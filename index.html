import React, { useState, useEffect } from 'react';
import { PlusCircle, TrendingUp, TrendingDown, Target, Calendar, CreditCard, AlertTriangle, CheckCircle, X, Edit3, Trash2 } from 'lucide-react';

const ExpenseTracker = () => {
  const [expenses, setExpenses] = useState([
    { id: 1, name: 'Mortgage', cost: 1840.63, type: 'Essential', frequency: 'Monthly', bank: 'Natwest', status: 'active', category: 'Housing' },
    { id: 2, name: 'Service Charge', cost: 175.94, type: 'Essential', frequency: 'Monthly', bank: 'Natwest', status: 'active', category: 'Housing' },
    { id: 3, name: 'Mortgage Protection', cost: 126.06, type: 'Non Essential', frequency: 'Monthly', bank: 'Natwest', status: 'active', category: 'Insurance' },
    { id: 4, name: 'Council Tax', cost: 117, type: 'Essential', frequency: 'Monthly', bank: 'Natwest', status: 'active', category: 'Housing' },
    { id: 5, name: 'BG Electricity', cost: 41.11, type: 'Essential', frequency: 'Monthly', bank: 'Natwest', status: 'active', category: 'Utilities' },
    { id: 6, name: 'Sky Internet', cost: 38, type: 'Essential', frequency: 'Monthly', bank: 'Natwest', status: 'active', category: 'Utilities' },
    { id: 7, name: 'Contribution SMBC', cost: 300, type: 'Essential', frequency: 'Monthly', bank: 'Revolut', status: 'active', category: 'Savings' },
    { id: 8, name: 'Content Insurance', cost: 350, type: 'Essential', frequency: 'Annual', bank: 'Natwest', status: 'active', category: 'Insurance' },
    { id: 9, name: 'Microsoft 365', cost: 84.99, type: 'Essential', frequency: 'Annual', bank: 'Amex', status: 'active', category: 'Software' },
    { id: 10, name: 'Gym Membership', cost: 55, type: 'Non Essential', frequency: 'Monthly', bank: 'Revolut', status: 'active', category: 'Health' },
    { id: 11, name: 'Apple Music', cost: 10.99, type: 'Non Essential', frequency: 'Monthly', bank: 'Amex', status: 'active', category: 'Entertainment' },
    { id: 12, name: 'Netflix', cost: 15.99, type: 'Non Essential', frequency: 'Monthly', bank: 'Amex', status: 'active', category: 'Entertainment' },
    { id: 13, name: 'Amazon Prime', cost: 8.99, type: 'Non Essential', frequency: 'Monthly', bank: 'Amex', status: 'active', category: 'Shopping' },
    { id: 14, name: 'Shopify', cost: 40, type: 'Non Essential', frequency: 'Monthly', bank: '', status: 'cancelled', category: 'Business' },
    { id: 15, name: 'Google Gemini Advanced', cost: 19.99, type: 'Non Essential', frequency: 'Monthly', bank: 'Revolut', status: 'active', category: 'Software' },
    { id: 16, name: 'Anthropic', cost: 18, type: 'Non Essential', frequency: 'Monthly', bank: 'Amex', status: 'active', category: 'Software' },
    { id: 17, name: 'OpenAI', cost: 20, type: 'Non Essential', frequency: 'Monthly', bank: 'Amex', status: 'active', category: 'Software' }
  ]);

  const [monthlyBudget, setMonthlyBudget] = useState(4000);
  const [savingsGoal, setSavingsGoal] = useState(1000);
  const [activeTab, setActiveTab] = useState('overview');
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingExpense, setEditingExpense] = useState(null);

  const [newExpense, setNewExpense] = useState({
    name: '',
    cost: '',
    type: 'Essential',
    frequency: 'Monthly',
    bank: 'Natwest',
    category: 'Other'
  });

  // Calculate monthly totals
  const calculateMonthlyTotal = () => {
    return expenses
      .filter(expense => expense.status === 'active')
      .reduce((total, expense) => {
        const monthlyCost = expense.frequency === 'Annual' ? expense.cost / 12 : expense.cost;
        return total + monthlyCost;
      }, 0);
  };

  const monthlyTotal = calculateMonthlyTotal();
  const budgetRemaining = monthlyBudget - monthlyTotal;
  const budgetUsagePercent = Math.min((monthlyTotal / monthlyBudget) * 100, 100);

  // Calculate category breakdowns
  const categoryTotals = expenses
    .filter(expense => expense.status === 'active')
    .reduce((acc, expense) => {
      const monthlyCost = expense.frequency === 'Annual' ? expense.cost / 12 : expense.cost;
      acc[expense.category] = (acc[expense.category] || 0) + monthlyCost;
      return acc;
    }, {});

  const essentialVsNonEssential = expenses
    .filter(expense => expense.status === 'active')
    .reduce((acc, expense) => {
      const monthlyCost = expense.frequency === 'Annual' ? expense.cost / 12 : expense.cost;
      acc[expense.type] = (acc[expense.type] || 0) + monthlyCost;
      return acc;
    }, {});

  const handleAddExpense = () => {
    if (!newExpense.name || !newExpense.cost) return;
    
    const expense = {
      id: Date.now(),
      ...newExpense,
      cost: parseFloat(newExpense.cost),
      status: 'active'
    };
    
    setExpenses([...expenses, expense]);
    setNewExpense({ name: '', cost: '', type: 'Essential', frequency: 'Monthly', bank: 'Natwest', category: 'Other' });
    setShowAddForm(false);
  };

  const handleEditExpense = (expense) => {
    setEditingExpense(expense);
    setNewExpense({
      name: expense.name,
      cost: expense.cost.toString(),
      type: expense.type,
      frequency: expense.frequency,
      bank: expense.bank,
      category: expense.category
    });
    setShowAddForm(true);
  };

  const handleUpdateExpense = () => {
    if (!newExpense.name || !newExpense.cost) return;
    
    setExpenses(expenses.map(expense => 
      expense.id === editingExpense.id 
        ? { ...expense, ...newExpense, cost: parseFloat(newExpense.cost) }
        : expense
    ));
    
    setEditingExpense(null);
    setNewExpense({ name: '', cost: '', type: 'Essential', frequency: 'Monthly', bank: 'Natwest', category: 'Other' });
    setShowAddForm(false);
  };

  const toggleExpenseStatus = (id) => {
    setExpenses(expenses.map(expense => 
      expense.id === id 
        ? { ...expense, status: expense.status === 'active' ? 'cancelled' : 'active' }
        : expense
    ));
  };

  const deleteExpense = (id) => {
    setExpenses(expenses.filter(expense => expense.id !== id));
  };

  const categories = ['Housing', 'Utilities', 'Insurance', 'Savings', 'Software', 'Health', 'Entertainment', 'Shopping', 'Business', 'Other'];

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
          <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <CreditCard className="text-blue-600" />
            Personal Finance Tracker
          </h1>
          <p className="text-gray-600 mt-2">Take control of your finances with smart tracking and insights</p>
        </div>

        {/* Navigation */}
        <div className="bg-white rounded-xl shadow-lg p-2 mb-6">
          <div className="flex gap-2">
            {['overview', 'expenses', 'analytics'].map((tab) => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-6 py-3 rounded-lg font-medium capitalize transition-all ${
                  activeTab === tab
                    ? 'bg-blue-600 text-white shadow-lg'
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                {tab}
              </button>
            ))}
          </div>
        </div>

        {activeTab === 'overview' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Budget Overview */}
            <div className="lg:col-span-2">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                  <Target className="text-green-600" />
                  Monthly Budget Overview
                </h2>
                
                {/* Budget Progress Bar */}
                <div className="mb-6">
                  <div className="flex justify-between mb-2">
                    <span className="text-sm font-medium text-gray-600">Budget Usage</span>
                    <span className="text-sm font-medium text-gray-800">{budgetUsagePercent.toFixed(1)}%</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-4">
                    <div 
                      className={`h-4 rounded-full transition-all duration-500 ${
                        budgetUsagePercent > 90 ? 'bg-red-500' : 
                        budgetUsagePercent > 75 ? 'bg-yellow-500' : 'bg-green-500'
                      }`}
                      style={{ width: `${Math.min(budgetUsagePercent, 100)}%` }}
                    ></div>
                  </div>
                </div>

                {/* Budget Stats */}
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-blue-50 rounded-lg p-4">
                    <div className="text-sm text-blue-600 font-medium">Monthly Budget</div>
                    <div className="text-2xl font-bold text-blue-800">£{monthlyBudget.toFixed(2)}</div>
                  </div>
                  <div className="bg-purple-50 rounded-lg p-4">
                    <div className="text-sm text-purple-600 font-medium">Total Expenses</div>
                    <div className="text-2xl font-bold text-purple-800">£{monthlyTotal.toFixed(2)}</div>
                  </div>
                  <div className={`rounded-lg p-4 ${budgetRemaining >= 0 ? 'bg-green-50' : 'bg-red-50'}`}>
                    <div className={`text-sm font-medium ${budgetRemaining >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                      {budgetRemaining >= 0 ? 'Remaining' : 'Over Budget'}
                    </div>
                    <div className={`text-2xl font-bold ${budgetRemaining >= 0 ? 'text-green-800' : 'text-red-800'}`}>
                      £{Math.abs(budgetRemaining).toFixed(2)}
                    </div>
                  </div>
                  <div className="bg-indigo-50 rounded-lg p-4">
                    <div className="text-sm text-indigo-600 font-medium">Annual Cost</div>
                    <div className="text-2xl font-bold text-indigo-800">£{(monthlyTotal * 12).toFixed(2)}</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Quick Actions */}
            <div className="space-y-6">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
                <div className="space-y-3">
                  <button
                    onClick={() => setShowAddForm(true)}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors"
                  >
                    <PlusCircle size={20} />
                    Add New Expense
                  </button>
                  <div className="space-y-2">
                    <label className="text-sm font-medium text-gray-600">Monthly Budget</label>
                    <input
                      type="number"
                      value={monthlyBudget}
                      onChange={(e) => setMonthlyBudget(parseFloat(e.target.value) || 0)}
                      className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>
              </div>

              {/* Essential vs Non-Essential */}
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">Spending Breakdown</h3>
                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-green-600 font-medium">Essential</span>
                    <span className="font-bold">£{(essentialVsNonEssential.Essential || 0).toFixed(2)}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="h-2 bg-green-500 rounded-full"
                      style={{ width: `${((essentialVsNonEssential.Essential || 0) / monthlyTotal) * 100}%` }}
                    ></div>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-orange-600 font-medium">Non-Essential</span>
                    <span className="font-bold">£{(essentialVsNonEssential['Non Essential'] || 0).toFixed(2)}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="h-2 bg-orange-500 rounded-full"
                      style={{ width: `${((essentialVsNonEssential['Non Essential'] || 0) / monthlyTotal) * 100}%` }}
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'expenses' && (
          <div className="bg-white rounded-xl shadow-lg overflow-hidden">
            <div className="p-6 border-b border-gray-200">
              <div className="flex justify-between items-center">
                <h2 className="text-xl font-bold text-gray-800">All Expenses</h2>
                <button
                  onClick={() => setShowAddForm(true)}
                  className="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium flex items-center gap-2 transition-colors"
                >
                  <PlusCircle size={18} />
                  Add Expense
                </button>
              </div>
            </div>
            
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bank</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {expenses.map((expense) => (
                    <tr key={expense.id} className={expense.status === 'cancelled' ? 'opacity-50' : ''}>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="font-medium text-gray-900">{expense.name}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-gray-900">£{expense.cost.toFixed(2)}</div>
                        {expense.frequency === 'Annual' && (
                          <div className="text-xs text-gray-500">£{(expense.cost / 12).toFixed(2)}/month</div>
                        )}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                          expense.type === 'Essential' 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-orange-100 text-orange-800'
                        }`}>
                          {expense.type}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-gray-900">{expense.frequency}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-gray-900">{expense.category}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-gray-900">{expense.bank}</td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                          expense.status === 'active' 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-red-100 text-red-800'
                        }`}>
                          {expense.status}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button
                          onClick={() => handleEditExpense(expense)}
                          className="text-blue-600 hover:text-blue-900"
                        >
                          <Edit3 size={16} />
                        </button>
                        <button
                          onClick={() => toggleExpenseStatus(expense.id)}
                          className={expense.status === 'active' ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'}
                        >
                          {expense.status === 'active' ? <X size={16} /> : <CheckCircle size={16} />}
                        </button>
                        <button
                          onClick={() => deleteExpense(expense.id)}
                          className="text-red-600 hover:text-red-900"
                        >
                          <Trash2 size={16} />
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeTab === 'analytics' && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Category Breakdown */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-6">Spending by Category</h2>
              <div className="space-y-4">
                {Object.entries(categoryTotals)
                  .sort(([,a], [,b]) => b - a)
                  .map(([category, amount]) => (
                    <div key={category} className="flex items-center justify-between">
                      <div className="flex-1">
                        <div className="flex justify-between mb-1">
                          <span className="text-sm font-medium text-gray-700">{category}</span>
                          <span className="text-sm font-bold text-gray-900">£{amount.toFixed(2)}</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div 
                            className="h-2 bg-blue-500 rounded-full"
                            style={{ width: `${(amount / monthlyTotal) * 100}%` }}
                          ></div>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          {((amount / monthlyTotal) * 100).toFixed(1)}% of total
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            </div>

            {/* Savings Opportunities */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-6">Optimization Suggestions</h2>
              <div className="space-y-4">
                {expenses
                  .filter(expense => expense.type === 'Non Essential' && expense.status === 'active')
                  .sort((a, b) => {
                    const aMonthly = a.frequency === 'Annual' ? a.cost / 12 : a.cost;
                    const bMonthly = b.frequency === 'Annual' ? b.cost / 12 : b.cost;
                    return bMonthly - aMonthly;
                  })
                  .slice(0, 5)
                  .map((expense) => {
                    const monthlyCost = expense.frequency === 'Annual' ? expense.cost / 12 : expense.cost;
                    return (
                      <div key={expense.id} className="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                        <div>
                          <div className="font-medium text-gray-800">{expense.name}</div>
                          <div className="text-sm text-gray-600">
                            Consider cancelling to save £{monthlyCost.toFixed(2)}/month
                          </div>
                        </div>
                        <button
                          onClick={() => toggleExpenseStatus(expense.id)}
                          className="text-red-600 hover:text-red-800 font-medium text-sm"
                        >
                          Cancel
                        </button>
                      </div>
                    );
                  })}
              </div>
            </div>
          </div>
        )}

        {/* Add/Edit Expense Modal */}
        {showAddForm && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
              <h3 className="text-xl font-bold text-gray-800 mb-4">
                {editingExpense ? 'Edit Expense' : 'Add New Expense'}
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input
                    type="text"
                    value={newExpense.name}
                    onChange={(e) => setNewExpense({ ...newExpense, name: e.target.value })}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Expense name"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Cost (£)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={newExpense.cost}
                    onChange={(e) => setNewExpense({ ...newExpense, cost: e.target.value })}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="0.00"
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select
                      value={newExpense.type}
                      onChange={(e) => setNewExpense({ ...newExpense, type: e.target.value })}
                      className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="Essential">Essential</option>
                      <option value="Non Essential">Non Essential</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Frequency</label>
                    <select
                      value={newExpense.frequency}
                      onChange={(e) => setNewExpense({ ...newExpense, frequency: e.target.value })}
                      className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="Monthly">Monthly</option>
                      <option value="Annual">Annual</option>
                    </select>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select
                      value={newExpense.category}
                      onChange={(e) => setNewExpense({ ...newExpense, category: e.target.value })}
                      className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      {categories.map(category => (
                        <option key={category} value={category}>{category}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Bank</label>
                    <select
                      value={newExpense.bank}
                      onChange={(e) => setNewExpense({ ...newExpense, bank: e.target.value })}
                      className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="Natwest">Natwest</option>
                      <option value="Revolut">Revolut</option>
                      <option value="Amex">Amex</option>
                    </select>
                  </div>
                </div>
              </div>
              <div className="flex gap-3 mt-6">
                <button
                  onClick={editingExpense ? handleUpdateExpense : handleAddExpense}
                  className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors"
                >
                  {editingExpense ? 'Update' : 'Add'} Expense
                </button>
                <button
                  onClick={() => {
                    setShowAddForm(false);
                    setEditingExpense(null);
                    setNewExpense({ name: '', cost: '', type: 'Essential', frequency: 'Monthly', bank: 'Natwest', category: 'Other' });
                  }}
                  className="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default ExpenseTracker;
