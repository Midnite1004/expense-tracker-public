<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>Lens - Personal Finance Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Clear financial insight for personal expense tracking and budgeting">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lens">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Content Security Policy for PWA -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:;">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='iconGradient' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6'/%3E%3Cstop offset='100%25' style='stop-color:%231d4ed8'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='0' y='0' width='32' height='32' rx='6' fill='url(%23iconGradient)'/%3E%3Ccircle cx='16' cy='16' r='10' fill='none' stroke='rgba(255,255,255,0.9)' stroke-width='1.5'/%3E%3Ccircle cx='16' cy='16' r='6' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='1'/%3E%3Ccircle cx='16' cy='16' r='3' fill='none' stroke='rgba(255,255,255,0.6)' stroke-width='1'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="mask-icon" href="icons/icon-192x192.png" color="#3b82f6">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Your existing scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc; /* Light gray background */
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b; /* Dark slate */
            --text-secondary: #64748b; /* Medium slate */
            --text-tertiary: #94a3b8; /* Light slate */
            --border-color: #e2e8f0;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --help-text-color: #374151;
            --health-score-good: var(--accent-green);
            --health-score-ok: var(--accent-yellow);
            --health-score-bad: var(--accent-red);
        }
        .dark {
            --bg-primary: #0f172a; /* Very dark blue */
            --bg-secondary: #1e293b; /* Dark blue */
            --bg-tertiary: #334155; /* Medium dark blue */
            --text-primary: #f1f5f9; /* Light gray */
            --text-secondary: #cbd5e1; /* Medium gray */
            --text-tertiary: #94a3b8; /* Darker gray */
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --help-text-color: #d1d5db;
        }
        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .stat-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
            text-align: center;
        }
        .dark .stat-card {
             background-color: var(--bg-tertiary);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .stat-card.cursor-pointer:hover {
            border-color: var(--accent-purple);
        }
        .stat-card-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        .stat-card-value {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* bold */
            color: var(--text-primary);
            line-height: 1.2;
        }
        .stat-card-value.text-green-600 { color: var(--accent-green); }
        .stat-card-value.text-red-600 { color: var(--accent-red); }
        .dark .stat-card-value.text-green-600 { color: #34d399; } /* Lighter green */
        .dark .stat-card-value.text-red-600 { color: #f87171; } /* Lighter red */
        
        /* Info Icon Styling */
        .info-icon {
            cursor: help;
            display: inline-flex;
            vertical-align: middle;
            color: var(--text-tertiary);
            transition: color 0.2s;
        }
        .info-icon:hover {
            color: var(--accent-blue);
        }
        /* Tooltip styling */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: normal;
            z-index: 50;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            max-width: 300px;
            width: max-content;
        }

        .tab-button {
            position: relative;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab-button:hover {
            color: var(--text-primary);
        }
        .tab-button.active {
            color: var(--accent-blue);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-blue);
            border-radius: 1px;
        }

/* Clean Onboarding Styles */
.onboarding-modal {
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    box-shadow: var(--shadow-md);
}

.progress-bar {
    width: 100%;
    height: 4px;
    background-color: var(--bg-tertiary);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background-color: var(--accent-blue);
    transition: width 0.5s ease;
}

.clean-goal-option:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.clean-goal-option.selected {
    border-color: var(--accent-blue);
    background-color: rgba(59, 130, 246, 0.1);
}

.clean-debt-item {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.clean-summary-card {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.highlight-number {
    color: var(--accent-blue);
    font-weight: 600;
}

        .modern-input, .modern-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
            appearance: none;
        }
        .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem;
        }
        .dark .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .modern-input:focus, .modern-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .modern-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            min-height: 44px;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .modern-button-primary {
            background-color: var(--accent-blue);
            color: white;
        }
        .modern-button-primary:hover {
            background-color: #2563eb;
            box-shadow: var(--shadow-md);
        }
         .modern-button-primary:active {
            transform: translateY(1px);
        }
        .modern-button-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .modern-button-secondary:hover {
            background-color: var(--border-color);
        }
        .modern-button-danger {
            background-color: var(--accent-red);
            color: white;
        }
        .modern-button-danger:hover {
             background-color: #dc2626;
             box-shadow: var(--shadow-md);
        }
        .icon-button {
            padding: 0.5rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        .icon-button:hover {
            color: var(--text-primary);
        }
        .icon-button svg {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        .dropdown-menu {
            position: absolute;
            margin-top: 0.5rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 50;
            min-width: 220px; /* Wider for import/export */
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: background-color 0.2s ease, color 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .dropdown-item:hover {
            background-color: var(--bg-secondary);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        .dark .status-active {
             background-color: rgba(16, 185, 129, 0.2);
             color: #10b981;
        }
        .status-cancelled {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            text-decoration: line-through;
        }
         .dark .status-cancelled {
             background-color: rgba(239, 68, 68, 0.2);
             color: #ef4444;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #2d3748;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 100;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            position: relative; 
            height: 350px;
            width: 100%;
        }
        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-blue);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        /* Help Tab Contrast */
        #help-tab p, #help-tab li {
            color: var(--help-text-color);
            transition: color 0.3s;
        }
        #help-tab h3 {
             color: var(--text-primary);
             transition: color 0.3s;
        }
        #help-tab strong {
            color: var(--text-primary);
            transition: color 0.3s;
        }
        #help-tab ul {
            margin-left: 1rem;
        }
        /* Table Checkbox */
        .table-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        /* Budget Health Score */
        .health-score-container {
            position: relative;
            width: 150px;
            height: 75px; /* Half circle */
            overflow: hidden;
            margin: 1rem auto 0;
        }
        .health-score-gauge {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--bg-tertiary);
            border-bottom-color: transparent;
            border-left-color: transparent;
            transform: rotate(-135deg); /* Start from bottom-left */
            box-sizing: border-box;
        }
        .health-score-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--health-score-good); /* Default color */
            border-top-color: transparent;
            border-right-color: transparent;
            transform: rotate(45deg); /* Start from bottom-left, fill clockwise */
            transform-origin: center center;
            clip-path: polygon(50% 0%, 100% 0%, 100% 50%, 50% 50%); /* Clip to top-right quadrant initially */
            transition: transform 1s ease-out, border-color 0.5s ease;
            box-sizing: border-box;
        }
        .health-score-text {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            color: var(--text-primary);
        }
        .health-score-label {
            font-size: 0.875rem; /* text-sm */
            color: var(--text-secondary);
            margin-top: -5px;
        }
        /* AI Insights Styling */
        .ai-insight {
            background-color: rgba(59, 130, 246, 0.05); /* Light blue bg */
            border-left: 4px solid var(--accent-blue);
            padding: 1rem;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        .dark .ai-insight {
            background-color: rgba(59, 130, 246, 0.1);
            border-left-color: var(--accent-blue);
            color: var(--text-secondary);
        }
        .ai-insight strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        /* Consistent Dark Mode */
        html.dark body { background-color: var(--bg-secondary); color: var(--text-primary); }
        html.dark .card { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .stat-card { background-color: var(--bg-tertiary); border-color: var(--border-color); }
        html.dark .modern-input, html.dark .modern-select { background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        html.dark .modern-button-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        html.dark .modern-button-secondary:hover { background-color: var(--border-color); }
        html.dark .tab-button { color: var(--text-secondary); }
        html.dark .tab-button:hover { color: var(--text-primary); }
        html.dark .tab-button.active { color: var(--accent-blue); }
        html.dark .icon-button { color: var(--text-secondary); }
        html.dark .icon-button:hover { color: var(--text-primary); }
        html.dark .dropdown-menu { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .dropdown-item { color: var(--text-primary); }
        html.dark .dropdown-item:hover { background-color: var(--bg-secondary); }
        html.dark table thead { background-color: var(--bg-tertiary); color: var(--text-secondary); }
        html.dark table tbody tr { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark table tbody tr:hover { background-color: var(--bg-secondary); }
        html.dark table tbody td { color: var(--text-secondary); }
        html.dark table tbody td:first-child { color: var(--text-primary); }
        html.dark #help-tab p, html.dark #help-tab li { color: var(--help-text-color); }
        html.dark #help-tab h3, html.dark #help-tab strong { color: var(--text-primary); }
        html.dark .health-score-gauge { border-color: var(--bg-tertiary); border-bottom-color: transparent; border-left-color: transparent; }
        html.dark .health-score-text { color: var(--text-primary); }
        html.dark .health-score-label { color: var(--text-secondary); }

        /* Driver.js Customization */
        .driver-popover {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* Match card radius */
        }
        .driver-popover-title {
            color: var(--text-primary);
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
        }
        .driver-popover-description {
            color: var(--text-secondary);
        }
        .driver-popover-progress-text {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn:hover {
            color: var(--text-primary);
        }
        .driver-popover-arrow-side-left.driver-popover-arrow {
            border-left-color: var(--border-color);
        }
        .driver-popover-arrow-side-right.driver-popover-arrow {
            border-right-color: var(--border-color);
        }
        .driver-popover-arrow-side-top.driver-popover-arrow {
            border-top-color: var(--border-color);
        }
        .driver-popover-arrow-side-bottom.driver-popover-arrow {
            border-bottom-color: var(--border-color);
        }
        .driver-popover-footer {
            gap: 0.5rem;
        }
        .driver-popover-next-btn, .driver-popover-prev-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
            cursor: pointer;
            text-shadow: none;
        }
        .driver-popover-next-btn {
            background-color: var(--accent-blue);
            color: white;
        }
        .driver-popover-next-btn:hover {
            background-color: #2563eb; /* Darker blue */
        }
        .driver-popover-prev-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .driver-popover-prev-btn:hover {
            background-color: var(--border-color);
        }

        /* Settings Modal Text Color Fix */
        #settings-modal .card h4,
        #settings-modal .card label {
            color: var(--text-primary);
        }

        /* New Tooltip CSS */
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 320px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            text-align: left;
            border-radius: 8px;
            padding: 16px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -160px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .dark .tooltip .tooltiptext {
            background-color: var(--bg-tertiary);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Arrow pointing down */
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--bg-primary) transparent transparent transparent;
        }

        .dark .tooltip .tooltiptext::after {
            border-color: var(--bg-tertiary) transparent transparent transparent;
        }

        /* AI Insights v2 Styling */
        .ai-section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* 12px */
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* bold */
            margin-bottom: 1rem; /* 16px */
        }
        .prediction-card {
            background-color: var(--bg-tertiary);
            padding: 1rem; /* 16px */
            border-radius: 0.75rem; /* 12px */
            border: 1px solid var(--border-color);
        }
        .confidence-meter {
            background-color: var(--border-color);
            border-radius: 9999px;
            height: 0.5rem; /* 8px */
            overflow: hidden;
        }
        .confidence-fill {
            background-color: var(--accent-blue);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .action-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .action-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .metric-card {
            background-color: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .ai-loading {
            width: 24px;
            height: 24px;
            border: 3px solid var(--accent-blue);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Bottom Nav Styling */
        .bottom-nav {
            background-color: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dark .bottom-nav {
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
        .bottom-nav-item {
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }
        .bottom-nav-item.active {
            color: var(--accent-blue);
        }
        
        /* New Mobile Card Styling */
        .mobile-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin: 0 8px 8px 8px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
        }
        html.dark .mobile-card {
            background-color: var(--bg-tertiary);
        }
        .mobile-card-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-tertiary);
            font-size: 1.25rem;
        }
         html.dark .mobile-card-icon {
            background-color: var(--bg-secondary);
        }
        .mobile-card-main {
            flex: 1;
            min-width: 0;
        }
        .mobile-card-title {
            font-weight: 500;
            color: var(--text-primary);
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        .mobile-card-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .mobile-card-amount {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        
        
        /* Modal z-index fixes */
        #goals-modal {
            z-index: 55 !important;
        }

        @media (max-width: 640px) {
          /* Hide table headers */
          table thead {
            position: absolute;
            top: -9999px;
            left: -9999px;
          }
          
          /* Date group headers - Revolut style */
          .mobile-date-header td {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0.75rem 1rem !important;
            color: var(--text-secondary) !important;
            font-size: 0.875rem !important;
            font-weight: 600 !important;
            border-bottom: 1px solid var(--border-color) !important;
            margin-bottom: 0.5rem !important;
            background: transparent !important;
            border-radius: 0 !important;
            box-shadow: none !important;
          }

          /* Checkbox styling */
          td:first-child {
            display: none !important;
          }
          
          td:first-child::before {
            content: '' !important;
          }

          /* Card layout */
          table, tbody, tr {
            display: block;
            width: 100%;
          }

          /* REVOLUT-STYLE TRANSACTION CARDS */
          tr:not(.mobile-date-header) {
            display: flex !important;
            align-items: center !important;
            background: var(--bg-primary) !important;
            border: 1px solid var(--border-color) !important;
            border-bottom: none !important;
            padding: 1rem !important;
            margin-bottom: 0 !important;
            gap: 0.75rem !important;
            transition: all 0.2s ease !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            min-height: 64px !important;
            cursor: pointer !important;
          }

          /* First card rounded top */
          tr:not(.mobile-date-header):first-of-type {
            border-radius: 0.75rem 0.75rem 0 0 !important;
          }

          /* Last card rounded bottom */
          tr:not(.mobile-date-header):last-of-type {
            border-radius: 0 0 0.75rem 0.75rem !important;
            border-bottom: 1px solid var(--border-color) !important;
          }

          /* Only card gets full rounded corners */
          tr:not(.mobile-date-header):only-of-type {
            border-radius: 0.75rem !important;
            border-bottom: 1px solid var(--border-color) !important;
          }

          .mobile-transaction-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 16px 8px;
            width: auto !important;
            min-width: fit-content !important;
            border: none !important;
          }
          .mobile-transaction-actions .icon-button {
            padding: 4px;
          }

          /* Hover and active states */
          tr:not(.mobile-date-header):hover {
            background: var(--bg-tertiary) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
          }

          tr:not(.mobile-date-header):active {
            transform: scale(0.98);
            background: var(--bg-tertiary) !important;
          }

          /* Transaction Icon - position as second visible element */
          td:nth-child(2) {
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #6b7280, #4b5563) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            font-size: 1.25rem !important;
            color: white !important;
            border: none !important;
          }

          /* Category-based icon colors */
          tr[data-category="Food/Drink"] td:nth-child(2) {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
          }
          tr[data-category="Transport"] td:nth-child(2) {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
          }
          tr[data-category="Entertainment"] td:nth-child(2) {
            background: linear-gradient(135deg, #8b5cf6, #a855f7) !important;
          }
          tr[data-category="Housing"] td:nth-child(2) {
            background: linear-gradient(135deg, #10b981, #059669) !important;
          }
          tr[data-category="Subscriptions"] td:nth-child(2) {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
          }
          tr[data-category="Utilities"] td:nth-child(2) {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
          }
          tr[data-category="Shopping"] td:nth-child(2) {
            background: linear-gradient(135deg, #ec4899, #db2777) !important;
          }
          tr[data-category="Health"] td:nth-child(2) {
            background: linear-gradient(135deg, #06b6d4, #0891b2) !important;
          }

          /* Icon display using data attribute */
          td:nth-child(2)::after {
            content: attr(data-icon);
            font-size: 1.25rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
          }

          /* Transaction details - Name field becomes flex container */
          td[data-label="Name"] {
            flex: 1 !important;
            min-width: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: flex-start !important;
            border: none !important;
          }

          /* Transaction name styling */
          td[data-label="Name"] > span {
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            font-size: 1rem !important;
            margin-bottom: 0.125rem !important;
            line-height: 1.2 !important;
            display: block !important;
            max-width: 100% !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
          }

          /* Transaction meta info */
          td[data-label="Name"]::after {
            font-size: 0.8125rem !important;
            color: var(--text-secondary) !important;
            display: block !important;
            margin-top: 0.125rem !important;
            line-height: 1.2 !important;
          }

          /* Generate meta info based on transaction type */
          td[data-label="Name"]:not([data-recurring="true"])::after {
            content: attr(data-category) " • " attr(data-time);
          }

          td[data-label="Name"][data-recurring="true"]::after {
            content: "🔁 Recurring • " attr(data-time);
          }

          /* Transaction amount */
          td[data-label="Amount"] {
            font-weight: 700 !important;
            font-size: 1.125rem !important;
            color: var(--text-primary) !important;
            text-align: right !important;
            padding: 0 !important;
            margin: 0 !important;
            margin-left: auto !important;
            flex-shrink: 0 !important;
            border: none !important;
            display: flex !important;
            align-items: center !important;
            line-height: 1 !important;
            white-space: nowrap !important;
            max-width: 30% !important;
          }

          /* Positive amounts (income) */
          td[data-label="Amount"][data-positive="true"] {
            color: var(--accent-green) !important;
          }

          /* Hide other desktop fields */
          td[data-label="Date"],
          td[data-label="Category"],
          td[data-label="Payment Method"],
          td[data-label="Type"],
          td[data-label="Actions"] {
            display: none !important;
          }

          /* Dark mode improvements */
          html.dark tr:not(.mobile-date-header) {
            background: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
          }

          html.dark tr:not(.mobile-date-header):hover {
            background: var(--bg-tertiary) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
          }

          html.dark .mobile-date-header td {
            color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
          }

          html.dark td[data-label="Name"] > span {
            color: var(--text-primary) !important;
          }

          html.dark td[data-label="Name"]::after {
            color: var(--text-secondary) !important;
          }

          html.dark td[data-label="Amount"] {
            color: var(--text-primary) !important;
          }

          html.dark td[data-label="Amount"][data-positive="true"] {
            color: var(--accent-green) !important;
          }

          /* Responsive adjustments for smaller screens */
          @media (max-width: 375px) {
            tr:not(.mobile-date-header) {
              padding: 0.875rem !important;
              gap: 0.625rem !important;
            }

            td:nth-child(2) {
              width: 36px !important;
              height: 36px !important;
              min-width: 36px !important;
              font-size: 1.125rem !important;
            }
            
            td[data-label="Name"] > span {
              font-size: 0.9375rem !important;
            }
            
            td[data-label="Amount"] {
              font-size: 1rem !important;
            }
          }

          /* Prevent horizontal overflow */
          .overflow-x-auto {
            overflow-x: hidden !important;
            width: 100%;
          }

          .card .overflow-x-auto {
            margin: -0.25rem;
            padding: 0.25rem;
          }
        }

        /* Landscape mode optimizations */
        @media screen and (orientation: landscape) and (max-height: 500px) {
          .app-header,
          header.card {
            padding: 0.75rem 1rem !important;
          }
          
          .app-header h1,
          header.card h1 {
            font-size: 1.5rem !important;
          }
          
          .bottom-nav {
            height: 56px !important;
          }
          
          .bottom-nav-item svg {
            width: 1.125rem !important;
            height: 1.125rem !important;
            margin-bottom: 0.125rem !important;
          }
          
          .bottom-nav-item span {
            font-size: 0.625rem !important;
          }
        }

        /* Safe area handling for notched devices */
        @supports (padding: max(0px)) {
          body {
            padding-bottom: max(5rem, env(safe-area-inset-bottom));
          }
          
          .bottom-nav {
            padding-bottom: max(0px, env(safe-area-inset-bottom));
          }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
          body {
            height: 100vh;
            height: -webkit-fill-available;
          }
          
          .min-h-screen {
            min-height: 100vh;
            min-height: -webkit-fill-available;
          }
        }

        /* Enhanced touch interactions */
        @media (hover: none) and (pointer: coarse) {
          .modern-button:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
          }
        }
        
        /* === Lens Mobile Card Layout END === */

        /* No-scroll CSS - Prevent horizontal scrolling */
        html,body{max-width:100%;overflow-x:hidden;}
        .table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%;}
    </style>

<style>
#health-score-tooltip{
  bottom:auto !important;
  top:110% !important;
}
</style>
</head>
<body class="antialiased pb-20 md:pb-0">
    <div class="min-h-screen p-4 md:p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="card p-2 md:p-1 mb-6">
                <div class="flex justify-between items-center gap-4">
                    <!-- Logo & Title -->
                    <div class="flex items-center gap-3" data-tour="app-header">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="8" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" fill="none"/>
                                <circle cx="12" cy="12" r="5" stroke="rgba(255,255,255,0.6)" stroke-width="1" fill="none"/>
                                <circle cx="12" cy="12" r="2.5" stroke="rgba(255,255,255,0.8)" stroke-width="1" fill="none"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold">Lens</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Your financial insight</p>
                                        </div>
                                        </div>

                    <!-- Desktop Navigation & Settings -->
                    <div class="hidden md:flex items-center gap-4">
                        <nav class="flex items-center space-x-2" aria-label="Tabs">
                        <button onclick="showTab('overview')" id="tab-overview" class="tab-button active">Overview</button>
                        <button onclick="showTab('expenses')" id="tab-expenses" class="tab-button">Expenses</button>
                        <button onclick="showTab('recurring')" id="tab-recurring" class="tab-button">Recurring</button>
                            <button onclick="showTab('insights')" id="tab-insights" class="tab-button">Insights</button>
                    </nav>
                        <div class="border-l border-gray-200 dark:border-gray-600 h-8"></div>
                        <div class="relative inline-block text-left">
                            <button onclick="openSettings()" class="modern-button modern-button-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                                <span class="hidden sm:inline">Settings</span>
                            </button>
                </div>
            </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <div class="mt-6">
                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Key Stats & Budget Health -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Key Stats Row -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="stat-card bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800">
                                    <div class="stat-card-title">Monthly Budget</div>
                                    <div class="stat-card-value text-blue-600 dark:text-blue-400" id="monthly-budget">£0.00</div>
                                </div>
                                <div class="stat-card bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800">
                                    <div class="stat-card-title">Spent (Month)</div>
                                    <div class="stat-card-value text-red-600" id="total-expenses">£0.00</div>
                                </div>
                                <div class="stat-card bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800">
                                    <div class="stat-card-title">Remaining</div>
                                    <div class="stat-card-value text-green-600" id="remaining-amount">£0.00</div>
                                </div>
                                 <div class="stat-card bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-800 cursor-pointer hover:border-purple-400 dark:hover:border-purple-600" onclick="openGoalsModal()">
                                    <div class="stat-card-title">
                                        Goal Progress
                                        <span class="info-icon ml-1" data-tooltip="Shows your progress on active financial goals. Click for details.">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="stat-card-value text-purple-600 dark:text-purple-400" id="goal-progress-display">--</div>
                                </div>
                            </div>
                
                            <!-- ADDED SHORTCUT -->
                            <div class="text-center -mt-4">
                                <button class="text-sm text-blue-600 dark:text-blue-400 opacity-70 hover:opacity-100 hover:underline" onclick="openSettings('budget')">
                                    Edit budget & income
                                </button>
                            </div>
                
                            <!-- Budget Health & Progress -->
                            <div class="card p-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                                    <div class="md:col-span-2">
                                        <h3 class="text-lg font-semibold mb-1">Budget Progress</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">How you're tracking against your monthly budget.</p>
                                        <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 mb-2">
                                            <div id="budget-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <p id="budget-percentage" class="text-sm text-gray-600 dark:text-gray-400">0% Used</p>
                                        </div>
                                        <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm" id="ai-projection-container">
                                            <!-- AI Projection content will be inserted here -->
                                        </div>
                                    </div>
                                    <div class="text-center" id="budget-health-section">
                                        <div class="flex items-center justify-center gap-2 mb-2">
                                            <h3 class="text-lg font-semibold">Budget Health</h3>
                                            <div class="tooltip">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-help hover:text-gray-600 dark:hover:text-gray-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div id="health-score-tooltip" class="tooltiptext">
                                                    <!-- Dynamic content goes here -->
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div id="health-score-visual" class="relative w-32 h-32 mx-auto mb-2">
                                            <!-- Circular progress indicator will be rendered here by JS -->
                                        </div>
                                        
                                        <div id="health-score-trend" class="text-xs mt-1">
                                            <!-- Trend indicator will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Essential vs Non-Essential -->
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Spending Breakdown (Month)</h3>
                                <div class="flex justify-around items-center text-center mb-4">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Essential</p>
                                        <p class="text-2xl font-semibold text-sky-600 dark:text-sky-400" id="essential-spending">£0.00</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Non-Essential</p>
                                        <p class="text-2xl font-semibold text-indigo-600 dark:text-indigo-400" id="non-essential-spending">£0.00</p>
                                    </div>
                                </div>
                                <div class="w-full rounded-full h-3">
                                    <div id="essential-bar" class="bg-sky-500 h-3 rounded-l-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div><!--
                                 --><div id="non-essential-bar" class="bg-indigo-500 h-3 rounded-r-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                
                        <!-- Right Column: Actions & Recent Activity -->
                        <div class="space-y-6">
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                                <div class="space-y-3">
                                    <button onclick="showAddForm()" class="modern-button modern-button-primary w-full">
                                        <span>➕</span> Add New Expense
                                    </button>
                                    <button onclick="showRecurringForm()" class="modern-button modern-button-secondary w-full">
                                        <span>🔁</span> Add Recurring Item
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Quick Add Common Expenses</h3>
                                <div class="flex flex-col gap-2 w-full">
                                    <div id="quick-add-coffee">
                                        <button class="bg-gray-600 dark:bg-gray-700 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">☕</span>
                                                <span class="text-white">Coffee</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-transport">
                                        <button class="bg-gray-600 dark:bg-gray-700 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">🚌</span>
                                                <span class="text-white">Transport</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-lunch">
                                        <button class="bg-gray-600 dark:bg-gray-700 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">🥪</span>
                                                <span class="text-white">Lunch</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-groceries">
                                        <button class="bg-gray-600 dark:bg-gray-700 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">🛒</span>
                                                <span class="text-white">Groceries</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                                <div id="recent-expenses" class="space-y-3">
                                    <p class="text-gray-700 dark:text-gray-800">No recent expenses.</p>
                                </div>
                                <div class="text-center mt-4">
                                    <button onclick="showTab('expenses')" class="text-blue-600 dark:text-blue-400 font-medium hover:underline">
                                        See all
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expenses Tab -->
                <div id="expenses-tab" class="tab-content hidden fade-in">
                    <div class="card">
                        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-4">
                            <h2 class="text-xl font-semibold">All Expenses</h2>
                            <div class="flex flex-wrap gap-2 sm:gap-3">
                                <button onclick="toggleFilterPanel('expense-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                    </svg>
                                    Filters
                                </button>
                                <button id="delete-selected-btn" onclick="deleteSelectedExpenses()" class="modern-button modern-button-danger hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showAddForm()" class="modern-button modern-button-primary">
                                     <span>➕</span> Add Expense
                                 </button>
                             </div>
                        </div>
                        
                        <!-- Filter Panel -->
                        <div id="expense-filter-panel" class="p-4 border-b border-gray-200 dark:border-gray-700 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <!-- Date Range -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Date Range</label>
                                    <div class="flex gap-2">
                                        <input type="date" id="expense-filter-date-from" class="modern-input">
                                        <input type="date" id="expense-filter-date-to" class="modern-input">
                                    </div>
                                </div>
                                <!-- Category -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Category</label>
                                    <select id="expense-filter-category" class="modern-select">
                                        <option value="">All Categories</option>
                                        <!-- Populated dynamically -->
                                    </select>
                                </div>
                                <!-- Type -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Type</label>
                                    <select id="expense-filter-type" class="modern-select">
                                        <option value="">All Types</option>
                                        <option value="Essential">Essential</option>
                                        <option value="Non-Essential">Non-Essential</option>
                                        <option value="Recurring">Recurring</option>
                                    </select>
                            </div>
                            <!-- Clear Filters -->
                                <div class="md:col-span-3 flex justify-end gap-2">
                                <button onclick="applyExpenseFilters()" class="modern-button modern-button-primary">Apply Filters</button>
                                <button onclick="clearExpenseFilters()" class="modern-button modern-button-secondary">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-expenses" onchange="toggleSelectAllExpenses(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Date</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Payment Method</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Type</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table">
                                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                        <td colspan="8" class="px-6 py-4 text-center">No expenses recorded yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                 <!-- Recurring Tab -->
                <div id="recurring-tab" class="tab-content hidden fade-in">
                    <div class="card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 gap-4">
                            <div>
                                <h2 class="text-xl font-bold">Recurring Items</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Regular income and expenses like salaries or subscriptions.</p>
                            </div>
                            <div class="flex-shrink-0 flex flex-wrap items-center gap-2 sm:space-x-2 sm:gap-0">
                                <button onclick="toggleFilterPanel('recurring-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg>
                                    Filter
                                </button>
                                <button id="delete-selected-recurring-btn" onclick="deleteSelectedRecurring()" class="modern-button modern-button-danger hidden">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showRecurringForm()" class="modern-button modern-button-primary">
                                    <span>🔁</span> Add Recurring
                                </button>
                            </div>
                        </div>
                
                        <div id="recurring-filter-panel" class="hidden p-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label for="recurring-filter-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                                    <select id="recurring-filter-type" class="modern-select mt-1">
                                        <option value="">All Types</option>
                                        <option value="income">Income</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                                    <select id="recurring-filter-category" class="modern-select mt-1">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-frequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                                    <select id="recurring-filter-frequency" class="modern-select mt-1">
                                        <option value="">All Frequencies</option>
                                        <option value="Daily">Daily</option>
                                        <option value="Weekly">Weekly</option>
                                        <option value="Bi-Weekly">Bi-Weekly</option>
                                        <option value="Monthly">Monthly</option>
                                        <option value="Quarterly">Quarterly</option>
                                        <option value="Annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 mt-4">
                                <button onclick="applyRecurringFilters()" class="modern-button modern-button-primary">Apply</button>
                                <button onclick="clearRecurringFilters()" class="modern-button modern-button-secondary">Clear</button>
                            </div>
                        </div>
                
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-recurring" onchange="toggleSelectAllRecurring(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Type</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Frequency</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell" style="white-space: nowrap;">Date</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recurring-table">
                                    <!-- Rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                
                <!-- Replace your insights tab HTML with this better layout -->
<div id="insights-tab" class="tab-content hidden fade-in">
    <!-- Priority Content First -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
        <!-- Smart Recommendations (Most Important) -->
        <div class="xl:col-span-2">
            <div class="card p-6">
                <h2 class="ai-section-title">
                    <span class="text-xl">💡</span>
                    <span>Smart Recommendations</span>
                    <span id="action-count" class="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
                </h2>
                <div id="smart-recommendations" class="space-y-3">
                    <!-- JS-rendered content -->
                </div>
            </div>
        </div>
        
        <!-- Month-End Projection (Quick Overview) -->
        <div class="card p-6">
            <h2 class="ai-section-title">
                <span class="text-xl">🎯</span>
                <span>Your Goals</span>
            </h2>
            <div id="goals-dashboard">
                <!-- JS-rendered content -->
            </div>
        </div>
    </div>

    <!-- Secondary Content -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Your Monthly Story (Combined with metrics) -->
        <div class="card p-6">
            <h2 class="ai-section-title">
                <span class="text-xl">📖</span>
                <span>Your Monthly Story</span>
            </h2>
            <div id="monthly-story">
                <!-- JS-rendered content with embedded metrics -->
            </div>
            <!-- This container is now hidden as metrics are embedded above -->
            <div id="story-metrics" class="hidden"></div>
        </div>
        
        <!-- 7-Day Forecast (Moved to secondary position) -->
        <div class="card p-6">
            <h2 class="ai-section-title">
                <span class="text-xl">📅</span>
                <span>7-Day Forecast</span>
            </h2>
            <div id="seven-day-forecast" class="space-y-4">
                <!-- JS-rendered content -->
            </div>
        </div>
    </div>

    <!-- Charts (Least important, moved to bottom) -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <div class="card p-6">
             <h2 class="text-xl font-bold mb-4">Spending Trend</h2>
             <div class="chart-container h-64 md:h-80">
                <canvas id="spending-trend-chart"></canvas>
            </div>
        </div>
        <div class="card p-6">
            <h2 class="text-xl font-semibold mb-4">Monthly Savings Trend</h2>
            <div class="chart-container" style="height: 320px;">
                <canvas id="monthly-savings-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced dark mode styling */
:root {
    --insights-bg-primary: #ffffff;
    --insights-bg-secondary: #f8fafc;
    --insights-text-primary: #1e293b;
    --insights-text-secondary: #64748b;
}

.dark {
    --insights-bg-primary: #0f172a;
    --insights-bg-secondary: #1e293b;
    --insights-text-primary: #f1f5f9;
    --insights-text-secondary: #cbd5e1;
}

/* Better contrast for insights */
#insights-tab {
    background-color: var(--insights-bg-secondary);
    min-height: 100vh;
    padding: 1rem;
}

#insights-tab .card {
    background-color: var(--insights-bg-primary);
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.dark #insights-tab .card {
    background-color: var(--insights-bg-primary);
    border-color: #334155;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

/* Recommendation cards with better dark mode */
#smart-recommendations .border-l-4 {
    background-color: var(--insights-bg-primary);
    border-right: 1px solid var(--border-color);
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
}

.dark #smart-recommendations .border-l-4 {
    background-color: #1e293b;
    border-right-color: #334155;
    border-top-color: #334155;
    border-bottom-color: #334155;
}

/* Fix text contrast in dark mode */
.dark #insights-tab h2,
.dark #insights-tab h3,
.dark #insights-tab h4 {
    color: var(--insights-text-primary);
}

.dark #insights-tab p,
.dark #insights-tab span:not(.bg-red-500):not(.bg-blue-600):not(.text-green-600):not(.text-red-600) {
    color: var(--insights-text-secondary);
}

/* Better visibility for action buttons */
.dark #smart-recommendations .bg-blue-600 {
    background-color: #2563eb !important;
    color: white !important;
}

/* Ensure chart visibility in dark mode */
.dark .chart-container {
    background-color: var(--insights-bg-primary);
    border-radius: 0.5rem;
    padding: 1rem;
}

/* Make metrics cards more visible */
.dark .metric-card,
.dark .bg-gray-50 {
    background-color: #334155 !important;
    color: var(--insights-text-primary) !important;
}

/* Toast improvements for dark mode */
.dark .toast {
    background-color: #1e293b !important;
    border: 1px solid #334155 !important;
    color: var(--insights-text-primary) !important;
}
</style>

    <!-- Settings Modal -->
    <div id="settings-modal" onclick="closeSettings()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Settings</h3>
                <button onclick="closeSettings()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Budget & Income Section -->
                <div id="settings-budget-section" class="space-y-3 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                    <h4 class="text-md font-semibold">Budget & Income</h4>
                    <div>
                        <label class="block text-xs font-medium">Monthly Budget</label>
                        <input type="number" id="settings-budget-input" placeholder="e.g., 2000" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-xs font-medium">Monthly Income</label>
                        <input type="number" id="settings-income-input" placeholder="e.g., 3500" class="modern-input mt-1">
                    </div>
                </div>
            
                <!-- General Settings -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="theme-toggle" class="text-sm font-medium">Dark Mode</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle" onchange="toggleTheme(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="currency-select" class="text-sm font-medium">Currency</label>
                        <select id="currency-select" onchange="changeCurrency(this.value)" class="modern-select text-sm w-40">
                            <option value="AUD">AUD (A$)</option>
                            <option value="CAD">CAD (C$)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                            <option value="JPY">JPY (¥)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="space-y-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="exportData()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>Export Data (JSON)</span>
                    </button>
                    <label class="modern-button modern-button-secondary w-full justify-start cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>Import Data (JSON)</span>
                        <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                    </label>
                     <button onclick="openHelpModal()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Help & Documentation</span>
                    </button>
                </div>
            </div>

            <div class="flex gap-3 mt-6 border-t border-gray-200 dark:border-gray-700 pt-3">
                <button onclick="saveSettings()" class="modern-button modern-button-primary flex-1">Save & Close</button>
                <button onclick="closeSettings()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>
    




    <!-- Add/Edit Expense Modal -->
    <div id="modal" onclick="closeModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-6" id="modal-title">Add New Expense</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="expense-name" placeholder="e.g., Coffee, Rent" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="modal-currency">£</span>)</label>
                        <input type="number" step="0.01" id="expense-cost" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" id="expense-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="expense-category" class="modern-select mt-1">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                        <select id="expense-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="expense-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveExpense()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Recurring Item Modal -->
    <div id="recurring-modal" onclick="closeRecurringModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-4" id="recurring-modal-title">Add Recurring Item</h3>
            <div class="space-y-4">
                 <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                    <select id="recurring-item-type" class="modern-select mt-1" onchange="toggleRecurringFields(this.value)">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="recurring-name" placeholder="e.g., Salary, Netflix" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="recurring-modal-currency">£</span>)</label>
                        <input type="number" step="0.01" id="recurring-amount" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                        <select id="recurring-frequency" class="modern-select mt-1">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Bi-Weekly">Bi-Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Annual">Annual</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="recurring-category" class="modern-select mt-1">
                            <!-- Options loaded dynamically -->
                        </select>
                    </div>
                    <div id="recurring-essential-type-wrapper">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Expense Type</label>
                        <select id="recurring-essential-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                        <input type="date" id="recurring-start-date" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date (Optional)</label>
                        <input type="date" id="recurring-end-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="recurring-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveRecurring()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeRecurringModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" onclick="closeHelpModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold">Help & Documentation</h3>
                <button onclick="closeHelpModal()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 md:p-8">
                <div class="space-y-8 text-sm leading-relaxed">
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">🚀 Getting Started</h3>
                        <p>Welcome to Lens! The first time you use the app, an onboarding tour will guide you through the key features. You can start by visiting the <button onclick="openSettings('budget')" class="text-blue-600 hover:underline">Settings</button> to set your monthly budget and income.</p>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">The Dashboard Tabs</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-md mb-2">🎯 Overview</h4>
                                <p class="mb-2">This is your main financial dashboard, giving you a live snapshot of your finances for the current month.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Key Stats:</strong> See your total monthly budget, how much you've spent, what's remaining, and your total income. Click the income card for a detailed breakdown.</li>
                                    <li><strong>Budget Progress & AI Projection:</strong> A visual bar shows how much of your budget is used. The AI projection forecasts your total spending by month-end.</li>
                                    <li><strong>Budget Health Score:</strong> A score from 0-100 that measures how well you're managing your finances. Hover over it for a detailed breakdown of what's affecting your score.</li>
                                    <li><strong>Spending Breakdown:</strong> See a clear split between your Essential and Non-Essential spending.</li>
                                    <li><strong>Quick Actions:</strong> Add new expenses or recurring items with a single click.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-md mb-2">💸 Expenses</h4>
                                <p class="mb-2">Log, view, and manage all your individual, one-off expenses.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Add, Edit, Delete:</strong> Use the action buttons to manage each expense. When adding, the app will try to auto-categorize it based on the name.</li>
                                    <li><strong>Filtering:</strong> Use the "Filters" button to narrow down your view by date range, category, or type (including auto-generated recurring expenses).</li>
                                    <li><strong>Bulk Actions:</strong> Use the checkboxes to select multiple expenses and delete them at once.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-md mb-2">🔄 Recurring</h4>
                                <p class="mb-2">Manage transactions that happen on a regular schedule, like salaries, rent, or subscriptions.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Income or Expense:</strong> Recurring items can be set as either income (e.g., salary) or an expense (e.g., Netflix).</li>
                                    <li><strong>Automatic Logging:</strong> The app automatically creates an expense record on the due date for each active recurring item. Recurring income is automatically added to your monthly total.</li>
                                    <li><strong>Pause & Resume:</strong> You can pause a recurring item by setting its status to "cancelled," and resume it by setting it back to "active."</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-md mb-2">📊 Insights</h4>
                                <p class="mb-2">This tab uses AI to analyze your spending and provide deeper insights into your financial habits.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>7-Day Forecast:</strong> Shows you any recurring expenses that are due in the next week.</li>
                                    <li><strong>Month-End Projection:</strong> Forecasts your total spending and savings by the end of the current month.</li>
                                    <li><strong>Smart Recommendations:</strong> Provides actionable tips based on your spending patterns, like reviewing subscriptions or high non-essential spending.</li>
                                    <li><strong>Your Monthly Story:</strong> A narrative summary of your financial activity for the month, highlighting key metrics.</li>
                                    <li><strong>Charts:</strong> Visualize your month-over-month spending and savings trends.</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">⚙️ Settings & Data</h3>
                         <ul class="list-disc ml-5 space-y-2">
                            <li><strong>Currency & Theme:</strong> Change your display currency and switch between light and dark modes.</li>
                            <li><strong>Data Management:</strong> Use the "Export Data" button to save a JSON backup of all your information. You can restore from a backup using the "Import Data" button.</li>
                            <li><strong>Privacy:</strong> All your data is stored <strong>only in your browser's local storage</strong>. It is never sent to a server. This means your information is completely private, but it also means clearing your browser data will erase your expense records. Please export your data regularly as a backup.</li>
                        </ul>
                    </section>
                </div>
            </div>
            <div class="flex justify-center p-4">
                <button onclick="closeHelpModal()" class="modern-button modern-button-primary w-56">Close</button>
            </div>
        </div>
    </div>

    <!-- Income Breakdown Modal -->
    <div id="income-modal" onclick="closeIncomeModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-sm w-full">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold">Income Breakdown</h3>
                <button onclick="closeIncomeModal()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            <div id="income-breakdown-content" class="p-6 space-y-3 text-sm">
                <!-- Dynamic content will be generated here by JavaScript -->
            </div>
            <div class="flex justify-center p-4">
                <button onclick="closeIncomeModal()" class="modern-button modern-button-primary w-56">Close</button>
            </div>
        </div>
    </div>

    <!-- Goals Modal -->
<div id="goals-modal" onclick="closeGoalsModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
    <div onclick="event.stopPropagation()" class="card max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold">Your Goals</h3>
            <button onclick="closeGoalsModal()" class="icon-button text-2xl leading-none">&times;</button>
        </div>
        <div id="goals-content" class="p-6">
            <!-- Goals will be populated here -->
        </div>
        <div class="flex justify-center p-4">
            <button onclick="editGoals()" class="modern-button modern-button-secondary mr-3">Edit Goals</button>
            <button onclick="closeGoalsModal()" class="modern-button modern-button-primary">Close</button>
        </div>
    </div>
</div>

<!-- Goal Editing Modal -->
<div id="goal-editing-modal" onclick="closeGoalEditingModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
    <div onclick="event.stopPropagation()" class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto relative">
        <!-- Confirmation Overlay (within goal editing modal) -->
        <div id="goal-confirmation-overlay" class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-10 hidden">
            <div class="card max-w-md w-full">
                <div class="p-6 text-center">
                    <div class="text-4xl mb-4" id="confirmation-icon">⚠️</div>
                    <h3 class="text-lg font-semibold mb-2" id="confirmation-title">Confirm Action</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6" id="confirmation-message">Are you sure you want to proceed?</p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="cancelConfirmation()" class="modern-button modern-button-secondary px-6">Cancel</button>
                        <button id="confirmation-button" onclick="confirmAction()" class="modern-button px-6">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold">Edit Your Goals</h3>
            <button onclick="closeGoalEditingModal()" class="icon-button text-2xl leading-none">&times;</button>
        </div>
        <div id="goal-editing-content" class="p-6">
            <!-- Goal editing interface will be populated here -->
        </div>
        <div class="flex justify-between p-4 border-t border-gray-200 dark:border-gray-700">
            <button onclick="addNewGoal()" class="modern-button modern-button-secondary">Add New Goal</button>
            <div class="space-x-3">
                <button onclick="closeGoalEditingModal()" class="modern-button modern-button-secondary">Cancel</button>
                <button onclick="saveGoalEdits()" class="modern-button modern-button-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

    <!-- Clean Modern Onboarding Modal -->
<div id="clean-onboarding-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
    <div class="onboarding-modal w-full max-w-lg">
        <!-- Progress Bar -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-600">
            <div class="progress-bar mb-2">
                <div id="clean-progress-fill" class="progress-fill" style="width: 16.67%"></div>
            </div>
            <div class="text-center text-sm text-gray-600 dark:text-gray-400">
                <span id="clean-step-indicator">Step 1 of 6</span>
            </div>
        </div>

        <!-- Step 1: Income & Budget -->
        <div id="clean-step-1" class="clean-onboarding-step p-6">
            <h2 class="text-xl font-semibold mb-2 text-center">Welcome to Lens</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Let's start with your monthly finances</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Monthly Take-Home Income</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="clean-income-input" placeholder="3,500" class="modern-input pl-8 text-center font-semibold">
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">Your actual monthly income after tax and deductions</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Monthly Spending Budget</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="clean-budget-input" placeholder="2,800" class="modern-input pl-8 text-center font-semibold">
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">How much you want to spend each month (the rest goes to savings/goals)</div>
                </div>
            </div>
        </div>

        <!-- Step 2: Goal Selection -->
        <div id="clean-step-2" class="clean-onboarding-step p-6 hidden">
            <h2 class="text-xl font-semibold mb-2 text-center">What's Your Main Goal?</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Choose your primary financial focus</p>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="clean-goal-option p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="house">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">🏠</div>
                        <h3 class="font-medium text-sm">House Deposit</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="emergency">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">💰</div>
                        <h3 class="font-medium text-sm">Emergency Fund</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="debt">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">💳</div>
                        <h3 class="font-medium text-sm">Pay Off Debt</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="vacation">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">✈️</div>
                        <h3 class="font-medium text-sm">Vacation</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="investment">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">📈</div>
                        <h3 class="font-medium text-sm">Investing</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="custom">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">🎯</div>
                        <h3 class="font-medium text-sm">Custom Goal</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Goal Details -->
        <div id="clean-step-3" class="clean-onboarding-step p-6 hidden">
            <div id="clean-goal-details-content">
                <!-- Dynamic content -->
            </div>
        </div>

        <!-- Step 4: Debts -->
        <div id="clean-step-4" class="clean-onboarding-step p-6 hidden">
            <h2 class="text-xl font-semibold mb-2 text-center">Current Debts</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Help us factor debts into your plan</p>
            
            <div id="clean-debt-list" class="space-y-3 mb-4"></div>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="addCleanDebt()" class="modern-button modern-button-secondary w-full">+ Add Debt</button>
                <button onclick="skipCleanDebts()" class="modern-button modern-button-secondary w-full">No Debts</button>
            </div>
        </div>

        <!-- Step 5: Current Position -->
        <div id="clean-step-5" class="clean-onboarding-step p-6 hidden">
            <h2 class="text-xl font-semibold mb-2 text-center">Your Starting Point</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Tell us your current financial position</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Total Current Savings</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="clean-total-savings-input" placeholder="2,500" class="modern-input pl-8 text-center font-semibold">
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">All your savings across all accounts (emergency fund, house savings, general savings, etc.)</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Monthly Expenses (Estimate)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="clean-expenses-input" placeholder="2,200" class="modern-input pl-8 text-center font-semibold">
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">Your best guess of typical monthly spending on everything</div>
                </div>
            </div>
        </div>

        <!-- Step 6: Summary -->
        <div id="clean-step-6" class="clean-onboarding-step p-6 hidden">
            <h2 class="text-xl font-semibold mb-2 text-center">Your Plan Summary</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Here's what we calculated</p>
            
            <div id="clean-summary-content" class="space-y-3"></div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-between items-center p-6 border-t border-gray-200 dark:border-gray-600">
            <button id="clean-back-btn" onclick="goCleanBack()" class="modern-button modern-button-secondary min-w-[120px]">← Back</button>
            <button id="clean-next-btn" onclick="goCleanNext()" class="modern-button modern-button-primary min-w-[120px]">Next →</button>
        </div>
    </div>
</div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <script>
        // --- State Variables ---
        let expenses = [];
        let recurringItems = [];
        let selectedExpenseIds = new Set();
        let selectedRecurringIds = new Set();
        let editingExpense = null;
        let editingRecurring = null;
        let monthlyBudget = 2000.00;
        let monthlyIncome = 0;
        let monthlyExpenses = 0;
        let healthScoreHistory = {};
        let currencyConfig = {
            'AUD': { symbol: 'A$', locale: 'en-AU' },
            'CAD': { symbol: 'C$', locale: 'en-CA' },
            'EUR': { symbol: '€', locale: 'de-DE' },
            'GBP': { symbol: '£', locale: 'en-GB' },
            'JPY': { symbol: '¥', locale: 'ja-JP' },
            'USD': { symbol: '$', locale: 'en-US' }
        };
        let currentCurrencyCode = 'GBP';
        let activeTab = 'overview';
        let spendingTrendChart = null;
        let categorySpendingChart = null;
        let monthlySavingsChart = null;
        let aiSavingsCache = null;
        let aiSpendingCache = null;
        let lastAiUpdate = 0;
        // === GOAL SYSTEM ===
let userGoals = [];
let goalTemplates = {
    'savings_builder': {
        name: 'Savings Builder',
        icon: '💰',
        description: 'Focus on building your savings and emergency fund',
        goals: [
            { type: 'savings_rate', name: 'Save 20% of income', target: 20, unit: 'percent' },
            { type: 'emergency_fund', name: 'Build £1000 emergency fund', target: 1000, unit: 'currency' },
            { type: 'no_spend_days', name: '6 no-spend days per month', target: 6, unit: 'days' }
        ]
    },
    'spending_controller': {
        name: 'Spending Controller', 
        icon: '📉',
        description: 'Take control of your spending habits',
        goals: [
            { type: 'category_limit', name: 'Dining out limit', target: 80, unit: 'currency', category: 'Food/Drink' },
            { type: 'impulse_limit', name: 'No purchases over £40', target: 40, unit: 'currency' },
            { type: 'subscription_review', name: 'Review subscriptions monthly', target: 1, unit: 'boolean' }
        ]
    },
    'mindful_spender': {
        name: 'Mindful Spender',
        icon: '🎯', 
        description: 'Develop healthy spending habits',
        goals: [
            { type: 'coffee_budget', name: 'Coffee budget £25/month', target: 25, unit: 'currency', category: 'Food/Drink', keywords: ['coffee'] },
            { type: 'cook_home', name: 'Cook at home 20 days/month', target: 20, unit: 'days' },
            { type: 'no_spend_days', name: '8 no-spend days per month', target: 8, unit: 'days' }
        ]
    },
    'debt_fighter': {
        name: 'Debt Fighter',
        icon: '⚔️',
        description: 'Aggressive debt reduction and spending cuts',
        goals: [
            { type: 'total_spending_limit', name: 'Total spending under budget by 15%', target: 15, unit: 'percent' },
            { type: 'entertainment_limit', name: 'Entertainment under £50', target: 50, unit: 'currency', category: 'Entertainment' },
            { type: 'no_spend_days', name: '10 no-spend days per month', target: 10, unit: 'days' }
        ]
    }
};

        function stripISO(dateStr) {
            return (dateStr || '').split('T')[0];
        }

        const expenseCategories = ["Housing", "Utilities", "Transport", "Food/Drink", "Entertainment", "Shopping", "Health", "Personal Care", "Education", "Debt", "Subscriptions", "Other"];
        const incomeCategories = ["Salary", "Bonus", "Investment", "Gift", "Other Income"];

        // Keyword mapping for auto-categorization and essential status
        const categoryKeywords = {
            'Housing': ['rent', 'mortgage', 'property tax', 'home insurance'],
            'Utilities': ['gas', 'electricity', 'water', 'internet', 'phone', 'council tax'],
            'Transport': ['fuel', 'petrol', 'diesel', 'train', 'bus', 'tube', 'taxi', 'uber'],
            'Food/Drink': ['coffee', 'lunch', 'groceries', 'supermarket', 'restaurant', 'takeaway'],
            'Entertainment': ['cinema', 'concert', 'theatre', 'streaming', 'netflix', 'spotify', 'disney+'],
            'Shopping': ['clothes', 'electronics', 'gifts', 'amazon'],
            'Health': ['pharmacy', 'doctor', 'dentist', 'gym'],
            'Personal Care': ['haircut', 'toiletries'],
            'Education': ['books', 'course', 'tuition'],
            'Debt': ['loan', 'credit card'],
            'Subscriptions': ['subscription']
        };

        const essentialKeywords = [
            'rent', 'mortgage', 'property tax', 'home insurance', 'gas', 'electricity', 
            'water', 'internet', 'phone', 'council tax', 'fuel', 'petrol', 'diesel', 'train', 
            'bus', 'tube', 'groceries', 'supermarket', 'pharmacy', 'doctor', 'dentist', 
            'loan', 'credit card', 'tuition'
        ];

        // --- DOM Elements Cache ---
        let DOMElements = {};

        function cacheDOMElements() {
            DOMElements = {
            html: document.documentElement,
            // Modals & Forms
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            expenseName: document.getElementById('expense-name'),
            expenseCost: document.getElementById('expense-cost'),
            expenseType: document.getElementById('expense-type'),
            expenseCategory: document.getElementById('expense-category'),
            expenseDate: document.getElementById('expense-date'),
            expensePaymentMethod: document.getElementById('expense-payment-method'),
            modalCurrency: document.getElementById('modal-currency'),
            
            recurringModal: document.getElementById('recurring-modal'),
            recurringModalTitle: document.getElementById('recurring-modal-title'),
            recurringItemType: document.getElementById('recurring-item-type'),
            recurringName: document.getElementById('recurring-name'),
            recurringAmount: document.getElementById('recurring-amount'),
            recurringFrequency: document.getElementById('recurring-frequency'),
            recurringCategory: document.getElementById('recurring-category'),
            recurringEssentialTypeWrapper: document.getElementById('recurring-essential-type-wrapper'),
            recurringEssentialType: document.getElementById('recurring-essential-type'),
            recurringPaymentMethod: document.getElementById('recurring-payment-method'),
            recurringStartDate: document.getElementById('recurring-start-date'),
            recurringEndDate: document.getElementById('recurring-end-date'),
            recurringModalCurrency: document.getElementById('recurring-modal-currency'),

            monthlyBudgetDisplay: document.getElementById('monthly-budget'),
            budgetInput: document.getElementById('budget-input'),
            incomeInput: document.getElementById('income-input'),
            totalExpensesDisplay: document.getElementById('total-expenses'),
            remainingAmountDisplay: document.getElementById('remaining-amount'),
            totalIncomeDisplay: document.getElementById('total-income'),
            budgetBar: document.getElementById('budget-bar'),
            budgetPercentage: document.getElementById('budget-percentage'),
            healthScoreFill: document.getElementById('health-score-fill'),
            healthScoreValue: document.getElementById('health-score-value'),
            healthScoreLabel: document.getElementById('health-score-label'),
            essentialSpendingDisplay: document.getElementById('essential-spending'),
            nonEssentialSpendingDisplay: document.getElementById('non-essential-spending'),
            essentialBar: document.getElementById('essential-bar'),
            nonEssentialBar: document.getElementById('non-essential-bar'),
            recentExpensesContainer: document.getElementById('recent-expenses'),
            expensesTableBody: document.getElementById('expenses-table'),
            recurringTableBody: document.getElementById('recurring-table'),
            settingsMenu: document.getElementById('settings-menu'),
            themeToggle: document.getElementById('theme-toggle'),
            currencySelect: document.getElementById('currency-select'),
            toast: document.getElementById('toast'),
            
            spendingTrendCanvas: document.getElementById('spending-trend-chart'),
            categorySpendingCanvas: document.getElementById('category-spending-chart'),
            monthlySavingsCanvas: document.getElementById('monthly-savings-chart'),
            spendingInsightsContainer: document.getElementById('spending-insights'),
            aiSavingsInsightsContainer: document.getElementById('ai-savings-insights'),

            selectAllExpensesCheckbox: document.getElementById('select-all-expenses'),
            deleteSelectedBtn: document.getElementById('delete-selected-btn'),
            selectAllRecurringCheckbox: document.getElementById('select-all-recurring'),
            deleteSelectedRecurringBtn: document.getElementById('delete-selected-recurring-btn'),
            
            // New Health Score Elements
            healthScoreVisual: document.getElementById('health-score-visual'),
            healthScoreTrend: document.getElementById('health-score-trend'),
            healthScoreTooltip: document.getElementById('health-score-tooltip'),
            aiProjectionContainer: document.getElementById('ai-projection-container'),
            };
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            cacheDOMElements();
            loadData();
            processRecurringExpenses();
            populateCategoryDropdowns();
            applyTheme();
            updateCurrencyUI();
            updateDisplay();
            showTab(activeTab);
            DOMElements.expenseDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];

            // Add event listener for auto-categorization
            DOMElements.expenseName.addEventListener('input', autoCategorizeExpense);
            DOMElements.recurringName.addEventListener('input', autoCategorizeExpense);
            
            startOnboardingProcess();
        });

        // --- Recurring Expense Processing ---
        function processRecurringExpenses() {
            let newExpensesGenerated = 0;
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            recurringItems.forEach(item => {
                if (item.status !== 'active' || item.type !== 'expense') {
                return;
            }

                const itemStartDate = new Date(item.startDate + 'T00:00:00');
                if (itemStartDate > today) return;

                let currentDate = new Date(itemStartDate);
                const itemEndDate = item.endDate ? new Date(item.endDate + 'T00:00:00') : today;

                let iterations = 0;
                while (currentDate <= itemEndDate && currentDate <= today && iterations < 1000) {
                    // Fix: Use local date string to avoid timezone issues
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    
                    const instanceId = `auto-${item.id}-${dateStr}`;
                    
                    if (!expenses.some(e => e.id === instanceId)) {
                        expenses.push({
                            id: instanceId,
                            name: item.name,
                            cost: item.amount,
                            type: item.essentialType || 'Non-Essential',
                            category: item.category,
                            date: dateStr,
                            paymentMethod: item.paymentMethod,
                            status: 'active',
                            recurringSourceId: item.id
                        });
                        newExpensesGenerated++;
                    }

                    // Get next date
                    switch (item.frequency) {
                        case 'Daily': currentDate.setDate(currentDate.getDate() + 1); break;
                        case 'Weekly': currentDate.setDate(currentDate.getDate() + 7); break;
                        case 'Bi-Weekly': currentDate.setDate(currentDate.getDate() + 14); break;
                        case 'Monthly': currentDate.setMonth(currentDate.getMonth() + 1); break;
                        case 'Quarterly': currentDate.setMonth(currentDate.getMonth() + 3); break;
                        case 'Annual': currentDate.setFullYear(currentDate.getFullYear() + 1); break;
                        default: iterations = 1000; break;
                    }
                    iterations++;
                }
            });

            if (newExpensesGenerated > 0) {
                sortExpenses();
                showToast(`${newExpensesGenerated} new recurring expense(s) have been added.`, 'info');
                saveData();
            }
        }

        // --- Expense Sorting ---
        function sortExpenses() {
            expenses.sort((a, b) => {
                // First sort by date (newest first)
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                // For same dates, sort by ID (newest first)
                // Handle both string and numeric IDs
                const getNumericId = (id) => {
                    if (typeof id === 'string') {
                        // Extract numeric part from auto-generated IDs
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return id;
                };
                
                return getNumericId(b.id) - getNumericId(a.id);
            });
            }

        // --- Onboarding ---
        function startOnboardingProcess() {
            const firstVisit = localStorage.getItem('onboardingComplete') !== 'true';
            if (firstVisit) {
                document.getElementById('clean-onboarding-modal').classList.remove('hidden');
                updateCleanOnboardingStep();
            }
        }

        // === NEW CLEAN ONBOARDING SYSTEM ===
let cleanOnboardingData = {
    currentStep: 1,
    totalSteps: 6,
    data: {
        monthlyIncome: 0,
        monthlyBudget: 0,
        primaryGoal: null,
        goalDetails: {},
        debts: [],
        totalSavings: 0,
        monthlyExpenses: 0
    }
};

function goCleanNext() {
    // Save current step data before validation
    saveCurrentStepData();
    
    // Validate this step; stop if errors
    if (!validateCleanStep()) return;

    // Skip debt step unless primary goal is 'debt'
    if (cleanOnboardingData.currentStep === 3 && cleanOnboardingData.data.primaryGoal !== 'debt') {
        cleanOnboardingData.currentStep = 5;
    } else {
        cleanOnboardingData.currentStep++;
    }

    // If we've gone past the last step, complete onboarding
    if (cleanOnboardingData.currentStep > cleanOnboardingData.totalSteps) {
        finishCleanOnboarding();
    } else {
        updateCleanOnboardingStep();
    }
}

function goCleanBack() {
    if (cleanOnboardingData.currentStep > 1) {
        // Save current step data before going back
        saveCurrentStepData();
        
        if (cleanOnboardingData.currentStep === 5 && cleanOnboardingData.data.primaryGoal !== 'debt') {
            cleanOnboardingData.currentStep = 3;
        } else {
            cleanOnboardingData.currentStep--;
        }
        updateCleanOnboardingStep();
    }
}

function updateCleanOnboardingStep() {
    // Hide all steps
    document.querySelectorAll('.clean-onboarding-step').forEach(step => {
        step.classList.add('hidden');
    });
    
    // Show current step
    document.getElementById(`clean-step-${cleanOnboardingData.currentStep}`).classList.remove('hidden');
    
    // Update progress
    const progress = (cleanOnboardingData.currentStep / cleanOnboardingData.totalSteps) * 100;
    document.getElementById('clean-progress-fill').style.width = `${progress}%`;
    document.getElementById('clean-step-indicator').textContent = `Step ${cleanOnboardingData.currentStep} of ${cleanOnboardingData.totalSteps}`;
    
    // Update navigation
    document.getElementById('clean-back-btn').style.visibility = cleanOnboardingData.currentStep === 1 ? 'hidden' : 'visible';
    document.getElementById('clean-next-btn').textContent = cleanOnboardingData.currentStep === cleanOnboardingData.totalSteps ? 'Complete Setup' : 'Next →';
    
    // Prepare step-specific content
    if (cleanOnboardingData.currentStep === 3) {
        prepareCleanGoalDetails();
    } else if (cleanOnboardingData.currentStep === 6) {
        generateCleanSummary();
    }
    
    // Restore form data for current step
    restoreCurrentStepData();
}

function validateCleanStep() {
    const data = cleanOnboardingData.data;
    
    switch(cleanOnboardingData.currentStep) {
        case 1:
            const income = parseFloat(document.getElementById('clean-income-input').value);
            const budget = parseFloat(document.getElementById('clean-budget-input').value);
            if (!income || !budget || income <= 0 || budget <= 0) {
                showToast('Please enter valid income and budget amounts', 'error');
                return false;
            }
            if (budget >= income) {
                showToast('Your budget should be less than your income to allow for savings', 'error');
                return false;
            }
            data.monthlyIncome = income;
            data.monthlyBudget = budget;
            return true;
            
        case 2:
            if (!data.primaryGoal) {
                showToast('Please select a primary goal', 'error');
                return false;
            }
            return true;
            
        case 3:
            const goal = cleanOnboardingData.data.primaryGoal;
            
            if (!goal) return false;
            
            if (goal === 'house') {
                const target = document.getElementById('house-target')?.value;
                const timeline = document.getElementById('house-timeline')?.value;
                if (!target || !timeline) {
                    showToast('Please fill in all house goal details', 'error');
                    return false;
                }
                cleanOnboardingData.data.goalDetails['house-target'] = parseFloat(target);
                cleanOnboardingData.data.goalDetails['house-timeline'] = timeline;
                cleanOnboardingData.data.goalDetails['house-current'] = parseFloat(document.getElementById('house-current')?.value || 0);
            }
            
            return true;
            
        case 4:
            cleanOnboardingData.data.debts = [];
            return true;
            
        case 5:
            const savings = parseFloat(document.getElementById('clean-total-savings-input').value) || 0;
            const expenses = parseFloat(document.getElementById('clean-expenses-input').value);
            if (!expenses || expenses <= 0) {
                showToast('Please enter your estimated monthly expenses', 'error');
                return false;
            }
            data.totalSavings = savings;
            data.monthlyExpenses = expenses;
            return true;
            
        default:
            return true;
    }
}

function finishCleanOnboarding() {
    const data = cleanOnboardingData.data;
    
    // Update main app variables
    monthlyIncome = data.monthlyIncome;
    monthlyBudget = data.monthlyBudget;
    monthlyExpenses = data.monthlyExpenses;
    
    // Create real goals
    userGoals = [];
    
    if (data.primaryGoal === 'house') {
        userGoals.push({
            id: Date.now(),
            type: 'house_deposit',
            name: 'House Deposit',
            target: data.goalDetails['house-target'] || 0,
            currentProgress: data.goalDetails['house-current'] || 0,
            unit: 'currency',
            timeline: data.goalDetails['house-timeline'],
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    if (data.primaryGoal === 'emergency') {
        const months = parseInt(data.goalDetails['emergency-months']?.charAt(0)) || 6;
        userGoals.push({
            id: Date.now() + 1,
            type: 'emergency_fund',
            name: `${months}-Month Emergency Fund`,
            target: data.monthlyExpenses * months,
            currentProgress: data.goalDetails['emergency-current'] || 0,
            unit: 'currency',
            months: months,
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    // Add debts as recurring items
    data.debts.forEach(debt => {
        recurringItems.push({
            id: Date.now() + Math.random(),
            type: 'expense',
            name: `${debt.name} Payment`,
            amount: Math.max(debt.balance * 0.02, 25),
            frequency: 'Monthly',
            category: 'Debt',
            essentialType: 'Essential',
            startDate: new Date().toISOString().split('T')[0],
            status: 'active',
            debtBalance: debt.balance,
            debtInterest: debt.interest
        });
    });
    
    // Save everything
    saveData();
    localStorage.setItem('onboardingComplete', 'true');
    localStorage.setItem('cleanOnboardingData', JSON.stringify(data));
    
    // Close modal and update display
    document.getElementById('clean-onboarding-modal').classList.add('hidden');
    updateDisplay();
    
    showToast('Welcome to Lens! Your personalized financial tracker is ready.', 'success');
    
    // Start tour
    setTimeout(() => {
        if (localStorage.getItem('tourComplete') !== 'true') {
            launchOnboardingTour();
        }
    }, 1000);
}

// === FIXES FOR THE 4 ERRORS ===

// 1. ADD missing prepareCleanGoalDetails function
function prepareCleanGoalDetails() {
    const container = document.getElementById('clean-goal-details-content');
    const goal = cleanOnboardingData.data.primaryGoal;
    
    const configs = {
        house: {
            title: '🏠 House Deposit Goal',
            subtitle: 'Tell us about your house purchase plan',
            fields: [
                { id: 'house-target', label: 'Target Deposit Amount', placeholder: '50,000', type: 'currency' },
                { id: 'house-timeline', label: 'Purchase Timeline', type: 'select', options: ['1 year', '2 years', '3 years', '4 years', '5+ years'] },
                { id: 'house-current', label: 'Current House Deposit Savings', placeholder: '5,000', type: 'currency', help: 'Money you\'ve already saved specifically for the house deposit (part of your total savings)' }
            ]
        },
        emergency: {
            title: '💰 Emergency Fund Goal',
            subtitle: 'Build your financial safety net',
            fields: [
                { id: 'emergency-months', label: 'Target Coverage', type: 'select', options: ['3 months expenses', '4 months expenses', '5 months expenses', '6 months expenses', '12 months expenses'] },
                { id: 'emergency-current', label: 'Current Emergency Fund', placeholder: '1,000', type: 'currency', help: 'Money already set aside for emergencies (part of your total savings)' }
            ]
        },
        debt: {
            title: '💳 Debt Payoff Strategy',
            subtitle: 'Choose your debt elimination approach',
            fields: [
                { id: 'debt-strategy', label: 'Payoff Strategy', type: 'select', options: ['Avalanche (highest interest first)', 'Snowball (smallest balance first)', 'Equal payments'] }
            ]
        },
        vacation: {
            title: '✈️ Vacation Goal',
            subtitle: 'Plan your dream trip',
            fields: [
                { id: 'vacation-cost', label: 'Total Trip Cost', placeholder: '3,000', type: 'currency' },
                { id: 'vacation-when', label: 'When do you want to go?', type: 'select', options: ['6 months', '1 year', '18 months', '2 years'] },
                { id: 'vacation-current', label: 'Current Vacation Savings', placeholder: '500', type: 'currency', help: 'Money already saved for vacation (part of your total savings)' }
            ]
        },
        investment: {
            title: '📈 Investment Goal',
            subtitle: 'Build your investment portfolio',
            fields: [
                { id: 'investment-target', label: 'Investment Target', placeholder: '10,000', type: 'currency' },
                { id: 'investment-timeline', label: 'Timeline', type: 'select', options: ['1 year', '3 years', '5 years', '10+ years'] },
                { id: 'investment-current', label: 'Current Investment Savings', placeholder: '1,000', type: 'currency', help: 'Money already set aside for investing (part of your total savings)' }
            ]
        },
        custom: {
            title: '🎯 Custom Goal',
            subtitle: 'Set your own financial target',
            fields: [
                { id: 'custom-name', label: 'Goal Name', placeholder: 'My Financial Goal', type: 'text' },
                { id: 'custom-target', label: 'Target Amount', placeholder: '5,000', type: 'currency' },
                { id: 'custom-timeline', label: 'Timeline', type: 'select', options: ['6 months', '1 year', '2 years', '3 years', '5+ years'] },
                { id: 'custom-current', label: 'Current Progress', placeholder: '0', type: 'currency', help: 'Money already saved toward this goal' }
            ]
        }
    };
    
    const config = configs[goal];
    if (!config) return;
    
    container.innerHTML = `
        <h2 class="text-xl font-semibold mb-2 text-center">${config.title}</h2>
        <p class="text-gray-600 dark:text-gray-400 text-center mb-6">${config.subtitle}</p>
        
        <div class="space-y-4">
            ${config.fields.map(field => {
                if (field.type === 'select') {
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${field.label}</label>
                            <select id="${field.id}" class="modern-select font-medium">
                                <option value="">Select...</option>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                            ${field.help ? `<div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">${field.help}</div>` : ''}
                        </div>
                    `;
                } else if (field.type === 'currency') {
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${field.label}</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                                <input type="number" id="${field.id}" placeholder="${field.placeholder}" class="modern-input pl-8 text-center font-semibold">
                            </div>
                            ${field.help ? `<div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">${field.help}</div>` : ''}
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${field.label}</label>
                            <input type="${field.type}" id="${field.id}" placeholder="${field.placeholder}" class="modern-input text-center font-medium">
                            ${field.help ? `<div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">${field.help}</div>` : ''}
                        </div>
                    `;
                }
            }).join('')}
        </div>
    `;
}

// 2. ADD missing validateCleanGoalDetails function
function validateCleanGoalDetails() {
    const inputs = document.querySelectorAll('#clean-goal-details-content input, #clean-goal-details-content select');
    let valid = true;
    
    inputs.forEach(input => {
        if (input.type === 'number') {
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0) {
                valid = false;
            } else {
                cleanOnboardingData.data.goalDetails[input.id] = value;
            }
        } else {
            if (!input.value.trim()) {
                valid = false;
            } else {
                cleanOnboardingData.data.goalDetails[input.id] = input.value;
            }
        }
    });
    
    if (!valid) {
        showToast('Please fill in all goal details', 'error');
        return false;
    }
    return true;
}

// 3. ADD missing debt management functions
function addCleanDebt() {
    const debtList = document.getElementById('clean-debt-list');
    const debtItem = document.createElement('div');
    debtItem.className = 'clean-debt-item';
    debtItem.innerHTML = `
        <div class="space-y-3">
            <input type="text" placeholder="Debt name (e.g., Credit Card)" class="modern-input debt-name text-sm font-medium text-center">
            <div class="grid grid-cols-2 gap-2">
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium text-sm">£</span>
                    <input type="number" placeholder="5,000" class="modern-input pl-8 debt-balance text-sm font-semibold text-center">
                </div>
                <input type="number" placeholder="18.9%" step="0.1" class="modern-input debt-interest text-sm font-semibold text-center">
            </div>
            <button onclick="removeCleanDebt(this)" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
        </div>
    `;
    debtList.appendChild(debtItem);
}

function removeCleanDebt(button) {
    button.closest('.clean-debt-item').remove();
}

function skipCleanDebts() {
    cleanOnboardingData.data.debts = [];
    goCleanNext();
}

function collectCleanDebts() {
    cleanOnboardingData.data.debts = [];
    document.querySelectorAll('.clean-debt-item').forEach(item => {
        const name = item.querySelector('.debt-name').value;
        const balance = parseFloat(item.querySelector('.debt-balance').value);
        const interest = parseFloat(item.querySelector('.debt-interest').value);
        
        if (name && !isNaN(balance) && balance > 0) {
            cleanOnboardingData.data.debts.push({
                name: name,
                balance: balance,
                interest: interest || 0
            });
        }
    });
}

// Data persistence functions
function saveCurrentStepData() {
    const step = cleanOnboardingData.currentStep;
    
    try {
        switch (step) {
            case 1:
                // Save income and budget
                const incomeInput = document.getElementById('clean-income-input');
                const budgetInput = document.getElementById('clean-budget-input');
                if (incomeInput) cleanOnboardingData.data.monthlyIncome = parseFloat(incomeInput.value) || 0;
                if (budgetInput) cleanOnboardingData.data.monthlyBudget = parseFloat(budgetInput.value) || 0;
                break;
                
            case 2:
                // Save selected goal - handled by click event
                break;
                
            case 3:
                // Save goal details - collect all inputs in the dynamic content
                const goalInputs = document.querySelectorAll('#clean-goal-details-content input, #clean-goal-details-content select');
                goalInputs.forEach(input => {
                    if (input.value) {
                        cleanOnboardingData.data.goalDetails[input.id] = input.value;
                    }
                });
                break;
                
            case 4:
                // Save debts - handled by collectCleanDebts function
                collectCleanDebts();
                break;
                
            case 5:
                // Save current position
                const savingsInput = document.getElementById('clean-total-savings-input');
                const expensesInput = document.getElementById('clean-expenses-input');
                if (savingsInput) cleanOnboardingData.data.totalSavings = parseFloat(savingsInput.value) || 0;
                if (expensesInput) cleanOnboardingData.data.monthlyExpenses = parseFloat(expensesInput.value) || 0;
                break;
        }
    } catch (error) {
        console.log('Error saving step data:', error);
    }
}

function restoreCurrentStepData() {
    const step = cleanOnboardingData.currentStep;
    const data = cleanOnboardingData.data;
    
    try {
        switch (step) {
            case 1:
                // Restore income and budget
                const incomeInput = document.getElementById('clean-income-input');
                const budgetInput = document.getElementById('clean-budget-input');
                if (incomeInput && data.monthlyIncome) incomeInput.value = data.monthlyIncome;
                if (budgetInput && data.monthlyBudget) budgetInput.value = data.monthlyBudget;
                break;
                
            case 2:
                // Restore selected goal
                if (data.primaryGoal) {
                    const selectedOption = document.querySelector(`[data-goal="${data.primaryGoal}"]`);
                    if (selectedOption) {
                        document.querySelectorAll('.clean-goal-option').forEach(opt => opt.classList.remove('selected'));
                        selectedOption.classList.add('selected');
                    }
                }
                break;
                
            case 3:
                // Restore goal details - wait for dynamic content to load
                setTimeout(() => {
                    Object.keys(data.goalDetails).forEach(fieldId => {
                        const input = document.getElementById(fieldId);
                        if (input && data.goalDetails[fieldId]) {
                            input.value = data.goalDetails[fieldId];
                        }
                    });
                }, 100);
                break;
                
            case 4:
                // Restore debts
                restoreDebts();
                break;
                
            case 5:
                // Restore current position
                const savingsInput = document.getElementById('clean-total-savings-input');
                const expensesInput = document.getElementById('clean-expenses-input');
                if (savingsInput && data.totalSavings) savingsInput.value = data.totalSavings;
                if (expensesInput && data.monthlyExpenses) expensesInput.value = data.monthlyExpenses;
                break;
        }
    } catch (error) {
        console.log('Error restoring step data:', error);
    }
}

function restoreDebts() {
    const debtList = document.getElementById('clean-debt-list');
    if (!debtList) return;
    
    // Clear existing debt items
    debtList.innerHTML = '';
    
    // Restore saved debts
    cleanOnboardingData.data.debts.forEach(debt => {
        addCleanDebt();
        const lastDebtItem = debtList.lastElementChild;
        if (lastDebtItem) {
            const nameInput = lastDebtItem.querySelector('.debt-name');
            const balanceInput = lastDebtItem.querySelector('.debt-balance');
            const interestInput = lastDebtItem.querySelector('.debt-interest');
            
            if (nameInput) nameInput.value = debt.name || '';
            if (balanceInput) balanceInput.value = debt.balance || '';
            if (interestInput) interestInput.value = debt.interest || '';
        }
    });
}

// 4. ADD missing generateCleanSummary function
function generateCleanSummary() {
    const container = document.getElementById('clean-summary-content');
    const data = cleanOnboardingData.data;
    
    const monthlySurplus = data.monthlyIncome - data.monthlyExpenses;
    const totalDebt = data.debts.reduce((sum, debt) => sum + debt.balance, 0);
    
    let goalSummary = '';
    if (data.primaryGoal === 'house') {
        const target = data.goalDetails['house-target'] || 0;
        const current = data.goalDetails['house-current'] || 0;
        const needed = target - current;
        const months = Math.ceil(needed / Math.max(monthlySurplus, 100));
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">🏠</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">House Deposit Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months} months</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'emergency') {
        const months = parseInt(data.goalDetails['emergency-months']?.charAt(0)) || 6;
        const target = data.monthlyExpenses * months;
        const current = data.goalDetails['emergency-current'] || 0;
        const needed = target - current;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">💰</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Emergency Fund Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">£${target.toLocaleString()} (${months} months)</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Current coverage:</span>
                                <span class="highlight-number font-mono">${data.monthlyExpenses > 0 ? (current/data.monthlyExpenses).toFixed(1) : '0.0'} months</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'vacation') {
        const target = data.goalDetails['vacation-cost'] || 0;
        const current = data.goalDetails['vacation-current'] || 0;
        const needed = target - current;
        const months = Math.ceil(needed / Math.max(monthlySurplus, 100));
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">✈️</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Vacation Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months} months</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'investment') {
        const monthlyTarget = data.goalDetails['investment-monthly'] || 0;
        const annualTarget = monthlyTarget * 12;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">📈</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Investment Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly Target:</span>
                                <span class="highlight-number font-mono">£${monthlyTarget.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Annual Target:</span>
                                <span class="highlight-number font-mono">£${annualTarget.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Type:</span>
                                <span class="highlight-number font-mono">${data.goalDetails['investment-type'] || 'General Investment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'custom') {
        const target = data.goalDetails['custom-amount'] || 0;
        const current = data.goalDetails['custom-current'] || 0;
        const needed = target - current;
        const months = Math.ceil(needed / Math.max(monthlySurplus, 100));
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">🎯</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">${data.goalDetails['custom-name'] || 'Custom Goal'}</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months} months</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = `
        <div class="clean-summary-card">
            <div class="flex gap-2">
                <div class="text-lg flex-shrink-0">💡</div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-semibold mb-2">Financial Overview</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span>Monthly Income:</span>
                            <span class="highlight-number font-mono">£${data.monthlyIncome.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span>Monthly Surplus:</span>
                            <span class="highlight-number font-mono">£${monthlySurplus.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span>Total Savings:</span>
                            <span class="highlight-number font-mono">£${data.totalSavings.toLocaleString()}</span>
                        </div>
                        ${totalDebt > 0 ? `<div class="flex justify-between items-center text-sm gap-2">
                            <span>Total Debt:</span>
                            <span class="highlight-number text-red-600 font-mono">£${totalDebt.toLocaleString()}</span>
                        </div>` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        ${goalSummary}
        
        <div class="clean-summary-card">
            <div class="flex gap-2">
                <div class="text-lg flex-shrink-0">🎯</div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-semibold mb-2">What's Next</h3>
                    <ul class="text-sm space-y-1 list-disc list-inside text-gray-600 dark:text-gray-400">
                        <li>Track expenses with real-time goal impact</li>
                        <li>Get personalized spending recommendations</li>
                        <li>Monitor progress toward your ${data.primaryGoal} goal</li>
                        <li>Receive smart financial insights</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
}

// Goal selection handler
document.addEventListener('click', function(e) {
    if (e.target.closest('.clean-goal-option')) {
        const option = e.target.closest('.clean-goal-option');
        const goalType = option.getAttribute('data-goal');
        
        // Clear previous selections
        document.querySelectorAll('.clean-goal-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // Select this option
        option.classList.add('selected');
        cleanOnboardingData.data.primaryGoal = goalType;
    }
});

        function launchOnboardingTour() {
            localStorage.setItem('tourComplete', 'true');
            const driver = window.driver?.js?.driver;
            if (!driver) {
                console.log('Driver.js not available, skipping tour');
                return;
            }
            
            const isMobile = window.innerWidth < 768;

            const desktopSteps = [
                {
                    element: '[data-tour="app-header"]',
                    popover: { title: 'Welcome to Lens!', description: "Let's take a quick tour to get you started.", side: "bottom", align: 'start' }
                },
                {
                    element: 'button[onclick="openSettings(\'budget\')"]',
                    popover: { title: 'Set Your Budget & Income', description: 'This is the baseline for all tracking.', side: "top", align: 'center' }
                },
                {
                    element: '.card button[onclick="showAddForm()"]',
                    popover: { title: 'Add a New Expense', description: 'Use this button to log any one-time purchases or expenses.', side: "left", align: 'start' }
                }
            ];

            const mobileSteps = [
                {
                    element: '[data-tour="app-header"]',
                    popover: { title: 'Welcome to Lens!', description: "Let's take a quick tour to get you started.", side: "bottom", align: 'start' }
                }
            ];

            const driverObj = driver({
                showProgress: true,
                popoverClass: 'driver-popover',
                steps: isMobile ? mobileSteps : desktopSteps,
                onDestroyed: () => {
                    localStorage.setItem('tourComplete', 'true');
                }
            });

            driverObj.drive();
        }

        // === GOAL SYSTEM FUNCTIONS ===

function renderGoalTemplates() {
    const container = document.getElementById('goal-templates-container');
    container.innerHTML = Object.entries(goalTemplates).map(([key, template]) => `
        <div onclick="selectGoalTemplate('${key}')" class="p-6 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
            <div class="text-center">
                <div class="text-4xl mb-3">${template.icon}</div>
                <h4 class="text-lg font-semibold mb-2">${template.name}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${template.description}</p>
                <div class="text-xs text-left space-y-1">
                    ${template.goals.map(goal => `
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                            <span>${goal.name}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');
}


function removeGoal(index) {
    const goalElement = document.querySelector(`#goals-list > div:nth-child(${index + 1})`);
    if (goalElement) {
        goalElement.remove();
    }
}


// === GOAL PROGRESS TRACKING ===

function calculateGoalProgress() {
    if (!userGoals || userGoals.length === 0) return;
    
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    userGoals.forEach(goal => {
        // Skip automatic calculation for manually edited goals
        if (goal.manuallyEdited) return;
        
        switch(goal.type) {
            case 'savings_rate':
                goal.currentProgress = calculateSavingsRateProgress(currentMonth, currentYear);
                break;
            case 'category_limit':
            case 'coffee_budget':
                goal.currentProgress = calculateCategorySpendingProgress(goal, currentMonth, currentYear);
                break;
            case 'no_spend_days':
                goal.currentProgress = calculateNoSpendDaysProgress(currentMonth, currentYear);
                break;
            case 'cook_home':
                goal.currentProgress = calculateCookHomeProgress(currentMonth, currentYear);
                break;
            case 'total_spending_limit':
                goal.currentProgress = calculateTotalSpendingProgress(goal, currentMonth, currentYear);
                break;
            case 'impulse_limit':
                goal.currentProgress = calculateImpulseLimitProgress(goal, currentMonth, currentYear);
                break;
            case 'emergency_fund':
                // Don't auto-calculate for house_deposit and emergency_fund 
                // These are manual savings goals
                if (!goal.manuallyEdited) {
                    goal.currentProgress = calculateEmergencyFundProgress(goal);
                }
                break;
        }
    });
    
    saveData();
}

function calculateSavingsRateProgress(month, year) {
    const monthlyRecurring = getMonthlyRecurringTotals(year, month);
    const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;
    const totalSpent = getMonthlyExpenseTotal(year, month);
    
    if (totalMonthlyIncome === 0) return 0;
    
    const actualSavingsRate = ((totalMonthlyIncome - totalSpent) / totalMonthlyIncome) * 100;
    return Math.max(0, actualSavingsRate);
}

function calculateCategorySpendingProgress(goal, month, year) {
    let categorySpending = 0;
    
    const monthlyExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year &&
               e.category === goal.category;
    });
    
    if (goal.keywords && goal.keywords.length > 0) {
        // Filter by keywords (e.g., coffee)
        categorySpending = monthlyExpenses
            .filter(e => goal.keywords.some(keyword => 
                e.name.toLowerCase().includes(keyword.toLowerCase())
            ))
            .reduce((sum, e) => sum + e.cost, 0);
    } else {
        categorySpending = monthlyExpenses.reduce((sum, e) => sum + e.cost, 0);
    }
    
    // Return percentage of goal used (inverted - lower spending = higher progress)
    const percentageUsed = (categorySpending / goal.target) * 100;
    return Math.max(0, 100 - percentageUsed);
}

function calculateNoSpendDaysProgress(month, year) {
    const monthlyExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year;
    });
    
    const spendingDays = new Set(monthlyExpenses.map(e => e.date)).size;
    const currentDay = new Date().getDate();
    const totalDaysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Calculate no-spend days so far
    const noSpendDays = Math.max(0, currentDay - spendingDays);
    return noSpendDays;
}

// Fix the missing calculation functions
function calculateCookHomeProgress(month, year) {
    // This is a placeholder - you'd need to track cooking vs dining out
    // For now, estimate based on food expenses
    const foodExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year &&
               e.category === 'Food/Drink';
    });
    
    const diningOutExpenses = foodExpenses.filter(e => 
        e.name.toLowerCase().includes('restaurant') ||
        e.name.toLowerCase().includes('takeaway') ||
        e.name.toLowerCase().includes('delivery')
    );
    
    const currentDay = new Date().getDate();
    const estimatedCookDays = Math.max(0, currentDay - diningOutExpenses.length);
    return estimatedCookDays;
}

function calculateTotalSpendingProgress(goal, month, year) {
    const totalSpent = getMonthlyExpenseTotal(year, month);
    const targetSpending = monthlyBudget * (1 - goal.target / 100);
    
    if (totalSpent <= targetSpending) {
        return 100; // Goal achieved
    } else {
        const overspend = totalSpent - targetSpending;
        return Math.max(0, 100 - (overspend / targetSpending) * 100);
    }
}

function calculateImpulseLimitProgress(goal, month, year) {
    const impulseExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year &&
               e.type === 'Non-Essential' &&
               e.cost > goal.target;
    });
    
    return impulseExpenses.length === 0 ? 100 : Math.max(0, 100 - impulseExpenses.length * 20);
}

function calculateEmergencyFundProgress(goal) {
    // Emergency fund progress should not be auto-calculated
    // It should only use the amount the user has specifically saved for emergencies
    // If no manual amount is set, return 0
    return goal.currentProgress || 0;
}

function updateGoalProgressDisplay() {
    calculateGoalProgress();
    
    if (!userGoals || userGoals.length === 0) {
        document.getElementById('goal-progress-display').textContent = 'No Goals';
        return;
    }
    
    const completedGoals = userGoals.filter(g => {
        if (g.unit === 'percent' || g.unit === 'currency') {
            return g.currentProgress >= g.target;
        } else if (g.unit === 'days') {
            return g.currentProgress >= g.target;
        }
                return false;
    }).length;
    
    document.getElementById('goal-progress-display').textContent = `${completedGoals}/${userGoals.length}`;
}

function openGoalsModal() {
    renderGoalsModal();
    document.getElementById('goals-modal').classList.remove('hidden');
}

function closeGoalsModal() {
    document.getElementById('goals-modal').classList.add('hidden');
}

function editGoals() {
    // Close the current goals modal
    closeGoalsModal();
    
    // Show the proper goal editing interface
    showGoalEditingInterface();
}

function showGoalEditingInterface() {
    document.getElementById('goal-editing-modal').classList.remove('hidden');
    renderGoalEditingInterface();
}

function closeGoalEditingModal() {
    document.getElementById('goal-editing-modal').classList.add('hidden');
}

function renderGoalEditingInterface() {
    const container = document.getElementById('goal-editing-content');
    
    if (!userGoals || userGoals.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">🎯</div>
                <p class="text-gray-600 dark:text-gray-400 mb-4">No goals set yet.</p>
                <button onclick="addNewGoal()" class="modern-button modern-button-primary">Add Your First Goal</button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-6">
            ${userGoals.map((goal, index) => renderGoalEditForm(goal, index)).join('')}
        </div>
    `;
}

function renderGoalEditForm(goal, index) {
    const goalTypeConfig = getGoalTypeConfig(goal.type);
    
    return `
        <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h4 class="text-lg font-semibold">${goalTypeConfig.icon} ${goal.name}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${goalTypeConfig.description}</p>
                </div>
                <button onclick="removeGoal(${index})" class="text-red-500 hover:text-red-700 font-medium text-sm">Remove</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Target Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="goal-${index}-target" value="${goal.target}" class="modern-input pl-8 text-center font-semibold" onchange="updateGoalProgress(${index})" oninput="updateGoalProgress(${index})">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Current Progress</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="goal-${index}-current" value="${goal.currentProgress}" class="modern-input pl-8 text-center font-semibold" onchange="updateGoalProgress(${index})" oninput="updateGoalProgress(${index})">
                    </div>
                </div>
                
                ${goal.timeline ? `
                <div>
                    <label class="block text-sm font-medium mb-2">Timeline</label>
                    <select id="goal-${index}-timeline" class="modern-select font-medium">
                        <option value="">Select...</option>
                        ${getTimelineOptions().map(opt => `
                            <option value="${opt}" ${goal.timeline === opt ? 'selected' : ''}>${opt}</option>
                        `).join('')}
                    </select>
                </div>
                ` : ''}
                
                ${goal.months ? `
                <div>
                    <label class="block text-sm font-medium mb-2">Coverage Period</label>
                    <select id="goal-${index}-months" class="modern-select font-medium">
                        <option value="">Select...</option>
                        ${getMonthOptions().map(opt => `
                            <option value="${opt}" ${goal.months === parseInt(opt.charAt(0)) ? 'selected' : ''}>${opt}</option>
                        `).join('')}
                    </select>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                        This updates the goal name only. Your target amount stays as you set it.
                    </div>
                </div>
                ` : ''}
            </div>
            
            <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded">
                <div class="flex justify-between text-sm">
                    <span>Progress: <span id="goal-${index}-progress-text" class="font-medium">${Math.round((goal.currentProgress / goal.target) * 100)}%</span></span>
                    <span>Remaining: <span id="goal-${index}-remaining-text" class="font-medium">£${(goal.target - goal.currentProgress).toLocaleString()}</span></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div id="goal-${index}-progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-500" style="width: ${Math.min((goal.currentProgress / goal.target) * 100, 100)}%"></div>
                </div>
            </div>
        </div>
    `;
}

function getGoalTypeConfig(type) {
    const configs = {
        'house_deposit': { icon: '🏠', description: 'House purchase deposit fund' },
        'emergency_fund': { icon: '💰', description: 'Emergency fund for unexpected expenses' },
        'vacation': { icon: '✈️', description: 'Dream vacation fund' },
        'investment': { icon: '📈', description: 'Investment portfolio building' },
        'custom': { icon: '🎯', description: 'Custom financial goal' }
    };
    return configs[type] || { icon: '🎯', description: 'Financial goal' };
}

function getTimelineOptions() {
    return ['6 months', '1 year', '18 months', '2 years', '3 years', '4 years', '5+ years'];
}

function getMonthOptions() {
    return ['3 months expenses', '4 months expenses', '5 months expenses', '6 months expenses', '12 months expenses'];
}

function updateGoalProgress(index) {
    const targetInput = document.getElementById(`goal-${index}-target`);
    const currentInput = document.getElementById(`goal-${index}-current`);
    const progressText = document.getElementById(`goal-${index}-progress-text`);
    const remainingText = document.getElementById(`goal-${index}-remaining-text`);
    const progressBar = document.getElementById(`goal-${index}-progress-bar`);
    
    if (targetInput && currentInput && progressText && remainingText && progressBar) {
        const target = parseFloat(targetInput.value) || 0;
        const current = parseFloat(currentInput.value) || 0;
        
        const progressPercent = target > 0 ? Math.round((current / target) * 100) : 0;
        const remaining = Math.max(target - current, 0);
        
        progressText.textContent = `${progressPercent}%`;
        remainingText.textContent = `£${remaining.toLocaleString()}`;
        progressBar.style.width = `${Math.min(progressPercent, 100)}%`;
    }
}

function addNewGoal() {
    const goalTypes = [
        { type: 'house_deposit', name: '🏠 House Deposit', description: 'Save for a house deposit' },
        { type: 'emergency_fund', name: '💰 Emergency Fund', description: 'Build an emergency fund' },
        { type: 'vacation', name: '✈️ Vacation', description: 'Save for a dream vacation' },
        { type: 'investment', name: '📈 Investment', description: 'Build investment portfolio' },
        { type: 'custom', name: '🎯 Custom Goal', description: 'Create a custom goal' }
    ];
    
    const container = document.getElementById('goal-editing-content');
    container.innerHTML = `
        <div class="text-center mb-6">
            <h4 class="text-lg font-semibold mb-2">Add New Goal</h4>
            <p class="text-gray-600 dark:text-gray-400">Choose the type of goal you want to add</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            ${goalTypes.map(type => `
                <div onclick="selectNewGoalType('${type.type}')" class="p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
                    <div class="text-center">
                        <div class="text-2xl mb-2">${type.name.split(' ')[0]}</div>
                        <h5 class="font-semibold mb-1">${type.name.substring(2)}</h5>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${type.description}</p>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="text-center">
            <button onclick="renderGoalEditingInterface()" class="modern-button modern-button-secondary">Back to Goals</button>
        </div>
    `;
}

function selectNewGoalType(goalType) {
    const newGoal = {
        id: Date.now(),
        type: goalType,
        name: getDefaultGoalName(goalType),
        target: 0,
        currentProgress: 0,
        unit: 'currency',
        status: 'active',
        priority: 'secondary',
        createdAt: new Date().toISOString()
    };
    
    // Only set months for emergency fund, but let user set their own target
    if (goalType === 'emergency_fund') {
        newGoal.months = 6;
        // Don't auto-calculate target - let user decide
    }
    
    userGoals.push(newGoal);
    renderGoalEditingInterface();
}

function getDefaultGoalName(type) {
    const names = {
        'house_deposit': 'House Deposit',
        'emergency_fund': '6-Month Emergency Fund',
        'vacation': 'Dream Vacation',
        'investment': 'Investment Portfolio',
        'custom': 'Custom Goal'
    };
    return names[type] || 'New Goal';
}

function removeGoal(index) {
    const goal = userGoals[index];
    showConfirmation({
        icon: '🗑️',
        title: 'Remove Goal',
        message: `Are you sure you want to remove "${goal.name}"? This action cannot be undone.`,
        confirmText: 'Remove',
        confirmClass: 'modern-button-danger',
        onConfirm: () => {
            userGoals.splice(index, 1);
            renderGoalEditingInterface();
            showToast('Goal removed successfully', 'info');
        }
    });
}

function showConfirmation(options) {
    const overlay = document.getElementById('goal-confirmation-overlay');
    const icon = document.getElementById('confirmation-icon');
    const title = document.getElementById('confirmation-title');
    const message = document.getElementById('confirmation-message');
    const button = document.getElementById('confirmation-button');
    
    // Set content
    icon.textContent = options.icon || '⚠️';
    title.textContent = options.title || 'Confirm Action';
    message.textContent = options.message || 'Are you sure you want to proceed?';
    button.textContent = options.confirmText || 'Confirm';
    
    // Set button style
    button.className = `modern-button px-6 ${options.confirmClass || 'modern-button-primary'}`;
    
    // Store callback
    window.currentConfirmationCallback = options.onConfirm;
    
    // Show overlay within the goal editing modal
    overlay.classList.remove('hidden');
}

function cancelConfirmation() {
    document.getElementById('goal-confirmation-overlay').classList.add('hidden');
    window.currentConfirmationCallback = null;
}

function confirmAction() {
    if (window.currentConfirmationCallback) {
        window.currentConfirmationCallback();
        window.currentConfirmationCallback = null;
    }
    document.getElementById('goal-confirmation-overlay').classList.add('hidden');
}

function saveGoalEdits() {
    // Update goals with new values from the forms
    userGoals.forEach((goal, index) => {
        const targetInput = document.getElementById(`goal-${index}-target`);
        const currentInput = document.getElementById(`goal-${index}-current`);
        const timelineInput = document.getElementById(`goal-${index}-timeline`);
        const monthsInput = document.getElementById(`goal-${index}-months`);
        
        // Always preserve user input values and mark as manually edited
        if (targetInput) {
            goal.target = parseFloat(targetInput.value) || 0;
            goal.manuallyEdited = true; // Prevent automatic calculation
        }
        if (currentInput) {
            goal.currentProgress = parseFloat(currentInput.value) || 0;
            goal.manuallyEdited = true; // Prevent automatic calculation
        }
        if (timelineInput) goal.timeline = timelineInput.value;
        
        // Only update months info if it exists, but DON'T override target
        if (monthsInput && goal.type === 'emergency_fund') {
            const months = parseInt(monthsInput.value.charAt(0));
            if (months) {
                goal.months = months;
                goal.name = `${months}-Month Emergency Fund`;
                // Don't override target - let user control it
            }
        }
    });
    
    // Save to localStorage
    saveData();
    
    // Update display
    updateDisplay();
    
    // Close modal and show success
    closeGoalEditingModal();
    showToast('Goals updated successfully!', 'success');
    
    // Refresh goals modal if it was open
    renderGoalsModal();
}

function renderGoalsModal() {
    const container = document.getElementById('goals-content');
    
    if (!userGoals || userGoals.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">🎯</div>
                <p class="text-gray-600 dark:text-gray-400">No goals set yet.</p>
                <button onclick="showGoalSelection()" class="modern-button modern-button-primary mt-4">Set Goals</button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = userGoals.map(goal => {
        const progressPercent = calculateGoalProgressPercent(goal);
        const isCompleted = progressPercent >= 100;
        
        return `
            <div class="p-4 border border-gray-200 dark:border-gray-600 rounded-lg mb-4 ${isCompleted ? 'bg-green-50 dark:bg-green-900/20 border-green-500' : ''}">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium">${goal.name}</h4>
                    ${isCompleted ? '<span class="text-green-600 text-xl">✅</span>' : ''}
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-purple-600 h-2 rounded-full transition-all duration-500" style="width: ${Math.min(progressPercent, 100)}%"></div>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">${formatGoalProgress(goal)}</span>
                    <span class="font-medium">${Math.round(progressPercent)}%</span>
                </div>
            </div>
        `;
    }).join('');
}

function calculateGoalProgressPercent(goal) {
    if (goal.unit === 'percent') {
        return (goal.currentProgress / goal.target) * 100;
    } else if (goal.unit === 'currency') {
        if (goal.type === 'category_limit' || goal.type === 'coffee_budget') {
            return goal.currentProgress; // Already calculated as percentage
        }
        return (goal.currentProgress / goal.target) * 100;
    } else if (goal.unit === 'days') {
        return (goal.currentProgress / goal.target) * 100;
    }
    return 0;
}

function formatGoalProgress(goal) {
    if (goal.unit === 'currency') {
        if (goal.type === 'category_limit' || goal.type === 'coffee_budget') {
            const spent = goal.target * (1 - goal.currentProgress / 100);
            return `${formatCurrency(spent)} / ${formatCurrency(goal.target)}`;
        } else if (goal.type === 'emergency_fund' && goal.months && monthlyExpenses > 0) {
            // Show coverage for emergency fund goals
            const coverageMonths = (goal.currentProgress / monthlyExpenses).toFixed(1);
            return `${formatCurrency(goal.currentProgress)} / ${formatCurrency(goal.target)} (${coverageMonths} months coverage)`;
        }
        return `${formatCurrency(goal.currentProgress)} / ${formatCurrency(goal.target)}`;
    } else if (goal.unit === 'percent') {
        return `${goal.currentProgress.toFixed(1)}% / ${goal.target}%`;
    } else if (goal.unit === 'days') {
        return `${goal.currentProgress} / ${goal.target} days`;
    }
    return `${goal.currentProgress} / ${goal.target}`;
}

function closeGoalSelection() {
    document.getElementById('goal-selection-modal').classList.add('hidden');
}

        // --- Tab Management ---
        function showTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            // Deactivate all desktop and mobile tab buttons
            document.querySelectorAll('.tab-button, .bottom-nav-item').forEach(button => button.classList.remove('active'));

            // Activate desktop tab button
            const desktopTabButton = document.getElementById(`tab-${tabName}`);
            if (desktopTabButton) desktopTabButton.classList.add('active');
            
            // Activate mobile tab button
            const mobileTabButton = document.getElementById(`mobile-tab-${tabName}`);
            if (mobileTabButton) mobileTabButton.classList.add('active');

            // Show the content panel
            const newTabContent = document.getElementById(`${tabName}-tab`);
            if (newTabContent) {
                newTabContent.classList.remove('hidden');
            }
            
                activeTab = tabName;

                if (activeTab === 'insights') {
                    updateChartsAndInsights();
                }
                saveData();
        }

        // --- Settings & Theme ---
        function toggleSettings() {
            DOMElements.settingsMenu.classList.toggle('hidden');
        }

        function toggleTheme(isDark) {
            localStorage.setItem('darkMode', isDark);
            applyTheme();
        }

        function applyTheme() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            DOMElements.html.classList.toggle('dark', darkMode);
            DOMElements.themeToggle.checked = darkMode;
            
            if (activeTab === 'insights') {
                updateChartsAndInsights(); 
            }
        }

        // --- Data Load/Save ---
        function loadData() {
            const data = localStorage.getItem('lensAppData');
            if (data) {
                const parsedData = JSON.parse(data);
                expenses = parsedData.expenses || [];
                recurringItems = parsedData.recurringItems || [];
                monthlyBudget = parsedData.monthlyBudget || 0;
                monthlyIncome = parsedData.monthlyIncome || 0;
                monthlyExpenses = parsedData.monthlyExpenses || 0;
                healthScoreHistory = parsedData.healthScoreHistory || {};
                currentCurrencyCode = parsedData.currentCurrencyCode || 'GBP';
                activeTab = parsedData.activeTab || 'overview';
                userGoals = parsedData.userGoals || [];
            }
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                 DOMElements.themeToggle.checked = savedDarkMode === 'true';
            }
        }

        function saveData() {
            const dataToSave = {
                expenses,
                recurringItems,
                monthlyBudget,
                monthlyIncome,
                monthlyExpenses,
                healthScoreHistory,
                currentCurrencyCode,
                activeTab,
                userGoals
            };
            localStorage.setItem('lensAppData', JSON.stringify(dataToSave));
        }

        // --- Import / Export ---
        function exportData() {
            const dataStr = localStorage.getItem('lensAppData') || '{}';
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `lens-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData === 'object' && importedData !== null) {
                        expenses = importedData.expenses || [];
                        recurringItems = importedData.recurringItems || [];
                        monthlyBudget = importedData.monthlyBudget || 0;
                        monthlyIncome = importedData.monthlyIncome || 0;
                        healthScoreHistory = importedData.healthScoreHistory || {};
                        currentCurrencyCode = importedData.currentCurrencyCode || 'GBP';
                        activeTab = importedData.activeTab || 'overview';
                        userGoals = importedData.userGoals || [];
                        
                        if (DOMElements.currencySelect) {
                            DOMElements.currencySelect.value = currentCurrencyCode;
                        }

                        saveData();
                        updateCurrencyUI();
                        updateDisplay();
                        showTab(activeTab);
                        showToast('Data imported successfully!');
                        closeSettings();
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    showToast('Import failed: Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        // --- Budget & Income ---
        function updateBudget(value) {
            monthlyBudget = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }
        function updateIncome(value) {
            monthlyIncome = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }

        // --- Currency Management ---
        function changeCurrency(value) {
            if (currencyConfig[value]) {
                currentCurrencyCode = value;
                updateCurrencyUI();
                saveData();
                updateDisplay();
                showToast(`Currency changed to ${value}`);
            }
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function updateCurrencyUI() {
            const symbol = currencyConfig[currentCurrencyCode].symbol;
            DOMElements.modalCurrency.textContent = symbol;
            DOMElements.recurringModalCurrency.textContent = symbol;
            DOMElements.currencySelect.value = currentCurrencyCode;
        }

        // --- Expense Management ---
        function showAddForm(prefill = {}) {
            editingExpense = null;
            DOMElements.modalTitle.textContent = 'Add New Expense';
            DOMElements.expenseName.value = prefill.name || '';
            DOMElements.expenseCost.value = prefill.cost || '';
            DOMElements.expenseType.value = prefill.type || 'Non-Essential';
            DOMElements.expenseCategory.value = prefill.category || 'Other';
            DOMElements.expenseDate.value = prefill.date || new Date().toISOString().split('T')[0];
            DOMElements.expensePaymentMethod.value = prefill.paymentMethod || '';
            DOMElements.modal.classList.remove('hidden');
        }

        function closeModal() {
            DOMElements.modal.classList.add('hidden');
            editingExpense = null;
        }

        function handleExpenseFormSubmission(event) {
            event.preventDefault();
            saveExpense();
        }

        function saveExpense() {
            const name = DOMElements.expenseName.value.trim();
            const cost = parseFloat(DOMElements.expenseCost.value);
            const date = DOMElements.expenseDate.value;

            if (!name || isNaN(cost) || cost <= 0 || !date) {
                showToast('Please fill in all fields correctly (Name, positive Amount, Date).', 'error');
                return;
            }

            const expense = {
                id: editingExpense ? editingExpense.id : Date.now(),
                name: name,
                cost: cost,
                type: DOMElements.expenseType.value,
                category: DOMElements.expenseCategory.value,
                date: date,
                paymentMethod: DOMElements.expensePaymentMethod.value,
                status: 'active'
            };

            if (editingExpense) {
                const index = expenses.findIndex(e => e.id === editingExpense.id);
                if (index !== -1) expenses[index] = expense;
            } else {
                expenses.push(expense);
            }

            sortExpenses();
            saveData();
            updateDisplay();
            closeModal();
            showToast(`Expense '${name}' saved successfully.`, "success");
        }
        
        function quickAddExpense(name, category, type, cost) {
            const expense = {
                    id: Date.now(),
                name: name,
                cost: cost,
                type: type || 'Non-Essential',
                category: category || 'Other',
                date: new Date().toISOString().split('T')[0],
                paymentMethod: '',
                    status: 'active'
                };
            expenses.push(expense);
            sortExpenses();
            saveData();
            updateDisplay();
            showToast(`${name} added successfully for ${formatCurrency(cost)}.`);
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
            editingExpense = expense;
                DOMElements.modalTitle.textContent = 'Edit Expense';
                DOMElements.expenseName.value = expense.name;
                DOMElements.expenseCost.value = expense.cost;
                DOMElements.expenseType.value = expense.type;
                DOMElements.expenseCategory.value = expense.category;
                DOMElements.expenseDate.value = expense.date;
                DOMElements.expensePaymentMethod.value = expense.paymentMethod || '';
                DOMElements.modal.classList.remove('hidden');
            }
        }

        function deleteExpense(id) {
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                const expenseName = expenses[index].name;
                expenses.splice(index, 1);
                updateDisplay();
                showToast(`Expense '${expenseName}' deleted.`, 'info');
            }
        }

        function toggleExpenseStatus(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.status = expense.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Expense status updated to ${expense.status}.`);
            }
        }

        function toggleFilterPanel(panelId) {
            document.getElementById(panelId).classList.toggle('hidden');
        }

        // --- Recurring Item Management ---
        function populateCategoryDropdowns() {
            const expenseOptions = expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            DOMElements.expenseCategory.innerHTML = expenseOptions;
            
            document.getElementById('expense-filter-category').innerHTML = '<option value="">All Categories</option>' + expenseOptions;
            
            const allCats = [...new Set([...expenseCategories, ...incomeCategories])];
            document.getElementById('recurring-filter-category').innerHTML = '<option value="">All Categories</option>' + allCats.map(c => `<option value="${c}">${c}</option>`).join('');

            toggleRecurringFields('expense');
        }

        function toggleRecurringFields(type) {
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            DOMElements.recurringCategory.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            DOMElements.recurringEssentialTypeWrapper.style.display = type === 'expense' ? 'block' : 'none';
        }

         function showRecurringForm() {
            editingRecurring = null;
            DOMElements.recurringModalTitle.textContent = 'Add Recurring Item';
            DOMElements.recurringItemType.value = 'expense';
            toggleRecurringFields('expense');
            DOMElements.recurringName.value = '';
            DOMElements.recurringAmount.value = '';
            DOMElements.recurringFrequency.value = 'Monthly';
            DOMElements.recurringPaymentMethod.value = '';
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringEndDate.value = '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function closeRecurringModal() {
            DOMElements.recurringModal.classList.add('hidden');
            editingRecurring = null;
        }

        function saveRecurring() {
            const type = DOMElements.recurringItemType.value;
            const name = DOMElements.recurringName.value.trim();
            const amount = parseFloat(DOMElements.recurringAmount.value);
            const startDate = DOMElements.recurringStartDate.value;
            const endDate = DOMElements.recurringEndDate.value || null;

            if (!name || isNaN(amount) || amount <= 0 || !startDate) {
                 showToast('Please fill in recurring item fields correctly.', 'error');
                return;
            }

            const recurringItem = {
                id: editingRecurring ? editingRecurring.id : Date.now(),
                type: type,
                name: name,
                amount: amount,
                frequency: DOMElements.recurringFrequency.value,
                category: DOMElements.recurringCategory.value,
                essentialType: type === 'expense' ? DOMElements.recurringEssentialType.value : null,
                paymentMethod: DOMElements.recurringPaymentMethod.value,
                startDate: startDate,
                endDate: endDate,
                status: 'active'
            };

            if (editingRecurring) {
                const index = recurringItems.findIndex(r => r.id === editingRecurring.id);
                if (index !== -1) recurringItems[index] = recurringItem;
            } else {
                recurringItems.unshift(recurringItem); // Add to beginning for chronological order
            }

            saveData();
            
            // Fix: Force immediate processing and update
            processRecurringExpenses();
            updateDisplay();
            
            closeRecurringModal();
            showToast(`Recurring item '${name}' saved successfully.`, "success");
        }

        function editRecurring(id) {
            const item = recurringItems.find(r => r.id === id);
            if (!item) return;
            editingRecurring = item;
            DOMElements.recurringModalTitle.textContent = 'Edit Recurring Item';
            DOMElements.recurringItemType.value = item.type;
            toggleRecurringFields(item.type);
            DOMElements.recurringName.value = item.name;
            DOMElements.recurringAmount.value = item.amount;
            DOMElements.recurringFrequency.value = item.frequency;
            DOMElements.recurringCategory.value = item.category;
            if (item.type === 'expense') {
                DOMElements.recurringEssentialType.value = item.essentialType || 'Non-Essential';
            }
            DOMElements.recurringPaymentMethod.value = item.paymentMethod || '';
            DOMElements.recurringStartDate.value = item.startDate;
            DOMElements.recurringEndDate.value = item.endDate || '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function deleteRecurring(id) {
            if (confirm('Are you sure you want to delete this recurring item and all its automatically generated expenses?')) {
                // Remove the recurring item
                recurringItems = recurringItems.filter(r => r.id !== id);
                
                // Remove ALL associated auto-generated expenses
                const initialExpenseCount = expenses.length;
                expenses = expenses.filter(e => e.recurringSourceId !== id);
                const removedExpenseCount = initialExpenseCount - expenses.length;
                
                // Remove from selected items
                selectedRecurringIds.delete(id);
                
                saveData();
                updateDisplay();
                
                if (removedExpenseCount > 0) {
                    showToast(`Recurring item and ${removedExpenseCount} associated expense(s) deleted!`);
                } else {
                    showToast('Recurring item deleted!');
                }
            }
        }
        
        function toggleRecurringStatus(id) {
            const item = recurringItems.find(r => r.id === id);
            if(item) {
                item.status = item.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Recurring item status updated.`);
            }
        }
        
        // --- Filtering Logic ---
        function applyExpenseFilters() {
            renderExpensesTable_NEW();
            showToast('Filters applied');
        }

        function clearExpenseFilters() {
            document.getElementById('expense-filter-date-from').value = '';
            document.getElementById('expense-filter-date-to').value = '';
            document.getElementById('expense-filter-category').value = '';
            document.getElementById('expense-filter-type').value = '';
            renderExpensesTable_NEW();
            showToast('Filters cleared');
        }

        function applyRecurringFilters() {
            renderRecurringTable_NEW();
            showToast('Filters applied');
        }

        function clearRecurringFilters() {
            document.getElementById('recurring-filter-type').value = '';
            document.getElementById('recurring-filter-category').value = '';
            document.getElementById('recurring-filter-frequency').value = '';
            renderRecurringTable_NEW();
            showToast('Filters cleared');
        }
        
        // --- Bulk Actions ---
        function toggleSelectAllExpenses(checked) {
            const checkboxes = DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox');
            selectedExpenseIds.clear();
            checkboxes.forEach(cb => {
                if (!cb.disabled) {
                    cb.checked = checked;
                    if (checked) {
                        selectedExpenseIds.add(cb.dataset.id);
                    }
                }
            });
            updateDeleteSelectedButton();
        }

        function toggleExpenseSelection(checkbox, id) {
            if (checkbox.checked) {
                selectedExpenseIds.add(id);
            } else {
                selectedExpenseIds.delete(id);
            }
            const allCheckboxes = [...DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox:not(:disabled)')];
            DOMElements.selectAllExpensesCheckbox.checked = allCheckboxes.length > 0 && selectedExpenseIds.size === allCheckboxes.length;
            updateDeleteSelectedButton();
        }

        function updateDeleteSelectedButton() {
            if (selectedExpenseIds.size > 0) {
                DOMElements.deleteSelectedBtn.classList.remove('hidden');
                DOMElements.deleteSelectedBtn.querySelector('span').textContent = `Delete Selected (${selectedExpenseIds.size})`;
            } else {
                DOMElements.deleteSelectedBtn.classList.add('hidden');
            }
        }

        function deleteSelectedExpenses() {
            if (selectedExpenseIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedExpenseIds.size} selected one-time expense(s)?`)) {
                const initialCount = expenses.length;
                expenses = expenses.filter(e => !selectedExpenseIds.has(e.id.toString()));
                const deletedCount = initialCount - expenses.length;
                selectedExpenseIds.clear();
                DOMElements.selectAllExpensesCheckbox.checked = false;
                saveData();
                updateDisplay();
                showToast(`${deletedCount} expense(s) deleted.`);
            }
        }
        
        function toggleSelectAllRecurring(checked) {
            const checkboxes = DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox');
            selectedRecurringIds.clear();
            checkboxes.forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedRecurringIds.add(parseInt(cb.dataset.id));
                }
            });
            updateDeleteSelectedRecurringButton();
        }

        function toggleRecurringSelection(checkbox, id) {
            const numId = parseInt(id);
            if (checkbox.checked) {
                selectedRecurringIds.add(numId);
            } else {
                selectedRecurringIds.delete(numId);
            }
            const allCheckboxes = [...DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox')];
            DOMElements.selectAllRecurringCheckbox.checked = allCheckboxes.length > 0 && selectedRecurringIds.size === allCheckboxes.length;
            updateDeleteSelectedRecurringButton();
        }

        function updateDeleteSelectedRecurringButton() {
            const btn = DOMElements.deleteSelectedRecurringBtn;
            if (selectedRecurringIds.size > 0) {
                btn.classList.remove('hidden');
                btn.querySelector('span').textContent = `Delete Selected (${selectedRecurringIds.size})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        function deleteSelectedRecurring() {
            if (selectedRecurringIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedRecurringIds.size} recurring item(s) and their associated expenses?`)) {
                let totalRemovedExpenses = 0;
                
                // For each selected recurring item, remove associated expenses
                selectedRecurringIds.forEach(recurringId => {
                    const initialExpenseCount = expenses.length;
                    expenses = expenses.filter(e => e.recurringSourceId !== recurringId);
                    totalRemovedExpenses += (initialExpenseCount - expenses.length);
                });
                
                // Remove the recurring items
                const deletedRecurringCount = selectedRecurringIds.size;
                recurringItems = recurringItems.filter(r => !selectedRecurringIds.has(r.id));
                
                // Clear selections and update UI
                selectedRecurringIds.clear();
                DOMElements.selectAllRecurringCheckbox.checked = false;
                
                saveData();
                updateDisplay();
                
                if (totalRemovedExpenses > 0) {
                    showToast(`${deletedRecurringCount} recurring item(s) and ${totalRemovedExpenses} associated expense(s) deleted!`);
                } else {
                    showToast(`${deletedRecurringCount} recurring item(s) deleted!`);
                }
            }
        }

        // --- Calculation Functions ---
        function getMonthlyRecurringTotals(year, month) {
            let totals = { income: 0, expenses: 0, incomeItems: [], expenseItems: [] };
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            recurringItems.forEach(item => {
                if (item.status !== 'active') return;

                const startDate = new Date(item.startDate + 'T00:00:00');
                if (startDate > lastDay) return;

                if (item.endDate) {
                    const endDate = new Date(item.endDate + 'T00:00:00');
                    if (endDate < firstDay) return;
                }

                // Check if this recurring item has a due date in this month
                let currentDate = new Date(startDate);
                let hasOccurrenceThisMonth = false;
                let iterations = 0;
                
                while (currentDate <= lastDay && iterations < 100) {
                    if (currentDate >= firstDay && currentDate <= lastDay) {
                        hasOccurrenceThisMonth = true;
            break;
    }

                    // Move to next occurrence
                    switch (item.frequency) {
                        case 'Daily': currentDate.setDate(currentDate.getDate() + 1); break;
                        case 'Weekly': currentDate.setDate(currentDate.getDate() + 7); break;
                        case 'Bi-Weekly': currentDate.setDate(currentDate.getDate() + 14); break;
                        case 'Monthly': currentDate.setMonth(currentDate.getMonth() + 1); break;
                        case 'Quarterly': currentDate.setMonth(currentDate.getMonth() + 3); break;
                        case 'Annual': currentDate.setFullYear(currentDate.getFullYear() + 1); break;
                        default: iterations = 100; break;
                    }
                    iterations++;
                }

                // If there's an occurrence this month, count it once
                if (hasOccurrenceThisMonth) {
                    if (item.type === 'income') {
                        totals.income += item.amount;
                        if (!totals.incomeItems.find(i => i.id === item.id)) {
                            totals.incomeItems.push(item);
                        }
                    } else {
                        // Note: Don't add recurring expenses here since they're already in the main expenses array
                        // Only track for income calculations
                        if (!totals.expenseItems.find(i => i.id === item.id)) {
                            totals.expenseItems.push(item);
                        }
                    }
                }
            });
            
            return totals;
        }

        function getMonthlyExpenseTotal(year, month) {
            return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === month && 
                       expenseDate.getFullYear() === year;
            }).reduce((sum, e) => sum + e.cost, 0);
        }

        // --- UI Update Functions ---
        function getResponsiveFontSize(text) {
            const baseSize = 1.875; // Corresponds to text-3xl
            const minSize = 1.25; // Corresponds to text-xl
            const maxLength = 8; // Start shrinking after 8 characters
            
            let newSize = baseSize;
            if (text.length > maxLength) {
                newSize = Math.max(minSize, baseSize - (text.length - maxLength) * 0.15);
            }
            return `${newSize}rem`;
        }

        function updateQuickAddButtons() {
            const quickAddData = {
                'JPY': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 500 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 700 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 1000 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 20000 }
                ],
                'default': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 5 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 10 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 15 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 50 }
                ]
            };

            const currencyData = quickAddData[currentCurrencyCode] || quickAddData['default'];
            
            currencyData.forEach(item => {
                const container = document.getElementById(item.id);
                if (container) {
                    const button = container.querySelector('button');
                    if (button) {
                        const costSpan = button.querySelector('span.font-medium');
                        if (costSpan) {
                            costSpan.textContent = formatCurrency(item.cost);
                        }
                        button.onclick = () => quickAddExpense(item.name, item.category, item.type, item.cost);
                    }
                }
            });
        }

        function updateDisplay() {
            console.time('updateDisplay');
            
            sortExpenses();
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Centralized calculations for all expenses this month
            const monthlyRecurring = getMonthlyRecurringTotals(currentYear, currentMonth);
            const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;

            // ✅ FIXED: Only use the main expenses array (recurring expenses are already there)
            const allMonthlyExpenses = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            const totalSpent = allMonthlyExpenses.reduce((sum, e) => sum + e.cost, 0);

            // --- Update UI Tiles ---
            const budgetStr = formatCurrency(monthlyBudget);
            const spentStr = formatCurrency(totalSpent);
            const incomeStr = formatCurrency(totalMonthlyIncome);
            const remaining = monthlyBudget - totalSpent;
            const remainingStr = formatCurrency(remaining);

            // Find the longest string to determine a consistent font size
            const maxLength = Math.max(budgetStr.length, spentStr.length, incomeStr.length, remainingStr.length);
            const responsiveSize = getResponsiveFontSize(" ".repeat(maxLength));

            DOMElements.monthlyBudgetDisplay.textContent = budgetStr;
            DOMElements.monthlyBudgetDisplay.style.fontSize = responsiveSize;

            DOMElements.totalExpensesDisplay.textContent = spentStr;
            DOMElements.totalExpensesDisplay.style.fontSize = responsiveSize;
            
            if (DOMElements.totalIncomeDisplay) {
    if (DOMElements.totalIncomeDisplay) {
    DOMElements.totalIncomeDisplay.textContent = incomeStr;
    DOMElements.totalIncomeDisplay.style.fontSize = responsiveSize;
}
}

            DOMElements.remainingAmountDisplay.textContent = remainingStr;
            DOMElements.remainingAmountDisplay.style.fontSize = responsiveSize;

            if (remaining < 0) {
                DOMElements.remainingAmountDisplay.classList.remove('text-green-600', 'dark:text-green-400');
                DOMElements.remainingAmountDisplay.classList.add('text-red-600', 'dark:text-red-400');
            } else {
                DOMElements.remainingAmountDisplay.classList.remove('text-red-600', 'dark:text-red-400');
                DOMElements.remainingAmountDisplay.classList.add('text-green-600', 'dark:text-green-400');
            }

            updateQuickAddButtons();

            // Budget Health & Progress Bar
            const budgetProgress = (monthlyBudget > 0) ? (totalSpent / monthlyBudget) * 100 : 0;
            DOMElements.budgetBar.style.width = `${Math.min(budgetProgress, 100)}%`;
            DOMElements.budgetBar.classList.remove('bg-blue-600', 'bg-red-600');
            DOMElements.budgetBar.classList.add(budgetProgress > 100 ? 'bg-red-600' : 'bg-blue-600');
            DOMElements.budgetPercentage.textContent = `${budgetProgress.toFixed(0)}% Used`;
            
            // AI Projection
            const projection = predictMonthEndSpending(totalSpent, now);
            DOMElements.aiProjectionContainer.innerHTML = `
                                <div class="flex items-center gap-2">
                    <span class="text-lg">🔮</span>
                    <div class="flex items-center gap-2">
                            <div>
                        <span class="font-semibold">AI Projection:</span>
                        You're on track to spend <strong>${formatCurrency(projection.projectedSpend)}</strong> this month.
                        <span class="font-bold ${projection.statusColor}">${projection.statusText}</span>
                                </div>
                        <div class="tooltip">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 cursor-help hover:text-gray-600 dark:hover:text-gray-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="tooltiptext">
                                <strong>How this works:</strong><br>
                                Based on your spending so far (${formatCurrency(totalSpent)}) divided by ${new Date().getDate()} days = ${formatCurrency(totalSpent / new Date().getDate())} per day average.<br><br>
                                Projected over ${new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate()} days in this month = ${formatCurrency(projection.projectedSpend)} total.<br><br>
                                This becomes more accurate as you add more expenses throughout the month.
                        </div>
                    </div>
                </div>
                    </div>
            `;
            
            // ✅ FIXED: Use the correct variable name 'allMonthlyExpenses' instead of 'activeMonthlyExpenses'
            updateBudgetHealthScore(totalSpent, monthlyBudget, allMonthlyExpenses, totalMonthlyIncome, now);
            
            // Spending Breakdown - FIXED: Use correct variable name
            const essentialSpending = allMonthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
            const nonEssentialSpending = allMonthlyExpenses.filter(e => e.type === 'Non-Essential').reduce((sum, e) => sum + e.cost, 0);
            DOMElements.essentialSpendingDisplay.textContent = formatCurrency(essentialSpending);
            DOMElements.nonEssentialSpendingDisplay.textContent = formatCurrency(nonEssentialSpending);
            const totalBreakdown = essentialSpending + nonEssentialSpending;
            const essentialPercent = totalBreakdown > 0 ? (essentialSpending / totalBreakdown) * 100 : 0;
            DOMElements.essentialBar.style.width = `${essentialPercent}%`;
            DOMElements.nonEssentialBar.style.width = `${100 - essentialPercent}%`;

            // ✅ These functions should now work properly
            renderRecentExpenses();
            renderExpensesTable_NEW();
            renderRecurringTable_NEW();
            
            if (activeTab === 'insights') {
                updateChartsAndInsights();
            }
            updateDeleteSelectedButton();
            updateDeleteSelectedRecurringButton();
            
            // Update table labels for mobile cards
            setTimeout(updateTableLabels_NEW, 10);
            
            updateGoalProgressDisplay(); // ADD THIS LINE

            console.timeEnd('updateDisplay');
        }

        // --- Budget Health Score v3 ---

        function calculateBudgetUsageScore(totalSpent, budget, now) {
            let score = 0;
            // Component 1: Budget Usage (30 points)
            if (budget > 0) {
                const usage = totalSpent / budget;
                if (usage > 1) score += 0;
                else if (usage <= 0.8) score += 30;
                else score += 30 * (1 - (usage - 0.8) / 0.2);
            }

            // Component 2: Spending Velocity (20 points)
            if (budget > 0) {
                const dayOfMonth = now.getDate();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const percentOfMonthPassed = dayOfMonth / daysInMonth;
                const idealSpend = budget * percentOfMonthPassed;
                const deviation = totalSpent / idealSpend;
                if (deviation <= 1.0) score += 20;
                else if (deviation <= 1.5) score += 20 * (1 - (deviation - 1.0) / 0.5);
            }

            return { score: Math.round(score), max: 50 };
        }

        function calculateSpendingHabitsScore(monthlyExpenses, totalSpent) {
            let score = 0;
            if (totalSpent > 0) {
                // Component 1: Essential vs Non-Essential (15 points)
                const essentialSpending = monthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
                const nonEssentialRatio = (totalSpent - essentialSpending) / totalSpent;
                if (nonEssentialRatio < 0.3) score += 15;
                else if (nonEssentialRatio < 0.5) score += 7;

                // Component 2: No-Spend Days (15 points)
                const spendingDays = new Set(monthlyExpenses.map(e => e.date)).size;
                const zeroSpendingDays = new Date().getDate() - spendingDays;
                if (zeroSpendingDays >= 8) score += 15;
                else if (zeroSpendingDays >= 4) score += 7;
            }
            return { score: Math.round(score), max: 30 };
        }

        function calculateSavingsRateScore(totalSpent, totalMonthlyIncome, now) {
            let score = 0;
            // Component 1: Positive Savings (10 points)
            if (totalMonthlyIncome > 0 && totalMonthlyIncome > totalSpent) {
                score += 10;
            }
            
            // Component 2: Improving Savings Rate (10 points)
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthData = getExpensesForMonth(lastMonth.getFullYear(), lastMonth.getMonth());
            const lastMonthIncomeData = getMonthlyRecurringTotals(lastMonth.getFullYear(), lastMonth.getMonth());
            const lastMonthTotalIncome = (monthlyIncome || 0) + lastMonthIncomeData.income;
            if (lastMonthTotalIncome > 0) {
                const lastMonthSpent = lastMonthData.reduce((sum, e) => sum + e.cost, 0);
                const currentSavingsRate = (totalMonthlyIncome - totalSpent) / totalMonthlyIncome;
                const lastMonthSavingsRate = (lastMonthTotalIncome - lastMonthSpent) / lastMonthTotalIncome;
                if (currentSavingsRate > lastMonthSavingsRate) {
                    score += 10;
                }
            }
            return { score: Math.round(score), max: 20 };
        }

        function generateHealthScoreInsights(scoreData, totalSpent, monthlyExpenses, totalMonthlyIncome) {
            const insights = { strengths: [], improvements: [], tip: '' };
            const { budgetUsage, spendingHabits, savingsRate } = scoreData.breakdown;

            // Strengths
            if (budgetUsage.score / budgetUsage.max > 0.8) insights.strengths.push("Excellent budget control and spending pace.");
            if (spendingHabits.score / spendingHabits.max > 0.8) insights.strengths.push("Great balance of essential vs. non-essential spending.");
            if (savingsRate.score / savingsRate.max > 0.8) insights.strengths.push("Fantastic! Your savings rate is improving.");
            if (insights.strengths.length === 0) insights.strengths.push("Getting started is the first step!");

            // Improvements & Tips
            let lowestCategory = 'budgetUsage';
            let lowestPercentage = (budgetUsage.score / budgetUsage.max);
            if ((spendingHabits.score / spendingHabits.max) < lowestPercentage) {
                lowestCategory = 'spendingHabits';
                lowestPercentage = spendingHabits.score / spendingHabits.max;
            }
            if ((savingsRate.score / savingsRate.max) < lowestPercentage) {
                lowestCategory = 'savingsRate';
            }
            
            if (lowestPercentage < 0.6) {
                switch(lowestCategory) {
                    case 'budgetUsage':
                        insights.improvements.push("Spending is outpacing your budget for this point in the month.");
                        insights.tip = "Try having a 'no-spend' day to get back on track.";
            break;
                    case 'spendingHabits':
                        insights.improvements.push("A high portion of spending is on non-essentials.");
                        insights.tip = "Review subscriptions or dining out for potential savings.";
            break;
                    case 'savingsRate':
                        insights.improvements.push("Currently not saving or saving less than last month.");
                        insights.tip = "Set a small, achievable savings goal for this month.";
            break;
    }
}
            if (insights.improvements.length === 0) insights.improvements.push("You're on the right track in all areas.");

            return insights;
        }

        function renderBudgetHealthScore(scoreData) {
            const { totalScore, breakdown, insights } = scoreData;

            // --- Render Visuals ---
            let scoreColor = 'var(--health-score-bad)';
            let scoreLabel = 'Poor';
            if (totalScore >= 70) {
                scoreColor = 'var(--health-score-good)';
                scoreLabel = 'Good';
            } else if (totalScore >= 40) {
                scoreColor = 'var(--health-score-ok)';
                scoreLabel = 'Okay';
            }
            
            DOMElements.healthScoreVisual.innerHTML = `
                <svg class="w-full h-full" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="${DOMElements.html.classList.contains('dark') ? 'var(--bg-tertiary)' : '#e6e6e6'}" stroke-width="3" />
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="${scoreColor}" stroke-width="3" stroke-dasharray="${totalScore}, 100" stroke-linecap="round"
                          style="transition: stroke-dasharray 1s ease-out;" />
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold" style="color: ${scoreColor};">${totalScore}</span>
                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">${scoreLabel}</span>
                    </div>
            `;
            
            // --- Render Trend ---
            let trendHtml = '';
            if (scoreData.lastMonthScore !== undefined) {
                const diff = totalScore - scoreData.lastMonthScore;
                if (diff > 0) {
                    trendHtml = `<span class="text-green-500 flex items-center justify-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        Up from ${scoreData.lastMonthScore}
                    </span>`;
                } else if (diff < 0) {
                    trendHtml = `<span class="text-red-500 flex items-center justify-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                        Down from ${scoreData.lastMonthScore}
                    </span>`;
                } else {
                    trendHtml = `<span>- Same as last month</span>`;
                }
            }
            DOMElements.healthScoreTrend.innerHTML = trendHtml;
            
            // --- Render Tooltip ---
            const renderProgressBar = (value, max) => {
                const percentage = (value / max) * 100;
                return `
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
            };

            DOMElements.healthScoreTooltip.innerHTML = `
                <div class="font-bold text-base mb-2 text-center">Your Score: ${totalScore}/100</div>
                <div class="space-y-3">
                <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-semibold">Budget Usage</span>
                            <span class="text-xs font-medium">${breakdown.budgetUsage.score}/${breakdown.budgetUsage.max} pts</span>
                    </div>
                        ${renderProgressBar(breakdown.budgetUsage.score, breakdown.budgetUsage.max)}
                </div>
                <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-semibold">Spending Habits</span>
                            <span class="text-xs font-medium">${breakdown.spendingHabits.score}/${breakdown.spendingHabits.max} pts</span>
                </div>
                        ${renderProgressBar(breakdown.spendingHabits.score, breakdown.spendingHabits.max)}
                    </div>
                            <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-semibold">Savings Rate</span>
                            <span class="text-xs font-medium">${breakdown.savingsRate.score}/${breakdown.savingsRate.max} pts</span>
                            </div>
                        ${renderProgressBar(breakdown.savingsRate.score, breakdown.savingsRate.max)}
                    </div>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-600 my-3"></div>
                        <div>
                    <h4 class="font-semibold text-green-600 dark:text-green-400">Strengths</h4>
                    <ul class="list-disc list-inside text-xs">${insights.strengths.map(s => `<li>${s}</li>`).join('')}</ul>
                        </div>
                <div class="mt-2">
                    <h4 class="font-semibold text-yellow-600 dark:text-yellow-400">Areas to Improve</h4>
                    <ul class="list-disc list-inside text-xs">${insights.improvements.map(i => `<li>${i}</li>`).join('')}</ul>
                    </div>
                <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 text-center">
                    <span class="font-semibold">💡 Tip:</span>
                    <span class="text-xs italic">${insights.tip}</span>
            </div>
        `;
        }

        function updateBudgetHealthScore(totalSpent, budget, monthlyExpenses, totalMonthlyIncome, now) {
            const breakdown = {
                budgetUsage: calculateBudgetUsageScore(totalSpent, budget, now),
                spendingHabits: calculateSpendingHabitsScore(monthlyExpenses, totalSpent),
                savingsRate: calculateSavingsRateScore(totalSpent, totalMonthlyIncome, now)
            };
            const totalScore = Math.round(breakdown.budgetUsage.score + breakdown.spendingHabits.score + breakdown.savingsRate.score);
            
            const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            healthScoreHistory[currentMonthKey] = totalScore;
            saveData();
            
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthKey = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
            
            const scoreData = {
                totalScore,
                breakdown,
                lastMonthScore: healthScoreHistory[lastMonthKey],
                insights: generateHealthScoreInsights({ breakdown }, totalSpent, monthlyExpenses, totalMonthlyIncome)
            };

            renderBudgetHealthScore(scoreData);
        }

        function predictMonthEndSpending(totalSpent, now) {
            if (totalSpent <= 0) {
                return { projectedSpend: 0, statusText: '', statusColor: '' };
            }
            const dayOfMonth = now.getDate();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const avgDailySpend = totalSpent / dayOfMonth;
            const projectedSpend = avgDailySpend * daysInMonth;

            const budgetUsage = projectedSpend / monthlyBudget;
            let statusText = 'On Track';
            let statusColor = 'text-green-700 dark:text-green-400';

            if (budgetUsage > 1.1) {
                statusText = 'Exceeding Budget';
                statusColor = 'text-red-700 dark:text-red-400';
            } else if (budgetUsage > 0.95) {
                statusText = 'At Risk';
                statusColor = 'text-yellow-600 dark:text-yellow-400';
            }
            return { projectedSpend, statusText, statusColor };
        }
        
        function getExpensesForMonth(year, month) {
            return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate.getFullYear() === year && expenseDate.getMonth() === month;
            });
        }

        function renderRecentExpenses() {
            DOMElements.recentExpensesContainer.innerHTML = '';
            const recent = expenses
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recent.length === 0) {
                DOMElements.recentExpensesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">No recent expenses.</p>';
                return;
            }
            recent.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center border-b border-gray-100 dark:border-gray-700 py-2 last:border-b-0 text-xs';
                div.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-900 dark:text-gray-600">${escapeHTML(expense.name)}</p>
                        <p class="text-gray-700 dark:text-gray-500">${expense.date} - ${escapeHTML(expense.category)}</p>
                    </div>
                    <p class="font-medium text-red-600 dark:text-red-400">${formatCurrency(expense.cost)}</p>
                `;
                DOMElements.recentExpensesContainer.appendChild(div);
            });
        }

        function renderExpensesTable() {
            let allExpenses = [...expenses];

            // Apply filters
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            const filteredExpenses = allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                if (typeFilter && e.type !== typeFilter && !(typeFilter === 'Recurring' && e.recurringSourceId)) passes = false;
                return passes;
            });

            // Sort filtered expenses
            filteredExpenses.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                const getNumericId = (id) => {
                    if (typeof id === 'string') {
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return id;
                };
                
                return getNumericId(b.id) - getNumericId(a.id);
            });

            const tableBody = DOMElements.expensesTableBody;
            if (filteredExpenses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500 dark:text-gray-400">No expenses match your filters.</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredExpenses.map(expense => {
                const isRecurringInstance = !!expense.recurringSourceId;
                const isCancelled = expense.status === 'cancelled';
                const originalRecurringItem = isRecurringInstance ? recurringItems.find(r => r.id === expense.recurringSourceId) : null;

                let editAction = `editExpense(${expense.id})`;
                if (isRecurringInstance && originalRecurringItem) {
                    editAction = `editRecurring(${originalRecurringItem.id})`;
                }
                
                const deleteAction = isRecurringInstance ? 'return false;' : `deleteExpense(${expense.id})`;
                const checkboxId = `expense-${expense.id}`;

                // Better status text for mobile
                let statusText = 'Active';
                if (isCancelled) {
                    statusText = 'Cancelled';
                } else if (isRecurringInstance) {
                    statusText = 'Recurring';
                }

                // Format date for better display
                const formattedDate = new Date(expense.date).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                return `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 ${isCancelled ? 'opacity-60' : ''}">
                        <td class="px-4 py-3" data-label="">
                            <input type="checkbox" id="${checkboxId}" data-id="${expense.id}" onchange="toggleExpenseSelection(this, '${expense.id}')" 
                            class="table-checkbox expense-checkbox" ${isRecurringInstance ? 'disabled' : ''} ${selectedExpenseIds.has(expense.id.toString()) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap" data-label="Name">
                            <span>${escapeHTML(expense.name)}</span>${isRecurringInstance ? '<span class="text-xs text-gray-400 ml-1">(R)</span>' : ''}
                        </td>
                        <td class="px-6 py-3" data-label="Amount">${formatCurrency(expense.cost)}</td>
                        <td class="px-6 py-3" data-label="Date">${formattedDate}</td>
                        <td class="px-6 py-3 hidden md:table-cell" data-label="Category">${escapeHTML(expense.category)}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Payment Method">${escapeHTML(expense.paymentMethod) || '-'}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Type">${escapeHTML(expense.type)}</td>
                        <td class="px-6 py-3 text-right" data-label="Actions">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="${editAction}" title="Edit" class="icon-button" ${isCancelled ? 'disabled' : ''} ${isCancelled ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="${deleteAction}" title="Delete" class="icon-button text-red-600/80 hover:text-red-500" ${isRecurringInstance ? 'disabled' : ''} ${isRecurringInstance ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
        </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderRecurringTable() {
            DOMElements.recurringTableBody.innerHTML = '';
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;

            let filtered = recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });

            // Fix: Sort by ID (newest first) since ID is timestamp-based
            filtered.sort((a, b) => b.id - a.id);

            if (filtered.length === 0) {
                DOMElements.recurringTableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                return;
            }

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                const isSelected = selectedRecurringIds.has(item.id);
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${item.status === 'cancelled' ? 'opacity-60' : ''} ${isSelected ? 'bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800'}`;
                const itemTypeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

                // Format start date for better display
                const formattedStartDate = new Date(item.startDate).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                tr.innerHTML = `
                    <td class="px-4 py-4 w-1" data-label=""><input type="checkbox" data-id="${item.id}" onchange="toggleRecurringSelection(this, ${item.id})" class="table-checkbox recurring-checkbox" ${isSelected ? 'checked' : ''}></td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white" data-label="Name">${escapeHTML(item.name)}</td>
                    <td class="px-6 py-4 capitalize" data-label="Type">${item.type}</td>
                    <td class="px-6 py-4 font-medium ${itemTypeClass}" data-label="Amount">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4" data-label="Frequency">${item.frequency}</td>
                    <td class="px-6 py-4" data-label="Start Date">${formattedStartDate}</td>
                    <td class="px-6 py-4 hidden lg:table-cell" data-label="Category">${escapeHTML(item.category)}</td>
                    <td class="px-6 py-4" data-label="Status"><span class="status-badge ${item.status === 'active' ? 'status-active' : 'status-cancelled'}">${item.status}</span></td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap" data-label="Actions">
                        <button onclick="editRecurring(${item.id})" class="icon-button" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        <button onclick="toggleRecurringStatus(${item.id})" class="icon-button" title="${item.status === 'active' ? 'Pause' : 'Resume'}">
                           ${item.status === 'active' ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                           }
                        </button>
                        <button onclick="deleteRecurring(${item.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </td>
                `;
                DOMElements.recurringTableBody.appendChild(tr);
            });
        }
        
        // --- Charting and Insights ---
        function updateChartsAndInsights() {
            renderSpendingTrendChart();
            renderCategorySpendingChart();
            renderMonthlySavingsChart();
            updateAiInsightsWithSmartAnalytics(); // NEW
        }

        const chartColors = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#06b6d4', '#d946ef', '#84cc16'];
        function getChartColors(count) {
            return Array.from({length: count}, (_, i) => chartColors[i % chartColors.length]);
        }

        function getChartOptions(isDarkMode) {
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { color: gridColor }, ticks: { color: textColor } },
                    y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, callback: value => formatCurrency(value, false) } }
                },
                plugins: {
                    legend: { labels: { color: textColor } },
                    tooltip: { titleFont: { weight: 'bold' }, bodyFont: {}, backgroundColor: isDarkMode ? '#334155' : '#ffffff', titleColor: isDarkMode ? '#f1f5f9' : '#1e293b', bodyColor: isDarkMode ? '#f1f5f9' : '#1e293b', borderColor: isDarkMode ? '#475569' : '#e2e8f0', borderWidth: 1 }
                }
            };
        }

        function renderSpendingTrendChart() {
            const ctx = DOMElements.spendingTrendCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const data = monthlyData.map(m => m.expenses);

            if (spendingTrendChart) spendingTrendChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            spendingTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: chartColors[2],
                        backgroundColor: chartColors[2] + '33',
                        tension: 0.2, fill: true, pointRadius: 3, pointHoverRadius: 5
                    }]
                },
                options: options
            });
        }

        function renderCategorySpendingChart() {
            const ctx = DOMElements.categorySpendingCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const data = monthlyData.map(m => m.expenses);
            
            if (categorySpendingChart) categorySpendingChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            categorySpendingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(d => d >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'),
                        borderColor: data.map(d => d >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }

        function renderMonthlySavingsChart() {
            const ctx = DOMElements.monthlySavingsCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const savingsData = monthlyData.map(m => m.income - m.expenses);

            if (monthlySavingsChart) monthlySavingsChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Savings: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            monthlySavingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: savingsData,
                        backgroundColor: savingsData.map(s => s >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'),
                        borderColor: savingsData.map(s => s >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }
        
        function getMonthlyIncomeAndExpenses(numMonths) {
            const data = [];
            for (let i = 0; i < numMonths; i++) {
                const date = new Date(new Date().setMonth(new Date().getMonth() - i));
                const year = date.getFullYear();
                const month = date.getMonth();
                
                // Get recurring income only (expenses are already in main array)
                const recurringIncome = getMonthlyRecurringTotals(year, month).income;
                
                data.push({
                    year: year,
                    month: month,
                    income: monthlyIncome + recurringIncome,
                    expenses: getMonthlyExpenseTotal(year, month)
                });
            }
            return data.reverse();
        }


        function getNextDueDate(item, fromDate) {
            let nextDueDate = new Date(item.startDate + 'T00:00:00');
            
            if (nextDueDate >= fromDate) {
                return nextDueDate;
            }

            let iterations = 0;
            while (nextDueDate < fromDate && iterations < 1000) {
                switch (item.frequency) {
                    case 'Daily': nextDueDate.setDate(nextDueDate.getDate() + 1); break;
                    case 'Weekly': nextDueDate.setDate(nextDueDate.getDate() + 7); break;
                    case 'Bi-Weekly': nextDueDate.setDate(nextDueDate.getDate() + 14); break;
                    case 'Monthly': nextDueDate.setMonth(nextDueDate.getMonth() + 1); break;
                    case 'Quarterly': nextDueDate.setMonth(nextDueDate.getMonth() + 3); break;
                    case 'Annual': nextDueDate.setFullYear(nextDueDate.getFullYear() + 1); break;
                    default: return new Date('9999-12-31');
                }
                iterations++;
            }
            return nextDueDate;
        }

        
        // --- Utility Functions ---
        function formatCurrency(amount, useDecimals = true) {
            const { locale } = currencyConfig[currentCurrencyCode];
            const isInteger = !useDecimals || (amount % 1 === 0);
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: isInteger ? 0 : 2,
                maximumFractionDigits: isInteger ? 0 : 2
            };
            return new Intl.NumberFormat(locale, options).format(amount || 0);
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function showToast(message, type = 'success') {
            DOMElements.toast.textContent = message;
            DOMElements.toast.className = `toast show ${type === 'error' ? 'bg-red-600' : 'bg-gray-800 dark:bg-gray-200 dark:text-gray-800'}`;
            setTimeout(() => { DOMElements.toast.className = 'toast'; }, 3000);
        }

        window.addEventListener('click', (e) => {
            const settingsContainer = DOMElements.settingsMenu.parentElement;
            if (settingsContainer && !DOMElements.settingsMenu.classList.contains('hidden') && !settingsContainer.contains(e.target)) {
                DOMElements.settingsMenu.classList.add('hidden');
        }
        });

        
        // --- Auto-Categorization ---
        function autoCategorizeExpense(event) {
            const name = event.target.value.toLowerCase();
            if (!name) return;

            let matchedCategory = 'Other';
            let matchedEssential = 'Non-Essential';

            // Find category based on keywords
            for (const category in categoryKeywords) {
                if (categoryKeywords[category].some(keyword => name.includes(keyword))) {
                    matchedCategory = category;
                    break;
                }
            }

            // Determine if essential based on keywords
            if (essentialKeywords.some(keyword => name.includes(keyword))) {
                matchedEssential = 'Essential';
            }

            // Update the form fields
            const formPrefix = event.target.id.startsWith('recurring') ? 'recurring-' : 'expense-';
            const categorySelect = document.getElementById(`${formPrefix}category`);
            const typeSelect = document.getElementById(`${formPrefix}type`) || document.getElementById(`${formPrefix}essential-type`);
            
            if (categorySelect) {
                categorySelect.value = matchedCategory;
            }
            if (typeSelect) {
                typeSelect.value = matchedEssential;
            }
        }

        // --- Settings Modal ---
        function openSettings(section) {
            const settingsModal = document.getElementById('settings-modal');
            
            // Populate inputs with current values
            document.getElementById('settings-budget-input').value = monthlyBudget > 0 ? monthlyBudget : '';
            document.getElementById('settings-income-input').value = monthlyIncome > 0 ? monthlyIncome : '';
            
            settingsModal.classList.remove('hidden');

            if (section === 'budget') {
                setTimeout(() => {
                    document.getElementById('settings-budget-input').focus();
                }, 100);
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const budgetValue = document.getElementById('settings-budget-input').value;
            const incomeValue = document.getElementById('settings-income-input').value;

            updateBudget(budgetValue);
            updateIncome(incomeValue);

            closeSettings();
            showToast('Settings saved successfully!');
        }

        function formatCurrency(amount) {
            const config = currencyConfig[currentCurrencyCode];
            const isInteger = amount % 1 === 0;
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
                maximumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
            };
            return new Intl.NumberFormat(config.locale, options).format(amount || 0);
        }

// SMART ANALYTICS CORE ENGINE

class LensSmartInsights {
    constructor(expenses, recurringItems, monthlyBudget, monthlyIncome) {
        this.expenses = expenses || [];
        this.recurringItems = recurringItems || [];
        this.monthlyBudget = monthlyBudget || 0;
        this.monthlyIncome = monthlyIncome || 0;
        this.now = new Date();
        
        // Process data once for all analyses
        this.processedExpenses = this.enrichExpenseData();
        this.monthlyData = this.getMonthlyBreakdown();
    }

    enrichExpenseData() {
        return this.expenses
            .filter(e => e.status === 'active')
            .map(expense => ({
                ...expense,
                cost: parseFloat(expense.cost) || 0,
                date: new Date(expense.date),
                dayOfWeek: new Date(expense.date).getDay(),
                isWeekend: [0, 6].includes(new Date(expense.date).getDay()),
                isRecurring: !!expense.recurringSourceId,
                merchantName: this.extractMerchant(expense.name),
                month: new Date(expense.date).getMonth(),
                year: new Date(expense.date).getFullYear()
            }))
            .sort((a, b) => b.date - a.date);
    }

    extractMerchant(name) {
        return name.toLowerCase()
            .replace(/\d+/g, '')
            .replace(/[^\w\s]/g, '')
            .trim()
            .split(' ')[0];
    }

    getMonthlyBreakdown() {
        const currentMonth = this.now.getMonth();
        const currentYear = this.now.getFullYear();
        
        return {
            thisMonth: this.processedExpenses.filter(e => 
                e.month === currentMonth && e.year === currentYear
            ),
            lastMonth: this.processedExpenses.filter(e => {
                const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const lastYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                return e.month === lastMonth && e.year === lastYear;
            }),
            last3Months: this.processedExpenses.filter(e => {
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                return e.date >= threeMonthsAgo;
            })
        };
    }

    // ===================================================================
    // BEHAVIORAL ANALYSIS
    // ===================================================================

    analyzeWeekendSpending() {
        const { thisMonth } = this.monthlyData;
        
        const weekdayExpenses = thisMonth.filter(e => !e.isWeekend && e.type === 'Non-Essential');
        const weekendExpenses = thisMonth.filter(e => e.isWeekend && e.type === 'Non-Essential');
        
        const weekdayTotal = weekdayExpenses.reduce((sum, e) => sum + e.cost, 0);
        const weekendTotal = weekendExpenses.reduce((sum, e) => sum + e.cost, 0);
        
        // Fix: Prevent division by zero
        const weekdayDays = Math.max(1, new Set(weekdayExpenses.map(e => e.date.getDate())).size);
        const weekendDays = Math.max(1, new Set(weekendExpenses.map(e => e.date.getDate())).size);
        
        const weekdayAvg = weekdayTotal / weekdayDays;
        const weekendAvg = weekendTotal / weekendDays;
        
        // Fix: Handle zero weekday spending
        const weekendPremium = weekdayAvg > 0 ? (weekendAvg - weekdayAvg) / weekdayAvg : 0;
        
        // Fix: Cap at reasonable values
        const cappedPremium = Math.min(5, Math.max(0, weekendPremium)); // Cap at 500% increase
        
        return {
            weekendPremium: cappedPremium,
            nonEssentialWeekendSpending: weekendTotal,
            nonEssentialWeekdaySpending: weekdayTotal,
            potentialSaving: Math.min(1000, cappedPremium * weekendTotal * 0.3) // Cap savings at £1000
        };
    }

    analyzeImpulseSpending() {
        const { thisMonth } = this.monthlyData;
        
        // Impulse indicators: Non-essential, small amounts, quick succession
        const impulseExpenses = thisMonth.filter(expense => {
            const isNonEssential = expense.type === 'Non-Essential';
            const isSmallAmount = expense.cost < 30;
            const isQuickSuccession = this.isInQuickSuccession(expense, thisMonth);
            
            return isNonEssential && (isSmallAmount || isQuickSuccession);
        });

        return {
            count: impulseExpenses.length,
            total: impulseExpenses.reduce((sum, e) => sum + e.cost, 0),
            avgAmount: impulseExpenses.length > 0 ? 
                impulseExpenses.reduce((sum, e) => sum + e.cost, 0) / impulseExpenses.length : 0,
            score: impulseExpenses.length / Math.max(thisMonth.length, 1)
        };
    }

    isInQuickSuccession(expense, allExpenses) {
        const sameDay = allExpenses.filter(e => 
            e.date.toDateString() === expense.date.toDateString() && 
            e.id !== expense.id
        );
        return sameDay.length > 2; // More than 2 other purchases same day
    }

    analyzeMerchantLoyalty() {
        const { last3Months } = this.monthlyData;
        
        // Group by category and merchant
        const categoryMerchants = {};
        last3Months.forEach(expense => {
            if (!categoryMerchants[expense.category]) {
                categoryMerchants[expense.category] = {};
            }
            if (!categoryMerchants[expense.category][expense.merchantName]) {
                categoryMerchants[expense.category][expense.merchantName] = [];
            }
            categoryMerchants[expense.category][expense.merchantName].push(expense.cost);
        });

        const opportunities = [];
        Object.entries(categoryMerchants).forEach(([category, merchants]) => {
            const merchantAvgs = Object.entries(merchants).map(([merchant, costs]) => ({
                merchant,
                avg: costs.reduce((a, b) => a + b, 0) / costs.length,
                count: costs.length,
                total: costs.reduce((a, b) => a + b, 0)
            })).filter(m => m.count >= 2); // Only merchants used multiple times

            if (merchantAvgs.length > 1) {
                merchantAvgs.sort((a, b) => a.avg - b.avg);
                const cheapest = merchantAvgs[0];
                const mostUsed = merchantAvgs.reduce((max, curr) => 
                    curr.count > max.count ? curr : max
                );

                if (mostUsed.merchant !== cheapest.merchant && mostUsed.avg > cheapest.avg * 1.2) {
                    const monthlySaving = (mostUsed.avg - cheapest.avg) * (mostUsed.count / 3); // Monthly estimate
                    opportunities.push({
                        category,
                        currentMerchant: mostUsed.merchant,
                        betterMerchant: cheapest.merchant,
                        potentialSaving: monthlySaving
                    });
                }
            }
        });

        return opportunities;
    }

    detectHiddenSubscriptions() {
        const { last3Months } = this.monthlyData;
        
        // Group by merchant and look for regular patterns
        const merchantPatterns = {};
        last3Months.forEach(expense => {
            if (!merchantPatterns[expense.merchantName]) {
                merchantPatterns[expense.merchantName] = [];
            }
            merchantPatterns[expense.merchantName].push({
                cost: expense.cost,
                date: expense.date
            });
        });

        const suspectedSubscriptions = [];
        Object.entries(merchantPatterns).forEach(([merchant, transactions]) => {
            if (transactions.length < 2) return;

            // Check for regular amounts
            const amounts = transactions.map(t => t.cost);
            const mostCommonAmount = this.getMostCommon(amounts);
            const regularAmountCount = amounts.filter(a => Math.abs(a - mostCommonAmount) < 0.01).length;
            
            // Check for regular intervals (approximately monthly)
            const dates = transactions.map(t => t.date).sort();
            const intervals = [];
            for (let i = 1; i < dates.length; i++) {
                const days = (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
                intervals.push(days);
            }
            
            const avgInterval = intervals.length > 0 ? intervals.reduce((a, b) => a + b, 0) / intervals.length : 0;
            const isMonthlyish = avgInterval > 25 && avgInterval < 35;
            const hasRegularInterval = intervals.every(interval => Math.abs(interval - avgInterval) < 7);

            // Check if already tracked
            const isTracked = this.recurringItems.some(item => 
                item.name.toLowerCase().includes(merchant.toLowerCase())
            );

            if (regularAmountCount >= 2 && (isMonthlyish || hasRegularInterval) && !isTracked) {
                suspectedSubscriptions.push({
                    merchant,
                    amount: mostCommonAmount,
                    confidence: (regularAmountCount / transactions.length) * 
                               (hasRegularInterval ? 1 : 0.7),
                    estimatedFrequency: Math.round(avgInterval)
                });
            }
        });

        return suspectedSubscriptions.filter(s => s.confidence > 0.6);
    }

    getMostCommon(arr) {
        const counts = {};
        arr.forEach(val => counts[val] = (counts[val] || 0) + 1);
        return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    }

    // ===================================================================
    // PREDICTIVE ANALYSIS
    // ===================================================================

    predictBudgetRisk() {
        const { thisMonth } = this.monthlyData;
        const currentDay = this.now.getDate();
        const daysInMonth = new Date(this.now.getFullYear(), this.now.getMonth() + 1, 0).getDate();
        
        const spentSoFar = thisMonth.reduce((sum, e) => sum + e.cost, 0);
        const dailyAverage = spentSoFar / currentDay;
        const projectedTotal = dailyAverage * daysInMonth;
        
        // Add upcoming recurring expenses
        const upcomingRecurring = this.getUpcomingRecurringThisMonth();
        const totalProjected = projectedTotal + upcomingRecurring;
        
        const overrunAmount = Math.max(0, totalProjected - this.monthlyBudget);
        const riskScore = this.monthlyBudget > 0 ? Math.min(1, overrunAmount / (this.monthlyBudget * 0.1)) : 0;
        
        return {
            riskScore,
            projectedSpend: totalProjected,
            projectedOverrun: overrunAmount,
            dailyBudgetRemaining: this.monthlyBudget > 0 ? 
                (this.monthlyBudget - spentSoFar) / (daysInMonth - currentDay) : 0
        };
    }

    getUpcomingRecurringThisMonth() {
        const startOfMonth = new Date(this.now.getFullYear(), this.now.getMonth(), 1);
        const endOfMonth = new Date(this.now.getFullYear(), this.now.getMonth() + 1, 0);
        
        return this.recurringItems
            .filter(item => item.status === 'active' && item.type === 'expense')
            .reduce((total, item) => {
                const nextDue = this.getNextDueDate(item, this.now);
                if (nextDue && nextDue <= endOfMonth && nextDue > this.now) {
                    return total + item.amount;
                }
                return total;
            }, 0);
    }

    getNextDueDate(recurringItem, fromDate) {
        let nextDate = new Date(recurringItem.startDate);
        
        while (nextDate <= fromDate) {
            switch (recurringItem.frequency) {
                case 'Daily': nextDate.setDate(nextDate.getDate() + 1); break;
                case 'Weekly': nextDate.setDate(nextDate.getDate() + 7); break;
                case 'Bi-Weekly': nextDate.setDate(nextDate.getDate() + 14); break;
                case 'Monthly': nextDate.setMonth(nextDate.getMonth() + 1); break;
                case 'Quarterly': nextDate.setMonth(nextDate.getMonth() + 3); break;
                case 'Annual': nextDate.setFullYear(nextDate.getFullYear() + 1); break;
            }
        }
        
        return nextDate;
    }

    analyzeCategoryTrends() {
        const { thisMonth, lastMonth } = this.monthlyData;
        
        const thisMonthByCategory = this.groupByCategory(thisMonth);
        const lastMonthByCategory = this.groupByCategory(lastMonth);
        
        const trends = [];
        Object.keys(thisMonthByCategory).forEach(category => {
            const thisTotal = thisMonthByCategory[category] || 0;
            const lastTotal = lastMonthByCategory[category] || 0;
            
            if (lastTotal > 0) {
                const change = (thisTotal - lastTotal) / lastTotal;
                if (Math.abs(change) > 0.2) { // 20% change threshold
                    trends.push({
                        category,
                        change,
                        thisMonth: thisTotal,
                        lastMonth: lastTotal,
                        direction: change > 0 ? 'increasing' : 'decreasing'
                    });
                }
            }
        });
        
        return trends.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
    }

    groupByCategory(expenses) {
        return expenses.reduce((acc, expense) => {
            acc[expense.category] = (acc[expense.category] || 0) + expense.cost;
            return acc;
        }, {});
    }

    // ===================================================================
    // RECOMMENDATION ENGINE
    // ===================================================================

    generateSmartRecommendations() {
        const recommendations = [];
        const { thisMonth } = this.monthlyData;
        
        // Coffee habit detection
        const coffeeExpenses = thisMonth.filter(e => e.name.toLowerCase().includes('coffee'));
        if (coffeeExpenses.length >= 3) {
            const coffeeTotal = coffeeExpenses.reduce((sum, e) => sum + e.cost, 0);
            recommendations.push({
                type: 'behavioral',
                priority: 'medium',
                title: 'Coffee Spending Pattern',
                description: `${coffeeExpenses.length} coffee purchases this month totaling £${coffeeTotal}. That's £${(coffeeTotal * 12).toFixed(0)} annually! Consider a coffee subscription or home brewing.`,
                icon: '☕',
                potentialSaving: coffeeTotal * 0.6,
                actionable: true,
                category: 'coffee_habit',
                action: 'Review coffee spending'
            });
        }
        
        // Same-day multiple purchases
        const expensesByDate = {};
        thisMonth.forEach(e => {
            if (!expensesByDate[e.date]) expensesByDate[e.date] = [];
            expensesByDate[e.date].push(e);
        });
        
        Object.entries(expensesByDate).forEach(([date, dayExpenses]) => {
            const sameCategoryMultiple = {};
            dayExpenses.forEach(e => {
                if (!sameCategoryMultiple[e.category]) sameCategoryMultiple[e.category] = [];
                sameCategoryMultiple[e.category].push(e);
            });
            
            Object.entries(sameCategoryMultiple).forEach(([category, expenses]) => {
                if (expenses.length > 1) {
                    const total = expenses.reduce((sum, e) => sum + e.cost, 0);
                    recommendations.push({
                        type: 'behavioral',
                        priority: 'high',
                        title: 'Multiple Same-Day Purchases',
                        description: `${expenses.length} ${category} purchases on ${date} totaling £${total}. Consider planning ahead to avoid duplicate spending.`,
                        icon: '🚨',
                        potentialSaving: total * 0.5,
                        actionable: true,
                        category: 'same_day_duplicates',
                        action: 'Plan purchases better'
                    });
                }
            });
        });
        
        // Large discretionary spending
        const largeDiscretionary = thisMonth.filter(e => 
            e.type === 'Non-Essential' && e.cost > 100
        );
        
        if (largeDiscretionary.length > 0) {
            const total = largeDiscretionary.reduce((sum, e) => sum + e.cost, 0);
            recommendations.push({
                type: 'behavioral',
                priority: 'high',
                title: 'Large Discretionary Purchases',
                description: `${largeDiscretionary.length} large non-essential purchases: ${largeDiscretionary.map(e => e.name).join(', ')} totaling £${total}. Consider a 48-hour cooling-off period for purchases over £100.`,
                icon: '💸',
                potentialSaving: total * 0.3,
                actionable: true,
                category: 'large_spending',
                action: 'Set spending limits'
            });
        }
        
        // Transport pattern analysis
        const transportExpenses = thisMonth.filter(e => e.category === 'Transport');
        if (transportExpenses.length >= 3) {
            const transportTotal = transportExpenses.reduce((sum, e) => sum + e.cost, 0);
            const avgPerTrip = transportTotal / transportExpenses.length;
            recommendations.push({
                type: 'efficiency',
                priority: 'medium',
                title: 'Regular Transport Costs',
                description: `${transportExpenses.length} transport expenses averaging £${avgPerTrip.toFixed(0)} per trip. Consider a monthly travel card or cycling for potential savings.`,
                icon: '🚌',
                potentialSaving: transportTotal * 0.2,
                actionable: true,
                category: 'transport_optimization',
                action: 'Consider travel alternatives'
            });
        }
        
        return recommendations.slice(0, 5); // Return top 5
    }

    prioritizeRecommendations(recommendations) {
        return recommendations
            .map(rec => ({
                ...rec,
                score: this.calculatePriorityScore(rec)
            }))
            .sort((a, b) => b.score - a.score)
            .slice(0, 6);
    }

    calculatePriorityScore(rec) {
        const priorityWeight = {
            'urgent': 100,
            'high': 75,
            'medium': 50,
            'low': 25
        }[rec.priority] || 25;
        
        const savingsScore = Math.min(50, (rec.potentialSaving || 0) / 2);
        const typeBonus = {
            'urgent': 25,
            'behavioral': 15,
            'efficiency': 20,
            'organization': 10,
            'trend': 15
        }[rec.type] || 0;
        
        return priorityWeight + savingsScore + typeBonus;
    }

    generate7DayForecast() {
        try {
            const forecast = [];
            const today = new Date();
            
            for (let i = 1; i <= 7; i++) {
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + i);
                
                const dayName = targetDate.toLocaleDateString('en-GB', { weekday: 'short' });
                const dayOfWeek = targetDate.getDay();
                
                const prediction = this.predictDaySpending(dayOfWeek, targetDate);
                
                forecast.push({
                    date: `${dayName} ${targetDate.getDate()}`,
                    predicted: prediction.amount,
                    confidence: prediction.confidence,
                    reasoning: prediction.reasoning,
                    hasRecurring: prediction.hasRecurring
                });
            }
            
            return forecast;
        } catch (error) {
            console.error('7-day forecast error:', error);
            return [];
        }
    }

    predictDaySpending(dayOfWeek, date) {
        try {
            const { last3Months } = this.monthlyData;
            
            const sameDaySpending = last3Months
                .filter(e => e.dayOfWeek === dayOfWeek)
                .map(e => e.cost);
                
            const avgSpending = sameDaySpending.length > 0 ? 
                sameDaySpending.reduce((a, b) => a + b, 0) / sameDaySpending.length : 0;
            
            const confidence = Math.min(95, Math.max(40, sameDaySpending.length * 10));
            const reasoning = `Based on ${sameDaySpending.length} similar days`;
            
            return {
                amount: avgSpending,
                confidence,
                reasoning,
                hasRecurring: false
            };
        } catch (error) {
            return { amount: 0, confidence: 0, reasoning: 'Unable to predict', hasRecurring: false };
        }
    }

    generateMonthlyStory() {
        try {
            const { thisMonth } = this.monthlyData;
            const totalSpent = thisMonth.reduce((sum, e) => sum + e.cost, 0);
            
            if (totalSpent === 0) {
                return {
                    story: "Add some expenses to see your personalized financial insights.",
                    metrics: null
                };
            }
            
            const totalIncome = this.monthlyIncome + this.getMonthlyRecurringIncome();
            const savingsRate = totalIncome > 0 ? ((totalIncome - totalSpent) / totalIncome) * 100 : 0;
            
            const spendingDays = new Set(thisMonth.map(e => e.date.getDate())).size;
            
            let story = `This month you've spent <strong>${formatCurrency(totalSpent)}</strong> across ${spendingDays} days. `;
            
            if (savingsRate > 15) {
                story += `Excellent <strong>${savingsRate.toFixed(0)}% savings rate</strong>! `;
            } else if (savingsRate > 0) {
                story += `Good <strong>${savingsRate.toFixed(0)}% savings rate</strong>. `;
            }
            
            const metrics = {
                savingsRate: savingsRate.toFixed(0),
                topCategory: 'Various',
                spendingDays: spendingDays
            };
            
            return { story, metrics };
        } catch (error) {
            return { story: "Unable to generate story", metrics: null };
        }
    }

    getMonthlyRecurringIncome() {
        try {
            return this.recurringItems
                .filter(item => item.status === 'active' && item.type === 'income')
                .reduce((total, item) => total + item.amount, 0);
        } catch (error) {
            return 0;
        }
    }
}

// ===================================================================
// INTEGRATION FUNCTIONS - Drop-in replacements
// ===================================================================

function updateAiInsightsWithSmartAnalytics() {
    console.log('Starting smart analytics update...');
    
    showInsightsLoading();
    
    setTimeout(() => {
        try {
            console.log('Data check:', {
                expensesCount: expenses?.length || 0,
                recurringCount: recurringItems?.length || 0,
                budget: monthlyBudget,
                income: monthlyIncome
            });
            
            const insights = new LensSmartInsights(
                expenses || [], 
                recurringItems || [], 
                monthlyBudget || 0, 
                monthlyIncome || 0
            );
            
            const forecast = insights.generate7DayForecast();
            const recommendations = insights.generateSmartRecommendations();
            const monthlyStory = insights.generateMonthlyStory();
            const budgetRisk = insights.predictBudgetRisk();
            
            renderSmart7DayForecast(forecast);
            renderSmartRecommendations(recommendations);
            renderSmartMonthlyStory(monthlyStory);
            renderMonthEndProjectionSmart(budgetRisk);
            updateRecommendationBadge(recommendations.length);
            
        } catch (error) {
            console.error('Smart analytics error:', error);
            showInsightsError();
        }
    }, 500);
}

// UI Rendering Functions
function showInsightsLoading() {
    const containers = [
        'seven-day-forecast',
        'smart-recommendations', 
        'monthly-story',
        'month-end-projection'
    ];
    
    containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = `
                <div class="flex justify-center items-center p-6">
                    <div class="ai-loading"></div>
                    <span class="ml-3 text-sm text-gray-500">Analyzing your spending patterns...</span>
            </div>
            `;
        }
    });
}

function renderSmart7DayForecast(forecast) {
    const container = document.getElementById('seven-day-forecast');
    if (!container) return;
    
    if (forecast.length === 0) {
        container.innerHTML = `
            <div class="text-center p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    Add more expenses to generate spending predictions
                </p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-3">
            <div class="text-xs text-gray-500 mb-3 italic">
                📊 Predictions based on your spending patterns
            </div>
            ${forecast.map(day => `
                <div class="flex justify-between items-center p-3 rounded-lg border border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                    <div>
                        <div class="font-medium text-gray-800 dark:text-gray-200">${day.date}</div>
                        <div class="text-xs text-gray-500 mt-1">${day.reasoning}</div>
            </div>
                    <div class="text-right">
                        <div class="font-semibold ${day.predicted > 0 ? 'text-red-500' : 'text-gray-400'} dark:text-red-400">
                            ${day.predicted > 0 ? formatCurrency(day.predicted) : 'No spending predicted'}
                        </div>
                        <div class="text-xs text-gray-400">${day.confidence}% confidence</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderSmartRecommendations(recommendations) {
    const container = document.getElementById('smart-recommendations');
    if (!container) return;
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="text-center p-6">
                <div class="text-4xl mb-3">🎉</div>
                <div class="font-medium text-gray-800 dark:text-gray-200 mb-2">All looking good!</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    No urgent recommendations right now. Keep up the great work!
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recommendations.map(rec => {
        const priorityColors = {
            'urgent': 'border-red-500 bg-red-50 dark:bg-red-900/20',
            'high': 'border-orange-500 bg-orange-50 dark:bg-orange-900/20',
            'medium': 'border-blue-500 bg-blue-50 dark:bg-blue-900/20',
            'low': 'border-gray-500 bg-gray-50 dark:bg-gray-900/20'
        };
        
        const priorityBadgeColors = {
            'urgent': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
            'high': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
            'medium': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
            'low': 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200'
        };
        
        return `
            <div class="p-4 rounded-lg border-l-4 ${priorityColors[rec.priority]} hover:shadow-md transition-shadow cursor-pointer" 
                 onclick="handleRecommendationClick('${rec.category}', ${JSON.stringify(rec).replace(/"/g, '&quot;')})">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${rec.icon}</span>
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">${rec.title}</h4>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full ${priorityBadgeColors[rec.priority]}">
                        ${rec.priority}
                    </span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 leading-relaxed">${rec.description}</p>
             <div class="flex justify-between items-center">
                    <div class="text-xs text-gray-500">
                        ${rec.potentialSaving > 0 ? `💰 Potential saving: <strong>${formatCurrency(rec.potentialSaving)}</strong>` : '📊 Organization improvement'}
            </div>
                    <div class="text-xs bg-white dark:bg-gray-800 px-2 py-1 rounded border hover:bg-gray-50 dark:hover:bg-gray-700">
                        Take Action →
                    </div>
                </div>
        </div>
    `;
    }).join('');
}

function renderSmartMonthlyStory(storyData) {
    const container = document.getElementById('monthly-story');
    const metricsContainer = document.getElementById('story-metrics');
    
    if (!container) return;
    
    container.innerHTML = `
        <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
            ${storyData.story}
        </div>
    `;
    
    if (metricsContainer && storyData.metrics) {
        metricsContainer.innerHTML = `
            <div class="metric-card">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Savings Rate</p>
                <p class="text-lg font-bold ${parseFloat(storyData.metrics.savingsRate) >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                    ${storyData.metrics.savingsRate}%
                </p>
            </div>
            <div class="metric-card">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Top Category</p>
                <p class="text-lg font-bold text-gray-800 dark:text-gray-200 truncate">${storyData.metrics.topCategory}</p>
            </div>
            <div class="metric-card">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Active Days</p>
                <p class="text-lg font-bold text-gray-800 dark:text-gray-200">${storyData.metrics.spendingDays}</p>
            </div>
        `;
        metricsContainer.classList.remove('hidden');
        metricsContainer.classList.add('grid', 'grid-cols-3', 'gap-2', 'mt-4', 'text-center');
    }
}

function renderMonthEndProjectionSmart(budgetRisk) {
    const container = document.getElementById('month-end-projection');
    if (!container) return;
    
    const riskLevel = budgetRisk.riskScore > 0.8 ? 'high' : budgetRisk.riskScore > 0.5 ? 'medium' : 'low';
    const riskColors = {
        'high': 'text-red-600 dark:text-red-400',
        'medium': 'text-yellow-600 dark:text-yellow-400', 
        'low': 'text-green-600 dark:text-green-400'
    };
    
    const totalIncome = monthlyIncome + (recurringItems?.filter(r => r.type === 'income' && r.status === 'active').reduce((sum, r) => sum + r.amount, 0) || 0);
    const projectedSavings = totalIncome - budgetRisk.projectedSpend;
    
    container.innerHTML = `
        <div class="space-y-4">
            <div class="text-center p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Projected Monthly Spending</p>
                <p class="text-2xl font-bold text-gray-800 dark:text-gray-200">${formatCurrency(budgetRisk.projectedSpend)}</p>
                <p class="text-xs font-medium mt-1 ${riskColors[riskLevel]}">
                    ${riskLevel === 'high' ? '⚠️ Budget Risk' : riskLevel === 'medium' ? '⚡ Watch Closely' : '✅ On Track'}
                </p>
            </div>
            
            ${budgetRisk.riskScore > 0.6 ? `
                <div class="p-3 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500">
                    <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Daily Budget Alert</p>
                    <p class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">
                        Limit spending to ${formatCurrency(budgetRisk.dailyBudgetRemaining)}/day to stay on budget
                    </p>
                </div>
            ` : ''}
            
            <div class="text-center">
                <p class="text-sm text-gray-600 dark:text-gray-400">Projected Savings</p>
                <p class="text-xl font-bold ${projectedSavings >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                    ${formatCurrency(projectedSavings)}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                    Based on current spending velocity
                </p>
            </div>
        </div>
    `;
}

function updateRecommendationBadge(count) {
    const badge = document.getElementById('action-count');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}

function handleRecommendationClick(category, recommendation) {
    // Handle different recommendation actions
    switch(category) {
        case 'weekend_control':
            // Could open a weekend budget setting modal
            showToast('Set a weekend spending limit in Settings', 'info');
            break;
        case 'impulse_control':
            // Could show impulse spending tips
            showToast('Try waiting 24 hours before non-essential purchases', 'info');
            break;
        case 'merchant_optimization':
            // Could show merchant comparison
            showToast('Research alternative merchants for better prices', 'info');
            break;
        case 'subscription_tracking':
            // Could open add recurring item modal
            showRecurringForm();
            break;
        case 'budget_risk':
            // Could open budget adjustment modal
            openSettings('budget');
            break;
        default:
            showToast('Recommendation noted! Check insights regularly for updates.', 'info');
    }
}

function showInsightsError() {
    const containers = ['seven-day-forecast', 'smart-recommendations', 'monthly-story', 'month-end-projection'];
    containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <p class="text-sm text-red-500">Unable to generate insights. Please try again.</p>
                </div>
            `;
        }
    });
}
        // --- Utility Functions ---
        function debugExpenseData() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const thisMonthExpenses = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            const recurringExpenses = thisMonthExpenses.filter(e => e.recurringSourceId);
            const oneTimeExpenses = thisMonthExpenses.filter(e => !e.recurringSourceId);
            
            console.log('=== EXPENSE DATA DEBUG ===');
            console.log('Total this month:', thisMonthExpenses.length);
            console.log('One-time expenses:', oneTimeExpenses.length);
            console.log('Recurring expenses:', recurringExpenses.length);
            console.log('Total amount:', thisMonthExpenses.reduce((sum, e) => sum + e.cost, 0));
            console.log('Recurring items in system:', recurringItems.length);

        return {
                total: thisMonthExpenses.length,
                oneTime: oneTimeExpenses.length,
                recurring: recurringExpenses.length,
                amount: thisMonthExpenses.reduce((sum, e) => sum + e.cost, 0)
            };
        }

        function categorizeChanges(oldItem, newItem) {
            const changes = {
                safe: [],      // amount, name, category, paymentMethod
                schedule: [],  // frequency, startDate, endDate
                structural: [] // type, essentialType
            };
            
            const safeFields = ['name', 'amount', 'category', 'paymentMethod'];
            const scheduleFields = ['frequency', 'startDate', 'endDate'];
            const structuralFields = ['type', 'essentialType'];
            
            Object.keys(newItem).forEach(key => {
                if (oldItem[key] !== newItem[key]) {
                    if (safeFields.includes(key)) {
                        changes.safe.push(key);
                    } else if (scheduleFields.includes(key)) {
                        changes.schedule.push(key);
                    } else if (structuralFields.includes(key)) {
                        changes.structural.push(key);
                    }
                }
            });
            
            return changes;
        }

        function updateExpensesFromCurrentMonth(recurringItem) {
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            let updatedCount = 0;
            let preservedCount = 0;
            
            expenses.forEach(expense => {
                if (expense.recurringSourceId === recurringItem.id) {
                    const expenseDate = new Date(expense.date);
                    
                    if (expenseDate >= currentMonthStart) {
                        // Update current month and future expenses
                        expense.name = recurringItem.name;
                        expense.cost = recurringItem.amount;
                        expense.category = recurringItem.category;
                        expense.type = recurringItem.essentialType || 'Non-Essential';
                        expense.paymentMethod = recurringItem.paymentMethod;
                        updatedCount++;
                    } else {
                        // Count preserved past expenses
                        preservedCount++;
                    }
                }
            });
            
            return { updatedCount, preservedCount };
        }

        function handleScheduleChanges(oldItem, newItem) {
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Count what we're about to remove
            const removedCount = expenses.filter(e => 
                e.recurringSourceId === oldItem.id && 
                new Date(e.date) >= currentMonthStart
            ).length;
            
            const preservedCount = expenses.filter(e => 
                e.recurringSourceId === oldItem.id && 
                new Date(e.date) < currentMonthStart
            ).length;
            
            // Remove future expenses (keep past ones intact)
            expenses = expenses.filter(e => {
                if (e.recurringSourceId !== oldItem.id) {
                    return true; // Keep non-related expenses
                }
                
                const expenseDate = new Date(e.date);
                return expenseDate < currentMonthStart; // Keep past expenses only
            });
            
            return { removedCount, preservedCount };
        }

        function saveRecurring() {
            const type = DOMElements.recurringItemType.value;
            const name = DOMElements.recurringName.value.trim();
            const amount = parseFloat(DOMElements.recurringAmount.value);
            const startDate = DOMElements.recurringStartDate.value;
            const endDate = DOMElements.recurringEndDate.value || null;

            if (!name || isNaN(amount) || amount <= 0 || !startDate) {
                 showToast('Please fill in recurring item fields correctly.', 'error');
                return;
            }

            const recurringItem = {
                id: editingRecurring ? editingRecurring.id : Date.now(),
                type: type,
                name: name,
                amount: amount,
                frequency: DOMElements.recurringFrequency.value,
                category: DOMElements.recurringCategory.value,
                essentialType: type === 'expense' ? DOMElements.recurringEssentialType.value : null,
                paymentMethod: DOMElements.recurringPaymentMethod.value,
                startDate: startDate,
                endDate: endDate,
                status: 'active'
            };

            if (editingRecurring) {
                const oldRecurring = editingRecurring;
                const changes = categorizeChanges(oldRecurring, recurringItem);
                
                // Update the recurring item first
                const index = recurringItems.findIndex(r => r.id === editingRecurring.id);
                if (index !== -1) {
                    recurringItems[index] = recurringItem;
                    
                    // Determine how to handle the update
                    if (changes.schedule.length > 0 || changes.structural.length > 0) {
                        // Schedule or structural changes: regenerate from current month
                        const result = handleScheduleChanges(oldRecurring, recurringItem);
                        
                        showToast(
                            `Recurring ${type} '${name}' updated! ` +
                            `${result.preservedCount} past expense(s) preserved, ` +
                            `${result.removedCount} current/future expense(s) will be regenerated.`
                        );
                    } else if (changes.safe.length > 0) {
                        // Safe changes: update current month + future only
                        const result = updateExpensesFromCurrentMonth(recurringItem);
                        
                        let message = `Recurring ${type} '${name}' updated!`;
                        if (result.updatedCount > 0) {
                            message += ` ${result.updatedCount} current/future expense(s) updated.`;
                        }
                        if (result.preservedCount > 0) {
                            message += ` ${result.preservedCount} past expense(s) preserved.`;
                        }
                        
                        showToast(message);
                    } else {
                        // No relevant changes
                        showToast(`Recurring ${type} '${name}' updated!`);
                    }
                }
            } else {
                // Adding new recurring item
                recurringItems.unshift(recurringItem);
                showToast(`Recurring ${type} '${name}' saved successfully!`);
            }
            
    saveData();
            
            // Fix: Force immediate processing and update
            processRecurringExpenses();
    updateDisplay();
            
            closeRecurringModal();
        }

        // Enhanced Mobile Rendering Functions

        // Category to icon mapping
        const categoryIcons = {
            "Housing": "🏠", "Utilities": "💡", "Transport": "🚗", "Food/Drink": "🍔",
            "Entertainment": "🎬", "Shopping": "🛍️", "Health": "❤️", "Personal Care": "🧴",
            "Education": "🎓", "Debt": "💳", "Subscriptions": "🔁", "Other": "❓",
            "Salary": "💰", "Bonus": "⭐", "Investment": "📈", "Gift": "🎁", "Other Income": "🪙"
        };

        // Enhanced renderExpensesTable function
        function renderExpensesTable_NEW() {
            let allExpenses = [...expenses];

            // Apply filters (existing filter logic)
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            const filteredExpenses = allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                
                if (typeFilter) {
                    if (typeFilter === 'Recurring') {
                        if (!e.recurringSourceId) passes = false;
                    } else {
                        if (e.type !== typeFilter) passes = false;
                    }
                }

                return passes;
            });

            // Sort expenses by date (newest first)
            filteredExpenses.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                const getNumericId = (id) => {
                    if (typeof id === 'string') {
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return id;
                };
                
                return getNumericId(b.id) - getNumericId(a.id);
            });

            const tableBody = DOMElements.expensesTableBody;
            
            if (filteredExpenses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500 dark:text-gray-400">No expenses match your filters.</td></tr>`;
                return;
            }

            // Check if we're on mobile
            const isMobile = window.innerWidth <= 640;
            
            if (isMobile) {
                renderMobileExpenseCards(filteredExpenses, tableBody);
            } else {
                renderDesktopExpenseTable(filteredExpenses, tableBody);
            }
        }

        function renderMobileExpenseCards(expenses, container) {
            if (!expenses || expenses.length === 0) {
                container.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500 dark:text-gray-400">No expenses to display.</td></tr>`;
                return;
            }

            const grouped = expenses.reduce((groups, expense) => {
                const date = (expense.date || '').split('T')[0];
                if (!date) return groups;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(expense);
                return groups;
            }, {});

            let html = '';

            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(date => {
                const dayExpenses = grouped[date];
                const dayTotal = dayExpenses.reduce((sum, exp) => sum + exp.cost, 0);

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const expenseDate = new Date(date + 'T00:00:00');

                let dateLabel;
                if (expenseDate.getTime() === today.getTime()) {
                    dateLabel = 'Today';
                } else if (expenseDate.getTime() === yesterday.getTime()) {
                    dateLabel = 'Yesterday';
                } else {
                    dateLabel = expenseDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' });
                }

                html += `
                    <tr class="mobile-date-header">
                        <td colspan="8" style="padding: 16px 8px 4px 8px; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${dateLabel}</span>
                                <span>-${formatCurrency(dayTotal, false)}</span>
                            </div>
                        </td>
                    </tr>`;

                dayExpenses.forEach(expense => {
                    const categoryIcon = categoryIcons[expense.category] || categoryIcons['Other'];
                    const isRecurringInstance = !!expense.recurringSourceId;
                    const originalRecurringItem = isRecurringInstance ? recurringItems.find(r => r.id === expense.recurringSourceId) : null;
                    const editAction = isRecurringInstance && originalRecurringItem ? `editRecurring(${originalRecurringItem.id})` : `editExpense(${expense.id})`;

                    html += `
                    <tr>
                        <td colspan="8" style="padding:0;">
                            <div onclick="${editAction}" class="mobile-card">
                                <div class="mobile-card-icon">${categoryIcon}</div>
                                <div class="mobile-card-main">
                                    <div class="mobile-card-title">${escapeHTML(expense.name)}</div>
                                    <div class="mobile-card-subtitle">${escapeHTML(expense.category)}</div>
                                </div>
                                <div class="mobile-card-amount">-${formatCurrency(expense.cost)}</div>
                            </div>
                        </td>
                    </tr>
                    `;
                    });
                });

            container.innerHTML = html;
        }

        function renderDesktopExpenseTable(expenses, container) {
            // Keep existing desktop table rendering logic
            container.innerHTML = expenses.map(expense => {
                const isRecurringInstance = !!expense.recurringSourceId;
                const isCancelled = expense.status === 'cancelled';
                const originalRecurringItem = isRecurringInstance ? 
                    recurringItems.find(r => r.id === expense.recurringSourceId) : null;

                let editAction = `editExpense(${expense.id})`;
                if (isRecurringInstance && originalRecurringItem) {
                    editAction = `editRecurring(${originalRecurringItem.id})`;
                }
                
                const deleteAction = isRecurringInstance ? 'return false;' : `deleteExpense(${expense.id})`;
                const checkboxId = `expense-${expense.id}`;

                const formattedDate = new Date(expense.date).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                return `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${isCancelled ? 'opacity-60' : ''}"
                        data-category="${expense.category}">
                        <td class="px-4 py-3" data-label="">
                            <input type="checkbox" id="${checkboxId}" data-id="${expense.id}" 
                                   onchange="toggleExpenseSelection(this, '${expense.id}')" 
                                   class="table-checkbox expense-checkbox" 
                                   ${isRecurringInstance ? 'disabled' : ''} 
                                   ${selectedExpenseIds.has(expense.id.toString()) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap" data-label="Name">
                            <span>${escapeHTML(expense.name)}</span>${isRecurringInstance ? '<span class="text-xs text-gray-400 ml-1">(R)</span>' : ''}
                        </td>
                        <td class="px-6 py-3" data-label="Amount">${formatCurrency(expense.cost)}</td>
                        <td class="px-6 py-3" data-label="Date">${formattedDate}</td>
                        <td class="px-6 py-3 hidden md:table-cell" data-label="Category">${escapeHTML(expense.category)}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Payment Method">${escapeHTML(expense.paymentMethod) || '-'}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Type">${escapeHTML(expense.type)}</td>
                        <td class="px-6 py-3 text-right" data-label="Actions">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="${editAction}" title="Edit" class="icon-button" 
                                        ${isCancelled ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button onclick="${deleteAction}" title="Delete" 
                                        class="icon-button text-red-600/80 hover:text-red-500" 
                                        ${isRecurringInstance ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function groupExpensesByDate(expenses) {
            return expenses.reduce((groups, expense) => {
                const date = expense.date;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(expense);
                return groups;
            }, {});
        }

        // Enhanced recurring table rendering for mobile
        function renderRecurringTable_NEW() {
            DOMElements.recurringTableBody.innerHTML = '';
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;

            let filtered = recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });

            filtered.sort((a, b) => b.id - a.id);

            if (filtered.length === 0) {
                DOMElements.recurringTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                return;
            }

            const isMobile = window.innerWidth <= 640;
            
            if (isMobile) {
                renderMobileRecurringList(filtered, DOMElements.recurringTableBody);
            } else {
                renderDesktopRecurringTable(filtered, DOMElements.recurringTableBody);
            }
        }

        function renderMobileRecurringList(items, container) {
            if (items.length === 0) {
                container.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                return;
            }
            let html = '';
            items.forEach(item => {
                const isCancelled = item.status === 'cancelled';
                const typeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                 html += `
                    <div onclick="editRecurring(${item.id})" class="mobile-card ${isCancelled ? 'opacity-60' : ''}">
                         <div class="mobile-card-icon">${categoryIcons[item.category] || categoryIcons['Other']}</div>
                         <div class="mobile-card-main">
                            <p class="mobile-card-title">${escapeHTML(item.name)}</p>
                            <div class="mobile-card-subtitle">
                                <span>${item.type === 'income' ? 'Income' : 'Expense'}</span>
                                &middot;
                                <span>${item.frequency}</span>
                            </div>
                         </div>
                         <div class="text-right">
                            <p class="mobile-card-amount ${typeClass}">${formatCurrency(item.amount)}</p>
                            <p class="text-xs text-gray-400">${item.status === 'active' ? 'Active' : 'Cancelled'}</p>
                         </div>
                    </div>
                `;
            });
            container.innerHTML = `<td colspan="8" style="padding: 0;">${html}</td>`;
        }

        function renderDesktopRecurringTable(items, container) {
            // Existing desktop recurring table logic
            items.forEach(item => {
                const tr = document.createElement('tr');
                const isSelected = selectedRecurringIds.has(item.id);
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${item.status === 'cancelled' ? 'opacity-60' : ''} ${isSelected ? 'bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800'}`;
                const itemTypeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

                const formattedStartDate = new Date(item.startDate).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                tr.innerHTML = `
                    <td class="px-4 py-4 w-1" data-label="">
                        <input type="checkbox" data-id="${item.id}" onchange="toggleRecurringSelection(this, ${item.id})" class="table-checkbox recurring-checkbox" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white" data-label="Name">${escapeHTML(item.name)}</td>
                    <td class="px-6 py-4 capitalize" data-label="Type">${item.type}</td>
                    <td class="px-6 py-4 font-medium ${itemTypeClass}" data-label="Amount">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4" data-label="Frequency">${item.frequency}</td>
                    <td class="px-6 py-4" data-label="Start Date">${formattedStartDate}</td>
                    <td class="px-6 py-4 hidden lg:table-cell" data-label="Category">${escapeHTML(item.category)}</td>
                    <td class="px-6 py-4" data-label="Status">
                        <span class="status-badge ${item.status === 'active' ? 'status-active' : 'status-cancelled'}">${item.status}</span>
                    </td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap" data-label="Actions">
                        <button onclick="editRecurring(${item.id})" class="icon-button" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button onclick="toggleRecurringStatus(${item.id})" class="icon-button" title="${item.status === 'active' ? 'Pause' : 'Resume'}">
                           ${item.status === 'active' ? 
                               '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : 
                               '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                           }
                        </button>
                        <button onclick="deleteRecurring(${item.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                container.appendChild(tr);
            });
        }

      // Add responsive behavior
      function handleResize() {
          if (activeTab === 'expenses') {
                renderExpensesTable_NEW();
          } else if (activeTab === 'recurring') {
                renderRecurringTable_NEW();
          }
      }

      // Listen for window resize with debounce
      let resizeTimeout;
      window.addEventListener('resize', function() {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(handleResize, 250);
      });

        // Enhanced updateTableLabels function for better mobile support
        function updateTableLabels_NEW() {
            document.querySelectorAll('table').forEach(tbl => {
                const headers = Array.from(tbl.querySelectorAll('thead th'))
                             .map(th => th.textContent.trim());

                tbl.querySelectorAll('tbody tr').forEach(row => {
                    Array.from(row.children).forEach((cell, idx) => {
                        if (!cell.hasAttribute('data-label')) {
                            cell.setAttribute('data-label', headers[idx] || '');
                        }
                        
                        // Add category data attribute for styling
                        if (headers[idx] === 'Category' && cell.textContent.trim()) {
                            row.setAttribute('data-category', cell.textContent.trim());
                        }
                        
                        // Add recurring data attribute
                        if (headers[idx] === 'Status' && cell.textContent.includes('Recurring')) {
                            row.setAttribute('data-recurring', 'true');
                        }
                        
                        // Add time data for mobile meta display
                        if (headers[idx] === 'Date' && cell.textContent.trim()) {
                            const timeAttr = '12:00'; // Default time since we don't store time
                            row.querySelector('td[data-label="Name"]')?.setAttribute('data-time', timeAttr);
                        }
                        
                        // Add icon data attribute based on category
                        if (headers[idx] === 'Category' && cell.textContent.trim()) {
                            const category = cell.textContent.trim();
                            const icon = categoryIcons[category] || categoryIcons['Other'];
                            const iconCell = row.querySelector('td:nth-child(2)');
                            if (iconCell) {
                                iconCell.setAttribute('data-icon', icon);
                            }
                        }
                    });
                });
            });
        }
    </script>

    <!-- === Lens Card Labels Script START === -->
    <script>
      function updateTableLabels() {
        document.querySelectorAll('table').forEach(tbl => {
          const headers = Array.from(tbl.querySelectorAll('thead th'))
                               .map(th => th.textContent.trim());

          tbl.querySelectorAll('tbody tr').forEach(row => {
            Array.from(row.children).forEach((cell, idx) => {
              if (!cell.hasAttribute('data-label')) {
                cell.setAttribute('data-label', headers[idx] || '');
              }
            });
          });
        });
      }
      
      document.addEventListener('DOMContentLoaded', updateTableLabels);
    </script>
    <!-- === Lens Card Labels Script END === -->

    <!-- Mobile Bottom Navigation -->
<!-- Mobile Bottom Navigation -->
<nav class="md:hidden bottom-nav fixed bottom-0 left-0 right-0 z-40">
    <div class="max-w-5xl mx-auto px-2">
        <div class="flex justify-around items-center h-16">
            <button id="mobile-tab-overview" onclick="showTab('overview')" class="bottom-nav-item active flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                <span class="text-xs">Overview</span>
            </button>
            <button id="mobile-tab-expenses" onclick="showTab('expenses')" class="bottom-nav-item flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                <span class="text-xs">Expenses</span>
            </button>
            <button id="mobile-tab-recurring" onclick="showTab('recurring')" class="bottom-nav-item flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                    <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01" stroke-linecap="round"/>
                </svg>
                <span class="text-xs">Recurring</span>
            </button>
            <button id="mobile-tab-insights" onclick="showTab('insights')" class="bottom-nav-item flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>
                <span class="text-xs">Insights</span>
            </button>
            <!-- Add Settings Button for Mobile -->
            <button id="mobile-bottom-nav-settings" onclick="openSettings()" class="bottom-nav-item flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-xs">Settings</span>
            </button>
            </div>
        </div>
    </nav>

<!-- Mobile View Rewrite (auto-generated) -->
<script>
// <![CDATA[
/* =============================================================
   Mobile View Rewrite for Lens Expense Tracker
   -------------------------------------------------------------
   Why a rewrite?
   • Table rows collapsed on some mobile browsers → invisible cards
   • Duplicate renderers caused confusion (renderExpensesTable vs renderExpensesTable_NEW)
   • Costs sometimes strings → totals = 0
   • ISO dates with time part created one header per entry
   Approach
   • Hide the desktop table on screens <640 px and render 
     a dedicated list of cards in a lightweight <div>.
   • Uses ONLY existing global arrays `expenses` and `recurringItems`.
   • NO changes to desktop logic or CSS – strictly inside a media query.
   ============================================================= */

/* ---------- Helper functions ---------- */
function stripISO(dateStr) {
    // "2025-06-09" or "2025-06-09T14:22"
    return (dateStr || '').split('T')[0];
}
function dateLabel(d) {
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    const target = new Date(d);
    const startTarget = new Date(target.getFullYear(), target.getMonth(), target.getDate());
    const startToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const startYesterday = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());

    if (startTarget.getTime() === startToday.getTime()) return 'Today';
    if (startTarget.getTime() === startYesterday.getTime()) return 'Yesterday';

    return target.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' });
}
function toNumber(x) {
    const n = typeof x === 'string' ? parseFloat(x) : x;
    return isNaN(n) ? 0 : n;
}

/* ---------- Rendering ---------- */
function renderMobileExpenseList(expArr) {
    // Lazy create container if not present
    let container = document.getElementById('expenses-mobile-list');
    if (!container) {
        container = document.createElement('div');
        container.id = 'expenses-mobile-list';
        // Put it right before the desktop table
        const deskTable = document.getElementById('expenses-table') || document.querySelector('#expensesTable');
        deskTable?.parentNode?.insertBefore(container, deskTable);
    }

    // Hide desktop table only on mobile
    const isMobile = window.matchMedia('(max-width:640px)').matches;
    container.style.display = isMobile ? 'block' : 'none';

    if (!isMobile) return; // bail early on desktop

    if (!Array.isArray(expArr) || expArr.length === 0) {
        container.innerHTML = '<p class="text-center py-6 text-sm text-gray-400">No expenses yet</p>';
        return;
    }

    /* ----- group by date ----- */
    const grouped = expArr.reduce((acc, exp) => {
        const key = stripISO(exp.date);
        if (!acc[key]) acc[key] = [];
        acc[key].push(exp);
        return acc;
    }, {});

    const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));

    let html = '';
    sortedDates.forEach(dateKey => {
        const dayExpenses = grouped[dateKey];
        const dayTotal = dayExpenses.reduce((s,e)=> s + toNumber(e.cost), 0);

        /* Date header */
        html += `
            <div style="padding:8px 12px;font-weight:600;font-size:14px;color:#555;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span>${dateLabel(dateKey)}</span>
                    <span>- ${formatCurrency(dayTotal)}</span>
                </div>
            </div>`;

        /* Cards */
        dayExpenses.forEach(exp => {
            const icon = categoryIcons?.[exp.category] ?? '❓';
            html += `
            <div onclick="editExpense(${exp.id})" style="
                 display:flex;align-items:center;gap:12px;
                 padding:12px;margin:4px 12px;background:#fff;
                 border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06);cursor:pointer;">
                <span style="font-size:22px;">${icon}</span>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:500;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;">${escapeHTML(exp.name)}</div>
                    <div style="font-size:12px;color:#666;">${escapeHTML(exp.category)}</div>
                </div>
                <div style="font-weight:600;white-space:nowrap;">${exp.type === 'Income' ? '' : '-'}${formatCurrency(toNumber(exp.cost))}</div>
            </div>`;
        });
    });

    container.innerHTML = html;
}

/* ---------- Hook into existing flow ---------- */
(function(){
    // Wrap original NEW renderer
    const original = window.renderExpensesTable_NEW;
    window.renderExpensesTable_NEW = function() {
        const args = Array.from(arguments);
        const expensesArr = args[0] ?? (typeof filteredExpenses !== 'undefined' ? filteredExpenses : window.expenses ?? []);
        renderMobileExpenseList(expensesArr);
        // Always call original for desktop
        original?.apply(this, args);
    };

    // Initial render for first load
    document.addEventListener('DOMContentLoaded', () => {
        window.renderExpensesTable_NEW();
    });

    // Re-render on resize (cheap debounce)
    let resizeTo = null;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTo);
        resizeTo = setTimeout(() => window.renderExpensesTable_NEW(), 150);
    });
})(); 



// ]]>
</script>
</body>
</html>
