<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character encoding and viewport configuration for responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>Lens - Personal Finance Tracker</title>
    
    <!-- Progressive Web App (PWA) configuration for installable app experience -->
    <meta name="description" content="Clear financial insight for personal expense tracking and budgeting">
    <meta name="theme-color" content="#2F4F4F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lens">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Content Security Policy: Defines allowed sources for scripts, styles, and connections -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdn.plaid.com https://accounts.google.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https: http://localhost:8000 http://127.0.0.1:8000 https://accounts.google.com https://oauth2.googleapis.com; frame-src https://cdn.plaid.com https://accounts.google.com;">
    
    <!-- App icons for various platforms and PWA installation -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='iconGradient' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6'/%3E%3Cstop offset='100%25' style='stop-color:%231d4ed8'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='0' y='0' width='32' height='32' rx='6' fill='url(%23iconGradient)'/%3E%3Ccircle cx='16' cy='16' r='10' fill='none' stroke='rgba(255,255,255,0.9)' stroke-width='1.5'/%3E%3Ccircle cx='16' cy='16' r='6' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='1'/%3E%3Ccircle cx='16' cy='16' r='3' fill='none' stroke='rgba(255,255,255,0.6)' stroke-width='1'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="mask-icon" href="icons/icon-192x192.png" color="#3b82f6">
    
    <!-- PWA Manifest: Defines app metadata for installation -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- External dependencies: UI framework, charting library, and banking integration -->
    <!-- Tailwind CSS: Utility-first CSS framework for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js: Library for rendering financial charts and graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Date adapter for Chart.js time-based charts -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Plaid Link: Integration for secure bank account connection -->
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <!-- Typography: Inter font for consistent text rendering -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Driver.js: User onboarding tour library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css">
    <style>
        /* Global font family configuration with system font fallbacks */
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* MOBILE FAB - FORCE HIDE REDUNDANT ELEMENTS */
        @media (max-width: 640px) {
            /* NUCLEAR OPTION - FORCE HIDE QUICK ACTIONS */
            .card:has(h3:contains("Quick Actions")),
            .card:has(h2:contains("Quick Actions")),
            div:has(> h3:contains("Quick Actions")),
            div:has(> h2:contains("Quick Actions")),
            section:has(h3:contains("Quick Actions")),
            
            /* Hide cards with specific content markers added by JavaScript */
            .hide-mobile-quick-add,
            .hide-mobile-quick-actions,
            .hide-mobile-add-income,
            .hide-mobile-add-recurring {
                display: none !important;
            }
            
            /* Hide quick action buttons and their containers (but NOT in FAB) */
            button[onclick*="quickAddExpense"]:not(.fab-quick-item):not(.fab-action-button),
            button[onclick*="showAddForm"]:not(.fab-action-button) {
                display: none !important;
            }
            
            /* FORCE HIDE BY STRUCTURE - target the exact Quick Actions card */
            #overview-tab > div > div:has(h3:contains("Quick Actions")),
            .tab-content > div > div:has(h3:contains("Quick Actions")),
            
            /* Hide cards by position (fallback) */
            #overview-tab .card.p-4.mb-4:nth-of-type(3):not(.fab-menu),
            #overview-tab .card.p-4.mb-4:nth-of-type(4):not(.fab-menu) {
                display: none !important;
            }
        }
        
        /* CSS Custom Properties for theme colors and consistent design system */
        :root {
            /* Light mode color palette */
            --color-primary: #0066CC;
            --color-primary-hover: #0052A3;
            --color-success: #00A651;
            --color-warning: #FF7B00;
            --color-error: #E31E24;
            
            /* Backgrounds */
            --color-bg-primary: #FFFFFF;
            --color-bg-secondary: #F8F9FA;
            --color-bg-tertiary: #F1F3F4;
            --color-surface: #FFFFFF;
            
            /* Text colors */
            --color-text-primary: #202124;
            --color-text-secondary: #5F6368;
            --color-text-tertiary: #9AA0A6;
            
            /* Borders */
            --color-border: #E8EAED;
            --color-border-focus: #0066CC;
            
            /* Legacy variable mappings maintained for backward compatibility with existing components */
            --bg-primary: var(--color-bg-primary);
            --bg-secondary: var(--color-bg-secondary);
            --bg-tertiary: var(--color-bg-tertiary);
            --text-primary: var(--color-text-primary);
            --text-secondary: var(--color-text-secondary);
            --text-tertiary: var(--color-text-tertiary);
            --border-color: var(--color-border);
            --accent-primary: var(--color-primary);
            --accent-secondary: var(--color-warning);
            --accent-blue: var(--color-primary);
            --accent-green: var(--color-success);
            --accent-red: var(--color-error);
            --accent-yellow: var(--color-warning);
            --accent-purple: var(--color-primary);
            --accent-pink: var(--color-warning);
            --accent-orange: var(--color-warning);
            --help-text-color: var(--color-text-secondary);
            --health-score-good: var(--color-success);
            --health-score-ok: var(--color-warning);
            --health-score-bad: var(--color-error);
            
            /* Layout system variables inspired by Trezor Suite design patterns */
            --sidebar-width: 240px;
            --sidebar-collapsed-width: 64px;
            --header-height: 64px;
            --border-radius: 6px;
            --border-radius-sm: 4px;
            --border-radius-xs: 2px;
        }

        /* Dark theme overrides using data attribute for explicit theme control */
        [data-theme="dark"] {
            /* Dark mode color palette with improved contrast and warm grays */
            --color-primary: #4A9EFF;
            --color-primary-hover: #66B3FF;
            --color-success: #00C964;
            --color-warning: #FF9533;
            --color-error: #FF4448;
            
            /* Backgrounds - Warm grays, not pure black */
            --color-bg-primary: #1F1F23;
            --color-bg-secondary: #2F2F35;
            --color-bg-tertiary: #3F3F46;
            --color-surface: #2F2F35;
            
            /* Text colors - Improved contrast for accessibility */
            --color-text-primary: #F4F4F5;
            --color-text-secondary: #D4D4D8;
            --color-text-tertiary: #A1A1AA;
            
            /* Borders */
            --color-border: #52525B;
            --color-border-focus: #4A9EFF;
        }
        .dark {
            /* Use data-theme approach for dark mode */
            --bg-primary: var(--color-bg-primary);
            --bg-secondary: var(--color-bg-secondary);
            --bg-tertiary: var(--color-bg-tertiary);
            --text-primary: var(--color-text-primary);
            --text-secondary: var(--color-text-secondary);
            --text-tertiary: var(--color-text-tertiary);
            --border-color: var(--color-border);
            --accent-primary: var(--color-primary);
            --accent-secondary: var(--color-warning);
            --accent-blue: var(--color-primary);
            --accent-green: var(--color-success);
            --accent-red: var(--color-error);
            --accent-yellow: var(--color-warning);
            --accent-purple: var(--color-primary);
            --accent-pink: var(--color-warning);
            --accent-orange: var(--color-warning);
            --help-text-color: var(--color-text-secondary);
            --health-score-good: var(--color-success);
            --health-score-ok: var(--color-warning);
            --health-score-bad: var(--color-error);
        }
        
        /* Theme toggle icon transitions between light (sun) and dark (moon) modes */
        .theme-icon {
            transition: all 0.3s ease;
        }
        
        .theme-icon-light {
            display: block;
        }
        
        .theme-icon-dark {
            display: none;
        }
        
        .dark .theme-icon-light {
            display: none;
        }
        
        .dark .theme-icon-dark {
            display: block;
        }
        
        /* Theme toggle button hover effect for user feedback */
        #theme-toggle-btn {
            position: relative;
        }
        
        #theme-toggle-btn:hover {
            transform: scale(1.05);
        }
        /* Base body styles with theme-aware colors and smooth transitions */
        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            padding: 0;
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Main application container using flexbox layout */
        .trezor-app {
            display: flex;
            min-height: 100vh;
            background-color: var(--bg-secondary);
        }
        
        /* Fixed sidebar navigation with collapsible functionality */
        .trezor-sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 40;
            transition: all 0.3s ease;
        }
        
        .trezor-sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }
        
        /* Sidebar header containing logo and brand name */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            height: var(--header-height);
            box-sizing: border-box;
        }
        
        .sidebar-logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), #00924a);
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .sidebar-brand {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: opacity 0.3s ease;
            flex: 1;
        }
        
        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }
        
        .sidebar-toggle:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .trezor-sidebar.collapsed .sidebar-brand {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }
        
        .trezor-sidebar.collapsed .sidebar-toggle {
            margin-left: 0;
        }
        
        .trezor-sidebar.collapsed .sidebar-toggle svg {
            transform: rotate(180deg);
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }
        
        /* Visual indicator for sidebar collapse state - rotates chevron icon */
        .trezor-sidebar.collapsed .nav-item[title="Toggle sidebar"] svg {
            transform: rotate(180deg);
        }
        
        /* Navigation item styling with hover and active states */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            position: relative;
        }
        
        .nav-item:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background-color: rgba(0, 171, 85, 0.1);
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: var(--accent-primary);
            border-radius: 0 2px 2px 0;
        }
        
        .nav-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            transition: opacity 0.3s ease;
        }
        
        .nav-text {
            transition: opacity 0.3s ease;
        }
        
        .trezor-sidebar.collapsed .nav-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }
        
        .trezor-sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 0.75rem;
        }
        
        .trezor-sidebar.collapsed .nav-item:hover {
            position: relative;
        }
        
        /* Tooltip display when sidebar is collapsed - shows nav item labels on hover */
        .trezor-sidebar.collapsed .nav-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1000;
            margin-left: 0.5rem;
            border: 1px solid var(--color-border);
        }
        
        .trezor-sidebar.collapsed .nav-item:hover::after {
            opacity: 1;
        }
        
        .trezor-main {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        .trezor-sidebar.collapsed + .trezor-main {
            margin-left: var(--sidebar-collapsed-width);
        }
        
        .trezor-header {
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 30;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .trezor-content {
            flex: 1;
            padding: 2rem;
            background-color: var(--bg-secondary);
            overflow-y: auto;
        }
        
        /* Content area constraints to prevent horizontal overflow */
        .trezor-content {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .tab-content {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .grid {
            width: 100%;
            max-width: 100%;
        }
        
        /* Card component styling with text wrapping for long content */
        .card, .trezor-card {
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
        }
        
        /* 
         * Mobile-First Responsive Design Section
         * Features: Floating action button, bottom sheet modal, and enhanced navigation
         */
        
        /* Floating action button (FAB) for quick expense entry on mobile */
        .floating-quick-add {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            border: none;
        }
        
        .floating-quick-add:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 102, 204, 0.4);
        }
        
        .floating-quick-add svg {
            width: 28px;
            height: 28px;
            color: white;
        }
        
        /* Bottom sheet modal for mobile quick actions with safe area support */
        .quick-add-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            padding-bottom: max(24px, calc(24px + env(safe-area-inset-bottom)));
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            max-height: calc(90vh - 80px);
            overflow-y: auto;
        }
        
        .quick-add-modal.open {
            transform: translateY(0);
        }
        
        .quick-add-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 190;
        }
        
        .quick-add-modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-handle {
            width: 36px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 20px;
        }
        
        .quick-add-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .quick-add-option {
            padding: 20px 16px;
            background: var(--bg-secondary);
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .quick-add-option:active {
            transform: scale(0.95);
        }
        
        .quick-add-option.selected {
            border-color: var(--accent-primary);
            background: rgba(0, 102, 204, 0.1);
        }
        
        .quick-add-option-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 20px;
            color: white;
        }
        
        .quick-add-option-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        /* Fixed bottom navigation bar for mobile devices with blur effect */
        .mobile-bottom-nav {
            padding-bottom: 24px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 16px 0 max(20px, env(safe-area-inset-bottom));
            z-index: 50;
            backdrop-filter: blur(10px);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        /* Animation to hide bottom nav when modal overlays are active */
        .mobile-bottom-nav.modal-open {
            transform: translateY(100%);
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            text-decoration: none;
            min-width: 60px;
        }
        
        .mobile-nav-item:hover {
            background-color: var(--bg-secondary);
        }
        
        .mobile-nav-item.active {
            background-color: rgba(0, 102, 204, 0.1);
            color: var(--color-primary);
        }
        
        .mobile-nav-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }
        
        .mobile-nav-text {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .mobile-nav-item.active .mobile-nav-text {
            color: var(--color-primary);
            font-weight: 600;
        }
        
        /* Mobile Dropdown Menu Styles */
        .mobile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            min-width: 160px;
            margin-top: 8px;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        
        .mobile-dropdown.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .mobile-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: left;
        }
        
        .mobile-dropdown-item:hover {
            background-color: var(--bg-secondary);
        }
        
        .mobile-dropdown-item:active {
            background-color: var(--bg-tertiary);
        }
        
        .mobile-dropdown-item svg {
            flex-shrink: 0;
        }
        
        /* Dark mode styles */
        .dark .mobile-dropdown {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        
        /* CRITICAL MOBILE FIXES - OVERRIDE ALL LAYOUT ISSUES */
        @media (max-width: 768px) {
            /* Hide desktop sidebar completely on mobile */
            .trezor-sidebar {
                display: none !important;
            }
            
            .trezor-main {
                margin-left: 0 !important;
                width: 100% !important;
            }
            
            .trezor-header {
                width: 100% !important;
                left: 0 !important;
                padding: 1rem !important;
            }
            
            .trezor-content {
                padding: 1rem !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                overflow-x: hidden !important;
                padding-bottom: 100px !important;
            }
            
            /* Modal specific fixes */
            #modal {
                z-index: 250 !important;
                max-height: calc(100vh - 40px) !important;
                margin-bottom: 40px !important;
            }
            
            #modal .card {
                max-height: calc(100vh - 120px) !important;
                overflow-y: auto !important;
                margin-bottom: 80px !important;
            }
            
            /* Hide bottom nav when any modal is open */
            body.modal-open .mobile-bottom-nav {
                transform: translateY(100%) !important;
            }
            
            /* Fix whitespace issues */
            body {
                margin: 0 !important;
                padding: 0 !important;
                overflow-x: hidden !important;
            }
            
            .trezor-app {
                width: 100vw !important;
                overflow-x: hidden !important;
            }
            
            /* Dashboard cards - uniform size */
            .stats-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 0.75rem !important;
                margin-bottom: 1.5rem !important;
                width: 100% !important;
            }
            
            .stat-card {
                min-height: 100px !important;
                padding: 1rem !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                text-align: center !important;
            }
            
            .stat-card-value {
                font-size: 1.25rem !important;
                font-weight: 700 !important;
                margin-bottom: 0.25rem !important;
            }
            
            .stat-card-title {
                font-size: 0.75rem !important;
                color: var(--text-secondary) !important;
                text-align: center !important;
            }
            
            /* Fix recurring tab empty state */
            #recurring-tab .tab-content {
                display: block !important;
                padding: 1rem !important;
            }
            
            /* Show mobile navigation */
            .mobile-bottom-nav {
                display: flex !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: var(--bg-primary) !important;
                border-top: 1px solid var(--border-color) !important;
                padding: 0.75rem 0 !important;
                z-index: 50 !important;
            }
            
            .floating-quick-add {
                display: flex !important;
                position: fixed !important;
                bottom: 110px !important;
                right: 1rem !important;
                z-index: 60 !important;
            }
            
            /* Hide desktop quick add buttons */
            .quick-add-section,
            .quick-actions {
                display: none !important;
            }
            
            /* Fix text overflow and cutting */
            * {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                box-sizing: border-box !important;
            }
            
            .page-title {
                text-align: center !important;
                font-size: 1.25rem !important;
                margin: 0 !important;
            }
            
            /* MAIN CONTENT ROW - Mobile Layout Fixes */
            .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3 {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            /* Left column full width on mobile */
            .lg\:col-span-2 {
                grid-column: 1 !important;
            }
            
            /* Space between sections */
            .space-y-6 > * + * {
                margin-top: 1.5rem !important;
            }
            
            /* Budget Progress card mobile */
            .card.p-6 {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                display: block !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Ensure all cards are visible */
            .card {
                visibility: visible !important;
                opacity: 1 !important;
                display: block !important;
            }
            
            /* Quick Add grid for mobile - FIXED */
            .quick-add-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
            }
            
            /* Quick Add button container wrapper */
            .quick-add-grid > div,
            .quick-add-wrapper {
                padding: 0 !important;
                box-sizing: border-box !important;
                width: 100% !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Quick Add button styling - FIXED */
            .quick-add-button {
                padding: 0.5rem !important;
                min-height: 60px !important;
                width: 100% !important;
                max-width: 100% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                gap: 0.375rem !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
                border-radius: 0.5rem !important;
                font-size: 0.75rem !important;
            }
            
            /* Content layout inside quick add button */
            .quick-add-content {
                display: flex !important;
                align-items: center !important;
                width: 100% !important;
                gap: 0.375rem !important;
                overflow: hidden !important;
                min-width: 0 !important;
            }
            
            /* Icon styling */
            .quick-add-icon {
                width: 1.75rem !important;
                height: 1.75rem !important;
                flex-shrink: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 0.375rem !important;
            }
            
            .quick-add-icon svg {
                width: 0.875rem !important;
                height: 0.875rem !important;
            }
            
            /* Text container - FIXED */
            .quick-add-button .flex-1 {
                flex: 1 1 0% !important;
                min-width: 0 !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: flex-start !important;
                max-width: calc(100% - 3.5rem) !important;
            }
            
            /* Title text - FIXED */
            .quick-add-title {
                font-size: 0.6875rem !important;
                font-weight: 600 !important;
                line-height: 1.1 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                width: 100% !important;
                max-width: 100% !important;
                display: block !important;
                color: var(--color-text-primary) !important;
            }
            
            /* Category text - FIXED */
            .quick-add-category {
                font-size: 0.625rem !important;
                line-height: 1.1 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                width: 100% !important;
                max-width: 100% !important;
                display: block !important;
                color: var(--color-text-secondary) !important;
                margin-top: 0.125rem !important;
            }
            
            /* Price styling - FIXED */
            .quick-add-price {
                font-size: 0.6875rem !important;
                font-weight: 700 !important;
                flex-shrink: 0 !important;
                white-space: nowrap !important;
                min-width: auto !important;
                color: var(--color-text-primary) !important;
            }
            
            /* Budget Progress & Health Section - Mobile Fixes */
            .card.p-6 {
                padding: 1rem !important;
            }
            
            /* Budget progress header mobile - TARGETED */
            .card.p-6 .flex.justify-between.items-center.mb-6 {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.75rem !important;
                margin-bottom: 1rem !important;
            }
            
            .card.p-6 .flex.items-center.gap-2 {
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
            }
            
            /* Budget Progress Section Mobile Optimization - TARGETED */
            .card.p-6 #budget-progress-used,
            .card.p-6 #days-remaining,
            .card.p-6 #budget-income-percentage,
            .card.p-6 #ai-insight,
            .card.p-6 #ai-insight-status {
                font-size: 0.875rem !important;
                line-height: 1.4 !important;
            }
            
            /* Progress bar mobile styling */
            #budget-progress-bar {
                height: 0.75rem !important;
                border-radius: 0.375rem !important;
            }
            
            /* Budget insight box mobile */
            .bg-blue-50 {
                padding: 0.75rem !important;
                border-radius: 0.5rem !important;
            }
            
            /* Health Score Circle - Mobile Responsive - TARGETED FIX */
            .relative.w-20.h-20 {
                width: 4rem !important;
                height: 4rem !important;
                margin: 0 auto !important;
            }
            
            .w-20.h-20 {
                width: 4rem !important;
                height: 4rem !important;
            }
            
            /* HIDE ONLY THE HEALTH SCORE CIRCLE ON MOBILE */
            .relative.w-20.h-20 {
                display: none !important;
            }
            
            #health-score-status {
                font-size: 0.75rem !important;
                margin-top: 0.25rem !important;
            }
            
            /* Health Score Tooltip Mobile */
            #health-score-tooltip-container {
                position: fixed !important;
                left: 1rem !important;
                right: 1rem !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                width: auto !important;
                max-width: calc(100vw - 2rem) !important;
                z-index: 9999 !important;
                font-size: 0.75rem !important;
                line-height: 1.4 !important;
                padding: 1rem !important;
                border-radius: 0.5rem !important;
            }
            
            /* Budget Health Tooltip Mobile */
            #budget-health-tooltip-container {
                position: fixed !important;
                left: 1rem !important;
                right: 1rem !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                width: auto !important;
                max-width: calc(100vw - 2rem) !important;
                z-index: 9999 !important;
                font-size: 0.75rem !important;
                line-height: 1.4 !important;
                padding: 1rem !important;
                border-radius: 0.5rem !important;
            }
            
            /* Budget Progress Layout Mobile - TARGETED */
            .card.p-6 .flex.justify-between.items-start {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            
            .card.p-6 .flex-1.mr-8 {
                margin-right: 0 !important;
                width: 100% !important;
            }
            
            /* Health score positioning mobile - TARGETED */
            .card.p-6 .text-center {
                margin-top: 0 !important;
                width: 100% !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
            }
            
            /* SVG health score mobile */
            #health-progress-circle {
                stroke-width: 6 !important;
            }
            
            /* Info icons mobile friendly */
            .w-5.h-5 {
                width: 1.25rem !important;
                height: 1.25rem !important;
                flex-shrink: 0 !important;
            }
            
            /* Budget section headers mobile - TARGETED */
            .card.p-6 .text-xl.font-semibold {
                font-size: 1.125rem !important;
                line-height: 1.4 !important;
            }
            
            .card.p-6 .text-lg.font-medium {
                font-size: 1rem !important;
                line-height: 1.4 !important;
            }
            
            /* Ensure tooltip containers don't cause overflow */
            .relative {
                overflow: visible !important;
            }
            
            /* Fix tooltip positioning for info icons */
            .group:hover .absolute,
            .relative:hover .absolute {
                position: fixed !important;
                z-index: 9999 !important;
                top: auto !important;
                bottom: auto !important;
                left: 50% !important;
                transform: translateX(-50%) translateY(-100%) !important;
                margin-top: -0.5rem !important;
            }
        }
        
        /* Additional mobile fixes for very small screens */
        @media (max-width: 480px) {
            .quick-add-grid {
                gap: 0.375rem !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* Additional Budget Progress fixes for very small screens */
            .quick-add-grid > div,
            .quick-add-wrapper {
                padding: 0.125rem !important;
            }
            
            /* Budget Progress & Health - Extra Small Mobile - TARGETED */
            .relative.w-20.h-20 {
                width: 3.5rem !important;
                height: 3.5rem !important;
            }
            
            .w-20.h-20 {
                width: 3.5rem !important;
                height: 3.5rem !important;
            }
            
            /* HIDE ONLY THE HEALTH SCORE CIRCLE ON SMALL MOBILE */
            .relative.w-20.h-20 {
                display: none !important;
            }
            
            #health-score-status {
                font-size: 0.625rem !important;
            }
            
            /* Progress text sizing - TARGETED */
            .card.p-6 #budget-progress-used,
            .card.p-6 #days-remaining {
                font-size: 0.75rem !important;
            }
            
            /* Budget insight box extra small - TARGETED */
            .card.p-6 .bg-blue-50 {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
            }
            
            .card.p-6 #ai-insight,
            .card.p-6 #ai-insight-status {
                font-size: 0.75rem !important;
                line-height: 1.3 !important;
            }
            
            /* Section headers extra small - TARGETED */
            .card.p-6 .text-xl.font-semibold {
                font-size: 1rem !important;
            }
            
            .quick-add-button {
                padding: 0.375rem !important;
                min-height: 56px !important;
                gap: 0.25rem !important;
            }
            
            .quick-add-content {
                gap: 0.25rem !important;
            }
            
            .quick-add-icon {
                width: 1.5rem !important;
                height: 1.5rem !important;
                border-radius: 0.25rem !important;
            }
            
            .quick-add-icon svg {
                width: 0.75rem !important;
                height: 0.75rem !important;
            }
            
            .quick-add-title {
                font-size: 0.625rem !important;
                line-height: 1 !important;
            }
            
            .quick-add-category {
                font-size: 0.5625rem !important;
                line-height: 1 !important;
                margin-top: 0.0625rem !important;
            }
            
            .quick-add-price {
                font-size: 0.625rem !important;
                font-weight: 700 !important;
            }
            
            /* Text container constraints for very small screens */
            .quick-add-button .flex-1 {
                max-width: calc(100% - 2.75rem) !important;
            }
            
            /* Ensure all tooltips work on small screens */
            .relative .absolute {
                min-width: 180px !important;
                max-width: 240px !important;
                font-size: 0.625rem !important;
                padding: 0.375rem !important;
            }
        }
        
        /* Hide mobile elements on desktop */
        @media (min-width: 769px) {
            .mobile-bottom-nav,
            .floating-quick-add {
                display: none !important;
            }
            
            /* Desktop Quick Add styling */
            .quick-add-grid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 1rem !important;
                width: 100% !important;
            }
            
            .quick-add-wrapper {
                display: block !important;
                width: 100% !important;
            }
            
            .quick-add-button {
                width: 100% !important;
                min-height: 80px !important;
                padding: 1rem !important;
                display: flex !important;
                align-items: center !important;
                gap: 0.75rem !important;
            }
            
            .quick-add-content {
                display: flex !important;
                align-items: center !important;
                gap: 0.75rem !important;
                width: 100% !important;
            }
            
            .quick-add-icon {
                width: 2.5rem !important;
                height: 2.5rem !important;
                flex-shrink: 0 !important;
            }
            
            .quick-add-icon svg {
                width: 1.5rem !important;
                height: 1.5rem !important;
            }
            
            .quick-add-button .flex-1 {
                flex: 1 1 0% !important;
                min-width: 0 !important;
                overflow: hidden !important;
            }
            
            .quick-add-title {
                font-size: 1rem !important;
                font-weight: 500 !important;
                line-height: 1.25 !important;
                margin-bottom: 0.25rem !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            .quick-add-category {
                font-size: 0.875rem !important;
                line-height: 1.25 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            .quick-add-price {
                font-size: 1rem !important;
                font-weight: 600 !important;
                flex-shrink: 0 !important;
                white-space: nowrap !important;
            }
        }
        
        /* =============================================
           MOBILE-FIRST TABLE TO CARD TRANSFORMATION
           ============================================= */

        /* Hide desktop tables on mobile, show card view */
        @media (max-width: 768px) {
            /* Hide the actual table structure on mobile */
            #expenses-table,
            #recurring-table,
            .overflow-x-auto table {
                display: none !important;
            }
            
            /* Show mobile card containers instead */
            .mobile-cards-container {
                display: block !important;
            }
        }

        /* Mobile card container */
        .mobile-cards-container {
            display: none;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            padding-bottom: 120px; /* Extra space for bottom nav */
        }
        
        /* Hide on desktop */
        @media (min-width: 769px) {
            .mobile-cards-container {
                display: none !important;
            }
        }

        /* Individual expense card styling */
        .expense-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .expense-card:active {
            transform: scale(0.98);
            background: var(--bg-tertiary);
        }

        /* Card checkbox */
        .expense-card-checkbox {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Card icon */
        .expense-card-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        /* Card content */
        .expense-card-content {
            flex: 1;
            min-width: 0;
        }

        .expense-card-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 4px;
            padding-right: 40px; /* Space for checkbox */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .expense-card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .expense-card-category {
            display: inline-block;
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 12px;
        }

        /* Card amount */
        .expense-card-amount {
            text-align: right;
            flex-shrink: 0;
        }

        .expense-card-amount-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .expense-card-amount-type {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        /* Date section headers for mobile */
        .mobile-date-section {
            margin-bottom: 20px;
        }

        .mobile-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mobile-date-total {
            font-weight: 600;
            color: var(--text-tertiary);
        }

        /* Recurring item card styling */
        .recurring-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .recurring-card:active {
            transform: scale(0.98);
            background: var(--bg-tertiary);
        }

        .recurring-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .recurring-card-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .recurring-card-info {
            flex: 1;
            min-width: 0;
        }

        .recurring-card-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .recurring-card-type {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .recurring-card-amount {
            text-align: right;
        }

        .recurring-card-amount-value {
            font-size: 20px;
            font-weight: 700;
        }

        .recurring-card-amount-frequency {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .recurring-card-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 14px;
        }

        /* Search bar fixes for mobile */
        @media (max-width: 768px) {
            .search-filters {
                flex-direction: column;
                gap: 12px;
                padding: 16px !important;
                background: var(--bg-secondary);
                position: sticky;
                top: 64px;
                z-index: 30;
                border-bottom: 1px solid var(--border-color);
            }
            
            .search-filters input[type="text"],
            .search-filters select {
                width: 100% !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            /* Fix button alignment */
            .search-filters .flex {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Tab content padding adjustment for mobile */
        @media (max-width: 768px) {
            #expenses-tab .tab-content,
            #recurring-tab .tab-content {
                padding: 0 !important;
            }
            
            /* Ensure proper spacing with bottom nav */
            .trezor-content {
                padding-bottom: 100px !important;
            }
            
            /* Fix the card container positioning */
            .mobile-cards-container {
                padding: 16px !important;
                margin-bottom: 100px !important; /* Space for bottom nav */
                display: block !important;
            }
        }
        
        /* Safe area handling for notched devices */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
          body {
            padding-bottom: max(5rem, env(safe-area-inset-bottom));
          }
          
          .mobile-bottom-nav {
            padding-bottom: max(8px, env(safe-area-inset-bottom));
          }
        }

        /* iOS Safari specific fixes */
        @media screen and (max-device-width: 767px) and (-webkit-min-device-pixel-ratio: 2) {
          .mobile-bottom-nav {
            height: 56px !important;
          }
          
          .bottom-nav-item svg {
            width: 1.125rem !important;
            height: 1.125rem !important;
            margin-bottom: 0.125rem !important;
          }
          
          .bottom-nav-item span {
            font-size: 0.625rem !important;
          }
        }
        
        /* Additional mobile layout fixes */
        @media (max-width: 768px) {
            .bottom-nav {
                display: flex !important;
            }
        }
        
        @media (min-width: 769px) {
            .bottom-nav,
            .mobile-bottom-nav {
                display: none !important;
            }
        }
        
        /* Enhanced hover effects for all screen sizes */
        @media (min-width: 769px) {
            /* More noticeable Quick Add button hover effects on desktop */
            .quick-add-button:hover {
                background-color: rgb(219 234 254) !important; /* blue-100 */
                border-color: rgb(59 130 246) !important; /* blue-500 */
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                transform: translateY(-1px) !important;
            }
            
            .dark .quick-add-button:hover {
                background-color: rgb(30 58 138) !important; /* blue-900/30 */
                border-color: rgb(59 130 246) !important; /* blue-500 */
            }
            
            /* Enhanced Quick Action button hover effects */
            button[onclick="showAddForm()"]:hover {
                background-color: rgb(29 78 216) !important; /* blue-700 */
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                transform: translateY(-1px) !important;
            }
            
            button[onclick="showAddIncomeForm()"]:hover,
            button[onclick="showRecurringForm()"]:hover {
                background-color: rgb(249 250 251) !important; /* gray-50 */
                border-color: rgb(59 130 246) !important; /* blue-500 */
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                transform: translateY(-1px) !important;
            }
            
            .dark button[onclick="showAddIncomeForm()"]:hover,
            .dark button[onclick="showRecurringForm()"]:hover {
                background-color: rgb(55 65 81) !important; /* gray-700 */
                border-color: rgb(59 130 246) !important; /* blue-500 */
            }
            
            /* Enhanced Add Income button in top area */
            .btn-primary:hover {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                transform: translateY(-1px) !important;
            }
        }
        
        /* Hide old container system - using Trezor layout now */
        .container {
            display: none;
        }
        
        /* Mobile-first responsive design - legacy (keeping for compatibility) */
        .legacy-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        @media (min-width: 640px) {
            .legacy-container {
                padding: 0 1.5rem;
            }
        }
        
        @media (min-width: 1024px) {
            .legacy-container {
                max-width: 1200px;
                padding: 0 2rem;
            }
        }
        
        /* Ensure proper mobile spacing */
        .mobile-safe {
            padding-left: max(1rem, env(safe-area-inset-left));
            padding-right: max(1rem, env(safe-area-inset-right));
        }
        
        /* Mobile Dashboard - Hide specific components */
        @media (max-width: 768px) {
            /* Hide Add Income section on mobile - Target the specific card */
            .card.p-4.mb-4:first-of-type {
                display: none !important;
            }
            
            /* Hide Quick Add component (all four buttons) on mobile */
            .card.p-4.mb-4:has(.quick-add-grid) {
                display: none !important;
            }
            
            /* Hide Quick Actions (all three buttons) on mobile */
            .card.p-4:has(.space-y-3:has(button[onclick*="showAddForm"])) {
                display: none !important;
            }
            
            /* Direct targeting for better compatibility */
            .quick-add-grid {
                display: none !important;
            }
            
            /* Hide the specific cards by their content */
            .card.p-4.mb-4:has(h3.text-lg.font-semibold:contains("Quick Add")) {
                display: none !important;
            }
            
            .card.p-4:has(h3.text-lg.font-semibold:contains("Quick Actions")) {
                display: none !important;
            }
            
            /* Force hide with multiple selectors */
            .card.p-4.mb-4:has(button[onclick*="showAddIncomeForm"]) {
                display: none !important;
            }
            
            .card.p-4.mb-4:has(.quick-add-wrapper) {
                display: none !important;
            }
            
            .card.p-4:has(button[onclick*="showAddForm"]) {
                display: none !important;
            }
            
            .card.p-4:has(button[onclick*="showRecurringForm"]) {
                display: none !important;
            }
            
            /* Ultra aggressive hiding for mobile */
            .trezor-content .card.p-4.mb-4:first-child {
                display: none !important;
            }
            
            .trezor-content .card.p-4.mb-4:has(.quick-add-grid) {
                display: none !important;
            }
            
            .trezor-content .card.p-4:has(button[onclick*="showAddForm"]) {
                display: none !important;
            }
            
            /* Hide by specific text content */
            .trezor-content .card:has(h2:contains("Total Monthly Income")) {
                display: none !important;
            }
            
            .trezor-content .card:has(h3:contains("Quick Add")) {
                display: none !important;
            }
            
            .trezor-content .card:has(h3:contains("Quick Actions")) {
                display: none !important;
            }
            
            /* 1. Extend progress bars and projections components */
            .card.p-4:has(#budget-progress-bar) {
                padding: 1.5rem !important;
            }
            
            #budget-progress-bar {
                height: 1rem !important;
                border-radius: 0.5rem !important;
            }
            
            /* Extend projection components */
            .card.p-4:has(.bg-blue-50) {
                padding: 1.5rem !important;
            }
            
            .bg-blue-50 {
                padding: 1rem !important;
                margin: 0.5rem 0 !important;
            }
            
            /* 2. Fix information too close to right edge */
            .trezor-content {
                padding: 1rem !important;
                max-width: 100vw !important;
                overflow-x: hidden !important;
            }
            
            .card {
                margin: 0.5rem 0 !important;
                padding: 1rem !important;
                box-sizing: border-box !important;
            }
            
            /* 3. Fix bottom navigation positioning */
            .mobile-bottom-nav {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: var(--bg-primary) !important;
                border-top: 1px solid var(--border-color) !important;
                padding: 0.5rem 0 !important;
                z-index: 50 !important;
                height: auto !important;
                min-height: 60px !important;
            }
            
            .bottom-nav-item {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 0.25rem !important;
                padding: 0.5rem 0.75rem !important;
                min-height: 50px !important;
            }
            
            .bottom-nav-item svg {
                width: 1.25rem !important;
                height: 1.25rem !important;
                margin-bottom: 0.125rem !important;
            }
            
            .bottom-nav-item span {
                font-size: 0.625rem !important;
                line-height: 1 !important;
                margin-top: 0 !important;
            }
            
            /* 4. Reduce FAB size for better button visibility */
            .floating-quick-add {
                width: 48px !important;
                height: 48px !important;
                bottom: 80px !important;
                right: 16px !important;
            }
            
            .floating-quick-add svg {
                width: 24px !important;
                height: 24px !important;
            }
            
            /* 5. Prevent horizontal layout changes */
            @media (orientation: landscape) {
                .trezor-content {
                    max-width: 100vw !important;
                    width: 100vw !important;
                }
                
                .card {
                    max-width: 100% !important;
                    width: 100% !important;
                }
                
                .stats-grid {
                    grid-template-columns: 1fr 1fr !important;
                }
                
                .mobile-bottom-nav {
                    position: fixed !important;
                    bottom: 0 !important;
                }
            }
            
            /* 6. Swap Save/Cancel button positions */
            .modal-footer {
                display: flex !important;
                gap: 0.75rem !important;
                justify-content: space-between !important;
            }
            
            .modal-footer button:first-child {
                order: 2 !important;
            }
            
            .modal-footer button:last-child {
                order: 1 !important;
            }
        }
        /* Trezor Suite Button Styles */
        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary:hover {
            background-color: var(--color-primary-hover);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-secondary:hover {
            background-color: var(--color-bg-tertiary);
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background-color: var(--accent-red);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-danger:hover {
            background-color: var(--color-error);
            transform: translateY(-1px);
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        /* Trezor Suite Card Styles */
        .card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }
        

        
        .trezor-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card-header {
            padding: 1.5rem 1.5rem 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .card-content {
            padding: 1.5rem;
        }
        
        .card-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stat-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            padding: 0.75rem 0.5rem; /* Reduced padding for small screens */
            transition: all 0.2s ease;
            text-align: center;
            overflow: hidden;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        @media (min-width: 480px) {
            .stat-card {
                padding: 1rem 0.75rem;
                min-height: 80px;
            }
        }
        
        @media (min-width: 640px) {
            .stat-card {
                padding: 1.25rem 1rem;
                min-height: 90px;
            }
        }
        
        @media (min-width: 768px) {
            .stat-card {
                padding: 1.5rem 1.25rem;
                min-height: 100px;
            }
        }
        
        .dark .stat-card {
             background-color: var(--bg-tertiary);
        }
        .stat-card.cursor-pointer:hover {
            border-color: var(--color-border-focus);
        }
        .stat-card-title {
            font-size: 0.625rem; /* Very small for mobile */
            font-weight: 500; /* medium */
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.1;
        }
        
        @media (min-width: 480px) {
            .stat-card-title {
                font-size: 0.6875rem; /* Slightly larger */
            }
        }
        
        @media (min-width: 640px) {
            .stat-card-title {
                font-size: 0.75rem; /* text-xs */
            }
        }
        
        @media (min-width: 768px) {
            .stat-card-title {
                font-size: 0.875rem; /* text-sm on md+ */
            }
        }
        
        .stat-card-value {
            font-size: 1rem; /* Smaller base size */
            font-weight: 700; /* bold */
            color: var(--text-primary);
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }
        
        /* Responsive font sizes for better mobile experience */
        @media (min-width: 480px) {
            .stat-card-value {
                font-size: 1.125rem; /* text-lg */
            }
        }
        
        @media (min-width: 640px) {
            .stat-card-value {
                font-size: 1.25rem; /* text-xl */
            }
        }
        
        @media (min-width: 768px) {
            .stat-card-value {
                font-size: 1.5rem; /* text-2xl */
            }
        }
        
        @media (min-width: 1024px) {
            .stat-card-value {
                font-size: 1.875rem; /* text-3xl on lg+ */
            }
        }
        .stat-card-value.text-green-600 { color: var(--accent-green); }
        .stat-card-value.text-red-600 { color: var(--accent-red); }
        .dark .stat-card-value.text-green-600 { color: #34d399; } /* Lighter green */
        .dark .stat-card-value.text-red-600 { color: #f87171; } /* Lighter red */
        
        /* Google Sign-In Button Styling */
        #googleSignInButton {
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #googleSignInButton > div {
            width: 100% !important;
        }
        
        /* Tooltip System - Fixed Version */
        .tooltip-trigger:hover + .tooltip-box {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .tooltip-box {
            pointer-events: none;
            white-space: normal;
            word-wrap: break-word;
        }
        
        /* Dark mode tooltip */
        .dark .tooltip-box {
            background-color: #1f2937 !important;
            color: #f9fafb !important;
        }
        
        .dark .tooltip-box .border-t-gray-900 {
            border-top-color: #1f2937 !important;
        }
        /* Tooltip styling */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: normal;
            z-index: 50;
            border: 1px solid var(--color-border);
            max-width: 300px;
            width: max-content;
        }
        
        /* Desktop only: Hide navigation tooltips when sidebar is expanded */
        @media (min-width: 1024px) {
            .trezor-sidebar:not(.collapsed) .nav-item:hover::after {
                display: none !important;
            }
        }

        .tab-button {
            position: relative;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab-button:hover {
            color: var(--text-primary);
        }
        .tab-button.active {
            color: var(--accent-primary);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-primary);
            border-radius: 1px;
        }

/* Clean Onboarding Styles */
.onboarding-modal {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    max-width: 600px;
    max-height: 85vh;
    overflow-y: auto;
}

.progress-bar {
    width: 100%;
    height: 4px;
    background-color: var(--color-bg-tertiary);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background-color: var(--color-primary);
    transition: width 0.5s ease;
}

.clean-goal-option:hover {
    border-color: var(--color-border-focus);
}

.clean-goal-option.selected {
    border-color: var(--color-primary);
    background-color: var(--color-bg-secondary);
}

.clean-debt-item {
    background-color: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.clean-summary-card {
    background-color: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.highlight-number {
    color: var(--color-primary);
    font-weight: 600;
}

        .modern-input, .modern-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-primary);
            transition: border-color 0.2s, background-color 0.3s, color 0.3s;
            appearance: none;
            line-height: 1.5;
        }
        .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem;
        }
        .dark .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .modern-input:focus, .modern-select:focus {
            outline: 2px solid var(--color-border-focus);
            outline-offset: 2px;
            border-color: var(--color-border-focus);
        }
        .modern-button {
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.875rem;
            min-height: 44px;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .modern-button-primary {
            background-color: var(--color-primary);
            color: white;
        }
        .modern-button-primary:hover {
            background-color: var(--color-primary-hover);
        }
        .modern-button-secondary {
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-primary);
        }
        .modern-button-secondary:hover {
            background-color: var(--color-border);
        }
        .modern-button-danger {
            background-color: var(--color-error);
            color: white;
        }
        .modern-button-danger:hover {
             background-color: var(--color-error);
             opacity: 0.9;
        }
        .modern-button-outline {
            background-color: transparent;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }
        .modern-button-outline:hover {
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-primary);
        }
        .icon-button {
            padding: 0.5rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        .icon-button:hover {
            color: var(--text-primary);
        }
        .icon-button svg {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        .dropdown-menu {
            position: absolute;
            margin-top: 0.5rem;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            z-index: 50;
            min-width: 220px; /* Wider for import/export */
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: background-color 0.2s ease, color 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .dropdown-item:hover {
            background-color: var(--bg-secondary);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        .dark .status-active {
             background-color: rgba(16, 185, 129, 0.2);
             color: #10b981;
        }
        .status-cancelled {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            text-decoration: line-through;
        }
         .dark .status-cancelled {
             background-color: rgba(239, 68, 68, 0.2);
             color: #ef4444;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: var(--color-text-primary);
            color: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            padding: 1rem;
            border-radius: var(--border-radius-sm);
            z-index: 100;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            position: relative; 
            height: 350px;
            width: 100%;
        }
        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 6px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-blue);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        /* Help Tab Contrast */
        #help-tab p, #help-tab li {
            color: var(--help-text-color);
            transition: color 0.3s;
        }
        #help-tab h3 {
             color: var(--text-primary);
             transition: color 0.3s;
        }
        #help-tab strong {
            color: var(--text-primary);
            transition: color 0.3s;
        }
        #help-tab ul {
            margin-left: 1rem;
        }
        /* Table Checkbox */
        .table-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        /* Budget Health Score */
        .health-score-container {
            position: relative;
            width: 150px;
            height: 75px; /* Half circle */
            overflow: hidden;
            margin: 1rem auto 0;
        }
        .health-score-gauge {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--bg-tertiary);
            border-bottom-color: transparent;
            border-left-color: transparent;
            transform: rotate(-135deg); /* Start from bottom-left */
            box-sizing: border-box;
        }
        .health-score-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--health-score-good); /* Default color */
            border-top-color: transparent;
            border-right-color: transparent;
            transform: rotate(45deg); /* Start from bottom-left, fill clockwise */
            transform-origin: center center;
            clip-path: polygon(50% 0%, 100% 0%, 100% 50%, 50% 50%); /* Clip to top-right quadrant initially */
            transition: transform 1s ease-out, border-color 0.5s ease;
            box-sizing: border-box;
        }
        .health-score-text {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            color: var(--text-primary);
        }
        .health-score-label {
            font-size: 0.875rem; /* text-sm */
            color: var(--text-secondary);
            margin-top: -5px;
        }
        /* Budget Insights Styling */
        .ai-insight {
            background: var(--color-bg-card) !important;
            border: 1px solid var(--color-border) !important;
            padding: 1rem;
            border-radius: 0.375rem;
            color: var(--color-text-secondary);
            font-size: 0.875rem;
        }
        .dark .ai-insight {
            background: var(--color-bg-card) !important;
            border: 1px solid var(--color-border) !important;
            color: var(--color-text-secondary);
        }
        .ai-insight strong {
            color: var(--color-text-primary);
            font-weight: 600;
        }
        /* Consistent Dark Mode */
        html.dark body { background-color: var(--bg-secondary); color: var(--text-primary); }
        html.dark .card { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .stat-card { background-color: var(--bg-tertiary); border-color: var(--border-color); }
        html.dark .modern-input, html.dark .modern-select { background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        html.dark .modern-button-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        html.dark .modern-button-secondary:hover { background-color: var(--border-color); }
        html.dark .tab-button { color: var(--text-secondary); }
        html.dark .tab-button:hover { color: var(--text-primary); }
        html.dark .tab-button.active { color: var(--accent-blue); }
        html.dark .icon-button { color: var(--text-secondary); }
        html.dark .icon-button:hover { color: var(--text-primary); }
        html.dark .dropdown-menu { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .dropdown-item { color: var(--text-primary); }
        html.dark .dropdown-item:hover { background-color: var(--bg-secondary); }
        html.dark table thead { background-color: var(--bg-tertiary); color: var(--text-secondary); }
        html.dark table tbody tr { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark table tbody tr:hover { background-color: var(--bg-secondary); }
        html.dark table tbody td { color: var(--text-secondary); }
        html.dark table tbody td:first-child { color: var(--text-primary); }
        html.dark #help-tab p, html.dark #help-tab li { color: var(--help-text-color); }
        html.dark #help-tab h3, html.dark #help-tab strong { color: var(--text-primary); }
        html.dark .health-score-gauge { border-color: var(--bg-tertiary); border-bottom-color: transparent; border-left-color: transparent; }
        html.dark .health-score-text { color: var(--text-primary); }
        html.dark .health-score-label { color: var(--text-secondary); }

        /* Driver.js Customization */
        .driver-popover {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* Match card radius */
        }
        .driver-popover-title {
            color: var(--text-primary);
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
        }
        .driver-popover-description {
            color: var(--text-secondary);
        }
        .driver-popover-progress-text {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn:hover {
            color: var(--text-primary);
        }
        .driver-popover-arrow-side-left.driver-popover-arrow {
            border-left-color: var(--border-color);
        }
        .driver-popover-arrow-side-right.driver-popover-arrow {
            border-right-color: var(--border-color);
        }
        .driver-popover-arrow-side-top.driver-popover-arrow {
            border-top-color: var(--border-color);
        }
        .driver-popover-arrow-side-bottom.driver-popover-arrow {
            border-bottom-color: var(--border-color);
        }
        .driver-popover-footer {
            gap: 0.5rem;
        }
        .driver-popover-next-btn, .driver-popover-prev-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
            cursor: pointer;
            text-shadow: none;
        }
        .driver-popover-next-btn {
            background-color: var(--accent-blue);
            color: white;
        }
        .driver-popover-next-btn:hover {
            background-color: #2563eb; /* Darker blue */
        }
        .driver-popover-prev-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .driver-popover-prev-btn:hover {
            background-color: var(--border-color);
        }

        /* Settings Modal Text Color Fix */
        #settings-modal .card h4,
        #settings-modal .card label {
            color: var(--text-primary);
        }

        /* Interactive Range Slider Styles */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--border-color);
            outline: none;
            border-radius: 5px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
        }

        .slider::-moz-range-track {
            height: 8px;
            background: var(--border-color);
            border-radius: 5px;
        }

        /* New Tooltip CSS */
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 320px;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            text-align: left;
            border-radius: 4px;
            padding: 16px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -160px;
            opacity: 0;
            transition: opacity 0.3s;

            font-size: 0.875rem;
            line-height: 1.5;
        }

        .dark .tooltip .tooltiptext {
            background-color: var(--color-bg-tertiary);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Arrow pointing down */
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--color-bg-primary) transparent transparent transparent;
        }

        .dark .tooltip .tooltiptext::after {
            border-color: var(--color-bg-tertiary) transparent transparent transparent;
        }

        /* Budget Insights v2 Styling */
        .ai-section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* 12px */
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* bold */
            margin-bottom: 1rem; /* 16px */
        }
        .prediction-card {
            background-color: var(--color-bg-tertiary);
            padding: 1rem; /* 16px */
            border-radius: 6px;
            border: 1px solid var(--color-border);
        }
        .confidence-meter {
            background-color: var(--color-border);
            border-radius: 2px;
            height: 0.5rem; /* 8px */
            overflow: hidden;
        }
        .confidence-fill {
            background-color: var(--color-primary);
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease-in-out;
        }
        .action-item {
            cursor: pointer;
            transition: border-color 0.2s ease-in-out;
        }
        .action-item:hover {
            border-color: var(--color-border-focus);
        }
        .metric-card {
            background-color: var(--color-bg-tertiary);
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--color-border);
        }
        .ai-loading {
            width: 24px;
            height: 24px;
            border: 3px solid var(--color-primary);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Bottom Nav Styling */
        .bottom-nav {
            background-color: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .bottom-nav-item {
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }
        .bottom-nav-item.active {
            color: var(--accent-primary);
        }
        
        /* New Mobile Card Styling */
        .mobile-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background-color: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            margin: 0 0 12px 0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        html.dark .mobile-card {
            background-color: var(--color-bg-tertiary);
        }
        .mobile-card:active {
            background-color: var(--color-bg-tertiary);
        }
        .mobile-card-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-bg-tertiary);
            font-size: 1.25rem;
        }
         html.dark .mobile-card-icon {
            background-color: var(--color-bg-secondary);
        }
        .mobile-card-main {
            flex: 1;
            min-width: 0;
        }
        .mobile-card-title {
            font-weight: 500;
            color: var(--color-text-primary);
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        .mobile-card-subtitle {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .mobile-card-amount {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        
        
        /* Modal z-index fixes */
        #goals-modal {
            z-index: 55 !important;
        }

        @media (max-width: 640px) {
          /* Hide table headers */
          table thead {
            position: absolute;
            top: -9999px;
            left: -9999px;
          }
          
          /* Date group headers - Revolut style */
          .mobile-date-header td {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0.75rem 1rem !important;
            color: var(--text-secondary) !important;
            font-size: 0.875rem !important;
            font-weight: 600 !important;
            border-bottom: 1px solid var(--border-color) !important;
            margin-bottom: 0.5rem !important;
            background: transparent !important;
            border-radius: 0 !important;
            box-shadow: none !important;
          }

          /* Checkbox styling */
          td:first-child {
            display: none !important;
          }
          
          td:first-child::before {
            content: '' !important;
          }

          /* Card layout */
          table, tbody, tr {
            display: block;
            width: 100%;
          }

          /* REVOLUT-STYLE TRANSACTION CARDS */
          tr:not(.mobile-date-header) {
            display: flex !important;
            align-items: center !important;
            background: var(--bg-primary) !important;
            border: 1px solid var(--border-color) !important;
            border-bottom: none !important;
            padding: 1rem !important;
            margin-bottom: 0 !important;
            gap: 0.75rem !important;
            transition: all 0.2s ease !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            min-height: 64px !important;
            cursor: pointer !important;
          }

          /* First card rounded top */
          tr:not(.mobile-date-header):first-of-type {
            border-radius: 0.75rem 0.75rem 0 0 !important;
          }

          /* Last card rounded bottom */
          tr:not(.mobile-date-header):last-of-type {
            border-radius: 0 0 0.75rem 0.75rem !important;
            border-bottom: 1px solid var(--border-color) !important;
          }

          /* Only card gets full rounded corners */
          tr:not(.mobile-date-header):only-of-type {
            border-radius: 0.75rem !important;
            border-bottom: 1px solid var(--border-color) !important;
          }

          .mobile-transaction-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 16px 8px;
            width: auto !important;
            min-width: fit-content !important;
            border: none !important;
          }
          .mobile-transaction-actions .icon-button {
            padding: 4px;
          }

          /* Hover and active states */
          tr:not(.mobile-date-header):hover {
            background: var(--color-bg-tertiary) !important;
          }

          tr:not(.mobile-date-header):active {
            background: var(--color-bg-tertiary) !important;
          }

          /* Transaction Icon - position as second visible element */
          td:nth-child(2) {
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            border-radius: 4px !important;
            background: linear-gradient(135deg, #6b7280, #4b5563) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            font-size: 1.25rem !important;
            color: white !important;
            border: none !important;
          }

          /* Category-based icon colors */
          tr[data-category="Food/Drink"] td:nth-child(2) {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
          }
          tr[data-category="Transport"] td:nth-child(2) {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
          }
          tr[data-category="Entertainment"] td:nth-child(2) {
            background: linear-gradient(135deg, #8b5cf6, #a855f7) !important;
          }
          tr[data-category="Housing"] td:nth-child(2) {
            background: linear-gradient(135deg, #10b981, #059669) !important;
          }
          tr[data-category="Subscriptions"] td:nth-child(2) {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
          }
          tr[data-category="Utilities"] td:nth-child(2) {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
          }
          tr[data-category="Shopping"] td:nth-child(2) {
            background: linear-gradient(135deg, #ec4899, #db2777) !important;
          }
          tr[data-category="Health"] td:nth-child(2) {
            background: linear-gradient(135deg, #06b6d4, #0891b2) !important;
          }

          /* Icon display using data attribute */
          td:nth-child(2)::after {
            content: attr(data-icon);
            font-size: 1.25rem;
            color: white;
          }

          /* Transaction details - Name field becomes flex container */
          td[data-label="Name"] {
            flex: 1 !important;
            min-width: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: flex-start !important;
            border: none !important;
          }

          /* Transaction name styling */
          td[data-label="Name"] > span {
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            font-size: 1rem !important;
            margin-bottom: 0.125rem !important;
            line-height: 1.2 !important;
            display: block !important;
            max-width: 100% !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
          }

          /* Transaction meta info */
          td[data-label="Name"]::after {
            font-size: 0.8125rem !important;
            color: var(--text-secondary) !important;
            display: block !important;
            margin-top: 0.125rem !important;
            line-height: 1.2 !important;
          }

          /* Generate meta info based on transaction type */
          td[data-label="Name"]:not([data-recurring="true"])::after {
            content: attr(data-category) " • " attr(data-time);
          }

          td[data-label="Name"][data-recurring="true"]::after {
            content: "🔁 Recurring • " attr(data-time);
          }

          /* Transaction amount */
          td[data-label="Amount"] {
            font-weight: 700 !important;
            font-size: 1.125rem !important;
            color: var(--text-primary) !important;
            text-align: right !important;
            padding: 0 !important;
            margin: 0 !important;
            margin-left: auto !important;
            flex-shrink: 0 !important;
            border: none !important;
            display: flex !important;
            align-items: center !important;
            line-height: 1 !important;
            white-space: nowrap !important;
            max-width: 30% !important;
          }

          /* Positive amounts (income) */
          td[data-label="Amount"][data-positive="true"] {
            color: var(--accent-green) !important;
          }

          /* Hide other desktop fields */
          td[data-label="Date"],
          td[data-label="Category"],
          td[data-label="Payment Method"],
          td[data-label="Type"],
          td[data-label="Actions"] {
            display: none !important;
          }

          /* Dark mode improvements */
          html.dark tr:not(.mobile-date-header) {
            background: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
          }

          html.dark tr:not(.mobile-date-header):hover {
            background: var(--color-bg-tertiary) !important;
          }

          html.dark .mobile-date-header td {
            color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
          }

          html.dark td[data-label="Name"] > span {
            color: var(--text-primary) !important;
          }

          html.dark td[data-label="Name"]::after {
            color: var(--text-secondary) !important;
          }

          html.dark td[data-label="Amount"] {
            color: var(--text-primary) !important;
          }

          html.dark td[data-label="Amount"][data-positive="true"] {
            color: var(--accent-green) !important;
          }

          /* Responsive adjustments for smaller screens */
          @media (max-width: 375px) {
            tr:not(.mobile-date-header) {
              padding: 0.875rem !important;
              gap: 0.625rem !important;
            }

            td:nth-child(2) {
              width: 36px !important;
              height: 36px !important;
              min-width: 36px !important;
              font-size: 1.125rem !important;
            }
            
            td[data-label="Name"] > span {
              font-size: 0.9375rem !important;
            }
            
            td[data-label="Amount"] {
              font-size: 1rem !important;
            }
          }

          /* Prevent horizontal overflow */
          .overflow-x-auto {
            overflow-x: hidden !important;
            width: 100%;
          }

          .card .overflow-x-auto {
            margin: -0.25rem;
            padding: 0.25rem;
          }
        }

        /* Landscape mode optimizations */
        @media screen and (orientation: landscape) and (max-height: 500px) {
          .app-header,
          header.card {
            padding: 0.75rem 1rem !important;
          }
          
          .app-header h1,
          header.card h1 {
            font-size: 1.5rem !important;
          }
          
          .bottom-nav {
            height: 56px !important;
          }
          
          .bottom-nav-item svg {
            width: 1.125rem !important;
            height: 1.125rem !important;
            margin-bottom: 0.125rem !important;
          }
          
          .bottom-nav-item span {
            font-size: 0.625rem !important;
          }
        }

        /* Safe area handling for notched devices */
        @supports (padding: max(0px)) {
          body {
            padding-bottom: max(5rem, env(safe-area-inset-bottom));
          }
          
          .bottom-nav {
            padding-bottom: max(0px, env(safe-area-inset-bottom));
          }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
          body {
            height: 100vh;
            height: -webkit-fill-available;
          }
          
          .min-h-screen {
            min-height: 100vh;
            min-height: -webkit-fill-available;
          }
        }

        /* Enhanced touch interactions */
        @media (hover: none) and (pointer: coarse) {
          .modern-button:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
          }
        }
        
        /* === Lens Mobile Card Layout END === */

        /* No-scroll CSS - Prevent horizontal scrolling */
        html,body{max-width:100%;overflow-x:hidden;}
        .table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%;}
        
        /* Enhanced Pagination Styling */
        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 1rem;
            margin: 0;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            border-radius: 0 0 0.75rem 0.75rem;
        }
        
        .pagination-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .pagination-info select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            min-width: 70px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .pagination-info select:focus {
            outline: 2px solid var(--color-border-focus);
            outline-offset: 2px;
            border-color: var(--color-border-focus);
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0;
        }
        
        .pagination-status {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }
        
        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .pagination-nav-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            min-height: 36px;
        }
        
        .pagination-nav-btn:hover:not(:disabled) {
            background-color: var(--bg-secondary);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .pagination-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--bg-tertiary);
        }
        
        .pagination-page-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 0.75rem;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            margin: 0 0.25rem;
        }
        
        .pagination-page-input {
            width: 3.5rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            text-align: center;
            font-weight: 600;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .pagination-page-input:focus {
            outline: 2px solid var(--color-border-focus);
            outline-offset: 2px;
            border-color: var(--color-border-focus);
            background-color: var(--color-surface);
        }
        
        .dark .pagination-page-input:focus {
            background-color: var(--color-bg-secondary);
        }
        
        .pagination-page-total {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Dark mode improvements */
        .dark .pagination-container {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
        }
        
        .dark .pagination-info select,
        .dark .pagination-nav-btn,
        .dark .pagination-page-input {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .dark .pagination-nav-btn:hover:not(:disabled) {
            background-color: var(--bg-secondary);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .dark .pagination-nav-btn:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-tertiary);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .pagination-controls {
                gap: 0.75rem;
            }
            
            .pagination-status {
                font-size: 0.8125rem;
            }
            
            .pagination-nav-btn {
                padding: 0.375rem 0.625rem;
                font-size: 0.8125rem;
                min-width: 32px;
                min-height: 32px;
            }
            
            .pagination-page-input {
                width: 3rem;
                padding: 0.375rem 0.5rem;
                font-size: 0.8125rem;
            }
            
            /* Hide redundant sidebar items on mobile when bottom nav is visible */
            /* These items are already in the bottom navigation, so no need to duplicate */
            #nav-overview,
            #nav-expenses, 
            #nav-recurring,
            #nav-insights,
            #nav-settings {
                display: none !important;
            }
            
            /* Keep Help visible as it's not in bottom nav */
            #nav-help {
                display: flex !important;
            }
            
            /* Hide the sidebar toggle button on mobile */
            .nav-item[title="Toggle sidebar"] {
                display: none !important;
            }
            
            /* Add some styling for the remaining help item */
            .sidebar-nav {
                padding-top: 2rem;
            }
            
            #nav-help {
                margin: 1rem;
                border-radius: 8px;
                background-color: rgba(59, 130, 246, 0.1);
                border: 1px solid rgba(59, 130, 246, 0.2);
            }
            
            #nav-help:hover {
                background-color: rgba(59, 130, 246, 0.15);
                border-color: rgba(59, 130, 246, 0.3);
            }
            
            /* Dark mode styling for Help button */
            .dark #nav-help {
                background-color: rgba(59, 130, 246, 0.2);
                border-color: rgba(59, 130, 246, 0.3);
            }
            
            .dark #nav-help:hover {
                background-color: rgba(59, 130, 246, 0.3);
                border-color: rgba(59, 130, 246, 0.4);
            }
        }
        
        /* ========== COMPREHENSIVE MOBILE LAYOUT FIXES ========== */
        @media (max-width: 768px) {
            /* Force all mobile styles to override */
            * {
                box-sizing: border-box !important;
            }
            /* CRITICAL FIX: Extend progress bars and projection components to full width */
            .progress-container,
            .projection-container,
            .budget-progress,
            .spending-projection,
            #budget-bar,
            .progress-bar,
            .budget-bar-container,
            .health-score-container {
                width: 100% !important;
                max-width: none !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                box-sizing: border-box !important;
            }
            
            /* Specific progress bar fixes */
            .budget-progress .bg-gray-200,
            .budget-progress .bg-blue-500,
            .budget-progress .bg-green-500 {
                width: 100% !important;
                border-radius: 2px !important;
            }
            
            /* CRITICAL FIX: Content spacing - prevent content from being too close to right edge */
            .dashboard-content,
            .tab-content,
            .card,
            .metric-card,
            .insights-grid,
            .trezor-content,
            .page-content {
                padding-left: 16px !important;
                padding-right: 16px !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                box-sizing: border-box !important;
            }
            
            /* Additional content containers */
            .grid,
            .flex,
            .space-y-6 {
                padding-left: 0 !important;
                padding-right: 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            /* Ensure cards have proper spacing */
            .card.p-4,
            .card.p-6 {
                margin-left: 0 !important;
                margin-right: 0 !important;
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            
            /* CRITICAL FIX: Bottom navigation positioning and spacing */
            .bottom-nav,
            .mobile-bottom-nav {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                padding: 12px 16px 8px !important;
                gap: 4px !important;
                background: var(--bg-primary) !important;
                border-top: 1px solid var(--border-color) !important;
                z-index: 50 !important;
                /* Add safe area padding for devices with home indicator */
                padding-bottom: max(8px, env(safe-area-inset-bottom)) !important;
            }
            
            .bottom-nav-item {
                flex: 1 !important;
                min-width: 0 !important;
                padding: 4px 2px !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                text-align: center !important;
            }
            
            .bottom-nav-icon {
                width: 20px !important;
                height: 20px !important;
                margin-bottom: 2px !important;
                flex-shrink: 0 !important;
            }
            
            .bottom-nav-text {
                font-size: 10px !important;
                line-height: 1.1 !important;
                margin-top: 2px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                max-width: 100% !important;
            }
            
            /* Ensure navigation items are properly spaced */
            .bottom-nav button,
            .mobile-bottom-nav button {
                min-height: 48px !important;
                padding: 4px !important;
                gap: 2px !important;
            }
            
            /* Center health score number in circular progress */
            .health-score-container {
                position: relative !important;
            }
            
            .health-score-number {
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                font-size: 14px !important;
                font-weight: 600 !important;
                z-index: 2 !important;
            }
            
            /* ========== ADDITIONAL CRITICAL MOBILE FIXES ========== */
            
            /* CRITICAL: Force progress bars to full width - Enhanced */
            .progress-container,
            .projection-container,
            .budget-progress,
            .spending-projection,
            .bg-blue-50,
            .chart-container,
            .insights-container,
            .seven-day-trend-chart {
                width: 100% !important;
                max-width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
                box-sizing: border-box !important;
            }
            
            /* ONLY target the progress bar BACKGROUND container */
            .w-full.bg-gray-200.rounded-full.h-4.border {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Target projection box specifically */
            .card .bg-blue-50,
            .card .rounded-lg,
            .card .border,
            .card .border-blue-100,
            .bg-blue-50.rounded-lg,
            .border.border-blue-100,
            /* Target any projection or insight containers */
            div[class*="bg-blue"],
            div[class*="border-blue"],
            .ai-insight-container,
            .projection-box {
                width: 100% !important;
                max-width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
                box-sizing: border-box !important;
            }
            
            /* 2. Better padding for right edge content */
            .trezor-content {
                padding-left: 16px !important;
                padding-right: 16px !important;
                max-width: 100vw !important;
                overflow-x: hidden !important;
            }
            
            /* CRITICAL: Budget Progress & Health card specific fixes */
            .card:has(.bg-blue-50),
            .card:has([id*="ai-insight"]),
            .card:has(.rounded-lg.border) {
                padding-left: 16px !important;
                padding-right: 16px !important;
            }
            
            /* CRITICAL: Fix Budget Progress bar layout to use full width */
            .card:has([class*="progress"]) .flex.justify-between,
            .card:has(.bg-gray-200) .flex.justify-between,
            .card .flex.justify-between.items-start {
                flex-direction: column !important;
                gap: 16px !important;
                align-items: stretch !important;
            }
            
            /* Make progress bar section use full width */
            .card .flex-1.mr-8,
            .card .flex-1 {
                margin-right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Ensure the progress bar container itself uses full width */
            .card .relative.w-full,
            .card .w-full.bg-gray-200.rounded-full.h-3 {
                width: 100% !important;
                max-width: 100% !important;
                margin: 8px 0 !important;
            }
            
            .card:has(.bg-blue-50) > *,
            .card:has([id*="ai-insight"]) > *,
            .card:has(.rounded-lg.border) > * {
                width: 100% !important;
                max-width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            /* Force any blue insight boxes to full width */
            [class*="bg-blue-50"],
            [class*="border-blue-100"],
            .ai-insight,
            .projection,
            #ai-insight,
            #ai-insight-status {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* 3. Enhanced bottom navigation */
            .mobile-bottom-nav {
                height: 60px !important;
                padding: 6px 8px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-around !important;
            }
            
            .mobile-nav-item {
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                gap: 2px !important;
                min-height: 48px !important;
                padding: 4px 2px !important;
            }
            
            .mobile-nav-icon {
                width: 18px !important;
                height: 18px !important;
            }
            
            .mobile-nav-text {
                font-size: 9px !important;
                line-height: 1.1 !important;
                font-weight: 500 !important;
            }
            
            /* 4. CRITICAL: Modal size and button visibility fixes */
            #modal,
            #recurring-modal {
                padding: 8px !important;
                max-height: calc(100vh - 60px) !important;
                align-items: flex-start !important;
                padding-top: 10px !important;
            }
            
            #modal > div,
            #recurring-modal > div {
                max-width: 90vw !important;
                width: 90vw !important;
                max-height: calc(100vh - 120px) !important;
                overflow-y: auto !important;
                margin: 0 auto !important;
                position: relative !important;
            }
            
            /* CRITICAL: Ensure modal content doesn't cut off buttons */
            .modal .card,
            #modal .card,
            #recurring-modal .card {
                max-height: calc(100vh - 140px) !important;
                overflow-y: auto !important;
                padding-bottom: 80px !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* CRITICAL: Fix button container positioning */
            .modal .flex.justify-between.p-4,
            .modal .flex.justify-center.p-4,
            .modal .space-x-3,
            #modal .flex.justify-between.p-4,
            #recurring-modal .flex.justify-between.p-4 {
                position: sticky !important;
                bottom: 0 !important;
                background: var(--bg-primary) !important;
                border-top: 1px solid var(--border-color) !important;
                margin: 0 !important;
                padding: 12px 16px !important;
                z-index: 100 !important;
                display: flex !important;
                justify-content: space-between !important;
                gap: 12px !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* 5. Button order fixes - Cancel left, Save right */
            .modal .flex.justify-between.p-4,
            .modal .flex.justify-center.p-4,
            .modal .space-x-3 {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                gap: 12px !important;
                padding: 16px !important;
            }
            
            .modern-button-primary {
                order: 2 !important;
                flex: 1 !important;
                max-width: 48% !important;
            }
            
            .modern-button-secondary {
                order: 1 !important;
                flex: 1 !important;
                max-width: 48% !important;
            }
            
            /* CRITICAL: Ensure all modal buttons are fully visible and accessible */
            .modal .modern-button,
            #modal .modern-button,
            #recurring-modal .modern-button,
            .modal button,
            #modal button,
            #recurring-modal button {
                min-height: 44px !important;
                font-size: 14px !important;
                padding: 12px 16px !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: static !important;
                z-index: 1000 !important;
                flex: 1 !important;
                max-width: 48% !important;
                border-radius: 4px !important;
                font-weight: 600 !important;
                text-align: center !important;
                cursor: pointer !important;
                border: none !important;
                outline: none !important;
            }
            
            /* Specific button styling */
            .modern-button-primary {
                background-color: #3b82f6 !important;
                color: white !important;
            }
            
            .modern-button-secondary {
                background-color: #6b7280 !important;
                color: white !important;
            }
            
            /* CRITICAL FIX: Prevent layout changes on horizontal orientation */
            @media (orientation: landscape) {
                /* Force same layout as portrait mode */
                .dashboard-content,
                .tab-content,
                .card,
                .metric-card,
                .trezor-content {
                    max-width: 100% !important;
                    width: 100% !important;
                    font-size: inherit !important;
                    line-height: inherit !important;
                    padding: inherit !important;
                    margin: inherit !important;
                }
                
                /* Keep navigation exactly the same */
                .bottom-nav,
                .mobile-bottom-nav {
                    position: fixed !important;
                    bottom: 0 !important;
                    padding: 12px 16px 8px !important;
                    gap: 4px !important;
                    height: auto !important;
                }
                
                /* Prevent modal size changes in landscape */
                #modal, #recurring-modal {
                    padding: 0.5rem !important;
                    align-items: flex-start !important;
                    padding-top: 2rem !important;
                }
                
                #modal > div, #recurring-modal > div {
                    max-height: 85vh !important;
                    width: 100% !important;
                    max-width: 28rem !important;
                }
                
                /* Maintain consistent text sizes */
                .bottom-nav-text {
                    font-size: 10px !important;
                }
                
                .bottom-nav-icon {
                    width: 20px !important;
                    height: 20px !important;
                }
            }
            
            /* CRITICAL FIX: Modal button accessibility and proper ordering */
            /* Ensure modal content doesn't overflow and buttons are always accessible */
            #modal, #recurring-modal {
                padding: 0.5rem !important;
                align-items: flex-start !important;
                padding-top: 2rem !important;
            }
            
            #modal > div, #recurring-modal > div {
                max-height: 85vh !important;
                overflow-y: auto !important;
                width: 100% !important;
                max-width: 28rem !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Modal content area should be scrollable */
            .modal-content {
                flex: 1 !important;
                overflow-y: auto !important;
                padding: 1rem !important;
            }
            
            /* Button container - always visible at bottom */
            .modal-footer {
                position: sticky !important;
                bottom: 0 !important;
                background: var(--bg-primary) !important;
                padding: 1rem !important;
                border-top: 1px solid var(--border-color) !important;
                display: flex !important;
                gap: 0.75rem !important;
                margin-top: auto !important;
                flex-shrink: 0 !important;
                /* BUTTON ORDER FIX: Cancel left, Save right */
                flex-direction: row !important;
            }
            
            /* Button order fix: Cancel button first (left), Save button second (right) */
            .modal-footer button:first-child {
                order: 1 !important; /* Cancel button */
            }
            
            .modal-footer button:last-child {
                order: 2 !important; /* Save button */
            }
            
            .modal-footer button {
                flex: 1 !important;
                padding: 0.75rem 1rem !important;
                min-height: 44px !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: static !important;
                z-index: 1000 !important;
            }
            
            /* FAB Modal size reduction for better button accessibility */
            .fab-menu {
                max-height: 70vh !important;
                padding-bottom: calc(env(safe-area-inset-bottom) + 1rem) !important;
            }
            
            .fab-menu .modal-footer {
                padding: 1rem !important;
                gap: 0.75rem !important;
            }
            
            .fab-action-button {
                padding: 12px 16px !important;
                min-height: 48px !important;
            }
            
            /* Hide Add Income section, Quick Add, and Quick Actions on mobile dashboard */
            .dashboard-content:has(.add-income-section),
            .dashboard-content:has(.quick-add-component),
            .dashboard-content:has(.quick-actions-section) {
                display: none !important;
            }
            
            /* Alternative selectors for hiding components */
            .add-income-section,
            .quick-add-component,
            .quick-actions-section,
            .dashboard-content > div:has(h3:contains("Add Income")),
            .dashboard-content > div:has(h3:contains("Quick Add")),
            .dashboard-content > div:has(h3:contains("Quick Actions")) {
                display: none !important;
            }
            
            /* More specific selectors for hiding components */
            .dashboard-content > div:nth-child(2),
            .dashboard-content > div:nth-child(3),
            .dashboard-content > div:nth-child(4) {
                display: none !important;
            }
            
            /* Additional mobile-specific overrides */
            .mobile-fab {
                width: 48px !important;
                height: 48px !important;
                bottom: 85px !important;
                right: 20px !important;
            }
            
            .mobile-fab svg {
                width: 20px !important;
                height: 20px !important;
            }
            
            /* Ensure health score is centered */
            .health-score-container {
                position: relative !important;
            }
            
            .health-score-number {
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                font-size: 14px !important;
                font-weight: 600 !important;
                z-index: 2 !important;
            }
        }
        
        /* Additional mobile breakpoint for smaller screens */
        @media (max-width: 640px) {
            .mobile-fab {
                width: 44px !important;
                height: 44px !important;
                bottom: 80px !important;
                right: 16px !important;
            }
            
            .mobile-fab svg {
                width: 18px !important;
                height: 18px !important;
            }
        }
        
        /* Enhanced Insights CSS */
        .card {
            background: var(--color-surface);
            border-radius: 6px;
            border: 1px solid var(--color-border);
        }
        .metric-card {
            background: var(--color-primary);
            color: white;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .metric-card:hover {
            background: var(--color-primary-hover);
        }
        .spending-indicator {
            height: 8px;
            border-radius: 2px;
            margin: 0.5rem 0;
        }
        .over-budget {
            background: var(--color-error);
        }
        .under-budget {
            background: var(--color-success);
        }
        .at-budget {
            background: var(--color-warning);
        }
        .alert-card {
            background: var(--color-bg-secondary);
            border-left: 4px solid var(--color-warning);
        }
        .success-card {
            background: var(--color-bg-secondary);
            border-left: 4px solid var(--color-success);
        }
        .warning-card {
            background: var(--color-bg-secondary);
            border-left: 4px solid var(--color-error);
        }
        .toggle-button {
            transition: background-color 0.3s ease;
        }
        .toggle-button.active {
            background: var(--color-primary);
            color: white;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .category-bar {
            height: 6px;
            border-radius: 2px;
            background: var(--color-primary);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Help Accordion Styling */
        .help-accordion {
            max-width: 100%;
        }

        .help-section {
            background: var(--color-bg);
            border: none !important;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .help-section-header {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--color-bg);
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-text-primary);
            transition: background-color 0.2s ease;
            text-align: left;
        }

        .help-section-header:hover {
            background: var(--color-bg-card);
        }

        .help-section-title {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-toggle {
            font-size: 1.2rem;
            transition: transform 0.2s ease;
            color: var(--color-text-secondary);
            font-family: monospace;
        }

        .help-section-content {
            padding: 0 1.5rem 1.5rem 1.5rem;
            background: var(--color-bg);
            border: none !important;
        }

        .help-section-content.hidden {
            display: none;
        }

        .help-component {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border: none !important;
        }

        .help-component:last-child {
            margin-bottom: 0;
        }

        .help-component-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-component-description {
            color: var(--color-text-secondary);
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .help-component-steps {
            background: var(--color-bg-card);
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            border: none !important;
        }

        .help-component-tips {
            background: var(--color-bg-card);
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            border: none !important;
        }

        .help-component-steps h5,
        .help-component-tips h5 {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--color-text-primary);
        }

        .help-component-steps ol,
        .help-component-tips ul {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .help-component-steps li,
        .help-component-tips li {
            margin-bottom: 0.25rem;
        }

        /* Dark mode adjustments - removed since using consistent background colors */
        
        /* Text utility classes for proper contrast */
        .text-secondary {
            color: var(--color-text-secondary) !important;
        }
        
        .text-muted {
            color: var(--color-text-tertiary) !important;
        }

/* CSS Color Variables */
:root {
  --color-bg: #F7F7F8;
  --color-bg-card: #FFFFFF;
  --color-border: #E5E7EB;
  --color-text-primary: #222;
  --color-text-secondary: #666;
  --color-accent: #4F8CFF;
  --color-success: #2ECC40;
  --color-error: #FF4D4F;
  --color-warning: #FFB020;
  --color-font: 'Inter', system-ui, sans-serif;
}
.dark {
  --color-bg: #181A1B;
  --color-bg-card: #232526;
  --color-border: #23272A;
  --color-text-primary: #F7F7F8;
  --color-text-secondary: #D4D4D8;
  --color-accent: #4F8CFF;
  --color-success: #2ECC40;
  --color-error: #FF4D4F;
  --color-warning: #FFB020;
  --color-font: 'Inter', system-ui, sans-serif;
}
body {
  background: var(--color-bg) !important;
  color: var(--color-text-primary);
  font-family: var(--color-font);
}
.trezor-app {
  background: var(--color-bg) !important;
}
.card, .trezor-card, .stat-card, .bg-white, .rounded-xl, .p-6, .p-4 {
  background: var(--color-bg-card) !important;
  border: 1px solid var(--color-border) !important;
  color: var(--color-text-primary) !important;
  border-radius: 12px !important;
  box-shadow: none !important;
}
.sidebar-header, .trezor-sidebar {
  background: var(--color-bg) !important;
  color: var(--color-text-primary);
}
.trezor-main, .trezor-content {
  background: var(--color-bg) !important;
}
.trezor-header {
  background: var(--color-bg) !important;
}
.nav-item, .sidebar-nav button {
  background: transparent !important;
  color: var(--color-text-secondary) !important;
  border: none !important;
  font-family: var(--color-font);
}
.nav-item.active, .sidebar-nav button.active {
  background: var(--color-bg-card) !important;
  color: var(--color-accent) !important;
  font-weight: 600;
}
button, .modern-button {
  font-family: var(--color-font);
  background: var(--color-accent);
  color: #fff;
  border-radius: 8px;
  border: none;
  transition: background 0.2s;
}
button.secondary, .modern-button.secondary {
  background: transparent;
  color: var(--color-accent);
  border: 1px solid var(--color-accent);
}
button.danger {
  background: var(--color-error);
  color: #fff;
}
input, select, textarea {
  background: var(--color-bg-card);
  color: var(--color-text-primary);
  border: 1px solid var(--color-border);
  font-family: var(--color-font);
}
h1, h2, h3, h4, h5, h6 {
  color: var(--color-text-primary);
  font-family: var(--color-font);
  font-weight: 600;
}
.text-accent, a, .text-blue-600, .text-blue-400, .text-blue-500, .text-blue-700 {
  color: var(--color-accent) !important;
}
.text-success, .text-green-600, .text-green-400 {
  color: var(--color-success) !important;
}
.text-error, .text-red-600, .text-red-400 {
  color: var(--color-error) !important;
}
.text-warning, .text-yellow-600, .text-yellow-400 {
  color: var(--color-warning) !important;
}
/* Remove all background color pops and gradients */
.bg-blue-50, .bg-blue-900, .bg-red-50, .bg-red-900, .bg-green-50, .bg-green-900, .bg-purple-50, .bg-purple-900, .bg-orange-50, .bg-orange-900, .bg-indigo-500, .bg-sky-500, .bg-gray-200, .bg-gray-700, .bg-gray-800, .bg-gray-50, .bg-gray-600, .bg-gray-400, .bg-gray-300, .bg-gray-100, .bg-gradient-to-r, .from-blue-500, .to-purple-600, .from-green-500, .to-teal-600, .from-purple-500, .to-indigo-600 {
  background: var(--color-bg-card) !important;
  color: var(--color-text-primary) !important;
}
/* Chart and legend backgrounds */
#daily-spending-insights-chart, #category-donut-chart {
  background: var(--color-bg-card) !important;
}
/* Chart legends text color fix */
.chart-legend, .chart-legend .legend-item {
  color: var(--color-text-primary) !important;
}
/* Remove all colored borders except semantic */
.border-blue-200, .border-blue-800, .border-red-200, .border-red-800, .border-green-200, .border-green-800, .border-purple-200, .border-purple-800, .border-orange-200, .border-orange-700, .border-gray-200, .border-gray-700 {
  border-color: var(--color-border) !important;
}
/* Status cards */
.success-card {
  border-left: 4px solid var(--color-success) !important;
}
.warning-card {
  border-left: 4px solid var(--color-warning) !important;
}
.error-card {
  border-left: 4px solid var(--color-error) !important;
}
/* Remove all text color pops except semantic */
.text-purple-600, .text-purple-400, .text-indigo-500, .text-sky-500, .text-orange-600, .text-orange-400 {
  color: var(--color-text-primary) !important;
}
/* Remove all box shadows for minimal look */
.shadow, .shadow-sm, .shadow-lg, .hover\:shadow-lg {
  box-shadow: none !important;
}
/* Insights page consistency */
#insights-tab, #insights-tab .card, #insights-tab .max-w-6xl {
  background: var(--color-bg) !important;
}
#insights-tab .ai-insight {
  background: var(--color-bg-card) !important;
  border: 1px solid var(--color-border) !important;
}
/* Misc */
::-webkit-input-placeholder { color: var(--color-text-secondary); }
::-moz-placeholder { color: var(--color-text-secondary); }
:-ms-input-placeholder { color: var(--color-text-secondary); }
::placeholder { color: var(--color-text-secondary); }

/* REDUCE ROUNDED CORNERS - MINIMAL DESIGN */
.card, .trezor-card, .stat-card, .modern-button, .modern-input, .modern-select {
  border-radius: 4px !important;
}
.rounded-lg, .rounded-xl, .rounded-2xl, .rounded-3xl {
  border-radius: 4px !important;
}
.rounded-full {
  border-radius: 4px !important;
}
.rounded, .rounded-md {
  border-radius: 3px !important;
}
.rounded-sm {
  border-radius: 2px !important;
}
/* Progress bars and small elements */
#budget-bar, .bg-gray-200, .bg-gray-700, .h-6, .h-3, .h-1\.5 {
  border-radius: 2px !important;
}
/* Buttons and interactive elements */
button, .btn, input[type="button"], input[type="submit"] {
  border-radius: 3px !important;
}
/* Modal and overlay elements */
.modal, .overlay, .tooltip, .tooltiptext {
  border-radius: 4px !important;
}

/* Health score tooltip positioning */
#health-score-tooltip{
  bottom:auto !important;
  top:110% !important;
}

/* Added by ChatGPT 2025-06-22 */
#commitment-buttons .modern-button {
    white-space: normal;
    line-height: 1.25rem;
    padding-block: .75rem;
    text-align: left;
    min-height: 64px;
}
#goal-confirmation-overlay {
    position: fixed !important;
}

/* Daily Coaching Badge Styles */
.daily-coaching-badge {
    background: var(--color-success);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 600;
    display: inline-block;
    margin: 0.5rem 0;
}

.daily-coaching-badge.warning {
    background: var(--color-error);
}

.daily-coaching-badge.alert {
    background: var(--color-warning);
}

/* Modal Fix Styles - Ensure proper overlay behavior */
.fade-in {
    animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Force proper modal overlay behavior */
#modal, #recurring-modal {
    background-color: rgba(0, 0, 0, 0.5) !important;
    backdrop-filter: blur(1px);
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    z-index: 50 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0.5rem !important;
}

/* Allow modals to be hidden when hidden class is applied */
#modal.hidden, #recurring-modal.hidden {
    display: none !important;
}

/* Ensure modal content is properly centered */
#modal > div, #recurring-modal > div {
    max-width: 28rem;
    width: 100%;
    margin: 0 auto;
}

/* Ensure dashboard content is visible behind modal */
.trezor-app, .trezor-main, .trezor-content {
    position: relative;
    z-index: 1;
}

/* ========== MOBILE FAB IMPLEMENTATION ========== */
        /* Professional FAB that preserves all existing functionality */
        
        /* Hide FAB on desktop */
        @media (min-width: 641px) {
            .mobile-fab {
                display: none !important;
            }
        }
        
        /* FAB Button - matches existing design system */
        .mobile-fab {
            position: fixed;
            bottom: 85px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: var(--accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
            cursor: pointer;
            z-index: 900;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            color: white;
        }
        
        .mobile-fab:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.3);
        }
        
        .mobile-fab svg {
            width: 20px;
            height: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .mobile-fab.active svg {
            transform: rotate(45deg);
        }
        
        /* FAB Menu Overlay */
        .fab-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 899;
        }
        
        .fab-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* FAB Menu Container */
        .fab-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 901;
            max-height: 70vh;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .fab-menu.active {
            transform: translateY(0);
        }
        
        /* Menu Handle */
        .fab-menu-handle {
            width: 36px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 12px auto 20px;
        }
        
        /* Quick Actions Section */
        .fab-quick-actions {
            padding: 0 16px 16px;
        }
        
        .fab-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            padding: 0 4px;
        }
        
        .fab-quick-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .fab-quick-item {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .fab-quick-item:active {
            transform: scale(0.98);
            background: var(--bg-secondary);
        }
        
        .fab-quick-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .fab-quick-item:active::before {
            width: 200px;
            height: 200px;
        }
        
        .fab-quick-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .fab-quick-icon.coffee {
            background: rgba(254, 243, 199, 0.5);
        }
        
        .fab-quick-icon.lunch {
            background: rgba(209, 250, 229, 0.5);
        }
        
        .fab-quick-icon.transport {
            background: rgba(219, 234, 254, 0.5);
        }
        
        .fab-quick-icon.groceries {
            background: rgba(233, 213, 255, 0.5);
        }
        
        .fab-quick-content {
            flex: 1;
            min-width: 0;
        }
        
        .fab-quick-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .fab-quick-category {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .fab-quick-amount {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Main Actions */
        .fab-main-actions {
            padding: 0 16px 24px;
        }
        
        .fab-action-button {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .fab-action-button:active {
            transform: scale(0.98);
        }
        
        .fab-action-button.primary {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .fab-action-button.primary:active {
            background: var(--accent-primary-hover);
        }
        
        .fab-action-icon {
            width: 20px;
            height: 20px;
        }
        
        /* Hide desktop add buttons on mobile without breaking existing functionality */
        @media (max-width: 640px) {
            /* Preserve header buttons (theme toggle, burger menu, upgrade) */
            /* Only hide add/quick action buttons */
            .header-actions button[onclick*="showExpenseForm"],
            .header-actions button[onclick*="showAddForm"],
            .page-header button[onclick*="add"]:not(#theme-toggle-btn):not(#mobile-menu-toggle),
            .tab-content button[onclick*="add"]:not(.mobile-fab),
            button.add-expense-btn:not(.mobile-fab),
            button.add-income-btn:not(.mobile-fab),
            button.add-recurring-btn:not(.mobile-fab),
            .desktop-add-button,
            /* Hide desktop quick actions but preserve navigation */
            button:has(svg path[d*="M12 4v16m8-8H4"]):not(.mobile-fab):not(#mobile-menu-toggle):not(#theme-toggle-btn) {
                display: none !important;
            }
        }
    </style>

</head>
<body class="antialiased">
    <div class="trezor-app">
        <!-- Trezor Suite Sidebar -->
        <div class="trezor-sidebar" id="trezor-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="8" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" fill="none"/>
                        <circle cx="12" cy="12" r="5" stroke="rgba(255,255,255,0.6)" stroke-width="1" fill="none"/>
                        <circle cx="12" cy="12" r="2.5" stroke="rgba(255,255,255,0.8)" stroke-width="1" fill="none"/>
                    </svg>
                </div>
                <div class="sidebar-brand">Lens</div>
            </div>
            
            <nav class="sidebar-nav">
                <button onclick="toggleSidebar()" class="nav-item" title="Toggle sidebar">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                    </svg>
                </button>
                
                <button onclick="showTab('overview')" id="nav-overview" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    <span class="nav-text">Dashboard</span>
                </button>
                
                <button onclick="showTab('expenses')" id="nav-expenses" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zM14 6a2 2 0 012 2v4a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2h8zM6 8a2 2 0 000 4h8a2 2 0 000-4H6z"/>
                        <path d="M1 11a1 1 0 011-1h2a1 1 0 010 2H2a1 1 0 01-1-1zM13 11a1 1 0 011-1h2a1 1 0 010 2h-2a1 1 0 01-1-1z"/>
                    </svg>
                    <span class="nav-text">Expenses</span>
                </button>
                
                <button onclick="showTab('recurring')" id="nav-recurring" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                    </svg>
                    <span class="nav-text">Recurring</span>
                </button>
                
                <button onclick="showTab('insights')" id="nav-insights" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    <span class="nav-text">Insights</span>
                </button>
                
                <button onclick="showTab('settings')" id="nav-settings" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                    </svg>
                    <span class="nav-text">Settings</span>
                </button>
                
                <button onclick="showTab('help')" id="nav-help" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                    </svg>
                    <span class="nav-text">Help</span>
                </button>
            </nav>
        </div>
        
        <!-- Main Content Area -->
        <div class="trezor-main">
            <header class="trezor-header">
                <h1 class="page-title" id="current-page-title">Dashboard</h1>
                <div class="header-actions">
                    <button onclick="toggleThemeFromHeader()" class="btn-icon" title="Toggle theme" id="theme-toggle-btn">
                        <!-- Sun icon (light mode) -->
                        <svg class="w-5 h-5 theme-icon theme-icon-light" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                        </svg>
                        <!-- Moon icon (dark mode) -->
                        <svg class="w-5 h-5 theme-icon theme-icon-dark hidden" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                        </svg>
                    </button>
                    
                    <div class="md:hidden relative">
                        <button id="mobile-menu-toggle" onclick="toggleMobileDropdown()" class="btn-icon">
                            <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        
                        <!-- Mobile Dropdown Menu -->
                        <div id="mobile-dropdown" class="mobile-dropdown hidden">
                            <button onclick="showTab('settings'); closeMobileDropdown();" class="mobile-dropdown-item">
                                <svg class="w-4 h-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.925 2.732a1 1 0 00-1.85 0l-.638 1.538a1 1 0 01-.754.54l-1.706.27a1 1 0 00-.656 1.614l1.13 1.428a1 1 0 010 1.156l-1.13 1.428a1 1 0 00.656 1.614l1.706.27a1 1 0 01.754.54l.638 1.538a1 1 0 001.85 0l.638-1.538a1 1 0 01.754-.54l1.706-.27a1 1 0 00.656-1.614l-1.13-1.428a1 1 0 010-1.156l1.13-1.428a1 1 0 00-.656-1.614l-1.706-.27a1 1 0 01-.754-.54L10.925 2.732z"/>
                                    <circle cx="10" cy="10" r="3"/>
                                </svg>
                                <span>Settings</span>
                            </button>
                            <button onclick="showTab('help'); closeMobileDropdown();" class="mobile-dropdown-item">
                                <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                </svg>
                                <span>Help</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Subscription Status Badge -->
                    <div id="subscription-badge" class="hidden">
                        <!-- Will be populated by subscription manager -->
                    </div>
                </div>
            </header>
            
            <div class="trezor-content" id="trezor-content">
                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content fade-in">
                    <!-- 1. TOP SECTION - Income (Modified per requirements) -->
                    <div class="card p-4 mb-4">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h2 class="text-2xl font-bold">Total Monthly Income</h2>
                                    <div class="relative group">
                                        <svg class="w-5 h-5 text-gray-500 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <div class="absolute left-1/2 transform -translate-x-1/2 top-8 bg-gray-900 dark:bg-gray-700 text-white text-xs rounded-lg px-3 py-2 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                            <div id="income-breakdown-tooltip">
                                                <!-- Dynamic content goes here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-4xl font-bold mb-2" id="total-monthly-income">£0.00</div>
                                <div class="text-gray-600 font-medium" id="savings-rate-display">💰 Savings Rate: 25%</div>
                            </div>
                            <div class="flex-shrink-0">
                                <button onclick="showAddIncomeForm()" class="btn-primary">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Add Income
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 2. STATS ROW (4 cards exactly as shown) -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4 stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-title">Monthly Budget</div>
                            <div class="stat-card-value text-blue-600" id="monthly-budget">£0.00</div>
                            <div class="text-xs text-green-600 mt-1" id="budget-change-indicator">+2.3%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-title">Spent This Month</div>
                            <div class="stat-card-value text-red-600" id="total-expenses">£0.00</div>
                            <div class="text-xs text-red-600 mt-1" id="spent-change-indicator">+15%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-title">Budget Remaining</div>
                            <div class="stat-card-value text-green-600" id="remaining-amount">£0.00</div>
                            <div class="text-xs text-gray-600 mt-1" id="remaining-change-indicator">-5%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-title">Monthly Savings</div>
                            <div class="stat-card-value" id="monthly-savings">£0.00</div>
                        </div>
                    </div>

                    <!-- 2.5. QUICK ADD BUTTONS -->
                    <div class="card p-4 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Quick Add</h3>
                            <span class="text-sm text-gray-500">Add common expenses instantly</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 quick-add-grid">
                            <div id="quick-add-coffee" class="quick-add-wrapper">
                                <button class="w-full bg-gray-50 hover:bg-blue-50 dark:bg-gray-700 dark:hover:bg-blue-900/20 border border-gray-200 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-700 rounded-lg p-3 text-left transition-all duration-200 group hover:shadow-sm quick-add-button" onclick="quickAddExpense('Coffee', 5.00, 'Food/Drink')">
                                    <div class="flex items-center gap-3 quick-add-content">
                                        <div class="w-10 h-10 bg-amber-500 group-hover:bg-amber-600 rounded-lg flex items-center justify-center text-white transition-colors duration-200 quick-add-icon">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M17 8h1a4 4 0 0 1 0 8h-1"/>
                                                <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8z"/>
                                                <path d="M7 4v2"/>
                                                <path d="M10 4v2"/>
                                                <path d="M13 4v2"/>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-gray-900 dark:text-gray-100 quick-add-title">Coffee</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400 quick-add-category">Food/Drink</div>
                                        </div>
                                        <span class="font-medium text-amber-600 dark:text-amber-400 quick-add-price">£5</span>
                                    </div>
                                </button>
                            </div>
                            <div id="quick-add-transport" class="quick-add-wrapper">
                                <button class="w-full bg-gray-50 hover:bg-blue-50 dark:bg-gray-700 dark:hover:bg-blue-900/20 border border-gray-200 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-700 rounded-lg p-3 text-left transition-all duration-200 group hover:shadow-sm quick-add-button" onclick="quickAddExpense('Transport', 10.00, 'Essential')">
                                    <div class="flex items-center gap-3 quick-add-content">
                                        <div class="w-10 h-10 bg-blue-500 group-hover:bg-blue-600 rounded-lg flex items-center justify-center text-white transition-colors duration-200 quick-add-icon">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.22.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-gray-900 dark:text-gray-100 quick-add-title">Transport</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400 quick-add-category">Essential</div>
                                        </div>
                                        <span class="font-medium text-blue-600 dark:text-blue-400 quick-add-price">£10</span>
                                    </div>
                                </button>
                            </div>
                            <div id="quick-add-lunch" class="quick-add-wrapper">
                                <button class="w-full bg-gray-50 hover:bg-blue-50 dark:bg-gray-700 dark:hover:bg-blue-900/20 border border-gray-200 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-700 rounded-lg p-3 text-left transition-all duration-200 group hover:shadow-sm quick-add-button" onclick="quickAddExpense('Lunch', 15.00, 'Food/Drink')">
                                    <div class="flex items-center gap-3 quick-add-content">
                                        <div class="w-10 h-10 bg-green-500 group-hover:bg-green-600 rounded-lg flex items-center justify-center text-white transition-colors duration-200 quick-add-icon">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8.1 13.34l2.83-2.83L3.91 3.5a4.008 4.008 0 0 0 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.20-1.10-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z"/>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-gray-900 dark:text-gray-100 quick-add-title">Lunch</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400 quick-add-category">Food/Drink</div>
                                        </div>
                                        <span class="font-medium text-green-600 dark:text-green-400 quick-add-price">£15</span>
                                    </div>
                                </button>
                            </div>
                            <div id="quick-add-groceries" class="quick-add-wrapper">
                                <button class="w-full bg-gray-50 hover:bg-blue-50 dark:bg-gray-700 dark:hover:bg-blue-900/20 border border-gray-200 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-700 rounded-lg p-3 text-left transition-all duration-200 group hover:shadow-sm quick-add-button" onclick="quickAddExpense('Groceries', 50.00, 'Essential')">
                                    <div class="flex items-center gap-3 quick-add-content">
                                        <div class="w-10 h-10 bg-purple-500 group-hover:bg-purple-600 rounded-lg flex items-center justify-center text-white transition-colors duration-200 quick-add-icon">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-gray-900 dark:text-gray-100 quick-add-title">Groceries</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400 quick-add-category">Essential</div>
                                        </div>
                                        <span class="font-medium text-purple-600 dark:text-purple-400 quick-add-price">£50</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 3. MAIN CONTENT ROW (2 columns exactly as shown) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-4">
                        <!-- LEFT COLUMN (wider - 2/3 width) -->
                        <div class="lg:col-span-2 space-y-6">
                                                        <!-- Budget Progress & Health -->
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-6">
                                    <div class="flex items-center gap-2">
                                        <h3 class="text-xl font-semibold">Budget Progress & Health</h3>
                                        <div class="relative">
                                            <svg class="w-5 h-5 text-gray-500 cursor-pointer hover:text-gray-700 dark:hover:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" onclick="toggleBudgetHealthTooltip()">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <div id="budget-health-tooltip-container" class="absolute left-1/2 transform -translate-x-1/2 top-8 bg-gray-900 dark:bg-gray-700 text-white text-xs rounded-lg px-3 py-2 opacity-0 transition-opacity whitespace-nowrap z-10 pointer-events-none">
                                                <div id="budget-health-tooltip">
                                                    <strong>Budget Health Score (0-100)</strong><br>
                                                    Based on spending habits, budget adherence,<br>
                                                    savings rate, and consistency over time.<br><br>
                                                    <strong>Projection Calculation:</strong><br>
                                                    • Current spending: <span id="tooltip-current-spend">£0</span><br>
                                                    • Daily average: <span id="tooltip-daily-avg">£0</span><br>
                                                    • Projected total: <span id="tooltip-projected">£0</span><br>
                                                    • Monthly budget: <span id="tooltip-budget">£0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="text-sm text-blue-600 hover:underline" onclick="showTab('settings')">
                                        Edit budget
                                    </button>
                                </div>
                                
                                <div class="flex justify-between items-start">
                                    <!-- Left side: Progress section -->
                                    <div class="flex-1 mr-8">
                                        <!-- Top row: Used % and Days left -->
                                        <div class="flex justify-between items-center mb-3">
                                            <span class="text-lg font-medium" id="budget-progress-used">0% Used</span>
                                            <span class="text-sm text-gray-500" id="days-remaining">-- days left</span>
                                        </div>
                                        
                                        <!-- Progress bar with labels -->
                                        <div class="w-full mb-4">
                                            <!-- Progress bar container with border -->
                                            <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-4 border border-gray-300 dark:border-gray-500 relative overflow-hidden">
                                                <div id="budget-progress-bar" class="bg-green-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                                                <!-- Optional: Add tick marks -->
                                                <div class="absolute top-0 left-1/4 w-px h-full bg-gray-400 opacity-30"></div>
                                                <div class="absolute top-0 left-1/2 w-px h-full bg-gray-400 opacity-50"></div>
                                                <div class="absolute top-0 left-3/4 w-px h-full bg-gray-400 opacity-30"></div>
                                            </div>
                                            <!-- Progress bar labels -->
                                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                <span>£0</span>
                                                <span class="text-center">50%</span>
                                                <span id="budget-limit-label">£0</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Income percentage -->
                                        <div class="mb-4">
                                            <span class="text-sm text-gray-500" id="budget-income-percentage">0% of total income</span>
                                        </div>
                                        
                                        <!-- Budget insight box -->
                                        <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm" id="ai-insight">📈 Projection: Set up your budget to get insights</span>
                                            </div>
                                            <div class="text-xs text-gray-600 mt-1" id="ai-insight-status">No data</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right side: Circular health score -->
                                    <div class="text-center">
                                        <div class="relative w-20 h-20">
                                            <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                                                <!-- Background circle -->
                                                <circle cx="50" cy="50" r="45" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                                                <!-- Progress circle -->
                                                <circle cx="50" cy="50" r="45" stroke="#f97316" stroke-width="8" fill="none"
                                                        stroke-dasharray="283" id="health-progress-circle"
                                                        stroke-dashoffset="81" stroke-linecap="round"/>
                                            </svg>
                                            <!-- Score text in center -->
                                            <div class="absolute inset-0 flex items-center justify-center">
                                                <span class="text-xl font-bold" id="health-score-display">--</span>
                                            </div>
                                            <!-- Info icon positioned at top right of circle -->
                                            <div class="absolute -top-1 -right-1">
                                                <svg class="w-4 h-4 text-gray-400 cursor-pointer hover:text-gray-600 dark:hover:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" onclick="toggleHealthScoreTooltip()">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            </div>
                                            <!-- Health Score Tooltip positioned near the circle -->
                                            <div id="health-score-tooltip-container" class="absolute left-1/2 transform -translate-x-1/2 top-full mt-2 bg-gray-900 dark:bg-gray-700 text-white text-xs rounded-lg px-3 py-2 opacity-0 transition-opacity whitespace-nowrap z-10 pointer-events-none w-64">
                                                <div id="health-score-tooltip">
                                                    <strong>Health Score Components:</strong><br>
                                                    • Budget usage & spending pace<br>
                                                    • Savings rate & goal progress<br>
                                                    • Spending consistency<br>
                                                    • Emergency fund status<br><br>
                                                    Higher scores = better financial health
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1" id="health-score-status">No data</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 7-Day Trend -->
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-semibold">7-Day Trend</h3>
                                    <button class="text-sm text-blue-600 hover:underline" onclick="showTab('insights')">
                                        Full Chart
                                    </button>
                                </div>
                                <div class="h-48 relative">
                                    <canvas id="seven-day-trend-chart" class="w-full h-full"></canvas>
                                </div>
                            </div>
                            
                            <!-- Goals Progress -->
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-semibold">Goals Progress</h3>
                                    <button onclick="openGoalsModal()" class="text-sm text-blue-600 dark:text-blue-400 opacity-70 hover:opacity-100 hover:underline">
                                        Manage
                                    </button>
                                </div>
                                <div id="dashboard-goals-container" class="space-y-4">
                                    <!-- Goals will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- RIGHT COLUMN (narrower - 1/3 width, stacked vertically) -->
                        <div class="space-y-4">
                            <!-- Upcoming Bills -->
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-semibold">Upcoming Bills</h3>
                                    <button onclick="showTab('recurring')" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">See all</button>
                                </div>
                                <div id="upcoming-events" class="space-y-3">
                                    <p class="text-gray-500 dark:text-gray-400 text-sm">No upcoming bills.</p>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="card p-4">
                                <h3 class="text-lg font-semibold mb-3">Quick Actions</h3>
                                <div class="space-y-3">
                                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-1">
                                        <button onclick="showAddForm()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 flex items-center justify-center gap-2 font-medium">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            + Add Expense
                                        </button>
                                    </div>
                                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-1">
                                        <button onclick="showAddIncomeForm()" class="w-full px-4 py-3 bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 flex items-center justify-center gap-2 font-medium">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            💰 Add Income
                                        </button>
                                    </div>
                                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-1">
                                        <button onclick="showRecurringForm()" class="w-full px-4 py-3 bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 flex items-center justify-center gap-2 font-medium">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                            </svg>
                                            🔄 Add Recurring
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recent Activity -->
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-semibold">Recent Activity</h3>
                                    <button onclick="showTab('expenses')" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">See all</button>
                                </div>
                                <div id="recent-expenses" class="space-y-3">
                                    <p class="text-gray-700 dark:text-gray-300 text-sm">No recent expenses.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                
                <!-- Expenses Tab -->
                <div id="expenses-tab" class="tab-content hidden fade-in">
                    <div class="card">
                        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-4">
                            <h2 class="text-xl font-semibold">All Expenses</h2>
                            <div class="flex flex-wrap gap-2 sm:gap-3">
                                <button onclick="toggleFilterPanel('expense-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                    </svg>
                                    Filters
                                </button>
                                <button id="delete-selected-btn" onclick="deleteSelectedExpenses()" class="modern-button modern-button-danger hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showAddForm()" class="modern-button modern-button-primary">
                                     <span>➕</span> Add Expense
                                 </button>
                             </div>
                        </div>
                        
                        <!-- Filter Panel -->
                        <div id="expense-filter-panel" class="p-4 border-b border-gray-200 dark:border-gray-700 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <!-- Date Range -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Date Range</label>
                                    <div class="flex gap-2">
                                        <input type="date" id="expense-filter-date-from" class="modern-input">
                                        <input type="date" id="expense-filter-date-to" class="modern-input">
                                    </div>
                                </div>
                                <!-- Category -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Category</label>
                                    <select id="expense-filter-category" class="modern-select">
                                        <option value="">All Categories</option>
                                        <!-- Populated dynamically -->
                                    </select>
                                </div>
                                <!-- Type -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Type</label>
                                    <select id="expense-filter-type" class="modern-select">
                                        <option value="">All Types</option>
                                        <option value="Essential">Essential</option>
                                        <option value="Non-Essential">Non-Essential</option>
                                        <option value="Recurring">Recurring</option>
                                    </select>
                            </div>
                            <!-- Clear Filters -->
                                <div class="md:col-span-3 flex justify-end gap-2">
                                <button onclick="applyExpenseFilters()" class="modern-button modern-button-primary">Apply Filters</button>
                                <button onclick="clearExpenseFilters()" class="modern-button modern-button-secondary">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-300">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-expenses" onchange="toggleSelectAllExpenses(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Date</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Payment Method</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Type</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table">
                                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                        <td colspan="8" class="px-6 py-4 text-center">No expenses recorded yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Expenses Pagination -->
                        <div id="expenses-pagination" class="pagination-container">
                            <div class="pagination-info">
                                <span>Show</span>
                                <select id="expenses-per-page" onchange="changeExpensesPerPage(this.value)">
                                    <option value="5" selected>5</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <span>entries</span>
                            </div>
                            
                            <div class="pagination-controls">
                                <span id="expenses-page-info" class="pagination-status"></span>
                                <div class="pagination-buttons">
                                    <button onclick="goToExpensesPage('first')" id="expenses-first-btn" class="pagination-nav-btn" title="First page">
                                        ⏮
                                    </button>
                                    <button onclick="changeExpensesPage('prev')" id="expenses-prev-btn" class="pagination-nav-btn">
                                        Previous
                                    </button>
                                    <div class="pagination-page-input-container">
                                        <span class="text-sm text-gray-500">Page</span>
                                        <input type="number" id="expenses-page-input" min="1" onchange="goToExpensesPage(this.value)" class="pagination-page-input">
                                        <span id="expenses-total-pages" class="-page-total"></span>
                                    </div>
                                    <button onclick="changeExpensesPage('next')" id="expenses-next-btn" class="pagination-nav-btn">
                                        Next
                                    </button>
                                    <button onclick="goToExpensesPage('last')" id="expenses-last-btn" class="pagination-nav-btn" title="Last page">
                                        ⏭
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <!-- Recurring Tab -->
                <div id="recurring-tab" class="tab-content hidden fade-in">
                    <div class="card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 gap-4">
                            <div>
                                <h2 class="text-xl font-bold">Recurring Items</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-300">Regular income and expenses like salaries or subscriptions.</p>
                            </div>
                            <div class="flex-shrink-0 flex flex-wrap items-center gap-2 sm:space-x-2 sm:gap-0">
                                <button onclick="toggleFilterPanel('recurring-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg>
                                    Filter
                                </button>
                                <button id="delete-selected-recurring-btn" onclick="deleteSelectedRecurring()" class="modern-button modern-button-danger hidden">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showRecurringForm()" class="modern-button modern-button-primary">
                                    <span>🔁</span> Add Recurring
                                </button>
                            </div>
                        </div>
                
                        <div id="recurring-filter-panel" class="hidden p-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label for="recurring-filter-type" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Type</label>
                                    <select id="recurring-filter-type" class="modern-select mt-1">
                                        <option value="">All Types</option>
                                        <option value="income">Income</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-category" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Category</label>
                                    <select id="recurring-filter-category" class="modern-select mt-1">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-frequency" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Frequency</label>
                                    <select id="recurring-filter-frequency" class="modern-select mt-1">
                                        <option value="">All Frequencies</option>
                                        <option value="Daily">Daily</option>
                                        <option value="Weekly">Weekly</option>
                                        <option value="Bi-Weekly">Bi-Weekly</option>
                                        <option value="Monthly">Monthly</option>
                                        <option value="Quarterly">Quarterly</option>
                                        <option value="Annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 mt-4">
                                <button onclick="applyRecurringFilters()" class="modern-button modern-button-primary">Apply</button>
                                <button onclick="clearRecurringFilters()" class="modern-button modern-button-secondary">Clear</button>
                            </div>
                        </div>
                
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-300">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-recurring" onchange="toggleSelectAllRecurring(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Type</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Frequency</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell" style="white-space: nowrap;">Date</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recurring-table">
                                    <!-- Rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Recurring Pagination -->
                        <div id="recurring-pagination" class="pagination-container">
                            <div class="pagination-info">
                                <span>Show</span>
                                <select id="recurring-per-page" onchange="changeRecurringPerPage(this.value)">
                                    <option value="10">10</option>
                                    <option value="15" selected>15</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <span>entries</span>
                            </div>
                            
                            <div class="pagination-controls">
                                <span id="recurring-page-info" class="pagination-status"></span>
                                <div class="pagination-buttons">
                                    <button onclick="goToRecurringPage('first')" id="recurring-first-btn" class="pagination-nav-btn" title="First page">
                                        ⏮
                                    </button>
                                    <button onclick="changeRecurringPage('prev')" id="recurring-prev-btn" class="pagination-nav-btn">
                                        Previous
                                    </button>
                                    <div class="pagination-page-input-container">
                                        <span class="text-sm text-gray-500">Page</span>
                                        <input type="number" id="recurring-page-input" min="1" onchange="goToRecurringPage(this.value)" class="pagination-page-input">
                                        <span id="recurring-total-pages" class="pagination-page-total"></span>
                                    </div>
                                    <button onclick="changeRecurringPage('next')" id="recurring-next-btn" class="pagination-nav-btn">
                                        Next
                                    </button>
                                    <button onclick="goToRecurringPage('last')" id="recurring-last-btn" class="pagination-nav-btn" title="Last page">
                                        ⏭
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                
                <!-- Replace your insights tab HTML with this better layout -->
<div id="insights-tab" class="tab-content hidden fade-in">
    <div class="max-w-6xl mx-auto space-y-6 p-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2" style="color: var(--color-text-primary);">Your Financial Insights</h1>
            <p style="color: var(--color-text-secondary);">Smart analysis with real-time daily budget coaching</p>
        </div>

        <!-- Smart Alerts Section -->
        <div id="alerts-section" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="metric-card">
                <div class="text-sm opacity-90">Monthly Budget</div>
                <div class="text-2xl font-bold" id="monthly-budget-display">£0</div>
                <div class="text-xs opacity-75 mt-1" id="budget-vs-income">0% of income</div>
            </div>
            <div class="metric-card">
                <div class="text-sm opacity-90">Total Spent</div>
                <div class="text-2xl font-bold" id="total-spent-display">£0</div>
                <div class="text-xs opacity-75 mt-1" id="spent-vs-budget">0% of budget</div>
            </div>
            <div class="metric-card">
                <div class="text-sm opacity-90">Daily Budget</div>
                <div class="text-2xl font-bold" id="daily-budget-display">£0</div>
                <div class="text-xs opacity-75 mt-1" id="daily-budget-status">Auto-calculated</div>
            </div>
            <div class="metric-card">
                <div class="text-sm opacity-90">Today's Spending</div>
                <div class="text-2xl font-bold" id="today-spent-display">£0</div>
            </div>
        </div>

        <!-- Daily Spending Visualization Chart -->
        <div class="card p-4 mb-4">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <div class="flex-1">
                    <div class="p-2">
                        <div>
                            <h2 class="text-xl font-semibold mb-2">Daily Spending Visualization</h2>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Track your daily spending patterns with budget alerts and reference lines</p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 flex-wrap">
                    <button class="period-toggle active px-4 py-2 rounded-lg font-medium transition-all duration-200 border-2 border-blue-500 bg-blue-500 text-white hover:bg-blue-600 hover:border-blue-600 shadow-sm hover:shadow-md transform hover:scale-105" onclick="setInsightsPeriod('7days')" data-period="7days">7 Days</button>
                    <button class="period-toggle px-4 py-2 rounded-lg font-medium transition-all duration-200 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 shadow-sm hover:shadow-md transform hover:scale-105" onclick="setInsightsPeriod('30days')" data-period="30days"> 30 Days</button>
                    <button class="period-toggle px-4 py-2 rounded-lg font-medium transition-all duration-200 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 shadow-sm hover:shadow-md transform hover:scale-105" onclick="setInsightsPeriod('90days')" data-period="90days"> 90 Days</button>
                </div>
            </div>

            <!-- Chart Container -->
            <div class="relative h-96 w-full mb-4">
                <canvas id="daily-spending-insights-chart"></canvas>
            </div>
        </div>

        <!-- Real-Time Daily Coaching -->
        <div class="card p-4 mb-4">
            <button onclick="toggleInsightsSection('budget-coach')" class="insights-section-toggle flex items-center justify-between w-full text-left p-2 rounded-lg mb-4">
                <div class="flex items-center gap-2">
                    <h3 class="text-lg font-semibold" style="color: var(--color-text-primary);">🎯 Daily Budget Coach</h3>
                    <div class="text-sm" style="color: var(--color-text-secondary);">Real-time guidance</div>
                </div>
                <span id="budget-coach-toggle" class="text-lg" style="color: var(--color-text-primary);">▼</span>
            </button>
            <div id="budget-coach-content" class="">
                <div id="daily-coaching-container">
                    <!-- Will be populated with dynamic coaching messages -->
                </div>
            </div>
        </div>

        <!-- Essential vs Non-Essential -->
        <div class="card p-4 mb-4">
            <button onclick="toggleInsightsSection('spending-breakdown')" class="insights-section-toggle flex items-center justify-between w-full text-left p-2 rounded-lg mb-4">
                <h3 class="text-lg font-semibold" style="color: var(--color-text-primary);">Spending Breakdown (Month)</h3>
                <span id="spending-breakdown-toggle" class="text-lg" style="color: var(--color-text-primary);">▶</span>
            </button>
            <div id="spending-breakdown-content" class="hidden">
            <div class="flex justify-around items-center text-center mb-4">
                <div>
                    <p class="text-sm" style="color: var(--color-text-secondary);">Essential</p>
                    <p class="text-2xl font-semibold" style="color: var(--color-primary);" id="insights-essential-spending">£0.00</p>
                </div>
                <div>
                    <p class="text-sm" style="color: var(--color-text-secondary);">Non-Essential</p>
                    <p class="text-2xl font-semibold" style="color: var(--color-warning);" id="insights-non-essential-spending">£0.00</p>
                </div>
            </div>
                <div class="w-full rounded-full h-3">
                    <div id="insights-essential-bar" class="bg-sky-500 h-3 rounded-l-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div><!--
                 --><div id="insights-non-essential-bar" class="bg-indigo-500 h-3 rounded-r-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Today's Budget Section -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
            <button onclick="toggleInsightsSection('todays-budget')" class="flex items-center justify-between w-full text-left hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded-lg transition-colors mb-4">
                <h3 class="text-lg font-semibold" style="color: var(--color-text-primary);">Today's Budget</h3>
                <span id="todays-budget-toggle" class="text-lg">▶</span>
            </button>
            <div id="todays-budget-content" class="hidden">
            
            <div class="text-center mb-4">
                <div class="text-3xl font-bold" style="color: var(--color-text-primary);" id="todays-remaining">£0</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Remaining Today</div>
            </div>
            
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                <div class="bg-blue-500 h-3 rounded-full transition-all duration-300" id="todays-budget-bar" style="width: 0%"></div>
            </div>
            
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                    <span id="todays-spent">Spent: £0</span>
                    <span id="todays-budget-total">Budget: £0</span>
                </div>
            </div>
        </div>

        <!-- Category Spending Analysis -->
        <div class="card p-4 mb-4">
            <button onclick="toggleInsightsSection('category-analysis')" class="insights-section-toggle flex items-center justify-between w-full text-left p-2 rounded-lg mb-4">
                <h3 class="text-lg font-semibold flex items-center gap-2" style="color: var(--color-text-primary);">
                    📊 Category Spending Analysis
                </h3>
                <span id="category-analysis-toggle" class="text-lg" style="color: var(--color-text-primary);">▶</span>
            </button>
            <div id="category-analysis-content" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Top Categories This Month -->
                <div>
                    <h4 class="font-medium mb-4" style="color: var(--color-text-primary);">Top Categories This Month</h4>
                    <div class="space-y-4" id="category-spending-breakdown">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Budget Impact by Category Chart -->
                <div>
                    <h4 class="font-medium mb-4" style="color: var(--color-text-primary);">Budget Impact by Category</h4>
                    <div class="relative">
                        <div class="h-80 flex items-center justify-center">
                            <canvas id="category-donut-chart" style="max-height: 300px;"></canvas>
                        </div>
                        <!-- Chart Legend -->
                        <div class="mt-4 grid grid-cols-2 gap-2 text-sm" id="category-chart-legend">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Smart Insights -->
        <div class="card p-4 mb-4">
            <button onclick="toggleInsightsSection('smart-insights')" class="insights-section-toggle flex items-center justify-between w-full text-left p-2 rounded-lg mb-4">
                <h3 class="text-lg font-semibold" style="color: var(--color-text-primary);">💡 Smart Insights</h3>
                <span id="smart-insights-toggle" class="text-lg" style="color: var(--color-text-primary);">▶</span>
            </button>
            <div id="smart-insights-content" class="hidden">
                <div class="space-y-4" id="insights-container">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Budget Coach Recommendations -->
        <div class="card p-4 mb-4">
            <button onclick="toggleInsightsSection('budget-performance')" class="insights-section-toggle flex items-center justify-between w-full text-left p-2 rounded-lg mb-4">
                <h3 class="text-lg font-semibold" style="color: var(--color-text-primary);">📊 Budget Performance</h3>
                <span id="budget-performance-toggle" class="text-lg" style="color: var(--color-text-primary);">▶</span>
            </button>
            <div id="budget-performance-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="coaching-panel">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Tab -->
<div id="settings-tab" class="tab-content hidden fade-in">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column: Core Settings -->
        <div class="space-y-6">
            <!-- Budget & Income Settings -->
            <div class="trezor-card">
                <div class="card-header">
                    <h3 class="card-title">💰 Budget & Income</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Set your financial targets for accurate insights</p>
                </div>
                <div class="card-content space-y-4">
                    <div>
                        <label for="settings-monthly-income" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Monthly Income
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                            <input type="number" 
                                   id="settings-monthly-income" 
                                   placeholder="Enter your monthly income" 
                                   class="w-full pl-8 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-semibold text-lg"
                                   onchange="updateIncome(this.value)" oninput="updateIncome(this.value)">
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Your total monthly income before taxes</p>
                    </div>
                    
                    <div>
                        <label for="settings-monthly-budget" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Monthly Budget
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                            <input type="number" 
                                   id="settings-monthly-budget" 
                                   placeholder="Enter your monthly budget" 
                                   class="w-full pl-8 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-semibold text-lg"
                                   onchange="updateBudget(this.value)" oninput="updateBudget(this.value)">
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">How much you plan to spend each month</p>
                    </div>
                    
                    <div>
                        <label for="settings-daily-budget" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Daily Budget (Optional)
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                            <input type="number" 
                                   id="settings-daily-budget" 
                                   placeholder="Auto-calculated from monthly" 
                                   class="w-full pl-8 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors font-semibold text-lg">
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            <span id="daily-budget-calculation">Leave empty to auto-calculate (Monthly ÷ 30)</span>
                        </p>
                        
                        <!-- Daily Budget Coaching Toggle -->
                        <div class="flex items-center justify-between mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div>
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Enable Daily Budget Coaching</label>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Get real-time spending guidance in Insights tab</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="daily-budget-enabled" class="sr-only peer" onchange="toggleDailyBudgetCoaching()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <!-- Daily Budget Line Visibility Toggle -->
                        <div class="flex items-center justify-between mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div>
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Show Daily Budget Line</label>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Display daily budget reference line on 7-day and 30-day charts</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="daily-budget-line-enabled" class="sr-only peer" onchange="toggleDailyBudgetLine()" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Quick Budget Calculation Helper -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-blue-900 dark:text-blue-100 mb-2">💡 Budget Helper</h4>
                        <div class="text-sm text-blue-800 dark:text-blue-200 space-y-1">
                            <div id="budget-surplus-display">• Monthly Surplus: <span class="font-semibold">£0</span> (Income - Budget)</div>
                            <div id="daily-budget-display">• Calculated Daily Budget: <span class="font-semibold">£0</span></div>
                            <div id="savings-rate-display">• Savings Rate: <span class="font-semibold">0%</span> of income</div>
                        </div>
                    </div>
                    
                    <!-- Save/Cancel Buttons for Budget Settings -->
                    <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button onclick="cancelSettings()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium">
                            Cancel
                        </button>
                        <button onclick="saveSettingsWithInsightsUpdate()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- General Settings -->
            <div class="trezor-card">
                <div class="card-header">
                    <h3 class="card-title">⚙️ General Settings</h3>
                </div>
                <div class="card-content space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</label>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Toggle between light and dark themes</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only peer" onchange="toggleTheme(this.checked)">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div>
                        <label for="currency-selector" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Currency</label>
                        <select id="currency-selector" onchange="changeCurrency(this.value)" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="AUD">AUD - Australian Dollar (A$)</option>
                            <option value="CAD">CAD - Canadian Dollar (C$)</option>
                            <option value="EUR">EUR - Euro (€)</option>
                            <option value="GBP">GBP - British Pound (£)</option>
                            <option value="JPY">JPY - Japanese Yen (¥)</option>
                            <option value="USD">USD - US Dollar ($)</option>
                        </select>
                    </div>

                    <!-- Income Display Settings -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold" style="color: var(--color-text-primary);">Chart Display Options</h3>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Show Income Line on Charts</label>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Display monthly income reference line on spending charts</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="income-display-enabled" class="sr-only peer" onchange="toggleIncomeDisplay()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Data Management & Actions -->
        <div class="space-y-6">
            <!-- Data Management -->
            <div class="trezor-card">
                <div class="card-header">
                    <h3 class="card-title">📊 Data Management</h3>
                </div>
                <div class="card-content space-y-4">
                    <button onclick="exportData()" class="w-full flex items-center justify-center gap-2 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export Data (JSON)
                    </button>
                    
                    <div class="relative">
                        <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
                        <button onclick="document.getElementById('import-file').click()" class="w-full flex items-center justify-center gap-2 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            Import Data (JSON)
                        </button>
                    </div>
                    
                    <div class="text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                        <strong>Data Privacy:</strong> All your data is stored locally on your device. No information is sent to external servers.
                    </div>
                </div>
            </div>

            <!-- Banking Integration -->
            <div class="trezor-card">
                <div class="card-header">
                    <h3 class="card-title">🏦 Banking Integration</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Connect your bank account for automatic transaction import</p>
                </div>
                <div class="card-content">
                    <button onclick="connectBankAccount()" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        Connect Bank Account
                    </button>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
                        Secure connection via bank-grade encryption
                    </p>
                </div>
            </div>


            <!-- Quick Actions -->
            <div class="trezor-card">
                <div class="card-header">
                    <h3 class="card-title">⚡ Quick Actions</h3>
                </div>
                <div class="card-content space-y-3">
                    <button onclick="restartTour()" class="w-full flex items-center justify-center gap-2 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Restart Tour
                    </button>
                    
                    <button onclick="clearAllData()" class="w-full flex items-center justify-center gap-2 px-4 py-3 border border-red-300 dark:border-red-600 rounded-lg text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Clear All Data
                    </button>
                </div>
            </div>


        </div>
    </div>

    <!-- Save Actions -->
</div>


<!-- Help & Documentation Tab -->
<div id="help-tab" class="tab-content hidden fade-in">
    <div class="p-6">
        <div class="mb-6">
            <h2 class="text-2xl font-semibold mb-2">Help & Documentation</h2>
            <p class="text-secondary">Learn how to make the most of your personal finance tracker</p>
        </div>
        
        <div class="help-accordion space-y-4">
            <!-- Getting Started Section -->
            <div class="help-section">
                <button class="help-section-header" onclick="toggleHelpSection('getting-started')">
                    <span class="help-section-title">🚀 Getting Started</span>
                    <span id="getting-started-toggle" class="help-toggle">▼</span>
                </button>
                <div id="getting-started-content" class="help-section-content">
                    <div class="help-component">
                        <h4 class="help-component-title">👋 Welcome to Lens</h4>
                        <p class="help-component-description">
                            Lens is your personal expense tracking and budgeting companion. This Progressive Web App helps you track expenses, manage recurring items, and monitor your financial health with real-time insights.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Quick Setup Steps:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Visit <button onclick="showTab('settings')" class="text-blue-600 hover:underline">Settings</button> to configure your monthly budget and income</li>
                                <li>Add your first expense using the "Add Expense" button</li>
                                <li>Set up recurring items for bills and subscriptions</li>
                                <li>Monitor your spending and budget health on the Dashboard</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Key Features:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Expense tracking with smart categorization</li>
                                <li>Budget monitoring and health scoring</li>
                                <li>Recurring items automation</li>
                                <li>Interactive spending insights</li>
                                <li>Essential vs Non-Essential analysis</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Overview Section -->
            <div class="help-section">
                <button class="help-section-header" onclick="toggleHelpSection('dashboard-overview')">
                    <span class="help-section-title">📊 Dashboard Overview</span>
                    <span id="dashboard-overview-toggle" class="help-toggle">▼</span>
                </button>
                <div id="dashboard-overview-content" class="help-section-content">
                    <div class="help-component">
                        <h4 class="help-component-title">📊 Budget Summary Cards</h4>
                        <p class="help-component-description">
                            The main dashboard displays four key budget cards showing your financial overview: Monthly Budget, Spent This Month, Budget Remaining, and Monthly Savings.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Understanding the percentages:</h5>
                            <ol class="list-decimal list-inside space-y-2">
                                <li><strong>Monthly Budget:</strong> Shows "X% of income" - how much of your income you've allocated to spending</li>
                                <li><strong>Spent This Month:</strong> Shows spending pace indicators:
                                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                        <li>"On pace ✓" = Spending matches expected progress through the month</li>
                                        <li>"+X% ahead" = Spending faster than expected for this point in the month</li>
                                        <li>"X% under" = Spending slower than expected</li>
                                    </ul>
                                </li>
                                <li><strong>Budget Remaining:</strong> Shows budget status:
                                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                        <li>"X% remaining" = Portion of budget still available</li>
                                        <li>"X% over budget" = Amount you've exceeded your budget</li>
                                        <li>🟢 Green (>50%): Plenty left • 🟡 Yellow (10-50%): Running low • 🔴 Red (<10%): Nearly exhausted</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Example:</h5>
                            <p class="text-sm bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                                If it's day 15 of a 30-day month, you should have spent ~50% of your budget. If you've spent 65%, you're "15% ahead of pace" and should slow down spending to stay on track.
                            </p>
                        </div>
                    </div>
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">How to read the cards:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Monthly Budget shows your total spending limit</li>
                                <li>Total Spent displays current month's expenses</li>
                                <li>Daily Budget shows recommended daily spending</li>
                                <li>Today's Spending tracks real-time daily expenses</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Tips:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Green cards indicate healthy spending patterns</li>
                                <li>Red cards warn of budget concerns</li>
                                <li>Click cards for detailed breakdowns</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">🎯 Budget Health Score</h4>
                        <p class="help-component-description">
                            A 0-100 score that evaluates your financial wellness based on spending patterns, budget adherence, and expense distribution.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Score calculation:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Budget adherence (40% weight)</li>
                                <li>Essential vs Non-Essential ratio (30% weight)</li>
                                <li>Spending consistency (20% weight)</li>
                                <li>Upcoming bills coverage (10% weight)</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Score ranges:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>80-100: Excellent financial health</li>
                                <li>60-79: Good with room for improvement</li>
                                <li>40-59: Needs attention</li>
                                <li>Below 40: Requires immediate action</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">↻ Upcoming Bills</h4>
                        <p class="help-component-description">
                            Shows the next 3 upcoming recurring items with due dates and amounts to help you plan your spending.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">How it works:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Automatically calculated from active recurring items</li>
                                <li>Shows items due within the next 30 days</li>
                                <li>Click to view or edit recurring item details</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Tips:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Set up recurring items for all regular bills</li>
                                <li>Check daily to avoid missing payments</li>
                                <li>Use this to plan large purchases</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">⚡ Quick Actions</h4>
                        <p class="help-component-description">
                            Fast access buttons for adding expenses and recurring items directly from the dashboard.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Available actions:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Add Expense: Record new spending immediately</li>
                                <li>Add Recurring: Set up new subscription or bill</li>
                                <li>Quick categorization with smart defaults</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Financial Management Section -->
            <div class="help-section">
                <button class="help-section-header" onclick="toggleHelpSection('financial-management')">
                    <span class="help-section-title">💰 Financial Management</span>
                    <span id="financial-management-toggle" class="help-toggle">▼</span>
                </button>
                <div id="financial-management-content" class="help-section-content">
                    <div class="help-component">
                        <h4 class="help-component-title">💸 Adding Expenses</h4>
                        <p class="help-component-description">
                            Track all your spending with detailed categorization, payment methods, and Essential vs Non-Essential classification.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">How to add expenses:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Click "Add Expense" button from dashboard or expenses tab</li>
                                <li>Enter amount, description, and select category</li>
                                <li>Choose date, payment method, and expense type</li>
                                <li>Mark as Essential or Non-Essential</li>
                                <li>Save to add to your expense history</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Tips:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Add expenses immediately to avoid forgetting</li>
                                <li>Use consistent category names for better insights</li>
                                <li>Be honest about Essential vs Non-Essential classification</li>
                                <li>Include descriptive names for easy searching</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">🏷️ Smart Categories</h4>
                        <p class="help-component-description">
                            Pre-defined categories help organize your spending: Food & Drink, Transport, Shopping, Bills, Entertainment, and more.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Available categories:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Food & Drink: Groceries, restaurants, coffee</li>
                                <li>Transport: Gas, public transit, ride-sharing</li>
                                <li>Shopping: Clothing, electronics, household items</li>
                                <li>Bills: Utilities, insurance, subscriptions</li>
                                <li>Entertainment: Movies, games, hobbies</li>
                                <li>Healthcare: Medical, dental, pharmacy</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Best practices:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Choose the most specific category available</li>
                                <li>Stick to the same category for similar expenses</li>
                                <li>Use "Other" sparingly for better analytics</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">🔄 Recurring Expenses</h4>
                        <p class="help-component-description">
                            Automate tracking of regular bills, subscriptions, and income with flexible frequency options and automatic processing.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Setting up recurring items:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Go to Recurring tab and click "Add Recurring Item"</li>
                                <li>Enter description, amount, and category</li>
                                <li>Choose frequency: Daily, Weekly, Monthly, etc.</li>
                                <li>Set start date and optional end date</li>
                                <li>Select Income or Expense type</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Tips:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Set up all regular bills for complete tracking</li>
                                <li>Include salary as recurring income</li>
                                <li>Use end dates for temporary subscriptions</li>
                                <li>Review and update amounts regularly</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">🏛️ Essential vs Non-Essential</h4>
                        <p class="help-component-description">
                            Classify expenses to understand spending priorities and identify optimization opportunities.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Classification guide:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Essential: Rent, utilities, groceries, transportation to work</li>
                                <li>Non-Essential: Dining out, entertainment, luxury items</li>
                                <li>Consider: "Do I need this to live/work/maintain health?"</li>
                                <li>When in doubt, lean towards Non-Essential</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Optimization tips:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Aim for 70% Essential, 30% Non-Essential spending</li>
                                <li>Review Non-Essential expenses when over budget</li>
                                <li>Track trends to identify spending patterns</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics & Insights Section -->
            <div class="help-section">
                <button class="help-section-header" onclick="toggleHelpSection('analytics-insights')">
                    <span class="help-section-title">📈 Analytics & Insights</span>
                    <span id="analytics-insights-toggle" class="help-toggle">▼</span>
                </button>
                <div id="analytics-insights-content" class="help-section-content">
                    <div class="help-component">
                        <h4 class="help-component-title">📊 Interactive Charts</h4>
                        <p class="help-component-description">
                            Visualize your spending patterns with interactive charts that adapt to different time periods and show detailed breakdowns.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Chart interactions:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Click time period buttons (7, 30, 90 days) to change view</li>
                                <li>Hover over chart elements for detailed tooltips</li>
                                <li>Click legend items to show/hide data series</li>
                                <li>Click chart segments for category drilldowns</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Reading charts:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Green indicates healthy/under budget spending</li>
                                <li>Red shows concerning/over budget amounts</li>
                                <li>Percentages show proportion of total spending</li>
                                <li>Trends help identify spending patterns</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">🧠 Smart Insights</h4>
                        <p class="help-component-description">
                            Automated analysis of your spending patterns with personalized recommendations and trend identification.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Available insights:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Spending trend analysis (increasing/decreasing)</li>
                                <li>Category overspending alerts</li>
                                <li>Budget performance projections</li>
                                <li>Essential vs Non-Essential balance recommendations</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Acting on insights:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Review insights weekly for best results</li>
                                <li>Focus on top spending categories first</li>
                                <li>Set specific goals based on recommendations</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">💡 Daily Budget Coach</h4>
                        <p class="help-component-description">
                            Real-time guidance on daily spending compared to your budget, helping you stay on track throughout the month.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">How it works:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Calculates daily budget based on monthly budget</li>
                                <li>Tracks actual daily spending in real-time</li>
                                <li>Provides immediate feedback and recommendations</li>
                                <li>Adjusts remaining budget for rest of month</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Tips:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Check daily coach each morning</li>
                                <li>Adjust spending when over daily budget</li>
                                <li>Use for planning large purchases</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings & Configuration Section -->
            <div class="help-section">
                <button class="help-section-header" onclick="toggleHelpSection('settings-configuration')">
                    <span class="help-section-title">⚙ Settings & Configuration</span>
                    <span id="settings-configuration-toggle" class="help-toggle">▼</span>
                </button>
                <div id="settings-configuration-content" class="help-section-content">
                    <div class="help-component">
                        <h4 class="help-component-title">💰 Budget Settings</h4>
                        <p class="help-component-description">
                            Configure your monthly budget and income to enable accurate tracking and budget health calculations.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Setup steps:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Open Settings from the navigation menu</li>
                                <li>Enter your monthly budget (total spending limit)</li>
                                <li>Set monthly income (for savings calculation)</li>
                                <li>Choose your preferred currency</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Budget tips:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Set realistic budgets based on past spending</li>
                                <li>Include all expenses except savings/investments</li>
                                <li>Review and adjust monthly based on performance</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">🎨 Theme & Display</h4>
                        <p class="help-component-description">
                            Customize the appearance with dark/light mode toggle and personalize your viewing experience.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Customization options:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Toggle dark/light mode in Settings</li>
                                <li>Theme automatically saves your preference</li>
                                <li>Charts and colors adapt to chosen theme</li>
                            </ol>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">💾 Data Management</h4>
                        <p class="help-component-description">
                            Export, import, and manage your financial data with local storage and backup options.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Data operations:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Export Data: Download all expenses as JSON file</li>
                                <li>Import Data: Upload previously exported data</li>
                                <li>Clear All Data: Reset app completely (irreversible)</li>
                                <li>Local Storage: All data stays on your device</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Backup strategy:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Export data monthly as backup</li>
                                <li>Store exports in cloud storage</li>
                                <li>Test import functionality periodically</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Troubleshooting Section -->
            <div class="help-section">
                <button class="help-section-header" onclick="toggleHelpSection('troubleshooting')">
                    <span class="help-section-title">🔧 Troubleshooting</span>
                    <span id="troubleshooting-toggle" class="help-toggle">▼</span>
                </button>
                <div id="troubleshooting-content" class="help-section-content">
                    <div class="help-component">
                        <h4 class="help-component-title">🐛 Common Issues</h4>
                        <p class="help-component-description">
                            Solutions for frequently encountered problems and performance optimization tips.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Common fixes:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Data not saving: Check browser local storage permissions</li>
                                <li>Charts not loading: Refresh page or clear browser cache</li>
                                <li>Slow performance: Export data and clear old entries</li>
                                <li>Missing expenses: Check date filters and category selection</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Performance tips:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Regularly archive old expenses</li>
                                <li>Keep browser updated for best performance</li>
                                <li>Clear browser cache if experiencing issues</li>
                                <li>Export data before major browser updates</li>
                            </ul>
                        </div>
                    </div>

                    <div class="help-component">
                        <h4 class="help-component-title">🔄 Data Recovery</h4>
                        <p class="help-component-description">
                            Steps to recover data if something goes wrong with local storage or accidental deletion.
                        </p>
                        <div class="help-component-steps">
                            <h5 class="font-medium mb-2">Recovery steps:</h5>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Check if you have recent data exports</li>
                                <li>Import the most recent backup file</li>
                                <li>Verify all data imported correctly</li>
                                <li>Recreate any missing recent entries</li>
                            </ol>
                        </div>
                        <div class="help-component-tips">
                            <h5 class="font-medium mb-2">💡 Prevention:</h5>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Export data weekly or monthly</li>
                                <li>Store backups in multiple locations</li>
                                <li>Test recovery process periodically</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Settings Modal -->
    <div id="settings-modal" onclick="closeSettings()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-2 sm:p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Settings</h3>
                <button onclick="closeSettings()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Budget & Income Section -->
                <div id="settings-budget-section" class="space-y-3 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                    <h4 class="text-md font-semibold">Budget & Income</h4>
                    <div>
                        <label class="block text-xs font-medium">Monthly Budget</label>
                        <input type="number" id="settings-budget-input" placeholder="e.g., 2000" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-xs font-medium">Monthly Income</label>
                        <input type="number" id="settings-income-input" placeholder="e.g., 3500" class="modern-input mt-1" onchange="updateIncome(this.value)" oninput="updateIncome(this.value)">
                    </div>
                </div>
            
                <!-- General Settings -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="theme-toggle" class="text-sm font-medium">Dark Mode</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle" onchange="toggleThemeFromSettings(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="currency-select" class="text-sm font-medium">Currency</label>
                        <select id="currency-select" onchange="changeCurrency(this.value)" class="modern-select text-sm w-40">
                            <option value="AUD">AUD (A$)</option>
                            <option value="CAD">CAD (C$)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                            <option value="JPY">JPY (¥)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="space-y-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="exportData()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>Export Data (JSON)</span>
                    </button>
                    <label class="modern-button modern-button-secondary w-full justify-start cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>Import Data (JSON)</span>
                        <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                    </label>
                    <button onclick="connectBankAccount()" class="modern-button modern-button-secondary w-full justify-start" id="connect-bank-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                        <span>Connect Bank Account</span>
                    </button>
                    <button onclick="importBankTransactions()" class="modern-button modern-button-secondary w-full justify-start" id="import-transactions-btn" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>Import Bank Transactions</span>
                    </button>
                    <button onclick="restartTour()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>Restart Tour</span>
                    </button>
                </div>
            </div>

        </div>
    </div>
    




    <!-- Add/Edit Expense Modal -->
    <div id="modal" onclick="closeModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-6" id="modal-title">Add New Expense</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="expense-name" placeholder="e.g., Coffee, Rent" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="modal-currency">£</span>)</label>
                        <input type="number" step="0.01" id="expense-cost" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" id="expense-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="expense-category" class="modern-select mt-1">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                        <select id="expense-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="expense-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveExpense()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Recurring Item Modal -->
    <div id="recurring-modal" onclick="closeRecurringModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-4" id="recurring-modal-title">Add Recurring Item</h3>
            <div class="space-y-4">
                 <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                    <select id="recurring-item-type" class="modern-select mt-1" onchange="toggleRecurringFields(this.value)">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="recurring-name" placeholder="e.g., Salary, Netflix" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="recurring-modal-currency">£</span>)</label>
                        <input type="number" step="0.01" id="recurring-amount" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                        <select id="recurring-frequency" class="modern-select mt-1">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Bi-Weekly">Bi-Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Annual">Annual</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="recurring-category" class="modern-select mt-1">
                            <!-- Options loaded dynamically -->
                        </select>
                    </div>
                    <div id="recurring-essential-type-wrapper">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Expense Type</label>
                        <select id="recurring-essential-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                        <input type="date" id="recurring-start-date" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date (Optional)</label>
                        <input type="date" id="recurring-end-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="recurring-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveRecurring()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeRecurringModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" onclick="closeHelpModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold">Help & Documentation</h3>
                <button onclick="closeHelpModal()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 md:p-8">
                <div class="space-y-8 text-sm leading-relaxed">
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">🚀 Getting Started</h3>
                        <div class="space-y-4">
                            <p>Welcome to <strong>Lens</strong> - your comprehensive personal finance companion! This Progressive Web App (PWA) provides powerful expense tracking, goal management, and financial optimization tools.</p>
                            
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">First Steps:</h4>
                                <ol class="list-decimal ml-5 space-y-2">
                                    <li>Complete the <strong>onboarding tour</strong> to set up your income, goals, and savings</li>
                                    <li>Visit <button onclick="openSettings('budget')" class="text-blue-600 hover:underline">Settings</button> to configure your monthly budget and preferences</li>
                                    <li>Connect bank accounts via Plaid for automatic transaction import</li>
                                    <li>Start tracking expenses and watch your financial insights grow</li>
                                </ol>
                            </div>
                            
                            <p><strong>Key Benefits:</strong> Real-time goal impact analysis, credit card points optimization, smart spending forecasts, and YNAB-style savings allocation.</p>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">📱 Dashboard Tabs Overview</h3>
                        <div class="space-y-6">
                            <div class="border-l-4 border-green-500 pl-4">
                                <h4 class="font-semibold text-md mb-2">🎯 Overview</h4>
                                <p class="mb-3">Your financial command center with live snapshot of monthly performance.</p>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Key Financial Stats:</strong> Monthly budget, spending total, remaining budget, and income breakdown (click income card for details)</li>
                                    <li><strong>Smart Projections:</strong> Visual budget progress bar with intelligent forecasts for month-end spending</li>
                                    <li><strong>Budget Health Score (0-100):</strong> Comprehensive financial wellness metric with detailed breakdown tooltip</li>
                                    <li><strong>Essential vs Non-Essential Spending:</strong> Categorized spending analysis for better budget awareness</li>
                                    <li><strong>Goal Progress Cards:</strong> Real-time timeline updates showing how current spending affects goal completion dates</li>
                                    <li><strong>Quick Action Buttons:</strong> One-click expense and recurring item creation</li>
                                </ul>
                            </div>

                            <div class="border-l-4 border-blue-500 pl-4">
                                <h4 class="font-semibold text-md mb-2">💸 Expenses</h4>
                                <p class="mb-3">Comprehensive expense management with intelligent categorization and bulk operations.</p>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Smart Auto-Categorization:</strong> Intelligent category suggestions based on merchant names and spending patterns</li>
                                    <li><strong>Advanced Filtering:</strong> Date ranges, categories, expense types, and auto-generated recurring items</li>
                                    <li><strong>Bulk Operations:</strong> Multi-select with checkboxes for efficient batch deletions</li>
                                    <li><strong>Real-time Impact:</strong> Instant goal timeline updates when expenses are added/modified</li>
                                    <li><strong>Import Integration:</strong> Seamless merging with bank-imported transactions (no duplicates)</li>
                                </ul>
                            </div>

                            <div class="border-l-4 border-purple-500 pl-4">
                                <h4 class="font-semibold text-md mb-2">🔄 Recurring</h4>
                                <p class="mb-3">Automated income and expense tracking for predictable financial planning.</p>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Dual Mode Support:</strong> Income (salaries, freelance) and expenses (subscriptions, bills)</li>
                                    <li><strong>Automatic Processing:</strong> Scheduled creation of expense records on due dates</li>
                                    <li><strong>Dynamic Income Integration:</strong> Recurring income automatically updates monthly totals</li>
                                    <li><strong>Flexible Status Management:</strong> Pause (cancelled) and resume (active) recurring items</li>
                                    <li><strong>Forecast Integration:</strong> Upcoming recurring items appear in 7-day forecast analysis</li>
                                </ul>
                            </div>

                            <div class="border-l-4 border-orange-500 pl-4">
                                <h4 class="font-semibold text-md mb-2">📊 Insights</h4>
                                <p class="mb-3">Advanced analytics with banking integration and optimization recommendations.</p>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Credit Card Points Optimization:</strong> Identifies missed rewards from imported transactions with annual value calculations</li>
                                    <li><strong>Real-time Goal Impact Analysis:</strong> Shows how spending affects completion timelines with optimization scenarios</li>
                                    <li><strong>Smart Actionable Recommendations:</strong> Dismissible cards with specific tips for points optimization and budget improvements</li>
                                    <li><strong>7-Day Forecast (2-column grid):</strong> Upcoming expenses with High/Medium/Low confidence levels</li>
                                    <li><strong>Month-End Projections:</strong> ML-powered forecasts for spending, savings, and goal progress</li>
                                    <li><strong>Monthly Story Narrative:</strong> Personalized summary highlighting achievements and key metrics</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">🎯 Goals & Real-time Impact Analysis</h3>
                        <div class="space-y-4">
                            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Goal System Overview</h4>
                                <p class="text-sm">YNAB-style "give every dollar a job" approach with real-time timeline calculations and optimization impact analysis.</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="font-semibold mb-2">Goal Types & Templates</h4>
                                    <ul class="list-disc ml-5 space-y-1 text-sm">
                                        <li><strong>House Deposit:</strong> Property purchase savings with market-based targets</li>
                                        <li><strong>Emergency Fund:</strong> 3-6 months expense coverage calculation</li>
                                        <li><strong>Dream Vacation:</strong> Travel and experience savings planning</li>
                                        <li><strong>Investment Fund:</strong> Long-term wealth building goals</li>
                                        <li><strong>Debt Payoff:</strong> Strategic debt elimination with 20% income allocation</li>
                                        <li><strong>Custom Goals:</strong> Flexible targets for any financial objective</li>
                                    </ul>
                                </div>

                                <div>
                                    <h4 class="font-semibold mb-2">Advanced Features</h4>
                                    <ul class="list-disc ml-5 space-y-1 text-sm">
                                        <li><strong>Real-time Timeline Updates:</strong> Instant recalculation when transactions change</li>
                                        <li><strong>Optimization Comparison:</strong> "Current" vs "With Optimization" scenarios</li>
                                        <li><strong>Smart Savings Estimation:</strong> Realistic capacity based on income and spending</li>
                                        <li><strong>Progress Acceleration Metrics:</strong> Days/months saved through optimization</li>
                                        <li><strong>Cross-tab Synchronization:</strong> Consistent progress display across Overview and Insights</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Savings Allocation System</h4>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Total Savings Pool:</strong> Complete savings across all accounts</li>
                                    <li><strong>Goal Allocation:</strong> Assign specific amounts to individual goals</li>
                                    <li><strong>Unallocated Tracking:</strong> Monitor unassigned savings available for new goals</li>
                                    <li><strong>Multiple Goal Support:</strong> Split savings across various objectives</li>
                                    <li><strong>Net Worth Calculation:</strong> Automatic debt consideration for accurate financial position</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">🏦 Banking Integration & Transaction Import</h3>
                        <div class="space-y-4">
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Plaid Integration Setup</h4>
                                <ol class="list-decimal ml-5 space-y-1 text-sm">
                                    <li>Ensure backend server (Node.js/Express) is running on localhost:8000</li>
                                    <li>Configure Plaid API credentials in server environment</li>
                                    <li>Click "Connect Bank Account" in Settings to start secure authentication</li>
                                    <li>Select your bank and complete OAuth flow</li>
                                </ol>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="font-semibold mb-2">Import Features</h4>
                                    <ul class="list-disc ml-5 space-y-1 text-sm">
                                        <li><strong>30-Day Transaction History:</strong> Automatic import of recent banking activity</li>
                                        <li><strong>Smart Categorization:</strong> Merchant-based category assignment</li>
                                        <li><strong>Duplicate Prevention:</strong> Intelligent deduplication with manual entries</li>
                                        <li><strong>Real-time Processing:</strong> Immediate goal timeline updates</li>
                                    </ul>
                                </div>

                                <div>
                                    <h4 class="font-semibold mb-2">Security & Privacy</h4>
                                    <ul class="list-disc ml-5 space-y-1 text-sm">
                                        <li><strong>Bank-Grade Security:</strong> Plaid-powered encryption and authentication</li>
                                        <li><strong>No Credential Storage:</strong> Only secure access tokens retained</li>
                                        <li><strong>Local Data Storage:</strong> Financial data stored in browser localStorage</li>
                                        <li><strong>Token-based API:</strong> Secure backend communication without exposing credentials</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Points Optimization Analysis</h4>
                                <p class="text-sm">Imported transactions are automatically analyzed for credit card rewards opportunities, showing potential annual value and optimal card recommendations for each spending category.</p>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">💳 Points Optimization Calculations</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-3">Credit Card Database</h4>
                                    <div class="space-y-2 text-xs">
                                        <div class="flex justify-between">
                                            <span>Amex Gold:</span>
                                            <span>4x Food & Drink, 1x Others</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Amex Green:</span>
                                            <span>3x Transport, 1x Others</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Virgin Red:</span>
                                            <span>3x Shopping, 2x Transport</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Chase Sapphire:</span>
                                            <span>2x Travel & Dining</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-3">Point Valuations (Conservative)</h4>
                                    <div class="space-y-2 text-xs">
                                        <div class="flex justify-between">
                                            <span>Amex Points:</span>
                                            <span>£0.005 per point</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Virgin Points:</span>
                                            <span>£0.01 per point</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>ANA Miles:</span>
                                            <span>£0.012 per mile</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Chase Points:</span>
                                            <span>£0.008 per point</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Optimization Formula</h4>
                                <div class="text-xs font-mono space-y-1">
                                    <div><span class="text-blue-600">potentialValue</span> = transactionAmount × pointRate × pointValue</div>
                                    <div><span class="text-green-600">annualSavings</span> = monthlyMissedValue × 12</div>
                                    <div><span class="text-purple-600">optimizationImpact</span> = annualSavings ÷ 12 (monthly boost)</div>
                                </div>
                                <div class="mt-3 p-2 bg-white dark:bg-gray-900 rounded text-xs">
                                    <strong>Example:</strong> £100 at Tesco with Amex Gold<br>
                                    £100 × 4 × £0.005 = £2.00 potential value
                                </div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">📈 Goal Timeline Calculations</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Debt Payoff Goals</h4>
                                    <div class="text-xs font-mono space-y-1">
                                        <div>availableIncome = max(0, monthlyIncome - monthlyBudget)</div>
                                        <div>paymentCapacity = availableIncome × 0.2</div>
                                        <div>monthlyPayment = max(£50, paymentCapacity)</div>
                                        <div>monthsToCompletion = remainingDebt ÷ monthlyPayment</div>
                                    </div>
                                    <p class="text-xs mt-2 text-gray-600 dark:text-gray-400">Allocates 20% of available income to debt payments with £50 minimum.</p>
                                </div>

                                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Savings Goals</h4>
                                    <div class="text-xs font-mono space-y-1">
                                        <div>surplus = max(0, monthlyIncome - monthlySpending)</div>
                                        <div>monthlySavings = max(£50, min(surplus × 0.5, monthlyIncome × 0.1))</div>
                                        <div>monthsToGoal = remainingAmount ÷ monthlySavings</div>
                                    </div>
                                    <p class="text-xs mt-2 text-gray-600 dark:text-gray-400">Conservative approach using 50% of surplus or 10% of income, whichever is lower.</p>
                                </div>
                            </div>

                            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Optimization Impact Calculation</h4>
                                <div class="text-xs font-mono space-y-1">
                                    <div>monthlyPointsValue = (monthlySpending × avgPointsRate × avgPointValue)</div>
                                    <div>optimizedSavings = baseSavings + monthlyPointsValue</div>
                                    <div>optimizedTimeline = remainingAmount ÷ optimizedSavings</div>
                                    <div>timeSaved = originalTimeline - optimizedTimeline</div>
                                </div>
                                <p class="text-xs mt-2 text-gray-600 dark:text-gray-400">Shows how credit card optimization accelerates goal completion.</p>
                            </div>

                            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Smart Estimation Features</h4>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Realistic Savings Rates:</strong> Accounts for actual spending patterns and income volatility</li>
                                    <li><strong>Goal-Specific Logic:</strong> Different calculation methods for debt vs savings goals</li>
                                    <li><strong>Minimum Thresholds:</strong> Ensures meaningful monthly progress (£50 minimum)</li>
                                    <li><strong>Income Protection:</strong> Never allocates more than 10% of total income to single goal</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">🎯 Goal Modal Calculations</h3>
                        <div class="space-y-4">
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Understanding Your Financial Position</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <strong>Core Metrics:</strong>
                                        <ul class="list-disc ml-5 space-y-1 mt-1">
                                            <li><strong>Goal Target:</strong> Total amount you're saving for</li>
                                            <li><strong>Total Savings:</strong> Complete savings across all accounts</li>
                                            <li><strong>Allocated Amount:</strong> Portion assigned to this specific goal</li>
                                            <li><strong>Still Needed:</strong> Gap between target and allocated amount</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <strong>Advanced Calculations:</strong>
                                        <ul class="list-disc ml-5 space-y-1 mt-1">
                                            <li><strong>Unallocated Savings:</strong> Available for new goal assignments</li>
                                            <li><strong>Net Worth:</strong> Total Savings - Total Debt</li>
                                            <li><strong>Allocation Percentage:</strong> Goal allocation as % of total savings</li>
                                            <li><strong>Progress Percentage:</strong> (Allocated ÷ Target) × 100</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">YNAB-Style Allocation System</h4>
                                <div class="space-y-3">
                                    <p class="text-sm"><strong>Core Principle:</strong> "Give every dollar a job" - Every pound of savings should be allocated to a specific goal or purpose.</p>
                                    
                                    <div class="text-xs font-mono bg-white dark:bg-gray-900 p-3 rounded">
                                        totalSavings = £10,000<br>
                                        allocatedToGoals = £8,500<br>
                                        unallocated = £1,500<br>
                                        netWorth = £10,000 - £2,000 (debt) = £8,000
                                    </div>

                                    <ul class="list-disc ml-5 space-y-1 text-sm">
                                        <li><strong>Multiple Goal Support:</strong> Split total savings across various objectives</li>
                                        <li><strong>Flexible Reallocation:</strong> Move money between goals as priorities change</li>
                                        <li><strong>Unallocated Buffer:</strong> Keep some savings unassigned for new opportunities</li>
                                        <li><strong>Debt Integration:</strong> Net worth calculation factors in total debt automatically</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Goal Editing & Management</h4>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Real-time Updates:</strong> Changes instantly reflect across all tabs and dashboards</li>
                                    <li><strong>Validation Logic:</strong> Prevents over-allocation beyond available savings</li>
                                    <li><strong>Timeline Recalculation:</strong> Automatic timeline updates when allocations change</li>
                                    <li><strong>Cross-tab Synchronization:</strong> Consistent data display in Overview and Insights tabs</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">⚙️ Settings & Data Management</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Banking Configuration</h4>
                                    <ul class="list-disc ml-5 space-y-1 text-sm">
                                        <li><strong>Plaid Integration:</strong> Secure bank account connections</li>
                                        <li><strong>Backend Server:</strong> Node.js/Express on localhost:8000</li>
                                        <li><strong>API Credentials:</strong> Plaid sandbox/development keys required</li>
                                        <li><strong>Token Management:</strong> Secure access token storage and refresh</li>
                                    </ul>
                                </div>

                                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Personalization</h4>
                                    <ul class="list-disc ml-5 space-y-1 text-sm">
                                        <li><strong>Currency Support:</strong> Multiple currency display options</li>
                                        <li><strong>Theme Toggle:</strong> Light/dark mode with system preference detection</li>
                                        <li><strong>Notification Settings:</strong> Customizable alerts and reminders</li>
                                        <li><strong>Display Preferences:</strong> Chart types, dashboard layout options</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Data Management & Privacy</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <strong>Local Storage:</strong>
                                        <ul class="list-disc ml-5 space-y-1 mt-1">
                                            <li>All financial data stored in browser localStorage</li>
                                            <li>No server-side personal data storage</li>
                                            <li>Automatic data persistence across sessions</li>
                                            <li>Clear browser data will erase all records</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <strong>Backup & Recovery:</strong>
                                        <ul class="list-disc ml-5 space-y-1 mt-1">
                                            <li><strong>JSON Export:</strong> Complete data backup capability</li>
                                            <li><strong>Import Restoration:</strong> Restore from previous exports</li>
                                            <li><strong>Regular Exports:</strong> Recommended weekly backup schedule</li>
                                            <li><strong>Version Control:</strong> Date-stamped export files</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Security & Privacy Considerations</h4>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Bank Credentials:</strong> Never stored locally - only secure Plaid tokens</li>
                                    <li><strong>Data Encryption:</strong> Banking tokens encrypted in transit</li>
                                    <li><strong>Local-Only Storage:</strong> Personal financial data remains on your device</li>
                                    <li><strong>No Analytics:</strong> No third-party tracking or data collection</li>
                                    <li><strong>PWA Security:</strong> Service worker caching with secure resource handling</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">🔧 Technical Requirements</h3>
                        <div class="space-y-4">
                            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Frontend (PWA)</h4>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Modern Browser:</strong> Chrome 90+, Firefox 88+, Safari 14+, Edge 90+</li>
                                    <li><strong>JavaScript:</strong> ES6+ features required</li>
                                    <li><strong>Local Storage:</strong> Minimum 10MB available space</li>
                                    <li><strong>PWA Support:</strong> Service workers and manifest support</li>
                                </ul>
                            </div>

                            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Backend (Optional Banking)</h4>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li><strong>Node.js:</strong> Version 16+ with Express framework</li>
                                    <li><strong>Plaid API:</strong> Sandbox or development credentials</li>
                                    <li><strong>CORS Configuration:</strong> Localhost frontend access</li>
                                    <li><strong>Environment Variables:</strong> Secure API key management</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
            <div class="flex justify-center p-4">
                <button onclick="closeHelpModal()" class="modern-button modern-button-primary w-56">Close</button>
            </div>
        </div>
    </div>

    <!-- Income Breakdown Modal -->
    <div id="income-modal" onclick="closeIncomeModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-sm w-full">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold">Income Breakdown</h3>
                <button onclick="closeIncomeModal()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            <div id="income-breakdown-content" class="p-6 space-y-3 text-sm">
                <!-- Dynamic content will be generated here by JavaScript -->
            </div>
            <div class="flex justify-center p-4">
                <button onclick="closeIncomeModal()" class="modern-button modern-button-primary w-56">Close</button>
            </div>
        </div>
    </div>

    <!-- Goals Modal -->
<div id="goals-modal" onclick="closeGoalsModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
    <div onclick="event.stopPropagation()" class="onboarding-modal w-full overflow-y-auto">
        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold">Your Goals</h3>
            <button onclick="closeGoalsModal()" class="icon-button text-2xl leading-none">&times;</button>
        </div>
        <div id="goals-content" class="p-6">
            <!-- Goals will be populated here -->
        </div>
        <div class="flex justify-start p-4 gap-3">
            <button onclick="showGoalSelection()" class="modern-button modern-button-secondary">Add Goals</button>
            <button onclick="closeGoalsModal()" class="modern-button modern-button-primary">Close</button>
        </div>
    </div>
</div>

<!-- Goal Editing Modal -->
<div id="goal-editing-modal" onclick="closeGoalEditingModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
    <div onclick="event.stopPropagation()" class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto relative">
        <!-- Confirmation Overlay (within goal editing modal) -->
        <div id="goal-confirmation-overlay" class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-10 hidden">
            <div class="card max-w-md w-full">
                <div class="p-6 text-center">
                    <div class="text-4xl mb-4" id="confirmation-icon">⚠️</div>
                    <h3 class="text-lg font-semibold mb-2" id="confirmation-title">Confirm Action</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6" id="confirmation-message">Are you sure you want to proceed?</p>
                    <div class="flex gap-3 justify-start">
                        <button onclick="cancelConfirmation()" class="modern-button modern-button-secondary px-6">Cancel</button>
                        <button id="confirmation-button" onclick="confirmAction()" class="modern-button px-6">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold">Edit Your Goals</h3>
            <button onclick="closeGoalEditingModal()" class="icon-button text-2xl leading-none">&times;</button>
        </div>
        <div id="goal-editing-content" class="p-6">
            <!-- Goal editing interface will be populated here -->
        </div>
        <div class="flex justify-between p-4 border-t border-gray-200 dark:border-gray-700">
            <button onclick="addNewGoal()" class="modern-button modern-button-secondary" data-tour="add-new-goal">Add New Goal</button>
            <div class="space-x-3">
                <button onclick="closeGoalEditingModal()" class="modern-button modern-button-secondary">Cancel</button>
                <button onclick="saveGoalEdits()" class="modern-button modern-button-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>


    <!-- Clean Modern Onboarding Modal -->
<div id="clean-onboarding-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-2 sm:p-4 z-50 hidden fade-in">
    <div class="onboarding-modal w-full">
        <!-- Progress Bar -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-600">
            <div class="progress-bar mb-2">
                <div id="clean-progress-fill" class="progress-fill" style="width: 20%"></div>
            </div>
            <div class="text-center text-sm text-gray-600 dark:text-gray-400">
                <span id="clean-step-indicator">Step 1 of 5</span>
            </div>
        </div>

        <!-- Step 1: Income & Budget -->
        <div id="clean-step-1" class="clean-onboarding-step p-6">
            <h2 class="text-xl font-semibold mb-2 text-center">Welcome to Lens</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Let's start with your monthly finances</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Monthly Income</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                        <input type="number" id="clean-income-input" placeholder="3,500" class="modern-input pl-6 pr-4 font-semibold">
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">Your monthly income after tax</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Monthly Spending</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                        <input type="number" id="clean-budget-input" placeholder="2,800" class="modern-input pl-6 pr-4 font-semibold">
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">How much you spend each month on bills, food, etc.</div>
                </div>
            </div>
        </div>

        <!-- Step 2: Goal Selection -->
        <div id="clean-step-2" class="clean-onboarding-step p-6 hidden">
            <h2 class="text-xl font-semibold mb-2 text-center">What's Your Main Goal?</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Choose your primary financial focus</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="house">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">🏠</div>
                        <h3 class="font-medium text-sm sm:text-base">House Deposit</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="emergency">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">💰</div>
                        <h3 class="font-medium text-sm sm:text-base">Emergency Fund</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="debt">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">💳</div>
                        <h3 class="font-medium text-sm sm:text-base">Pay Off Debt</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="vacation">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">✈️</div>
                        <h3 class="font-medium text-sm sm:text-base">Vacation</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="investment">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">📈</div>
                        <h3 class="font-medium text-sm sm:text-base">Investing</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="custom">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">🎯</div>
                        <h3 class="font-medium text-sm sm:text-base">Custom Goal</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Complete Goal Planning (MERGED 3A+3B+3C) -->
        <div id="clean-step-3" class="clean-onboarding-step p-6 hidden">
            <div id="clean-complete-goal-content">
                <!-- Will be populated by prepareCompleteGoalPlanning() -->
            </div>
        </div>

        <!-- Step 4: Financial Position & Debt (MERGED debt + savings) -->
        <div id="clean-step-4" class="clean-onboarding-step p-6 hidden">
            <div id="clean-financial-position-content">
                <!-- Will be populated by prepareFinancialPosition() -->
            </div>
        </div>

        <!-- Step 5: Goal Activation (ENHANCED) -->
        <div id="clean-step-5" class="clean-onboarding-step p-6 hidden">
            <div id="clean-goal-activation-content">
                <!-- Will be populated by prepareGoalActivation() -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-between items-center p-6 border-t border-gray-200 dark:border-gray-600">
            <button id="clean-back-btn" onclick="goCleanBack()" class="modern-button modern-button-secondary min-w-[120px] sm:min-w-[140px]">← Back</button>
            <div class="flex gap-3">
                <button onclick="skipOnboarding()" class="modern-button modern-button-outline min-w-[120px] sm:min-w-[140px]">Skip Setup</button>
                <button id="clean-next-btn" onclick="goCleanNext()" class="modern-button modern-button-primary min-w-[120px] sm:min-w-[140px]">Next →</button>
            </div>
        </div>
    </div>
</div>

    <!-- Toast notification container for user feedback messages -->
    <div id="toast" class="toast"></div>

    <!-- Driver.js library for interactive user onboarding tours -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    
    <script>
        /**
         * Authentication Manager Class
         * Handles user authentication, session management, and token refresh
         * Note: Google OAuth functionality has been disabled
         */
        class AuthManager {
            constructor() {
                // Backend API endpoint for authentication services
                this.baseURL = 'http://localhost:8000';
                // Current authenticated user object
                this.currentUser = null;
                // JWT access token for API requests
                this.accessToken = null;
                // Refresh token for obtaining new access tokens
                this.refreshToken = null;
                // Google OAuth initialization flag (currently disabled)
                this.googleInitialized = false;
                this.googleClientId = null;
                
                this.init();
            }
            
            /**
             * Initialize authentication state from stored session
             * Verifies existing tokens and refreshes if necessary
             */
            async init() {
                // Restore tokens from localStorage if available
                this.loadTokensFromStorage();
                
                // Validate existing session
                if (this.refreshToken) {
                    try {
                        await this.verifyToken();
                    } catch (error) {
                        console.log('Token verification failed, user needs to login');
                        this.clearSession();
                    }
                }
            }
            
            /**
             * Register new user account
             * @param {string} email - User email address
             * @param {string} password - User password
             * @param {string} name - User display name
             * @returns {Promise<Object>} User data and authentication tokens
             */
            async register(email, password, name) {
                try {
                    const response = await fetch(`${this.baseURL}/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password, name })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        let errorMessage = data.error || 'Registration failed';
                        if (data.details && Array.isArray(data.details)) {
                            const detailsList = data.details.map(err => `• ${err.msg}`).join('\n');
                            errorMessage = `Validation failed:\n\n${detailsList}`;
                        }
                        throw new Error(errorMessage);
                    }
                    
                    this.setSession(data.user, data.accessToken, data.refreshToken);
                    await this.migrateLocalStorageData();
                    return data;
                } catch (error) {
                    console.error('Registration error:', error);
                    throw error;
                }
            }
            
            async login(email, password) {
                try {
                    const response = await fetch(`${this.baseURL}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        let errorMessage = data.error || 'Login failed';
                        if (data.details && Array.isArray(data.details)) {
                            const detailsList = data.details.map(err => `• ${err.msg}`).join('\n');
                            errorMessage = `Validation failed:\n\n${detailsList}`;
                        }
                        throw new Error(errorMessage);
                    }
                    
                    this.setSession(data.user, data.accessToken, data.refreshToken);
                    await this.migrateLocalStorageData();
                    return data;
                } catch (error) {
                    console.error('Login error:', error);
                    throw error;
                }
            }
            
            // handleGoogleAuth method removed - Google authentication disabled
            
            async verifyToken() {
                try {
                    const response = await fetch(`${this.baseURL}/auth/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ refreshToken: this.refreshToken })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Token verification failed');
                    }
                    
                    this.setSession(data.user, data.accessToken, data.refreshToken);
                    return data;
                } catch (error) {
                    console.error('Token verification error:', error);
                    throw error;
                }
            }
            
            async logout() {
                this.clearSession();
                // showAuthModal call removed - authentication disabled
                this.showSuccessMessage('Successfully logged out');
            }
            
            // Session Management
            setSession(user, accessToken, refreshToken) {
                this.currentUser = user;
                this.accessToken = accessToken;
                this.refreshToken = refreshToken;
                
                localStorage.setItem('authManager_accessToken', accessToken);
                localStorage.setItem('authManager_refreshToken', refreshToken);
                localStorage.setItem('authManager_user', JSON.stringify(user));
            }
            
            clearSession() {
                this.currentUser = null;
                this.accessToken = null;
                this.refreshToken = null;
                
                localStorage.removeItem('authManager_accessToken');
                localStorage.removeItem('authManager_refreshToken');
                localStorage.removeItem('authManager_user');
            }
            
            loadTokensFromStorage() {
                this.accessToken = localStorage.getItem('authManager_accessToken');
                this.refreshToken = localStorage.getItem('authManager_refreshToken');
                const userStr = localStorage.getItem('authManager_user');
                if (userStr) {
                    try {
                        this.currentUser = JSON.parse(userStr);
                    } catch (error) {
                        console.error('Error parsing stored user data:', error);
                    }
                }
            }
            
            // User Data Storage Methods (replacing localStorage)
            async setUserData(key, value) {
                if (!this.currentUser) {
                    console.warn(`Cannot save ${key}: User not authenticated`);
                    return;
                }
                
                try {
                    // For now, store locally with user prefix while implementing cloud sync
                    const userKey = `user_${this.currentUser._id}_${key}`;
                    localStorage.setItem(userKey, JSON.stringify(value));
                    
                    // TODO: Sync to cloud storage
                    // await this.syncToCloud(key, value);
                } catch (error) {
                    console.error(`Error saving ${key}:`, error);
                }
            }
            
            getUserData(key, defaultValue = null) {
                if (!this.currentUser) {
                    // If not authenticated, try to get old localStorage data for migration
                    const oldValue = localStorage.getItem(key);
                    if (oldValue) {
                        try {
                            return JSON.parse(oldValue);
                        } catch (error) {
                            return oldValue;
                        }
                    }
                    return defaultValue;
                }
                
                try {
                    const userKey = `user_${this.currentUser._id}_${key}`;
                    const value = localStorage.getItem(userKey);
                    if (value === null) return defaultValue;
                    
                    try {
                        return JSON.parse(value);
                    } catch (error) {
                        return value;
                    }
                } catch (error) {
                    console.error(`Error loading ${key}:`, error);
                    return defaultValue;
                }
            }
            
            // Data Migration from old localStorage
            async migrateLocalStorageData() {
                if (!this.currentUser) return;
                
                const keysToMigrate = [
                    'expenses',
                    'recurringItems', 
                    'monthlyBudget',
                    'monthlyIncome',
                    'userGoals',
                    'totalSavings',
                    'totalDebt'
                ];
                
                let hasMigrated = false;
                
                for (const key of keysToMigrate) {
                    const oldValue = localStorage.getItem(key);
                    const userKey = `user_${this.currentUser._id}_${key}`;
                    const userValue = localStorage.getItem(userKey);
                    
                    // Only migrate if old value exists and user value doesn't
                    if (oldValue && !userValue) {
                        try {
                            localStorage.setItem(userKey, oldValue);
                            hasMigrated = true;
                        } catch (error) {
                            console.error(`Error migrating ${key}:`, error);
                        }
                    }
                }
                
                if (hasMigrated) {
                    console.log('Successfully migrated data to user-specific storage');
                    
                    // Ask user if they want to clear old data
                    if (confirm('Your data has been migrated to your user account. Would you like to clear the old local data?')) {
                        keysToMigrate.forEach(key => localStorage.removeItem(key));
                    }
                }
            }
            
            // Authentication Status
            isAuthenticated() {
                return !!this.currentUser && !!this.accessToken;
            }
            
            getUser() {
                return this.currentUser;
            }
            
            // API Helper
            async authenticatedFetch(url, options = {}) {
                if (!this.accessToken) {
                    throw new Error('Not authenticated');
                }
                
                const headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${this.accessToken}`,
                    'Content-Type': 'application/json'
                };
                
                let response = await fetch(url, { ...options, headers });
                
                // If token expired, try to refresh
                if (response.status === 401 && this.refreshToken) {
                    try {
                        await this.verifyToken();
                        headers['Authorization'] = `Bearer ${this.accessToken}`;
                        response = await fetch(url, { ...options, headers });
                    } catch (error) {
                        this.clearSession();
                        // showAuthModal call removed - authentication disabled
                        throw new Error('Session expired. Please log in again.');
                    }
                }
                
                return response;
            }
            
            // UI Methods - authentication modal methods removed
            
            // createAuthModal method removed - authentication system disabled
            
            // setupAuthModalEvents method removed - authentication system disabled
            
            // Helper methods for loading states and messages
            setLoading(button, type, loading) {
                const textEl = button.querySelector(`.${type}-text`);
                const loadingEl = button.querySelector(`.${type}-loading`);
                
                if (loading) {
                    button.disabled = true;
                    textEl.classList.add('hidden');
                    loadingEl.classList.remove('hidden');
                } else {
                    button.disabled = false;
                    textEl.classList.remove('hidden');
                    loadingEl.classList.add('hidden');
                }
            }
            
            clearMessages() {
                const messageEl = document.getElementById('authMessage');
                if (messageEl) {
                    messageEl.classList.add('hidden');
                    messageEl.textContent = '';
                }
            }
            
            validatePassword(password) {
                const requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /\d/.test(password),
                    special: /[@$!%*?&]/.test(password)
                };
                
                Object.keys(requirements).forEach(req => {
                    const element = document.getElementById(`req-${req}`);
                    const indicator = element?.querySelector('.req-indicator');
                    const checkIcon = element?.querySelector('.check-icon');
                    const textSpan = element?.querySelector('span:last-child');
                    
                    if (requirements[req]) {
                        indicator?.classList.remove('border-gray-300');
                        indicator?.classList.add('border-green-500', 'bg-green-500');
                        checkIcon?.classList.remove('hidden');
                        textSpan?.classList.remove('text-gray-500', 'dark:text-gray-400');
                        textSpan?.classList.add('text-green-600', 'dark:text-green-400');
                    } else {
                        indicator?.classList.remove('border-green-500', 'bg-green-500');
                        indicator?.classList.add('border-gray-300');
                        checkIcon?.classList.add('hidden');
                        textSpan?.classList.remove('text-green-600', 'dark:text-green-400');
                        textSpan?.classList.add('text-gray-500', 'dark:text-gray-400');
                    }
                });
                
                return Object.values(requirements).every(req => req);
            }
            
            showSuccessMessage(message) {
                // You can integrate this with your existing toast/notification system
                console.log('Success:', message);
                
                // Simple temporary implementation
                const messageEl = document.getElementById('authMessage');
                if (messageEl) {
                    messageEl.className = 'mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-800';
                    messageEl.textContent = message;
                    messageEl.classList.remove('hidden');
                }
            }
            
            showErrorMessage(message) {
                console.error('Auth Error:', message);
                
                const messageEl = document.getElementById('authMessage');
                if (messageEl) {
                    messageEl.className = 'mt-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-800 dark:text-red-200';
                    
                    // Format validation errors nicely
                    if (typeof message === 'string' && message.includes('Validation failed')) {
                        // Convert newlines to HTML breaks for better display
                        const formattedMessage = message.replace(/\n/g, '<br>');
                        messageEl.innerHTML = formattedMessage;
                    } else if (message.includes('Password must contain')) {
                        messageEl.innerHTML = '<strong>Password Requirements:</strong><br>• At least 8 characters<br>• One uppercase letter (A-Z)<br>• One lowercase letter (a-z)<br>• One number (0-9)<br>• One special character (@$!%*?&)';
                    } else {
                        messageEl.textContent = message;
                    }
                    
                    messageEl.classList.remove('hidden');
                }
            }
        }
        
        // Initialize AuthManager
        const authManager = new AuthManager();
        
        // === SUBSCRIPTION MANAGER ===
        class SubscriptionManager {
            constructor() {
                this.subscriptionData = null;
                this.featureAccess = null;
                this.isInitialized = false;
            }
            
            async init() {
                if (!authManager.isAuthenticated()) {
                    // Set free tier defaults for unauthenticated users
                    this.setFreeTierDefaults();
                    return;
                }
                
                try {
                    await this.loadSubscriptionStatus();
                    this.isInitialized = true;
                } catch (error) {
                    console.error('Failed to load subscription status:', error);
                    this.setFreeTierDefaults();
                }
            }
            
            setFreeTierDefaults() {
                this.subscriptionData = {
                    tier: 'free',
                    status: null
                };
                this.featureAccess = {
                    manualExpenseEntry: true,
                    basicBudgetTracking: true,
                    dailyBudgetBasic: true,
                    financialHealthScore: true,
                    mobilePWA: true,
                    bankConnections: 0,
                    goals: 2,
                    recurringTransactions: 5,
                    transactionHistory: 180,
                    categories: 12,
                    exports: 1,
                    advancedInsights: false,
                    aiCoaching: false,
                    pointsOptimization: false,
                    customGoalTypes: false,
                    prioritySupport: false
                };
                this.isInitialized = true;
            }
            
            async loadSubscriptionStatus() {
                const response = await fetch('/subscription-status', {
                    headers: {
                        'Authorization': `Bearer ${authManager.getAccessToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load subscription status');
                }
                
                const data = await response.json();
                this.subscriptionData = data.subscription;
                this.featureAccess = data.features;
            }
            
            isPremium() {
                return this.subscriptionData?.tier === 'premium' && 
                       this.subscriptionData?.status === 'active';
            }
            
            hasFeature(featureName) {
                if (!this.isInitialized) return false;
                return this.featureAccess[featureName] === true || 
                       this.featureAccess[featureName] === 'unlimited';
            }
            
            getFeatureLimit(featureName) {
                if (!this.isInitialized) return 0;
                const access = this.featureAccess[featureName];
                return access === 'unlimited' ? Infinity : (access || 0);
            }
            
            async showUpgradeModal(feature = null) {
                const modal = document.createElement('div');
                modal.id = 'upgrade-modal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeUpgradeModal()"></div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 relative z-10">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">Upgrade to Premium</h3>
                                <button onclick="closeUpgradeModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            ${feature ? `<div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <p class="text-sm text-blue-800 dark:text-blue-200">
                                    <strong>${this.getFeatureDisplayName(feature)}</strong> requires a Premium subscription.
                                </p>
                            </div>` : ''}
                            
                            <div class="mb-6">
                                <div class="text-center mb-4">
                                    <div class="text-3xl font-bold text-blue-600">£9.99</div>
                                    <div class="text-gray-600 dark:text-gray-400">per month</div>
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        </div>
                                        <span class="text-sm">Unlimited bank connections</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        </div>
                                        <span class="text-sm">AI-powered daily budget coaching</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        </div>
                                        <span class="text-sm">Advanced insights & analytics</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        </div>
                                        <span class="text-sm">Unlimited goals & categories</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        </div>
                                        <span class="text-sm">Credit card points optimization</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="closeUpgradeModal()" class="flex-1 modern-button modern-button-secondary">
                                    Maybe Later
                                </button>
                                <button onclick="subscriptionManager.startSubscription()" class="flex-1 modern-button modern-button-primary">
                                    Upgrade Now
                                </button>
                            </div>
                            
                            <!-- Test Login Button (Remove in production) -->
                            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <button onclick="testLogin()" class="w-full text-xs text-gray-600 hover:text-gray-700 font-medium">
                                    🧪 Test Login (Development Only)
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            getFeatureDisplayName(feature) {
                const names = {
                    bankConnections: 'Bank Connections',
                    advancedInsights: 'Advanced Insights',
                    aiCoaching: 'Smart Coaching',
                    pointsOptimization: 'Points Optimization',
                    customGoalTypes: 'Custom Goals'
                };
                return names[feature] || feature;
            }
            
            async startSubscription() {
                // Authentication check removed - subscription available without login
                // if (!authManager.isAuthenticated()) {
                //     authManager.showAuthModal();
                //     return;
                // }
                
                try {
                    showToast('Redirecting to checkout...', 'info');
                    
                    const response = await fetch('/subscribe', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authManager.getAccessToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to create checkout session');
                    }
                    
                    const { url } = await response.json();
                    window.location.href = url;
                } catch (error) {
                    console.error('Subscription error:', error);
                    showToast('Failed to start subscription. Please try again.', 'error');
                }
            }
            
            showFeatureLimit(featureName, currentCount = null) {
                const limit = this.getFeatureLimit(featureName);
                const displayName = this.getFeatureDisplayName(featureName);
                
                let message = `You've reached the limit for ${displayName}.`;
                if (currentCount !== null && limit !== Infinity) {
                    message = `You've used ${currentCount} of ${limit} ${displayName}.`;
                }
                
                this.showUpgradeModal(featureName);
            }
        }
        
        const subscriptionManager = new SubscriptionManager();
        
        // Update subscription status badge in header
        function updateSubscriptionBadge() {
            const badge = document.getElementById('subscription-badge');
            if (!badge || !subscriptionManager.isInitialized) return;
            
            if (subscriptionManager.isPremium()) {
                badge.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-medium rounded-full">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                        </svg>
                        <span class="hidden sm:inline">Premium</span>
                    </div>
                `;
                badge.classList.remove('hidden');
            } else {
                badge.innerHTML = `
                    <button onclick="subscriptionManager.showUpgradeModal()" 
                            class="flex items-center gap-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-full transition-colors">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span class="hidden sm:inline">Upgrade</span>
                    </button>
                `;
                badge.classList.remove('hidden');
            }
        }
        
        // === DAILY BUDGET COACHING SYSTEM ===
        class DailyBudgetCoach {
            constructor() {
                this.isInitialized = false;
                this.coachingEnabled = true;
                this.lastNotificationTime = 0;
                this.notificationCooldown = 300000; // 5 minutes
            }
            
            init() {
                this.calculateDailyBudget();
                this.updateTodaySpent();
                this.isInitialized = true;
                console.log('Daily Budget Coach initialized');
            }
            
            calculateDailyBudget() {
                if (dailyBudgetOverride && dailyBudget) {
                    return dailyBudget; // User has set custom daily budget
                }
                // Auto-calculate from monthly budget
                dailyBudget = Math.round((monthlyBudget / 30) * 100) / 100;
                return dailyBudget;
            }
            
            updateTodaySpent() {
                const today = new Date().toISOString().split('T')[0];
                todaySpent = this.getDaySpending(today);
                
                // Update daily spending history
                dailySpendingHistory[today] = todaySpent;
                
                return todaySpent;
            }
            
            getDaySpending(dateStr) {
                return expenses
                    .filter(expense => expense.date === dateStr)
                    .reduce((sum, expense) => sum + expense.amount, 0);
            }
            
            getRemainingDailyBudget() {
                this.updateTodaySpent();
                return Math.max(0, dailyBudget - todaySpent);
            }
            
            getDailyBudgetProgress() {
                if (!dailyBudget || dailyBudget === 0) return 0;
                return Math.min(100, (todaySpent / dailyBudget) * 100);
            }
            
            // FREE TIER: Basic daily budget tracking
            renderBasicDailyTracker() {
                const today = new Date().toISOString().split('T')[0];
                this.updateTodaySpent();
                const remaining = this.getRemainingDailyBudget();
                const progress = this.getDailyBudgetProgress();
                
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-semibold text-gray-800 dark:text-gray-200">Today's Budget</h3>
                            <span class="text-sm text-gray-600 dark:text-gray-400">${today}</span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm">Spent: £${todaySpent.toFixed(2)}</span>
                                <span class="text-sm">Budget: £${dailyBudget.toFixed(2)}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${Math.min(100, progress)}%"></div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            ${remaining > 0 
                                ? `<div class="text-green-600 font-medium">£${remaining.toFixed(2)} remaining</div>`
                                : `<div class="text-red-600 font-medium">£${Math.abs(remaining).toFixed(2)} over budget</div>`
                            }
                        </div>
                        
                        ${!subscriptionManager.isPremium() ? `
                            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <button onclick="subscriptionManager.showUpgradeModal('aiCoaching')" 
                                        class="w-full text-xs text-blue-600 hover:text-blue-700 font-medium">
                                    ✨ Upgrade for smart coaching & insights
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // PREMIUM TIER: Smart coaching and insights
            renderPremiumCoaching() {
                if (!subscriptionManager.isPremium()) {
                    return this.renderBasicDailyTracker();
                }
                
                const insights = this.generateSmartInsights();
                const weekPerformance = this.getWeekPerformance();
                
                return `
                    <div class="space-y-4">
                        ${this.renderBasicDailyTracker()}
                        
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-700">
                            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">💡 Smart Insights</h4>
                            <div class="space-y-2 text-sm text-blue-700 dark:text-blue-300">
                                ${insights.map(insight => `<div>• ${insight}</div>`).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                            <h4 class="font-semibold mb-3">Week Performance</h4>
                            <div class="grid grid-cols-7 gap-1">
                                ${weekPerformance.map(day => `
                                    <div class="text-center">
                                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">${day.day}</div>
                                        <div class="w-full h-8 ${day.status === 'over' ? 'bg-red-100 dark:bg-red-900/30' : 
                                                                   day.status === 'good' ? 'bg-green-100 dark:bg-green-900/30' :
                                                                   'bg-gray-100 dark:bg-gray-700'} rounded flex items-center justify-center">
                                            <span class="text-xs font-medium ${day.status === 'over' ? 'text-red-600 dark:text-red-400' :
                                                                                day.status === 'good' ? 'text-green-600 dark:text-green-400' :
                                                                                'text-gray-600 dark:text-gray-400'}">
                                                ${day.status === 'future' ? '-' : '£' + day.spent.toFixed(0)}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            generateSmartInsights() {
                const insights = [];
                const progress = this.getDailyBudgetProgress();
                const remaining = this.getRemainingDailyBudget();
                const weekData = this.getWeeklySpendingData();
                
                // Progress-based insights
                if (progress > 100) {
                    insights.push(`You're £${Math.abs(remaining).toFixed(2)} over today's budget. Consider skipping non-essentials.`);
                } else if (progress > 80) {
                    insights.push(`You've used ${progress.toFixed(0)}% of today's budget. Proceed with caution!`);
                } else if (progress < 50) {
                    insights.push(`Great self-control! You've only spent ${progress.toFixed(0)}% of today's budget.`);
                }
                
                // Weekly pattern insights
                if (weekData.weekendOverspend > 1.5) {
                    insights.push(`Your weekend spending is ${(weekData.weekendOverspend * 100).toFixed(0)}% higher than weekdays.`);
                }
                
                if (weekData.averageDaily > dailyBudget * 1.2) {
                    insights.push(`This week you're averaging £${weekData.averageDaily.toFixed(2)}/day - consider reducing to £${dailyBudget.toFixed(2)}.`);
                }
                
                // Goal-related insights
                if (monthlyBudget && monthlyIncome) {
                    const projectedMonthlySpend = weekData.averageDaily * 30;
                    const monthlySurplus = monthlyIncome - projectedMonthlySpend;
                    if (monthlySurplus > 0) {
                        insights.push(`At this pace, you'll save £${monthlySurplus.toFixed(0)} this month! Consider increasing goal contributions.`);
                    }
                }
                
                return insights.slice(0, 3); // Limit to top 3 insights
            }
            
            getWeekPerformance() {
                const performance = [];
                const today = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const dayName = date.toLocaleDateString('en', { weekday: 'short' });
                    const spent = this.getDaySpending(dateStr);
                    
                    let status = 'future';
                    if (date <= today) {
                        status = spent > dailyBudget ? 'over' : spent > dailyBudget * 0.8 ? 'warning' : 'good';
                    }
                    
                    performance.push({
                        day: dayName,
                        date: dateStr,
                        spent: spent,
                        status: status
                    });
                }
                
                return performance;
            }
            
            getWeeklySpendingData() {
                const last7Days = [];
                const today = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const spent = this.getDaySpending(dateStr);
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    
                    last7Days.push({ date: dateStr, spent, isWeekend });
                }
                
                const weekdaySpend = last7Days.filter(d => !d.isWeekend).reduce((sum, d) => sum + d.spent, 0);
                const weekendSpend = last7Days.filter(d => d.isWeekend).reduce((sum, d) => sum + d.spent, 0);
                const averageWeekday = weekdaySpend / last7Days.filter(d => !d.isWeekend).length;
                const averageWeekend = weekendSpend / last7Days.filter(d => d.isWeekend).length;
                
                return {
                    averageDaily: last7Days.reduce((sum, d) => sum + d.spent, 0) / 7,
                    weekendOverspend: averageWeekend / (averageWeekday || 1),
                    totalWeekSpend: last7Days.reduce((sum, d) => sum + d.spent, 0)
                };
            }
            
            // Real-time coaching intervention before expense entry
            checkSpendingIntervention(proposedAmount) {
                if (!subscriptionManager.isPremium()) return null;
                
                const newTotal = todaySpent + proposedAmount;
                const overBudget = newTotal - dailyBudget;
                
                if (overBudget > 0) {
                    return {
                        type: 'warning',
                        message: `This will put you £${overBudget.toFixed(2)} over today's budget.`,
                        suggestion: 'Consider if this purchase is essential today.'
                    };
                }
                
                if (newTotal > dailyBudget * 0.8) {
                    const remaining = dailyBudget - newTotal;
                    return {
                        type: 'caution',
                        message: `You'll have £${remaining.toFixed(2)} left for today.`,
                        suggestion: 'You\'re on track - just be mindful of remaining spending.'
                    };
                }
                
                return null;
            }
            
            // Called after expense is added
            onExpenseAdded(expense) {
                this.updateTodaySpent();
                
                // Show appropriate feedback
                const progress = this.getDailyBudgetProgress();
                
                if (subscriptionManager.isPremium()) {
                    if (progress > 100) {
                        this.showCoachingMessage('Over budget! Consider reviewing your spending priorities.', 'warning');
                    } else if (progress < 50 && todaySpent > 0) {
                        const streak = this.getUnderBudgetStreak();
                        if (streak >= 3) {
                            this.showCoachingMessage(`Amazing! ${streak} days under budget. You're crushing your goals! 🎉`, 'success');
                        }
                    }
                }
                
                // Update daily budget display
                this.refreshDailyBudgetDisplay();
            }
            
            getUnderBudgetStreak() {
                let streak = 0;
                const today = new Date();
                
                for (let i = 0; i < 30; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const spent = this.getDaySpending(dateStr);
                    
                    if (spent <= dailyBudget && spent > 0) {
                        streak++;
                    } else if (spent > 0) {
                        break;
                    }
                }
                
                return streak;
            }
            
            showCoachingMessage(message, type = 'info') {
                const now = Date.now();
                if (now - this.lastNotificationTime < this.notificationCooldown) {
                    return; // Avoid spam
                }
                
                showToast(message, type);
                this.lastNotificationTime = now;
            }
            
            refreshDailyBudgetDisplay() {
                const container = document.getElementById('daily-budget-container');
                if (container) {
                    container.innerHTML = subscriptionManager.isPremium() ? 
                        this.renderPremiumCoaching() : 
                        this.renderBasicDailyTracker();
                }
            }
        }
        
        const dailyBudgetCoach = new DailyBudgetCoach();
        
        /**
         * Global Application State Management
         * Core data structures that power the entire application
         */
        
        // Financial transaction arrays
        let expenses = [];              // Array of expense objects with amount, category, date, etc.
        let recurringItems = [];        // Array of recurring expenses (subscriptions, bills)
        
        // Selection state for bulk operations
        let selectedExpenseIds = new Set();     // IDs of selected expenses for bulk actions
        let selectedRecurringIds = new Set();   // IDs of selected recurring items
        
        // Editing state for forms
        let editingExpense = null;      // Currently editing expense object
        let editingRecurring = null;    // Currently editing recurring item
        
        // Financial configuration
        let monthlyBudget = 4000.00;    // User's monthly spending limit
        let monthlyIncome = 10000.00;   // User's monthly income
        let monthlyExpenses = 0;        // Calculated total of monthly expenses
        let totalSavings = 0;           // Total savings across all accounts
        let totalDebt = 0;              // Total debt amount
        
        // Daily budget tracking for real-time guidance
        let dailyBudget = null;         // Calculated as monthlyBudget / 30
        let dailyBudgetOverride = false; // Flag for manual daily budget override
        let todaySpent = 0;             // Today's total spending amount
        // Historical tracking for insights
        let dailySpendingHistory = {};  // Map of date strings to daily spending amounts
        let healthScoreHistory = {};    // Map of date strings to health scores
        
        // Pagination state for large data sets
        window.expensesCurrentPage = 1;
        window.expensesItemsPerPage = 25;     // Items per page for expense list
        window.recurringCurrentPage = 1;
        window.recurringItemsPerPage = 25;    // Items per page for recurring list
        // Currency configuration for multi-currency support
        let currencyConfig = {
            'AUD': { symbol: 'A$', locale: 'en-AU' },
            'CAD': { symbol: 'C$', locale: 'en-CA' },
            'EUR': { symbol: '€', locale: 'de-DE' },
            'GBP': { symbol: '£', locale: 'en-GB' },
            'JPY': { symbol: '¥', locale: 'ja-JP' },
            'USD': { symbol: '$', locale: 'en-US' }
        };
        // UI state management
        let currentCurrencyCode = 'GBP';       // Active currency for display
        let activeTab = 'overview';             // Current active tab in navigation
        let currentInsightsView = 'daily';      // Current view in insights tab
        
        // Chart.js instance references for updates and cleanup
        let spendingTrendChart = null;         // Main spending trend chart
        let categorySpendingChart = null;       // Category breakdown chart
        let monthlySavingsChart = null;         // Monthly savings progression
        let dailySpendingInsightsChart = null;  // Daily spending insights chart
        let sevenDayTrendChart = null;          // 7-day spending trend
        
        // Chart configuration and caching
        let currentInsightsPeriod = '7days';    // Period for insights display
        let chartPeriod = 30;                   // Default chart period in days
        let aiSavingsCache = null;              // Cached AI-generated savings insights
        let aiSpendingCache = null;             // Cached AI-generated spending insights
        let lastAiUpdate = 0;                   // Timestamp of last AI insight update
        /**
         * Goal System Configuration
         * Pre-defined goal templates for different financial personalities
         */
        let userGoals = [];  // Array of active user goals
        let goalTemplates = {
    'savings_builder': {
        name: 'Savings Builder',
        icon: '💰',
        description: 'Focus on building your savings and emergency fund',
        goals: [
            { type: 'savings_rate', name: 'Save 20% of income', target: 20, unit: 'percent' },
            { type: 'emergency_fund', name: 'Build £1000 emergency fund', target: 1000, unit: 'currency' },
            { type: 'no_spend_days', name: '6 no-spend days per month', target: 6, unit: 'days' }
        ]
    },
    'spending_controller': {
        name: 'Spending Controller', 
        icon: '📉',
        description: 'Take control of your spending habits',
        goals: [
            { type: 'category_limit', name: 'Dining out limit', target: 80, unit: 'currency', category: 'Food/Drink' },
            { type: 'impulse_limit', name: 'No purchases over £40', target: 40, unit: 'currency' },
            { type: 'subscription_review', name: 'Review subscriptions monthly', target: 1, unit: 'boolean' }
        ]
    },
    'mindful_spender': {
        name: 'Mindful Spender',
        icon: '🎯', 
        description: 'Develop healthy spending habits',
        goals: [
            { type: 'coffee_budget', name: 'Coffee budget £25/month', target: 25, unit: 'currency', category: 'Food/Drink', keywords: ['coffee'] },
            { type: 'cook_home', name: 'Cook at home 20 days/month', target: 20, unit: 'days' },
            { type: 'no_spend_days', name: '8 no-spend days per month', target: 8, unit: 'days' }
        ]
    },
    'debt_fighter': {
        name: 'Debt Fighter',
        icon: '⚔️',
        description: 'Aggressive debt reduction and spending cuts',
        goals: [
            { type: 'total_spending_limit', name: 'Total spending under budget by 15%', target: 15, unit: 'percent' },
            { type: 'entertainment_limit', name: 'Entertainment under £50', target: 50, unit: 'currency', category: 'Entertainment' },
            { type: 'no_spend_days', name: '10 no-spend days per month', target: 10, unit: 'days' }
        ]
    }
};

        /**
         * Utility function to extract date portion from ISO datetime string
         * @param {string} dateStr - ISO datetime string (e.g., '2024-01-15T10:30:00')
         * @returns {string} Date portion only (e.g., '2024-01-15')
         */
        function stripISO(dateStr) {
            return (dateStr || '').split('T')[0];
        }

        // Pre-defined expense categories for consistent classification
        const expenseCategories = ["Housing", "Utilities", "Transport", "Food/Drink", "Entertainment", "Shopping", "Health", "Personal Care", "Education", "Debt", "Subscriptions", "Other"];
        
        // Income categories for revenue tracking
        const incomeCategories = ["Salary", "Bonus", "Investment", "Gift", "Other Income"];

        // Keyword mapping for intelligent auto-categorization of transactions
        const categoryKeywords = {
            'Housing': ['rent', 'mortgage', 'property tax', 'home insurance'],
            'Utilities': ['gas', 'electricity', 'water', 'internet', 'phone', 'council tax'],
            'Transport': ['fuel', 'petrol', 'diesel', 'train', 'bus', 'tube', 'taxi', 'uber'],
            'Food/Drink': ['coffee', 'lunch', 'groceries', 'supermarket', 'restaurant', 'takeaway'],
            'Entertainment': ['cinema', 'concert', 'theatre', 'streaming', 'netflix', 'spotify', 'disney+'],
            'Shopping': ['clothes', 'electronics', 'gifts', 'amazon'],
            'Health': ['pharmacy', 'doctor', 'dentist', 'gym'],
            'Personal Care': ['haircut', 'toiletries'],
            'Education': ['books', 'course', 'tuition'],
            'Debt': ['loan', 'credit card'],
            'Subscriptions': ['subscription']
        };

        const essentialKeywords = [
            'rent', 'mortgage', 'property tax', 'home insurance', 'gas', 'electricity', 
            'water', 'internet', 'phone', 'council tax', 'fuel', 'petrol', 'diesel', 'train', 
            'bus', 'tube', 'groceries', 'supermarket', 'pharmacy', 'doctor', 'dentist', 
            'loan', 'credit card', 'tuition'
        ];

        // --- DOM Elements Cache ---
        let DOMElements = {};

        function cacheDOMElements() {
            DOMElements = {
            html: document.documentElement,
            // Modals & Forms
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            expenseName: document.getElementById('expense-name'),
            expenseCost: document.getElementById('expense-cost'),
            expenseType: document.getElementById('expense-type'),
            expenseCategory: document.getElementById('expense-category'),
            expenseDate: document.getElementById('expense-date'),
            expensePaymentMethod: document.getElementById('expense-payment-method'),
            modalCurrency: document.getElementById('modal-currency'),
            
            recurringModal: document.getElementById('recurring-modal'),
            recurringModalTitle: document.getElementById('recurring-modal-title'),
            recurringItemType: document.getElementById('recurring-item-type'),
            recurringName: document.getElementById('recurring-name'),
            recurringAmount: document.getElementById('recurring-amount'),
            recurringFrequency: document.getElementById('recurring-frequency'),
            recurringCategory: document.getElementById('recurring-category'),
            recurringEssentialTypeWrapper: document.getElementById('recurring-essential-type-wrapper'),
            recurringEssentialType: document.getElementById('recurring-essential-type'),
            recurringPaymentMethod: document.getElementById('recurring-payment-method'),
            recurringStartDate: document.getElementById('recurring-start-date'),
            recurringEndDate: document.getElementById('recurring-end-date'),
            recurringModalCurrency: document.getElementById('recurring-modal-currency'),

            monthlyBudgetDisplay: document.getElementById('monthly-budget'),
            budgetInput: document.getElementById('budget-input'),
            incomeInput: document.getElementById('income-input'),
            totalExpensesDisplay: document.getElementById('total-expenses'),
            remainingAmountDisplay: document.getElementById('remaining-amount'),
            totalIncomeDisplay: document.getElementById('total-income'),
            budgetBar: document.getElementById('budget-bar'),
            budgetPercentage: document.getElementById('budget-percentage'),
            healthScoreFill: document.getElementById('health-score-fill'),
            healthScoreValue: document.getElementById('health-score-value'),
            healthScoreLabel: document.getElementById('health-score-label'),
            essentialSpendingDisplay: document.getElementById('essential-spending'),
            nonEssentialSpendingDisplay: document.getElementById('non-essential-spending'),
            essentialBar: document.getElementById('essential-bar'),
            nonEssentialBar: document.getElementById('non-essential-bar'),
            recentExpensesContainer: document.getElementById('recent-expenses'),
            expensesTableBody: document.getElementById('expenses-table'),
            recurringTableBody: document.getElementById('recurring-table'),
            themeToggle: document.getElementById('theme-toggle'),
            themeToggleBtn: document.getElementById('theme-toggle-btn'),
            currencySelect: document.getElementById('currency-select'),
            toast: document.getElementById('toast'),
            
            spendingTrendCanvas: document.getElementById('spending-trend-chart'),
            categorySpendingCanvas: document.getElementById('category-spending-chart'),
            monthlySavingsCanvas: document.getElementById('monthly-savings-chart'),
            spendingInsightsContainer: document.getElementById('spending-insights'),
            aiSavingsInsightsContainer: document.getElementById('ai-savings-insights'),

            selectAllExpensesCheckbox: document.getElementById('select-all-expenses'),
            deleteSelectedBtn: document.getElementById('delete-selected-btn'),
            selectAllRecurringCheckbox: document.getElementById('select-all-recurring'),
            deleteSelectedRecurringBtn: document.getElementById('delete-selected-recurring-btn'),
            
            // New Health Score Elements
            healthScoreVisual: document.getElementById('health-score-visual'),
            healthScoreTrend: document.getElementById('health-score-trend'),
            healthScoreTooltip: document.getElementById('health-score-tooltip'),
            aiProjectionContainer: document.getElementById('ai-projection-container'),
            };
        }
        
        /**
         * Main Application Initialization
         * Sets up the app when DOM is ready, following proper initialization order
         */
        document.addEventListener('DOMContentLoaded', async function() {
            // Cache DOM elements for performance
            cacheDOMElements();
            
            // Apply saved theme to prevent flash of unstyled content
            applyTheme();
            
            // Initialize authentication and load user data
            await initializeApp();
        });
        
        // Initialize app with authentication check
        async function initializeApp() {
            try {
                // Wait for AuthManager to initialize
                let attempts = 0;
                while (!authManager && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!authManager) {
                    console.error('AuthManager failed to initialize');
                    return;
                }
                
                // Wait a bit more for token verification if needed
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Authentication check removed - allow direct access to main app
                console.log('Loading main app without authentication');
                
                // Initialize subscription and coaching systems
                await subscriptionManager.init();
                dailyBudgetCoach.init();
                updateSubscriptionBadge();
                
                // Continue with normal app initialization
                loadData();
                processRecurringExpenses();
                populateCategoryDropdowns();
                applyTheme();
                updateCurrencyUI();
                updateDisplay();
                restoreSidebarState();
                updateInsightsTiles();
                loadInsightsSettings();
                
                // Initialize goal progress markers
                initializeGoalMarkers();
                // Restore the last active tab, or default to overview
                const savedTab = localStorage.getItem('currentTab');
                const tabToShow = savedTab && ['overview', 'expenses', 'recurring', 'insights', 'settings', 'help'].includes(savedTab) ? savedTab : 'overview';
                showTab(tabToShow);
                DOMElements.expenseDate.value = getLocalDateString();
                DOMElements.recurringStartDate.value = getLocalDateString();

                // Add event listener for auto-categorization
                DOMElements.expenseName.addEventListener('input', autoCategorizeExpense);
                DOMElements.recurringName.addEventListener('input', autoCategorizeExpense);
                
                // startOnboardingProcess();
                
                // Add user info to UI
                addUserInfoToUI();
                
                // Final fallback to ensure recent expenses and goal progress are rendered
                setTimeout(() => {
                    console.log('🔄 Final initialization - forcing renderRecentExpenses and updateGoalProgressDisplay');
                    renderRecentExpenses();
                    updateGoalProgressDisplay();
                }, 200);
                
            } catch (error) {
                console.error('App initialization error:', error);
                // showAuthModal call removed - authentication disabled
            }
        }
        
        // Add user info to UI
        function addUserInfoToUI() {
            // Authentication check removed - allow UI setup without login
            // if (!authManager.isAuthenticated()) return;
            
            const user = authManager.getUser();
            
            // Skip user menu creation if no user is available
            if (!user) return;
            
            // Add user menu to header if it doesn't exist
            if (!document.getElementById('userMenu')) {
                const headerActions = document.querySelector('.header-actions') || document.querySelector('header .flex');
                if (headerActions) {
                    // Generate user initials
                    const getInitials = (name) => {
                        const names = name.trim().split(' ');
                        if (names.length >= 2) {
                            return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
                        }
                        return name.charAt(0).toUpperCase();
                    };
                    
                    const initials = getInitials(user.name);
                    
                    const userMenuHTML = `
                        <div id="userMenu" class="relative ml-4">
                            <button id="userMenuButton" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                ${user.avatar ? 
                                    `<img class="h-8 w-8 rounded-full" src="${user.avatar}" alt="${user.name}">` :
                                    `<div class="h-8 w-8 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-semibold text-sm">${initials}</div>`
                                }
                                <span class="ml-2 text-gray-700 dark:text-gray-300 hidden sm:block">${user.name}</span>
                            </button>
                            <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50">
                                <div class="py-1">
                                    <div class="px-4 py-2 text-sm text-gray-500 border-b">
                                        ${user.email}
                                    </div>
                                    <button id="logoutButton" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        Sign out
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    headerActions.insertAdjacentHTML('beforeend', userMenuHTML);
                    
                    // Add event listeners
                    document.getElementById('userMenuButton').addEventListener('click', () => {
                        document.getElementById('userDropdown').classList.toggle('hidden');
                    });
                    
                    document.getElementById('logoutButton').addEventListener('click', () => {
                        authManager.logout();
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('#userMenu')) {
                            document.getElementById('userDropdown').classList.add('hidden');
                        }
                    });
                }
            }
        }

        // --- Recurring Expense Processing ---
        function processRecurringExpenses() {
            let newExpensesGenerated = 0;
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            recurringItems.forEach(item => {
                if (item.status !== 'active' || item.type !== 'expense') {
                return;
            }

                const itemStartDate = new Date(item.startDate + 'T00:00:00');
                if (itemStartDate > today) return;

                let currentDate = new Date(itemStartDate);
                const itemEndDate = item.endDate ? new Date(item.endDate + 'T00:00:00') : today;

                let iterations = 0;
                while (currentDate <= itemEndDate && currentDate <= today && iterations < 1000) {
                    // Fix: Use local date string to avoid timezone issues
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    
                    const instanceId = `auto-${item.id}-${dateStr}`;
                    
                    if (!expenses.some(e => e.id === instanceId)) {
                        expenses.push({
                            id: instanceId,
                            name: item.name,
                            cost: item.amount,
                            type: item.essentialType || 'Non-Essential',
                            category: item.category,
                            date: dateStr,
                            paymentMethod: item.paymentMethod,
                            status: 'active',
                            recurringSourceId: item.id
                        });
                        newExpensesGenerated++;
                    }

                    // Get next date
                    switch (item.frequency) {
                        case 'Daily': currentDate.setDate(currentDate.getDate() + 1); break;
                        case 'Weekly': currentDate.setDate(currentDate.getDate() + 7); break;
                        case 'Bi-Weekly': currentDate.setDate(currentDate.getDate() + 14); break;
                        case 'Monthly': currentDate.setMonth(currentDate.getMonth() + 1); break;
                        case 'Quarterly': currentDate.setMonth(currentDate.getMonth() + 3); break;
                        case 'Annual': currentDate.setFullYear(currentDate.getFullYear() + 1); break;
                        default: iterations = 1000; break;
                    }
                    iterations++;
                }
            });

            if (newExpensesGenerated > 0) {
                sortExpenses();
                console.log('🔄 processRecurringExpenses - generated', newExpensesGenerated, 'new expenses');
                console.log('📊 processRecurringExpenses - total expenses now:', expenses.length);
                saveData();
                
                // Force render recent expenses after processing recurring
                setTimeout(() => {
                    renderRecentExpenses();
                }, 50);
                
                showToast(`${newExpensesGenerated} new recurring expense(s) have been added.`, 'info');
            }
        }

        // --- Expense Sorting ---
        function sortExpenses() {
            expenses.sort((a, b) => {
                // First sort by date (newest first)
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                // For same dates, sort by ID (newest first)
                // Handle both string and numeric IDs
                const getNumericId = (id) => {
                    if (typeof id === 'string') {
                        // Extract numeric part from auto-generated IDs
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return id;
                };
                
                return getNumericId(b.id) - getNumericId(a.id);
            });
            }

        // --- Onboarding ---
        function startOnboardingProcess() {
            const firstVisit = localStorage.getItem('onboardingComplete') !== 'true';
            if (firstVisit) {
                document.getElementById('clean-onboarding-modal').classList.remove('hidden');
                updateCleanOnboardingStep();
            }
        }

        // === NEW CLEAN ONBOARDING SYSTEM ===
let cleanOnboardingData = {
    currentStep: 1,
    totalSteps: 5, // Consolidated to 5 logical steps
    data: {
        monthlyIncome: 0,
        monthlyBudget: 0,
        primaryGoal: null,
        goalDetails: {},
        debts: [],
        totalSavings: 0,
        monthlyExpenses: 0
    }
};

function goCleanNext() {
    console.log('goCleanNext called, current step:', cleanOnboardingData.currentStep);
    
    // Save current step data before validation
    saveCurrentStepData();
    
    // Validate this step; stop if errors
    if (!validateCleanStep()) {
        console.log('Validation failed for step:', cleanOnboardingData.currentStep);
        return;
    }

    console.log('Validation passed, moving to next step');
    
    // Move to next step
    cleanOnboardingData.currentStep++;

    // If we've gone past the last step, complete onboarding
    if (cleanOnboardingData.currentStep > cleanOnboardingData.totalSteps) {
        finishCleanOnboarding();
    } else {
        updateCleanOnboardingStep();
    }
}

function goCleanBack() {
    if (cleanOnboardingData.currentStep > 1) {
        // Save current step data before going back
        saveCurrentStepData();
        
        // Move to previous step
        cleanOnboardingData.currentStep--;
        updateCleanOnboardingStep();
    }
}

function updateCleanOnboardingStep() {
    try {
        // Validate current step is within bounds
        if (cleanOnboardingData.currentStep < 1 || cleanOnboardingData.currentStep > cleanOnboardingData.totalSteps) {
            console.error('Invalid step:', cleanOnboardingData.currentStep);
            cleanOnboardingData.currentStep = Math.max(1, Math.min(cleanOnboardingData.currentStep, cleanOnboardingData.totalSteps));
        }
        
        // Hide all steps
        document.querySelectorAll('.clean-onboarding-step').forEach(step => {
            step.classList.add('hidden');
        });
        
        // Show current step
        const currentStepElement = document.getElementById(`clean-step-${cleanOnboardingData.currentStep}`);
        if (currentStepElement) {
            currentStepElement.classList.remove('hidden');
        } else {
            console.error('Step element not found:', `clean-step-${cleanOnboardingData.currentStep}`);
            return;
        }
        
        // Update progress
        const progress = (cleanOnboardingData.currentStep / cleanOnboardingData.totalSteps) * 100;
        const progressBar = document.getElementById('clean-progress-fill');
        const stepIndicator = document.getElementById('clean-step-indicator');
        
        if (progressBar) progressBar.style.width = `${progress}%`;
        
        // Create user-friendly step labels
        const stepLabels = {
            1: 'Income & Budget',
            2: 'Choose Goal',
            3: 'Goal Planning',
            4: 'Financial Position',
            5: 'Goal Activation'
        };
        
        const stepLabel = stepLabels[cleanOnboardingData.currentStep] || `Step ${cleanOnboardingData.currentStep}`;
        if (stepIndicator) stepIndicator.textContent = `Step ${cleanOnboardingData.currentStep} of ${cleanOnboardingData.totalSteps}: ${stepLabel}`;
        
        // Update navigation
        const backBtn = document.getElementById('clean-back-btn');
        const nextBtn = document.getElementById('clean-next-btn');
        
        if (backBtn) backBtn.style.visibility = cleanOnboardingData.currentStep === 1 ? 'hidden' : 'visible';
        if (nextBtn) nextBtn.textContent = cleanOnboardingData.currentStep === cleanOnboardingData.totalSteps ? 'Activate My Goal' : 'Next →';
        
        // Prepare step-specific content
        if (cleanOnboardingData.currentStep === 3) {
            prepareCompleteGoalPlanning(); // Step 3: Complete Goal Planning (merged)
            setTimeout(() => restoreCurrentStepData(), 150);
        } else if (cleanOnboardingData.currentStep === 4) {
            prepareFinancialPosition(); // Step 4: Financial Position & Debt
            setTimeout(() => restoreCurrentStepData(), 150);
        } else if (cleanOnboardingData.currentStep === 5) {
            prepareGoalActivation(); // Step 5: Goal Activation
            restoreCurrentStepData();
        } else {
            // Restore form data for current step
            restoreCurrentStepData();
        }
    } catch (error) {
        console.error('Error updating onboarding step:', error);
        showToast('Error updating onboarding step. Please refresh and try again.', 'error');
    }
}

function validateCleanStep() {
    const data = cleanOnboardingData.data;
    
    switch(cleanOnboardingData.currentStep) {
        case 1:
            const income = parseFloat(document.getElementById('clean-income-input').value);
            const budget = parseFloat(document.getElementById('clean-budget-input').value);
            if (!income || !budget || income <= 0 || budget <= 0) {
                showToast('Please enter valid income and budget amounts', 'error');
                return false;
            }
            if (budget >= income) {
                showToast('Your budget should be less than your income to allow for savings', 'error');
                return false;
            }
            data.monthlyIncome = income;
            data.monthlyBudget = budget;
            return true;
            
        case 2:
            console.log('Validating step 2, primaryGoal:', data.primaryGoal);
            if (!data.primaryGoal) {
                showToast('Please select a primary goal', 'error');
                return false;
            }
            console.log('Step 2 validation passed');
            return true;
            
        case 3:
            // Step 3: Complete Goal Planning validation
            // Special handling for debt goals
            if (data.primaryGoal === 'debt') {
                console.log('=== DEBT VALIDATION START ===');
                console.log('Current data.debts before collection:', data.debts);
                
                // Collect debt data from the form before validation
                const debtItems = document.querySelectorAll('.debt-entry-item');
                console.log('Found debt items:', debtItems.length);
                
                const debts = [];
                
                debtItems.forEach((item, index) => {
                    const name = item.querySelector('.debt-name').value || '';
                    const balance = parseFloat(item.querySelector('.debt-balance').value) || 0;
                    const interest = parseFloat(item.querySelector('.debt-interest').value) || 0;
                    
                    console.log(`Debt item ${index + 1}:`, { name, balance, interest });
                    
                    if (balance > 0) {
                        debts.push({ name: name || 'Debt', balance, interest });
                    }
                });
                
                console.log('Collected debts from form:', debts);
                
                // Update the data object with collected debts
                data.debts = debts;
                console.log('Updated data.debts:', data.debts);
                
                // Validate that at least one debt is entered
                if (!debts || debts.length === 0) {
                    console.error('VALIDATION FAILED: No debts found');
                    showToast('Please add at least one debt to continue', 'error');
                    return false;
                }
                
                // Validate strategy is selected
                const strategy = document.getElementById('debt-strategy')?.value;
                console.log('Selected strategy:', strategy);
                if (!strategy) {
                    console.error('VALIDATION FAILED: No strategy selected');
                    showToast('Please select a payoff strategy from the dropdown', 'error');
                    return false;
                }
                
                // Save debt-specific data
                data.goalDetails['debt-strategy'] = strategy;
                const extraPayment = parseFloat(document.getElementById('debt-extra-payment-slider')?.value) || 0;
                data.goalDetails['debt-extra-payment'] = extraPayment;
                const totalDebt = debts.reduce((sum, debt) => sum + debt.balance, 0);
                data.goalDetails.target = totalDebt;
                data.goalDetails.current = 0; // Start with 0 paid off
                data.goalDetails.monthlyCommitment = extraPayment;
                
                console.log('DEBT VALIDATION PASSED:', {
                    debts: debts,
                    strategy: strategy,
                    extraPayment: extraPayment,
                    totalDebt: totalDebt
                });
                console.log('=== DEBT VALIDATION END ===');
                return true;
            }
            
            // Regular goal validation
            const targetInput = document.getElementById('goal-target');
            const slider = document.getElementById('monthly-commitment-slider') || document.getElementById('monthly-commitment-slider-alt');
            
            if (!targetInput) {
                showToast('Please enter your goal target amount', 'error');
                return false;
            }
            
            const target = parseFloat(targetInput.value) || 0;
            
            if (target <= 0) {
                showToast('Please enter a target amount for your goal', 'error');
                return false;
            }
            
            if (!slider) {
                showToast('Please set a monthly commitment amount', 'error');
                console.log('Slider validation failed - no slider found');
                return false;
            }
            
            const monthlyCommitment = parseFloat(slider.value) || 0;
            console.log('Validation: slider value =', slider.value, 'parsed =', monthlyCommitment);
            
            if (monthlyCommitment <= 0) {
                showToast('Please set a monthly commitment amount using the slider', 'error');
                console.log('Monthly commitment validation failed:', monthlyCommitment);
                return false;
            }
            
            return true;
            
        case 4:
            // Step 4: Financial Position & Debt validation
            const savings = parseFloat(document.getElementById('clean-total-savings-input')?.value) || 0;
            data.totalSavings = savings;
            
            // Validate that goal allocation doesn't exceed total savings
            const goalAllocation = data.goalDetails.current || 0;
            if (goalAllocation > savings) {
                showToast(`Your goal allocation (£${goalAllocation.toLocaleString()}) cannot exceed your total savings (£${savings.toLocaleString()})`, 'error');
                return false;
            }
            
            // Use monthly budget as monthly expenses since we simplified the questions
            data.monthlyExpenses = data.monthlyBudget;
            return true;
            
        default:
            return true;
    }
}

/**
 * Complete the onboarding process and initialize the application
 * Transfers onboarding data to main app state and creates initial goals
 */
function finishCleanOnboarding() {
    try {
        const data = cleanOnboardingData.data;
        
        // Transfer onboarding data to main application state
        monthlyIncome = data.monthlyIncome || 0;
        monthlyBudget = data.monthlyBudget || 0;
        monthlyExpenses = data.monthlyExpenses || data.monthlyBudget || 0;
        totalSavings = data.totalSavings || 0;
        totalDebt = (data.debts || []).reduce((sum, debt) => sum + debt.balance, 0);
    
    // Create real goals
    userGoals = [];
    console.log('Creating goals for primaryGoal:', data.primaryGoal);
    
    if (data.primaryGoal === 'house') {
        userGoals.push({
            id: Date.now(),
            type: 'house_deposit',
            name: 'House Deposit',
            target: data.goalDetails['house-target'] || 0,
            currentProgress: data.goalDetails['house-current'] || 0,
            unit: 'currency',
            timeline: data.goalDetails['house-timeline'],
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    if (data.primaryGoal === 'emergency') {
        const monthsValue = data.goalDetails['emergency-months'];
        const months = monthsValue ? parseInt(String(monthsValue).charAt(0)) || 6 : 6;
        const userTarget = data.goalDetails['emergency-target'] || (data.monthlyExpenses * months);
        console.log('Emergency fund creation:', {
            savedTarget: data.goalDetails['emergency-target'],
            calculatedTarget: data.monthlyExpenses * months,
            finalTarget: userTarget,
            months: months,
            monthlyExpenses: data.monthlyExpenses
        });
        userGoals.push({
            id: Date.now() + 1,
            type: 'emergency_fund',
            name: `${months}-Month Emergency Fund`,
            target: userTarget,
            currentProgress: data.goalDetails['emergency-current'] || 0,
            unit: 'currency',
            months: months,
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    if (data.primaryGoal === 'vacation') {
        userGoals.push({
            id: Date.now() + 2,
            type: 'vacation',
            name: data.goalDetails['vacation-name'] || 'Dream Vacation',
            target: data.goalDetails['vacation-cost'] || 0,
            currentProgress: data.goalDetails['vacation-current'] || 0,
            unit: 'currency',
            timeline: data.goalDetails['vacation-timeline'],
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    if (data.primaryGoal === 'investment') {
        userGoals.push({
            id: Date.now() + 3,
            type: 'investment',
            name: 'Investment Goal',
            target: data.goalDetails['investment-target'] || 0,
            currentProgress: data.goalDetails['investment-current'] || 0,
            unit: 'currency',
            timeline: data.goalDetails['investment-timeline'],
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    if (data.primaryGoal === 'debt') {
        console.log('Creating debt goal with data.debts:', data.debts);
        const totalDebt = (data.debts || []).reduce((sum, debt) => sum + debt.balance, 0);
        console.log('Calculated totalDebt:', totalDebt);
        
        if (totalDebt === 0) {
            console.error('ERROR: Total debt is 0! data.debts:', data.debts);
            showToast('Error: No debt data found. Please go back and add your debts.', 'error');
            return;
        }
        
        userGoals.push({
            id: Date.now() + 4,
            type: 'debt_payoff',
            name: 'Debt Payoff',
            target: totalDebt, // Use calculated total debt
            currentProgress: 0, // Start with 0 paid off
            unit: 'currency',
            timeline: data.goalDetails['debt-timeline'] || '',
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString(),
            // Add debt-specific properties
            strategy: data.goalDetails['debt-strategy'] || '',
            extraPayment: data.goalDetails['debt-extra-payment'] || 0,
            debts: data.debts || []
        });
        console.log('Created debt goal:', userGoals[userGoals.length - 1]);
    }
    
    if (data.primaryGoal === 'custom') {
        userGoals.push({
            id: Date.now() + 5,
            type: 'custom',
            name: data.goalDetails['custom-name'] || 'Custom Goal',
            target: data.goalDetails['custom-target'] || 0,
            currentProgress: data.goalDetails['custom-current'] || 0,
            unit: 'currency',
            timeline: data.goalDetails['custom-timeline'],
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    console.log('Goals created:', userGoals.length, userGoals);
    console.log('Data details:', {
        primaryGoal: data.primaryGoal,
        goalDetails: data.goalDetails,
        totalSavings: data.totalSavings,
        totalDebt: totalDebt
    });
    
    // Add debts as recurring items
    data.debts.forEach(debt => {
        recurringItems.push({
            id: Date.now() + Math.random(),
            type: 'expense',
            name: `${debt.name} Payment`,
            amount: Math.max(debt.balance * 0.02, 25),
            frequency: 'Monthly',
            category: 'Debt',
            essentialType: 'Essential',
            startDate: new Date().toISOString().split('T')[0],
            status: 'active',
            debtBalance: debt.balance,
            debtInterest: debt.interest
        });
    });
    
    // Save everything
    console.log('About to save data, userGoals:', userGoals);
    try {
        saveData();
        console.log('Data saved successfully');
    } catch (saveError) {
        console.error('Error saving data:', saveError);
        throw saveError;
    }
    
    console.log('Data saved. Checking localStorage...');
    const savedData = authManager.getUserData('lensAppData') || {};
    console.log('Saved userGoals:', savedData.userGoals);
    localStorage.setItem('onboardingComplete', 'true');
    localStorage.setItem('cleanOnboardingData', JSON.stringify(data));
    
        // Close modal and update display
        const modal = document.getElementById('clean-onboarding-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        try {
            updateDisplay();
            console.log('Display updated successfully');
        } catch (displayError) {
            console.error('Error updating display:', displayError);
            throw displayError;
        }
        
        try {
            updateInsightsTiles();
            console.log('Insights tiles updated successfully');
        } catch (insightsError) {
            console.error('Error updating insights tiles:', insightsError);
            // Don't throw here since insights update is not critical for onboarding completion
        }
        
        try {
            updateBudgetCalculations();
            console.log('Budget calculations updated successfully');
        } catch (budgetError) {
            console.error('Error updating budget calculations:', budgetError);
            // Don't throw here since budget calculations are not critical for onboarding completion
        }
        
        showToast('Welcome to Lens! Your personalized financial tracker is ready.', 'success');
        
        // Start tour
        setTimeout(() => {
            try {
                if (localStorage.getItem('tourComplete') !== 'true') {
                    launchOnboardingTour();
                }
            } catch (tourError) {
                console.error('Error launching tour:', tourError);
                // Don't throw here since tour is optional
            }
        }, 1000);
        
    } catch (error) {
        console.error('Error finishing onboarding:', error);
        console.error('Error stack:', error.stack);
        console.error('Onboarding data at error:', cleanOnboardingData);
        
        // Fallback: just close the modal
        const modal = document.getElementById('clean-onboarding-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        showToast('Setup completed with some issues. You can continue using the app.', 'warning');
    }
}

// === FIXES FOR THE 4 ERRORS ===

// 1. ADD missing prepareCleanGoalDetails function
function prepareCleanGoalDetails() {
    const container = document.getElementById('clean-goal-details-content');
    const goal = cleanOnboardingData.data.primaryGoal;
    
    const configs = {
        house: {
            title: '▦ House Deposit Goal',
            subtitle: 'Tell us about your house purchase plan',
            fields: [
                { id: 'house-target', label: 'Target Deposit Amount', placeholder: '50,000', type: 'currency' },
                { id: 'house-timeline', label: 'Purchase Timeline', type: 'select', options: ['1 year', '2 years', '3 years', '4 years', '5+ years'] },
                { id: 'house-current', label: 'Current House Deposit Savings', placeholder: '5,000', type: 'currency', help: 'Money you\'ve already saved specifically for the house deposit (part of your total savings)' }
            ]
        },
        emergency: {
            title: '💰 Emergency Fund Goal',
            subtitle: 'Build your financial safety net',
            fields: [
                { id: 'emergency-months', label: 'Target Coverage', type: 'select', options: ['3 months expenses', '4 months expenses', '5 months expenses', '6 months expenses', '12 months expenses'] },
                { id: 'emergency-current', label: 'Current Emergency Fund Allocation', placeholder: '1,000', type: 'currency', help: 'How much of your total savings is specifically allocated to emergency fund (this should be part of your total savings amount)' }
            ]
        },
        debt: {
            title: '💳 Debt Payoff Strategy',
            subtitle: 'Choose your debt elimination approach',
            fields: [
                { id: 'debt-strategy', label: 'Payoff Strategy', type: 'select', options: ['Avalanche (highest interest first)', 'Snowball (smallest balance first)', 'Equal payments'] }
            ]
        },
        vacation: {
            title: '✈️ Vacation Goal',
            subtitle: 'Plan your dream trip',
            fields: [
                { id: 'vacation-cost', label: 'Total Trip Cost', placeholder: '3,000', type: 'currency' },
                { id: 'vacation-when', label: 'When do you want to go?', type: 'select', options: ['6 months', '1 year', '18 months', '2 years'] },
                { id: 'vacation-current', label: 'Current Vacation Savings', placeholder: '500', type: 'currency', help: 'Money already saved for vacation (part of your total savings)' }
            ]
        },
        investment: {
            title: '📈 Investment Goal',
            subtitle: 'Build your investment portfolio',
            fields: [
                { id: 'investment-target', label: 'Investment Target', placeholder: '10,000', type: 'currency' },
                { id: 'investment-timeline', label: 'Timeline', type: 'select', options: ['1 year', '3 years', '5 years', '10+ years'] },
                { id: 'investment-current', label: 'Current Investment Savings', placeholder: '1,000', type: 'currency', help: 'Money already set aside for investing (part of your total savings)' }
            ]
        },
        custom: {
            title: '🎯 Custom Goal',
            subtitle: 'Set your own financial target',
            fields: [
                { id: 'custom-name', label: 'Goal Name', placeholder: 'My Financial Goal', type: 'text' },
                { id: 'custom-target', label: 'Target Amount', placeholder: '5,000', type: 'currency' },
                { id: 'custom-timeline', label: 'Timeline', type: 'select', options: ['6 months', '1 year', '2 years', '3 years', '5+ years'] },
                { id: 'custom-current', label: 'Current Progress', placeholder: '0', type: 'currency', help: 'Money already saved toward this goal' }
            ]
        }
    };
    
    const config = configs[goal];
    if (!config) return;
    
    container.innerHTML = `
        <h2 class="text-xl font-semibold mb-2 text-center">${config.title}</h2>
        <p class="text-gray-600 dark:text-gray-400 text-center mb-6">${config.subtitle}</p>
        
        <div class="space-y-4">
            ${config.fields.map(field => {
                if (field.type === 'select') {
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${field.label}</label>
                            <select id="${field.id}" class="modern-select font-medium">
                                <option value="">Select...</option>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                            ${field.help ? `<div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">${field.help}</div>` : ''}
                        </div>
                    `;
                } else if (field.type === 'currency') {
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${field.label}</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                                <input type="number" id="${field.id}" placeholder="${field.placeholder}" class="modern-input pl-8 text-center font-semibold">
                            </div>
                            ${field.help ? `<div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">${field.help}</div>` : ''}
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${field.label}</label>
                            <input type="${field.type}" id="${field.id}" placeholder="${field.placeholder}" class="modern-input text-center font-medium">
                            ${field.help ? `<div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">${field.help}</div>` : ''}
                        </div>
                    `;
                }
            }).join('')}
        </div>
    `;
}

function prepareGoalCommitment() {
    const container = document.getElementById('clean-goal-commitment-content');
    const goal = cleanOnboardingData.data.primaryGoal;
    const data = cleanOnboardingData.data;
    
    // Calculate available surplus
    const surplus = data.monthlyIncome - data.monthlyBudget;
    
    if (surplus <= 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">⚠️</div>
                <h2 class="text-xl font-semibold mb-4 text-red-600">Budget Alert</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Your budget exceeds your income. You'll need to adjust your budget before setting financial goals.</p>
                <button onclick="goCleanBack()" class="modern-button modern-button-primary">Go Back & Adjust Budget</button>
            </div>
        `;
        return;
    }
    
    const goalConfigs = {
        house: { 
            icon: '🏠', 
            title: 'House Deposit Plan',
            subtitle: 'Let\'s create your monthly savings plan',
            targetPlaceholder: '50,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '5,000',
            currentLabel: 'Amount allocated to this goal'
        },
        emergency: { 
            icon: '💰', 
            title: 'Emergency Fund Plan',
            subtitle: 'Build your financial safety net',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        vacation: { 
            icon: '✈️', 
            title: 'Vacation Savings Plan',
            subtitle: 'Plan your dream trip',
            targetPlaceholder: '3,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        },
        investment: { 
            icon: '📈', 
            title: 'Investment Plan',
            subtitle: 'Build your investment portfolio',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        custom: { 
            icon: '🎯', 
            title: 'Custom Goal Plan',
            subtitle: 'Achieve your financial target',
            targetPlaceholder: '5,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        },
        debt: { 
            icon: '💳', 
            title: 'Debt Payoff Plan',
            subtitle: 'Eliminate your debt strategically',
            targetPlaceholder: '15,000',
            targetLabel: 'Total Debt Amount',
            currentPlaceholder: '0',
            currentLabel: 'Already Paid Off'
        }
    };
    
    const config = goalConfigs[goal] || goalConfigs.custom;
    
    // Special handling for debt payoff goals
    if (goal === 'debt') {
        container.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">${config.icon}</div>
                <h2 class="text-xl font-semibold mb-2">${config.title}</h2>
                <p class="text-gray-600 dark:text-gray-400">${config.subtitle}</p>
            </div>
            
            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 mb-6">
                <div class="text-center">
                    <div class="text-sm text-red-600 dark:text-red-400 font-medium">Total Debt to Pay Off</div>
                    <div class="text-2xl font-bold text-red-700 dark:text-red-300">£${totalDebt.toLocaleString()}</div>
                    <div class="text-xs text-red-500 dark:text-red-400">From ${data.debts.length} debt(s) you entered</div>
                </div>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-3">Payoff Strategy <span class="text-gray-500">(Required - Select from dropdown)</span></label>
                    <div class="relative">
                        <select id="debt-strategy" class="modern-input appearance-none pr-10 cursor-pointer" onchange="updateDebtCalculations()">
                            <option value="">🔽 Choose your payoff strategy...</option>
                            <option value="Avalanche (highest interest first)">🏔️ Avalanche - Pay highest interest first</option>
                            <option value="Snowball (smallest balance first)">⛄ Snowball - Pay smallest balance first</option>
                            <option value="Equal payments">⚖️ Equal Payments - Split evenly</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">Choose the strategy that motivates you most</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-3">Extra Monthly Payment</label>
                    <div class="space-y-3">
                        <input type="range" id="debt-extra-payment-slider" 
                               min="0" max="${surplus}" step="25" value="0"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                               onchange="updateDebtCalculations()" oninput="updateDebtCalculations()">
                        
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                            <span>£0/month extra</span>
                            <span>£${surplus.toLocaleString()}/month extra</span>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-lg font-semibold">Extra Payment: <span id="debt-extra-amount">£0</span>/month</div>
                        </div>
                    </div>
                </div>
                
                <div id="debt-timeline-display" class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800 hidden">
                    <h4 class="font-medium mb-3 text-blue-700 dark:text-blue-300">Payoff Timeline</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Minimum Payments:</span>
                            <span id="debt-min-payments" class="font-mono text-blue-600 dark:text-blue-400">£0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Total Monthly Payment:</span>
                            <span id="debt-total-payment" class="font-mono text-blue-600 dark:text-blue-400">£0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Debt-Free Timeline:</span>
                            <span id="debt-timeline-months" class="font-mono text-green-600 dark:text-green-400">0 months</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Initialize debt calculations
        updateDebtCalculations();
        return;
    }
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">${config.icon}</div>
            <h2 class="text-xl font-semibold mb-2">${config.title}</h2>
            <p class="text-gray-600 dark:text-gray-400">${config.subtitle}</p>
        </div>
        
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-6">
            <div class="text-center">
                <div class="text-sm text-blue-600 dark:text-blue-400 font-medium">Monthly Surplus Available</div>
                <div class="text-2xl font-bold text-blue-700 dark:text-blue-300">£${surplus.toLocaleString()}</div>
                <div class="text-xs text-blue-500 dark:text-blue-400">Income - Budget = Available for goals</div>
            </div>
        </div>
        
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">${config.targetLabel}</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                        <input type="number" id="goal-target" placeholder="${config.targetPlaceholder}" 
                               class="modern-input pl-6 pr-4 font-semibold" 
                               onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">${config.currentLabel}</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                        <input type="number" id="goal-current" placeholder="${config.currentPlaceholder}" 
                               class="modern-input pl-6 pr-4 font-semibold" 
                               onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-3">Monthly Commitment</label>
                <div class="space-y-3">
                    <input type="range" id="monthly-commitment-slider" 
                           min="0" max="${surplus}" step="50" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider monthly-commitment-main"
                           onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                    
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                        <span>£0/month</span>
                        <span>£${surplus.toLocaleString()}/month</span>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-lg font-bold" id="commitment-amount">£0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">per month toward your goal</div>
                    </div>
                </div>
            </div>
            
            <div id="timeline-display" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 hidden">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-medium">Your Plan Timeline</span>
                    <span id="timeline-months" class="text-lg font-bold text-purple-600"></span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                    <div id="timeline-progress" class="bg-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                    <span id="timeline-current">£0 (current)</span>
                    <span id="timeline-target">£0 (target)</span>
                </div>
            </div>
            
            <div id="commitment-options" class="space-y-3 hidden">
                <h4 class="font-medium">Quick Commitment Options:</h4>
                <div class="grid grid-cols-2 gap-3" id="commitment-buttons">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <div id="commitment-warning" class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-4 hidden">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700 dark:text-yellow-300" id="warning-text"></p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Initialize calculations
    setTimeout(() => {
        updateCommitmentCalculations();
        generateCommitmentOptions();
    }, 100);
}

// Step 3: Complete Goal Planning (MERGED 3A+3B+3C)
function prepareCompleteGoalPlanning() {
    const container = document.getElementById('clean-complete-goal-content');
    const goal = cleanOnboardingData.data.primaryGoal;
    const data = cleanOnboardingData.data;
    
    // Calculate available surplus
    const surplus = data.monthlyIncome - data.monthlyBudget;
    
    if (surplus <= 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">⚠️</div>
                <h2 class="text-xl font-semibold mb-4 text-red-600">Budget Alert</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Your budget exceeds your income. You'll need to adjust your budget before setting financial goals.</p>
                <button onclick="goCleanBack()" class="modern-button modern-button-primary">Go Back & Adjust Budget</button>
            </div>
        `;
        return;
    }
    
    // Special handling for debt payoff goals
    if (goal === 'debt') {
        const totalDebt = (data.debts || []).reduce((sum, debt) => sum + debt.balance, 0);
        container.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">💳</div>
                <h2 class="text-xl font-semibold mb-2">Debt Payoff Plan</h2>
                <p class="text-gray-600 dark:text-gray-400">Add your debts and choose your payoff strategy</p>
            </div>
            
            <!-- Debt Entry Section -->
            <div class="card p-4 mb-6">
                <h3 class="font-medium mb-4">Your Debts</h3>
                <div id="debt-entry-list" class="space-y-3 mb-4"></div>
                <button onclick="addDebtEntry()" class="modern-button modern-button-secondary w-full">+ Add Debt</button>
            </div>
            
            <div id="debt-summary-section" class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 mb-6 ${totalDebt === 0 ? 'hidden' : ''}">
                <div class="text-center">
                    <div class="text-sm text-red-600 dark:text-red-400 font-medium">Total Debt to Pay Off</div>
                    <div class="text-2xl font-bold text-red-700 dark:text-red-300" id="total-debt-display">£${totalDebt.toLocaleString()}</div>
                    <div class="text-xs text-red-500 dark:text-red-400" id="debt-count-display">From ${(data.debts || []).length} debt(s) you entered</div>
                </div>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-3">Payoff Strategy <span class="text-gray-500">(Required - Select from dropdown)</span></label>
                    <div class="relative">
                        <select id="debt-strategy" class="modern-input appearance-none pr-10 cursor-pointer" onchange="updateDebtCalculations()">
                            <option value="">🔽 Choose your payoff strategy...</option>
                            <option value="Avalanche (highest interest first)">🏔️ Avalanche - Pay highest interest first</option>
                            <option value="Snowball (smallest balance first)">⛄ Snowball - Pay smallest balance first</option>
                            <option value="Equal payments">⚖️ Equal Payments - Split evenly</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">Choose the strategy that motivates you most</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-3">Extra Monthly Payment</label>
                    <div class="space-y-3">
                        <input type="range" id="debt-extra-payment-slider" 
                               min="0" max="${surplus}" step="25" value="0"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                               onchange="updateDebtCalculations()" oninput="updateDebtCalculations()">
                        
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                            <span>£0/month extra</span>
                            <span>£${surplus.toLocaleString()}/month extra</span>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-lg font-semibold">Extra Payment: <span id="debt-extra-amount">£0</span>/month</div>
                        </div>
                    </div>
                </div>
                
                <div id="debt-timeline-display" class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800 hidden">
                    <h4 class="font-medium mb-3 text-blue-700 dark:text-blue-300">Payoff Timeline</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Minimum Payments:</span>
                            <span id="debt-min-payments" class="font-mono text-blue-600 dark:text-blue-400">£0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Total Monthly Payment:</span>
                            <span id="debt-total-payment" class="font-mono text-blue-600 dark:text-blue-400">£0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Debt-Free Timeline:</span>
                            <span id="debt-timeline-months" class="font-mono text-green-600 dark:text-green-400">0 months</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Initialize debt calculations and restore existing debts
        setTimeout(() => {
            const debtList = document.getElementById('debt-entry-list');
            if (debtList && data.debts && data.debts.length > 0) {
                // Restore existing debts
                data.debts.forEach(debt => {
                    addDebtEntry();
                    const lastItem = debtList.lastElementChild;
                    if (lastItem) {
                        lastItem.querySelector('.debt-name').value = debt.name || '';
                        lastItem.querySelector('.debt-balance').value = debt.balance || '';
                        lastItem.querySelector('.debt-interest').value = debt.interest || '';
                    }
                });
                updateDebtSummary();
            } else if (debtList && debtList.children.length === 0) {
                // Auto-add first debt entry if none exist
                addDebtEntry();
            }
            updateDebtCalculations();
        }, 100);
        return;
    }
    
    const goalConfigs = {
        house: { 
            icon: '🏠', 
            title: 'House Deposit Plan',
            subtitle: 'Complete your house deposit planning',
            targetPlaceholder: '50,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '5,000',
            currentLabel: 'Amount allocated to this goal'
        },
        emergency: { 
            icon: '💰', 
            title: 'Emergency Fund Plan',
            subtitle: 'Build your financial safety net',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        vacation: { 
            icon: '✈️', 
            title: 'Vacation Savings Plan',
            subtitle: 'Plan your dream trip',
            targetPlaceholder: '3,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        },
        investment: { 
            icon: '📈', 
            title: 'Investment Plan',
            subtitle: 'Build your investment portfolio',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        custom: { 
            icon: '🎯', 
            title: 'Custom Goal Plan',
            subtitle: 'Achieve your financial target',
            targetPlaceholder: '5,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        }
    };
    
    const config = goalConfigs[goal] || goalConfigs.custom;
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">${config.icon}</div>
            <h2 class="text-xl font-semibold mb-2">${config.title}</h2>
            <p class="text-gray-600 dark:text-gray-400">${config.subtitle}</p>
        </div>
        
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-6">
            <div class="text-center">
                <div class="text-sm text-blue-600 dark:text-blue-400 font-medium">Monthly Surplus Available</div>
                <div class="text-2xl font-bold text-blue-700 dark:text-blue-300">£${surplus.toLocaleString()}</div>
                <div class="text-xs text-blue-500 dark:text-blue-400">Income - Budget = Available for goals</div>
            </div>
        </div>
        
        <div class="space-y-6">
            <!-- Goal Details Section -->
            <div class="card p-4">
                <h3 class="font-medium mb-4">Goal Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">${config.targetLabel}</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                            <input type="number" id="goal-target" placeholder="${config.targetPlaceholder}" 
                                   class="modern-input pl-8 text-center font-semibold" 
                                   onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">${config.currentLabel}</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                            <input type="number" id="goal-current" placeholder="${config.currentPlaceholder}" 
                                   class="modern-input pl-8 text-center font-semibold" 
                                   onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Commitment Section -->
            <div class="card p-4">
                <h3 class="font-medium mb-4">Monthly Commitment</h3>
                <div class="space-y-3">
                    <input type="range" id="monthly-commitment-slider-alt" 
                           min="0" max="${surplus}" step="50" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider monthly-commitment-alt"
                           onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                    
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                        <span>£0/month</span>
                        <span>£${surplus.toLocaleString()}/month</span>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-lg font-semibold">Monthly commitment: <span id="commitment-amount">£0</span></div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">per month toward your goal</div>
                    </div>
                </div>
                
                <div id="commitment-options" class="space-y-3 hidden mt-4">
                    <h4 class="font-medium">Quick Commitment Options:</h4>
                    <div class="grid grid-cols-2 gap-3" id="commitment-buttons"></div>
                </div>
            </div>
            
            <!-- Timeline Section -->
            <div id="timeline-display" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 hidden">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-medium">Your Plan Timeline</span>
                    <span id="timeline-months" class="text-lg font-bold text-purple-600"></span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                    <div id="timeline-progress" class="bg-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                    <span id="timeline-current">£0 (current)</span>
                    <span id="timeline-target">£0 (target)</span>
                </div>
            </div>
            
            <div id="commitment-warning" class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 hidden">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700 dark:text-yellow-300" id="warning-text"></p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Initialize calculations and restore data
    setTimeout(() => {
        // Restore data if it exists
        const data = cleanOnboardingData.data;
        if (data.goalDetails && Object.keys(data.goalDetails).length > 0) {
            const targetInput = document.getElementById('goal-target');
            const currentInput = document.getElementById('goal-current');
            const slider = document.getElementById('monthly-commitment-slider') || document.getElementById('monthly-commitment-slider-alt');
            
            if (targetInput && data.goalDetails.target !== undefined) {
                targetInput.value = data.goalDetails.target;
            }
            if (currentInput && data.goalDetails.current !== undefined) {
                currentInput.value = data.goalDetails.current;
            }
            if (slider && data.goalDetails.monthlyCommitment !== undefined) {
                slider.value = data.goalDetails.monthlyCommitment;
            }
            
            // Trigger calculations after restoration to ensure UI updates
            setTimeout(() => {
                updateCommitmentCalculations();
                generateCommitmentOptions();
            }, 50);
        } else {
            // No data to restore, but still initialize the UI
            updateCommitmentCalculations();
            generateCommitmentOptions();
        }
    }, 200);
}

// Legacy function kept for compatibility
function prepareGoalDetails() {
    const container = document.getElementById('clean-goal-details-content');
    const goal = cleanOnboardingData.data.primaryGoal;
    const data = cleanOnboardingData.data;
    
    // Calculate available surplus
    const surplus = data.monthlyIncome - data.monthlyBudget;
    
    if (surplus <= 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">⚠️</div>
                <h2 class="text-xl font-semibold mb-4 text-red-600">Budget Alert</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Your budget exceeds your income. You'll need to adjust your budget before setting financial goals.</p>
                <button onclick="goCleanBack()" class="modern-button modern-button-primary">Go Back & Adjust Budget</button>
            </div>
        `;
        return;
    }
    
    const goalConfigs = {
        house: { 
            icon: '🏠', 
            title: 'House Deposit Plan',
            subtitle: 'Tell us about your house deposit goal',
            targetPlaceholder: '50,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '5,000',
            currentLabel: 'Amount allocated to this goal'
        },
        emergency: { 
            icon: '💰', 
            title: 'Emergency Fund Plan',
            subtitle: 'Set up your financial safety net',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        vacation: { 
            icon: '✈️', 
            title: 'Vacation Savings Plan',
            subtitle: 'Plan your dream trip',
            targetPlaceholder: '3,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        },
        investment: { 
            icon: '📈', 
            title: 'Investment Plan',
            subtitle: 'Build your investment portfolio',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        custom: { 
            icon: '🎯', 
            title: 'Custom Goal Plan',
            subtitle: 'Achieve your financial target',
            targetPlaceholder: '5,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        }
    };
    
    const config = goalConfigs[goal] || goalConfigs.custom;
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">${config.icon}</div>
            <h2 class="text-xl font-semibold mb-2">${config.title}</h2>
            <p class="text-gray-600 dark:text-gray-400">${config.subtitle}</p>
        </div>
        
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">${config.targetLabel}</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="goal-target" placeholder="${config.targetPlaceholder}" 
                               class="modern-input pl-8 text-center font-semibold">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">${config.currentLabel}</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="goal-current" placeholder="${config.currentPlaceholder}" 
                               class="modern-input pl-8 text-center font-semibold">
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Step 4: Financial Position & Debt (CONTEXT-AWARE)
function prepareFinancialPosition() {
    const container = document.getElementById('clean-financial-position-content');
    const data = cleanOnboardingData.data;
    const isDebtGoal = data.primaryGoal === 'debt';
    
    if (isDebtGoal) {
        // Simplified view for debt goals - only savings needed
        container.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">💰</div>
                <h2 class="text-xl font-semibold mb-2">Your Current Savings</h2>
                <p class="text-gray-600 dark:text-gray-400">How much do you have saved across all accounts?</p>
            </div>
            
            <div class="space-y-6">
                <!-- Current Savings Section -->
                <div class="card p-4">
                    <h3 class="font-medium mb-4">Total Savings</h3>
                    <div>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                            <input type="number" id="clean-total-savings-input" placeholder="2,500" class="modern-input pl-6 pr-4 font-semibold">
                        </div>
                        <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                            Total money you have saved across all accounts (used to calculate your net worth after debt payoff)
                        </div>
                    </div>
                </div>
                
                <!-- Debt Summary (Read-only) -->
                <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
                    <h4 class="font-medium mb-3 text-red-700 dark:text-red-300">Your Debt Summary</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Total Debt:</span>
                            <span class="font-mono text-red-600 dark:text-red-400">£${(data.debts || []).reduce((sum, debt) => sum + debt.balance, 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Number of Debts:</span>
                            <span class="font-mono">${(data.debts || []).length}</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-2">
                        ✓ Debts already configured in previous step
                    </div>
                </div>
            </div>
        `;
    } else {
        // Full view for other goals - savings + optional debts
        container.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">💰</div>
                <h2 class="text-xl font-semibold mb-2">Your Financial Position</h2>
                <p class="text-gray-600 dark:text-gray-400">Tell us about your current savings and any debts</p>
            </div>
            
            <div class="space-y-6">
                <!-- Current Savings Section -->
                <div class="card p-4">
                    <h3 class="font-medium mb-4">Current Savings</h3>
                    <div>
                        <label class="block text-sm font-medium mb-2">Total Savings</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                            <input type="number" id="clean-total-savings-input" placeholder="2,500" class="modern-input pl-6 pr-4 font-semibold">
                        </div>
                        <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                            Total money you have saved across all accounts (your goal allocations will be portions of this total)
                        </div>
                    </div>
                </div>
                
                <!-- Debt Section -->
                <div class="card p-4">
                    <h3 class="font-medium mb-4">Current Debts (Optional)</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Add any debts to get better goal recommendations and progress tracking</p>
                    
                    <div id="clean-debt-list" class="space-y-3 mb-4"></div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="addCleanDebt()" class="modern-button modern-button-secondary w-full">+ Add Debt</button>
                        <button onclick="skipCleanDebts()" class="modern-button modern-button-outline w-full">No Debts</button>
                    </div>
                </div>
            
            <!-- Impact Preview -->
            <div id="financial-impact-preview" class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 hidden">
                <h4 class="font-medium mb-3 text-blue-700 dark:text-blue-300">Financial Impact Preview</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Current Savings:</span>
                        <span id="preview-savings" class="font-mono">£0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Debt:</span>
                        <span id="preview-debt" class="font-mono text-red-600">£0</span>
                    </div>
                    <div class="flex justify-between font-medium border-t border-blue-200 dark:border-blue-800 pt-2">
                        <span>Net Worth:</span>
                        <span id="preview-net-worth" class="font-mono">£0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Estimated Monthly Debt Payments:</span>
                        <span id="preview-debt-payments" class="font-mono">£0</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    }
    
    // Add event listener to savings input to update preview (works for both debt and non-debt goals)
    setTimeout(() => {
        const savingsInput = document.getElementById('clean-total-savings-input');
        if (savingsInput) {
            savingsInput.addEventListener('input', updateFinancialPreview);
        }
        updateFinancialPreview();
    }, 100);
}

function updateFinancialPreview() {
    const savingsInput = document.getElementById('clean-total-savings-input');
    const previewDiv = document.getElementById('financial-impact-preview');
    const previewSavings = document.getElementById('preview-savings');
    const previewDebt = document.getElementById('preview-debt');
    const previewNetWorth = document.getElementById('preview-net-worth');
    const previewDebtPayments = document.getElementById('preview-debt-payments');
    
    if (!previewDiv) return;
    
    const savings = savingsInput ? parseFloat(savingsInput.value) || 0 : 0;
    
    // Collect current debt data from form inputs in real-time
    const currentDebts = [];
    document.querySelectorAll('.clean-debt-item').forEach(item => {
        const name = item.querySelector('.debt-name')?.value || '';
        const balance = parseFloat(item.querySelector('.debt-balance')?.value) || 0;
        const interest = parseFloat(item.querySelector('.debt-interest')?.value) || 0;
        
        if (balance > 0) {
            currentDebts.push({ name, balance, interest });
        }
    });
    
    const totalDebt = currentDebts.reduce((sum, debt) => sum + debt.balance, 0);
    const monthlyDebtPayments = currentDebts.reduce((sum, debt) => sum + Math.max(debt.balance * 0.02, 25), 0);
    const netWorth = savings - totalDebt;
    
    if (savings > 0 || totalDebt > 0) {
        previewDiv.classList.remove('hidden');
        
        if (previewSavings) previewSavings.textContent = `£${savings.toLocaleString()}`;
        if (previewDebt) previewDebt.textContent = `£${totalDebt.toLocaleString()}`;
        if (previewNetWorth) {
            previewNetWorth.textContent = `£${netWorth.toLocaleString()}`;
            previewNetWorth.className = `font-mono ${netWorth >= 0 ? 'text-green-600' : 'text-red-600'}`;
        }
        if (previewDebtPayments) previewDebtPayments.textContent = `£${monthlyDebtPayments.toLocaleString()}`;
    } else {
        previewDiv.classList.add('hidden');
    }
}

// Step 3C: Timeline & Review  
function prepareGoalReview() {
    const container = document.getElementById('clean-goal-review-content');
    const data = cleanOnboardingData.data;
    const goalDetails = data.goalDetails || {};
    
    const target = goalDetails.target || 0;
    const current = goalDetails.current || 0;
    const monthlyCommitment = goalDetails.monthlyCommitment || 0;
    const remaining = Math.max(target - current, 0);
    const monthsToComplete = monthlyCommitment > 0 ? Math.ceil(remaining / monthlyCommitment) : 0;
    const currentProgress = target > 0 ? (current / target) * 100 : 0;
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">📊</div>
            <h2 class="text-xl font-semibold mb-2">Your Goal Timeline</h2>
            <p class="text-gray-600 dark:text-gray-400">Review your plan before proceeding</p>
        </div>
        
        <div class="space-y-6">
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                <h3 class="font-medium mb-3">Goal Summary</h3>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span>Target:</span>
                        <span class="font-mono">£${target.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>Current:</span>
                        <span class="font-mono">£${current.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>Still needed:</span>
                        <span class="font-mono">£${remaining.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>Monthly commitment:</span>
                        <span class="font-mono">£${monthlyCommitment.toLocaleString()}</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                <h3 class="font-medium mb-3 text-blue-700 dark:text-blue-300">Timeline Projection</h3>
                <div class="text-center mb-4">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">
                        ${monthsToComplete} months
                    </div>
                    <div class="text-sm text-blue-600 dark:text-blue-400">to reach your goal</div>
                </div>
                
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                    <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${Math.min(currentProgress, 100)}%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                    <span>${currentProgress.toFixed(1)}% complete</span>
                    <span>${target > 0 ? ((target - current) / target * 100).toFixed(1) : 0}% remaining</span>
                </div>
            </div>
            
            ${monthsToComplete > 36 ? `
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700 dark:text-yellow-300">
                                This timeline is quite long. Consider increasing your monthly commitment or adjusting your target to reach your goal sooner.
                            </p>
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// Step 5: Goal Activation (ENHANCED)
// Step 5: Goal Activation (ENHANCED, patched)
function prepareGoalActivation() {
    const container = document.getElementById('clean-goal-activation-content');
    if (!container) return;

    // Build shell first so #clean-summary-content exists
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">🚀</div>
            <h2 class="text-xl font-semibold mb-2">Activate Your Goal</h2>
            <p class="text-gray-600 dark:text-gray-400">Your personalized goal tracker is ready to go!</p>
        </div>

        <!-- Plan Summary -->
        <div class="card p-4 mb-6">
            <h3 class="font-medium mb-4">Your Plan Summary</h3>
            <div id="clean-summary-content"></div>
        </div>

        <!-- Next Steps -->
        <div class="card p-4 mb-6">
            <h3 class="font-medium mb-4">What Happens Next</h3>
            <div class="space-y-3">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-xs font-medium text-blue-600 dark:text-blue-400">1</div>
                    <div>
                        <div class="font-medium">Your goal will be activated</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">All goals and budgets will be set up in your account</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-xs font-medium text-blue-600 dark:text-blue-400">2</div>
                    <div>
                        <div class="font-medium">Start tracking expenses</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Log your spending to stay on track with your budget</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-xs font-medium text-blue-600 dark:text-blue-400">3</div>
                    <div>
                        <div class="font-medium">Monitor your progress</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Watch your goals grow and adjust as needed</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Health Preview -->
        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 mb-6">
            <h4 class="font-medium mb-3 text-green-700 dark:text-green-300">Your Financial Health Score</h4>
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="activation-health-score">Calculating...</div>
                    <div class="text-sm text-green-600 dark:text-green-400">Expected score with this plan</div>
                </div>
                <div class="text-4xl">📈</div>
            </div>
        </div>

        <!-- Ready to activate -->
        <div class="text-center">
            <div class="text-gray-600 dark:text-gray-400">Click "Activate My Goal" below to complete setup</div>
        </div>
    `;

    // Populate summary and score once container is in DOM
    generateCleanSummary();
    calculateActivationHealthScore();
}

function calculateActivationHealthScore() {
    const data = cleanOnboardingData.data;
    const scoreElement = document.getElementById('activation-health-score');
    
    if (!scoreElement) return;
    
    // Simplified health score calculation
    let score = 50; // Base score
    
    // Income vs Budget ratio
    const surplus = data.monthlyIncome - data.monthlyBudget;
    const surplusRatio = surplus / data.monthlyIncome;
    if (surplusRatio > 0.2) score += 20;
    else if (surplusRatio > 0.1) score += 10;
    else if (surplusRatio < 0) score -= 30;
    
    // Savings to income ratio
    const savingsRatio = data.totalSavings / (data.monthlyIncome * 12);
    if (savingsRatio > 0.5) score += 15;
    else if (savingsRatio > 0.25) score += 10;
    else if (savingsRatio > 0.1) score += 5;
    
    // Debt considerations
    const totalDebt = data.debts.reduce((sum, debt) => sum + debt.balance, 0);
    if (totalDebt === 0) score += 10;
    else if (totalDebt < data.monthlyIncome * 6) score += 5;
    else if (totalDebt > data.monthlyIncome * 12) score -= 15;
    
    // Goal commitment
    if (data.goalDetails.monthlyCommitment > 0) score += 10;
    
    // Cap the score
    score = Math.max(0, Math.min(100, score));
    
    scoreElement.textContent = `${Math.round(score)}/100`;
}

function activateGoal() {
    console.log('activateGoal function called');
    // This function will complete the onboarding
    finishCleanOnboarding();
}

        // Ensure function is globally accessible
        window.activateGoal = activateGoal;

        // 🚨 ADD THIS FUNCTION TO YOUR CODE (Emergency Reset)
        window.emergencyHealthScoreReset = function() {
            console.log('🚨 EMERGENCY: Forcing health score reset...');
            
            // Find and forcibly clear the health score display
            const healthScoreElement = document.querySelector('#health-score-value') || 
                                      document.querySelector('[id*="health-score"]') ||
                                      document.querySelector('.health-score');
            
            if (healthScoreElement) {
                healthScoreElement.textContent = '0';
                console.log('✅ Forced health score to 0');
            }
            
            // Clear any contaminated stored data
            try {
                const lensData = JSON.parse(localStorage.getItem('lensAppData') || '{}');
                if (lensData.healthScoreHistory) {
                    lensData.healthScoreHistory = {};
                    localStorage.setItem('lensAppData', JSON.stringify(lensData));
                    console.log('✅ Cleared localStorage health score history');
                }
            } catch (e) {
                console.log('Could not clear localStorage');
            }
            
            // Force a complete recalculation
            if (typeof updateDisplay === 'function') {
                updateDisplay();
                console.log('✅ Triggered updateDisplay()');
            }
            
            console.log('Emergency reset complete!');
        };

        // 🚨 IMMEDIATE DEBUG - Add this to your console to see what's happening
        window.debugHealthScore = function() {
            console.log('=== HEALTH SCORE DEBUG ===');
            console.log('DOMElements.healthScoreValue:', DOMElements?.healthScoreValue);
            console.log('Element by ID:', document.getElementById('health-score-value'));
            console.log('Current textContent:', document.getElementById('health-score-value')?.textContent);
            console.log('All health score elements:', document.querySelectorAll('[id*="health"]'));
            
            // Check if there's any element showing £211.26
            const allElements = document.querySelectorAll('*');
            const problematicElements = [];
            allElements.forEach(el => {
                if (el.textContent && el.textContent.includes('£211.26')) {
                    problematicElements.push({
                        element: el,
                        id: el.id,
                        class: el.className,
                        textContent: el.textContent
                    });
                }
            });
            console.log('Elements showing £211.26:', problematicElements);
        };

function activateGoalSafely() {
    try {
        // Validate that we have minimum required data
        const data = cleanOnboardingData.data;
        
        if (!data.monthlyIncome || !data.monthlyBudget || !data.primaryGoal) {
            throw new Error('Missing required data: income, budget, or goal');
        }
        
        // Ensure goalDetails exists
        if (!data.goalDetails) {
            data.goalDetails = {};
        }
        
        // Validate goal-specific data and set defaults if missing
        if (data.primaryGoal === 'house') {
            if (!data.goalDetails['house-target']) {
                data.goalDetails['house-target'] = 50000; // Default house target
            }
            if (!data.goalDetails['house-current']) {
                data.goalDetails['house-current'] = 0;
            }
        } else if (data.primaryGoal === 'emergency') {
            if (!data.goalDetails['emergency-months']) {
                data.goalDetails['emergency-months'] = '6 months expenses';
            }
            if (!data.goalDetails['emergency-current']) {
                data.goalDetails['emergency-current'] = 0;
            }
        } else if (data.primaryGoal === 'vacation') {
            if (!data.goalDetails['vacation-cost']) {
                data.goalDetails['vacation-cost'] = 3000;
            }
            if (!data.goalDetails['vacation-current']) {
                data.goalDetails['vacation-current'] = 0;
            }
        } else if (data.primaryGoal === 'investment') {
            if (!data.goalDetails['investment-target']) {
                data.goalDetails['investment-target'] = 10000;
            }
            if (!data.goalDetails['investment-current']) {
                data.goalDetails['investment-current'] = 0;
            }
        }
        
        // Ensure debts array exists
        if (!data.debts) {
            data.debts = [];
        }
        
        // Ensure savings value exists
        if (!data.totalSavings) {
            data.totalSavings = 0;
        }
        
        console.log('Activating goal with validated data:', data);
        
        // Now call the finish function with validated data
        finishCleanOnboarding();
        
    } catch (error) {
        console.error('Error activating goal:', error);
        showToast('Error setting up your goal. Using default values...', 'warning');
        
        // Set safe defaults and try again
        cleanOnboardingData.data.goalDetails = {
            target: 5000,
            current: 0,
            monthlyCommitment: 250
        };
        cleanOnboardingData.data.debts = cleanOnboardingData.data.debts || [];
        cleanOnboardingData.data.totalSavings = cleanOnboardingData.data.totalSavings || 0;
        
        finishCleanOnboarding();
    }
}

/**
 * Skip onboarding process and set up app with default values
 * Provides a quick start option for users who want to explore the app
 */
function skipOnboarding() {
    // Initialize with sensible default values
    cleanOnboardingData.data.monthlyIncome = 10000;
    cleanOnboardingData.data.monthlyBudget = 4000;
    cleanOnboardingData.data.primaryGoal = 'emergency';
    cleanOnboardingData.data.goalDetails = {
        target: 5000,
        current: 0,
        monthlyCommitment: 250
    };
    cleanOnboardingData.data.debts = [];
    cleanOnboardingData.data.totalSavings = 0;
    
    // Process defaults through normal onboarding completion
    finishCleanOnboarding();
}

/**
 * Validate goal detail inputs during onboarding
 * Ensures all required fields are filled and values are valid
 * @returns {boolean} True if all validation passes
 */
function validateCleanGoalDetails() {
    const inputs = document.querySelectorAll('#clean-goal-details-content input, #clean-goal-details-content select');
    let valid = true;
    
    inputs.forEach(input => {
        if (input.type === 'number') {
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0) {
                valid = false;
            } else {
                cleanOnboardingData.data.goalDetails[input.id] = value;
            }
        } else {
            if (!input.value.trim()) {
                valid = false;
            } else {
                cleanOnboardingData.data.goalDetails[input.id] = input.value;
            }
        }
    });
    
    if (!valid) {
        showToast('Please fill in all goal details', 'error');
        return false;
    }
    return true;
}

function updateCommitmentCalculations() {
    const targetInput = document.getElementById('goal-target');
    const currentInput = document.getElementById('goal-current');
    const slider = document.getElementById('monthly-commitment-slider') || document.getElementById('monthly-commitment-slider-alt');
    const commitmentAmount = document.getElementById('commitment-amount');
    const timelineDisplay = document.getElementById('timeline-display');
    const timelineMonths = document.getElementById('timeline-months');
    const timelineProgress = document.getElementById('timeline-progress');
    const timelineCurrent = document.getElementById('timeline-current');
    const timelineTarget = document.getElementById('timeline-target');
    const warningDiv = document.getElementById('commitment-warning');
    const warningText = document.getElementById('warning-text');
    
    if (!targetInput || !currentInput || !slider) return;
    
    const target = parseFloat(targetInput.value) || 0;
    const current = parseFloat(currentInput.value) || 0;
    const monthlyCommitment = parseFloat(slider.value) || 0;
    const remaining = Math.max(target - current, 0);
    
    // Update commitment amount display
    if (commitmentAmount) {
        commitmentAmount.textContent = `£${monthlyCommitment.toLocaleString()}`;
    }
    
    // Save to onboarding data
    cleanOnboardingData.data.goalDetails = {
        target: target,
        current: current,
        monthlyCommitment: monthlyCommitment
    };
    
    if (target > 0 && monthlyCommitment > 0) {
        // Calculate timeline
        const monthsToComplete = Math.ceil(remaining / monthlyCommitment);
        const currentProgress = current > 0 ? (current / target) * 100 : 0;
        
        // Show timeline
        if (timelineDisplay) timelineDisplay.classList.remove('hidden');
        if (timelineMonths) {
            timelineMonths.textContent = monthsToComplete === 1 ? '1 month' : `${monthsToComplete} months`;
        }
        if (timelineProgress) {
            timelineProgress.style.width = `${Math.min(currentProgress, 100)}%`;
        }
        if (timelineCurrent) {
            timelineCurrent.textContent = `£${current.toLocaleString()} (current)`;
        }
        if (timelineTarget) {
            timelineTarget.textContent = `£${target.toLocaleString()} (target)`;
        }
        
        // Show warnings if needed
        if (monthsToComplete > 60) {
            warningDiv.classList.remove('hidden');
            warningText.textContent = `At this rate, it will take ${monthsToComplete} months (${Math.round(monthsToComplete/12)} years) to reach your goal. Consider increasing your monthly commitment.`;
        } else if (monthlyCommitment > (cleanOnboardingData.data.monthlyIncome - cleanOnboardingData.data.monthlyBudget) * 0.8) {
            warningDiv.classList.remove('hidden');
            warningText.textContent = 'This commitment uses most of your surplus. Make sure to leave room for other goals and unexpected expenses.';
        } else {
            warningDiv.classList.add('hidden');
        }
    } else {
        if (timelineDisplay) timelineDisplay.classList.add('hidden');
        if (warningDiv) warningDiv.classList.add('hidden');
    }
    
    // Update quick options when calculations change
    generateCommitmentOptions();
}

function generateCommitmentOptions() {
    const targetInput = document.getElementById('goal-target');
    const currentInput = document.getElementById('goal-current');
    const buttonsContainer = document.getElementById('commitment-buttons');
    const optionsDiv = document.getElementById('commitment-options');
    
    if (!targetInput || !currentInput || !buttonsContainer) return;
    
    const target = parseFloat(targetInput.value) || 0;
    const current = parseFloat(currentInput.value) || 0;
    const remaining = Math.max(target - current, 0);
    const surplus = cleanOnboardingData.data.monthlyIncome - cleanOnboardingData.data.monthlyBudget;
    
    if (target > 0 && remaining > 0) {
        optionsDiv.classList.remove('hidden');
        
        // Generate smart commitment options
        const options = [];
        
        // Option 1: Complete in 1 year
        const oneYearAmount = Math.ceil(remaining / 12);
        if (oneYearAmount <= surplus) {
            options.push({ 
                label: 'Complete in 1 Year', 
                amount: oneYearAmount, 
                description: `£${oneYearAmount.toLocaleString()}/month` 
            });
        }
        
        // Option 2: Complete in 2 years
        const twoYearAmount = Math.ceil(remaining / 24);
        if (twoYearAmount <= surplus && twoYearAmount !== oneYearAmount) {
            options.push({ 
                label: 'Complete in 2 Years', 
                amount: twoYearAmount, 
                description: `£${twoYearAmount.toLocaleString()}/month` 
            });
        }
        
        // Option 3: Use 50% of surplus
        const halfSurplus = Math.floor(surplus * 0.5);
        if (halfSurplus > 0 && !options.some(opt => Math.abs(opt.amount - halfSurplus) < 50)) {
            const months = Math.ceil(remaining / halfSurplus);
            options.push({ 
                label: 'Balanced Approach', 
                amount: halfSurplus, 
                description: `£${halfSurplus.toLocaleString()}/month (${months} months)` 
            });
        }
        
        // Option 4: Aggressive (80% of surplus)
        const aggressiveAmount = Math.floor(surplus * 0.8);
        if (aggressiveAmount > halfSurplus && !options.some(opt => Math.abs(opt.amount - aggressiveAmount) < 50)) {
            const months = Math.ceil(remaining / aggressiveAmount);
            options.push({ 
                label: 'Aggressive Plan', 
                amount: aggressiveAmount, 
                description: `£${aggressiveAmount.toLocaleString()}/month (${months} months)` 
            });
        }
        
        buttonsContainer.innerHTML = options.slice(0, 4).map(option => `
            <button onclick="setCommitmentAmount(${option.amount})" 
                    class="modern-button modern-button-secondary text-left p-3">
                <div class="font-medium text-sm">${option.label}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">${option.description}</div>
            </button>
        `).join('');
    } else {
        optionsDiv.classList.add('hidden');
    }
}

function updateDebtCalculations() {
    const slider = document.getElementById('debt-extra-payment-slider');
    const strategySelect = document.getElementById('debt-strategy');
    const extraAmountSpan = document.getElementById('debt-extra-amount');
    const timelineDisplay = document.getElementById('debt-timeline-display');
    const minPaymentsSpan = document.getElementById('debt-min-payments');
    const totalPaymentSpan = document.getElementById('debt-total-payment');
    const timelineMonthsSpan = document.getElementById('debt-timeline-months');
    
    if (!slider || !cleanOnboardingData.data.debts || cleanOnboardingData.data.debts.length === 0) return;
    
    const extraPayment = parseFloat(slider.value) || 0;
    const strategy = strategySelect ? strategySelect.value : 'Avalanche (highest interest first)';
    
    // Calculate minimum payments
    const totalMinPayments = cleanOnboardingData.data.debts.reduce((sum, debt) => 
        sum + Math.max(debt.balance * 0.02, 25), 0);
    const totalPayment = totalMinPayments + extraPayment;
    
    // Update display
    if (extraAmountSpan) extraAmountSpan.textContent = `£${extraPayment.toLocaleString()}`;
    if (minPaymentsSpan) minPaymentsSpan.textContent = `£${totalMinPayments.toLocaleString()}`;
    if (totalPaymentSpan) totalPaymentSpan.textContent = `£${totalPayment.toLocaleString()}`;
    
    // Calculate simplified payoff timeline
    const totalDebt = cleanOnboardingData.data.debts.reduce((sum, debt) => sum + debt.balance, 0);
    const avgInterest = cleanOnboardingData.data.debts.length > 0 ? 
        cleanOnboardingData.data.debts.reduce((sum, debt) => sum + debt.interest, 0) / cleanOnboardingData.data.debts.length : 0;
    
    // Simplified calculation - actual debt payoff is more complex with interest compounding
    const monthsToPayoff = totalPayment > 0 ? Math.ceil(totalDebt / totalPayment) : 0;
    
    if (timelineMonthsSpan) timelineMonthsSpan.textContent = `${monthsToPayoff} months`;
    
    if (timelineDisplay) {
        timelineDisplay.classList.remove('hidden');
    }
    
    // Save debt strategy to goal details
    cleanOnboardingData.data.goalDetails = {
        ...cleanOnboardingData.data.goalDetails,
        'debt-strategy': strategy,
        'debt-extra-payment': extraPayment,
        'debt-total-payment': totalPayment
    };
}

function setCommitmentAmount(amount) {
    console.log('setCommitmentAmount called with:', amount);
    
    // Find the correct slider - there might be multiple in different steps
    const sliders = [
        document.getElementById('monthly-commitment-slider'),
        document.getElementById('monthly-commitment-slider-alt')
    ].filter(Boolean); // Remove null values
    
    if (sliders.length === 0) {
        console.log('No sliders found!');
        return;
    }
    
    // Update all found sliders
    sliders.forEach((slider, index) => {
        console.log(`Updating slider ${index + 1}, current value:`, slider.value);
        slider.value = amount;
        console.log(`Slider ${index + 1} value set to:`, slider.value);
        
        // Trigger events
        slider.dispatchEvent(new Event('input', { bubbles: true }));
        slider.dispatchEvent(new Event('change', { bubbles: true }));
    });
    
    // Call update function
    updateCommitmentCalculations();
    console.log('updateCommitmentCalculations called');
}

// 3. ADD missing debt management functions
function addCleanDebt() {
    const debtList = document.getElementById('clean-debt-list');
    const debtItem = document.createElement('div');
    debtItem.className = 'clean-debt-item';
    debtItem.innerHTML = `
        <div class="space-y-3">
            <input type="text" placeholder="Debt name (e.g., Credit Card)" class="modern-input debt-name text-sm font-medium text-center">
            <div class="grid grid-cols-2 gap-2">
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium text-sm">£</span>
                    <input type="number" placeholder="5,000" class="modern-input pl-8 debt-balance text-sm font-semibold text-center" oninput="updateFinancialPreview()">
                </div>
                <input type="number" placeholder="18.9%" step="0.1" class="modern-input debt-interest text-sm font-semibold text-center" oninput="updateFinancialPreview()">
            </div>
            <button onclick="removeCleanDebt(this)" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
        </div>
    `;
    debtList.appendChild(debtItem);
}

// New function for debt entry in goal planning (Step 3)
function addDebtEntry() {
    const debtList = document.getElementById('debt-entry-list');
    if (!debtList) return;
    
    const debtItem = document.createElement('div');
    debtItem.className = 'debt-entry-item border border-gray-200 dark:border-gray-600 rounded-lg p-4';
    debtItem.innerHTML = `
        <div class="space-y-3">
            <input type="text" placeholder="Debt name (e.g., Credit Card)" class="modern-input debt-name text-sm font-medium">
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Balance</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium text-sm">£</span>
                        <input type="number" placeholder="5,000" class="modern-input pl-8 debt-balance text-sm font-semibold" oninput="updateDebtSummary()">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Interest Rate (%)</label>
                    <input type="number" placeholder="18.9" step="0.1" class="modern-input debt-interest text-sm font-semibold" oninput="updateDebtSummary()">
                </div>
            </div>
            <button onclick="removeDebtEntry(this)" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
        </div>
    `;
    debtList.appendChild(debtItem);
    
    // Auto-add first debt entry if this is the first one
    if (debtList.children.length === 1) {
        updateDebtSummary();
    }
}

function removeDebtEntry(button) {
    button.closest('.debt-entry-item').remove();
    updateDebtSummary();
}

function updateDebtSummary() {
    const debtItems = document.querySelectorAll('.debt-entry-item');
    let totalDebt = 0;
    const debts = [];
    
    console.log('updateDebtSummary called, found', debtItems.length, 'debt items');
    
    debtItems.forEach((item, index) => {
        const name = item.querySelector('.debt-name').value || '';
        const balance = parseFloat(item.querySelector('.debt-balance').value) || 0;
        const interest = parseFloat(item.querySelector('.debt-interest').value) || 0;
        
        console.log(`Debt ${index + 1}:`, { name, balance, interest });
        
        if (balance > 0) {
            totalDebt += balance;
            debts.push({ name: name || 'Debt', balance, interest });
        }
    });
    
    console.log('Total debts collected:', debts);
    console.log('Total debt amount:', totalDebt);
    
    // Update cleanOnboardingData
    cleanOnboardingData.data.debts = debts;
    console.log('Updated cleanOnboardingData.data.debts:', cleanOnboardingData.data.debts);
    
    // Update UI
    const summarySection = document.getElementById('debt-summary-section');
    const totalDisplay = document.getElementById('total-debt-display');
    const countDisplay = document.getElementById('debt-count-display');
    
    if (summarySection && totalDisplay && countDisplay) {
        if (totalDebt > 0) {
            summarySection.classList.remove('hidden');
            totalDisplay.textContent = `£${totalDebt.toLocaleString()}`;
            countDisplay.textContent = `From ${debts.length} debt(s) you entered`;
        } else {
            summarySection.classList.add('hidden');
        }
    }
    
    // Update debt calculations if elements exist
    updateDebtCalculations();
}

function removeCleanDebt(button) {
    button.closest('.clean-debt-item').remove();
    updateFinancialPreview();
}

function skipCleanDebts() {
    cleanOnboardingData.data.debts = [];
    goCleanNext();
}

function collectCleanDebts() {
    const debtItems = document.querySelectorAll('.clean-debt-item');
    const newDebts = [];
    
    // Only clear debts if we find debt items in the DOM
    if (debtItems.length > 0) {
        debtItems.forEach(item => {
            const nameInput = item.querySelector('.debt-name');
            const balanceInput = item.querySelector('.debt-balance');
            const interestInput = item.querySelector('.debt-interest');
            
            if (nameInput && balanceInput && interestInput) {
                const name = nameInput.value || '';
                const balance = parseFloat(balanceInput.value) || 0;
                const interest = parseFloat(interestInput.value) || 0;
                
                // Include debt even if name is empty, as long as balance > 0
                if (balance > 0) {
                    newDebts.push({
                        name: name || 'Unnamed Debt',
                        balance: balance,
                        interest: interest
                    });
                }
            }
        });
        
        // Only update the debts array if we found actual debt items
        cleanOnboardingData.data.debts = newDebts;
        console.log('Collected debts from', debtItems.length, 'items:', cleanOnboardingData.data.debts);
    } else {
        // No debt items found in DOM - preserve existing debt data
        console.log('No debt items found in DOM, preserving existing debts:', cleanOnboardingData.data.debts);
    }
}

// Data persistence functions
function saveCurrentStepData() {
    const step = cleanOnboardingData.currentStep;
    console.log('saveCurrentStepData called for step:', step);
    
    try {
        switch (step) {
            case 1:
                // Save income and budget
                const incomeInput = document.getElementById('clean-income-input');
                const budgetInput = document.getElementById('clean-budget-input');
                if (incomeInput) cleanOnboardingData.data.monthlyIncome = parseFloat(incomeInput.value) || 0;
                if (budgetInput) cleanOnboardingData.data.monthlyBudget = parseFloat(budgetInput.value) || 0;
                break;
                
            case 2:
                // Save selected goal - handled by click event
                break;
                
            case 3:
                // Step 3: Save complete goal planning (target, current, commitment)
                // Ensure goalDetails object exists
                if (!cleanOnboardingData.data.goalDetails) {
                    cleanOnboardingData.data.goalDetails = {};
                }
                const targetInput = document.getElementById('goal-target');
                const currentInput = document.getElementById('goal-current');
                const slider = document.getElementById('monthly-commitment-slider') || document.getElementById('monthly-commitment-slider-alt');
                
                // Save both generic and goal-specific field names for compatibility
                const targetValue = parseFloat(targetInput?.value) || 0;
                const currentValue = parseFloat(currentInput?.value) || 0;
                const commitmentValue = parseFloat(slider?.value) || 0;
                
                // Generic field names (for new Step 3 consolidated approach)
                cleanOnboardingData.data.goalDetails.target = targetValue;
                cleanOnboardingData.data.goalDetails.current = currentValue;
                cleanOnboardingData.data.goalDetails.monthlyCommitment = commitmentValue;
                
                // Goal-specific field names (for backward compatibility and summary function)
                const goal = cleanOnboardingData.data.primaryGoal;
                if (goal === 'house') {
                    cleanOnboardingData.data.goalDetails['house-target'] = targetValue;
                    cleanOnboardingData.data.goalDetails['house-current'] = currentValue;
                    cleanOnboardingData.data.goalDetails['house-commitment'] = commitmentValue;
                } else if (goal === 'vacation') {
                    cleanOnboardingData.data.goalDetails['vacation-cost'] = targetValue;
                    cleanOnboardingData.data.goalDetails['vacation-current'] = currentValue;
                    cleanOnboardingData.data.goalDetails['vacation-commitment'] = commitmentValue;
                } else if (goal === 'emergency') {
                    // For emergency funds, save the user's target amount and current allocation
                    cleanOnboardingData.data.goalDetails['emergency-target'] = targetValue;
                    cleanOnboardingData.data.goalDetails['emergency-current'] = currentValue;
                    const months = cleanOnboardingData.data.monthlyExpenses > 0 ? Math.round(targetValue / cleanOnboardingData.data.monthlyExpenses) : 0;
                    cleanOnboardingData.data.goalDetails['emergency-months'] = months;
                    cleanOnboardingData.data.goalDetails['emergency-commitment'] = commitmentValue;
                } else if (goal === 'investment') {
                    cleanOnboardingData.data.goalDetails['investment-target'] = targetValue;
                    cleanOnboardingData.data.goalDetails['investment-current'] = currentValue;
                    cleanOnboardingData.data.goalDetails['investment-commitment'] = commitmentValue;
                } else if (goal === 'custom') {
                    cleanOnboardingData.data.goalDetails['custom-target'] = targetValue;
                    cleanOnboardingData.data.goalDetails['custom-current'] = currentValue;
                    cleanOnboardingData.data.goalDetails['custom-commitment'] = commitmentValue;
                } else if (goal === 'debt') {
                    // For debt goals, collect debt data from Step 3 form
                    const debtItems = document.querySelectorAll('.debt-entry-item');
                    const debts = [];
                    
                    debtItems.forEach(item => {
                        const name = item.querySelector('.debt-name').value || '';
                        const balance = parseFloat(item.querySelector('.debt-balance').value) || 0;
                        const interest = parseFloat(item.querySelector('.debt-interest').value) || 0;
                        
                        if (balance > 0) {
                            debts.push({ name: name || 'Debt', balance, interest });
                        }
                    });
                    
                    cleanOnboardingData.data.debts = debts;
                    console.log('Saved debts in case 3:', debts);
                    
                    // Save strategy and extra payment
                    const strategy = document.getElementById('debt-strategy')?.value || '';
                    const extraPayment = parseFloat(document.getElementById('debt-extra-payment-slider')?.value) || 0;
                    
                    cleanOnboardingData.data.goalDetails['debt-strategy'] = strategy;
                    cleanOnboardingData.data.goalDetails['debt-extra-payment'] = extraPayment;
                    
                    const totalDebt = debts.reduce((sum, debt) => sum + debt.balance, 0);
                    cleanOnboardingData.data.goalDetails.target = totalDebt;
                    cleanOnboardingData.data.goalDetails.current = 0;
                    cleanOnboardingData.data.goalDetails.monthlyCommitment = extraPayment;
                }
                break;
                
            case 4:
                // Step 4: Save financial position and debts - SIMPLE AND DIRECT
                const savingsInput = document.getElementById('clean-total-savings-input');
                if (savingsInput) {
                    cleanOnboardingData.data.totalSavings = parseFloat(savingsInput.value) || 0;
                }
                
                cleanOnboardingData.data.monthlyExpenses = cleanOnboardingData.data.monthlyBudget;
                
                // Save debts directly (but only if not a debt payoff goal - debt goals collect debt data in Step 3)
                if (cleanOnboardingData.data.primaryGoal !== 'debt') {
                    cleanOnboardingData.data.debts = [];
                    document.querySelectorAll('.clean-debt-item').forEach(item => {
                        const name = item.querySelector('.debt-name')?.value || '';
                        const balance = parseFloat(item.querySelector('.debt-balance')?.value) || 0;
                        const interest = parseFloat(item.querySelector('.debt-interest')?.value) || 0;
                    
                        if (balance > 0) {
                            cleanOnboardingData.data.debts.push({
                                name: name || 'Debt',
                                balance: balance,
                                interest: interest
                            });
                        }
                    });
                } else {
                    // For debt payoff goals, preserve existing debt data from Step 3
                    console.log('Step 4: Preserving debt data for debt goal:', cleanOnboardingData.data.debts);
                }
                break;
        }
    } catch (error) {
        console.log('Error saving step data:', error);
    }
}

function restoreCurrentStepData() {
    const step = cleanOnboardingData.currentStep;
    const data = cleanOnboardingData.data;
    
    try {
        switch (step) {
            case 1:
                // Restore income and budget
                const incomeInput = document.getElementById('clean-income-input');
                const budgetInput = document.getElementById('clean-budget-input');
                if (incomeInput && data.monthlyIncome) incomeInput.value = data.monthlyIncome;
                if (budgetInput && data.monthlyBudget) budgetInput.value = data.monthlyBudget;
                break;
                
            case 2:
                // Restore selected goal
                if (data.primaryGoal) {
                    const selectedOption = document.querySelector(`[data-goal="${data.primaryGoal}"]`);
                    if (selectedOption) {
                        document.querySelectorAll('.clean-goal-option').forEach(opt => opt.classList.remove('selected'));
                        selectedOption.classList.add('selected');
                    }
                }
                break;
                
            case 3:
                // Step 3: Restore complete goal planning
                const targetInput = document.getElementById('goal-target');
                const currentInput = document.getElementById('goal-current');
                const slider = document.getElementById('monthly-commitment-slider') || document.getElementById('monthly-commitment-slider-alt');
                
                if (data.goalDetails) {
                    if (targetInput && data.goalDetails.target) targetInput.value = data.goalDetails.target;
                    if (currentInput && data.goalDetails.current) currentInput.value = data.goalDetails.current;
                    if (slider && data.goalDetails.monthlyCommitment) {
                        slider.value = data.goalDetails.monthlyCommitment;
                        // Trigger calculations after restoration
                        setTimeout(() => updateCommitmentCalculations(), 100);
                    }
                }
                break;
                
            case 4:
                // Step 4: Restore financial position and debts - SIMPLE AND DIRECT
                setTimeout(() => {
                    // Restore savings
                    const savingsInput = document.getElementById('clean-total-savings-input');
                    if (savingsInput) {
                        if (data.totalSavings) {
                            savingsInput.value = data.totalSavings;
                        } else {
                            savingsInput.value = '';
                            savingsInput.placeholder = '2,500';
                        }
                    }
                    
                    // Restore debts
                    const debtList = document.getElementById('clean-debt-list');
                    if (debtList && data.debts && data.debts.length > 0) {
                        debtList.innerHTML = '';
                        
                        data.debts.forEach(debt => {
                            addCleanDebt();
                            const lastItem = debtList.lastElementChild;
                            if (lastItem) {
                                const nameInput = lastItem.querySelector('.debt-name');
                                const balanceInput = lastItem.querySelector('.debt-balance');
                                const interestInput = lastItem.querySelector('.debt-interest');
                                
                                if (nameInput) nameInput.value = debt.name || '';
                                if (balanceInput) balanceInput.value = debt.balance || '';
                                if (interestInput) interestInput.value = debt.interest || '';
                            }
                        });
                    }
                    
                    // Update preview
                    updateFinancialPreview();
                }, 300);
                break;
        }
    } catch (error) {
        console.log('Error restoring step data:', error);
    }
}

function restoreDebts() {
    const debtList = document.getElementById('clean-debt-list');
    if (!debtList) {
        console.log('ERROR: Debt list element not found');
        return;
    }
    
    const debts = cleanOnboardingData.data.debts || [];
    console.log('Restoring debts - found', debts.length, 'debts:', debts);
    
    // Clear existing debt items
    debtList.innerHTML = '';
    
    if (debts.length === 0) {
        console.log('No debts to restore');
        return;
    }
    
    // Restore saved debts
    debts.forEach((debt, index) => {
        addCleanDebt();
        const lastDebtItem = debtList.lastElementChild;
        if (lastDebtItem) {
            const nameInput = lastDebtItem.querySelector('.debt-name');
            const balanceInput = lastDebtItem.querySelector('.debt-balance');
            const interestInput = lastDebtItem.querySelector('.debt-interest');
            
            if (nameInput) {
                nameInput.value = debt.name || '';
                console.log(`Restored debt ${index + 1} name:`, debt.name);
            }
            if (balanceInput) {
                balanceInput.value = debt.balance || '';
                console.log(`Restored debt ${index + 1} balance:`, debt.balance);
            }
            if (interestInput) {
                interestInput.value = debt.interest || '';
                console.log(`Restored debt ${index + 1} interest:`, debt.interest);
            }
            
            // Ensure event listeners are working by manually adding them if needed
            if (balanceInput && !balanceInput.hasAttribute('data-listener-added')) {
                balanceInput.addEventListener('input', updateFinancialPreview);
                balanceInput.setAttribute('data-listener-added', 'true');
            }
            if (interestInput && !interestInput.hasAttribute('data-listener-added')) {
                interestInput.addEventListener('input', updateFinancialPreview);
                interestInput.setAttribute('data-listener-added', 'true');
            }
        }
    });
    
    // Trigger financial preview update after debt restoration
    setTimeout(() => {
        updateFinancialPreview();
    }, 50);
}

// 4. ADD missing generateCleanSummary function
function generateCleanSummary() {
    const container = document.getElementById('clean-summary-content');
    const data = cleanOnboardingData.data;
    
    const monthlySurplus = data.monthlyIncome - data.monthlyExpenses;
    const totalDebt = data.debts.reduce((sum, debt) => sum + debt.balance, 0);
    
    // Helper function to get goal-specific values with proper mapping
    function getGoalValues(goalType) {
        const details = data.goalDetails;
        let target = 0, current = 0, monthlyCommitment = 0;
        
        switch (goalType) {
            case 'house':
                target = details['house-target'] || details.target || 0;
                current = details['house-current'] || details.current || 0;
                monthlyCommitment = details['house-commitment'] || details.monthlyCommitment || 0;
                break;
            case 'vacation':
                target = details['vacation-cost'] || details.target || 0;
                current = details['vacation-current'] || details.current || 0;
                monthlyCommitment = details['vacation-commitment'] || details.monthlyCommitment || 0;
                break;
            case 'emergency':
                const months = details['emergency-months'] || 0;
                target = months * data.monthlyExpenses || details.target || 0;
                current = details['emergency-current'] || details.current || 0;
                monthlyCommitment = details['emergency-commitment'] || details.monthlyCommitment || 0;
                break;
            case 'investment':
                target = details['investment-target'] || details.target || 0;
                current = details['investment-current'] || details.current || 0;
                monthlyCommitment = details['investment-commitment'] || details.monthlyCommitment || 0;
                break;
            case 'custom':
                target = details['custom-target'] || details.target || 0;
                current = details['custom-current'] || details.current || 0;
                monthlyCommitment = details['custom-commitment'] || details.monthlyCommitment || 0;
                break;
        }
        
        return { target, current, monthlyCommitment };
    }
    
    let goalSummary = '';
    if (data.primaryGoal === 'house') {
        const { target, current, monthlyCommitment } = getGoalValues('house');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">🏠</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">House Deposit Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already saved:</span>
                                <span class="highlight-number font-mono">£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'emergency') {
        const { target, current, monthlyCommitment } = getGoalValues('emergency');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        const currentCoverage = data.monthlyExpenses > 0 ? (current / data.monthlyExpenses).toFixed(1) : '0.0';
        const targetCoverage = data.monthlyExpenses > 0 ? (target / data.monthlyExpenses).toFixed(1) : '0.0';
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">💰</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Emergency Fund Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">£${target.toLocaleString()} (${targetCoverage} months)</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already saved:</span>
                                <span class="highlight-number font-mono">£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Current coverage:</span>
                                <span class="highlight-number font-mono">${currentCoverage} months</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'vacation') {
        const { target, current, monthlyCommitment } = getGoalValues('vacation');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">✈️</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Vacation Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already saved:</span>
                                <span class="highlight-number font-mono">£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'investment') {
        const { target, current, monthlyCommitment } = getGoalValues('investment');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">📈</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Investment Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already invested:</span>
                                <span class="highlight-number font-mono">£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'custom') {
        const { target, current, monthlyCommitment } = getGoalValues('custom');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">🎯</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Custom Goal</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already saved:</span>
                                <span class="highlight-number font-mono">£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'debt') {
        // Calculate debt payoff strategy
        const strategy = data.goalDetails['debt-strategy'] || 'Avalanche (highest interest first)';
        const totalMinPayments = data.debts.reduce((sum, debt) => sum + Math.max(debt.balance * 0.02, 25), 0);
        const extraPayment = Math.max(monthlySurplus - 50, 0); // Leave £50 buffer
        const totalPayment = totalMinPayments + extraPayment;
        
        // Calculate payoff timeline (simplified calculation)
        const avgInterest = data.debts.length > 0 ? 
            data.debts.reduce((sum, debt) => sum + debt.interest, 0) / data.debts.length : 0;
        const monthsToPayoff = totalDebt > 0 && totalPayment > 0 ? 
            Math.ceil(totalDebt / totalPayment) : 0;
        
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">💳</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Debt Payoff Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Strategy:</span>
                                <span class="highlight-number font-mono">${strategy.split(' ')[0]}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Total Monthly Payment:</span>
                                <span class="highlight-number font-mono">£${totalPayment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Payoff Timeline:</span>
                                <span class="highlight-number font-mono">${monthsToPayoff} months</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Extra Payment:</span>
                                <span class="highlight-number text-green-600 font-mono">+£${extraPayment.toLocaleString()}/month</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = `
        <div class="clean-summary-card">
            <div class="flex gap-2">
                <div class="text-lg flex-shrink-0">💡</div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-semibold mb-2">Financial Overview</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span>Monthly Income:</span>
                            <span class="highlight-number font-mono">£${data.monthlyIncome.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span>Monthly Surplus:</span>
                            <span class="highlight-number font-mono">£${monthlySurplus.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span>Total Savings:</span>
                            <span class="highlight-number font-mono">£${data.totalSavings.toLocaleString()}</span>
                        </div>
                        ${totalDebt > 0 ? `<div class="flex justify-between items-center text-sm gap-2">
                            <span>Total Debt:</span>
                            <span class="highlight-number text-red-600 font-mono">£${totalDebt.toLocaleString()}</span>
                        </div>` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        ${goalSummary}
        
        <div class="clean-summary-card">
            <div class="flex gap-2">
                <div class="text-lg flex-shrink-0">🎯</div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-semibold mb-2">What's Next</h3>
                    <ul class="text-sm space-y-1 list-disc list-inside text-gray-600 dark:text-gray-400">
                        <li>Track expenses with real-time goal impact</li>
                        <li>Get personalized spending recommendations</li>
                        <li>Monitor progress toward your ${data.primaryGoal} goal</li>
                        <li>Receive smart financial insights</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
}

// Goal selection handler
document.addEventListener('click', function(e) {
    if (e.target.closest('.clean-goal-option')) {
        e.preventDefault();
        e.stopPropagation();
        
        const option = e.target.closest('.clean-goal-option');
        const goalType = option.getAttribute('data-goal');
        
        // Clear previous selections
        document.querySelectorAll('.clean-goal-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // Select this option
        option.classList.add('selected');
        cleanOnboardingData.data.primaryGoal = goalType;
        
        // Debug logging
        console.log('Goal selected:', goalType, cleanOnboardingData.data.primaryGoal);
        
        // Explicitly prevent any auto-advancement
        return false;
    }
});

        function launchOnboardingTour() {
            const driver = window.driver?.js?.driver;
            if (!driver) {
                console.log('Driver.js not available, skipping tour');
                return;
            }
            
            // Close any open modals before starting tour
            const settingsMenu = document.getElementById('settings-menu');
            if (settingsMenu && !settingsMenu.classList.contains('hidden')) {
                settingsMenu.classList.add('hidden');
            }
            
            const isMobile = window.innerWidth < 768;

            const desktopSteps = [
                {
                    element: '[data-tour="app-header"]',
                    popover: { title: 'Welcome to Lens! 👋', description: "Your personal finance tracker is ready. Let's take a quick tour to get you started with tracking expenses and achieving your financial goals.", side: "bottom", align: 'start' }
                },
                {
                    element: '[data-tour="budget-button"]',
                    popover: { title: 'Set Your Budget & Income 💰', description: 'Start here! Set your monthly income and budget - this creates the foundation for all your financial tracking and goal planning.', side: "top", align: 'center' }
                },
                {
                    element: '[data-tour="goals-section"]',
                    popover: { 
                        title: 'Financial Goals Hub 🎯', 
                        description: 'This is where the magic happens! Click here to set up financial goals like saving for a house, vacation, emergency fund, or paying off debt. Track your progress and stay motivated.',
                        side: "top", 
                        align: 'center'
                    }
                },
                {
                    element: '[data-tour="add-expense"]',
                    popover: { title: 'Track Your Expenses 📝', description: 'Log your daily expenses here. Every purchase, bill, and cost should be tracked to see where your money goes and stay on budget.', side: "left", align: 'start' }
                },
                {
                    element: null,
                    popover: { 
                        title: 'You\'re All Set! 🎉', 
                        description: 'You now know the basics: set your budget, create goals, and track expenses. Start with small goals and build the habit of logging expenses daily. Your financial future starts now!',
                        onDeselected: () => {
                            closeGoalsModal(); // Close goals modal when tour ends
                        }
                    }
                }
            ];

            const mobileSteps = [
                {
                    element: '[data-tour="app-header"]',
                    popover: { title: 'Welcome to Lens! 👋', description: "Your personal finance tracker is ready. Let's take a quick mobile tour to get you started.", side: "bottom", align: 'start' }
                },
                {
                    element: '[data-tour="goals-section"]',
                    popover: { 
                        title: 'Set Financial Goals 🎯', 
                        description: 'Tap here to create goals like saving for vacation, emergency fund, house deposit, or debt payoff. Track your progress and stay motivated!',
                        side: "top", 
                        align: 'center',
                        onNextClick: () => {
                            openGoalsModal();
                        }
                    }
                },
                {
                    element: '[data-tour="first-goal"]',
                    popover: { title: 'Add Your First Goal 🚀', description: 'Start here! Choose from goal templates or create a custom financial target. Set amount, timeline, and track progress.', side: "bottom", align: 'center' }
                },
                {
                    element: '[data-tour="add-expense"]',
                    popover: { title: 'Track Expenses 📱', description: 'Tap here to log expenses. Quick and easy - just enter amount, category, and description to track your spending.', side: "top", align: 'center' }
                },
                {
                    element: null,
                    popover: { 
                        title: 'Ready to Go! 🎉', 
                        description: 'You\'re all set! Start by creating a goal, then track your expenses daily. Small steps lead to big financial wins!',
                        onDeselected: () => {
                            closeGoalsModal();
                        }
                    }
                }
            ];

            const driverObj = driver({
                showProgress: true,
                popoverClass: 'driver-popover',
                steps: isMobile ? mobileSteps : desktopSteps,
                onDestroyed: () => {
                    localStorage.setItem('tourComplete', 'true');
                },
                onDeselected: (element, step, options) => {
                    // Only mark complete if user reaches the last step
                    const totalSteps = isMobile ? mobileSteps.length : desktopSteps.length;
                    if (step.index === totalSteps - 1) {
                        localStorage.setItem('tourComplete', 'true');
                    }
                }
            });

            driverObj.drive();
        }

        function restartTour() {
            // Close settings modal first
            closeSettings();
            
            localStorage.removeItem('tourComplete');
            
            // Add slight delay to ensure modal closes
            setTimeout(() => {
                launchOnboardingTour();
            }, 300);
        }

        // Enhanced goal-focused tour for first-time users
        function launchGoalTour() {
            // Close settings modal first
            closeSettings();
            
            // Add slight delay to ensure modal closes
            setTimeout(() => {
                const driver = window.driver?.js?.driver;
                if (!driver) return;
            
            // Check if user has existing goals to determine tour path
            const hasGoals = userGoals && userGoals.length > 0;
            
            const goalSteps = [
                {
                    element: '[data-tour="goals-section"]',
                    popover: { 
                        title: 'Goal Setting Made Easy 🎯', 
                        description: hasGoals ? 'Let\'s explore your goal management system! Here you can see your goal progress and make adjustments.' : 'Let\'s set up your first financial goal! This is the key to staying motivated and tracking progress.',
                        side: "top",
                        onNextClick: () => showGoalEditingInterface()
                    }
                },
                {
                    element: hasGoals ? '[data-tour="add-new-goal"]' : '[data-tour="first-goal"]',
                    popover: { 
                        title: hasGoals ? 'Add More Goals 🚀' : 'Choose Your Goal Type 🚀', 
                        description: hasGoals ? 'You can add additional goals here. Choose from popular templates like house deposit, vacation fund, emergency savings, or create your own custom goal.' : 'Select from popular templates like house deposit, vacation fund, emergency savings, or create your own custom goal.',
                        side: "bottom"
                    }
                }
            ];

            const goalDriver = driver({
                showProgress: true,
                popoverClass: 'driver-popover',
                steps: goalSteps,
                onDestroyed: () => closeGoalEditingModal()
            });

            goalDriver.drive();
            }, 300);
        }

        // === GOAL SYSTEM FUNCTIONS ===

function renderGoalTemplates() {
    const container = document.getElementById('goal-templates-container');
    container.innerHTML = Object.entries(goalTemplates).map(([key, template]) => `
        <div onclick="selectGoalTemplate('${key}')" class="p-6 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
            <div class="text-center">
                <div class="text-4xl mb-3">${template.icon}</div>
                <h4 class="text-lg font-semibold mb-2">${template.name}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${template.description}</p>
                <div class="text-xs text-left space-y-1">
                    ${template.goals.map(goal => `
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                            <span>${goal.name}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');
}


function removeGoal(index) {
    const goalElement = document.querySelector(`#goals-list > div:nth-child(${index + 1})`);
    if (goalElement) {
        goalElement.remove();
    }
}


/**
 * Goal Progress Tracking System
 * Automatically calculates and updates progress for various goal types
 */

/**
 * Main function to calculate progress for all active user goals
 * Updates progress based on actual transaction data
 */
function calculateGoalProgress() {
    if (!userGoals || userGoals.length === 0) return;
    
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    userGoals.forEach(goal => {
        // Skip goals that have been manually adjusted by user
        if (goal.manuallyEdited) return;
        
        // Calculate progress based on goal type
        switch(goal.type) {
            case 'savings_rate':
                goal.currentProgress = calculateSavingsRateProgress(currentMonth, currentYear);
                break;
            case 'category_limit':
            case 'coffee_budget':
                goal.currentProgress = calculateCategorySpendingProgress(goal, currentMonth, currentYear);
                break;
            case 'no_spend_days':
                goal.currentProgress = calculateNoSpendDaysProgress(currentMonth, currentYear);
                break;
            case 'cook_home':
                goal.currentProgress = calculateCookHomeProgress(currentMonth, currentYear);
                break;
            case 'total_spending_limit':
                goal.currentProgress = calculateTotalSpendingProgress(goal, currentMonth, currentYear);
                break;
            case 'impulse_limit':
                goal.currentProgress = calculateImpulseLimitProgress(goal, currentMonth, currentYear);
                break;
            case 'emergency_fund':
                // Don't auto-calculate for house_deposit and emergency_fund 
                // These are manual savings goals
                if (!goal.manuallyEdited) {
                    goal.currentProgress = calculateEmergencyFundProgress(goal);
                }
                break;
        }
    });
    
    saveData();
}

function calculateSavingsRateProgress(month, year) {
    const monthlyRecurring = getMonthlyRecurringTotals(year, month);
    const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;
    const totalSpent = getMonthlyExpenseTotal(year, month);
    
    if (totalMonthlyIncome === 0) return 0;
    
    const actualSavingsRate = ((totalMonthlyIncome - totalSpent) / totalMonthlyIncome) * 100;
    return Math.max(0, actualSavingsRate);
}

function calculateCategorySpendingProgress(goal, month, year) {
    let categorySpending = 0;
    
    const monthlyExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year &&
               e.category === goal.category;
    });
    
    if (goal.keywords && goal.keywords.length > 0) {
        // Filter by keywords (e.g., coffee)
        categorySpending = monthlyExpenses
            .filter(e => goal.keywords.some(keyword => 
                e.name.toLowerCase().includes(keyword.toLowerCase())
            ))
            .reduce((sum, e) => sum + e.cost, 0);
    } else {
        categorySpending = monthlyExpenses.reduce((sum, e) => sum + e.cost, 0);
    }
    
    // Return percentage of goal used (inverted - lower spending = higher progress)
    const percentageUsed = (categorySpending / goal.target) * 100;
    return Math.max(0, 100 - percentageUsed);
}

function calculateNoSpendDaysProgress(month, year) {
    const monthlyExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year;
    });
    
    const spendingDays = new Set(monthlyExpenses.map(e => e.date)).size;
    const currentDay = new Date().getDate();
    const totalDaysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Calculate no-spend days so far
    const noSpendDays = Math.max(0, currentDay - spendingDays);
    return noSpendDays;
}

// Fix the missing calculation functions
function calculateCookHomeProgress(month, year) {
    // This is a placeholder - you'd need to track cooking vs dining out
    // For now, estimate based on food expenses
    const foodExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year &&
               e.category === 'Food/Drink';
    });
    
    const diningOutExpenses = foodExpenses.filter(e => 
        e.name.toLowerCase().includes('restaurant') ||
        e.name.toLowerCase().includes('takeaway') ||
        e.name.toLowerCase().includes('delivery')
    );
    
    const currentDay = new Date().getDate();
    const estimatedCookDays = Math.max(0, currentDay - diningOutExpenses.length);
    return estimatedCookDays;
}

function calculateTotalSpendingProgress(goal, month, year) {
    const totalSpent = getMonthlyExpenseTotal(year, month);
    const targetSpending = monthlyBudget * (1 - goal.target / 100);
    
    if (totalSpent <= targetSpending) {
        return 100; // Goal achieved
    } else {
        const overspend = totalSpent - targetSpending;
        return Math.max(0, 100 - (overspend / targetSpending) * 100);
    }
}

function calculateImpulseLimitProgress(goal, month, year) {
    const impulseExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year &&
               e.type === 'Non-Essential' &&
               e.cost > goal.target;
    });
    
    return impulseExpenses.length === 0 ? 100 : Math.max(0, 100 - impulseExpenses.length * 20);
}

function calculateEmergencyFundProgress(goal) {
    // Emergency fund progress should not be auto-calculated
    // It should only use the amount the user has specifically saved for emergencies
    // If no manual amount is set, return 0
    return goal.currentProgress || 0;
}

function addDirectCSS() {
    const style = document.createElement('style');
    style.textContent = `
        /* Goal progress bar container MUST be relative for absolute positioning */
        .goal-progress-container {
            position: relative !important;
            overflow: visible !important;
        }
        
        /* 50% midpoint marker */
        .goal-50-marker {
            position: absolute !important;
            top: 0 !important;
            left: 50% !important;
            width: 1px !important;
            height: 100% !important;
            background-color: rgba(156, 163, 175, 0.5) !important; /* gray-400 with opacity */
            z-index: 10 !important;
        }
        
        /* 50% text label - MOVED BELOW */
        .goal-50-label {
            position: absolute !important;
            top: 100% !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            font-size: 10px !important;
            color: rgba(107, 114, 128, 0.8) !important;
            font-weight: 500 !important;
            z-index: 15 !important;
            margin-top: 2px !important;
        }
        
        /* Dark mode support for 50% label */
        .dark .goal-50-label {
            color: rgba(156, 163, 175, 0.8) !important;
        }
        
        /* Progress marker */
        .goal-progress-marker {
            position: absolute !important;
            top: 0 !important;
            width: 2px !important;
            height: 100% !important;
            background-color: white !important;
            border-left: 1px solid #1f2937 !important;
            border-right: 1px solid #1f2937 !important;
            z-index: 20 !important;
        }
    `;
    document.head.appendChild(style);
}

function updateDashboardGoals() {
    const container = document.getElementById('dashboard-goals-container');
    if (!container) return;
    
    if (!userGoals || userGoals.length === 0) {
        container.innerHTML = `
            <div class="border border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center">
                <div class="text-gray-500 dark:text-gray-400 mb-2">No Goals Set</div>
                <div class="text-sm text-gray-400 dark:text-gray-500">Click "Manage" to create your first financial goal</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = userGoals.map(goal => {
        const currentAmount = goal.currentAmount || goal.currentProgress || 0;
        const targetAmount = goal.targetAmount || goal.target || 0;
        const progressPercentage = currentAmount && targetAmount ? 
            Math.min((currentAmount / targetAmount) * 100, 100) : 0;
        
        // Determine color based on goal type
        const colors = {
            'emergency_fund': 'bg-green-500',
            'emergency': 'bg-green-500',
            'house_deposit': 'bg-blue-500',
            'house': 'bg-blue-500', 
            'vacation': 'bg-purple-500',
            'investment': 'bg-indigo-500',
            'debt': 'bg-red-500',
            'custom': 'bg-gray-500'
        };
        const color = colors[goal.type] || colors['custom'];
        
        return `
            <div class="border rounded-lg p-4 hover:border-blue-300 dark:hover:border-blue-700 transition-colors cursor-pointer" onclick="openGoalsModal()">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-semibold text-gray-900 dark:text-gray-100">${goal.name}</h4>
                    <span class="text-sm text-gray-600 dark:text-gray-400">${Math.round(progressPercentage)}%</span>
                </div>
                <!-- Progress bar with DIRECT CSS classes -->
                <div class="w-full mb-2" style="padding-top: 20px;">
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 border border-gray-300 dark:border-gray-500 goal-progress-container">
                        <!-- Progress bar fill -->
                        <div class="${color} h-full rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
                        
                        <!-- 50% midpoint reference marker -->
                        <div class="goal-50-marker"></div>
                        <div class="goal-50-label">50%</div>
                        
                        <!-- Actual progress marker -->
                        <div class="goal-progress-marker" style="left: ${Math.min(progressPercentage, 100)}%"></div>
                    </div>
                </div>
                <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
                    <span>${formatCurrency(currentAmount)}</span>
                    <span>${formatCurrency(targetAmount)}</span>
                </div>
            </div>
        `;
    }).join('');
}

// Initialize the direct CSS styles when the page loads
function initializeGoalMarkers() {
    // Add the CSS first
    addDirectCSS();
    
    // Add debugging function to window
    window.fixMarkersDirectCSS = function() {
        console.log('🔧 Applying direct CSS markers fix...');
        addDirectCSS();
        updateDashboardGoals();
        console.log('✅ Direct CSS markers applied!');
    };
    
    console.log('🎯 Direct CSS goal markers fix loaded. Run fixMarkersDirectCSS() to apply immediately.');
}

function updateGoalProgressDisplay() {
    calculateGoalProgress();
    
    // Update impact analysis when goals are updated
    updateGoalImpactDisplay();
    
    // Update dashboard goals display
    updateDashboardGoals();
    
    const goalDisplay = document.getElementById('goal-progress-display');
    
    console.log('🎯 updateGoalProgressDisplay - userGoals:', userGoals);
    console.log('🎯 updateGoalProgressDisplay - userGoals length:', userGoals?.length);
    
    if (!goalDisplay) {
        console.error('❌ Goal progress display element not found');
        return;
    }
    
    if (!userGoals || userGoals.length === 0) {
        console.log('🎯 No goals found, showing default message');
        goalDisplay.innerHTML = `
            <div class="text-sm font-medium">No Goals</div>
            <div class="text-xs text-purple-500 mt-1 opacity-70">Click to set goals</div>
        `;
        
        // Make it clickable to create goals
        goalDisplay.className = goalDisplay.className + ' cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors rounded-lg';
        goalDisplay.onclick = () => openGoalsModal();
        return;
    }
    
    console.log('🎯 Found goals, looking for primary goal...');
    
    // Find the primary goal (active financial goal) or just the first financial goal
    let primaryGoal = userGoals.find(g => g.priority === 'primary' && g.unit === 'currency');
    
    // If no primary goal with currency unit, try to find any currency goal
    if (!primaryGoal) {
        primaryGoal = userGoals.find(g => g.unit === 'currency');
    }
    
    // If still no currency goal, try the first goal regardless of unit
    if (!primaryGoal) {
        primaryGoal = userGoals[0];
    }
    
    console.log('🎯 Primary goal found:', primaryGoal);
    
    if (primaryGoal) {
        // Ensure currentProgress and target are valid numbers
        const currentProgress = typeof primaryGoal.currentProgress === 'number' ? primaryGoal.currentProgress : 0;
        const target = typeof primaryGoal.target === 'number' && primaryGoal.target > 0 ? primaryGoal.target : 1;
        
        // Show concise progress for primary financial goal
        const progressPercent = (currentProgress / target) * 100;
        
        console.log('🎯 Displaying goal progress:', {
            name: primaryGoal.name,
            currentProgress,
            target,
            progressPercent: Math.round(progressPercent)
        });
        
        // Simple, compact display
        if (primaryGoal.unit === 'currency') {
            goalDisplay.innerHTML = `
                <div class="text-sm font-medium truncate">${primaryGoal.name || 'Goal'}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">
                    ${formatCurrency(currentProgress)} / ${formatCurrency(target)} (${Math.round(progressPercent)}%)
                </div>
                <div class="text-xs text-purple-500 mt-1 opacity-70">Click for details</div>
            `;
        } else if (primaryGoal.unit === 'percent') {
            goalDisplay.innerHTML = `
                <div class="text-sm font-medium truncate">${primaryGoal.name || 'Goal'}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">
                    ${currentProgress.toFixed(1)}% / ${target}%
                </div>
                <div class="text-xs text-purple-500 mt-1 opacity-70">Click for details</div>
            `;
        } else {
            goalDisplay.innerHTML = `
                <div class="text-sm font-medium truncate">${primaryGoal.name || 'Goal'}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">
                    ${Math.round(progressPercent)}% complete
                </div>
                <div class="text-xs text-purple-500 mt-1 opacity-70">Click for details</div>
            `;
        }
        
        // Make it clickable for details
        goalDisplay.className = goalDisplay.className.replace(/cursor-pointer.*?rounded-lg/g, '') + ' cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors rounded-lg';
        goalDisplay.onclick = () => openGoalsModal();
    } else {
        console.log('🎯 No primary goal found, showing completion status');
        
        // Fallback to simple completed/total display
        const completedGoals = userGoals.filter(g => {
            const currentProgress = typeof g.currentProgress === 'number' ? g.currentProgress : 0;
            const target = typeof g.target === 'number' ? g.target : 1;
            
            if (g.unit === 'percent' || g.unit === 'currency') {
                return currentProgress >= target;
            } else if (g.unit === 'days') {
                return currentProgress >= target;
            }
            return false;
        }).length;
        
        goalDisplay.innerHTML = `
            <div class="text-sm font-medium">${completedGoals}/${userGoals.length} Complete</div>
            <div class="text-xs text-purple-500 mt-1 opacity-70">Click to edit goals</div>
        `;
        
        // Make it clickable for details
        goalDisplay.className = goalDisplay.className.replace(/cursor-pointer.*?rounded-lg/g, '') + ' cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors rounded-lg';
        goalDisplay.onclick = () => openGoalsModal();
    }
}

function openGoalsModal() {
    renderGoalsModal();
    document.getElementById('goals-modal').classList.remove('hidden');
}

function closeGoalsModal() {
    document.getElementById('goals-modal').classList.add('hidden');
}

function closeUpgradeModal() {
    const modal = document.getElementById('upgrade-modal');
    if (modal) {
        modal.remove();
    }
}

// TEST LOGIN FUNCTION (Remove in production)
function testLogin() {
    // Simulate logged in user
    const testUser = {
        _id: 'test_user_123',
        name: 'Test User',
        email: 'test@example.com',
        subscriptionTier: 'free'
    };
    
    // Set test data
    localStorage.setItem('accessToken', 'test_token_123');
    localStorage.setItem('user', JSON.stringify(testUser));
    localStorage.setItem('user_test_user_123_lensAppData', JSON.stringify({
        expenses: [
            { id: 1, name: 'Coffee', cost: 4.50, category: 'Food & Drink', date: new Date().toISOString().split('T')[0], status: 'active' },
            { id: 2, name: 'Lunch', cost: 12.00, category: 'Food & Drink', date: new Date().toISOString().split('T')[0], status: 'active' }
        ],
        userGoals: [],
        monthlyBudget: 900,
        monthlyIncome: 3000,
        totalSavings: 1000,
        monthlyExpenses: 800
    }));
    
    // Close modal and reload
    closeUpgradeModal();
    location.reload();
}


function closeHelpModal() {
    document.getElementById('help-modal').classList.add('hidden');
}

function editGoals() {
    // Close the current goals modal
    closeGoalsModal();
    
    // Show the proper goal editing interface
    showGoalEditingInterface();
}

function showGoalEditingInterface() {
    document.getElementById('goal-editing-modal').classList.remove('hidden');
    renderGoalEditingInterface();
}

function closeGoalEditingModal() {
    document.getElementById('goal-editing-modal').classList.add('hidden');
}


function updateSavingsAllocation() {
    const input = document.getElementById('edit-total-savings-main');
    const newTotalSavings = parseFloat(input.value) || 0;
    
    // Calculate total allocated amount
    const allocatedAmount = userGoals.reduce((sum, goal) => {
        if (goal.unit === 'currency') {
            return sum + goal.currentProgress;
        }
        return sum;
    }, 0);
    
    const newUnallocated = newTotalSavings - allocatedAmount;
    
    // Update the unallocated display
    const unallocatedDisplay = document.getElementById('unallocated-display');
    if (unallocatedDisplay) {
        unallocatedDisplay.textContent = formatCurrency(newUnallocated);
        
        // Change color based on whether it's positive or negative
        if (newUnallocated < 0) {
            unallocatedDisplay.className = 'font-medium text-red-600';
        } else {
            unallocatedDisplay.className = 'font-medium text-green-600';
        }
    }
    
    // Show warning if new total is less than allocated
    if (newTotalSavings < allocatedAmount) {
        input.classList.add('border-red-500');
        input.title = `Warning: Total savings (${formatCurrency(newTotalSavings)}) is less than allocated amount (${formatCurrency(allocatedAmount)})`;
    } else {
        input.classList.remove('border-red-500');
        input.title = '';
    }
}

function renderGoalEditingInterface() {
    const container = document.getElementById('goal-editing-content');
    
    console.log('renderGoalEditingInterface - userGoals:', userGoals);
    console.log('renderGoalEditingInterface - userGoals length:', userGoals?.length);
    
    if (!userGoals || userGoals.length === 0) {
        console.log('No goals found in edit interface');
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">🎯</div>
                <p class="text-gray-600 dark:text-gray-400 mb-4">No goals set yet.</p>
                <button onclick="closeGoalEditingModal(); openGoalsModal(); showGoalSelection();" class="modern-button modern-button-primary" data-tour="first-goal">Choose Your Goals</button>
            </div>
        `;
        return;
    }
    
    // Calculate total allocated amount
    const allocatedAmount = userGoals.reduce((sum, goal) => {
        if (goal.unit === 'currency') {
            return sum + goal.currentProgress;
        }
        return sum;
    }, 0);
    
    const unallocated = totalSavings - allocatedAmount;
    
    container.innerHTML = `
        <!-- Total Savings Section -->
        <div class="card p-4 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-700">
            <h4 class="font-medium mb-3 text-blue-800 dark:text-blue-200">💰 Total Savings Management</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Total Savings</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">£</span>
                        <input type="number" id="edit-total-savings-main" value="${totalSavings}" class="modern-input pl-6 pr-4 font-semibold" onchange="updateSavingsAllocation()">
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Total money across all accounts</div>
                </div>
                <div class="space-y-2">
                    <div class="text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Goal allocations:</span>
                            <span class="font-medium">${formatCurrency(allocatedAmount)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Unallocated:</span>
                            <span class="font-medium text-green-600" id="unallocated-display">${formatCurrency(unallocated)}</span>
                        </div>
                        ${totalDebt > 0 ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Total debt:</span>
                            <span class="font-medium text-red-600">-${formatCurrency(totalDebt)}</span>
                        </div>
                        <div class="flex justify-between border-t pt-1 mt-1">
                            <span class="text-gray-700 dark:text-gray-300 font-medium">Net worth:</span>
                            <span class="font-semibold ${totalSavings - totalDebt >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(totalSavings - totalDebt)}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Goals Section -->
        <div class="space-y-6">
            <h4 class="font-medium text-gray-800 dark:text-gray-200">🎯 Individual Goals</h4>
            ${userGoals.map((goal, index) => renderGoalEditForm(goal, index)).join('')}
        </div>
    `;
}

function renderGoalEditForm(goal, index) {
    const goalTypeConfig = getGoalTypeConfig(goal.type);
    
    return `
        <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h4 class="text-lg font-semibold">${goalTypeConfig.icon} ${goal.name}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${goalTypeConfig.description}</p>
                </div>
                <button onclick="removeGoal(${index})" class="text-red-500 hover:text-red-700 font-medium text-sm">Remove</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Target Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="goal-${index}-target" value="${goal.target}" class="modern-input pl-8 text-center font-semibold" onchange="updateGoalProgress(${index})" oninput="updateGoalProgress(${index})">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Current Progress</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">£</span>
                        <input type="number" id="goal-${index}-current" value="${goal.currentProgress}" class="modern-input pl-8 text-center font-semibold" onchange="updateGoalProgress(${index})" oninput="updateGoalProgress(${index})">
                    </div>
                </div>
                
                ${goal.timeline ? `
                <div>
                    <label class="block text-sm font-medium mb-2">Timeline</label>
                    <select id="goal-${index}-timeline" class="modern-select font-medium">
                        <option value="">Select...</option>
                        ${getTimelineOptions().map(opt => `
                            <option value="${opt}" ${goal.timeline === opt ? 'selected' : ''}>${opt}</option>
                        `).join('')}
                    </select>
                </div>
                ` : ''}
                
                ${goal.months ? `
                <div>
                    <label class="block text-sm font-medium mb-2">Coverage Period</label>
                    <select id="goal-${index}-months" class="modern-select font-medium">
                        <option value="">Select...</option>
                        ${getMonthOptions().map(opt => `
                            <option value="${opt}" ${goal.months === parseInt(opt.charAt(0)) ? 'selected' : ''}>${opt}</option>
                        `).join('')}
                    </select>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                        This updates the goal name only. Your target amount stays as you set it.
                    </div>
                </div>
                ` : ''}
            </div>
            
            <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded">
                <div class="flex justify-between text-sm">
                    <span>Progress: <span id="goal-${index}-progress-text" class="font-medium">${Math.round((goal.currentProgress / goal.target) * 100)}%</span></span>
                    <span>Remaining: <span id="goal-${index}-remaining-text" class="font-medium">£${(goal.target - goal.currentProgress).toLocaleString()}</span></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2 goal-progress-container" style="margin-top: 20px;">
                    <div id="goal-${index}-progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-500" style="width: ${Math.min((goal.currentProgress / goal.target) * 100, 100)}%"></div>
                    <!-- 50% midpoint reference marker -->
                    <div class="goal-50-marker"></div>
                    <div class="goal-50-label">50%</div>
                    <!-- Actual progress marker -->
                    <div class="goal-progress-marker" style="left: ${Math.min((goal.currentProgress / goal.target) * 100, 100)}%"></div>
                </div>
            </div>
        </div>
    `;
}

function getGoalTypeConfig(type) {
    const configs = {
        'house_deposit': { icon: '🏠', description: 'House purchase deposit fund' },
        'emergency_fund': { icon: '💰', description: 'Emergency fund for unexpected expenses' },
        'vacation': { icon: '✈️', description: 'Dream vacation fund' },
        'investment': { icon: '📈', description: 'Investment portfolio building' },
        'custom': { icon: '🎯', description: 'Custom financial goal' }
    };
    return configs[type] || { icon: '🎯', description: 'Financial goal' };
}

function getTimelineOptions() {
    return ['6 months', '1 year', '18 months', '2 years', '3 years', '4 years', '5+ years'];
}

function getMonthOptions() {
    return ['3 months expenses', '4 months expenses', '5 months expenses', '6 months expenses', '12 months expenses'];
}

function updateGoalProgress(index) {
    const targetInput = document.getElementById(`goal-${index}-target`);
    const currentInput = document.getElementById(`goal-${index}-current`);
    const progressText = document.getElementById(`goal-${index}-progress-text`);
    const remainingText = document.getElementById(`goal-${index}-remaining-text`);
    const progressBar = document.getElementById(`goal-${index}-progress-bar`);
    
    if (targetInput && currentInput && progressText && remainingText && progressBar) {
        const target = parseFloat(targetInput.value) || 0;
        const current = parseFloat(currentInput.value) || 0;
        
        const progressPercent = target > 0 ? Math.round((current / target) * 100) : 0;
        const remaining = Math.max(target - current, 0);
        
        progressText.textContent = `${progressPercent}%`;
        remainingText.textContent = `£${remaining.toLocaleString()}`;
        progressBar.style.width = `${Math.min(progressPercent, 100)}%`;
        
        // Update the progress marker position
        const progressMarker = progressBar.parentElement.querySelector('.goal-progress-marker');
        if (progressMarker) {
            progressMarker.style.left = `${Math.min(progressPercent, 100)}%`;
        }
    }
}

function addNewGoal() {
    const goalTypes = [
        { type: 'house_deposit', name: '🏠 House Deposit', description: 'Save for a house deposit' },
        { type: 'emergency_fund', name: '💰 Emergency Fund', description: 'Build an emergency fund' },
        { type: 'vacation', name: '✈️ Vacation', description: 'Save for a dream vacation' },
        { type: 'investment', name: '📈 Investment', description: 'Build investment portfolio' },
        { type: 'debt_payoff', name: '💳 Debt Payoff', description: 'Pay off credit cards and loans' },
        { type: 'custom', name: '🎯 Custom Goal', description: 'Create a custom goal' }
    ];
    
    const container = document.getElementById('goal-editing-content');
    container.innerHTML = `
        <div class="text-center mb-6">
            <h4 class="text-lg font-semibold mb-2">Add New Goal</h4>
            <p class="text-gray-600 dark:text-gray-400">Choose the type of goal you want to add</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            ${goalTypes.map(type => `
                <div onclick="selectNewGoalType('${type.type}')" class="p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
                    <div class="text-center">
                        <div class="text-2xl mb-2">${type.name.split(' ')[0]}</div>
                        <h5 class="font-semibold mb-1">${type.name.substring(2)}</h5>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${type.description}</p>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="text-center">
            <button onclick="renderGoalEditingInterface()" class="modern-button modern-button-secondary">Back to Goals</button>
        </div>
    `;
}

function selectNewGoalType(goalType) {
    // Show goal configuration screen instead of creating empty goal
    showGoalConfiguration(goalType);
}

function showGoalConfiguration(goalType) {
    const container = document.getElementById('goals-content');
    const goalConfig = getGoalConfiguration(goalType);
    
    // Generate fields HTML using EXACT same approach as onboarding
    const fieldsHTML = goalConfig.fields.map(field => {
        if (field.type === 'currency') {
            return `
                <div>
                    <label class="block text-sm font-medium mb-2">${field.label}</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">£</span>
                        <input type="number" id="${field.id}" placeholder="${field.placeholder}" 
                               class="w-full pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800">
                    </div>
                    ${field.help ? `<p class="text-xs text-gray-500 mt-1">${field.help}</p>` : ''}
                </div>
            `;
        } else if (field.type === 'select') {
            return `
                <div>
                    <label class="block text-sm font-medium mb-2">${field.label}</label>
                    <select id="${field.id}" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800">
                        ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                    </select>
                    ${field.help ? `<p class="text-xs text-gray-500 mt-1">${field.help}</p>` : ''}
                </div>
            `;
        } else if (field.type === 'text') {
            return `
                <div>
                    <label class="block text-sm font-medium mb-2">${field.label}</label>
                    <input type="text" id="${field.id}" placeholder="${field.placeholder}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800">
                    ${field.help ? `<p class="text-xs text-gray-500 mt-1">${field.help}</p>` : ''}
                </div>
            `;
        }
        return '';
    }).join('');
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">${goalConfig.icon}</div>
            <h4 class="text-xl font-semibold mb-2">${goalConfig.title}</h4>
            <p class="text-gray-600 dark:text-gray-400">${goalConfig.subtitle}</p>
        </div>
        
        <div class="space-y-6">
            ${fieldsHTML}
        </div>
        
        <div class="flex gap-3 pt-6 border-t border-gray-200 dark:border-gray-600">
            <button onclick="showGoalSelection()" class="modern-button modern-button-secondary flex-1">
                ← Back to Goals
            </button>
            <button onclick="createGoalFromFields('${goalType}')" class="modern-button modern-button-primary flex-1">
                Create Goal
            </button>
        </div>
    `;
}

function getGoalConfiguration(goalType) {
    // Use EXACT same configuration as onboarding for consistency
    const configs = {
        'house_deposit': {
            icon: '🏠',
            title: '🏠 House Deposit Goal',
            subtitle: 'Tell us about your house purchase plan',
            fields: [
                { id: 'house-target', label: 'Target Deposit Amount', placeholder: '50,000', type: 'currency' },
                { id: 'house-timeline', label: 'Purchase Timeline', type: 'select', options: ['1 year', '2 years', '3 years', '4 years', '5+ years'] },
                { id: 'house-current', label: 'Current House Deposit Savings', placeholder: '5,000', type: 'currency', help: 'Money you\'ve already saved specifically for the house deposit (part of your total savings)' }
            ]
        },
        'emergency_fund': {
            icon: '💰',
            title: '💰 Emergency Fund Goal',
            subtitle: 'Build your financial safety net',
            fields: [
                { id: 'emergency-months', label: 'Target Coverage', type: 'select', options: ['3 months expenses', '4 months expenses', '5 months expenses', '6 months expenses', '12 months expenses'] },
                { id: 'emergency-current', label: 'Current Emergency Fund Allocation', placeholder: '1,000', type: 'currency', help: 'How much of your total savings is specifically allocated to emergency fund (this should be part of your total savings amount)' }
            ]
        },
        'vacation': {
            icon: '✈️',
            title: '✈️ Vacation Goal',
            subtitle: 'Plan your dream trip',
            fields: [
                { id: 'vacation-cost', label: 'Total Trip Cost', placeholder: '3,000', type: 'currency' },
                { id: 'vacation-when', label: 'When do you want to go?', type: 'select', options: ['6 months', '1 year', '18 months', '2 years'] },
                { id: 'vacation-current', label: 'Current Vacation Savings', placeholder: '500', type: 'currency', help: 'Money already saved for vacation (part of your total savings)' }
            ]
        },
        'investment': {
            icon: '📈',
            title: '📈 Investment Goal',
            subtitle: 'Build your investment portfolio',
            fields: [
                { id: 'investment-target', label: 'Investment Target', placeholder: '10,000', type: 'currency' },
                { id: 'investment-timeline', label: 'Investment Timeline', type: 'select', options: ['1 year', '2 years', '3 years', '5+ years'] },
                { id: 'investment-current', label: 'Current Investment Value', placeholder: '1,000', type: 'currency', help: 'Current value of your investment portfolio' }
            ]
        },
        'debt_payoff': {
            icon: '💳',
            title: '💳 Debt Payoff Strategy',
            subtitle: 'Choose your debt elimination approach',
            fields: [
                { id: 'debt-target', label: 'Total Debt Amount', placeholder: '5,000', type: 'currency', help: 'Total amount of all debts you want to pay off' },
                { id: 'debt-strategy', label: 'Payoff Strategy', type: 'select', options: ['Avalanche (highest interest first)', 'Snowball (smallest balance first)', 'Equal payments'] },
                { id: 'debt-current', label: 'Amount Already Paid', placeholder: '0', type: 'currency', help: 'How much debt have you already paid off?' }
            ]
        },
        'custom': {
            icon: '🎯',
            title: '🎯 Custom Goal',
            subtitle: 'Create your own savings goal',
            fields: [
                { id: 'custom-name', label: 'Goal Name', placeholder: 'My Goal', type: 'text' },
                { id: 'custom-target', label: 'Target Amount', placeholder: '1,000', type: 'currency' },
                { id: 'custom-timeline', label: 'Timeline', type: 'select', options: ['6 months', '1 year', '18 months', '2 years', '3+ years'] },
                { id: 'custom-current', label: 'Current Progress', placeholder: '0', type: 'currency', help: 'How much have you already saved towards this goal?' }
            ]
        }
    };
    return configs[goalType] || configs['custom'];
}

function createGoalFromFields(goalType) {
    // Use IDENTICAL logic to finishCleanOnboarding() function
    console.log('Creating goal with type:', goalType);
    
    // Collect form data exactly like onboarding does
    const goalDetails = {};
    const goalConfig = getGoalConfiguration(goalType);
    
    goalConfig.fields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            if (field.type === 'currency') {
                goalDetails[field.id] = parseFloat(element.value) || 0;
            } else {
                goalDetails[field.id] = element.value;
            }
        }
    });
    
    console.log('Collected goal details:', goalDetails);
    
    // Create goal using EXACT same logic as finishCleanOnboarding()
    let newGoal;
    
    if (goalType === 'house_deposit') {
        const target = goalDetails['house-target'] || 0;
        const current = goalDetails['house-current'] || 0;
        const timeline = goalDetails['house-timeline'];
        
        if (target <= 0) {
            alert('Please enter a valid target deposit amount');
            return;
        }
        
        newGoal = {
            id: Date.now(),
            type: 'house_deposit',
            name: 'House Deposit',
            target: target,
            currentProgress: current,
            unit: 'currency',
            timeline: timeline,
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        };
        
    } else if (goalType === 'emergency_fund') {
        const monthsValue = goalDetails['emergency-months'];
        const months = monthsValue ? parseInt(String(monthsValue).charAt(0)) || 6 : 6;
        const userTarget = goalDetails['emergency-target'] || (monthlyExpenses * months);
        const current = goalDetails['emergency-current'] || 0;
        
        console.log('Emergency fund creation:', {
            savedTarget: goalDetails['emergency-target'],
            calculatedTarget: monthlyExpenses * months,
            finalTarget: userTarget,
            months: months,
            monthlyExpenses: monthlyExpenses
        });
        
        newGoal = {
            id: Date.now(),
            type: 'emergency_fund',
            name: `${months}-Month Emergency Fund`,
            target: userTarget,
            currentProgress: current,
            unit: 'currency',
            months: months,
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        };
        
    } else if (goalType === 'vacation') {
        const target = goalDetails['vacation-cost'] || 0;
        const current = goalDetails['vacation-current'] || 0;
        const timeline = goalDetails['vacation-timeline'];
        const name = goalDetails['vacation-name'] || 'Dream Vacation';
        
        if (target <= 0) {
            alert('Please enter a valid trip cost');
            return;
        }
        
        newGoal = {
            id: Date.now(),
            type: 'vacation',
            name: name,
            target: target,
            currentProgress: current,
            unit: 'currency',
            timeline: timeline,
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        };
        
    } else if (goalType === 'investment') {
        const target = goalDetails['investment-target'] || 0;
        const current = goalDetails['investment-current'] || 0;
        const timeline = goalDetails['investment-timeline'];
        
        if (target <= 0) {
            alert('Please enter a valid investment target');
            return;
        }
        
        newGoal = {
            id: Date.now(),
            type: 'investment',
            name: 'Investment Goal',
            target: target,
            currentProgress: current,
            unit: 'currency',
            timeline: timeline,
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        };
        
    } else if (goalType === 'debt_payoff') {
        // For debt goals, we need debt data like onboarding
        const totalDebtTarget = goalDetails['debt-target'] || 0;
        
        if (totalDebtTarget <= 0) {
            alert('Please enter a valid debt amount');
            return;
        }
        
        newGoal = {
            id: Date.now(),
            type: 'debt_payoff',
            name: 'Debt Payoff',
            target: totalDebtTarget,
            currentProgress: 0, // Start with 0 paid off (same as onboarding)
            unit: 'currency',
            timeline: goalDetails['debt-timeline'] || '',
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString(),
            strategy: goalDetails['debt-strategy'] || '',
            extraPayment: goalDetails['debt-extra-payment'] || 0
        };
        
    } else if (goalType === 'custom') {
        const name = goalDetails['custom-name'] || 'Custom Goal';
        const target = goalDetails['custom-target'] || 0;
        const current = goalDetails['custom-current'] || 0;
        const timeline = goalDetails['custom-timeline'];
        
        if (!name.trim()) {
            alert('Please enter a goal name');
            return;
        }
        
        if (target <= 0) {
            alert('Please enter a valid target amount');
            return;
        }
        
        newGoal = {
            id: Date.now(),
            type: 'custom',
            name: name,
            target: target,
            currentProgress: current,
            unit: 'currency',
            timeline: timeline,
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        };
    }
    
    if (!newGoal) {
        alert('Error creating goal. Please try again.');
        return;
    }
    
    // Validation: Check progress vs target
    if (newGoal.currentProgress > newGoal.target) {
        alert('Current progress cannot be greater than target amount');
        return;
    }
    
    // Check subscription limits for goals
    if (subscriptionManager && subscriptionManager.isInitialized) {
        const goalLimit = subscriptionManager.getFeatureLimit('goals');
        const currentGoalCount = userGoals.length;
        
        if (!subscriptionManager.isPremium() && currentGoalCount >= goalLimit) {
            subscriptionManager.showFeatureLimit('goals', currentGoalCount);
            return;
        }
    }
    
    // Check for existing goal of same type to prevent duplicates
    const existingGoalIndex = userGoals.findIndex(g => g.type === newGoal.type);
    if (existingGoalIndex !== -1) {
        // Replace existing goal instead of adding duplicate
        userGoals[existingGoalIndex] = newGoal;
        console.log('Updated existing goal of type:', newGoal.type);
    } else {
        userGoals.push(newGoal);
        console.log('Added new goal of type:', newGoal.type);
    }
    
    console.log('Goals created:', userGoals.length, userGoals);
    
    // Save using IDENTICAL method to finishCleanOnboarding() - via saveData()
    saveData();
    console.log('Saved goals using saveData() method');
    
    // Refresh the goals display everywhere
    updateGoalsWithImpactAnalysis();
    updateDashboardGoals();
    
    // Show success and go back to goals view
    renderGoalsModal();
    
    // Update modal footer to show success state temporarily
    const goalsModal = document.getElementById('goals-modal');
    const footer = goalsModal.querySelector('.flex.justify-center.p-4');
    if (footer) {
        footer.innerHTML = `
            <div class="text-green-600 text-sm mb-2">✅ Goal "${newGoal.name}" created successfully!</div>
            <button onclick="showGoalSelection()" class="modern-button modern-button-secondary mr-3">Add Another Goal</button>
            <button onclick="closeGoalsModal()" class="modern-button modern-button-primary">Done</button>
        `;
        
        // Reset footer after 3 seconds
        setTimeout(() => {
            footer.innerHTML = `
                <button onclick="showGoalSelection()" class="modern-button modern-button-secondary">Add Goals</button>
                <button onclick="closeGoalsModal()" class="modern-button modern-button-primary">Close</button>
            `;
        }, 3000);
    }
}

function getDefaultGoalName(type) {
    const names = {
        'house_deposit': 'House Deposit',
        'emergency_fund': '6-Month Emergency Fund',
        'vacation': 'Dream Vacation',
        'investment': 'Investment Portfolio',
        'custom': 'Custom Goal'
    };
    return names[type] || 'New Goal';
}

function removeGoal(index) {
    const goal = userGoals[index];
    showConfirmation({
        icon: '🗑️',
        title: 'Remove Goal',
        message: `Are you sure you want to remove "${goal.name}"? This action cannot be undone.`,
        confirmText: 'Remove',
        confirmClass: 'modern-button-danger',
        onConfirm: () => {
            userGoals.splice(index, 1);
            renderGoalEditingInterface();
            showToast('Goal removed successfully', 'info');
        }
    });
}

function showConfirmation(options) {
    const overlay = document.getElementById('goal-confirmation-overlay');
    const icon = document.getElementById('confirmation-icon');
    const title = document.getElementById('confirmation-title');
    const message = document.getElementById('confirmation-message');
    const button = document.getElementById('confirmation-button');
    
    // Set content
    icon.textContent = options.icon || '⚠️';
    title.textContent = options.title || 'Confirm Action';
    message.textContent = options.message || 'Are you sure you want to proceed?';
    button.textContent = options.confirmText || 'Confirm';
    
    // Set button style
    button.className = `modern-button px-6 ${options.confirmClass || 'modern-button-primary'}`;
    
    // Store callback
    window.currentConfirmationCallback = options.onConfirm;
    
    // Show overlay within the goal editing modal
    overlay.classList.remove('hidden');
}

function cancelConfirmation() {
    document.getElementById('goal-confirmation-overlay').classList.add('hidden');
    window.currentConfirmationCallback = null;
}

function confirmAction() {
    if (window.currentConfirmationCallback) {
        window.currentConfirmationCallback();
        window.currentConfirmationCallback = null;
    }
    document.getElementById('goal-confirmation-overlay').classList.add('hidden');
}

function saveGoalEdits() {
    // Update total savings first
    const totalSavingsInput = document.getElementById('edit-total-savings-main');
    if (totalSavingsInput) {
        const newTotalSavings = parseFloat(totalSavingsInput.value) || 0;
        
        // Validate the input
        if (newTotalSavings < 0) {
            showToast('Total savings cannot be negative', 'error');
            return;
        }
        
        totalSavings = newTotalSavings;
    }
    
    // Update goals with new values from the forms
    userGoals.forEach((goal, index) => {
        const targetInput = document.getElementById(`goal-${index}-target`);
        const currentInput = document.getElementById(`goal-${index}-current`);
        const timelineInput = document.getElementById(`goal-${index}-timeline`);
        const monthsInput = document.getElementById(`goal-${index}-months`);
        
        // Always preserve user input values and mark as manually edited
        if (targetInput) {
            goal.target = parseFloat(targetInput.value) || 0;
            goal.manuallyEdited = true; // Prevent automatic calculation
        }
        if (currentInput) {
            goal.currentProgress = parseFloat(currentInput.value) || 0;
            goal.manuallyEdited = true; // Prevent automatic calculation
        }
        if (timelineInput) goal.timeline = timelineInput.value;
        
        // Only update months info if it exists, but DON'T override target
        if (monthsInput && goal.type === 'emergency_fund') {
            const months = parseInt(monthsInput.value.charAt(0));
            if (months) {
                goal.months = months;
                goal.name = `${months}-Month Emergency Fund`;
                // Don't override target - let user control it
            }
        }
    });
    
    // Save to localStorage
    saveData();
    
    // Update display
    updateDisplay();
    
    // Close modal and show success
    closeGoalEditingModal();
    showToast('Goals updated successfully!', 'success');
    
    // Refresh goals modal if it was open
    renderGoalsModal();
}

function renderGoalsModal() {
    const container = document.getElementById('goals-content');
    
    if (!userGoals || userGoals.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">🎯</div>
                <p class="text-gray-600 dark:text-gray-400">No goals set yet.</p>
                <button onclick="showGoalSelection()" class="modern-button modern-button-primary mt-4">Choose Your Goals</button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = userGoals.map(goal => {
        const progressPercent = calculateGoalProgressPercent(goal);
        const isCompleted = progressPercent >= 100;
        const remaining = goal.target - goal.currentProgress;
        
        // Create detailed info for the modal
        let detailedInfo = '';
        if (goal.unit === 'currency') {
            if (goal.type === 'debt_payoff') {
                // Special handling for debt payoff goals
                detailedInfo = `
                    <div class="text-sm space-y-2 mt-3 p-3 bg-red-50 dark:bg-red-900/20 rounded">
                        <div class="flex justify-between">
                            <span>Total Debt:</span>
                            <span class="font-medium text-red-600 dark:text-red-400">${formatCurrency(goal.target)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Amount Paid Off:</span>
                            <span class="font-medium text-green-600 dark:text-green-400">${formatCurrency(goal.currentProgress)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Remaining Debt:</span>
                            <span class="font-medium text-red-600 dark:text-red-400">${formatCurrency(remaining)}</span>
                        </div>
                        ${goal.strategy ? `
                        <div class="flex justify-between text-xs pt-2 border-t border-red-200 dark:border-red-800">
                            <span>Strategy:</span>
                            <span>${goal.strategy}</span>
                        </div>
                        ` : ''}
                        ${goal.extraPayment > 0 ? `
                        <div class="flex justify-between text-xs">
                            <span>Extra Monthly Payment:</span>
                            <span>${formatCurrency(goal.extraPayment)}</span>
                        </div>
                        ` : ''}
                        ${totalSavings > 0 ? `
                        <div class="flex justify-between text-xs border-t border-red-200 dark:border-red-800 pt-2">
                            <span>Net Worth After Payoff:</span>
                            <span class="text-green-600 dark:text-green-400">${formatCurrency(totalSavings - remaining)}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Regular savings goals
                detailedInfo = `
                    <div class="text-sm space-y-2 mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded">
                        <div class="flex justify-between">
                            <span>Goal target:</span>
                            <span class="font-medium">${formatCurrency(goal.target)}</span>
                        </div>
                        ${totalSavings > 0 ? `
                        <div class="flex justify-between">
                            <span>Total savings:</span>
                            <span class="font-medium text-green-600 dark:text-green-400">${formatCurrency(totalSavings)}</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between">
                            <span>Allocated to goal:</span>
                            <span class="font-medium text-green-600 dark:text-green-400">${formatCurrency(goal.currentProgress)}</span>
                        </div>
                        ${totalSavings > 0 ? `
                        <div class="flex justify-between">
                            <span>Unallocated:</span>
                            <span class="font-medium text-green-600 dark:text-green-400">${formatCurrency(totalSavings - goal.currentProgress)}</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between pb-2 border-b border-gray-200 dark:border-gray-600">
                            <span>Still needed:</span>
                            <span class="font-medium text-purple-600">${formatCurrency(remaining)}</span>
                        </div>
                        ${totalDebt > 0 ? `
                        <div class="flex justify-between text-xs pt-2">
                            <span>Total debt:</span>
                            <span class="text-red-500">-${formatCurrency(totalDebt)}</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="flex items-center gap-1">
                                Net worth:
                                <span class="tooltip-trigger cursor-help text-gray-400 hover:text-gray-600" title="Net worth = Total savings (${formatCurrency(totalSavings)}) - Total debt (${formatCurrency(totalDebt)}) = ${formatCurrency(totalSavings - totalDebt)}">ⓘ</span>
                            </span>
                            <span class="${totalSavings - totalDebt >= 0 ? 'text-green-600' : 'text-red-500'}">${formatCurrency(totalSavings - totalDebt)}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        return `
            <div class="p-4 border border-gray-200 dark:border-gray-600 rounded-lg mb-4 ${isCompleted ? 'bg-green-50 dark:bg-green-900/20 border-green-500' : ''}">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium">${goal.name}</h4>
                    <div class="flex items-center gap-2">
                        ${isCompleted ? '<span class="text-green-600 text-xl">✅</span>' : ''}
                        <button onclick="editGoal(${userGoals.indexOf(goal)})" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1 rounded hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors" title="Edit goal">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deleteGoal(${userGoals.indexOf(goal)})" class="text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" title="Delete goal">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-4 border border-gray-300 dark:border-gray-500 relative overflow-hidden mb-2">
                    <div class="bg-purple-600 h-full rounded-full transition-all duration-500" style="width: ${Math.min(Math.round(progressPercent), 100)}%"></div>
                    <!-- 50% midpoint reference marker -->
                    <div class="absolute top-0 left-1/2 w-px h-full bg-gray-400 opacity-50"></div>
                    <!-- 71% actual progress marker -->
                    <div class="absolute top-0 w-0.5 h-full bg-white border-l border-r border-gray-800" style="left: ${Math.min(Math.round(progressPercent), 100)}%"></div>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600 dark:text-gray-400">${formatGoalProgress(goal)}</span>
                    <span class="font-medium">${Math.round(progressPercent)}%</span>
                </div>
                ${detailedInfo}
            </div>
        `;
    }).join('');
}

// Edit and Delete Goal Functions
function editGoal(goalIndex) {
    if (!userGoals || !userGoals[goalIndex]) {
        showToast('Goal not found', 'error');
        return;
    }
    
    const goal = userGoals[goalIndex];
    const container = document.getElementById('goals-content');
    
    container.innerHTML = `
        <div class="max-w-md mx-auto">
            <div class="text-center mb-6">
                <h4 class="text-xl font-semibold mb-2">Edit Goal: ${goal.name}</h4>
                <p class="text-gray-600 dark:text-gray-400">Update your goal details</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Goal Name</label>
                    <input type="text" id="edit-goal-name" value="${goal.name}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Target Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">£</span>
                        <input type="number" id="edit-goal-target" value="${goal.target}" class="w-full pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Current Progress</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">£</span>
                        <input type="number" id="edit-goal-current" value="${goal.currentProgress || 0}" class="w-full pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                    </div>
                </div>
                
                ${goal.type !== 'debt_payoff' ? `
                <div>
                    <label class="block text-sm font-medium mb-2">Monthly Contribution (Optional)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">£</span>
                        <input type="number" id="edit-goal-monthly" value="${goal.monthlyContribution || ''}" class="w-full pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white" placeholder="0">
                    </div>
                </div>
                ` : ''}
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="renderGoalsModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
                <button onclick="saveGoalEdit(${goalIndex})" class="modern-button modern-button-primary flex-1">Save Changes</button>
            </div>
        </div>
    `;
}

function deleteGoal(goalIndex) {
    if (!userGoals || !userGoals[goalIndex]) {
        showToast('Goal not found', 'error');
        return;
    }
    
    const goal = userGoals[goalIndex];
    
    if (confirm(`Are you sure you want to delete "${goal.name}"? This action cannot be undone.`)) {
        // Remove the goal from the array
        userGoals.splice(goalIndex, 1);
        
        // Save updated goals
        saveData();
        
        // Update displays
        updateGoalProgressDisplay();
        updateGoalsWithImpactAnalysis();
        
        // Refresh modal
        renderGoalsModal();
        
        showToast(`Goal "${goal.name}" deleted successfully`, 'success');
    }
}

function saveGoalEdit(goalIndex) {
    if (!userGoals || !userGoals[goalIndex]) {
        showToast('Goal not found', 'error');
        return;
    }
    
    // Get form values
    const name = document.getElementById('edit-goal-name').value.trim();
    const target = parseFloat(document.getElementById('edit-goal-target').value) || 0;
    const current = parseFloat(document.getElementById('edit-goal-current').value) || 0;
    const monthlyInput = document.getElementById('edit-goal-monthly');
    const monthly = monthlyInput ? parseFloat(monthlyInput.value) || 0 : 0;
    
    // Validation
    if (!name) {
        showToast('Please enter a goal name', 'error');
        return;
    }
    
    if (target <= 0) {
        showToast('Please enter a valid target amount', 'error');
        return;
    }
    
    if (current < 0) {
        showToast('Current progress cannot be negative', 'error');
        return;
    }
    
    if (current > target) {
        showToast('Current progress cannot be greater than target', 'error');
        return;
    }
    
    // Update the goal
    userGoals[goalIndex].name = name;
    userGoals[goalIndex].target = target;
    userGoals[goalIndex].currentProgress = current;
    if (monthly > 0) {
        userGoals[goalIndex].monthlyContribution = monthly;
    }
    
    // Mark as manually edited to prevent auto-calculation overriding user values
    userGoals[goalIndex].manuallyEdited = true;
    
    // Save updated goals
    saveData();
    
    // Update displays
    updateGoalProgressDisplay();
    updateGoalsWithImpactAnalysis();
    
    // Go back to goals view
    renderGoalsModal();
    
    showToast(`Goal "${name}" updated successfully`, 'success');
}

// NEW STREAMLINED GOAL SELECTION - Replaces confusing multi-modal approach
function showGoalSelection() {
    const container = document.getElementById('goals-content');
    const goalTypes = [
        { type: 'house_deposit', name: '🏠 House Deposit', description: 'Save for a house deposit' },
        { type: 'emergency_fund', name: '💰 Emergency Fund', description: 'Build an emergency fund' },
        { type: 'vacation', name: '✈️ Vacation', description: 'Save for a dream vacation' },
        { type: 'investment', name: '📈 Investment', description: 'Build investment portfolio' },
        { type: 'debt_payoff', name: '💳 Debt Payoff', description: 'Pay off credit cards and loans' },
        { type: 'custom', name: '🎯 Custom Goal', description: 'Create a custom goal' }
    ];
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">🎯</div>
            <h4 class="text-xl font-semibold mb-2">Choose Your Goals</h4>
            <p class="text-gray-600 dark:text-gray-400">Select the goals you want to work towards</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            ${goalTypes.map(type => `
                <div onclick="selectNewGoalType('${type.type}')" class="group p-4 border-2 border-gray-200 dark:border-gray-600 rounded-xl cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all duration-200 transform hover:scale-[1.02]">
                    <div class="text-center">
                        <div class="text-3xl mb-3 group-hover:scale-110 transition-transform duration-200">${type.name.split(' ')[0]}</div>
                        <h5 class="font-semibold mb-2 text-gray-900 dark:text-white">${type.name.substring(2)}</h5>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${type.description}</p>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="text-center pt-4 border-t border-gray-200 dark:border-gray-600">
            <button onclick="renderGoalsModal()" class="modern-button modern-button-secondary">
                ← Back to Goals
            </button>
        </div>
    `;
    
    // Update modal footer to be consistent
    const goalsModal = document.getElementById('goals-modal');
    const footer = goalsModal.querySelector('.flex.justify-center.p-4');
    if (footer) {
        footer.innerHTML = `
            <button onclick="closeGoalsModal()" class="modern-button modern-button-primary">
                Close
            </button>
        `;
    }
}

/**
 * Calculate goal completion percentage based on goal type and unit
 * @param {Object} goal - Goal object with progress and target values
 * @returns {number} Percentage of goal completion (0-100)
 */
function calculateGoalProgressPercent(goal) {
    if (goal.unit === 'percent') {
        return goal.target > 0 ? (goal.currentProgress / goal.target) * 100 : 0;
    } else if (goal.unit === 'currency') {
        // Category limits are already percentage-based
        if (goal.type === 'category_limit' || goal.type === 'coffee_budget') {
            return goal.currentProgress;
        }
        if (goal.target === 0) {
            console.warn('Goal has 0 target:', goal);
            return 0;
        }
        return (goal.currentProgress / goal.target) * 100;
    } else if (goal.unit === 'days') {
        return goal.target > 0 ? (goal.currentProgress / goal.target) * 100 : 0;
    }
    return 0;
}

/**
 * Format goal progress for display based on goal type and unit
 * @param {Object} goal - Goal object to format
 * @returns {string} Formatted progress string for UI display
 */
function formatGoalProgress(goal) {
    if (goal.unit === 'currency') {
        if (goal.type === 'category_limit' || goal.type === 'coffee_budget') {
            const spent = goal.target * (1 - goal.currentProgress / 100);
            return `${formatCurrency(spent)} / ${formatCurrency(goal.target)}`;
        } else if (goal.type === 'emergency_fund' && goal.months && monthlyExpenses > 0) {
            // Show coverage for emergency fund goals 
            const coverageMonths = (goal.currentProgress / monthlyExpenses).toFixed(1);
            return `${formatCurrency(goal.currentProgress)} / ${formatCurrency(goal.target)} (${coverageMonths} months coverage)`;
        }
        return `${formatCurrency(goal.currentProgress)} / ${formatCurrency(goal.target)}`;
    } else if (goal.unit === 'percent') {
        return `${goal.currentProgress.toFixed(1)}% / ${goal.target}%`;
    } else if (goal.unit === 'days') {
        return `${goal.currentProgress} / ${goal.target} days`;
    }
    return `${goal.currentProgress} / ${goal.target}`;
}

function closeGoalSelection() {
    document.getElementById('goal-selection-modal').classList.add('hidden');
}

        // --- Help Accordion Management ---
        function toggleHelpSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const toggle = document.getElementById(`${sectionId}-toggle`);
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = '▲';
                toggle.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                toggle.textContent = '▼';
                toggle.style.transform = 'rotate(0deg)';
            }
            
            // Save state to localStorage
            const expandedSections = JSON.parse(localStorage.getItem('expandedHelpSections') || '{}');
            expandedSections[sectionId] = !content.classList.contains('hidden');
            localStorage.setItem('expandedHelpSections', JSON.stringify(expandedSections));
        }

        function initializeHelpSectionStates() {
            const expandedSections = JSON.parse(localStorage.getItem('expandedHelpSections') || '{}');
            
            // Default: expand "Getting Started" section only
            const sections = ['getting-started', 'dashboard-overview', 'financial-management', 'analytics-insights', 'settings-configuration', 'troubleshooting'];
            
            sections.forEach(sectionId => {
                const content = document.getElementById(`${sectionId}-content`);
                const toggle = document.getElementById(`${sectionId}-toggle`);
                
                if (content && toggle) {
                    const shouldExpand = expandedSections.hasOwnProperty(sectionId) ? 
                        expandedSections[sectionId] : 
                        (sectionId === 'getting-started'); // Default expand first section
                    
                    if (shouldExpand) {
                        content.classList.remove('hidden');
                        toggle.textContent = '▲';
                    } else {
                        content.classList.add('hidden');
                        toggle.textContent = '▼';
                    }
                }
            });
        }

        // --- Tab Management ---
        function showTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            // Deactivate all desktop and mobile tab buttons
            document.querySelectorAll('.tab-button, .bottom-nav-item').forEach(button => button.classList.remove('active'));

            // Activate desktop tab button
            const desktopTabButton = document.getElementById(`tab-${tabName}`);
            if (desktopTabButton) desktopTabButton.classList.add('active');
            
            // Activate mobile tab button
            const mobileTabButton = document.getElementById(`mobile-tab-${tabName}`);
            if (mobileTabButton) mobileTabButton.classList.add('active');

            // Show the content panel
            const newTabContent = document.getElementById(`${tabName}-tab`);
            if (newTabContent) {
                newTabContent.classList.remove('hidden');
            }
            
                activeTab = tabName;
                
                // Save current tab to localStorage for page refresh persistence
                localStorage.setItem('currentTab', tabName);

                // Render content based on the active tab
                if (activeTab === 'overview') {
                    // Initialize 7-day trend chart on dashboard
                    if (!sevenDayTrendChart) {
                        setTimeout(() => initializeSevenDayTrendChart(), 100);
                    } else {
                        updateSevenDayTrendChart();
                    }
                } else if (activeTab === 'insights') {
                    updateChartsAndInsights();
                    // Update Today's Budget section when switching to insights
                    updateTodaysBudget();
                    // Initialize collapsible section states
                    initializeInsightsSectionStates();
                } else if (activeTab === 'expenses') {
                    renderExpensesTable();
                } else if (activeTab === 'recurring') {
                    renderRecurringTable();
                } else if (activeTab === 'settings') {
                    populateSettingsForm();
                } else if (activeTab === 'help') {
                    initializeHelpSectionStates();
                }
                saveData();
        }
        
        // --- Insights Section Toggle Management ---
        function toggleInsightsSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const toggle = document.getElementById(`${sectionId}-toggle`);
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = '▼'; // Down arrow for expanded
                toggle.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                toggle.textContent = '▶'; // Right arrow for collapsed
                toggle.style.transform = 'rotate(0deg)';
            }
            
            // Save the state to localStorage
            const expandedSections = JSON.parse(localStorage.getItem('expandedInsightsSections') || '{}');
            expandedSections[sectionId] = !content.classList.contains('hidden');
            localStorage.setItem('expandedInsightsSections', JSON.stringify(expandedSections));
        }
        
        // Initialize collapsed state for insights sections
        function initializeInsightsSectionStates() {
            const expandedSections = JSON.parse(localStorage.getItem('expandedInsightsSections') || '{}');
            
            // Default expanded sections (removed 'daily-spending' as it's no longer collapsible)
            const defaultExpanded = ['budget-coach'];
            
            ['budget-coach', 'spending-breakdown', 'todays-budget', 'category-analysis', 'smart-insights', 'budget-performance'].forEach(sectionId => {
                const content = document.getElementById(`${sectionId}-content`);
                const toggle = document.getElementById(`${sectionId}-toggle`);
                
                if (content && toggle) {
                    const shouldBeExpanded = expandedSections.hasOwnProperty(sectionId) ? 
                        expandedSections[sectionId] : 
                        defaultExpanded.includes(sectionId);
                    
                    if (shouldBeExpanded) {
                        content.classList.remove('hidden');
                        toggle.textContent = '▼';
                        toggle.style.transform = 'rotate(0deg)';
                    } else {
                        content.classList.add('hidden');
                        toggle.textContent = '▶';
                        toggle.style.transform = 'rotate(0deg)';
                    }
                }
            });
        }

        let currentView = 'daily';
        let chart, categoryChart, velocityChart;

        

        // Generate smart alerts
        function generateAlerts() {
            const insights = calculateInsights();
            const container = document.getElementById('alerts-section');
            const alerts = [];

            if (insights.projectedMonthly > financialData.monthlyBudget) {
                alerts.push({
                    type: 'warning',
                    icon: '⚠️',
                    title: 'Budget Alert',
                    message: `You're projected to exceed your budget by £${(insights.projectedMonthly - financialData.monthlyBudget).toFixed(2)}`,
                    action: 'Reduce daily spending by £5-10'
                });
            }

            if (insights.goalImpact > 0) {
                alerts.push({
                    type: 'alert',
                    icon: '🏠',
                    title: 'Goal Impact',
                    message: `Current spending delays your house deposit by ${insights.goalImpact} weeks`,
                    action: 'Consider cutting non-essential expenses'
                });
            }

            if (insights.dailyRecommended < financialData.dailyBudget) {
                alerts.push({
                    type: 'success',
                    icon: '✅',
                    title: 'On Track',
                    message: `Great job! You can spend £${insights.dailyRecommended.toFixed(2)} per day for the rest of the month`,
                    action: 'Keep up the good work'
                });
            }

            container.innerHTML = alerts.map(alert => `
                <div class="${alert.type === 'warning' ? 'warning-card' : alert.type === 'alert' ? 'alert-card' : 'success-card'} p-4 rounded-lg">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl">${alert.icon}</div>
                        <div class="flex-1">
                            <h4 class="font-semibold mb-1" style="color: var(--color-text-primary);">${alert.title}</h4>
                            <p class="text-sm mb-2" style="color: var(--color-text-primary);">${alert.message}</p>
                            <p class="text-xs font-medium" style="color: var(--color-text-primary);">${alert.action}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Generate coaching panel
        function generateCoachingPanel() {
            const insights = calculateInsights();
            const container = document.getElementById('coaching-panel');
            const today = new Date();
            const daysLeft = 30 - today.getDate();

            const coaching = [
                {
                    title: 'Today\'s Budget',
                    value: `£${insights.dailyRecommended.toFixed(2)}`,
                    subtitle: 'Recommended spend',
                    status: insights.dailyRecommended < financialData.dailyBudget ? 'success' : 'warning'
                },
                {
                    title: 'Days Left',
                    value: daysLeft,
                    subtitle: 'in this month',
                    status: 'neutral'
                },
                {
                    title: 'Budget Remaining',
                    value: `£${insights.remainingBudget.toFixed(2)}`,
                    subtitle: `${((insights.remainingBudget / financialData.monthlyBudget) * 100).toFixed(0)}% left`,
                    status: insights.remainingBudget > 0 ? 'success' : 'warning'
                }
            ];

            container.innerHTML = coaching.map(item => `
                <div class="text-center p-4 rounded-lg" style="background-color: var(--color-bg-tertiary);">
                    <div class="text-2xl font-bold" style="color: ${item.status === 'success' ? 'var(--color-success)' : item.status === 'warning' ? 'var(--color-error)' : 'var(--color-text-primary)'};">${item.value}</div>
                    <div class="text-sm font-medium" style="color: var(--color-text-primary);">${item.title}</div>
                    <div class="text-xs" style="color: var(--color-text-primary);">${item.subtitle}</div>
                </div>
            `).join('');
        }

        // Update metrics
        function updateMetrics() {
            const insights = calculateInsights();
            document.getElementById('goal-impact').textContent = insights.goalImpact > 0 ? `+${insights.goalImpact} weeks` : 'On track';
            document.getElementById('monthly-forecast').textContent = `£${insights.projectedMonthly.toFixed(0)}`;
            document.getElementById('forecast-status').textContent = 
                insights.projectedMonthly > financialData.monthlyBudget ? 
                `${(((insights.projectedMonthly - financialData.monthlyBudget) / financialData.monthlyBudget) * 100).toFixed(0)}% over budget` :
                `${((1 - insights.projectedMonthly / financialData.monthlyBudget) * 100).toFixed(0)}% under budget`;
        }

        // Generate category breakdown
        function generateCategoryBreakdown() {
            const categoryTotals = {};
            spendingData.forEach(day => {
                if (day.category) {
                    categoryTotals[day.category] = (categoryTotals[day.category] || 0) + day.amount;
                }
            });

            const sortedCategories = Object.entries(categoryTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const container = document.getElementById('category-breakdown');
            const total = Object.values(categoryTotals).reduce((sum, amount) => sum + amount, 0);

            container.innerHTML = sortedCategories.map(([category, amount]) => {
                const percentage = (amount / total * 100).toFixed(0);
                const colors = {
                    'Food': ['#10b981', '#059669'],
                    'Transport': ['#3b82f6', '#1d4ed8'],
                    'Entertainment': ['#8b5cf6', '#7c3aed'],
                    'Shopping': ['#f59e0b', '#d97706'],
                    'Bills': ['#ef4444', '#dc2626']
                };
                const [startColor, endColor] = colors[category] || ['#6b7280', '#4b5563'];

                return `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-gray-700">${category}</span>
                                <span class="text-lg font-bold text-gray-900">£${amount.toFixed(2)}</span>
                            </div>
                            <div class="category-bar" style="--start-color: ${startColor}; --end-color: ${endColor}; width: ${percentage}%;"></div>
                            <div class="text-xs text-gray-500 mt-1">${percentage}% of total spending</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Create enhanced chart
        function createChart() {
            const ctx = document.getElementById('budgetChart').getContext('2d');
            const insights = calculateInsights();
            
            // Prepare data based on current view
            let labels, spendingAmounts, predictions;
            
            if (currentView === 'daily') {
                labels = spendingData.map(d => d.day);
                spendingAmounts = spendingData.map(d => d.amount);
                // Add prediction for remaining days
                const remainingDays = 30 - spendingData.length;
                const predictedDaily = insights.dailyRecommended;
                predictions = Array(remainingDays).fill(predictedDaily);
                labels = [...labels, ...Array.from({length: remainingDays}, (_, i) => spendingData.length + i + 1)];
                spendingAmounts = [...spendingAmounts, ...predictions];
            }

            const datasets = [
                {
                    label: 'Monthly Income (Daily Average)',
                    data: Array(labels.length).fill(financialData.income / 30),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    pointRadius: 0,
                    borderDash: [5, 5],
                    fill: false
                },
                {
                    label: 'Monthly Budget (Daily Average)',
                    data: Array(labels.length).fill(financialData.monthlyBudget / 30),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 3,
                    pointRadius: 0,
                    borderDash: [10, 5],
                    fill: false
                },
                {
                    label: 'Daily Budget Threshold',
                    data: Array(labels.length).fill(financialData.dailyBudget),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                },
                {
                    label: 'Your Daily Spending',
                    data: spendingAmounts.slice(0, spendingData.length),
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointBackgroundColor: spendingAmounts.slice(0, spendingData.length).map(amount => {
                        if (amount > financialData.dailyBudget) return '#ef4444';
                        if (amount === 0) return '#6b7280';
                        return '#10b981';
                    }),
                    pointBorderColor: '#8b5cf6',
                    pointBorderWidth: 2,
                    fill: false,
                    tension: 0.2
                }
            ];

            // Add prediction line if in daily view
            if (currentView === 'daily' && predictions.length > 0) {
                datasets.push({
                    label: 'Recommended Spending',
                    data: [...Array(spendingData.length).fill(null), ...predictions],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    pointRadius: 3,
                    borderDash: [3, 3],
                    fill: false,
                    tension: 0.1
                });
            }

            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (context.datasetIndex === 3) {
                                        const status = value > financialData.dailyBudget ? '(Over daily budget)' : 
                                                     value === 0 ? '(No spending)' : '(Under daily budget)';
                                        return `Spent: £${value.toFixed(2)} ${status}`;
                                    }
                                    return `${context.dataset.label}: £${value.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Day of Month' },
                            grid: { display: false }
                        },
                        y: {
                            title: { display: true, text: 'Amount (£)' },
                            beginAtZero: true,
                            max: Math.max(financialData.income / 30 * 1.2, Math.max(...spendingAmounts) * 1.2),
                            grid: { color: 'rgba(0, 0, 0, 0.02)' }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Create category chart
        function createCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const categoryTotals = {};
            spendingData.forEach(day => {
                if (day.category) {
                    categoryTotals[day.category] = (categoryTotals[day.category] || 0) + day.amount;
                }
            });

            const categories = Object.keys(categoryTotals);
            const amounts = Object.values(categoryTotals);
            const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444'];

            if (categoryChart) categoryChart.destroy();
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 20, usePointStyle: true }
                        }
                    }
                }
            });
        }

        // Create velocity chart
        function createVelocityChart() {
            const ctx = document.getElementById('velocityChart').getContext('2d');
            
            // Calculate 3-day moving average
            const movingAverage = [];
            for (let i = 2; i < spendingData.length; i++) {
                const avg = (spendingData[i-2].amount + spendingData[i-1].amount + spendingData[i].amount) / 3;
                movingAverage.push(avg);
            }

            if (velocityChart) velocityChart.destroy();
            
            velocityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: movingAverage.length}, (_, i) => `Day ${i + 3}`),
                    datasets: [{
                        label: '3-Day Spending Average',
                        data: movingAverage,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Daily Budget',
                        data: Array(movingAverage.length).fill(financialData.dailyBudget),
                        borderColor: '#10b981',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Generate weekly pattern
        function generateWeeklyPattern() {
            const container = document.getElementById('weekly-pattern');
            const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const weeklyTotals = Array(7).fill(0);
            const weeklyCounts = Array(7).fill(0);

            spendingData.forEach(day => {
                const dayOfWeek = (day.day - 1) % 7;
                weeklyTotals[dayOfWeek] += day.amount;
                weeklyCounts[dayOfWeek]++;
            });

            const weeklyAverages = weeklyTotals.map((total, i) => 
                weeklyCounts[i] > 0 ? total / weeklyCounts[i] : 0
            );

            container.innerHTML = weekDays.map((day, i) => {
                const avg = weeklyAverages[i];
                const percentage = (avg / Math.max(...weeklyAverages)) * 100;
                return `
                    <div class="flex items-center justify-between p-2 rounded bg-gray-50">
                        <span class="text-sm font-medium">${day.slice(0, 3)}</span>
                        <div class="flex-1 mx-3">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <span class="text-sm font-bold">£${avg.toFixed(0)}</span>
                    </div>
                `;
            }).join('');
        }

        // Generate daily breakdown
        function generateDailyBreakdown() {
            const container = document.getElementById('daily-breakdown');
            container.innerHTML = '';

            const weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            spendingData.slice(0, 14).forEach((data, index) => {
                const dayOfWeek = weekDays[index % 7];
                const isOverBudget = data.amount > financialData.dailyBudget;
                const isUnderBudget = data.amount > 0 && data.amount <= financialData.dailyBudget;

                const card = document.createElement('div');
                let statusClass = 'border-gray-200 bg-gray-50';
                let indicatorClass = '';
                let statusText = 'No Spending';

                if (isOverBudget) {
                    statusClass = 'border-red-200 bg-red-50';
                    indicatorClass = 'over-budget';
                    statusText = 'Over Budget';
                } else if (isUnderBudget) {
                    statusClass = 'border-green-200 bg-green-50';
                    indicatorClass = 'under-budget';
                    statusText = 'On Track';
                }

                card.className = `text-center p-3 rounded-lg border ${statusClass}`;
                card.innerHTML = `
                    <div class="text-xs text-gray-500 mb-1">${dayOfWeek}</div>
                    <div class="text-lg font-bold">Day ${data.day}</div>
                    <div class="text-xl font-bold text-gray-900 mb-2">£${data.amount}</div>
                    <div class="spending-indicator ${indicatorClass}"></div>
                    <div class="text-xs font-medium ${isOverBudget ? 'text-red-600' : isUnderBudget ? 'text-green-600' : 'text-gray-500'}">${statusText}</div>
                    <div class="text-xs text-gray-400 mt-1">${data.category || ''}</div>
                `;

                container.appendChild(card);
            });
        }
    

        // View toggle functions
        function setView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.toggle-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(view + '-btn').classList.add('active');
            
            // Recreate chart with new view
            createChart();
        }

        // Initialize insights dashboard
        function initInsightsDashboard() {
            generateAlerts();
            generateCoachingPanel();
            updateMetrics();
            generateCategoryBreakdown();
            createChart();
            createCategoryChart();
            createVelocityChart();
            generateWeeklyPattern();
            generateDailyBreakdown();
            generateInsights();
        }

        // --- Settings & Theme ---
        function toggleSettings() {
            DOMElements.settingsMenu.classList.toggle('hidden');
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.trezor-sidebar');
            const isCollapsed = sidebar.classList.contains('collapsed');
            
            if (isCollapsed) {
                sidebar.classList.remove('collapsed');
                localStorage.setItem('sidebarCollapsed', 'false');
            } else {
                sidebar.classList.add('collapsed');
                localStorage.setItem('sidebarCollapsed', 'true');
            }
        }

        function restoreSidebarState() {
            const sidebar = document.querySelector('.trezor-sidebar');
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
            } else {
                sidebar.classList.remove('collapsed');
            }
        }

        function toggleTheme(isDark) {
            localStorage.setItem('darkMode', isDark);
            applyTheme();
        }

        function toggleThemeFromHeader() {
            // Get current theme state and toggle it
            const currentDarkMode = localStorage.getItem('darkMode') === 'true';
            const newDarkMode = !currentDarkMode;
            
            localStorage.setItem('darkMode', newDarkMode);
            applyTheme();
        }

        function toggleThemeFromSettings(isDark) {
            localStorage.setItem('darkMode', isDark);
            applyTheme();
        }

        function applyTheme() {
            // Get saved theme preference, default to light mode if not set
            let savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === null) {
                // Default to light mode
                savedDarkMode = 'false';
                localStorage.setItem('darkMode', savedDarkMode);
            }
            
            const darkMode = savedDarkMode === 'true';
            
            // Apply theme to html element
            DOMElements.html.classList.toggle('dark', darkMode);
            
            // Apply data-theme attribute for new design system
            if (darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            // Sync the settings toggle
            if (DOMElements.themeToggle) {
                DOMElements.themeToggle.checked = darkMode;
            }
            
            // Update the header theme toggle button title
            if (DOMElements.themeToggleBtn) {
                DOMElements.themeToggleBtn.title = darkMode ? 'Switch to light mode' : 'Switch to dark mode';
            }
            
            // The CSS will automatically handle the icon visibility based on .dark class
            
            if (activeTab === 'insights') {
                updateChartsAndInsights(); 
            }
        }

        // --- Data Load/Save ---
        /**
         * Load application data from localStorage/authentication system
         * Restores all user data including expenses, goals, and settings
         */
        function loadData() {
            const data = authManager.getUserData('lensAppData');
            if (data) {
                const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                console.log('loadData - raw data from localStorage:', data);
                console.log('loadData - parsedData.userGoals:', parsedData.userGoals);
                console.log('loadData - userGoals before assignment:', userGoals);
                
                // Restore core financial data
                expenses = parsedData.expenses || [];
                recurringItems = parsedData.recurringItems || [];
                monthlyBudget = parsedData.monthlyBudget || 0;
                monthlyIncome = parsedData.monthlyIncome || 0;
                monthlyExpenses = parsedData.monthlyExpenses || 0;
                
                // Initialize simplified income system
                migrateIncomeToRecurringOnly();
                
                // Restore user preferences and state
                totalSavings = parsedData.totalSavings || 0;
                totalDebt = parsedData.totalDebt || 0;
                healthScoreHistory = parsedData.healthScoreHistory || {};
                currentCurrencyCode = parsedData.currentCurrencyCode || 'GBP';
                activeTab = parsedData.activeTab || 'overview';
                userGoals = parsedData.userGoals || [];
                
                console.log('loadData - userGoals after assignment:', userGoals);
                console.log('🎯 loadData - userGoals length:', userGoals.length);
                console.log('🔥 loadData - expenses loaded:', expenses.length);
            } else {
                console.log('⚠️ loadData - no data found in localStorage');
            }
            
            // Clean any corrupted health score data
            cleanHealthScoreData();
            
            // Refresh UI components after data load
            console.log('🔄 loadData - forcing renderRecentExpenses');
            setTimeout(() => {
                if (typeof renderRecentExpenses === 'function') {
                    renderRecentExpenses();
                }
            }, 100);
        }

        /**
         * Save application data to localStorage and authentication system
         * Persists all user data including expenses, goals, and settings
         */
        function saveData() {
            try {
                console.log('🔥 SAVING CURRENT GLOBAL VARIABLES');
                console.log('Saving:', { monthlyIncome, monthlyBudget, monthlyExpenses });
                
                // Package all application state for persistence
                const dataToSave = {
                    expenses,
                    recurringItems,
                    monthlyBudget,        // Current spending limit
                    monthlyIncome,        // Current income amount
                    monthlyExpenses,      // Calculated monthly expenses
                    dailyBudget,
                    dailyBudgetOverride,
                    currentCurrencyCode,
                    totalSavings,
                    totalDebt,
                    userGoals,
                    lastSaved: new Date().toISOString()
                };

                // Primary storage: localStorage (always available)
                localStorage.setItem('lensAppData', JSON.stringify(dataToSave));
                console.log('✅ Saved to localStorage');
                
                // Secondary storage: authManager (if user authenticated)
                if (typeof authManager !== 'undefined' && authManager.saveUserData) {
                    try {
                        authManager.saveUserData('lensAppData', dataToSave);
                        console.log('✅ Saved to authManager');
                    } catch (error) {
                        console.log('AuthManager save failed, but localStorage succeeded:', error.message);
                    }
                }
                
                console.log('🎉 Data saved successfully');
            } catch (error) {
                console.error('❌ Error saving data:', error);
                showToast('Error saving data', 'error');
            }
        }

        // --- Import / Export ---
        function exportData() {
            const dataObj = authManager.getUserData('lensAppData') || {};
            const dataStr = JSON.stringify(dataObj);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `lens-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData === 'object' && importedData !== null) {
                        expenses = importedData.expenses || [];
                        recurringItems = importedData.recurringItems || [];
                        monthlyBudget = importedData.monthlyBudget || 0;
                        monthlyIncome = importedData.monthlyIncome || 0;
                        healthScoreHistory = importedData.healthScoreHistory || {};
                        currentCurrencyCode = importedData.currentCurrencyCode || 'GBP';
                        activeTab = importedData.activeTab || 'overview';
                        userGoals = importedData.userGoals || [];
                        
                        if (DOMElements.currencySelect) {
                            DOMElements.currencySelect.value = currentCurrencyCode;
                        }

                        saveData();
                        updateCurrencyUI();
                        updateDisplay();
                        showTab(activeTab);
                        showToast('Data imported successfully!');
                        closeSettings();
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    showToast('Import failed: Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        // --- Budget & Income ---
        function updateBudget(value) {
            monthlyBudget = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }
        function updateIncome(value) {
            monthlyIncome = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }

        // --- Tooltip Management ---
        function toggleBudgetHealthTooltip() {
            const tooltip = document.getElementById('budget-health-tooltip-container');
            if (tooltip.style.opacity === '1') {
                tooltip.style.opacity = '0';
                tooltip.style.pointerEvents = 'none';
            } else {
                tooltip.style.opacity = '1';
                tooltip.style.pointerEvents = 'auto';
            }
        }

        function toggleHealthScoreTooltip() {
            const tooltip = document.getElementById('health-score-tooltip-container');
            if (tooltip.style.opacity === '1') {
                tooltip.style.opacity = '0';
                tooltip.style.pointerEvents = 'none';
            } else {
                tooltip.style.opacity = '1';
                tooltip.style.pointerEvents = 'auto';
            }
        }

        // Hide tooltips when clicking outside
        document.addEventListener('click', function(event) {
            const budgetTooltip = document.getElementById('budget-health-tooltip-container');
            const scoreTooltip = document.getElementById('health-score-tooltip-container');
            
            // Check if click is outside both tooltips and their triggers
            if (!event.target.closest('#budget-health-tooltip-container') && 
                !event.target.closest('svg[onclick="toggleBudgetHealthTooltip()"]')) {
                budgetTooltip.style.opacity = '0';
                budgetTooltip.style.pointerEvents = 'none';
            }
            
            if (!event.target.closest('#health-score-tooltip-container') && 
                !event.target.closest('svg[onclick="toggleHealthScoreTooltip()"]')) {
                scoreTooltip.style.opacity = '0';
                scoreTooltip.style.pointerEvents = 'none';
            }
        });

        // --- Currency Management ---
        function changeCurrency(value) {
            if (currencyConfig[value]) {
                currentCurrencyCode = value;
                updateCurrencyUI();
                saveData();
                updateDisplay();
                showToast(`Currency changed to ${value}`);
            }
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function updateCurrencyUI() {
            const symbol = currencyConfig[currentCurrencyCode].symbol;
            DOMElements.modalCurrency.textContent = symbol;
            DOMElements.recurringModalCurrency.textContent = symbol;
            DOMElements.currencySelect.value = currentCurrencyCode;
            
            // Update ALL currency symbol spans throughout the app
            const currencySymbolElements = document.querySelectorAll('.currency-symbol');
            currencySymbolElements.forEach(element => {
                element.textContent = symbol;
            });
            
            // Update insights chart if on insights tab
            if (activeTab === 'insights' && dailySpendingInsightsChart) {
                updateDailySpendingInsightsChart();
            }
        }

        // --- Daily Budget & Income Display Settings ---
        function toggleDailyBudget() {
            const enabled = document.getElementById('daily-budget-enabled').checked;
            localStorage.setItem('dailyBudgetEnabled', enabled.toString());
            
            if (enabled) {
                const amount = parseFloat(document.getElementById('daily-budget-amount').value) || (monthlyBudget / 30);
                enableDailyBudget(amount);
            } else {
                disableDailyBudget();
            }
        }

        function updateDailyBudget() {
            const enabled = document.getElementById('daily-budget-enabled').checked;
            if (enabled) {
                const amount = parseFloat(document.getElementById('daily-budget-amount').value);
                if (amount > 0) {
                    // Don't store daily budget - it should be calculated from monthly budget
                    enableDailyBudget(amount);
                    
                    // Update budget line immediately if on insights tab
                    if (activeTab === 'insights') {
                        setTimeout(() => {
                            updateDailyBudgetLineAnnotation();
                        }, 100);
                    }
                }
            }
        }

        function toggleIncomeDisplay() {
            const enabled = document.getElementById('income-display-enabled').checked;
            localStorage.setItem('monthlyIncomeEnabled', enabled.toString());
            
            if (enabled) {
                enableMonthlyIncomeDisplay();
            } else {
                disableMonthlyIncomeDisplay();
            }
        }

        function enableDailyBudget(amount) {
            // Don't store daily budget amount - it should be calculated from monthly budget
            localStorage.setItem('dailyBudgetEnabled', 'true');
            
            // Update insights if open
            if (activeTab === 'insights' && window.FinanceInsights) {
                window.FinanceInsights.refresh();
            }
            
            // Show daily budget coaching elements
            const coachingElements = document.querySelectorAll('.daily-coaching-badge');
            coachingElements.forEach(el => el.style.display = 'inline-block');
        }

        function disableDailyBudget() {
            localStorage.setItem('dailyBudgetEnabled', 'false');
            
            // Hide daily budget coaching elements
            const coachingElements = document.querySelectorAll('.daily-coaching-badge');
            coachingElements.forEach(el => el.style.display = 'none');
            
            // Update insights if open
            if (activeTab === 'insights' && window.FinanceInsights) {
                window.FinanceInsights.refresh();
            }
        }

        function enableMonthlyIncomeDisplay() {
            localStorage.setItem('monthlyIncomeEnabled', 'true');
            
            // Update charts to show income line
            if (activeTab === 'insights') {
                updateChartsAndInsights();
            }
        }

        function disableMonthlyIncomeDisplay() {
            localStorage.setItem('monthlyIncomeEnabled', 'false');
            
            // Update charts to hide income line
            if (activeTab === 'insights') {
                updateChartsAndInsights();
            }
        }

        function loadInsightsSettings() {
            const dailyBudgetEnabled = localStorage.getItem('dailyBudgetEnabled') === 'true';
            const incomeDisplayEnabled = localStorage.getItem('monthlyIncomeEnabled') === 'true';
            const dailyBudgetAmount = localStorage.getItem('dailyBudget');
            
            // Update checkbox states
            const dailyBudgetCheckbox = document.getElementById('daily-budget-enabled');
            const incomeDisplayCheckbox = document.getElementById('income-display-enabled');
            const dailyBudgetInput = document.getElementById('daily-budget-amount');
            
            if (dailyBudgetCheckbox) dailyBudgetCheckbox.checked = dailyBudgetEnabled;
            if (incomeDisplayCheckbox) incomeDisplayCheckbox.checked = incomeDisplayEnabled;
            if (dailyBudgetInput && dailyBudgetAmount) {
                dailyBudgetInput.value = dailyBudgetAmount;
            }
            
            // Apply settings
            if (dailyBudgetEnabled && dailyBudgetAmount) {
                enableDailyBudget(parseFloat(dailyBudgetAmount));
            } else {
                disableDailyBudget();
            }
            
            if (incomeDisplayEnabled) {
                enableMonthlyIncomeDisplay();
            } else {
                disableMonthlyIncomeDisplay();
            }
        }

        // --- Expense Management ---
        function showAddForm(prefill = {}) {
            editingExpense = null;
            DOMElements.modalTitle.textContent = 'Add New Expense';
            DOMElements.expenseName.value = prefill.name || '';
            DOMElements.expenseCost.value = prefill.cost || '';
            DOMElements.expenseType.value = prefill.type || 'Non-Essential';
            DOMElements.expenseCategory.value = prefill.category || 'Other';
            DOMElements.expenseDate.value = prefill.date || getLocalDateString();
            DOMElements.expensePaymentMethod.value = prefill.paymentMethod || '';
            
            // Ensure we're on the same page/tab and modal appears over current content
            DOMElements.modal.classList.remove('hidden');
        }

        // Fixed showModal function for expenses (alias for showAddForm)
        function showModal() {
            showAddForm();
        }

        function closeModal() {
            DOMElements.modal.classList.add('hidden');
            editingExpense = null;
        }

        function handleExpenseFormSubmission(event) {
            event.preventDefault();
            saveExpense();
        }

        function saveExpense() {
            const name = DOMElements.expenseName.value.trim();
            const cost = parseFloat(DOMElements.expenseCost.value);
            const date = DOMElements.expenseDate.value;

            if (!name || isNaN(cost) || cost <= 0 || !date) {
                showToast('Please fill in all fields correctly (Name, positive Amount, Date).', 'error');
                return;
            }

            const expense = {
                id: editingExpense ? editingExpense.id : Date.now(),
                name: name,
                cost: cost,
                type: DOMElements.expenseType.value,
                category: DOMElements.expenseCategory.value,
                date: date,
                paymentMethod: DOMElements.expensePaymentMethod.value,
                status: 'active'
            };

            // Check for spending intervention (only when viewing insights tab)
            if (!editingExpense && activeTab === 'insights' && dailyBudgetCoach && dailyBudgetCoach.isInitialized) {
                const intervention = dailyBudgetCoach.checkSpendingIntervention(cost);
                if (intervention) {
                    const proceed = confirm(`${intervention.message}\n\n${intervention.suggestion}\n\nProceed with this expense?`);
                    if (!proceed) {
                        return; // User chose not to add the expense
                    }
                }
            }

            if (editingExpense) {
                const index = expenses.findIndex(e => e.id === editingExpense.id);
                if (index !== -1) expenses[index] = expense;
            } else {
                expenses.push(expense);
                
                // Notify daily budget coach of new expense (only when viewing insights tab)
                if (activeTab === 'insights' && dailyBudgetCoach && dailyBudgetCoach.isInitialized) {
                    dailyBudgetCoach.onExpenseAdded(expense);
                }
            }

            sortExpenses();
            saveData();
            updateDisplay();
            closeModal();
            showToast(`Expense '${name}' saved successfully.`, "success");
            
            // Refresh insights after adding expense
            if (activeTab === 'insights') {
                setTimeout(updateChartsAndInsights, 100);
            }
        }
        
        function quickAddExpense(name, category, type, cost) {
            // Check for spending intervention (only when viewing insights tab)
            if (activeTab === 'insights' && dailyBudgetCoach && dailyBudgetCoach.isInitialized) {
                const intervention = dailyBudgetCoach.checkSpendingIntervention(cost);
                if (intervention) {
                    const proceed = confirm(`${intervention.message}\n\n${intervention.suggestion}\n\nProceed with this expense?`);
                    if (!proceed) {
                        return; // User chose not to add the expense
                    }
                }
            }
            
            const expense = {
                    id: Date.now(),
                name: name,
                cost: cost,
                type: type || 'Non-Essential',
                category: category || 'Other',
                date: getLocalDateString(),
                paymentMethod: '',
                    status: 'active'
                };
            expenses.push(expense);
            console.log('🆕 quickAddExpense - expense added:', expense);
            console.log('📊 quickAddExpense - total expenses now:', expenses.length);
            
            // Notify daily budget coach of new expense (only when viewing insights tab)
            if (activeTab === 'insights' && dailyBudgetCoach && dailyBudgetCoach.isInitialized) {
                dailyBudgetCoach.onExpenseAdded(expense);
            }
            
            sortExpenses();
            saveData();
            updateDisplay();
            
            // Force render recent expenses after adding
            setTimeout(() => {
                renderRecentExpenses();
            }, 50);
            
            showToast(`${name} added successfully for ${formatCurrency(cost)}.`);
            
            // Refresh insights after adding expense
            if (activeTab === 'insights') {
                setTimeout(updateChartsAndInsights, 100);
            }
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
            editingExpense = expense;
                DOMElements.modalTitle.textContent = 'Edit Expense';
                DOMElements.expenseName.value = expense.name;
                DOMElements.expenseCost.value = expense.cost;
                DOMElements.expenseType.value = expense.type;
                DOMElements.expenseCategory.value = expense.category;
                DOMElements.expenseDate.value = expense.date;
                DOMElements.expensePaymentMethod.value = expense.paymentMethod || '';
                DOMElements.modal.classList.remove('hidden');
            }
        }

        function deleteExpense(id) {
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                const expenseName = expenses[index].name;
                expenses.splice(index, 1);
                console.log('🗑️ deleteExpense - expense deleted:', expenseName);
                console.log('📊 deleteExpense - total expenses now:', expenses.length);
                
                saveData();
                updateDisplay();
                
                // Force immediate table refresh
                renderExpensesTable();
                
                // Force render recent expenses after deleting
                setTimeout(() => {
                    renderRecentExpenses();
                }, 50);
                
                showToast(`Expense '${expenseName}' deleted.`, 'info');
                
                // Refresh insights after deleting expense
                if (activeTab === 'insights') {
                    setTimeout(updateChartsAndInsights, 100);
                }
            }
        }

        function toggleExpenseStatus(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.status = expense.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                
                // Force immediate table refresh
                renderExpensesTable();
                
                showToast(`Expense status updated to ${expense.status}.`);
            }
        }

        function toggleFilterPanel(panelId) {
            document.getElementById(panelId).classList.toggle('hidden');
        }

        // --- Recurring Item Management ---
        function populateCategoryDropdowns() {
            const expenseOptions = expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            DOMElements.expenseCategory.innerHTML = expenseOptions;
            
            document.getElementById('expense-filter-category').innerHTML = '<option value="">All Categories</option>' + expenseOptions;
            
            const allCats = [...new Set([...expenseCategories, ...incomeCategories])];
            document.getElementById('recurring-filter-category').innerHTML = '<option value="">All Categories</option>' + allCats.map(c => `<option value="${c}">${c}</option>`).join('');

            toggleRecurringFields('expense');
        }

        function toggleRecurringFields(type) {
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            DOMElements.recurringCategory.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            DOMElements.recurringEssentialTypeWrapper.style.display = type === 'expense' ? 'block' : 'none';
        }

         function showRecurringForm() {
            editingRecurring = null;
            
            // Reset all form fields
            DOMElements.recurringModalTitle.textContent = 'Add Recurring Item';
            DOMElements.recurringItemType.value = 'expense';
            DOMElements.recurringName.value = '';
            DOMElements.recurringAmount.value = '';
            DOMElements.recurringFrequency.value = 'Monthly';
            DOMElements.recurringPaymentMethod.value = '';
            DOMElements.recurringStartDate.value = getLocalDateString();
            DOMElements.recurringEndDate.value = '';
            
            // Initialize the form properly
            toggleRecurringFields('expense');
            
            // Show modal over current content (same behavior as expense modal)
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function showAddIncomeForm() {
            editingRecurring = null;
            
            // Reset all form fields
            DOMElements.recurringModalTitle.textContent = 'Add Income';
            DOMElements.recurringItemType.value = 'income';
            DOMElements.recurringName.value = '';
            DOMElements.recurringAmount.value = '';
            DOMElements.recurringFrequency.value = 'Monthly';
            DOMElements.recurringPaymentMethod.value = '';
            DOMElements.recurringStartDate.value = getLocalDateString();
            DOMElements.recurringEndDate.value = '';
            
            // Initialize the form properly
            toggleRecurringFields('income');
            
            // Show modal over current content (same behavior as other modals)
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function closeRecurringModal() {
            DOMElements.recurringModal.classList.add('hidden');
            editingRecurring = null;
        }

        function saveRecurring() {
            const type = DOMElements.recurringItemType.value;
            const name = DOMElements.recurringName.value.trim();
            const amount = parseFloat(DOMElements.recurringAmount.value);
            const startDate = DOMElements.recurringStartDate.value;
            const endDate = DOMElements.recurringEndDate.value || null;

            if (!name || isNaN(amount) || amount <= 0 || !startDate) {
                 showToast('Please fill in recurring item fields correctly.', 'error');
                return;
            }

            const recurringItem = {
                id: editingRecurring ? editingRecurring.id : Date.now(),
                type: type,
                name: name,
                amount: amount,
                frequency: DOMElements.recurringFrequency.value,
                category: DOMElements.recurringCategory.value,
                essentialType: type === 'expense' ? DOMElements.recurringEssentialType.value : null,
                paymentMethod: DOMElements.recurringPaymentMethod.value,
                startDate: startDate,
                endDate: endDate,
                status: 'active'
            };

            if (editingRecurring) {
                const index = recurringItems.findIndex(r => r.id === editingRecurring.id);
                if (index !== -1) recurringItems[index] = recurringItem;
            } else {
                recurringItems.push(recurringItem); // Add to end, sorting will handle chronological order
            }

            saveData();
            syncGlobalIncomeFromRecurring(); // Sync global income
            
            // Fix: Force immediate processing and update
            processRecurringExpenses();
            updateDisplay();
            
            closeRecurringModal();
            showToast(`Recurring item '${name}' saved successfully.`, "success");
        }

        function editRecurring(id) {
            const item = recurringItems.find(r => r.id === id);
            if (!item) return;
            editingRecurring = item;
            DOMElements.recurringModalTitle.textContent = 'Edit Recurring Item';
            DOMElements.recurringItemType.value = item.type;
            toggleRecurringFields(item.type);
            DOMElements.recurringName.value = item.name;
            DOMElements.recurringAmount.value = item.amount;
            DOMElements.recurringFrequency.value = item.frequency;
            DOMElements.recurringCategory.value = item.category;
            if (item.type === 'expense') {
                DOMElements.recurringEssentialType.value = item.essentialType || 'Non-Essential';
            }
            DOMElements.recurringPaymentMethod.value = item.paymentMethod || '';
            DOMElements.recurringStartDate.value = item.startDate;
            DOMElements.recurringEndDate.value = item.endDate || '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function deleteRecurring(id) {
            if (confirm('Are you sure you want to delete this recurring item and all its automatically generated expenses?')) {
                // Remove the recurring item
                recurringItems = recurringItems.filter(r => r.id !== id);
                
                // Remove ALL associated auto-generated expenses
                const initialExpenseCount = expenses.length;
                expenses = expenses.filter(e => e.recurringSourceId !== id);
                const removedExpenseCount = initialExpenseCount - expenses.length;
                
                // Remove from selected items
                selectedRecurringIds.delete(id);
                
                saveData();
                syncGlobalIncomeFromRecurring(); // Sync global income
                updateDisplay();
                
                // Force immediate table refresh
                renderRecurringTable();
                if (removedExpenseCount > 0) {
                    renderExpensesTable(); // Also refresh expenses table if expenses were removed
                }
                
                if (removedExpenseCount > 0) {
                    showToast(`Recurring item and ${removedExpenseCount} associated expense(s) deleted!`);
                } else {
                    showToast('Recurring item deleted!');
                }
            }
        }
        
        function toggleRecurringStatus(id) {
            const item = recurringItems.find(r => r.id === id);
            if(item) {
                item.status = item.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                
                // Force immediate table refresh
                renderRecurringTable();
                
                showToast(`Recurring item status updated.`);
            }
        }
        
        // --- Filtering Logic ---
        function applyExpenseFilters() {
            window.expensesCurrentPage = 1; // Reset to first page when filtering
            renderExpensesTable();
            showToast('Filters applied');
        }

        function clearExpenseFilters() {
            document.getElementById('expense-filter-date-from').value = '';
            document.getElementById('expense-filter-date-to').value = '';
            document.getElementById('expense-filter-category').value = '';
            document.getElementById('expense-filter-type').value = '';
            window.expensesCurrentPage = 1; // Reset to first page when clearing
            renderExpensesTable();
            showToast('Filters cleared');
        }

        function applyRecurringFilters() {
            window.recurringCurrentPage = 1; // Reset to first page when filtering
            renderRecurringTable();
            showToast('Filters applied');
        }

        function clearRecurringFilters() {
            document.getElementById('recurring-filter-type').value = '';
            document.getElementById('recurring-filter-category').value = '';
            document.getElementById('recurring-filter-frequency').value = '';
            window.recurringCurrentPage = 1; // Reset to first page when clearing
            renderRecurringTable();
            showToast('Filters cleared');
        }
        
        // --- Bulk Actions ---
        function toggleSelectAllExpenses(checked) {
            const checkboxes = DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox');
            selectedExpenseIds.clear();
            checkboxes.forEach(cb => {
                if (!cb.disabled) {
                    cb.checked = checked;
                    if (checked) {
                        selectedExpenseIds.add(cb.dataset.id);
                    }
                }
            });
            updateDeleteSelectedButton();
        }

        function toggleExpenseSelection(checkbox, id) {
            if (checkbox.checked) {
                selectedExpenseIds.add(id);
            } else {
                selectedExpenseIds.delete(id);
            }
            const allCheckboxes = [...DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox:not(:disabled)')];
            DOMElements.selectAllExpensesCheckbox.checked = allCheckboxes.length > 0 && selectedExpenseIds.size === allCheckboxes.length;
            updateDeleteSelectedButton();
        }

        function updateDeleteSelectedButton() {
            if (selectedExpenseIds.size > 0) {
                DOMElements.deleteSelectedBtn.classList.remove('hidden');
                DOMElements.deleteSelectedBtn.querySelector('span').textContent = `Delete Selected (${selectedExpenseIds.size})`;
            } else {
                DOMElements.deleteSelectedBtn.classList.add('hidden');
            }
        }

        function deleteSelectedExpenses() {
            if (selectedExpenseIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedExpenseIds.size} selected one-time expense(s)?`)) {
                const initialCount = expenses.length;
                expenses = expenses.filter(e => !selectedExpenseIds.has(e.id.toString()));
                const deletedCount = initialCount - expenses.length;
                selectedExpenseIds.clear();
                DOMElements.selectAllExpensesCheckbox.checked = false;
                saveData();
                updateDisplay();
                
                // Force immediate table refresh
                renderExpensesTable();
                
                showToast(`${deletedCount} expense(s) deleted.`);
            }
        }
        
        function toggleSelectAllRecurring(checked) {
            const checkboxes = DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox');
            selectedRecurringIds.clear();
            checkboxes.forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedRecurringIds.add(parseInt(cb.dataset.id));
                }
            });
            updateDeleteSelectedRecurringButton();
        }

        function toggleRecurringSelection(checkbox, id) {
            const numId = parseInt(id);
            if (checkbox.checked) {
                selectedRecurringIds.add(numId);
            } else {
                selectedRecurringIds.delete(numId);
            }
            const allCheckboxes = [...DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox')];
            DOMElements.selectAllRecurringCheckbox.checked = allCheckboxes.length > 0 && selectedRecurringIds.size === allCheckboxes.length;
            updateDeleteSelectedRecurringButton();
        }

        function updateDeleteSelectedRecurringButton() {
            const btn = DOMElements.deleteSelectedRecurringBtn;
            if (selectedRecurringIds.size > 0) {
                btn.classList.remove('hidden');
                btn.querySelector('span').textContent = `Delete Selected (${selectedRecurringIds.size})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        function deleteSelectedRecurring() {
            if (selectedRecurringIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedRecurringIds.size} recurring item(s) and their associated expenses?`)) {
                let totalRemovedExpenses = 0;
                
                // For each selected recurring item, remove associated expenses
                selectedRecurringIds.forEach(recurringId => {
                    const initialExpenseCount = expenses.length;
                    expenses = expenses.filter(e => e.recurringSourceId !== recurringId);
                    totalRemovedExpenses += (initialExpenseCount - expenses.length);
                });
                
                // Remove the recurring items
                const deletedRecurringCount = selectedRecurringIds.size;
                recurringItems = recurringItems.filter(r => !selectedRecurringIds.has(r.id));
                
                // Clear selections and update UI
                selectedRecurringIds.clear();
                DOMElements.selectAllRecurringCheckbox.checked = false;
                
                saveData();
                syncGlobalIncomeFromRecurring(); // Sync global income
                updateDisplay();
                
                // Force immediate table refresh
                renderRecurringTable();
                if (totalRemovedExpenses > 0) {
                    renderExpensesTable(); // Also refresh expenses table if expenses were removed
                }
                
                if (totalRemovedExpenses > 0) {
                    showToast(`${deletedRecurringCount} recurring item(s) and ${totalRemovedExpenses} associated expense(s) deleted!`);
                } else {
                    showToast(`${deletedRecurringCount} recurring item(s) deleted!`);
                }
            }
        }

        // --- Calculation Functions ---
        function getMonthlyRecurringTotals(year, month) {
            let totals = { income: 0, expenses: 0, incomeItems: [], expenseItems: [], salaryIncome: 0, otherIncome: 0 };
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            recurringItems.forEach(item => {
                if (item.status !== 'active') return;

                const startDate = new Date(item.startDate + 'T00:00:00');
                if (startDate > lastDay) return;

                if (item.endDate) {
                    const endDate = new Date(item.endDate + 'T00:00:00');
                    if (endDate < firstDay) return;
                }

                // Check if this recurring item has a due date in this month
                let currentDate = new Date(startDate);
                let hasOccurrenceThisMonth = false;
                let iterations = 0;
                
                while (currentDate <= lastDay && iterations < 100) {
                    if (currentDate >= firstDay && currentDate <= lastDay) {
                        hasOccurrenceThisMonth = true;
            break;
    }

                    // Move to next occurrence
                    switch (item.frequency) {
                        case 'Daily': currentDate.setDate(currentDate.getDate() + 1); break;
                        case 'Weekly': currentDate.setDate(currentDate.getDate() + 7); break;
                        case 'Bi-Weekly': currentDate.setDate(currentDate.getDate() + 14); break;
                        case 'Monthly': currentDate.setMonth(currentDate.getMonth() + 1); break;
                        case 'Quarterly': currentDate.setMonth(currentDate.getMonth() + 3); break;
                        case 'Annual': currentDate.setFullYear(currentDate.getFullYear() + 1); break;
                        default: iterations = 100; break;
                    }
                    iterations++;
                }

                // If there's an occurrence this month, count it once
                if (hasOccurrenceThisMonth) {
                    if (item.type === 'income') {
                        totals.income += item.amount;
                        if (!totals.incomeItems.find(i => i.id === item.id)) {
                            totals.incomeItems.push(item);
                        }
                        
                        // Separate salary from other income based on category
                        if (item.category === 'Salary') {
                            totals.salaryIncome += item.amount;
                        } else if (item.category === 'Other Income') {
                            totals.otherIncome += item.amount;
                        }
                        // Note: Other income types like Bonus, Investment, Gift are not included in either category for now
                    } else {
                        // Note: Don't add recurring expenses here since they're already in the main expenses array
                        // Only track for income calculations
                        if (!totals.expenseItems.find(i => i.id === item.id)) {
                            totals.expenseItems.push(item);
                        }
                    }
                }
            });
            
            return totals;
        }

        function getMonthlyExpenseTotal(year, month) {
            return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === month && 
                       expenseDate.getFullYear() === year;
            }).reduce((sum, e) => sum + e.cost, 0);
        }

        // --- UI Update Functions ---
        function getResponsiveFontSize(text) {
            const baseSize = 1.875; // Corresponds to text-3xl
            const minSize = 1.25; // Corresponds to text-xl
            const maxLength = 8; // Start shrinking after 8 characters
            
            let newSize = baseSize;
            if (text.length > maxLength) {
                newSize = Math.max(minSize, baseSize - (text.length - maxLength) * 0.15);
            }
            return `${newSize}rem`;
        }

        function updateQuickAddButtons() {
            const quickAddData = {
                'JPY': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 500 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 700 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 1000 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 20000 }
                ],
                'default': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 5 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 10 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 15 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 50 }
                ]
            };

            const currencyData = quickAddData[currentCurrencyCode] || quickAddData['default'];
            
            currencyData.forEach(item => {
                const container = document.getElementById(item.id);
                if (container) {
                    const button = container.querySelector('button');
                    if (button) {
                        const costSpan = button.querySelector('span.font-medium');
                        if (costSpan) {
                            costSpan.textContent = formatCurrency(item.cost);
                        }
                        button.onclick = () => quickAddExpense(item.name, item.category, item.type, item.cost);
                    }
                }
            });
        }

        function updateBudgetPercentageIndicators(totalSpent, monthlyBudget, totalMonthlyIncome) {
            console.log('🔄 FIXED: Updating budget percentage indicators');
            console.log('Input values:', { totalSpent, monthlyBudget, totalMonthlyIncome });
            
            // Get current date info for pace calculations
            const now = new Date();
            const currentDate = now.getDate();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const monthProgress = currentDate / daysInMonth; // Decimal: 0.5 = halfway through month
            
            console.log('Date calculations:', { 
                currentDate, 
                daysInMonth, 
                monthProgress: monthProgress.toFixed(3),
                monthProgressPercent: (monthProgress * 100).toFixed(1) + '%'
            });
            
            // 1. Monthly Budget: Show as % of income
            const budgetChangeIndicator = document.getElementById('budget-change-indicator');
            if (budgetChangeIndicator) {
                if (monthlyIncome > 0) {
                    const budgetIncomePercentage = (monthlyBudget / monthlyIncome) * 100;
                    budgetChangeIndicator.textContent = `${budgetIncomePercentage.toFixed(1)}% of income`;
                    
                    console.log('💰 Budget percentage:', budgetIncomePercentage.toFixed(1) + '%');
                    
                    // Color coding: green if reasonable (≤70%), yellow if high (≤90%), red if excessive (>90%)
                    if (budgetIncomePercentage <= 70) {
                        budgetChangeIndicator.className = 'text-xs text-green-600 mt-1';
                    } else if (budgetIncomePercentage <= 90) {
                        budgetChangeIndicator.className = 'text-xs text-yellow-600 mt-1';
                    } else {
                        budgetChangeIndicator.className = 'text-xs text-red-600 mt-1';
                    }
                } else {
                    budgetChangeIndicator.textContent = 'Set income in settings';
                    budgetChangeIndicator.className = 'text-xs text-gray-600 mt-1';
                }
            }
            
            // 2. FIXED: Spent This Month - Show spending pace vs expected pace
            const spentChangeIndicator = document.getElementById('spent-change-indicator');
            if (spentChangeIndicator) {
                if (monthlyBudget > 0 && totalSpent > 0) {
                    const spentPercentage = (totalSpent / monthlyBudget) * 100;
                    const expectedPercentage = monthProgress * 100; // Convert decimal to percentage
                    const paceVariance = spentPercentage - expectedPercentage;
                    
                    console.log('📊 Spending pace calculations:', {
                        spentPercentage: spentPercentage.toFixed(1) + '%',
                        expectedPercentage: expectedPercentage.toFixed(1) + '%', 
                        paceVariance: paceVariance.toFixed(1) + '%'
                    });
                    
                    if (Math.abs(paceVariance) < 5) {
                    spentChangeIndicator.textContent = 'On pace ✓';
                    spentChangeIndicator.className = 'text-xs text-green-600 mt-1';
                    } else if (paceVariance > 0) {
                    spentChangeIndicator.textContent = `+${paceVariance.toFixed(1)}% ahead of pace`;
                    spentChangeIndicator.className = 'text-xs text-red-600 mt-1';
                    } else {
                    spentChangeIndicator.textContent = `${Math.abs(paceVariance).toFixed(1)}% under pace`;
                    spentChangeIndicator.className = 'text-xs text-green-600 mt-1';
                    }
                } else if (monthlyBudget <= 0) {
                    spentChangeIndicator.textContent = 'Set budget in settings';
                    spentChangeIndicator.className = 'text-xs text-gray-600 mt-1';
                } else {
                    spentChangeIndicator.textContent = 'No spending yet';
                    spentChangeIndicator.className = 'text-xs text-gray-600 mt-1';
                }
            }
            
            // 3. Budget Remaining: Show % of budget left
            const remainingChangeIndicator = document.getElementById('remaining-change-indicator');
            if (remainingChangeIndicator) {
                if (monthlyBudget > 0) {
                    const remaining = monthlyBudget - totalSpent;
                    const remainingPercentage = (remaining / monthlyBudget) * 100;
                    
                    console.log('💳 Remaining calculations:', {
                        remaining: remaining.toFixed(2),
                        remainingPercentage: remainingPercentage.toFixed(1) + '%'
                    });
                    
                    if (remaining >= 0) {
                        remainingChangeIndicator.textContent = `${remainingPercentage.toFixed(1)}% remaining`;
                        
                        // Color coding: green if >50%, yellow if 10-50%, red if <10%
                        if (remainingPercentage > 50) {
                            remainingChangeIndicator.className = 'text-xs text-green-600 mt-1';
                        } else if (remainingPercentage > 10) {
                            remainingChangeIndicator.className = 'text-xs text-yellow-600 mt-1';
                        } else {
                            remainingChangeIndicator.className = 'text-xs text-red-600 mt-1';
                        }
                    } else {
                        // Over budget
                        const overBudgetPercentage = Math.abs(remaining / monthlyBudget) * 100;
                        remainingChangeIndicator.textContent = `${overBudgetPercentage.toFixed(1)}% over budget`;
                        remainingChangeIndicator.className = 'text-xs text-red-600 mt-1';
                    }
                } else {
                    remainingChangeIndicator.textContent = 'Set budget in settings';
                    remainingChangeIndicator.className = 'text-xs text-gray-600 mt-1';
                }
            }
            
            console.log('✅ Budget percentage indicators updated successfully');
        }

        function updateDisplay() {
            console.time('updateDisplay');
            
            sortExpenses();
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Centralized calculations for all expenses this month
            const monthlyRecurring = getMonthlyRecurringTotals(currentYear, currentMonth);
            const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;

            // ✅ FIXED: Only use the main expenses array (recurring expenses are already there)
            const allMonthlyExpenses = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            const totalSpent = allMonthlyExpenses.reduce((sum, e) => {
                const cost = parseFloat(e.cost) || 0;
                return sum + (isNaN(cost) ? 0 : cost);
            }, 0);

            // --- Update UI Tiles ---
            const budgetStr = formatCurrency(monthlyBudget);
            const spentStr = formatCurrency(totalSpent);
            const incomeStr = formatCurrency(totalMonthlyIncome);
            const remaining = monthlyBudget - totalSpent;
            const remainingStr = formatCurrency(remaining);

            // Find the longest string to determine a consistent font size
            const maxLength = Math.max(budgetStr.length, spentStr.length, incomeStr.length, remainingStr.length);
            const responsiveSize = getResponsiveFontSize(" ".repeat(maxLength));

            if (DOMElements.monthlyBudgetDisplay) {
                DOMElements.monthlyBudgetDisplay.textContent = budgetStr;
                DOMElements.monthlyBudgetDisplay.style.fontSize = responsiveSize;
            }

            if (DOMElements.totalExpensesDisplay) {
                DOMElements.totalExpensesDisplay.textContent = spentStr;
                DOMElements.totalExpensesDisplay.style.fontSize = responsiveSize;
            }
            
            if (DOMElements.totalIncomeDisplay) {
                DOMElements.totalIncomeDisplay.textContent = incomeStr;
                DOMElements.totalIncomeDisplay.style.fontSize = responsiveSize;
            }

            if (DOMElements.remainingAmountDisplay) {
                DOMElements.remainingAmountDisplay.textContent = remainingStr;
                DOMElements.remainingAmountDisplay.style.fontSize = responsiveSize;

                if (remaining < 0) {
                    DOMElements.remainingAmountDisplay.classList.remove('text-green-600', 'dark:text-green-400');
                    DOMElements.remainingAmountDisplay.classList.add('text-red-600', 'dark:text-red-400');
                } else {
                    DOMElements.remainingAmountDisplay.classList.remove('text-red-600', 'dark:text-red-400');
                    DOMElements.remainingAmountDisplay.classList.add('text-green-600', 'dark:text-green-400');
                }
            }

            // Update dynamic percentage indicators
            updateBudgetPercentageIndicators(totalSpent, monthlyBudget, totalMonthlyIncome);

            updateQuickAddButtons();

            // Budget Progress - Exact Layout Match
            const budgetProgress = (monthlyBudget > 0) ? (totalSpent / monthlyBudget) * 100 : 0;
            const incomePercentage = (totalMonthlyIncome > 0) ? (totalSpent / totalMonthlyIncome) * 100 : 0;
            
            // Update budget progress text
            const budgetProgressUsed = document.getElementById('budget-progress-used');
            if (budgetProgressUsed) {
                budgetProgressUsed.textContent = `${budgetProgress.toFixed(0)}% Used`;
            }
            
            // Update budget limit label
            const budgetLimitLabel = document.getElementById('budget-limit-label');
            if (budgetLimitLabel) {
                budgetLimitLabel.textContent = formatCurrency(monthlyBudget);
            }
            
            // Update progress bar width
            const budgetProgressBar = document.getElementById('budget-progress-bar');
            if (budgetProgressBar) {
                const progressWidth = Math.min(budgetProgress, 100);
                budgetProgressBar.style.width = `${progressWidth}%`;
                console.log('📊 Budget progress bar updated:', progressWidth + '%');
                
                // Color based on progress
                if (budgetProgress >= 90) {
                    budgetProgressBar.className = 'bg-red-600 h-4 rounded-full transition-all duration-500';
                } else if (budgetProgress >= 75) {
                    budgetProgressBar.className = 'bg-orange-500 h-4 rounded-full transition-all duration-500';
                } else {
                    budgetProgressBar.className = 'bg-green-600 h-4 rounded-full transition-all duration-500';
                }
            }
            
            const budgetIncomePercentage = document.getElementById('budget-income-percentage');
            if (budgetIncomePercentage) {
                budgetIncomePercentage.textContent = `${incomePercentage.toFixed(0)}% of total income`;
            }
            
            // Update circular health score (simplified calculation)
            const healthScore = Math.max(0, Math.min(100, 100 - budgetProgress + (totalMonthlyIncome > totalSpent ? 20 : 0)));
            const healthScoreDisplay = document.getElementById('health-score-display');
            if (healthScoreDisplay) {
                healthScoreDisplay.textContent = Math.round(healthScore);
            }
            
            // Update Budget Progress & Health tooltip with real numbers
            updateBudgetHealthTooltip(totalSpent, monthlyBudget);
            
            // Update health score status
            const healthScoreStatus = document.getElementById('health-score-status');
            if (healthScoreStatus) {
                if (healthScore >= 80) {
                    healthScoreStatus.textContent = 'Excellent';
                } else if (healthScore >= 70) {
                    healthScoreStatus.textContent = 'Good';
                } else if (healthScore >= 50) {
                    healthScoreStatus.textContent = 'Fair';
                } else {
                    healthScoreStatus.textContent = 'Poor';
                }
            }
            
            // Update circular progress indicator
            const healthProgressCircle = document.getElementById('health-progress-circle');
            if (healthProgressCircle) {
                const circumference = 283; // 2 * PI * 45
                const progressOffset = circumference - (healthScore / 100) * circumference;
                healthProgressCircle.style.strokeDashoffset = progressOffset;
                
                // Color based on health score - always orange for now to match image
                healthProgressCircle.style.stroke = '#f97316'; // orange
            }
            
            // Update AI insights with real data  
            const aiInsight = document.getElementById('ai-insight');
            const aiInsightStatus = document.getElementById('ai-insight-status');
            if (aiInsight && aiInsightStatus) {
                // DEBUG: Log all the values being used
                console.log('🔍 PROJECTION DEBUG:');
                console.log('- Monthly Budget:', formatCurrency(monthlyBudget));
                console.log('- Total Spent This Month:', formatCurrency(totalSpent));
                console.log('- Total Monthly Income:', formatCurrency(totalMonthlyIncome));
                console.log('- Number of expenses this month:', allMonthlyExpenses.length);
                console.log('- Expenses:', allMonthlyExpenses);
                
                const today = new Date();
                const currentDate = today.getDate();
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                const daysLeft = daysInMonth - currentDate;
                
                console.log('- Current date:', currentDate);
                console.log('- Days left in month:', daysLeft);
                console.log('- Daily average spend:', totalSpent / currentDate);
                
                if (monthlyBudget > 0 && totalSpent > 0) {
                    const dailySpendRate = totalSpent / currentDate;
                    const projectedTotal = totalSpent + (dailySpendRate * daysLeft);
                    
                    console.log('- Projected month-end total:', formatCurrency(projectedTotal));
                    
                    if (projectedTotal <= monthlyBudget) {
                        aiInsight.innerHTML = `📊 Projection: Spent ${formatCurrency(totalSpent)} so far, on track for ${formatCurrency(projectedTotal)} total. <span class="text-green-600 font-medium">Within Budget</span>`;
                        aiInsightStatus.textContent = 'Good';
                    } else {
                        const overage = projectedTotal - monthlyBudget;
                        aiInsight.innerHTML = `📊 Projection: Spent ${formatCurrency(totalSpent)} so far, projecting ${formatCurrency(projectedTotal)} total. <span class="text-red-600 font-medium">Over by ${formatCurrency(overage)}</span>`;
                        aiInsightStatus.textContent = 'Warning';
                    }
                } else if (monthlyBudget <= 0) {
                    aiInsight.textContent = '📊 Projection: Set your monthly budget in Settings to get insights';
                    aiInsightStatus.textContent = 'No budget set';
                } else {
                    aiInsight.textContent = '📊 Projection: No expenses yet this month';
                    aiInsightStatus.textContent = 'No spending data';
                }
            }
            
            // Update 7-day trend chart if on overview tab
            if (activeTab === 'overview' && sevenDayTrendChart) {
                updateSevenDayTrendChart();
            }
            
            // Update days remaining
            const daysRemaining = document.getElementById('days-remaining');
            if (daysRemaining) {
                const today = new Date();
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                const daysLeft = Math.max(0, lastDay.getDate() - today.getDate());
                daysRemaining.textContent = `${daysLeft} days left`;
            }
            
            // Budget Projection
            const projection = predictMonthEndSpending(totalSpent, now);
            if (DOMElements.aiProjectionContainer) {
                DOMElements.aiProjectionContainer.innerHTML = `
                                <div class="flex items-center gap-2">
                    <span class="text-lg">🔮</span>
                    <div class="flex items-center gap-2">
                            <div>
                        <span class="font-semibold">Budget Projection:</span>
                        You're on track to spend <strong>${formatCurrency(projection.projectedSpend)}</strong> this month.
                        <span class="font-bold ${projection.statusColor}">${projection.statusText}</span>
                                </div>
                        <div class="tooltip">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 cursor-help hover:text-gray-600 dark:hover:text-gray-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="tooltiptext">
                                <strong>How this works:</strong><br>
                                Based on your spending so far (${formatCurrency(totalSpent)}) divided by ${new Date().getDate()} days = ${formatCurrency(totalSpent / new Date().getDate())} per day average.<br><br>
                                Projected over ${new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate()} days in this month = ${formatCurrency(projection.projectedSpend)} total.<br><br>
                                This becomes more accurate as you add more expenses throughout the month.
                        </div>
                    </div>
                </div>
                    </div>
            `;
            }
            
            // ✅ FIXED: Use the correct variable name 'allMonthlyExpenses' instead of 'activeMonthlyExpenses'
            updateBudgetHealthScore(totalSpent, monthlyBudget, allMonthlyExpenses, totalMonthlyIncome, now);
            
            // Spending Breakdown - FIXED: Use correct variable name with null checks
            const essentialSpending = allMonthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
            const nonEssentialSpending = allMonthlyExpenses.filter(e => e.type === 'Non-Essential').reduce((sum, e) => sum + e.cost, 0);
            
            // Add null checks to prevent errors
            if (DOMElements.essentialSpendingDisplay) {
                DOMElements.essentialSpendingDisplay.textContent = formatCurrency(essentialSpending);
            }
            if (DOMElements.nonEssentialSpendingDisplay) {
                DOMElements.nonEssentialSpendingDisplay.textContent = formatCurrency(nonEssentialSpending);
            }
            
            const totalBreakdown = essentialSpending + nonEssentialSpending;
            const essentialPercent = totalBreakdown > 0 ? (essentialSpending / totalBreakdown) * 100 : 0;
            
            if (DOMElements.essentialBar) {
                DOMElements.essentialBar.style.width = `${essentialPercent}%`;
            }
            if (DOMElements.nonEssentialBar) {
                DOMElements.nonEssentialBar.style.width = `${100 - essentialPercent}%`;
            }

            // ✅ These functions should now work properly
            renderRecentExpenses();
            renderExpensesTable();
            renderRecurringTable();
            
            if (activeTab === 'insights') {
                updateChartsAndInsights();
                // Update Today's Budget section (only in insights tab)
                updateTodaysBudget();
            }
            updateDeleteSelectedButton();
            updateDeleteSelectedRecurringButton();
            
            // Update table labels for mobile cards
            setTimeout(updateTableLabels_NEW, 10);
            
            updateGoalProgressDisplay(); // ADD THIS LINE
            updateUpcomingEvents(); // Update upcoming events display
            
            // Update daily budget coaching display - Disabled for cleaner dashboard
            // if (dailyBudgetCoach && dailyBudgetCoach.isInitialized) {
            //     dailyBudgetCoach.refreshDailyBudgetDisplay();
            // }

            console.timeEnd('updateDisplay');
            
            // Update income section
            updateIncomeSection();
        }

        // --- Income Calculation Functions ---
        
        function updateIncomeSection() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Get total income from recurring entries only (single source of truth)
            const totalMonthlyIncome = calculateTotalIncomeFromRecurring();
            
            // Update global variable for compatibility with other functions
            monthlyIncome = totalMonthlyIncome;
            
            // Update total monthly income display
            const totalIncomeElement = document.getElementById('total-monthly-income');
            if (totalIncomeElement) {
                totalIncomeElement.textContent = formatCurrency(totalMonthlyIncome);
            }
            
            // Update income breakdown tooltip using new system
            const incomeBreakdown = getIncomeSourcesBreakdown();
            updateIncomeBreakdownTooltip(0, incomeBreakdown.salaryIncome, incomeBreakdown.otherIncome);
            
            // Calculate and update savings rate
            const totalSpent = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            }).reduce((sum, e) => sum + e.cost, 0);
            
            const savingsAmount = totalMonthlyIncome - totalSpent;
            const savingsRate = totalMonthlyIncome > 0 ? (savingsAmount / totalMonthlyIncome) * 100 : 0;
            
            // Update savings rate display
            const savingsRateElement = document.getElementById('savings-rate-display');
            if (savingsRateElement) {
                savingsRateElement.textContent = `💰 Savings Rate: ${savingsRate.toFixed(0)}%`;
            }
            
            // Update monthly savings card
            const monthlySavingsElement = document.getElementById('monthly-savings');
            if (monthlySavingsElement) {
                monthlySavingsElement.textContent = formatCurrency(savingsAmount);
                
                // Update color based on savings amount
                if (savingsAmount >= 0) {
                    monthlySavingsElement.classList.remove('text-red-600', 'dark:text-red-400');
                    monthlySavingsElement.classList.add('text-purple-600', 'dark:text-purple-400');
                } else {
                    monthlySavingsElement.classList.remove('text-purple-600', 'dark:text-purple-400');
                    monthlySavingsElement.classList.add('text-red-600', 'dark:text-red-400');
                }
            }
        }
        
        function updateIncomeBreakdownTooltip(baseIncome, salaryIncome, otherIncome) {
            const tooltipElement = document.getElementById('income-breakdown-tooltip');
            if (tooltipElement) {
                let breakdownText = '';
                
                // In the simplified system, all salary income is from recurring entries
                const totalBaseSalary = salaryIncome; // No more settings base income
                
                if (totalBaseSalary > 0) {
                    breakdownText += `Base salary: ${formatCurrency(totalBaseSalary)}`;
                }
                
                if (otherIncome > 0) {
                    if (breakdownText) breakdownText += '<br>';
                    breakdownText += `Other income: ${formatCurrency(otherIncome)}`;
                }
                
                if (!breakdownText) {
                    breakdownText = 'No income sources configured';
                }
                
                tooltipElement.innerHTML = breakdownText;
            }
        }
        
        function updateBudgetHealthTooltip(totalSpent, monthlyBudget) {
            const today = new Date();
            const currentDate = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const dailyAverage = totalSpent / currentDate;
            const projectedTotal = dailyAverage * daysInMonth;
            
            // Update tooltip elements
            const tooltipCurrentSpend = document.getElementById('tooltip-current-spend');
            const tooltipDailyAvg = document.getElementById('tooltip-daily-avg');
            const tooltipProjected = document.getElementById('tooltip-projected');
            const tooltipBudget = document.getElementById('tooltip-budget');
            
            if (tooltipCurrentSpend) tooltipCurrentSpend.textContent = formatCurrency(totalSpent);
            if (tooltipDailyAvg) tooltipDailyAvg.textContent = formatCurrency(dailyAverage);
            if (tooltipProjected) tooltipProjected.textContent = formatCurrency(projectedTotal);
            if (tooltipBudget) tooltipBudget.textContent = formatCurrency(monthlyBudget);
        }

        // --- Budget Health Score v3 ---

        // CRITICAL FIX: Clear contaminated health score data
        function cleanHealthScoreData() {
            console.log('🧹 Cleaning health score data...');
            
            if (healthScoreHistory && typeof healthScoreHistory === 'object') {
                let cleanedCount = 0;
                Object.keys(healthScoreHistory).forEach(key => {
                    const storedScore = healthScoreHistory[key];
                    if (typeof storedScore !== 'number' || isNaN(storedScore) || storedScore < 0 || storedScore > 100) {
                        console.warn('❌ Removing contaminated health score:', key, storedScore);
                        delete healthScoreHistory[key];
                        cleanedCount++;
                    }
                });
                
                if (cleanedCount > 0) {
                    console.log(`✅ Cleaned ${cleanedCount} contaminated health score entries`);
                    saveData();
                }
            }
            
            // Also clear any contaminated localStorage data
            try {
                const lensData = localStorage.getItem('lensAppData');
                if (lensData) {
                    const parsed = JSON.parse(lensData);
                    if (parsed.healthScoreHistory) {
                        let changed = false;
                        Object.keys(parsed.healthScoreHistory).forEach(key => {
                            const score = parsed.healthScoreHistory[key];
                            if (typeof score !== 'number' || isNaN(score) || score < 0 || score > 100) {
                                delete parsed.healthScoreHistory[key];
                                changed = true;
                            }
                        });
                        
                        if (changed) {
                            localStorage.setItem('lensAppData', JSON.stringify(parsed));
                            console.log('✅ Cleaned contaminated localStorage health scores');
                        }
                    }
                }
            } catch (error) {
                console.warn('Error cleaning localStorage:', error);
            }
        }

        // Manual health score reset function (can be called from console)
        window.resetHealthScore = function() {
            console.log('🔄 Manually resetting health score...');
            healthScoreHistory = {};
            cleanHealthScoreData();
            updateDisplay();
            console.log('✅ Health score reset complete');
        };

        function calculateBudgetUsageScore(totalSpent, budget, now) {
            let score = 0;
            
            // Validate inputs
            const validTotalSpent = (typeof totalSpent === 'number' && !isNaN(totalSpent)) ? Math.max(0, totalSpent) : 0;
            const validBudget = (typeof budget === 'number' && !isNaN(budget)) ? Math.max(0, budget) : 0;
            
            // Component 1: Budget Usage (30 points)
            if (validBudget > 0) {
                const usage = validTotalSpent / validBudget;
                if (usage > 1) score += 0;
                else if (usage <= 0.8) score += 30;
                else score += 30 * (1 - (usage - 0.8) / 0.2);
            }

            // Component 2: Spending Velocity (20 points)
            if (validBudget > 0) {
                const dayOfMonth = now.getDate();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const percentOfMonthPassed = dayOfMonth / daysInMonth;
                const idealSpend = validBudget * percentOfMonthPassed;
                if (idealSpend > 0) {
                    const deviation = validTotalSpent / idealSpend;
                    if (deviation <= 1.0) score += 20;
                    else if (deviation <= 1.5) score += 20 * (1 - (deviation - 1.0) / 0.5);
                }
            }

            // Ensure score is a valid number
            const finalScore = (typeof score === 'number' && !isNaN(score)) ? Math.max(0, Math.min(50, Math.round(score))) : 0;
            
            return { score: finalScore, max: 50 };
        }

        function calculateSpendingHabitsScore(monthlyExpenses, totalSpent) {
            let score = 0;
            
            // Validate inputs
            const validTotalSpent = (typeof totalSpent === 'number' && !isNaN(totalSpent)) ? Math.max(0, totalSpent) : 0;
            const validExpenses = Array.isArray(monthlyExpenses) ? monthlyExpenses : [];
            
            if (validTotalSpent > 0 && validExpenses.length > 0) {
                // Component 1: Essential vs Non-Essential (15 points)
                const essentialSpending = validExpenses
                    .filter(e => e && e.type === 'Essential')
                    .reduce((sum, e) => sum + (typeof e.cost === 'number' ? e.cost : 0), 0);
                
                const nonEssentialRatio = (validTotalSpent - essentialSpending) / validTotalSpent;
                if (nonEssentialRatio < 0.3) score += 15;
                else if (nonEssentialRatio < 0.5) score += 7;

                // Component 2: No-Spend Days (15 points)
                const spendingDays = new Set(validExpenses.filter(e => e && e.date).map(e => e.date)).size;
                const currentDay = new Date().getDate();
                const zeroSpendingDays = Math.max(0, currentDay - spendingDays);
                if (zeroSpendingDays >= 8) score += 15;
                else if (zeroSpendingDays >= 4) score += 7;
            }
            
            // Ensure score is a valid number
            const finalScore = (typeof score === 'number' && !isNaN(score)) ? Math.max(0, Math.min(30, Math.round(score))) : 0;
            
            return { score: finalScore, max: 30 };
        }

        function calculateSavingsRateScore(totalSpent, totalMonthlyIncome, now) {
            let score = 0;
            
            // Validate inputs
            const validTotalSpent = (typeof totalSpent === 'number' && !isNaN(totalSpent)) ? Math.max(0, totalSpent) : 0;
            const validTotalIncome = (typeof totalMonthlyIncome === 'number' && !isNaN(totalMonthlyIncome)) ? Math.max(0, totalMonthlyIncome) : 0;
            
            // Component 1: Positive Savings (10 points)
            if (validTotalIncome > 0 && validTotalIncome > validTotalSpent) {
                score += 10;
            }
            
            // Component 2: Improving Savings Rate (10 points)
            try {
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonthData = getExpensesForMonth(lastMonth.getFullYear(), lastMonth.getMonth());
                const lastMonthIncomeData = getMonthlyRecurringTotals(lastMonth.getFullYear(), lastMonth.getMonth());
                const lastMonthTotalIncome = (monthlyIncome || 0) + (lastMonthIncomeData ? lastMonthIncomeData.income : 0);
                
                if (lastMonthTotalIncome > 0 && Array.isArray(lastMonthData)) {
                    const lastMonthSpent = lastMonthData.reduce((sum, e) => sum + (typeof e.cost === 'number' ? e.cost : 0), 0);
                    const currentSavingsRate = (validTotalIncome - validTotalSpent) / validTotalIncome;
                    const lastMonthSavingsRate = (lastMonthTotalIncome - lastMonthSpent) / lastMonthTotalIncome;
                    if (currentSavingsRate > lastMonthSavingsRate) {
                        score += 10;
                    }
                }
            } catch (error) {
                console.warn('Error calculating savings rate comparison:', error);
                // Continue without the improvement score component
            }
            
            // Ensure score is a valid number
            const finalScore = (typeof score === 'number' && !isNaN(score)) ? Math.max(0, Math.min(20, Math.round(score))) : 0;
            
            return { score: finalScore, max: 20 };
        }

        function generateHealthScoreInsights(scoreData, totalSpent, monthlyExpenses, totalMonthlyIncome) {
            const insights = { strengths: [], improvements: [], tip: '' };
            const { budgetUsage, spendingHabits, savingsRate } = scoreData.breakdown;

            // Strengths
            if (budgetUsage.score / budgetUsage.max > 0.8) insights.strengths.push("Excellent budget control and spending pace.");
            if (spendingHabits.score / spendingHabits.max > 0.8) insights.strengths.push("Great balance of essential vs. non-essential spending.");
            if (savingsRate.score / savingsRate.max > 0.8) insights.strengths.push("Fantastic! Your savings rate is improving.");
            if (insights.strengths.length === 0) insights.strengths.push("Getting started is the first step!");

            // Improvements & Tips
            let lowestCategory = 'budgetUsage';
            let lowestPercentage = (budgetUsage.score / budgetUsage.max);
            if ((spendingHabits.score / spendingHabits.max) < lowestPercentage) {
                lowestCategory = 'spendingHabits';
                lowestPercentage = spendingHabits.score / spendingHabits.max;
            }
            if ((savingsRate.score / savingsRate.max) < lowestPercentage) {
                lowestCategory = 'savingsRate';
            }
            
            if (lowestPercentage < 0.6) {
                switch(lowestCategory) {
                    case 'budgetUsage':
                        insights.improvements.push("Spending is outpacing your budget for this point in the month.");
                        insights.tip = "Try having a 'no-spend' day to get back on track.";
            break;
                    case 'spendingHabits':
                        insights.improvements.push("A high portion of spending is on non-essentials.");
                        insights.tip = "Review subscriptions or dining out for potential savings.";
            break;
                    case 'savingsRate':
                        insights.improvements.push("Currently not saving or saving less than last month.");
                        insights.tip = "Set a small, achievable savings goal for this month.";
            break;
    }
}
            if (insights.improvements.length === 0) insights.improvements.push("You're on the right track in all areas.");

            return insights;
        }

        // 🚨 CRITICAL FIX: Copy this ENTIRE function to replace your renderBudgetHealthScore function

        function renderBudgetHealthScore(scoreData) {
            const { totalScore, breakdown, insights } = scoreData;

            // Debug logging to catch the monetary value issue
            console.log('🔍 Budget Health Score Debug:');
            console.log('- Raw totalScore:', totalScore, typeof totalScore);
            console.log('- scoreData:', scoreData);
            
            // Validate totalScore is a proper score value (0-100)
            let validScore = totalScore;
            
            // Extra validation to catch cost/amount values that shouldn't be here
            if (typeof validScore !== 'number' || isNaN(validScore)) {
                console.warn('❌ Non-numeric score detected:', validScore, typeof validScore);
                validScore = 0;
            } else if (validScore < 0) {
                console.warn('❌ Negative score detected:', validScore);
                validScore = 0;
            } else if (validScore > 100) {
                console.warn('❌ Score over 100 detected (likely a monetary value):', validScore);
                validScore = 0; // Reset to 0 instead of capping at 100 to force recalculation
            }
            
            // Ensure the score is displayed as a whole number
            const displayScore = Math.round(validScore);
            
            console.log('- Final displayScore:', displayScore);
            
            // 🚨 THE MISSING CRITICAL LINES - ADD THESE!
            // Set the health score VALUE in the DOM element
            if (DOMElements.healthScoreValue) {
                DOMElements.healthScoreValue.textContent = displayScore;
                console.log('✅ Set health score VALUE to:', displayScore);
            } else {
                // Fallback - try direct element access
                const healthScoreValueElement = document.getElementById('health-score-value');
                if (healthScoreValueElement) {
                    healthScoreValueElement.textContent = displayScore;
                    console.log('✅ Set health score VALUE via fallback to:', displayScore);
                } else {
                    console.error('❌ health-score-value element not found!');
                }
            }

            // --- Render Visuals ---
            let scoreColor = 'var(--health-score-bad)';
            let scoreLabel = 'Poor';
            if (displayScore >= 70) {
                scoreColor = 'var(--health-score-good)';
                scoreLabel = 'Good';
            } else if (displayScore >= 40) {
                scoreColor = 'var(--health-score-ok)';
                scoreLabel = 'Okay';
            }
            
            // Set the health score LABEL
            if (DOMElements.healthScoreLabel) {
                DOMElements.healthScoreLabel.textContent = scoreLabel;
                console.log('✅ Set health score LABEL to:', scoreLabel);
            } else {
                // Fallback - try direct element access
                const healthScoreLabelElement = document.getElementById('health-score-label');
                if (healthScoreLabelElement) {
                    healthScoreLabelElement.textContent = scoreLabel;
                    console.log('✅ Set health score LABEL via fallback to:', scoreLabel);
                } else {
                    console.error('❌ health-score-label element not found!');
                }
            }
            
            // Update the visual SVG if it exists
            if (DOMElements.healthScoreVisual) {
                DOMElements.healthScoreVisual.innerHTML = `
                    <svg class="w-full h-full" viewBox="0 0 36 36">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                              fill="none" stroke="${DOMElements.html.classList.contains('dark') ? '#374151' : '#E5E7EB'}"
                              stroke-width="2.5"/>
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                              fill="none" stroke="${scoreColor}"
                              stroke-width="2.5"
                              stroke-dasharray="${displayScore}, 100"
                              stroke-linecap="round"/>
                        <text x="18" y="18" text-anchor="middle" dy="0.3em" class="fill-current text-sm font-semibold">${displayScore}</text>
                    </svg>
                `;
            }

            // --- Render Trend ---
            let trendHtml = '';
            if (scoreData.lastMonthScore !== undefined) {
                const trend = displayScore - Math.round(scoreData.lastMonthScore);
                if (trend > 0) {
                    trendHtml = `<span class="text-green-600 dark:text-green-400">
                        ↗ +${trend} from ${Math.round(scoreData.lastMonthScore)}
                    </span>`;
                } else if (trend < 0) {
                    trendHtml = `<span class="text-red-600 dark:text-red-400">
                        ↘ ${trend} from ${Math.round(scoreData.lastMonthScore)}
                    </span>`;
                } else {
                    trendHtml = `<span>- Same as last month</span>`;
                }
            }
            if (DOMElements.healthScoreTrend) {
                DOMElements.healthScoreTrend.innerHTML = trendHtml;
            }
            
            // --- Render Tooltip ---
            const renderProgressBar = (value, max) => {
                const percentage = (value / max) * 100;
                return `
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
            };

            if (DOMElements.healthScoreTooltip) {
                DOMElements.healthScoreTooltip.innerHTML = `
                    <div class="font-bold text-base mb-2 text-center">Your Score: ${displayScore}/100</div>
                    <div class="space-y-3">
                    <div>
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="font-semibold">Budget Usage</span>
                                <span class="text-xs font-medium">${breakdown.budgetUsage.score}/${breakdown.budgetUsage.max} pts</span>
                        </div>
                            ${renderProgressBar(breakdown.budgetUsage.score, breakdown.budgetUsage.max)}
                    </div>
                    <div>
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="font-semibold">Spending Habits</span>
                                <span class="text-xs font-medium">${breakdown.spendingHabits.score}/${breakdown.spendingHabits.max} pts</span>
                    </div>
                            ${renderProgressBar(breakdown.spendingHabits.score, breakdown.spendingHabits.max)}
                        </div>
                                <div>
                          <div class="flex justify-between items-baseline mb-1">
                                <span class="font-semibold">Savings Rate</span>
                                <span class="text-xs font-medium">${breakdown.savingsRate.score}/${breakdown.savingsRate.max} pts</span>
                                </div>
                            ${renderProgressBar(breakdown.savingsRate.score, breakdown.savingsRate.max)}
                        </div>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-600 my-3"></div>
                            <div>
                        <h4 class="font-semibold text-green-600 dark:text-green-400">Strengths</h4>
                        <ul class="list-disc list-inside text-xs">${insights.strengths.map(s => `<li>${s}</li>`).join('')}</ul>
                            </div>
                    <div class="mt-2">
                        <h4 class="font-semibold text-yellow-600 dark:text-yellow-400">Areas to Improve</h4>
                        <ul class="list-disc list-inside text-xs">${insights.improvements.map(i => `<li>${i}</li>`).join('')}</ul>
                        </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 text-center">
                        <span class="font-semibold">💡 Tip:</span>
                        <span class="text-xs italic">${insights.tip}</span>
                </div>
            `;
            }
        }

        function updateBudgetHealthScore(totalSpent, budget, monthlyExpenses, totalMonthlyIncome, now) {
            console.log('🔍 updateBudgetHealthScore called with:', {
                totalSpent, budget, monthlyExpenses: monthlyExpenses?.length, totalMonthlyIncome
            });
            
            // CRITICAL FIX: Validate all input parameters to prevent monetary values leaking in
            const validTotalSpent = (typeof totalSpent === 'number' && !isNaN(totalSpent) && totalSpent >= 0) ? totalSpent : 0;
            const validBudget = (typeof budget === 'number' && !isNaN(budget) && budget >= 0) ? budget : 0;
            const validTotalIncome = (typeof totalMonthlyIncome === 'number' && !isNaN(totalMonthlyIncome) && totalMonthlyIncome >= 0) ? totalMonthlyIncome : 0;
            const validExpenses = Array.isArray(monthlyExpenses) ? monthlyExpenses : [];
            
            console.log('🔍 Validated inputs:', { validTotalSpent, validBudget, validTotalIncome, expenseCount: validExpenses.length });
            
            const breakdown = {
                budgetUsage: calculateBudgetUsageScore(validTotalSpent, validBudget, now),
                spendingHabits: calculateSpendingHabitsScore(validExpenses, validTotalSpent),
                savingsRate: calculateSavingsRateScore(validTotalSpent, validTotalIncome, now)
            };
            
            console.log('🔍 Score breakdown:', breakdown);
            
            // Ensure all score components are valid numbers
            const budgetScore = (breakdown.budgetUsage && typeof breakdown.budgetUsage.score === 'number' && !isNaN(breakdown.budgetUsage.score)) ? Math.max(0, Math.min(50, breakdown.budgetUsage.score)) : 0;
            const habitsScore = (breakdown.spendingHabits && typeof breakdown.spendingHabits.score === 'number' && !isNaN(breakdown.spendingHabits.score)) ? Math.max(0, Math.min(30, breakdown.spendingHabits.score)) : 0;
            const savingsScore = (breakdown.savingsRate && typeof breakdown.savingsRate.score === 'number' && !isNaN(breakdown.savingsRate.score)) ? Math.max(0, Math.min(20, breakdown.savingsRate.score)) : 0;
            
            console.log('🔍 Validated individual scores:', { budgetScore, habitsScore, savingsScore });
            
            // Calculate total score with strict validation
            let totalScore = budgetScore + habitsScore + savingsScore;
            
            console.log('🔍 Raw calculated totalScore:', totalScore);
            
            // CRITICAL: Ensure totalScore is always a valid integer between 0 and 100
            if (typeof totalScore !== 'number' || isNaN(totalScore) || totalScore < 0) {
                console.warn('❌ Invalid totalScore detected:', totalScore, 'Setting to 0');
                totalScore = 0;
            } else if (totalScore > 100) {
                console.warn('❌ TotalScore over 100:', totalScore, 'This should not happen with proper component validation');
                totalScore = 100;
            }
            
            // Force to integer to prevent any decimal contamination
            totalScore = Math.round(totalScore);
            
            console.log('🔍 Final validated totalScore:', totalScore);
            
            // Clear any potentially contaminated health score history
            if (healthScoreHistory && typeof healthScoreHistory === 'object') {
                Object.keys(healthScoreHistory).forEach(key => {
                    const storedScore = healthScoreHistory[key];
                    if (typeof storedScore !== 'number' || isNaN(storedScore) || storedScore < 0 || storedScore > 100) {
                        console.warn('❌ Removing contaminated health score:', key, storedScore);
                        delete healthScoreHistory[key];
                    }
                });
            }
            
            const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            healthScoreHistory[currentMonthKey] = totalScore;
            saveData();
            
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthKey = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
            
            // Validate last month score
            let lastMonthScore = healthScoreHistory[lastMonthKey];
            if (typeof lastMonthScore !== 'number' || isNaN(lastMonthScore) || lastMonthScore < 0 || lastMonthScore > 100) {
                lastMonthScore = undefined;
            }
            
            const scoreData = {
                totalScore,
                breakdown,
                lastMonthScore,
                insights: generateHealthScoreInsights({ breakdown }, validTotalSpent, validExpenses, validTotalIncome)
            };

            renderBudgetHealthScore(scoreData);
        }

        function predictMonthEndSpending(totalSpent, now) {
            if (totalSpent <= 0) {
                return { projectedSpend: 0, statusText: '', statusColor: '' };
            }
            const dayOfMonth = now.getDate();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const avgDailySpend = totalSpent / dayOfMonth;
            const projectedSpend = avgDailySpend * daysInMonth;

            const budgetUsage = projectedSpend / monthlyBudget;
            let statusText = 'On Track';
            let statusColor = 'text-green-700 dark:text-green-400';

            if (budgetUsage > 1.1) {
                statusText = 'Exceeding Budget';
                statusColor = 'text-red-700 dark:text-red-400';
            } else if (budgetUsage > 0.95) {
                statusText = 'At Risk';
                statusColor = 'text-yellow-600 dark:text-yellow-400';
            }
            return { projectedSpend, statusText, statusColor };
        }
        
        function getExpensesForMonth(year, month) {
            return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate.getFullYear() === year && expenseDate.getMonth() === month;
            });
        }

        function renderRecentExpenses() {
            console.log('🔍 renderRecentExpenses called');
            console.log('📊 Total expenses:', expenses.length);
            console.log('🛍️ Sample expenses:', expenses.slice(0, 3));
            
            // Ensure container exists
            if (!DOMElements.recentExpensesContainer) {
                console.error('❌ recentExpensesContainer not found');
                return;
            }
            
            DOMElements.recentExpensesContainer.innerHTML = '';
            
            // Get all expenses, ensure we have valid date parsing and sorting
            const allExpenses = [...expenses];
            console.log('📦 Working with', allExpenses.length, 'expenses');
            
            // Sort by date (newest first), then by ID (highest first) as fallback
            const recent = allExpenses
                .sort((a, b) => {
                    // Primary sort: by date (newest first)
                    const dateA = new Date(a.date + 'T00:00:00');
                    const dateB = new Date(b.date + 'T00:00:00');
                    const dateComparison = dateB - dateA;
                    
                    if (dateComparison !== 0) {
                        return dateComparison;
                    }
                    
                    // Secondary sort: by ID (highest first, for expenses added on same day)
                    const getNumericId = (id) => {
                        if (typeof id === 'string') {
                            const match = id.match(/\d+/);
                            return match ? parseInt(match[0]) : 0;
                        }
                        return parseInt(id) || 0;
                    };
                    
                    return getNumericId(b.id) - getNumericId(a.id);
                })
                .slice(0, 5);

            console.log('🎯 Recent expenses to show:', recent.length);
            console.log('📝 Recent expenses:', recent);

            if (recent.length === 0) {
                DOMElements.recentExpensesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">No recent expenses.</p>';
                console.log('❌ No recent expenses found');
                return;
            }
            
            recent.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center border-b border-gray-200 py-3 last:border-b-0';
                
                // Format date for better display
                const formattedDate = new Date(expense.date).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                div.innerHTML = `
                    <div>
                        <p class="font-medium text-sm">${escapeHTML(expense.name)}</p>
                        <p class="text-xs text-gray-500">${formattedDate} - ${escapeHTML(expense.category)}</p>
                    </div>
                    <p class="font-medium text-sm text-red-600">-${formatCurrency(expense.cost)}</p>
                `;
                DOMElements.recentExpensesContainer.appendChild(div);
            });
            
            console.log('✅ renderRecentExpenses completed successfully');
        }

        function renderExpensesTable() {
            console.log('=== PAGINATION DEBUG START ===');
            console.log('Current page:', window.expensesCurrentPage || 1);
            console.log('Items per page:', window.expensesItemsPerPage || 15);
            
            let allExpenses = [...expenses];
            console.log('Total expenses:', allExpenses.length);

            // Apply filters
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            const filteredExpenses = allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                if (typeFilter && e.type !== typeFilter && !(typeFilter === 'Recurring' && e.recurringSourceId)) passes = false;
                return passes;
            });

            console.log('Filtered expenses:', filteredExpenses.length);

            // Sort filtered expenses
            filteredExpenses.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                const getNumericId = (id) => {
                    if (typeof id === 'string') {
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return id;
                };
                
                return getNumericId(b.id) - getNumericId(a.id);
            });

            const tableBody = DOMElements.expensesTableBody;
            if (filteredExpenses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500 dark:text-gray-400">No expenses match your filters.</td></tr>`;
                document.getElementById('expenses-pagination').style.display = 'none';
                console.log('=== PAGINATION DEBUG END (no data) ===');
                return;
            }

            // SIMPLE PAGINATION - NO COMPLEX LOGIC
            const currentPage = window.expensesCurrentPage || 1;
            const itemsPerPage = window.expensesItemsPerPage || 25;
            const totalItems = filteredExpenses.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageItems = filteredExpenses.slice(startIndex, endIndex);

            console.log('PAGINATION CALCULATION:');
            console.log('- Total items:', totalItems);
            console.log('- Current page:', currentPage);
            console.log('- Items per page:', itemsPerPage);
            console.log('- Total pages:', totalPages);
            console.log('- Start index:', startIndex);
            console.log('- End index:', endIndex);
            console.log('- Page items count:', pageItems.length);

            // Update pagination display
            const pagination = document.getElementById('expenses-pagination');
            if (pagination) {
                pagination.style.display = 'flex';
                
                const pageInfo = document.getElementById('expenses-page-info');
                if (pageInfo) {
                    pageInfo.textContent = `${startIndex + 1}-${endIndex} of ${totalItems}`;
                }
                
                const pageInput = document.getElementById('expenses-page-input');
                if (pageInput) {
                    pageInput.value = currentPage;
                    pageInput.max = totalPages;
                }
                
                const totalPagesSpan = document.getElementById('expenses-total-pages');
                if (totalPagesSpan) {
                    totalPagesSpan.textContent = `of ${totalPages}`;
                }
                
                // Update buttons
                const prevBtn = document.getElementById('expenses-prev-btn');
                const nextBtn = document.getElementById('expenses-next-btn');
                const firstBtn = document.getElementById('expenses-first-btn');
                const lastBtn = document.getElementById('expenses-last-btn');
                
                if (prevBtn) prevBtn.disabled = currentPage <= 1;
                if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
                if (firstBtn) firstBtn.disabled = currentPage <= 1;
                if (lastBtn) lastBtn.disabled = currentPage >= totalPages;
            }

            tableBody.innerHTML = pageItems.map(expense => {
                const isRecurringInstance = !!expense.recurringSourceId;
                const isCancelled = expense.status === 'cancelled';
                const originalRecurringItem = isRecurringInstance ? recurringItems.find(r => r.id === expense.recurringSourceId) : null;

                let editAction = `editExpense(${expense.id})`;
                if (isRecurringInstance && originalRecurringItem) {
                    editAction = `editRecurring(${originalRecurringItem.id})`;
                }
                
                const deleteAction = isRecurringInstance ? 'return false;' : `deleteExpense(${expense.id})`;
                const checkboxId = `expense-${expense.id}`;

                // Better status text for mobile
                let statusText = 'Active';
                if (isCancelled) {
                    statusText = 'Cancelled';
                } else if (isRecurringInstance) {
                    statusText = 'Recurring';
                }

                // Format date for better display
                const formattedDate = new Date(expense.date).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                return `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 ${isCancelled ? 'opacity-60' : ''}">
                        <td class="px-4 py-3" data-label="">
                            <input type="checkbox" id="${checkboxId}" data-id="${expense.id}" onchange="toggleExpenseSelection(this, '${expense.id}')" 
                            class="table-checkbox expense-checkbox" ${isRecurringInstance ? 'disabled' : ''} ${selectedExpenseIds.has(expense.id.toString()) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap" data-label="Name">
                            <span>${escapeHTML(expense.name)}</span>${isRecurringInstance ? '<span class="text-xs text-gray-400 ml-1">(R)</span>' : ''}
                        </td>
                        <td class="px-6 py-3" data-label="Amount">${formatCurrency(expense.cost)}</td>
                        <td class="px-6 py-3" data-label="Date">${formattedDate}</td>
                        <td class="px-6 py-3 hidden md:table-cell" data-label="Category">${escapeHTML(expense.category)}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Payment Method">${escapeHTML(expense.paymentMethod) || '-'}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Type">${escapeHTML(expense.type)}</td>
                        <td class="px-6 py-3 text-right" data-label="Actions">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="${editAction}" title="Edit" class="icon-button" ${isCancelled ? 'disabled' : ''} ${isCancelled ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="${deleteAction}" title="Delete" class="icon-button text-red-600/80 hover:text-red-500" ${isRecurringInstance ? 'disabled' : ''} ${isRecurringInstance ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
        </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('Table rendered with', pageItems.length, 'items');
            console.log('=== PAGINATION DEBUG END ===');
        }

        window.renderRecurringTable = function renderRecurringTable() {
            DOMElements.recurringTableBody.innerHTML = '';
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;

            let filtered = recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });

            // Sort chronologically by start date (latest first)
            filtered.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            if (filtered.length === 0) {
                DOMElements.recurringTableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                updateRecurringPagination(0, 0);
                return;
            }

            // Calculate pagination
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / window.recurringItemsPerPage);
            const startIndex = (window.recurringCurrentPage - 1) * window.recurringItemsPerPage;
            const endIndex = startIndex + window.recurringItemsPerPage;
            const pageItems = filtered.slice(startIndex, endIndex);

            // Update pagination controls
            updateRecurringPagination(totalItems, totalPages);

            // Clear table first
            DOMElements.recurringTableBody.innerHTML = '';

            pageItems.forEach(item => {
                const tr = document.createElement('tr');
                const isSelected = selectedRecurringIds.has(item.id);
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${item.status === 'cancelled' ? 'opacity-60' : ''} ${isSelected ? 'bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800'}`;
                const itemTypeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

                // Format start date for better display
                const formattedStartDate = new Date(item.startDate).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                tr.innerHTML = `
                    <td class="px-4 py-4 w-1" data-label=""><input type="checkbox" data-id="${item.id}" onchange="toggleRecurringSelection(this, ${item.id})" class="table-checkbox recurring-checkbox" ${isSelected ? 'checked' : ''}></td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white" data-label="Name">${escapeHTML(item.name)}</td>
                    <td class="px-6 py-4 capitalize" data-label="Type">${item.type}</td>
                    <td class="px-6 py-4 font-medium ${itemTypeClass}" data-label="Amount">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4" data-label="Frequency">${item.frequency}</td>
                    <td class="px-6 py-4" data-label="Start Date">${formattedStartDate}</td>
                    <td class="px-6 py-4 hidden lg:table-cell" data-label="Category">${escapeHTML(item.category)}</td>
                    <td class="px-6 py-4" data-label="Status"><span class="status-badge ${item.status === 'active' ? 'status-active' : 'status-cancelled'}">${item.status}</span></td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap" data-label="Actions">
                        <button onclick="editRecurring(${item.id})" class="icon-button" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        <button onclick="toggleRecurringStatus(${item.id})" class="icon-button" title="${item.status === 'active' ? 'Pause' : 'Resume'}">
                           ${item.status === 'active' ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                           }
                        </button>
                        <button onclick="deleteRecurring(${item.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </td>
                `;
                DOMElements.recurringTableBody.appendChild(tr);
            });
        }

        // --- Pagination Functions ---
        function updateExpensesPagination(totalItems, totalPages) {
            const pageInfo = document.getElementById('expenses-page-info');
            const prevBtn = document.getElementById('expenses-prev-btn');
            const nextBtn = document.getElementById('expenses-next-btn');
            const firstBtn = document.getElementById('expenses-first-btn');
            const lastBtn = document.getElementById('expenses-last-btn');
            const pageInput = document.getElementById('expenses-page-input');
            const totalPagesSpan = document.getElementById('expenses-total-pages');
            const pagination = document.getElementById('expenses-pagination');

            console.log('updateExpensesPagination called:', { totalItems, totalPages, currentPage: expensesCurrentPage });

            if (totalItems === 0) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            
            const startItem = (window.expensesCurrentPage - 1) * window.expensesItemsPerPage + 1;
            const endItem = Math.min(window.expensesCurrentPage * window.expensesItemsPerPage, totalItems);
            
            pageInfo.textContent = `${startItem}-${endItem} of ${totalItems}`;
            
            // Update page input and total pages
            pageInput.value = window.expensesCurrentPage;
            pageInput.max = totalPages;
            totalPagesSpan.textContent = `of ${totalPages}`;
            
            // Update button states
            prevBtn.disabled = window.expensesCurrentPage <= 1;
            nextBtn.disabled = window.expensesCurrentPage >= totalPages;
            firstBtn.disabled = window.expensesCurrentPage <= 1;
            lastBtn.disabled = window.expensesCurrentPage >= totalPages;
            
            console.log('Pagination UI updated:', { startItem, endItem, totalItems });
        }

        function updateRecurringPagination(totalItems, totalPages) {
            const pageInfo = document.getElementById('recurring-page-info');
            const prevBtn = document.getElementById('recurring-prev-btn');
            const nextBtn = document.getElementById('recurring-next-btn');
            const firstBtn = document.getElementById('recurring-first-btn');
            const lastBtn = document.getElementById('recurring-last-btn');
            const pageInput = document.getElementById('recurring-page-input');
            const totalPagesSpan = document.getElementById('recurring-total-pages');
            const pagination = document.getElementById('recurring-pagination');

            if (totalItems === 0) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            
            const startItem = (window.recurringCurrentPage - 1) * window.recurringItemsPerPage + 1;
            const endItem = Math.min(window.recurringCurrentPage * window.recurringItemsPerPage, totalItems);
            
            pageInfo.textContent = `${startItem}-${endItem} of ${totalItems}`;
            
            // Update page input and total pages
            pageInput.value = window.recurringCurrentPage;
            pageInput.max = totalPages;
            totalPagesSpan.textContent = `of ${totalPages}`;
            
            // Update button states
            prevBtn.disabled = window.recurringCurrentPage <= 1;
            nextBtn.disabled = window.recurringCurrentPage >= totalPages;
            firstBtn.disabled = window.recurringCurrentPage <= 1;
            lastBtn.disabled = window.recurringCurrentPage >= totalPages;
        }

        // SIMPLE PAGINATION FUNCTIONS
        window.changeExpensesPage = function(direction) {
            console.log('changeExpensesPage called with:', direction);
            if (direction === 'prev' && (window.expensesCurrentPage || 1) > 1) {
                window.expensesCurrentPage = (window.expensesCurrentPage || 1) - 1;
            } else if (direction === 'next') {
                window.expensesCurrentPage = (window.expensesCurrentPage || 1) + 1;
            }
            console.log('New page:', window.expensesCurrentPage);
            renderExpensesTable();
        }

        window.changeRecurringPage = function(direction) {
            if (direction === 'prev' && window.recurringCurrentPage > 1) {
                window.recurringCurrentPage--;
            } else if (direction === 'next') {
                window.recurringCurrentPage++;
            }
            renderRecurringTable();
        }

        window.changeExpensesPerPage = function(value) {
            console.log('changeExpensesPerPage called with:', value);
            window.expensesItemsPerPage = parseInt(value) || 15;
            window.expensesCurrentPage = 1;
            console.log('Items per page set to:', window.expensesItemsPerPage);
            renderExpensesTable();
        }

        window.changeRecurringPerPage = function(value) {
            window.recurringItemsPerPage = parseInt(value);
            window.recurringCurrentPage = 1; // Reset to first page
            renderRecurringTable();
        }

        window.goToExpensesPage = function(target) {
            console.log('goToExpensesPage called with:', target);
            
            // Simple approach - don't overcomplicate
            if (target === 'first') {
                window.expensesCurrentPage = 1;
            } else if (target === 'last') {
                // Calculate total pages on the fly
                const totalItems = expenses.length; // Use simple total for now
                const totalPages = Math.ceil(totalItems / (window.expensesItemsPerPage || 15));
                window.expensesCurrentPage = totalPages;
            } else {
                const page = parseInt(target);
                if (page >= 1) {
                    window.expensesCurrentPage = page;
                }
            }
            console.log('Going to page:', window.expensesCurrentPage);
            renderExpensesTable();
        }

        window.goToRecurringPage = function(target) {
            const filteredRecurring = getFilteredRecurring(); // We need this to calculate total pages
            const totalPages = Math.ceil(filteredRecurring.length / window.recurringItemsPerPage);
            
            if (target === 'first') {
                window.recurringCurrentPage = 1;
            } else if (target === 'last') {
                window.recurringCurrentPage = totalPages;
            } else {
                const page = parseInt(target);
                if (page >= 1 && page <= totalPages) {
                    window.recurringCurrentPage = page;
                }
            }
            renderRecurringTable();
        }

        // Helper functions to get filtered data (extracted from render functions)
        function getFilteredExpenses() {
            let allExpenses = [...expenses];

            // Apply filters
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            return allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                
                // Fixed typeFilter logic
                if (typeFilter) {
                    if (typeFilter === 'Recurring') {
                        if (!e.recurringSourceId) passes = false;
                    } else {
                        if (e.type !== typeFilter) passes = false;
                    }
                }
                
                return passes;
            });
        }

        function getFilteredRecurring() {
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;

            return recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });
        }
        
        // --- Charting and Insights ---
        function updateChartsAndInsights() {
            renderSpendingTrendChart();
            renderCategorySpendingChart();
            renderMonthlySavingsChart();
            updateAiInsightsWithSmartAnalytics(); // NEW
            initInsightsDashboard(); // Initialize new insights dashboard
        }

        const chartColors = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#06b6d4', '#d946ef', '#84cc16'];
        /**
         * Generate array of chart colors for multiple data series
         * @param {number} count - Number of colors needed
         * @returns {string[]} Array of color strings cycling through predefined colors
         */
        function getChartColors(count) {
            return Array.from({length: count}, (_, i) => chartColors[i % chartColors.length]);
        }

        /**
         * Generate Chart.js options with theme-aware styling
         * @param {boolean} isDarkMode - Whether dark mode is active
         * @returns {Object} Chart.js configuration options
         */
        function getChartOptions(isDarkMode) {
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.02)';
            const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { color: gridColor }, ticks: { color: textColor } },
                    y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, callback: value => formatCurrency(value, false) } }
                },
                plugins: {
                    legend: { labels: { color: textColor } },
                    tooltip: { 
                        titleFont: { weight: 'bold' }, 
                        bodyFont: {}, 
                        backgroundColor: isDarkMode ? '#334155' : '#ffffff', 
                        titleColor: isDarkMode ? '#f1f5f9' : '#1e293b', 
                        bodyColor: isDarkMode ? '#f1f5f9' : '#1e293b', 
                        borderColor: isDarkMode ? '#475569' : '#e2e8f0', 
                        borderWidth: 1 
                    }
                }
            };
        }

        /**
         * Render spending trend chart showing monthly spending over time
         * Creates a line chart with 12 months of spending data
         */
        function renderSpendingTrendChart() {
            const ctx = DOMElements.spendingTrendCanvas?.getContext('2d');
            if (!ctx) return;
            
            // Get 12 months of spending data
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const data = monthlyData.map(m => m.expenses);

            // Destroy existing chart to prevent memory leaks
            if (spendingTrendChart) spendingTrendChart.destroy();
            
            // Configure chart with theme-aware styling
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            // Create new Chart.js instance
            spendingTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: chartColors[2],
                        backgroundColor: chartColors[2] + '33',
                        tension: 0.2, fill: true, pointRadius: 3, pointHoverRadius: 5
                    }]
                },
                options: options
            });
        }

        /**
         * Render category spending chart showing expense breakdown by category
         * Creates a doughnut chart for visual spending distribution
         */
        function renderCategorySpendingChart() {
            const ctx = DOMElements.categorySpendingCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const data = monthlyData.map(m => m.expenses);
            
            if (categorySpendingChart) categorySpendingChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            categorySpendingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(d => d >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'),
                        borderColor: data.map(d => d >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }

        function renderMonthlySavingsChart() {
            const ctx = DOMElements.monthlySavingsCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const savingsData = monthlyData.map(m => m.income - m.expenses);

            if (monthlySavingsChart) monthlySavingsChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Savings: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            monthlySavingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: savingsData,
                        backgroundColor: savingsData.map(s => s >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'),
                        borderColor: savingsData.map(s => s >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }
        
        function getMonthlyIncomeAndExpenses(numMonths) {
            const data = [];
            for (let i = 0; i < numMonths; i++) {
                const date = new Date(new Date().setMonth(new Date().getMonth() - i));
                const year = date.getFullYear();
                const month = date.getMonth();
                
                // Get recurring income only (expenses are already in main array)
                const recurringIncome = getMonthlyRecurringTotals(year, month).income;
                
                data.push({
                    year: year,
                    month: month,
                    income: monthlyIncome + recurringIncome,
                    expenses: getMonthlyExpenseTotal(year, month)
                });
            }
            return data.reverse();
        }


        function getNextDueDate(item, fromDate) {
            let nextDueDate = new Date(item.startDate + 'T00:00:00');
            
            if (nextDueDate >= fromDate) {
                return nextDueDate;
            }

            let iterations = 0;
            while (nextDueDate < fromDate && iterations < 1000) {
                switch (item.frequency) {
                    case 'Daily': nextDueDate.setDate(nextDueDate.getDate() + 1); break;
                    case 'Weekly': nextDueDate.setDate(nextDueDate.getDate() + 7); break;
                    case 'Bi-Weekly': nextDueDate.setDate(nextDueDate.getDate() + 14); break;
                    case 'Monthly': nextDueDate.setMonth(nextDueDate.getMonth() + 1); break;
                    case 'Quarterly': nextDueDate.setMonth(nextDueDate.getMonth() + 3); break;
                    case 'Annual': nextDueDate.setFullYear(nextDueDate.getFullYear() + 1); break;
                    default: return new Date('9999-12-31');
                }
                iterations++;
            }
            return nextDueDate;
        }

        function getUpcomingEvents(daysAhead = 30) {
            const today = new Date();
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + daysAhead);
            
            const upcomingEvents = [];
            
            recurringItems.forEach(item => {
                if (item.status !== 'active') return;
                
                // Check if item has ended
                if (item.endDate) {
                    const itemEndDate = new Date(item.endDate + 'T00:00:00');
                    if (itemEndDate < today) return;
                }
                
                const nextDue = getNextDueDate(item, today);
                
                if (nextDue && nextDue <= endDate) {
                    const daysUntilDue = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));
                    
                    upcomingEvents.push({
                        id: item.id,
                        name: item.name,
                        amount: item.amount,
                        type: item.type,
                        category: item.category,
                        frequency: item.frequency,
                        dueDate: nextDue,
                        daysUntilDue: daysUntilDue,
                        isOverdue: daysUntilDue < 0,
                        isDueToday: daysUntilDue === 0,
                        isDueSoon: daysUntilDue <= 7 && daysUntilDue > 0
                    });
                }
            });
            
            // Sort by due date (soonest first)
            upcomingEvents.sort((a, b) => a.dueDate - b.dueDate);
            
            return upcomingEvents;
        }

        function updateUpcomingEvents() {
            const upcomingEvents = getUpcomingEvents(30);
            const container = document.getElementById('upcoming-events');
            
            if (!container) return;
            
            if (upcomingEvents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">No upcoming bills.</p>';
                return;
            }
            
            // Show only the next 3 events for compact layout
            const eventsToShow = upcomingEvents.slice(0, 3);
            
            container.innerHTML = eventsToShow.map(event => {
                const dateStr = event.dueDate.toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'short'
                });
                
                let statusClass = 'text-gray-600 dark:text-gray-400';
                let statusText = `${event.daysUntilDue}d`;
                
                if (event.isOverdue) {
                    statusClass = 'text-red-600 dark:text-red-400';
                    statusText = 'Overdue';
                } else if (event.isDueToday) {
                    statusClass = 'text-orange-600 dark:text-orange-400';
                    statusText = 'Today';
                } else if (event.isDueSoon) {
                    statusClass = 'text-yellow-600 dark:text-yellow-400';
                    statusText = `${event.daysUntilDue}d`;
                }
                
                const typeIcon = event.type === 'income' ? '💰' : '💳';
                
                return `
                    <div class="flex items-center justify-between py-3 border-b border-gray-200 last:border-b-0">
                        <div class="flex items-center gap-3">
                            <div class="text-lg">${typeIcon}</div>
                            <div class="min-w-0 flex-1">
                                <div class="font-medium text-sm">${event.name}</div>
                                <div class="text-xs text-gray-500">${dateStr}</div>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <div class="font-medium text-sm ${event.type === 'income' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(event.amount)}</div>
                            <div class="text-xs ${statusClass}">${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        
        // --- Utility Functions ---
        function formatCurrency(amount, useDecimals = true) {
            // Handle NaN, undefined, null, and invalid values
            if (typeof amount !== 'number' || isNaN(amount) || !isFinite(amount)) {
                amount = 0;
            }
            
            const { locale } = currencyConfig[currentCurrencyCode];
            const isInteger = !useDecimals || (amount % 1 === 0);
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: isInteger ? 0 : 2,
                maximumFractionDigits: isInteger ? 0 : 2
            };
            return new Intl.NumberFormat(locale, options).format(amount);
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function showToast(message, type = 'success') {
            DOMElements.toast.textContent = message;
            DOMElements.toast.className = `toast show ${type === 'error' ? 'bg-red-600' : 'bg-gray-800 dark:bg-gray-200 dark:text-gray-800'}`;
            setTimeout(() => { DOMElements.toast.className = 'toast'; }, 3000);
        }

        // Plaid Integration Functions
        const BACKEND_URL = 'http://localhost:8000';  // Changed from 127.0.0.1 to localhost
        let plaidAccessToken = localStorage.getItem('plaid_access_token');

        // Also add this test function to verify connectivity
        async function testBackendConnection() {
            try {
                console.log('Testing backend connection...');
                const response = await fetch(`${BACKEND_URL}/health`);
                console.log('Health check response:', response.status, response.statusText);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Backend health:', data);
                    showToast('Backend connection successful!', 'success');
                } else {
                    throw new Error(`Health check failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Backend connection test failed:', error);
                showToast(`Backend connection failed: ${error.message}`, 'error');
            }
        }

        // Call this function in console to test: testBackendConnection()

        async function connectBankAccount() {
            try {
                const connectBtn = document.getElementById('connect-bank-btn');
                connectBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Connecting...</span>';
                
                // Get link token from backend
                const linkTokenResponse = await authManager.authenticatedFetch(`${BACKEND_URL}/api/create_link_token`, {
                    method: 'POST'
                });
                
                if (!linkTokenResponse.ok) {
                    throw new Error('Failed to create link token');
                }
                
                const { link_token } = await linkTokenResponse.json();
                
                // Initialize Plaid Link
                const handler = Plaid.create({
                    token: link_token,
                    onSuccess: async (public_token, metadata) => {
                        try {
                            await exchangePublicToken(public_token);
                            showToast('Bank account connected successfully!');
                            connectBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Connected ✓</span>';
                            document.getElementById('import-transactions-btn').style.display = 'flex';
                        } catch (error) {
                            console.error('Error exchanging token:', error);
                            showToast('Failed to connect bank account', 'error');
                            resetConnectButton();
                        }
                    },
                    onLoad: () => {
                        // Handle loading
                    },
                    onExit: (err, metadata) => {
                        if (err != null) {
                            console.error('Plaid Link error:', err);
                            showToast('Bank connection cancelled', 'error');
                        }
                        resetConnectButton();
                    },
                    onEvent: (eventName, metadata) => {
                        // Handle events
                    }
                });
                
                handler.open();
                
            } catch (error) {
                console.error('Error connecting bank account:', error);
                showToast('Failed to connect bank account', 'error');
                resetConnectButton();
            }
        }

        async function exchangePublicToken(publicToken) {
            const response = await authManager.authenticatedFetch(`${BACKEND_URL}/api/exchange_public_token`, {
                method: 'POST',
                body: JSON.stringify({ public_token: publicToken })
            });
            
            if (!response.ok) {
                throw new Error('Failed to exchange public token');
            }
            
            const { access_token } = await response.json();
            plaidAccessToken = access_token;
            localStorage.setItem('plaid_access_token', access_token);
            
            // Import transactions immediately after connecting
            await importBankTransactions();
        }

        async function importBankTransactions() {
            if (!plaidAccessToken) {
                showToast('No bank account connected', 'error');
                return;
            }
            
            try {
                console.log('Starting transaction import with token:', plaidAccessToken);
                console.log('Backend URL:', BACKEND_URL);
                
                // Add timeout and better error handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await authManager.authenticatedFetch(`${BACKEND_URL}/api/transactions`, {
                    method: 'POST',
                    body: JSON.stringify({ access_token: plaidAccessToken }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('Backend response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const responseData = await response.json();
                console.log('Backend response data:', responseData);
                
                const { transactions } = responseData;
                console.log('Transactions received:', transactions?.length, transactions);
                
                if (!transactions || !Array.isArray(transactions)) {
                    throw new Error('Invalid transactions data received');
                }
                
                const importedCount = processPlaidTransactions(transactions);
                console.log('Imported count:', importedCount);
                
                if (importedCount > 0) {
                    showToast(`Imported ${importedCount} new transactions from your bank`);
                    updateDisplay();
                    
                    // Close settings modal and navigate to expenses page
                    document.getElementById('settings-modal').classList.add('hidden');
                    showTab('expenses');
                } else {
                    showToast('No new transactions to import');
                    
                    // Still close settings and go to expenses even if no new transactions
                    document.getElementById('settings-modal').classList.add('hidden');
                    showTab('expenses');
                }
                
            } catch (error) {
                console.error('Error importing transactions:', error);
                
                if (error.name === 'AbortError') {
                    showToast('Request timeout - please try again', 'error');
                } else if (error instanceof TypeError && error.message.includes('fetch')) {
                    showToast('Network error - check if backend is running', 'error');
                } else {
                    showToast(`Failed to import transactions: ${error.message}`, 'error');
                }
            }
        }

        function processPlaidTransactions(plaidTransactions) {
            console.log('Processing Plaid transactions:', plaidTransactions);
            let importedCount = 0;
            const existingTransactionIds = new Set(expenses.map(e => e.plaidId).filter(id => id));
            console.log('Existing transaction IDs:', existingTransactionIds);
            
            for (const transaction of plaidTransactions) {
                console.log('Processing transaction:', transaction);
                
                // Skip if we already have this transaction
                if (existingTransactionIds.has(transaction.transaction_id)) {
                    console.log('Skipping duplicate transaction:', transaction.transaction_id);
                    continue;
                }
                
                const transformedExpense = transformPlaidTransaction(transaction);
                console.log('Transformed expense:', transformedExpense);
                
                expenses.push(transformedExpense);
                importedCount++;
            }
            
            console.log('Total expenses after import:', expenses.length);
            console.log('Imported count:', importedCount);
            
            if (importedCount > 0) {
                saveData();
                generateEnhancedPointsOptimization(expenses); // Replace existing call
                updateGoalImpactDisplay(); // Add this new call
            }
            
            return importedCount;
        }

        function transformPlaidTransaction(transaction) {
            // Map Plaid categories to app categories
            const categoryMap = {
                'Food and Drink': 'Food/Drink',
                'Shops': 'Shopping',
                'Transportation': 'Transport',
                'Healthcare': 'Health',
                'Entertainment': 'Entertainment',
                'Travel': 'Transport',
                'Bills': 'Utilities',
                'Transfer': 'Other',
                'Restaurants': 'Food/Drink',
                'Public Transportation': 'Transport',
                'Digital Purchase': 'Shopping',
                'Supermarkets and Groceries': 'Shopping'
            };
            
            // Get the first (most specific) category from Plaid
            const plaidCategory = transaction.category?.[0] || 'Other';
            const appCategory = categoryMap[plaidCategory] || 'Other';
            
            // Extract clean merchant name
            let merchantName = transaction.merchant_name || transaction.name || 'Unknown';
            // Remove common bank transaction prefixes
            merchantName = merchantName.replace(/^(CARD PURCHASE |DEBIT CARD |ATM |)/, '');
            
            // Determine expense type based on category
            const essentialCategories = ['Transport', 'Utilities', 'Health'];
            const expenseType = essentialCategories.includes(appCategory) ? 'Essential' : 'Non-Essential';
            
            return {
                id: Date.now() + Math.random(),
                plaidId: transaction.transaction_id,
                name: merchantName,
                cost: Math.abs(transaction.amount), // Ensure positive number
                type: expenseType,
                category: appCategory,
                date: transaction.date,
                paymentMethod: 'Bank Account',
                status: 'active',
                source: 'plaid'
            };
        }

        // Enhanced Points Optimization System
        class PointsOptimizationEngine {
            constructor() {
                // Credit card rewards mapping
                this.cardRewards = {
                    'amex_gold': {
                        name: 'Amex Gold',
                        categories: {
                            'Food & Drink': 4, // 4x points
                            'Shopping': 1,
                            'Transport': 1,
                            'default': 1
                        }
                    },
                    'amex_green': {
                        name: 'Amex Green',
                        categories: {
                            'Transport': 3, // 3x points  
                            'Food & Drink': 1,
                            'Shopping': 1,
                            'default': 1
                        }
                    },
                    'virgin_red': {
                        name: 'Virgin Red',
                        categories: {
                            'Shopping': 3, // 3x points at certain retailers
                            'Transport': 2, // 2x for Virgin services
                            'Food & Drink': 1,
                            'default': 1
                        }
                    }
                };
                
                // Points value in GBP (conservative estimates)
                this.pointValues = {
                    'amex': 0.005, // £0.005 per point
                    'virgin': 0.01, // £0.01 per point
                    'ana': 0.012   // £0.012 per mile
                };
            }
            
            // Analyze a transaction for point optimization opportunities
            analyzeTransaction(transaction) {
                const opportunities = [];
                const amount = transaction.cost;
                const category = transaction.category;
                
                // Find best card for this transaction
                let bestCard = null;
                let bestPoints = 0;
                let bestValue = 0;
                
                for (const [cardId, card] of Object.entries(this.cardRewards)) {
                    const pointsRate = card.categories[category] || card.categories.default;
                    const potentialPoints = Math.floor(amount * pointsRate);
                    const pointValue = potentialPoints * this.pointValues.amex; // Assuming Amex for now
                    
                    if (pointValue > bestValue) {
                        bestCard = card;
                        bestPoints = potentialPoints;
                        bestValue = pointValue;
                    }
                }
                
                // If transaction was made with suboptimal method, flag opportunity
                if (transaction.paymentMethod === 'Bank Account' || transaction.paymentMethod === 'Debit Card') {
                    opportunities.push({
                        type: 'missed_points',
                        transaction_id: transaction.id,
                        merchant: transaction.name,
                        amount: amount,
                        category: category,
                        date: transaction.date,
                        recommended_card: bestCard.name,
                        potential_points: bestPoints,
                        potential_value: bestValue,
                        message: `Could have earned ${bestPoints} points (worth £${bestValue.toFixed(2)}) using ${bestCard.name}`
                    });
                }
                
                return opportunities;
            }
            
            // Analyze all transactions for optimization opportunities
            analyzeAllTransactions(transactions) {
                const allOpportunities = [];
                let totalMissedValue = 0;
                
                transactions.forEach(transaction => {
                    if (transaction.source === 'plaid') { // Only analyze imported transactions
                        const opportunities = this.analyzeTransaction(transaction);
                        allOpportunities.push(...opportunities);
                        
                        opportunities.forEach(opp => {
                            totalMissedValue += opp.potential_value;
                        });
                    }
                });
                
                return {
                    opportunities: allOpportunities,
                    totalMissedValue: totalMissedValue,
                    summary: this.generateOptimizationSummary(allOpportunities)
                };
            }
            
            // Generate merchant-specific recommendations
            generateMerchantRecommendations(transactions) {
                const merchantSpending = {};
                
                // Group spending by merchant
                transactions.forEach(transaction => {
                    if (transaction.source === 'plaid') {
                        const merchant = transaction.name;
                        if (!merchantSpending[merchant]) {
                            merchantSpending[merchant] = {
                                total: 0,
                                count: 0,
                                category: transaction.category,
                                transactions: []
                            };
                        }
                        merchantSpending[merchant].total += transaction.cost;
                        merchantSpending[merchant].count += 1;
                        merchantSpending[merchant].transactions.push(transaction);
                    }
                });
                
                // Generate recommendations for top merchants
                const recommendations = [];
                const topMerchants = Object.entries(merchantSpending)
                    .sort(([,a], [,b]) => b.total - a.total)
                    .slice(0, 5);
                    
                topMerchants.forEach(([merchant, data]) => {
                    const bestCard = this.getBestCardForCategory(data.category);
                    const monthlyPoints = Math.floor(data.total * bestCard.pointsRate);
                    const monthlyValue = monthlyPoints * this.pointValues.amex;
                    
                    recommendations.push({
                        merchant: merchant,
                        monthlySpending: data.total,
                        recommendedCard: bestCard.name,
                        monthlyPoints: monthlyPoints,
                        monthlyValue: monthlyValue,
                        annualValue: monthlyValue * 12
                    });
                });
                
                return recommendations;
            }
            
            // Get best card for a category
            getBestCardForCategory(category) {
                let bestCard = { name: 'Amex Gold', pointsRate: 1 };
                let bestRate = 1;
                
                for (const [cardId, card] of Object.entries(this.cardRewards)) {
                    const rate = card.categories[category] || card.categories.default;
                    if (rate > bestRate) {
                        bestCard = { name: card.name, pointsRate: rate };
                        bestRate = rate;
                    }
                }
                
                return bestCard;
            }
            
            // Generate summary insights
            generateOptimizationSummary(opportunities) {
                if (opportunities.length === 0) {
                    return "Great job! You're already optimizing your spending.";
                }
                
                const totalValue = opportunities.reduce((sum, opp) => sum + opp.potential_value, 0);
                const topCategory = this.getTopMissedCategory(opportunities);
                
                return {
                    totalMissedValue: totalValue,
                    monthlyPotential: totalValue,
                    annualPotential: totalValue * 12,
                    topRecommendation: `Switch to optimized cards for ${topCategory} spending`,
                    quickWin: `Start using the right card for your top spending categories`
                };
            }
            
            // Get category with most missed value
            getTopMissedCategory(opportunities) {
                const categoryTotals = {};
                
                opportunities.forEach(opp => {
                    if (!categoryTotals[opp.category]) {
                        categoryTotals[opp.category] = 0;
                    }
                    categoryTotals[opp.category] += opp.potential_value;
                });
                
                return Object.entries(categoryTotals)
                    .sort(([,a], [,b]) => b - a)[0]?.[0] || 'General';
            }
        }

        // Initialize the points optimization engine
        const pointsEngine = new PointsOptimizationEngine();

        // Enhanced function to replace existing generatePointsOptimizationSuggestions
        function generateEnhancedPointsOptimization(transactions) {
            const analysis = pointsEngine.analyzeAllTransactions(transactions);
            const merchantRecs = pointsEngine.generateMerchantRecommendations(transactions);
            
            // Store enhanced insights
            localStorage.setItem('pointsAnalysis', JSON.stringify(analysis));
            localStorage.setItem('merchantRecommendations', JSON.stringify(merchantRecs));
            localStorage.setItem('pointsOptimizationSuggestions', JSON.stringify(analysis.opportunities));
            
            console.log('Enhanced points analysis:', analysis);
            console.log('Merchant recommendations:', merchantRecs);
            
            return analysis;
        }

        // Legacy function for backward compatibility
        function generatePointsOptimizationSuggestions(transactions) {
            return generateEnhancedPointsOptimization(expenses);
        }

        function resetConnectButton() {
            const connectBtn = document.getElementById('connect-bank-btn');
            connectBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg><span>Connect Bank Account</span>';
        }

        // Enhanced Insights Dashboard Display Functions
        function renderEnhancedInsights() {
            const pointsAnalysis = JSON.parse(localStorage.getItem('pointsAnalysis') || '{"opportunities": [], "totalMissedValue": 0}');
            const merchantRecs = JSON.parse(localStorage.getItem('merchantRecommendations') || '[]');
            
            // Only render if there are opportunities to show
            if (pointsAnalysis.opportunities && pointsAnalysis.opportunities.length > 0) {
                // Create a dedicated section for points insights if it doesn't exist
                let pointsSection = document.getElementById('points-optimization-section');
                if (!pointsSection) {
                    pointsSection = document.createElement('div');
                    pointsSection.id = 'points-optimization-section';
                    
                    // Insert before the smart recommendations
                    const smartRecommendationsContainer = document.getElementById('smart-recommendations');
                    if (smartRecommendationsContainer && smartRecommendationsContainer.parentNode) {
                        smartRecommendationsContainer.parentNode.insertBefore(pointsSection, smartRecommendationsContainer);
                    }
                }
                
                // Render the points insights
                pointsSection.innerHTML = renderPointsOptimizationInsights(pointsAnalysis, merchantRecs);
                
                // Badge will be updated by the main insights function
            }
        }

        function renderPointsOptimizationInsights(analysis, merchantRecs) {
            if (analysis.opportunities.length === 0) {
                return `
                    <div class="text-center p-6 bg-green-50 dark:bg-green-900/20 rounded-lg mb-4">
                        <div class="text-2xl mb-2">🎯</div>
                        <h3 class="font-semibold text-green-800 dark:text-green-200 mb-2">Perfect Optimization!</h3>
                        <p class="text-sm text-green-600 dark:text-green-300">You're already maximizing your points potential.</p>
                    </div>
                `;
            }
            
            const totalMissed = analysis.totalMissedValue;
            const annualPotential = totalMissed * 12;
            
            return `
                <!-- Points Optimization Summary Card -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="text-2xl">💳</div>
                            <div>
                                <h3 class="font-semibold text-gray-800 dark:text-gray-200">Points Optimization</h3>
                                <p class="text-xs text-gray-600 dark:text-gray-400">Based on your spending patterns</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-purple-600 dark:text-purple-400">£${totalMissed.toFixed(2)}</div>
                            <div class="text-xs text-gray-500">potential monthly</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-3">
                            <div class="text-sm font-semibold text-gray-800 dark:text-gray-200">Monthly Potential</div>
                            <div class="text-lg font-bold text-green-600">£${totalMissed.toFixed(2)}</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-3">
                            <div class="text-sm font-semibold text-gray-800 dark:text-gray-200">Annual Potential</div>
                            <div class="text-lg font-bold text-blue-600">£${annualPotential.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Opportunities -->
                <div class="space-y-3 mb-4">
                    <h4 class="font-semibold text-gray-800 dark:text-gray-200 text-sm">🎯 Top Opportunities</h4>
                    ${analysis.opportunities.slice(0, 3).map(opp => `
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-100 dark:border-gray-700">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800 dark:text-gray-200">${opp.merchant}</div>
                                    <div class="text-xs text-gray-500">${opp.category} • ${opp.date}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-green-600">£${opp.potential_value.toFixed(2)}</div>
                                    <div class="text-xs text-gray-500">${opp.potential_points} points</div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                💡 ${opp.message}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Merchant Recommendations -->
                ${merchantRecs.length > 0 ? `
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 text-sm mb-3">🏪 Your Top Merchants</h4>
                        <div class="space-y-2">
                            ${merchantRecs.slice(0, 3).map(rec => `
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-100 dark:border-gray-700">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-medium text-gray-800 dark:text-gray-200">${rec.merchant}</div>
                                            <div class="text-xs text-gray-500">Monthly: £${rec.monthlySpending.toFixed(2)}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold text-blue-600">${rec.recommendedCard}</div>
                                            <div class="text-xs text-green-600">+£${rec.monthlyValue.toFixed(2)}/month</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Action Button -->
                <div class="mb-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="showDetailedOptimization()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors">
                        View Detailed Analysis
                    </button>
                </div>
            `;
        }


        function showDetailedOptimization() {
            const analysis = JSON.parse(localStorage.getItem('pointsAnalysis') || '{"opportunities": []}');
            const merchantRecs = JSON.parse(localStorage.getItem('merchantRecommendations') || '[]');
            
            // Create a detailed modal or navigate to a detailed view
            console.log('Detailed optimization analysis:', { analysis, merchantRecs });
            
            // For now, show a detailed toast
            const totalAnnual = analysis.totalMissedValue * 12;
            showToast(`Annual optimization potential: £${totalAnnual.toFixed(2)}. Check console for details.`, 'info');
        }

        // Goal Impact Analysis System
        class GoalImpactAnalyzer {
            constructor() {
                this.pointValues = {
                    'amex': 0.005,
                    'virgin': 0.01,
                    'ana': 0.012
                };
            }
            
            // Calculate how spending affects goal timeline
            calculateGoalImpact(goals, transactions, pointsOptimization) {
                const goalImpacts = [];
                
                goals.forEach(goal => {
                    if (goal.status !== 'active') return;
                    
                    const monthlySpending = this.calculateMonthlySpending(transactions);
                    const monthlyPointsValue = this.calculateMonthlyPointsValue(pointsOptimization);
                    const currentSavings = goal.current || 0;
                    const targetAmount = goal.target;
                    const remainingAmount = targetAmount - currentSavings;
                    
                    console.log(`Goal ${goal.name}:`, {
                        type: goal.type,
                        current: currentSavings,
                        target: targetAmount,
                        remaining: remainingAmount,
                        monthlySpending,
                        monthlyPointsValue
                    });
                    
                    // Current trajectory (without optimization)
                    const monthlySavingsCurrent = this.estimateMonthlySavings(monthlySpending, goal.type);
                    const monthsToGoalCurrent = remainingAmount / (monthlySavingsCurrent || 1);
                    
                    console.log(`${goal.name} calculation:`, {
                        monthlySavingsCurrent,
                        monthsToGoalCurrent,
                        monthlyIncome: monthlyIncome || 0,
                        monthlyBudget: monthlyBudget || 0
                    });
                    
                    // Optimized trajectory (with points optimization)
                    const monthlySavingsOptimized = monthlySavingsCurrent + monthlyPointsValue;
                    const monthsToGoalOptimized = remainingAmount / monthlySavingsOptimized;
                    
                    // Time saved through optimization
                    const timeSavedMonths = monthsToGoalCurrent - monthsToGoalOptimized;
                    
                    goalImpacts.push({
                        goalId: goal.id,
                        goalName: goal.name,
                        goalType: goal.type,
                        target: targetAmount,
                        current: currentSavings,
                        remaining: remainingAmount,
                        progressPercent: (currentSavings / targetAmount) * 100,
                        
                        // Current trajectory
                        monthsToGoalCurrent: monthsToGoalCurrent,
                        completionDateCurrent: this.addMonthsToDate(new Date(), monthsToGoalCurrent),
                        
                        // Optimized trajectory  
                        monthsToGoalOptimized: monthsToGoalOptimized,
                        completionDateOptimized: this.addMonthsToDate(new Date(), monthsToGoalOptimized),
                        
                        // Impact metrics
                        timeSavedMonths: timeSavedMonths,
                        timeSavedDays: timeSavedMonths * 30,
                        monthlyPointsBoost: monthlyPointsValue,
                        annualPointsBoost: monthlyPointsValue * 12,
                        
                        // Recommendations
                        recommendations: this.generateGoalRecommendations(goal, monthlySpending, monthlyPointsValue)
                    });
                });
                
                return goalImpacts;
            }
            
            // Calculate monthly spending from transactions
            calculateMonthlySpending(transactions) {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                return transactions
                    .filter(t => {
                        const transactionDate = new Date(t.date);
                        return transactionDate.getMonth() === currentMonth && 
                               transactionDate.getFullYear() === currentYear &&
                               t.status === 'active';
                    })
                    .reduce((total, t) => total + t.cost, 0);
            }
            
            // Calculate monthly points value from optimization opportunities
            calculateMonthlyPointsValue(pointsOptimization) {
                if (!pointsOptimization || !pointsOptimization.totalMissedValue) {
                    return 0;
                }
                return pointsOptimization.totalMissedValue;
            }
            
            // Estimate monthly savings based on goal type and available income
            estimateMonthlySavings(monthlySpending, goalType) {
                // Get user's monthly budget and income
                const userIncome = monthlyIncome || 0;
                const userBudget = monthlyBudget || 0;
                
                // For debt payoff, use a more realistic calculation
                if (goalType === 'debt') {
                    // Use 20% of available income after essential expenses as baseline
                    const availableAfterBudget = Math.max(0, userIncome - userBudget);
                    const debtPaymentCapacity = availableAfterBudget * 0.2;
                    
                    // Minimum payment should be at least £50/month to be realistic
                    return Math.max(50, debtPaymentCapacity);
                } else {
                    // For other goals, use 10% of income or available surplus
                    const surplus = Math.max(0, userIncome - monthlySpending);
                    return Math.max(50, Math.min(surplus * 0.5, userIncome * 0.1));
                }
            }
            
            // Add months to a date
            addMonthsToDate(date, months) {
                const result = new Date(date);
                result.setMonth(result.getMonth() + months);
                return result;
            }
            
            // Format date for display
            formatDate(date) {
                return date.toLocaleDateString('en-GB', { 
                    year: 'numeric', 
                    month: 'short' 
                });
            }
            
            // Generate goal-specific recommendations
            generateGoalRecommendations(goal, monthlySpending, monthlyPointsValue) {
                const recommendations = [];
                
                if (monthlyPointsValue > 0) {
                    recommendations.push({
                        type: 'points_optimization',
                        message: `Use points strategically to accelerate your ${goal.name} goal by ${Math.round(monthlyPointsValue * 30)} days per month`,
                        impact: monthlyPointsValue
                    });
                }
                
                if (goal.type === 'house') {
                    recommendations.push({
                        type: 'spending_reduction',
                        message: 'Consider reducing non-essential spending by 5% to reach your house deposit faster',
                        impact: monthlySpending * 0.05
                    });
                }
                
                if (goal.type === 'emergency') {
                    recommendations.push({
                        type: 'automatic_allocation',
                        message: 'Set up automatic transfers to build your emergency fund consistently',
                        impact: 'behavioral'
                    });
                }
                
                return recommendations;
            }
        }

        // Initialize goal impact analyzer
        const goalImpactAnalyzer = new GoalImpactAnalyzer();

        // Enhanced function to update goal displays with impact analysis
        function updateGoalsWithImpactAnalysis() {
            console.log('=== UPDATING GOALS WITH IMPACT ANALYSIS ===');
            
            // STEP 1: Load goals from the correct source (same as loadData function)
            let goals = [];
            
            // Try userGoals variable first
            if (userGoals && userGoals.length > 0) {
                goals = userGoals;
                console.log('Loaded goals from userGoals variable:', goals);
            } 
            // If that fails, load from main lensAppData storage (consistent with loadData)
            else {
                try {
                    const data = authManager.getUserData('lensAppData');
                    if (data) {
                        const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                        goals = parsedData.userGoals || [];
                        // Update the global variable so other functions can use it
                        userGoals = goals;
                        console.log('Loaded goals from lensAppData storage:', goals);
                    }
                } catch (error) {
                    console.error('Error loading goals from lensAppData:', error);
                }
            }
            
            // STEP 2: Get the goals dashboard container
            const goalsContainer = document.getElementById('goals-dashboard');
            if (!goalsContainer) {
                console.error('Goals dashboard container not found');
                return;
            }
            
            // STEP 3: Handle empty goals case
            if (!goals || goals.length === 0) {
                console.log('No goals found, showing empty state');
                goalsContainer.innerHTML = `
                    <div class="text-center py-6">
                        <div class="text-3xl mb-2">🎯</div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mb-3">No goals set yet</p>
                        <button onclick="openGoalsModal()" class="text-blue-600 hover:text-blue-700 hover:underline text-sm font-medium">
                            Choose your goals →
                        </button>
                    </div>
                `;
                return;
            }
            
            // STEP 4: Render goals with correct current data
            console.log('Rendering', goals.length, 'goals');
            
            const goalsHTML = goals.map(goal => {
                // Calculate actual progress percentage
                const current = goal.currentProgress || 0;
                const target = goal.target || 1;
                const progressPercent = target > 0 ? (current / target) * 100 : 0;
                const remaining = Math.max(0, target - current);
                
                console.log(`Goal "${goal.name}":`, {
                    current: current,
                    target: target,
                    progressPercent: progressPercent.toFixed(1) + '%'
                });
                
                // Calculate timeline if monthly contribution exists
                let timelineText = '';
                if (goal.monthlyContribution && goal.monthlyContribution > 0 && remaining > 0) {
                    const monthsRemaining = Math.ceil(remaining / goal.monthlyContribution);
                    if (monthsRemaining <= 12) {
                        timelineText = `${monthsRemaining} months remaining`;
                    } else {
                        const years = Math.round(monthsRemaining / 12 * 10) / 10;
                        timelineText = `${years} years remaining`;
                    }
                } else if (progressPercent >= 100) {
                    timelineText = '🎉 Complete!';
                } else {
                    timelineText = 'Set monthly contribution for timeline';
                }
                
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-100 dark:border-gray-700 hover:border-blue-200 dark:hover:border-blue-700 transition-all duration-200 cursor-pointer" onclick="openGoalsModal()">
                        <!-- Goal Header -->
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800 dark:text-gray-200 text-base">${goal.name || 'Unnamed Goal'}</h3>
                                <p class="text-sm text-gray-500 mt-1">
                                    ${formatCurrency(current)} / ${formatCurrency(target)}
                                </p>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-lg font-bold ${progressPercent >= 100 ? 'text-green-600' : 'text-blue-600'} dark:text-blue-400">
                                    ${progressPercent.toFixed(1)}%
                                </div>
                                <div class="text-xs text-gray-500">complete</div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-4 relative overflow-hidden">
                            <div class="h-3 rounded-full transition-all duration-500 ${progressPercent >= 100 ? 'bg-green-500' : 'bg-blue-600'}" 
                                 style="width: ${Math.min(progressPercent, 100)}%"></div>
                            <!-- 50% midpoint reference marker -->
                            <div class="absolute top-0 left-1/2 w-px h-full bg-gray-400 opacity-50"></div>
                            <!-- Actual progress marker -->
                            <div class="absolute top-0 w-0.5 h-full bg-white border-l border-r border-gray-800" style="left: ${Math.min(progressPercent, 100)}%"></div>
                        </div>
                        
                        <!-- Goal Details Grid -->
                        <div class="grid grid-cols-1 gap-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500">Still needed:</span>
                                <span class="font-semibold ${remaining > 0 ? 'text-purple-600' : 'text-green-600'}">
                                    ${remaining > 0 ? formatCurrency(remaining) : 'Complete!'}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500">Timeline:</span>
                                <span class="font-medium text-gray-800 dark:text-gray-200 text-right">
                                    ${timelineText}
                                </span>
                            </div>
                        </div>
                        
                        ${progressPercent >= 100 ? `
                            <div class="mt-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-center">
                                <span class="text-green-600 dark:text-green-400 text-sm font-semibold">
                                    🎉 Congratulations! Goal achieved!
                                </span>
                            </div>
                        ` : progressPercent > 50 ? `
                            <div class="mt-3 p-2 bg-blue-50 dark:bg-blue-900/20 rounded text-center">
                                <span class="text-blue-600 dark:text-blue-400 text-xs font-medium">
                                    Great progress! You're over halfway there! 💪
                                </span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // STEP 5: Add the edit button at the bottom
            goalsContainer.innerHTML = `
                <div class="space-y-4">
                    ${goalsHTML}
                    
                    <div class="text-center pt-2">
                        <button onclick="openGoalsModal()" class="text-blue-600 hover:text-blue-700 hover:underline text-sm font-medium transition-colors">
                            View details & edit goals →
                        </button>
                    </div>
                </div>
            `;
            
            console.log('Goals successfully rendered in insights tab');
        }

        // Render enhanced goal cards with impact analysis
        function renderGoalImpactCards(goalImpacts) {
            const goalsContainer = document.getElementById('goals-dashboard');
            if (!goalsContainer || goalImpacts.length === 0) return;
            
            goalsContainer.innerHTML = `
                <div class="space-y-4">
                    ${goalImpacts.map(impact => `
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-100 dark:border-gray-700">
                            <!-- Goal Header -->
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-semibold text-gray-800 dark:text-gray-200">${impact.goalName}</h3>
                                    <p class="text-sm text-gray-500">£${impact.current.toLocaleString()} / £${impact.target.toLocaleString()}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-gray-600 dark:text-gray-400">${impact.progressPercent.toFixed(1)}%</div>
                                    <div class="text-xs text-gray-500">complete</div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${Math.min(impact.progressPercent, 100)}%"></div>
                            </div>
                            
                            <!-- Impact Analysis -->
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500">Current Timeline</div>
                                    <div class="font-semibold text-gray-800 dark:text-gray-200">
                                        ${impact.monthsToGoalCurrent > 12 ? 
                                            `${(impact.monthsToGoalCurrent / 12).toFixed(1)} years` : 
                                            `${Math.round(impact.monthsToGoalCurrent)} months`}
                                    </div>
                                    <div class="text-xs text-gray-500">${goalImpactAnalyzer.formatDate(impact.completionDateCurrent)}</div>
                                </div>
                                
                                ${impact.timeSavedMonths > 0 ? `
                                    <div class="text-center">
                                        <div class="text-xs text-green-600">With Optimization</div>
                                        <div class="font-semibold text-green-700">
                                            ${impact.monthsToGoalOptimized > 12 ? 
                                                `${(impact.monthsToGoalOptimized / 12).toFixed(1)} years` : 
                                                `${Math.round(impact.monthsToGoalOptimized)} months`}
                                        </div>
                                        <div class="text-xs text-green-600">
                                            ${Math.round(impact.timeSavedDays)} days faster!
                                        </div>
                                    </div>
                                ` : `
                                    <div class="text-center">
                                        <div class="text-xs text-gray-500">Points Boost</div>
                                        <div class="font-semibold text-blue-600">£${impact.monthlyPointsBoost.toFixed(2)}</div>
                                        <div class="text-xs text-gray-500">per month</div>
                                    </div>
                                `}
                            </div>
                            
                            <!-- Quick Action -->
                            ${impact.timeSavedMonths > 0 ? `
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3">
                                    <div class="text-sm text-green-800 dark:text-green-200">
                                        💡 <strong>Optimize spending</strong> to reach this goal ${Math.round(impact.timeSavedDays)} days earlier
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Call this function when transactions are updated
        function updateGoalImpactDisplay() {
            updateGoalsWithImpactAnalysis();
        }


        // Settings modal is handled by onclick="closeSettings()" on the backdrop
        // No need for window click handler since we use a modal, not a dropdown menu

        
        // --- Auto-Categorization ---
        function autoCategorizeExpense(event) {
            const name = event.target.value.toLowerCase();
            if (!name) return;

            let matchedCategory = 'Other';
            let matchedEssential = 'Non-Essential';

            // Find category based on keywords
            for (const category in categoryKeywords) {
                if (categoryKeywords[category].some(keyword => name.includes(keyword))) {
                    matchedCategory = category;
                    break;
                }
            }

            // Determine if essential based on keywords
            if (essentialKeywords.some(keyword => name.includes(keyword))) {
                matchedEssential = 'Essential';
            }

            // Update the form fields
            const formPrefix = event.target.id.startsWith('recurring') ? 'recurring-' : 'expense-';
            const categorySelect = document.getElementById(`${formPrefix}category`);
            const typeSelect = document.getElementById(`${formPrefix}type`) || document.getElementById(`${formPrefix}essential-type`);
            
            if (categorySelect) {
                categorySelect.value = matchedCategory;
            }
            if (typeSelect) {
                typeSelect.value = matchedEssential;
            }
        }

        // =============================================================================
        // SIMPLIFIED INCOME MANAGEMENT - SINGLE SOURCE OF TRUTH
        // =============================================================================

        function migrateIncomeToRecurringOnly() {
            console.log('🔄 Starting income migration to recurring-only system...');
            
            // Get existing income from global variable or localStorage
            const existingGlobalIncome = parseFloat(window.monthlyIncome || 0);
            const incomeToMigrate = existingGlobalIncome;
            
            console.log('Found existing income:', incomeToMigrate);
            
            if (incomeToMigrate > 0) {
                // Check if we already have a recurring salary item
                const existingIncomeItem = recurringItems.find(item => 
                    item.type === 'income' && 
                    item.category === 'Salary' &&
                    item.status === 'active'
                );
                
                if (!existingIncomeItem) {
                    console.log('Creating new recurring income item...');
                    
                    // Create recurring income item
                    const newIncomeItem = {
                        id: Date.now(),
                        type: 'income',
                        name: 'Base Salary',
                        amount: incomeToMigrate,
                        frequency: 'Monthly',
                        category: 'Salary',
                        startDate: new Date().toISOString().split('T')[0],
                        status: 'active'
                    };
                    
                    recurringItems.push(newIncomeItem);
                    console.log('✅ Migration completed - new recurring income created');
                    showToast('Your income has been migrated to the Recurring tab!', 'success');
                } else {
                    console.log('✅ Recurring income already exists, no migration needed');
                }
            }
            
            // Clear old income storage
            window.monthlyIncome = 0; // Reset global variable to 0
            
            // Save the updated data
            saveData();
            
            console.log('🎯 Migration complete - recurring tab is now the single source of truth');
        }

        function calculateTotalIncomeFromRecurring() {
            const incomeItems = recurringItems.filter(item => 
                item.type === 'income' && 
                item.status === 'active'
            );
            
            const totalIncome = incomeItems.reduce((sum, item) => {
                return sum + (item.amount || 0);
            }, 0);
            
            console.log('📊 Calculated total income from recurring:', totalIncome);
            return totalIncome;
        }

        function getIncomeSourcesBreakdown() {
            const incomeItems = recurringItems.filter(item => 
                item.type === 'income' && 
                item.status === 'active'
            );
            
            return {
                salaryIncome: incomeItems.filter(item => item.category === 'Salary')
                    .reduce((sum, item) => sum + (item.amount || 0), 0),
                otherIncome: incomeItems.filter(item => item.category !== 'Salary')
                    .reduce((sum, item) => sum + (item.amount || 0), 0),
                items: incomeItems.map(item => ({
                    name: item.name,
                    amount: item.amount,
                    category: item.category || 'Income'
                }))
            };
        }

        // --- Settings Page Population ---
        
        function syncGlobalIncomeFromRecurring() {
            // Update global monthlyIncome from recurring entries (single source of truth)
            monthlyIncome = calculateTotalIncomeFromRecurring();
            console.log('🔄 Synced global monthlyIncome:', monthlyIncome);
        }

        function populateSettingsForm() {
            // Populate budget and income fields
            const budgetInput = document.getElementById('monthly-budget');
            const incomeInput = document.getElementById('monthly-income');
            const currencySelect = document.getElementById('currency-selector');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            
            if (budgetInput) {
                budgetInput.value = monthlyBudget > 0 ? monthlyBudget : '';
            }
            if (incomeInput) {
                // Calculate income from recurring entries
                const totalRecurringIncome = calculateTotalIncomeFromRecurring();
                incomeInput.value = totalRecurringIncome > 0 ? totalRecurringIncome : '';
            }
            if (currencySelect) {
                currencySelect.value = currentCurrencyCode || 'USD';
            }
            if (darkModeToggle) {
                const isDark = localStorage.getItem('darkMode') === 'true';
                darkModeToggle.checked = isDark;
            }
        }

        function cancelSettings() {
            // Reset form to original values
            populateSettingsForm();
            showToast('Changes cancelled');
        }

        // --- Settings Modal ---
        function openSettings(section) {
            const settingsModal = document.getElementById('settings-modal');
            
            // Populate inputs with current values
            document.getElementById('settings-budget-input').value = monthlyBudget > 0 ? monthlyBudget : '';
            document.getElementById('settings-income-input').value = monthlyIncome > 0 ? monthlyIncome : '';
            
            settingsModal.classList.remove('hidden');

            if (section === 'budget') {
                setTimeout(() => {
                    document.getElementById('settings-budget-input').focus();
                }, 100);
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }


        function formatCurrency(amount) {
            // Handle NaN, undefined, null, and invalid values
            if (typeof amount !== 'number' || isNaN(amount) || !isFinite(amount)) {
                amount = 0;
            }
            
            const config = currencyConfig[currentCurrencyCode];
            const isInteger = amount % 1 === 0;
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
                maximumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
            };
            return new Intl.NumberFormat(config.locale, options).format(amount);
        }

// SMART ANALYTICS CORE ENGINE

class LensSmartInsights {
    constructor(expenses, recurringItems, monthlyBudget, monthlyIncome) {
        this.expenses = expenses || [];
        this.recurringItems = recurringItems || [];
        this.monthlyBudget = monthlyBudget || 0;
        this.monthlyIncome = monthlyIncome || 0;
        this.now = new Date();
        
        // Process data once for all analyses
        this.processedExpenses = this.enrichExpenseData();
        this.monthlyData = this.getMonthlyBreakdown();
    }

    enrichExpenseData() {
        return this.expenses
            .filter(e => e.status === 'active')
            .map(expense => ({
                ...expense,
                cost: parseFloat(expense.cost) || 0,
                date: new Date(expense.date),
                dayOfWeek: new Date(expense.date).getDay(),
                isWeekend: [0, 6].includes(new Date(expense.date).getDay()),
                isRecurring: !!expense.recurringSourceId,
                merchantName: this.extractMerchant(expense.name),
                month: new Date(expense.date).getMonth(),
                year: new Date(expense.date).getFullYear()
            }))
            .sort((a, b) => b.date - a.date);
    }

    extractMerchant(name) {
        return name.toLowerCase()
            .replace(/\d+/g, '')
            .replace(/[^\w\s]/g, '')
            .trim()
            .split(' ')[0];
    }

    getMonthlyBreakdown() {
        const currentMonth = this.now.getMonth();
        const currentYear = this.now.getFullYear();
        
        return {
            thisMonth: this.processedExpenses.filter(e => 
                e.month === currentMonth && e.year === currentYear
            ),
            lastMonth: this.processedExpenses.filter(e => {
                const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const lastYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                return e.month === lastMonth && e.year === lastYear;
            }),
            last3Months: this.processedExpenses.filter(e => {
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                return e.date >= threeMonthsAgo;
            })
        };
    }

    // ===================================================================
    // BEHAVIORAL ANALYSIS
    // ===================================================================

    analyzeWeekendSpending() {
        const { thisMonth } = this.monthlyData;
        
        const weekdayExpenses = thisMonth.filter(e => !e.isWeekend && e.type === 'Non-Essential');
        const weekendExpenses = thisMonth.filter(e => e.isWeekend && e.type === 'Non-Essential');
        
        const weekdayTotal = weekdayExpenses.reduce((sum, e) => sum + e.cost, 0);
        const weekendTotal = weekendExpenses.reduce((sum, e) => sum + e.cost, 0);
        
        // Fix: Prevent division by zero
        const weekdayDays = Math.max(1, new Set(weekdayExpenses.map(e => e.date.getDate())).size);
        const weekendDays = Math.max(1, new Set(weekendExpenses.map(e => e.date.getDate())).size);
        
        const weekdayAvg = weekdayTotal / weekdayDays;
        const weekendAvg = weekendTotal / weekendDays;
        
        // Fix: Handle zero weekday spending
        const weekendPremium = weekdayAvg > 0 ? (weekendAvg - weekdayAvg) / weekdayAvg : 0;
        
        // Fix: Cap at reasonable values
        const cappedPremium = Math.min(5, Math.max(0, weekendPremium)); // Cap at 500% increase
        
        return {
            weekendPremium: cappedPremium,
            nonEssentialWeekendSpending: weekendTotal,
            nonEssentialWeekdaySpending: weekdayTotal,
            potentialSaving: Math.min(1000, cappedPremium * weekendTotal * 0.3) // Cap savings at £1000
        };
    }

    analyzeImpulseSpending() {
        const { thisMonth } = this.monthlyData;
        
        // Impulse indicators: Non-essential, small amounts, quick succession
        const impulseExpenses = thisMonth.filter(expense => {
            const isNonEssential = expense.type === 'Non-Essential';
            const isSmallAmount = expense.cost < 30;
            const isQuickSuccession = this.isInQuickSuccession(expense, thisMonth);
            
            return isNonEssential && (isSmallAmount || isQuickSuccession);
        });

        return {
            count: impulseExpenses.length,
            total: impulseExpenses.reduce((sum, e) => sum + e.cost, 0),
            avgAmount: impulseExpenses.length > 0 ? 
                impulseExpenses.reduce((sum, e) => sum + e.cost, 0) / impulseExpenses.length : 0,
            score: impulseExpenses.length / Math.max(thisMonth.length, 1)
        };
    }

    isInQuickSuccession(expense, allExpenses) {
        const sameDay = allExpenses.filter(e => 
            e.date.toDateString() === expense.date.toDateString() && 
            e.id !== expense.id
        );
        return sameDay.length > 2; // More than 2 other purchases same day
    }

    analyzeMerchantLoyalty() {
        const { last3Months } = this.monthlyData;
        
        // Group by category and merchant
        const categoryMerchants = {};
        last3Months.forEach(expense => {
            if (!categoryMerchants[expense.category]) {
                categoryMerchants[expense.category] = {};
            }
            if (!categoryMerchants[expense.category][expense.merchantName]) {
                categoryMerchants[expense.category][expense.merchantName] = [];
            }
            categoryMerchants[expense.category][expense.merchantName].push(expense.cost);
        });

        const opportunities = [];
        Object.entries(categoryMerchants).forEach(([category, merchants]) => {
            const merchantAvgs = Object.entries(merchants).map(([merchant, costs]) => ({
                merchant,
                avg: costs.reduce((a, b) => a + b, 0) / costs.length,
                count: costs.length,
                total: costs.reduce((a, b) => a + b, 0)
            })).filter(m => m.count >= 2); // Only merchants used multiple times

            if (merchantAvgs.length > 1) {
                merchantAvgs.sort((a, b) => a.avg - b.avg);
                const cheapest = merchantAvgs[0];
                const mostUsed = merchantAvgs.reduce((max, curr) => 
                    curr.count > max.count ? curr : max
                );

                if (mostUsed.merchant !== cheapest.merchant && mostUsed.avg > cheapest.avg * 1.2) {
                    const monthlySaving = (mostUsed.avg - cheapest.avg) * (mostUsed.count / 3); // Monthly estimate
                    opportunities.push({
                        category,
                        currentMerchant: mostUsed.merchant,
                        betterMerchant: cheapest.merchant,
                        potentialSaving: monthlySaving
                    });
                }
            }
        });

        return opportunities;
    }

    detectHiddenSubscriptions() {
        const { last3Months } = this.monthlyData;
        
        // Group by merchant and look for regular patterns
        const merchantPatterns = {};
        last3Months.forEach(expense => {
            if (!merchantPatterns[expense.merchantName]) {
                merchantPatterns[expense.merchantName] = [];
            }
            merchantPatterns[expense.merchantName].push({
                cost: expense.cost,
                date: expense.date
            });
        });

        const suspectedSubscriptions = [];
        Object.entries(merchantPatterns).forEach(([merchant, transactions]) => {
            if (transactions.length < 2) return;

            // Check for regular amounts
            const amounts = transactions.map(t => t.cost);
            const mostCommonAmount = this.getMostCommon(amounts);
            const regularAmountCount = amounts.filter(a => Math.abs(a - mostCommonAmount) < 0.01).length;
            
            // Check for regular intervals (approximately monthly)
            const dates = transactions.map(t => t.date).sort();
            const intervals = [];
            for (let i = 1; i < dates.length; i++) {
                const days = (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
                intervals.push(days);
            }
            
            const avgInterval = intervals.length > 0 ? intervals.reduce((a, b) => a + b, 0) / intervals.length : 0;
            const isMonthlyish = avgInterval > 25 && avgInterval < 35;
            const hasRegularInterval = intervals.every(interval => Math.abs(interval - avgInterval) < 7);

            // Check if already tracked
            const isTracked = this.recurringItems.some(item => 
                item.name.toLowerCase().includes(merchant.toLowerCase())
            );

            if (regularAmountCount >= 2 && (isMonthlyish || hasRegularInterval) && !isTracked) {
                suspectedSubscriptions.push({
                    merchant,
                    amount: mostCommonAmount,
                    confidence: (regularAmountCount / transactions.length) * 
                               (hasRegularInterval ? 1 : 0.7),
                    estimatedFrequency: Math.round(avgInterval)
                });
            }
        });

        return suspectedSubscriptions.filter(s => s.confidence > 0.6);
    }

    getMostCommon(arr) {
        const counts = {};
        arr.forEach(val => counts[val] = (counts[val] || 0) + 1);
        return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    }

    // ===================================================================
    // PREDICTIVE ANALYSIS
    // ===================================================================

    predictBudgetRisk() {
        const { thisMonth } = this.monthlyData;
        const currentDay = this.now.getDate();
        const daysInMonth = new Date(this.now.getFullYear(), this.now.getMonth() + 1, 0).getDate();
        
        const spentSoFar = thisMonth.reduce((sum, e) => sum + e.cost, 0);
        const dailyAverage = spentSoFar / currentDay;
        const projectedTotal = dailyAverage * daysInMonth;
        
        // Add upcoming recurring expenses
        const upcomingRecurring = this.getUpcomingRecurringThisMonth();
        const totalProjected = projectedTotal + upcomingRecurring;
        
        const overrunAmount = Math.max(0, totalProjected - this.monthlyBudget);
        const riskScore = this.monthlyBudget > 0 ? Math.min(1, overrunAmount / (this.monthlyBudget * 0.1)) : 0;
        
        return {
            riskScore,
            projectedSpend: totalProjected,
            projectedOverrun: overrunAmount,
            dailyBudgetRemaining: this.monthlyBudget > 0 ? 
                (this.monthlyBudget - spentSoFar) / (daysInMonth - currentDay) : 0
        };
    }

    getUpcomingRecurringThisMonth() {
        const startOfMonth = new Date(this.now.getFullYear(), this.now.getMonth(), 1);
        const endOfMonth = new Date(this.now.getFullYear(), this.now.getMonth() + 1, 0);
        
        return this.recurringItems
            .filter(item => item.status === 'active' && item.type === 'expense')
            .reduce((total, item) => {
                const nextDue = this.getNextDueDate(item, this.now);
                if (nextDue && nextDue <= endOfMonth && nextDue > this.now) {
                    return total + item.amount;
                }
                return total;
            }, 0);
    }

    getNextDueDate(recurringItem, fromDate) {
        let nextDate = new Date(recurringItem.startDate);
        
        while (nextDate <= fromDate) {
            switch (recurringItem.frequency) {
                case 'Daily': nextDate.setDate(nextDate.getDate() + 1); break;
                case 'Weekly': nextDate.setDate(nextDate.getDate() + 7); break;
                case 'Bi-Weekly': nextDate.setDate(nextDate.getDate() + 14); break;
                case 'Monthly': nextDate.setMonth(nextDate.getMonth() + 1); break;
                case 'Quarterly': nextDate.setMonth(nextDate.getMonth() + 3); break;
                case 'Annual': nextDate.setFullYear(nextDate.getFullYear() + 1); break;
            }
        }
        
        return nextDate;
    }

    analyzeCategoryTrends() {
        const { thisMonth, lastMonth } = this.monthlyData;
        
        const thisMonthByCategory = this.groupByCategory(thisMonth);
        const lastMonthByCategory = this.groupByCategory(lastMonth);
        
        const trends = [];
        Object.keys(thisMonthByCategory).forEach(category => {
            const thisTotal = thisMonthByCategory[category] || 0;
            const lastTotal = lastMonthByCategory[category] || 0;
            
            if (lastTotal > 0) {
                const change = (thisTotal - lastTotal) / lastTotal;
                if (Math.abs(change) > 0.2) { // 20% change threshold
                    trends.push({
                        category,
                        change,
                        thisMonth: thisTotal,
                        lastMonth: lastTotal,
                        direction: change > 0 ? 'increasing' : 'decreasing'
                    });
                }
            }
        });
        
        return trends.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
    }

    groupByCategory(expenses) {
        return expenses.reduce((acc, expense) => {
            acc[expense.category] = (acc[expense.category] || 0) + expense.cost;
            return acc;
        }, {});
    }

    // ===================================================================
    // RECOMMENDATION ENGINE
    // ===================================================================

    generateSmartRecommendations() {
        const recommendations = [];
        const { thisMonth } = this.monthlyData;
        
        // Coffee habit detection
        const coffeeExpenses = thisMonth.filter(e => e.name.toLowerCase().includes('coffee'));
        if (coffeeExpenses.length >= 3) {
            const coffeeTotal = coffeeExpenses.reduce((sum, e) => sum + e.cost, 0);
            recommendations.push({
                type: 'behavioral',
                priority: 'medium',
                title: 'Coffee Spending Pattern',
                description: `${coffeeExpenses.length} coffee purchases this month totaling £${coffeeTotal}. That's £${(coffeeTotal * 12).toFixed(0)} annually! Consider a coffee subscription or home brewing.`,
                icon: '☕',
                potentialSaving: coffeeTotal * 0.6,
                actionable: true,
                category: 'coffee_habit',
                action: 'Review coffee spending'
            });
        }
        
        // Same-day multiple purchases
        const expensesByDate = {};
        thisMonth.forEach(e => {
            if (!expensesByDate[e.date]) expensesByDate[e.date] = [];
            expensesByDate[e.date].push(e);
        });
        
        Object.entries(expensesByDate).forEach(([date, dayExpenses]) => {
            const sameCategoryMultiple = {};
            dayExpenses.forEach(e => {
                if (!sameCategoryMultiple[e.category]) sameCategoryMultiple[e.category] = [];
                sameCategoryMultiple[e.category].push(e);
            });
            
            Object.entries(sameCategoryMultiple).forEach(([category, expenses]) => {
                if (expenses.length > 1) {
                    const total = expenses.reduce((sum, e) => sum + e.cost, 0);
                    recommendations.push({
                        type: 'behavioral',
                        priority: 'high',
                        title: 'Multiple Same-Day Purchases',
                        description: `${expenses.length} ${category} purchases on ${date} totaling £${total}. Consider planning ahead to avoid duplicate spending.`,
                        icon: '🚨',
                        potentialSaving: total * 0.5,
                        actionable: true,
                        category: 'same_day_duplicates',
                        action: 'Plan purchases better'
                    });
                }
            });
        });
        
        // Large discretionary spending
        const largeDiscretionary = thisMonth.filter(e => 
            e.type === 'Non-Essential' && e.cost > 100
        );
        
        if (largeDiscretionary.length > 0) {
            const total = largeDiscretionary.reduce((sum, e) => sum + e.cost, 0);
            recommendations.push({
                type: 'behavioral',
                priority: 'high',
                title: 'Large Discretionary Purchases',
                description: `${largeDiscretionary.length} large non-essential purchases: ${largeDiscretionary.map(e => e.name).join(', ')} totaling £${total}. Consider a 48-hour cooling-off period for purchases over £100.`,
                icon: '💸',
                potentialSaving: total * 0.3,
                actionable: true,
                category: 'large_spending',
                action: 'Set spending limits'
            });
        }
        
        // Transport pattern analysis
        const transportExpenses = thisMonth.filter(e => e.category === 'Transport');
        if (transportExpenses.length >= 3) {
            const transportTotal = transportExpenses.reduce((sum, e) => sum + e.cost, 0);
            const avgPerTrip = transportTotal / transportExpenses.length;
            recommendations.push({
                type: 'efficiency',
                priority: 'medium',
                title: 'Regular Transport Costs',
                description: `${transportExpenses.length} transport expenses averaging £${avgPerTrip.toFixed(0)} per trip. Consider a monthly travel card or cycling for potential savings.`,
                icon: '🚌',
                potentialSaving: transportTotal * 0.2,
                actionable: true,
                category: 'transport_optimization',
                action: 'Consider travel alternatives'
            });
        }

        // Enhanced points optimization recommendations
        const pointsAnalysis = JSON.parse(localStorage.getItem('pointsAnalysis') || '{}');
        const merchantRecs = JSON.parse(localStorage.getItem('merchantRecommendations') || '[]');
        
        if (pointsAnalysis.opportunities && pointsAnalysis.opportunities.length > 0) {
            const totalMissedValue = pointsAnalysis.totalMissedValue || 0;
            const annualPotential = totalMissedValue * 12;
            const topCategory = pointsAnalysis.summary?.topRecommendation || 'Use optimized credit cards';
            
            recommendations.push({
                type: 'efficiency',
                priority: 'high',
                title: `Optimize Credit Card Usage`,
                description: `You're missing £${totalMissedValue.toFixed(2)}/month (£${annualPotential.toFixed(2)}/year) in rewards value. ${topCategory}.`,
                icon: '💳',
                potentialSaving: Math.floor(annualPotential),
                actionable: true,
                category: 'points_optimization',
                action: pointsAnalysis.summary?.quickWin || 'Use rewards cards for purchases'
            });
        }
        
        // Add merchant-specific recommendations
        if (merchantRecs.length > 0) {
            const topMerchant = merchantRecs[0];
            if (topMerchant.annualValue > 50) {
                recommendations.push({
                    type: 'efficiency',
                    priority: 'medium',
                    title: `Optimize ${topMerchant.merchant} Spending`,
                    description: `You spend £${topMerchant.monthlySpending.toFixed(2)}/month at ${topMerchant.merchant}. Using ${topMerchant.recommendedCard} could earn £${topMerchant.annualValue.toFixed(2)}/year in rewards.`,
                    icon: '🎯',
                    potentialSaving: Math.floor(topMerchant.annualValue),
                    actionable: true,
                    category: 'merchant_optimization',
                    action: `Use ${topMerchant.recommendedCard} at ${topMerchant.merchant}`
                });
            }
        }
        
        // DEDUPLICATION LOGIC - Add this instead of the simple return
        const deduplicatedRecommendations = [];
        const groupedByType = new Map();

        recommendations.forEach(rec => {
            const key = `${rec.type}_${rec.category}`;
            if (!groupedByType.has(key)) {
                groupedByType.set(key, rec);
            } else {
                // If similar recommendation exists, combine the savings
                const existing = groupedByType.get(key);
                existing.potentialSaving += rec.potentialSaving;
            }
        });

        return Array.from(groupedByType.values())
            .sort((a, b) => {
                const priorityOrder = { urgent: 4, high: 3, medium: 2, low: 1 };
                return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
            })
            .slice(0, 8); // Limit to top 8 recommendations
    }

    prioritizeRecommendations(recommendations) {
        return recommendations
            .map(rec => ({
                ...rec,
                score: this.calculatePriorityScore(rec)
            }))
            .sort((a, b) => b.score - a.score)
            .slice(0, 6);
    }

    calculatePriorityScore(rec) {
        const priorityWeight = {
            'urgent': 100,
            'high': 75,
            'medium': 50,
            'low': 25
        }[rec.priority] || 25;
        
        const savingsScore = Math.min(50, (rec.potentialSaving || 0) / 2);
        const typeBonus = {
            'urgent': 25,
            'behavioral': 15,
            'efficiency': 20,
            'organization': 10,
            'trend': 15
        }[rec.type] || 0;
        
        return priorityWeight + savingsScore + typeBonus;
    }

    generate7DayForecast() {
        try {
            const forecast = [];
            const today = new Date();
            
            for (let i = 1; i <= 7; i++) {
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + i);
                
                const dayName = targetDate.toLocaleDateString('en-GB', { weekday: 'short' });
                const dayOfWeek = targetDate.getDay();
                
                const prediction = this.predictDaySpending(dayOfWeek, targetDate);
                
                forecast.push({
                    date: `${dayName} ${targetDate.getDate()}`,
                    predicted: prediction.amount,
                    confidence: prediction.confidence,
                    reasoning: prediction.reasoning,
                    hasRecurring: prediction.hasRecurring
                });
            }
            
            return forecast;
        } catch (error) {
            console.error('7-day forecast error:', error);
            return [];
        }
    }

    predictDaySpending(dayOfWeek, date) {
        try {
            const dateNum = date.getDate();
            
            // Check for recurring expenses on this day
            const recurringForDay = this.recurringItems.filter(item => {
                if (item.status !== 'active') return false;
                
                const daysDiff = Math.floor((date - new Date(item.startDate)) / (1000 * 60 * 60 * 24));
                
                switch(item.frequency) {
                    case 'weekly': return daysDiff % 7 === 0;
                    case 'monthly': return date.getDate() === new Date(item.startDate).getDate();
                    case 'daily': return true;
                    default: return false;
                }
            });
            
            const recurringAmount = recurringForDay.reduce((sum, item) => sum + item.amount, 0);
            
            if (recurringAmount > 0) {
                return {
                    amount: recurringAmount,
                    confidence: 90,
                    reasoning: `${recurringForDay.length} scheduled recurring expense(s)`,
                    hasRecurring: true
                };
            }
            
            // Historical pattern analysis
            const sameDayOfWeekExpenses = this.processedExpenses.filter(e => 
                e.dayOfWeek === dayOfWeek && !e.isRecurring
            );
            
            const sameDateExpenses = this.processedExpenses.filter(e => 
                e.date.getDate() === dateNum && !e.isRecurring
            );
            
            const recentExpenses = this.processedExpenses.filter(e => {
                const daysDiff = Math.floor((this.now - e.date) / (1000 * 60 * 60 * 24));
                return daysDiff <= 30 && e.dayOfWeek === dayOfWeek && !e.isRecurring;
            }).slice(0, 10);
            
            let avgSpending = 0;
            let confidence = 25;
            let reasoning = 'Limited historical data';
            
            if (recentExpenses.length >= 3) {
                avgSpending = recentExpenses.reduce((sum, e) => sum + e.cost, 0) / recentExpenses.length;
                confidence = Math.min(85, 25 + (recentExpenses.length * 8));
                reasoning = `Based on ${recentExpenses.length} recent similar days`;
            } else if (sameDayOfWeekExpenses.length >= 2) {
                avgSpending = sameDayOfWeekExpenses.reduce((sum, e) => sum + e.cost, 0) / sameDayOfWeekExpenses.length;
                confidence = Math.min(65, 25 + (sameDayOfWeekExpenses.length * 5));
                reasoning = `Based on ${sameDayOfWeekExpenses.length} similar weekdays`;
            } else if (sameDateExpenses.length >= 1) {
                avgSpending = sameDateExpenses.reduce((sum, e) => sum + e.cost, 0) / sameDateExpenses.length;
                confidence = Math.min(50, 25 + (sameDateExpenses.length * 10));
                reasoning = `Based on ${sameDateExpenses.length} similar date(s)`;
            }
            
            return {
                amount: avgSpending,
                confidence: Math.round(confidence),
                reasoning,
                hasRecurring: false
            };
        } catch (error) {
            return { amount: 0, confidence: 20, reasoning: 'Unable to predict', hasRecurring: false };
        }
    }

    generateMonthlyStory() {
        try {
            const { thisMonth } = this.monthlyData;
            const totalSpent = thisMonth.reduce((sum, e) => sum + e.cost, 0);
            
            if (totalSpent === 0) {
                return {
                    story: "Add some expenses to see your personalized financial insights.",
                    metrics: null
                };
            }
            
            // Calculate actual top category
            const categoryTotals = {};
            thisMonth.forEach(expense => {
                const cat = expense.category || 'Other';
                categoryTotals[cat] = (categoryTotals[cat] || 0) + expense.cost;
            });
            
            // Get the actual top category
            let topCategory = 'Various';
            if (Object.keys(categoryTotals).length > 0) {
                const topCategoryEntry = Object.entries(categoryTotals)
                    .sort(([,a], [,b]) => b - a)[0];
                
                const topCategorySpending = topCategoryEntry[1];
                const topCategoryPercentage = (topCategorySpending / totalSpent) * 100;
                
                // Only show specific category if it represents >30% of spending
                if (topCategoryPercentage > 30) {
                    topCategory = topCategoryEntry[0];
                } else {
                    topCategory = 'Diversified spending';
                }
            }
            
            const totalIncome = this.monthlyIncome + this.getMonthlyRecurringIncome();
            const savingsRate = totalIncome > 0 ? ((totalIncome - totalSpent) / totalIncome) * 100 : 0;
            
            const spendingDays = new Set(thisMonth.map(e => e.date.getDate())).size;
            
            let story = `This month you've spent <strong>${formatCurrency(totalSpent)}</strong> across ${spendingDays} days. `;
            
            if (savingsRate > 15) {
                story += `Excellent <strong>${savingsRate.toFixed(0)}% savings rate</strong>! `;
            } else if (savingsRate > 0) {
                story += `Good <strong>${savingsRate.toFixed(0)}% savings rate</strong>. `;
            } else {
                story += `Your spending is currently above your tracked income. `;
            }
            
            // Add category insight
            if (topCategory !== 'Various' && topCategory !== 'Diversified spending') {
                story += `Your top spending category is <strong>${topCategory}</strong>.`;
            } else {
                story += `You have <strong>well-diversified spending</strong> across categories.`;
            }
            
            const metrics = {
                savingsRate: savingsRate.toFixed(0),
                topCategory: topCategory,
                spendingDays: spendingDays
            };
            
            return { story, metrics };
        } catch (error) {
            return { story: "Unable to generate story", metrics: null };
        }
    }

    getMonthlyRecurringIncome() {
        try {
            return this.recurringItems
                .filter(item => item.status === 'active' && item.type === 'income')
                .reduce((total, item) => total + item.amount, 0);
        } catch (error) {
            return 0;
        }
    }
}

// ===================================================================
// INTEGRATION FUNCTIONS - Drop-in replacements
// ===================================================================

function updateAiInsightsWithSmartAnalytics() {
    console.log('Starting smart analytics update...');
    
    showInsightsLoading();
    
    setTimeout(() => {
        try {
            console.log('Data check:', {
                expensesCount: expenses?.length || 0,
                recurringCount: recurringItems?.length || 0,
                budget: monthlyBudget,
                income: monthlyIncome
            });
            
            const insights = new LensSmartInsights(
                expenses || [], 
                recurringItems || [], 
                monthlyBudget || 0, 
                monthlyIncome || 0
            );
            
            const forecast = insights.generate7DayForecast();
            const recommendations = insights.generateSmartRecommendations();
            const monthlyStory = insights.generateMonthlyStory();
            const budgetRisk = insights.predictBudgetRisk();
            
            renderSmart7DayForecast(forecast);
            renderSmartRecommendations(recommendations);
            renderSmartMonthlyStory(monthlyStory);
            renderMonthEndProjectionSmart(budgetRisk);
            
            // Add enhanced points optimization insights and update combined badge
            renderEnhancedInsights();
            
            // Update badge with combined count
            const pointsAnalysis = JSON.parse(localStorage.getItem('pointsAnalysis') || '{"opportunities": []}');
            const totalRecommendations = recommendations.length + pointsAnalysis.opportunities.length;
            updateRecommendationBadge(totalRecommendations);
            
        } catch (error) {
            console.error('Smart analytics error:', error);
            showInsightsError();
        }
    }, 500);
}

// UI Rendering Functions
function showInsightsLoading() {
    const containers = [
        'seven-day-forecast',
        'smart-recommendations', 
        'monthly-story',
        'month-end-projection'
    ];
    
    containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = `
                <div class="flex justify-center items-center p-6">
                    <div class="ai-loading"></div>
                    <span class="ml-3 text-sm text-gray-500">Analyzing your spending patterns...</span>
            </div>
            `;
        }
    });
}

function renderSmart7DayForecast(forecast) {
    const container = document.getElementById('seven-day-forecast');
    if (!container) return;
    
    if (forecast.length === 0) {
        container.innerHTML = `
            <div class="text-center p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    Add more expenses to generate spending predictions
                </p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="grid grid-cols-2 gap-3 text-sm">
            ${forecast.map(day => {
                // Calculate confidence level text
                const confidenceLevel = day.confidence >= 80 ? 'High' : 
                                       day.confidence >= 50 ? 'Medium' : 'Low';
                
                return `
                    <div class="flex flex-col bg-white dark:bg-gray-800 p-4 rounded-md shadow border border-gray-100 dark:border-gray-700">
                        <span class="font-medium text-gray-800 dark:text-gray-200">${day.date}</span>
                        <span class="font-semibold self-end ${day.predicted > 0 ? 'text-red-500' : 'text-gray-400'} text-lg">
                            ${day.predicted > 0 ? formatCurrency(day.predicted) : '£0'}
                        </span>
                        <span class="text-xs text-gray-500 mt-1">${confidenceLevel} confidence</span>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function renderSmartRecommendations(recommendations) {
    const container = document.getElementById('smart-recommendations');
    if (!container) return;
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="text-center p-6">
                <div class="text-4xl mb-3">🎉</div>
                <div class="font-medium text-gray-800 dark:text-gray-200 mb-2">All looking good!</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    No urgent recommendations right now. Keep up the great work!
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recommendations.map(rec => {
        const priorityColors = {
            'urgent': 'border-red-500 bg-red-50 dark:bg-red-900/20',
            'high': 'border-orange-500 bg-orange-50 dark:bg-orange-900/20',
            'medium': 'border-blue-500 bg-blue-50 dark:bg-blue-900/20',
            'low': 'border-gray-500 bg-gray-50 dark:bg-gray-900/20'
        };
        
        const priorityBadgeColors = {
            'urgent': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
            'high': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
            'medium': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
            'low': 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200'
        };
        
        return `
            <div class="p-4 rounded-lg border-l-4 ${priorityColors[rec.priority]} hover:shadow-md transition-shadow cursor-pointer" 
                 onclick="handleRecommendationClick('${rec.category}', ${JSON.stringify(rec).replace(/"/g, '&quot;')})">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${rec.icon}</span>
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">${rec.title}</h4>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full ${priorityBadgeColors[rec.priority]}">
                        ${rec.priority}
                    </span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 leading-relaxed">${rec.description}</p>
             <div class="flex justify-between items-center">
                    <div class="text-xs text-gray-500">
                        ${rec.potentialSaving > 0 ? `💰 Potential saving: <strong>${formatCurrency(rec.potentialSaving)}</strong>` : '📊 Organization improvement'}
            </div>
                    <div class="text-xs bg-white dark:bg-gray-800 px-2 py-1 rounded border hover:bg-gray-50 dark:hover:bg-gray-700">
                        Take Action →
                    </div>
                </div>
        </div>
    `;
    }).join('');
}

function renderSmartMonthlyStory(storyData) {
    const container = document.getElementById('monthly-story');
    const metricsContainer = document.getElementById('story-metrics');
    
    if (!container) return;
    
    container.innerHTML = `
        <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
            ${storyData.story}
        </div>
    `;
    
    if (metricsContainer && storyData.metrics) {
        metricsContainer.innerHTML = `
            <div class="metric-card">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Savings Rate</p>
                <p class="text-lg font-bold ${parseFloat(storyData.metrics.savingsRate) >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                    ${storyData.metrics.savingsRate}%
                </p>
            </div>
            <div class="metric-card">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Top Category</p>
                <p class="text-lg font-bold text-gray-800 dark:text-gray-200 truncate">${storyData.metrics.topCategory}</p>
            </div>
            <div class="metric-card">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Active Days</p>
                <p class="text-lg font-bold text-gray-800 dark:text-gray-200">${storyData.metrics.spendingDays}</p>
            </div>
        `;
        metricsContainer.classList.remove('hidden');
        metricsContainer.classList.add('grid', 'grid-cols-3', 'gap-2', 'mt-4', 'text-center');
    }
}

function renderMonthEndProjectionSmart(budgetRisk) {
    const container = document.getElementById('month-end-projection');
    if (!container) return;
    
    const riskLevel = budgetRisk.riskScore > 0.8 ? 'high' : budgetRisk.riskScore > 0.5 ? 'medium' : 'low';
    const riskColors = {
        'high': 'text-red-600 dark:text-red-400',
        'medium': 'text-yellow-600 dark:text-yellow-400', 
        'low': 'text-green-600 dark:text-green-400'
    };
    
    const totalIncome = monthlyIncome + (recurringItems?.filter(r => r.type === 'income' && r.status === 'active').reduce((sum, r) => sum + r.amount, 0) || 0);
    const projectedSavings = totalIncome - budgetRisk.projectedSpend;
    
    container.innerHTML = `
        <div class="space-y-4">
            <div class="text-center p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Projected Monthly Spending</p>
                <p class="text-2xl font-bold text-gray-800 dark:text-gray-200">${formatCurrency(budgetRisk.projectedSpend)}</p>
                <p class="text-xs font-medium mt-1 ${riskColors[riskLevel]}">
                    ${riskLevel === 'high' ? '⚠️ Budget Risk' : riskLevel === 'medium' ? '⚡ Watch Closely' : '✅ On Track'}
                </p>
            </div>
            
            ${budgetRisk.riskScore > 0.6 ? `
                <div class="p-3 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500">
                    <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Daily Budget Alert</p>
                    <p class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">
                        Limit spending to ${formatCurrency(budgetRisk.dailyBudgetRemaining)}/day to stay on budget
                    </p>
                </div>
            ` : ''}
            
            <div class="text-center">
                <p class="text-sm text-gray-600 dark:text-gray-400">Projected Savings</p>
                <p class="text-xl font-bold ${projectedSavings >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                    ${formatCurrency(projectedSavings)}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                    Based on current spending velocity
                </p>
            </div>
        </div>
    `;
}

function updateRecommendationBadge(count) {
    const badge = document.getElementById('action-count');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}

function handleRecommendationClick(category, recommendation) {
    // Get the recommendation element to remove it
    const clickedElement = event.target.closest('.border-l-4');
    
    if (clickedElement) {
        // Visual feedback - fade out the card
        clickedElement.style.transition = 'opacity 0.3s ease';
        clickedElement.style.opacity = '0.5';
        
        // Update the recommendation count badge
        const badge = document.getElementById('action-count');
        const currentCount = parseInt(badge.textContent) || 0;
        const newCount = Math.max(0, currentCount - 1);
        
        if (newCount > 0) {
            badge.textContent = newCount;
        } else {
            badge.classList.add('hidden');
        }
        
        // Remove the card after animation
        setTimeout(() => {
            clickedElement.remove();
            
            // Check if this was the last recommendation
            const remainingRecs = document.querySelectorAll('#smart-recommendations .border-l-4');
            if (remainingRecs.length === 0) {
                document.getElementById('smart-recommendations').innerHTML = `
                    <div class="text-center p-6">
                        <div class="text-4xl mb-3">🎉</div>
                        <div class="font-medium text-gray-800 dark:text-gray-200 mb-2">All recommendations handled!</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            Keep up the great work! New recommendations will appear as your spending patterns change.
                        </div>
                    </div>
                `;
            }
        }, 300);
    }
    
    // Handle different recommendation actions with better feedback
    switch(category) {
        case 'weekend_control':
            showToast('💡 Tip: Try setting a weekend spending limit in Settings', 'success');
            break;
        case 'impulse_control':
            showToast('💡 Tip: Wait 24 hours before making non-essential purchases over £30', 'success');
            break;
        case 'same_day_duplicates':
            showToast('💡 Tip: Plan your shopping trips to avoid multiple same-day purchases', 'success');
            break;
        case 'large_spending':
            showToast('💡 Tip: Consider a 48-hour cooling-off period for purchases over £100', 'success');
            break;
        case 'transport_optimization':
            showToast('💡 Tip: Look into monthly travel cards or alternative transport methods', 'success');
            break;
        case 'points_optimization':
            showToast('💡 Tip: Check your credit card rewards categories for optimal usage', 'success');
            break;
        case 'subscription_tracking':
            showRecurringForm();
            break;
        case 'budget_risk':
            openSettings('budget');
            break;
        default:
            showToast('✅ Recommendation noted!', 'success');
    }
}

function showInsightsError() {
    const containers = ['seven-day-forecast', 'smart-recommendations', 'monthly-story', 'month-end-projection'];
    containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <p class="text-sm text-red-500">Unable to generate insights. Please try again.</p>
                </div>
            `;
        }
    });
}
        // --- Utility Functions ---
        function debugExpenseData() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const thisMonthExpenses = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            const recurringExpenses = thisMonthExpenses.filter(e => e.recurringSourceId);
            const oneTimeExpenses = thisMonthExpenses.filter(e => !e.recurringSourceId);
            
            console.log('=== EXPENSE DATA DEBUG ===');
            console.log('Total this month:', thisMonthExpenses.length);
            console.log('One-time expenses:', oneTimeExpenses.length);
            console.log('Recurring expenses:', recurringExpenses.length);
            console.log('Total amount:', thisMonthExpenses.reduce((sum, e) => sum + e.cost, 0));
            console.log('Recurring items in system:', recurringItems.length);

        return {
                total: thisMonthExpenses.length,
                oneTime: oneTimeExpenses.length,
                recurring: recurringExpenses.length,
                amount: thisMonthExpenses.reduce((sum, e) => sum + e.cost, 0)
            };
        }

        function categorizeChanges(oldItem, newItem) {
            const changes = {
                safe: [],      // amount, name, category, paymentMethod
                schedule: [],  // frequency, startDate, endDate
                structural: [] // type, essentialType
            };
            
            const safeFields = ['name', 'amount', 'category', 'paymentMethod'];
            const scheduleFields = ['frequency', 'startDate', 'endDate'];
            const structuralFields = ['type', 'essentialType'];
            
            Object.keys(newItem).forEach(key => {
                if (oldItem[key] !== newItem[key]) {
                    if (safeFields.includes(key)) {
                        changes.safe.push(key);
                    } else if (scheduleFields.includes(key)) {
                        changes.schedule.push(key);
                    } else if (structuralFields.includes(key)) {
                        changes.structural.push(key);
                    }
                }
            });
            
            return changes;
        }

        function updateExpensesFromCurrentMonth(recurringItem) {
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            let updatedCount = 0;
            let preservedCount = 0;
            
            expenses.forEach(expense => {
                if (expense.recurringSourceId === recurringItem.id) {
                    const expenseDate = new Date(expense.date);
                    
                    if (expenseDate >= currentMonthStart) {
                        // Update current month and future expenses
                        expense.name = recurringItem.name;
                        expense.cost = recurringItem.amount;
                        expense.category = recurringItem.category;
                        expense.type = recurringItem.essentialType || 'Non-Essential';
                        expense.paymentMethod = recurringItem.paymentMethod;
                        updatedCount++;
                    } else {
                        // Count preserved past expenses
                        preservedCount++;
                    }
                }
            });
            
            return { updatedCount, preservedCount };
        }

        function handleScheduleChanges(oldItem, newItem) {
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Count what we're about to remove
            const removedCount = expenses.filter(e => 
                e.recurringSourceId === oldItem.id && 
                new Date(e.date) >= currentMonthStart
            ).length;
            
            const preservedCount = expenses.filter(e => 
                e.recurringSourceId === oldItem.id && 
                new Date(e.date) < currentMonthStart
            ).length;
            
            // Remove future expenses (keep past ones intact)
            expenses = expenses.filter(e => {
                if (e.recurringSourceId !== oldItem.id) {
                    return true; // Keep non-related expenses
                }
                
                const expenseDate = new Date(e.date);
                return expenseDate < currentMonthStart; // Keep past expenses only
            });
            
            return { removedCount, preservedCount };
        }

        function saveRecurring() {
            const type = DOMElements.recurringItemType.value;
            const name = DOMElements.recurringName.value.trim();
            const amount = parseFloat(DOMElements.recurringAmount.value);
            const startDate = DOMElements.recurringStartDate.value;
            const endDate = DOMElements.recurringEndDate.value || null;

            if (!name || isNaN(amount) || amount <= 0 || !startDate) {
                 showToast('Please fill in recurring item fields correctly.', 'error');
                return;
            }

            const recurringItem = {
                id: editingRecurring ? editingRecurring.id : Date.now(),
                type: type,
                name: name,
                amount: amount,
                frequency: DOMElements.recurringFrequency.value,
                category: DOMElements.recurringCategory.value,
                essentialType: type === 'expense' ? DOMElements.recurringEssentialType.value : null,
                paymentMethod: DOMElements.recurringPaymentMethod.value,
                startDate: startDate,
                endDate: endDate,
                status: 'active'
            };

            if (editingRecurring) {
                const oldRecurring = editingRecurring;
                const changes = categorizeChanges(oldRecurring, recurringItem);
                
                // Update the recurring item first
                const index = recurringItems.findIndex(r => r.id === editingRecurring.id);
                if (index !== -1) {
                    recurringItems[index] = recurringItem;
                    
                    // Determine how to handle the update
                    if (changes.schedule.length > 0 || changes.structural.length > 0) {
                        // Schedule or structural changes: regenerate from current month
                        const result = handleScheduleChanges(oldRecurring, recurringItem);
                        
                        showToast(
                            `Recurring ${type} '${name}' updated! ` +
                            `${result.preservedCount} past expense(s) preserved, ` +
                            `${result.removedCount} current/future expense(s) will be regenerated.`
                        );
                    } else if (changes.safe.length > 0) {
                        // Safe changes: update current month + future only
                        const result = updateExpensesFromCurrentMonth(recurringItem);
                        
                        let message = `Recurring ${type} '${name}' updated!`;
                        if (result.updatedCount > 0) {
                            message += ` ${result.updatedCount} current/future expense(s) updated.`;
                        }
                        if (result.preservedCount > 0) {
                            message += ` ${result.preservedCount} past expense(s) preserved.`;
                        }
                        
                        showToast(message);
                    } else {
                        // No relevant changes
                        showToast(`Recurring ${type} '${name}' updated!`);
                    }
                }
            } else {
                // Adding new recurring item
                recurringItems.push(recurringItem);
                showToast(`Recurring ${type} '${name}' saved successfully!`);
            }
            
    saveData();
            
            // Fix: Force immediate processing and update
            processRecurringExpenses();
    updateDisplay();
            
            closeRecurringModal();
        }

        // Enhanced Mobile Rendering Functions

        // Category to icon mapping
        const categoryIcons = {
            "Housing": "🏠", "Utilities": "💡", "Transport": "🛍️", "Food/Drink": "🍔",
            "Entertainment": "🎬", "Shopping": "🛍️", "Health": "❤️", "Personal Care": "🧴",
            "Education": "🎓", "Debt": "💳", "Subscriptions": "🔁", "Other": "❔",
            "Salary": "💰", "Bonus": "⭐", "Investment": "📈", "Gift": "🎁", "Other Income": "🪙"
        };

        // DEPRECATED: Enhanced renderExpensesTable function (replaced with paginated version)
        function renderExpensesTable_NEW_DEPRECATED() {
            let allExpenses = [...expenses];

            // Apply filters (existing filter logic)
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            const filteredExpenses = allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                
                if (typeFilter) {
                    if (typeFilter === 'Recurring') {
                        if (!e.recurringSourceId) passes = false;
                    } else {
                        if (e.type !== typeFilter) passes = false;
                    }
                }

                return passes;
            });

            // Sort expenses by date (newest first)
            filteredExpenses.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                const getNumericId = (id) => {
                    if (typeof id === 'string') {
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return id;
                };
                
                return getNumericId(b.id) - getNumericId(a.id);
            });

            const tableBody = DOMElements.expensesTableBody;
            
            if (filteredExpenses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500 dark:text-gray-400">No expenses match your filters.</td></tr>`;
                return;
            }

            // Check if we're on mobile (using more reliable detection)
            const isMobile = window.innerWidth <= 768 || /Mobi|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Hide the desktop table structure for mobile
                const tableContainer = tableBody.closest('table');
                if (tableContainer) {
                    tableContainer.style.display = 'none';
                }
                
                // Create or get mobile container
                let mobileContainer = document.getElementById('mobile-expenses-container');
                if (!mobileContainer) {
                    mobileContainer = document.createElement('div');
                    mobileContainer.id = 'mobile-expenses-container';
                    mobileContainer.className = 'block md:hidden p-2 sm:p-4';
                    tableBody.closest('.card').appendChild(mobileContainer);
                }
                
                renderMobileExpenseCards(filteredExpenses, mobileContainer);
                
                // Show mobile container
                mobileContainer.style.display = 'block';
            } else {
                // Show desktop table
                const tableContainer = tableBody.closest('table');
                if (tableContainer) {
                    tableContainer.style.display = 'table';
                }
                
                // Hide mobile container
                const mobileContainer = document.getElementById('mobile-expenses-container');
                if (mobileContainer) {
                    mobileContainer.style.display = 'none';
                }
                
                renderDesktopExpenseTable(filteredExpenses, tableBody);
            }
        }

        function renderMobileExpenseCards(expenses, container) {
            if (!expenses || expenses.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-500 dark:text-gray-400">No expenses to display.</div>`;
                return;
            }

            const grouped = expenses.reduce((groups, expense) => {
                const date = (expense.date || '').split('T')[0];
                if (!date) return groups;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(expense);
                return groups;
            }, {});

            let html = '';

            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(date => {
                const dayExpenses = grouped[date];
                const dayTotal = dayExpenses.reduce((sum, exp) => sum + exp.cost, 0);

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const expenseDate = new Date(date + 'T00:00:00');

                let dateLabel;
                if (expenseDate.getTime() === today.getTime()) {
                    dateLabel = 'Today';
                } else if (expenseDate.getTime() === yesterday.getTime()) {
                    dateLabel = 'Yesterday';
                } else {
                    dateLabel = expenseDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' });
                }

                html += `
                    <div class="mobile-date-header" style="padding: 16px 8px 4px 8px; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${dateLabel}</span>
                            <span>-${formatCurrency(dayTotal, false)}</span>
                        </div>
                    </div>`;

                dayExpenses.forEach(expense => {
                    const categoryIcon = categoryIcons[expense.category] || categoryIcons['Other'];
                    const isRecurringInstance = !!expense.recurringSourceId;
                    const originalRecurringItem = isRecurringInstance ? recurringItems.find(r => r.id === expense.recurringSourceId) : null;
                    const editAction = isRecurringInstance && originalRecurringItem ? `editRecurring(${originalRecurringItem.id})` : `editExpense(${expense.id})`;

                    html += `
                        <div onclick="${editAction}" class="mobile-card">
                            <div class="mobile-card-icon">${categoryIcon}</div>
                            <div class="mobile-card-main">
                                <div class="mobile-card-title">${escapeHTML(expense.name)}</div>
                                <div class="mobile-card-subtitle">${escapeHTML(expense.category)}</div>
                            </div>
                            <div class="mobile-card-amount">-${formatCurrency(expense.cost)}</div>
                        </div>
                    `;
                    });
                });

            container.innerHTML = html;
        }

        function renderDesktopExpenseTable(expenses, container) {
            // Keep existing desktop table rendering logic
            container.innerHTML = expenses.map(expense => {
                const isRecurringInstance = !!expense.recurringSourceId;
                const isCancelled = expense.status === 'cancelled';
                const originalRecurringItem = isRecurringInstance ? 
                    recurringItems.find(r => r.id === expense.recurringSourceId) : null;

                let editAction = `editExpense(${expense.id})`;
                if (isRecurringInstance && originalRecurringItem) {
                    editAction = `editRecurring(${originalRecurringItem.id})`;
                }
                
                const deleteAction = isRecurringInstance ? 'return false;' : `deleteExpense(${expense.id})`;
                const checkboxId = `expense-${expense.id}`;

                const formattedDate = new Date(expense.date).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                return `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${isCancelled ? 'opacity-60' : ''}"
                        data-category="${expense.category}">
                        <td class="px-4 py-3" data-label="">
                            <input type="checkbox" id="${checkboxId}" data-id="${expense.id}" 
                                   onchange="toggleExpenseSelection(this, '${expense.id}')" 
                                   class="table-checkbox expense-checkbox" 
                                   ${isRecurringInstance ? 'disabled' : ''} 
                                   ${selectedExpenseIds.has(expense.id.toString()) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap" data-label="Name">
                            <span>${escapeHTML(expense.name)}</span>${isRecurringInstance ? '<span class="text-xs text-gray-400 ml-1">(R)</span>' : ''}
                        </td>
                        <td class="px-6 py-3" data-label="Amount">${formatCurrency(expense.cost)}</td>
                        <td class="px-6 py-3" data-label="Date">${formattedDate}</td>
                        <td class="px-6 py-3 hidden md:table-cell" data-label="Category">${escapeHTML(expense.category)}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Payment Method">${escapeHTML(expense.paymentMethod) || '-'}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Type">${escapeHTML(expense.type)}</td>
                        <td class="px-6 py-3 text-right" data-label="Actions">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="${editAction}" title="Edit" class="icon-button" 
                                        ${isCancelled ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button onclick="${deleteAction}" title="Delete" 
                                        class="icon-button text-red-600/80 hover:text-red-500" 
                                        ${isRecurringInstance ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function groupExpensesByDate(expenses) {
            return expenses.reduce((groups, expense) => {
                const date = expense.date;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(expense);
                return groups;
            }, {});
        }

        // DEPRECATED: Enhanced recurring table rendering for mobile (replaced with paginated version)
        function renderRecurringTable_NEW_DEPRECATED() {
            DOMElements.recurringTableBody.innerHTML = '';
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;

            let filtered = recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });

            filtered.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            if (filtered.length === 0) {
                DOMElements.recurringTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                return;
            }

            const isMobile = window.innerWidth <= 640;
            
            if (isMobile) {
                renderMobileRecurringList(filtered, DOMElements.recurringTableBody);
            } else {
                renderDesktopRecurringTable(filtered, DOMElements.recurringTableBody);
            }
        }

        function renderMobileRecurringList(items, container) {
            if (items.length === 0) {
                container.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                return;
            }
            let html = '';
            items.forEach(item => {
                const isCancelled = item.status === 'cancelled';
                const typeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                 html += `
                    <div onclick="editRecurring(${item.id})" class="mobile-card ${isCancelled ? 'opacity-60' : ''}">
                         <div class="mobile-card-icon">${categoryIcons[item.category] || categoryIcons['Other']}</div>
                         <div class="mobile-card-main">
                            <p class="mobile-card-title">${escapeHTML(item.name)}</p>
                            <div class="mobile-card-subtitle">
                                <span>${item.type === 'income' ? 'Income' : 'Expense'}</span>
                                &middot;
                                <span>${item.frequency}</span>
                            </div>
                         </div>
                         <div class="text-right">
                            <p class="mobile-card-amount ${typeClass}">${formatCurrency(item.amount)}</p>
                            <p class="text-xs text-gray-400">${item.status === 'active' ? 'Active' : 'Cancelled'}</p>
                         </div>
                    </div>
                `;
            });
            container.innerHTML = `<td colspan="8" style="padding: 0;">${html}</td>`;
        }

        function renderDesktopRecurringTable(items, container) {
            // Existing desktop recurring table logic
            items.forEach(item => {
                const tr = document.createElement('tr');
                const isSelected = selectedRecurringIds.has(item.id);
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${item.status === 'cancelled' ? 'opacity-60' : ''} ${isSelected ? 'bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800'}`;
                const itemTypeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

                const formattedStartDate = new Date(item.startDate).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                tr.innerHTML = `
                    <td class="px-4 py-4 w-1" data-label="">
                        <input type="checkbox" data-id="${item.id}" onchange="toggleRecurringSelection(this, ${item.id})" class="table-checkbox recurring-checkbox" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white" data-label="Name">${escapeHTML(item.name)}</td>
                    <td class="px-6 py-4 capitalize" data-label="Type">${item.type}</td>
                    <td class="px-6 py-4 font-medium ${itemTypeClass}" data-label="Amount">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4" data-label="Frequency">${item.frequency}</td>
                    <td class="px-6 py-4" data-label="Start Date">${formattedStartDate}</td>
                    <td class="px-6 py-4 hidden lg:table-cell" data-label="Category">${escapeHTML(item.category)}</td>
                    <td class="px-6 py-4" data-label="Status">
                        <span class="status-badge ${item.status === 'active' ? 'status-active' : 'status-cancelled'}">${item.status}</span>
                    </td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap" data-label="Actions">
                        <button onclick="editRecurring(${item.id})" class="icon-button" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button onclick="toggleRecurringStatus(${item.id})" class="icon-button" title="${item.status === 'active' ? 'Pause' : 'Resume'}">
                           ${item.status === 'active' ? 
                               '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : 
                               '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                           }
                        </button>
                        <button onclick="deleteRecurring(${item.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                container.appendChild(tr);
            });
        }

      // Add responsive behavior
      function handleResize() {
          if (activeTab === 'expenses') {
                renderExpensesTable();
          } else if (activeTab === 'recurring') {
                renderRecurringTable();
          }
      }

      /**
       * Window resize handler with debouncing
       * Optimizes performance by limiting resize event frequency
       */
      let resizeTimeout;
      window.addEventListener('resize', function() {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(handleResize, 250);
      });

        // Enhanced updateTableLabels function for better mobile support
        function updateTableLabels_NEW() {
            document.querySelectorAll('table').forEach(tbl => {
                const headers = Array.from(tbl.querySelectorAll('thead th'))
                             .map(th => th.textContent.trim());

                tbl.querySelectorAll('tbody tr').forEach(row => {
                    Array.from(row.children).forEach((cell, idx) => {
                        if (!cell.hasAttribute('data-label')) {
                            cell.setAttribute('data-label', headers[idx] || '');
                        }
                        
                        // Add category data attribute for styling
                        if (headers[idx] === 'Category' && cell.textContent.trim()) {
                            row.setAttribute('data-category', cell.textContent.trim());
                        }
                        
                        // Add recurring data attribute
                        if (headers[idx] === 'Status' && cell.textContent.includes('Recurring')) {
                            row.setAttribute('data-recurring', 'true');
                        }
                        
                        // Add time data for mobile meta display
                        if (headers[idx] === 'Date' && cell.textContent.trim()) {
                            const timeAttr = '12:00'; // Default time since we don't store time
                            row.querySelector('td[data-label="Name"]')?.setAttribute('data-time', timeAttr);
                        }
                        
                        // Add icon data attribute based on category
                        if (headers[idx] === 'Category' && cell.textContent.trim()) {
                            const category = cell.textContent.trim();
                            const icon = categoryIcons[category] || categoryIcons['Other'];
                            const iconCell = row.querySelector('td:nth-child(2)');
                            if (iconCell) {
                                iconCell.setAttribute('data-icon', icon);
                            }
                        }
                    });
                });
            });
        }
    </script>

    <!-- === Lens Card Labels Script START === -->
    <script>
      function updateTableLabels() {
        document.querySelectorAll('table').forEach(tbl => {
          const headers = Array.from(tbl.querySelectorAll('thead th'))
                               .map(th => th.textContent.trim());

          tbl.querySelectorAll('tbody tr').forEach(row => {
            Array.from(row.children).forEach((cell, idx) => {
              if (!cell.hasAttribute('data-label')) {
                cell.setAttribute('data-label', headers[idx] || '');
              }
            });
          });
        });
      }
      
      document.addEventListener('DOMContentLoaded', updateTableLabels);
    </script>
    <!-- === Lens Card Labels Script END === -->

    <!-- Enhanced Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <button id="mobile-tab-overview" onclick="showTab('overview')" class="bottom-nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            <span>Overview</span>
        </button>
        <button id="mobile-tab-expenses" onclick="showTab('expenses')" class="bottom-nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.293 2.293c-.63.63-.184 1.707.707 1.707H19M7 13v4a2 2 0 002 2h8a2 2 0 002-2v-4m-8 6a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z" />
            </svg>
            <span>Expenses</span>
        </button>
        <button id="mobile-tab-recurring" onclick="showTab('recurring')" class="bottom-nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
                <circle cx="8" cy="16" r="2"/>
                <path d="M16 14v6"/>
            </svg>
            <span>Recurring</span>
        </button>
        <button id="mobile-tab-insights" onclick="showTab('insights')" class="bottom-nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
            <span>Insights</span>
        </button>
    </nav>
    
    <!-- Floating Quick Add Button -->
    <button class="floating-quick-add" onclick="showAddForm()" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>

<!-- Mobile View Rewrite (auto-generated) -->
<script>
// <![CDATA[
/* =============================================================
   Mobile View Rewrite for Lens Expense Tracker
   -------------------------------------------------------------
   Why a rewrite?
   • Table rows collapsed on some mobile browsers → invisible cards
   • Duplicate renderers caused confusion (renderExpensesTable vs renderExpensesTable_NEW)
   • Costs sometimes strings → totals = 0
   • ISO dates with time part created one header per entry
   Approach
   • Hide the desktop table on screens <640 px and render 
     a dedicated list of cards in a lightweight <div>.
   • Uses ONLY existing global arrays `expenses` and `recurringItems`.
   • NO changes to desktop logic or CSS – strictly inside a media query.
   ============================================================= */

/* ---------- Helper functions ---------- */
function stripISO(dateStr) {
    // "2025-06-09" or "2025-06-09T14:22"
    return (dateStr || '').split('T')[0];
}
function dateLabel(d) {
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    const target = new Date(d);
    const startTarget = new Date(target.getFullYear(), target.getMonth(), target.getDate());
    const startToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const startYesterday = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());

    if (startTarget.getTime() === startToday.getTime()) return 'Today';
    if (startTarget.getTime() === startYesterday.getTime()) return 'Yesterday';

    return target.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' });
}
function toNumber(x) {
    const n = typeof x === 'string' ? parseFloat(x) : x;
    return isNaN(n) ? 0 : n;
}

/* ---------- Rendering ---------- */
function renderMobileExpenseList(expArr) {
    // Lazy create container if not present
    let container = document.getElementById('expenses-mobile-list');
    if (!container) {
        container = document.createElement('div');
        container.id = 'expenses-mobile-list';
        // Put it right before the desktop table
        const deskTable = document.getElementById('expenses-table') || document.querySelector('#expensesTable');
        deskTable?.parentNode?.insertBefore(container, deskTable);
    }

    // Hide desktop table only on mobile
    const isMobile = window.matchMedia('(max-width:640px)').matches;
    container.style.display = isMobile ? 'block' : 'none';

    if (!isMobile) return; // bail early on desktop

    if (!Array.isArray(expArr) || expArr.length === 0) {
        container.innerHTML = '<p class="text-center py-6 text-sm text-gray-400">No expenses yet</p>';
        return;
    }

    /* ----- group by date ----- */
    const grouped = expArr.reduce((acc, exp) => {
        const key = stripISO(exp.date);
        if (!acc[key]) acc[key] = [];
        acc[key].push(exp);
        return acc;
    }, {});

    const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));

    let html = '';
    sortedDates.forEach(dateKey => {
        const dayExpenses = grouped[dateKey];
        const dayTotal = dayExpenses.reduce((s,e)=> s + toNumber(e.cost), 0);

        /* Date header */
        html += `
            <div style="padding:8px 12px;font-weight:600;font-size:14px;color:#555;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span>${dateLabel(dateKey)}</span>
                    <span>- ${formatCurrency(dayTotal)}</span>
                </div>
            </div>`;

        /* Cards */
        dayExpenses.forEach(exp => {
            const icon = categoryIcons?.[exp.category] ?? '❓';
            html += `
            <div onclick="editExpense(${exp.id})" style="
                 display:flex;align-items:center;gap:12px;
                 padding:12px;margin:4px 12px;background:var(--color-surface);
                 border-radius:6px;border:1px solid var(--color-border);cursor:pointer;">
                <span style="font-size:22px;">${icon}</span>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:500;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;">${escapeHTML(exp.name)}</div>
                    <div style="font-size:12px;color:#666;">${escapeHTML(exp.category)}</div>
                </div>
                <div style="font-weight:600;white-space:nowrap;">${exp.type === 'Income' ? '' : '-'}${formatCurrency(toNumber(exp.cost))}</div>
            </div>`;
        });
    });

    container.innerHTML = html;
}

/* ---------- Hook into existing flow ---------- */
/**
 * Mobile rendering integration
 * Enhances desktop table rendering with mobile-optimized cards
 */
document.addEventListener('DOMContentLoaded', () => {
    // Store the original desktop render function
    const originalRenderExpensesTable = window.renderExpensesTable;
    
    if (originalRenderExpensesTable) {
        // Wrap the function to add mobile rendering capability
        window.renderExpensesTable = function() {
            // Execute original desktop rendering first
            originalRenderExpensesTable.apply(this, arguments);
            
            // Add mobile card rendering with same data
            if (typeof getFilteredExpenses === 'function') {
                const filteredExpenses = getFilteredExpenses();
                const currentPage = window.expensesCurrentPage || 1;
                const itemsPerPage = window.expensesItemsPerPage || 25;
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageItems = filteredExpenses.slice(startIndex, endIndex);
                renderMobileExpenseList(pageItems);
            } else {
                const expensesArr = window.expenses ?? [];
                renderMobileExpenseList(expensesArr);
            }
        };
    }

    // Re-render on resize (cheap debounce)
    let resizeTo = null;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTo);
        resizeTo = setTimeout(() => {
            if (window.renderExpensesTable) {
                window.renderExpensesTable();
            }
        }, 150);
    });
}); 



// ]]>
</script>

<!-- Added by ChatGPT 2025-06-22 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  /* Rename Monthly Commitment to Monthly Contribution */
  document.querySelectorAll('label').forEach(lbl => {
    if(/Monthly Commitment/i.test(lbl.textContent)) {
      lbl.textContent = lbl.textContent.replace(/Commitment/i, 'Contribution');
    }
  });

  /* Lock body scroll when confirmation overlay is visible - BUT NOT FOR OTHER MODALS */
  const overlay = document.getElementById('goal-confirmation-overlay');
  if (overlay) {
    const observer = new MutationObserver(() => {
      if (!overlay.classList.contains('hidden')) {
        // Only hide overflow for the goal confirmation overlay, not other modals
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    });
    observer.observe(overlay, { attributes: true, attributeFilter: ['class'] });
  }

  /* Micro‑copy for emergency fund inputs */
  const cleanStep3 = document.getElementById('clean-step-3');
  if (cleanStep3) {
    const title = cleanStep3.querySelector('h3');
    if (title && /Emergency Fund/i.test(title.textContent)) {
      cleanStep3.querySelectorAll('input[type="number"]').forEach(input => {
        const note = document.createElement('div');
        note.className = 'text-xs text-gray-500 mt-1';
        note.innerText = 'Only enter what’s earmarked specifically for emergencies.';
        input.parentElement.appendChild(note);
      });
    }
  }
});

/* APR “I don’t know” helper */
function toggleAprUnknown(box) {
  const item = box.closest('.clean-debt-item');
  if (!item) return;
  const interestInput = item.querySelector('.debt-interest');
  if (!interestInput) return;
  if (box.checked) {
    interestInput.value = '';
    interestInput.disabled = true;
    interestInput.placeholder = 'N/A';
  } else {
    interestInput.disabled = false;
    interestInput.placeholder = '18.9%';
  }
}

/* Patch addCleanDebt to append the unknown‑APR checkbox */
(function() {
  if (!window.addCleanDebt) return;
  const originalAddCleanDebt = window.addCleanDebt;
  window.addCleanDebt = function() {
    originalAddCleanDebt();
    const debtList = document.getElementById('clean-debt-list');
    const item = debtList ? debtList.lastElementChild : null;
    if (item && !item.querySelector('.apr-unknown')) {
      const interestInput = item.querySelector('input[type="number"]');
      if (interestInput) interestInput.classList.add('debt-interest');
      const wrapper = document.createElement('div');
      wrapper.className = 'flex items-center mt-1';
      wrapper.innerHTML = '<input type="checkbox" class="apr-unknown mr-2" onclick="toggleAprUnknown(this)"><span class="text-xs">I don’t know the APR</span>';
      const grid = item.querySelector('.grid');
      if (grid) {
        grid.appendChild(wrapper);
      }
    }
  };
})();
</script>


<!-- ==== Hot‑fix overrides (safe, no core edits) ==== -->
<script>
/* Override addCleanDebt and updateFinancialPreview without touching original functions */
(function(){
    function fmt(n){return '£'+(Number(n)||0).toLocaleString();}
    window.addCleanDebt = function addCleanDebt(){
        const list=document.getElementById('clean-debt-list');if(!list)return;
        const row=document.createElement('div');row.className='clean-debt-item';
        row.innerHTML=`
            <div class="space-y-3">
                <input type="text" placeholder="Debt name (e.g., Credit Card)" class="modern-input debt-name text-sm font-medium text-center">
                <div class="grid grid-cols-2 gap-2">
                    <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">£</span>
                        <input type="number" placeholder="5,000" class="modern-input debt-balance pl-7 font-semibold text-center" oninput="updateFinancialPreview()">
                    </div>
                    <input type="number" placeholder="18.9%" step="0.1" class="modern-input debt-interest font-semibold text-center" oninput="updateFinancialPreview()">
                </div>
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" class="debt-no-apr"> I don’t know the APR
                </label>
                <button onclick="removeCleanDebt(this)" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
            </div>`;
        list.appendChild(row);
        const chk=row.querySelector('.debt-no-apr');const apr=row.querySelector('.debt-interest');
        chk.addEventListener('change',()=>{if(chk.checked){apr.dataset.v=apr.value;apr.value='';apr.placeholder='N/A';apr.disabled=true;}else{apr.disabled=false;apr.placeholder='18.9%';if(apr.dataset.v)apr.value=apr.dataset.v;}updateFinancialPreview();});
        updateFinancialPreview();
    };
    window.updateFinancialPreview = function updateFinancialPreview(){
        const prev=document.getElementById('financial-impact-preview');if(!prev)return;
        const s=parseFloat(document.getElementById('clean-total-savings-input')?.value)||0;
        let d=0;document.querySelectorAll('.clean-debt-item').forEach(r=>{d+=parseFloat(r.querySelector('.debt-balance').value)||0;});
        const nw=s-d;const pay=d?Math.max(d*0.02,25):0;
        cleanOnboardingData.data.totalSavings=s;
        cleanOnboardingData.data.debts=[...document.querySelectorAll('.clean-debt-item')].map(r=>({name:r.querySelector('.debt-name').value||'',balance:parseFloat(r.querySelector('.debt-balance').value)||0,apr:parseFloat(r.querySelector('.debt-interest').value)||0}));
        document.getElementById('preview-savings').textContent=fmt(s);
        document.getElementById('preview-debt').textContent=fmt(d);
        const n=document.getElementById('preview-net-worth');if(n){n.textContent=fmt(nw);n.className='font-mono '+(nw>=0?'text-green-600':'text-red-600');}
        document.getElementById('preview-debt-payments').textContent=fmt(pay);
        prev.classList.remove('hidden');
    };
})();

// Trezor Suite Navigation Functions
function updateTrezorNavigation(activeTab) {
    // Update sidebar navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const navElement = document.getElementById(`nav-${activeTab}`);
    if (navElement) {
        navElement.classList.add('active');
    }
    
    // Update page title
    const titles = {
        'overview': 'Dashboard',
        'expenses': 'Expenses',
        'recurring': 'Recurring',
        'insights': 'Insights',
        'settings': 'Settings',
        'help': 'Help & Documentation'
    };
    
    const pageTitle = document.getElementById('current-page-title');
    if (pageTitle) {
        pageTitle.textContent = titles[activeTab] || 'Dashboard';
    }
}

function toggleMobileDropdown() {
    const dropdown = document.getElementById('mobile-dropdown');
    if (!dropdown) return;
    
    const isOpen = dropdown.classList.contains('show');
    
    if (isOpen) {
        closeMobileDropdown();
    } else {
        // Open dropdown
        dropdown.classList.remove('hidden');
        // Use setTimeout to ensure proper transition
        setTimeout(() => {
            dropdown.classList.add('show');
        }, 10);
        
        // Add click outside listener
        setTimeout(() => {
            document.addEventListener('click', handleClickOutside);
        }, 100);
    }
}

function closeMobileDropdown() {
    const dropdown = document.getElementById('mobile-dropdown');
    if (!dropdown) return;
    
    dropdown.classList.remove('show');
    setTimeout(() => {
        dropdown.classList.add('hidden');
    }, 200);
    
    // Remove click outside listener
    document.removeEventListener('click', handleClickOutside);
}

function handleClickOutside(event) {
    const dropdown = document.getElementById('mobile-dropdown');
    const toggle = document.getElementById('mobile-menu-toggle');
    
    if (dropdown && toggle && 
        !dropdown.contains(event.target) && 
        !toggle.contains(event.target)) {
        closeMobileDropdown();
    }
}

// Initialize Settings form with current values
function initializeSettingsForm() {
    console.log('🔥 INITIALIZING SETTINGS FORM WITH CURRENT VALUES');
    console.log('Current global values:', { monthlyIncome, monthlyBudget, dailyBudget });
    
    // Populate budget and income fields with CURRENT global variables, not localStorage
    const budgetInput = document.getElementById('settings-monthly-budget');
    const incomeInput = document.getElementById('settings-monthly-income');
    const dailyBudgetInput = document.getElementById('settings-daily-budget');
    const currencySelect = document.getElementById('currency-selector');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    
    if (budgetInput) {
        budgetInput.value = monthlyBudget > 0 ? monthlyBudget : '';  // ✅ Use global variable
        console.log('✅ Set budget input to:', budgetInput.value);
    }
    if (incomeInput) {
        // Make income field read-only and show total from recurring
        const totalIncome = calculateTotalIncomeFromRecurring();
        incomeInput.value = totalIncome > 0 ? totalIncome : '';
        incomeInput.readOnly = true;
        incomeInput.placeholder = 'Managed via Recurring tab';
        incomeInput.classList.add('bg-gray-100', 'cursor-not-allowed');
        console.log('✅ Set income input to read-only total:', incomeInput.value);
        
        // Add helpful guidance text
        const helpText = incomeInput.parentNode.querySelector('.income-help-text') || 
            (() => {
                const div = document.createElement('div');
                div.className = 'income-help-text text-sm text-gray-600 dark:text-gray-400 mt-2';
                incomeInput.parentNode.appendChild(div);
                return div;
            })();
        
        if (totalIncome > 0) {
            const breakdown = getIncomeSourcesBreakdown();
            helpText.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>💼 ${breakdown.items.length} income source(s) configured</span>
                    <button onclick="showTab('recurring')" 
                            class="text-blue-600 hover:text-blue-800 underline text-sm">
                        Manage Income →
                    </button>
                </div>
            `;
        } else {
            helpText.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-orange-600">⚠️ No income sources configured</span>
                    <button onclick="showTab('recurring')" 
                            class="text-blue-600 hover:text-blue-800 underline text-sm">
                        Add Income →
                    </button>
                </div>
            `;
        }
    }
    if (dailyBudgetInput) {
        dailyBudgetInput.value = dailyBudget > 0 && dailyBudgetOverride ? dailyBudget : '';
        console.log('✅ Set daily budget input to:', dailyBudgetInput.value);
    }
    if (currencySelect) {
        currencySelect.value = currentCurrencyCode || 'GBP';
    }
    if (darkModeToggle) {
        darkModeToggle.checked = document.body.classList.contains('dark');
    }
    
    console.log('🎉 Settings form initialized with current values');
}

// Override the existing showTab function to work with Trezor navigation
const originalShowTab = window.showTab;
window.showTab = function(tabName) {
    // Call the original function
    if (originalShowTab) {
        originalShowTab(tabName);
    }
    
    // Update Trezor navigation
    updateTrezorNavigation(tabName);
    
    // Initialize Settings form if showing settings tab
    if (tabName === 'settings') {
        setTimeout(initializeSettingsForm, 100);
    }
    
    // Close mobile dropdown if open
    closeMobileDropdown();
};

/**
 * Initialize Trezor-style navigation system
 * Sets up sidebar navigation and handles initial tab selection
 */
document.addEventListener('DOMContentLoaded', function() {
    updateTrezorNavigation('overview');
    
    // Development helper: bypass login for testing
    setTimeout(() => {
        const loginModal = document.querySelector('[data-modal="auth"]');
        if (loginModal && loginModal.classList.contains('flex')) {
            loginModal.classList.add('hidden');
            loginModal.classList.remove('flex');
            // Show main app content
            document.body.classList.remove('overflow-hidden');
        }
    }, 1000);
    
    // Ensure body overflow is never hidden for modals
    document.body.style.overflow = '';
    document.body.classList.remove('overflow-hidden');
});

function updateBudgetCalculations() {
    console.log('🔥 BUDGET HELPER - USING GLOBAL VARIABLES');
    console.log('Values:', { monthlyIncome, monthlyBudget });
    
    const surplus = monthlyIncome - monthlyBudget;
    const calculatedDailyBudget = monthlyBudget / 30;
    const savingsRate = monthlyIncome > 0 ? (surplus / monthlyIncome) * 100 : 0;
    
    console.log('Calculated:', { surplus, savingsRate });
    
    // Update displays
    const surplusDisplay = document.getElementById('budget-surplus-display');
    const dailyDisplay = document.getElementById('daily-budget-display');
    const savingsDisplay = document.getElementById('savings-rate-display');
    
    if (surplusDisplay) {
        surplusDisplay.innerHTML = `• Monthly Surplus: <span class="font-semibold ${surplus >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(surplus)}</span> (Income - Budget)`;
    }
    
    if (dailyDisplay) {
        const displayBudget = dailyBudgetOverride && dailyBudget > 0 ? dailyBudget : calculatedDailyBudget;
        dailyDisplay.innerHTML = `• ${dailyBudgetOverride ? 'Custom' : 'Calculated'} Daily Budget: <span class="font-semibold">${formatCurrency(displayBudget)}</span>`;
    }
    
    if (savingsDisplay) {
        savingsDisplay.innerHTML = `• Savings Rate: <span class="font-semibold ${savingsRate >= 20 ? 'text-green-600' : savingsRate >= 10 ? 'text-yellow-600' : 'text-red-600'}">${savingsRate.toFixed(1)}%</span> of income`;
    }
    
    console.log('✅ Budget calculations updated');
}

function updateCurrentStatus() {
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    // Calculate totals
    const totalExpenses = expenses.reduce((sum, exp) => sum + (exp.status === 'active' ? exp.cost : 0), 0);
    const monthlyExpenses = expenses.filter(exp => {
        const expDate = new Date(exp.date);
        return expDate.getMonth() === currentMonth && 
               expDate.getFullYear() === currentYear && 
               exp.status === 'active';
    }).reduce((sum, exp) => sum + exp.cost, 0);
    

}

/**
 * Set up real-time budget calculation updates
 * Automatically recalculates budgets when user changes settings
 */
document.addEventListener('DOMContentLoaded', function() {
    const incomeInput = document.getElementById('settings-monthly-income');
    const budgetInput = document.getElementById('settings-monthly-budget');
    const dailyInput = document.getElementById('settings-daily-budget');
    
    // Attach input listeners for live updates
    if (incomeInput) incomeInput.addEventListener('input', updateBudgetCalculations);
    if (budgetInput) budgetInput.addEventListener('input', updateBudgetCalculations);
    if (dailyInput) dailyInput.addEventListener('input', updateBudgetCalculations);
});

// COMPLETE FIX FOR INSIGHTS PAGE - REAL DATA IMPLEMENTATION
// Replace the hardcoded insights section with this functional implementation

// ===========================
// 1. REAL DATA CALCULATION FUNCTIONS
// ===========================

function getRealSpendingData() {
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    // Get current month expenses only
    const monthlyExpenses = expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate.getMonth() === currentMonth && 
               expenseDate.getFullYear() === currentYear &&
               expense.status === 'active';
    });
    
    // Create daily spending breakdown
    const dailySpending = {};
    monthlyExpenses.forEach(expense => {
        const day = new Date(expense.date).getDate();
        if (!dailySpending[day]) {
            dailySpending[day] = 0;
        }
        dailySpending[day] += expense.cost;
    });
    
    // Convert to array format for charts
    const spendingDataArray = [];
    for (let day = 1; day <= currentDate.getDate(); day++) {
        spendingDataArray.push({
            day: day,
            amount: dailySpending[day] || 0,
            expenses: monthlyExpenses.filter(e => new Date(e.date).getDate() === day)
        });
    }
    
    return spendingDataArray;
}

function getRealCategoryData() {
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    const monthlyExpenses = expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate.getMonth() === currentMonth && 
               expenseDate.getFullYear() === currentYear &&
               expense.status === 'active';
    });
    
    const categoryTotals = {};
    monthlyExpenses.forEach(expense => {
        const category = expense.category || 'Other';
        categoryTotals[category] = (categoryTotals[category] || 0) + expense.cost;
    });
    
    return Object.entries(categoryTotals)
        .map(([category, amount]) => ({ category, amount }))
        .sort((a, b) => b.amount - a.amount);
}

function calculateRealInsights() {
    const spendingData = getRealSpendingData();
    const totalSpent = spendingData.reduce((sum, day) => sum + day.amount, 0);
    const daysElapsed = spendingData.length;
    const averageDaily = daysElapsed > 0 ? totalSpent / daysElapsed : 0;
    
    // Calculate daily budget (from monthly budget or override)
    const realDailyBudget = dailyBudgetOverride ? dailyBudget : (monthlyBudget / 30);
    
    // Project spending to end of month
    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
    const projectedMonthly = averageDaily * daysInMonth;
    
    // Days over daily budget
    const daysOverBudget = spendingData.filter(d => d.amount > realDailyBudget).length;
    
    // Budget variance
    const budgetVariance = projectedMonthly - monthlyBudget;
    const budgetVariancePercent = monthlyBudget > 0 ? (budgetVariance / monthlyBudget) * 100 : 0;
    
    return {
        totalSpent,
        averageDaily,
        projectedMonthly,
        daysOverBudget,
        budgetVariance,
        budgetVariancePercent,
        daysElapsed,
        daysInMonth,
        isOverBudget: projectedMonthly > monthlyBudget,
        dailyBudgetTarget: realDailyBudget
    };
}

// ===========================
// 2. CHART GENERATION WITH REAL DATA
// ===========================

function createRealSpendingChart() {
    const canvas = document.getElementById('spending-trend-chart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const spendingData = getRealSpendingData();
    const insights = calculateRealInsights();
    
    // Destroy existing chart
    if (spendingTrendChart) {
        spendingTrendChart.destroy();
    }
    
    const labels = spendingData.map(d => `Day ${d.day}`);
    const actualSpending = spendingData.map(d => d.amount);
    
    // Create projection for remaining days
    const remainingDays = insights.daysInMonth - insights.daysElapsed;
    const projectedLabels = [];
    const projectedSpending = [];
    
    for (let i = 1; i <= remainingDays; i++) {
        projectedLabels.push(`Day ${insights.daysElapsed + i}`);
        projectedSpending.push(insights.averageDaily);
    }
    
    const datasets = [
        {
            label: 'Actual Spending',
            data: actualSpending,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4
        },
        {
            label: 'Daily Budget',
            data: Array(spendingData.length).fill(insights.dailyBudgetTarget),
            borderColor: '#10b981',
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0
        },
        {
            label: 'Monthly Income (Daily Avg)',
            data: Array(spendingData.length).fill(monthlyIncome / insights.daysInMonth),
            borderColor: '#8b5cf6',
            borderDash: [10, 5],
            fill: false,
            pointRadius: 0
        }
    ];
    
    // Add projection if there are remaining days
    if (remainingDays > 0) {
        datasets.push({
            label: 'Projected Spending',
            data: [...Array(insights.daysElapsed).fill(null), ...projectedSpending],
            borderColor: '#f59e0b',
            borderDash: [3, 3],
            fill: false,
            pointRadius: 1
        });
    }
    
    spendingTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [...labels, ...projectedLabels],
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Spending vs Budget vs Income'
                },
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (£)'
                    }
                }
            }
        }
    });
}

function createRealCategoryChart() {
    const canvas = document.getElementById('category-spending-chart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const categoryData = getRealCategoryData();
    
    if (categorySpendingChart) {
        categorySpendingChart.destroy();
    }
    
    if (categoryData.length === 0) {
        // Show empty state
        ctx.fillStyle = '#6b7280';
        ctx.font = '16px Inter';
        ctx.textAlign = 'center';
        ctx.fillText('No expenses recorded yet', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    const colors = [
        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
        '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
    ];
    
    categorySpendingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categoryData.map(d => d.category),
            datasets: [{
                data: categoryData.map(d => d.amount),
                backgroundColor: colors.slice(0, categoryData.length),
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Spending by Category'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// ===========================
// 3. INSIGHTS GENERATION WITH REAL DATA
// ===========================

function generateRealInsights() {
    const insights = calculateRealInsights();
    const spendingData = getRealSpendingData();
    const container = document.getElementById('insights-container');
    
    if (!container) return;
    
    const insightsList = [
        {
            icon: '🎯',
            title: 'Month-End Projection',
            description: `Based on your current spending of £${insights.totalSpent.toFixed(2)} over ${insights.daysElapsed} days, you're projected to spend £${insights.projectedMonthly.toFixed(2)} this month.`,
            status: insights.isOverBudget ? 'warning' : 'success',
            action: insights.isOverBudget 
                ? `Reduce daily spending by £${(insights.budgetVariance / (insights.daysInMonth - insights.daysElapsed)).toFixed(2)} to stay within budget`
                : `You're on track! You have £${(monthlyBudget - insights.projectedMonthly).toFixed(2)} buffer remaining.`
        },
        {
            icon: '📊',
            title: 'Daily Budget Performance',
            description: `You've exceeded your daily budget of £${insights.dailyBudgetTarget.toFixed(2)} on ${insights.daysOverBudget} out of ${insights.daysElapsed} days.`,
            status: insights.daysOverBudget > insights.daysElapsed * 0.3 ? 'warning' : 'success',
            action: insights.daysOverBudget > insights.daysElapsed * 0.3 
                ? 'Try to stick to your daily budget more consistently'
                : 'Great job maintaining daily spending discipline!'
        },
        {
            icon: '💰',
            title: 'Income vs Spending',
            description: monthlyIncome > 0 
                ? `Your projected monthly spending (£${insights.projectedMonthly.toFixed(2)}) is ${insights.projectedMonthly > monthlyIncome ? 'exceeding' : 'within'} your income of £${monthlyIncome.toFixed(2)}.`
                : 'Set your monthly income in Settings to get income-based insights.',
            status: monthlyIncome > 0 && insights.projectedMonthly > monthlyIncome ? 'warning' : 'info',
            action: monthlyIncome > 0 && insights.projectedMonthly > monthlyIncome 
                ? 'Review your spending categories and cut non-essential expenses'
                : monthlyIncome > 0 ? 'You\'re living within your means!' : 'Go to Settings → Budget & Income to set your monthly income'
        },
        {
            icon: '📈',
            title: 'Spending Trend',
            description: getSpendingTrendDescription(spendingData),
            status: 'info',
            action: getSpendingTrendAction(spendingData, insights)
        }
    ];
    
    container.innerHTML = insightsList.map(insight => `
        <div class="flex items-start gap-4 p-4 rounded-lg ${getInsightCardClass(insight.status)}">
            <div class="text-2xl">${insight.icon}</div>
            <div class="flex-1">
                <h4 class="font-semibold mb-1" style="color: var(--color-text-primary);">${insight.title}</h4>
                <p class="text-sm mb-2" style="color: var(--color-text-primary);">${insight.description}</p>
                <div class="text-xs font-medium px-2 py-1 rounded" style="color: var(--color-text-primary); background-color: var(--color-bg-tertiary);">${insight.action}</div>
            </div>
        </div>
    `).join('');
}

function getSpendingTrendDescription(spendingData) {
    if (spendingData.length < 7) {
        return 'Track spending for at least a week to see trend analysis.';
    }
    
    const recentWeek = spendingData.slice(-7);
    const previousWeek = spendingData.slice(-14, -7);
    
    if (previousWeek.length === 0) {
        return 'Continue tracking to build trend analysis.';
    }
    
    const recentAvg = recentWeek.reduce((sum, d) => sum + d.amount, 0) / recentWeek.length;
    const previousAvg = previousWeek.reduce((sum, d) => sum + d.amount, 0) / previousWeek.length;
    
    const changePercent = ((recentAvg - previousAvg) / previousAvg * 100).toFixed(1);
    
    if (Math.abs(changePercent) < 5) {
        return 'Your spending has been relatively stable over the past two weeks.';
    } else if (changePercent > 0) {
        return `Your spending has increased by ${changePercent}% compared to the previous week.`;
    } else {
        return `Your spending has decreased by ${Math.abs(changePercent)}% compared to the previous week.`;
    }
}

function getSpendingTrendAction(spendingData, insights) {
    if (spendingData.length < 7) {
        return 'Keep tracking your expenses to get personalized recommendations.';
    }
    
    if (insights.daysOverBudget > insights.daysElapsed * 0.5) {
        return 'Focus on staying within your daily budget. Try the envelope method for discretionary spending.';
    }
    
    if (insights.isOverBudget) {
        return 'Review your largest expense categories and identify areas to reduce spending.';
    }
    
    return 'Your spending is well-controlled. Consider increasing your savings rate if possible.';
}

function getInsightCardClass(status) {
    switch (status) {
        case 'warning':
            return 'bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800';
        case 'success':
            return 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800';
        case 'info':
        default:
            return 'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800';
    }
}

// ===========================
// 4. DAILY BREAKDOWN WITH REAL DATA
// ===========================

function generateRealDailyBreakdown() {
    const container = document.getElementById('daily-breakdown');
    if (!container) return;
    
    const spendingData = getRealSpendingData();
    const insights = calculateRealInsights();
    
    // Show last 14 days
    const displayData = spendingData.slice(-14);
    
    container.innerHTML = displayData.map(day => {
        const isOverBudget = day.amount > insights.dailyBudgetTarget;
        const isNoSpend = day.amount === 0;
        
        return `
            <div class="p-3 rounded-lg border ${isOverBudget ? 'border-red-200 bg-red-50 dark:border-red-800 dark:bg-red-900/20' : 
                                                 isNoSpend ? 'border-green-200 bg-green-50 dark:border-green-800 dark:bg-green-900/20' : 
                                                           'border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-800'}">
                <div class="text-center">
                    <div class="text-sm font-medium text-gray-600 dark:text-gray-400">Day ${day.day}</div>
                    <div class="text-lg font-bold ${isOverBudget ? 'text-red-600 dark:text-red-400' : 
                                                   isNoSpend ? 'text-green-600 dark:text-green-400' : 
                                                             'text-gray-900 dark:text-white'}">${formatCurrency(day.amount)}</div>
                    <div class="text-xs ${isOverBudget ? 'text-red-500' : isNoSpend ? 'text-green-500' : 'text-gray-500'}">
                        ${isOverBudget ? 'Over Budget' : isNoSpend ? 'No Spending' : 'On Track'}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">${day.expenses.length} expense${day.expenses.length !== 1 ? 's' : ''}</div>
                </div>
            </div>
        `;
    }).join('');
}

// ===========================
// 5. MAIN UPDATE FUNCTION
// ===========================

function updateChartsAndInsights() {
    console.log('=== UPDATING INSIGHTS ===');
    
    if (activeTab !== 'insights') {
        console.log('Not on insights tab, skipping');
        return;
    }
    
    // Check data availability
    if (!expenses || expenses.length === 0) {
        console.log('No expenses data available');
        const container = document.getElementById('insights-container');
        if (container) {
            container.innerHTML = '<div class="text-center p-8 text-gray-500">Add some expenses to see insights</div>';
        }
        return;
    }
    
    if (monthlyBudget <= 0) {
        console.log('No budget set');
        const container = document.getElementById('insights-container');
        if (container) {
            container.innerHTML = '<div class="text-center p-8 text-gray-500">Set your budget in Settings to see insights</div>';
        }
        return;
    }
    
    // Check if insight elements exist
    const elementsToCheck = [
        'insights-container',
        'spending-trend-chart', 
        'category-spending-chart',
        'daily-breakdown'
    ];
    
    const missingElements = elementsToCheck.filter(id => !document.getElementById(id));
    if (missingElements.length > 0) {
        console.log('Missing insight elements:', missingElements);
    }
    
    try {
        // Update insights with proper error handling
        console.log('Generating real insights...');
        if (typeof generateRealInsights === 'function') {
            generateRealInsights();
        } else {
            console.log('generateRealInsights function not available, using fallback');
            generateBasicInsights();
        }
        
        console.log('Creating spending chart...');
        if (typeof createRealSpendingChart === 'function') {
            createRealSpendingChart();
        } else {
            console.log('createRealSpendingChart function not available');
        }
        
        console.log('Creating category chart...');
        if (typeof createRealCategoryChart === 'function') {
            createRealCategoryChart();
        } else {
            console.log('createRealCategoryChart function not available');
        }
        
        console.log('Generating daily breakdown...');
        if (typeof generateRealDailyBreakdown === 'function') {
            generateRealDailyBreakdown();
        } else {
            console.log('generateRealDailyBreakdown function not available');
            generateBasicDailyBreakdown();
        }
        
        // Update metrics display
        updateRealMetrics();
        
        console.log('✅ Insights update completed successfully');
        
    } catch (error) {
        console.error('❌ Error updating insights:', error);
        console.error('Error stack:', error.stack);
        
        // Show user-friendly error message
        const container = document.getElementById('insights-container');
        if (container) {
            container.innerHTML = `
                <div class="text-center p-8 text-red-500">
                    <p>Unable to generate insights at the moment.</p>
                    <button onclick="updateChartsAndInsights()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Try Again
                    </button>
                </div>
            `;
        }
    }
    
    console.log('=== INSIGHTS UPDATE COMPLETE ===');
}


function saveSettingsWithInsightsUpdate() {
    console.log('🔥 SAVING SETTINGS - FORCE UPDATE ALL VALUES');
    
    // Get form inputs with correct IDs
    const budgetInput = document.getElementById('settings-monthly-budget');
    const incomeInput = document.getElementById('settings-monthly-income');
    const dailyBudgetInput = document.getElementById('settings-daily-budget');
    
    console.log('Form elements found:', {
        budget: !!budgetInput,
        income: !!incomeInput,
        daily: !!dailyBudgetInput
    });
    
    if (!budgetInput || !incomeInput) {
        showToast('Settings form not found', 'error');
        return;
    }
    
    // Extract values
    const incomeValue = parseFloat(incomeInput.value) || 0;
    const budgetValue = parseFloat(budgetInput.value) || 0;
    const dailyValue = parseFloat(dailyBudgetInput?.value) || 0;
    
    console.log('New values from form:', { incomeValue, budgetValue, dailyValue });
    
    // Validation
    if (budgetValue <= 0) {
        showToast('Please enter a valid monthly budget', 'error');
        return;
    }
    
    // Income is now read-only and managed via recurring tab
    console.log('Income field is read-only, no sync needed');
    
    console.log('BEFORE update - Global variables:', { monthlyIncome, monthlyBudget, monthlyExpenses });
    
    // 🔥 UPDATE ALL GLOBAL VARIABLES
    // monthlyIncome is now calculated from recurring entries only
    monthlyIncome = calculateTotalIncomeFromRecurring();
    monthlyBudget = budgetValue;
    monthlyExpenses = budgetValue;
    
    if (dailyValue > 0) {
        dailyBudget = dailyValue;
        dailyBudgetOverride = true;
    } else {
        dailyBudget = Math.round((monthlyBudget / 30) * 100) / 100;
        dailyBudgetOverride = false;
    }
    
    console.log('AFTER update - Global variables:', { monthlyIncome, monthlyBudget, monthlyExpenses });
    
    // 🔥 FORCE SAVE TO BOTH STORAGE LOCATIONS
    try {
        // Save to main app data
        saveData();
        console.log('✅ Saved to lensAppData');
        
        // Force update onboarding data to prevent override
        const onboardingData = {
            completed: true,
            currentStep: 6,
            data: {
                monthlyIncome: monthlyIncome,
                monthlyBudget: monthlyBudget,
                monthlyExpenses: monthlyExpenses,
                totalSavings: totalSavings || 0,
                debts: [],
                primaryGoal: 'custom',
                goalDetails: {}
            }
        };
        localStorage.setItem('cleanOnboardingData', JSON.stringify(onboardingData));
        console.log('✅ Updated onboarding data');
        
        // Force update dashboard tiles immediately
        updateDisplay();
        console.log('✅ Updated dashboard display');
        
        // Force update budget calculations
        updateBudgetCalculations();
        console.log('✅ Updated budget calculations');
        
        // Force update insights tiles with new values
        updateInsightsTiles();
        console.log('✅ Updated insights tiles');
        
        // Force update insights if on insights tab
        if (activeTab === 'insights') {
            updateChartsAndInsights();
            console.log('✅ Updated insights');
        }
        
    } catch (error) {
        console.error('Error saving settings:', error);
        showToast('Error saving settings', 'error');
        return;
    }
    
    const surplus = monthlyIncome - monthlyBudget;
    console.log('Final surplus calculation:', monthlyIncome, '-', monthlyBudget, '=', surplus);
    
    showToast(`Settings saved! Income: ${formatCurrency(monthlyIncome)}, Budget: ${formatCurrency(monthlyBudget)}, Surplus: ${formatCurrency(surplus)}`, 'success');
    
    // Close settings modal
    if (typeof closeSettings === 'function') {
        closeSettings();
    }
    
    console.log('🎉 SETTINGS SAVE COMPLETE - NEW VALUES APPLIED');
}

function updateInsightsTiles() {
    console.log('Updating insights tiles with:', { monthlyIncome, monthlyBudget, dailyBudget });
    
    // Update insights tiles
    const insightsIncome = document.getElementById('insights-monthly-income');
    const insightsBudget = document.getElementById('insights-monthly-budget');
    const insightsDailyBudget = document.getElementById('insights-daily-budget');
    const budgetPercentage = document.getElementById('budget-percentage');
    
    if (insightsIncome) {
        insightsIncome.textContent = formatCurrency(monthlyIncome);
        console.log('✅ Updated insights income to:', formatCurrency(monthlyIncome));
    }
    
    if (insightsBudget) {
        insightsBudget.textContent = formatCurrency(monthlyBudget);
        console.log('✅ Updated insights budget to:', formatCurrency(monthlyBudget));
    }
    
    if (insightsDailyBudget) {
        insightsDailyBudget.textContent = formatCurrency(dailyBudget);
        console.log('✅ Updated insights daily budget to:', formatCurrency(dailyBudget));
    }
    
    if (budgetPercentage && monthlyIncome > 0) {
        const percentage = ((monthlyBudget / monthlyIncome) * 100).toFixed(0);
        budgetPercentage.textContent = `${percentage}% of income`;
        console.log('✅ Updated budget percentage to:', `${percentage}% of income`);
    }
}

function generateBasicInsights() {
    console.log('Using basic insights fallback');
    
    const container = document.getElementById('insights-container');
    if (!container) return;
    
    // Calculate basic metrics
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    const monthlyExpenses = expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate.getMonth() === currentMonth && 
               expenseDate.getFullYear() === currentYear &&
               expense.status === 'active';
    });
    
    const totalSpent = monthlyExpenses.reduce((sum, e) => {
        const cost = parseFloat(e.cost) || 0;
        return sum + (isNaN(cost) ? 0 : cost);
    }, 0);
    const remaining = (monthlyBudget || 0) - (totalSpent || 0);
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const daysElapsed = Math.max(1, currentDate.getDate());
    const dailyAverage = totalSpent / daysElapsed;
    const projectedSpending = dailyAverage * daysInMonth;
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="card p-4">
                <h3 class="text-lg font-semibold mb-4 text-gray-900">📊 Spending Overview</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Spent this month:</span>
                        <span class="font-semibold">${formatCurrency(totalSpent)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Budget remaining:</span>
                        <span class="font-semibold ${remaining >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(remaining)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Daily average:</span>
                        <span class="font-semibold">${formatCurrency(dailyAverage)}</span>
                    </div>
                </div>
            </div>
            
            <div class="card p-4">
                <h3 class="text-lg font-semibold mb-4 text-gray-900">🔮 Projections</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Projected monthly:</span>
                        <span class="font-semibold ${projectedSpending <= monthlyBudget ? 'text-green-600' : 'text-red-600'}">${formatCurrency(projectedSpending)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Days elapsed:</span>
                        <span class="font-semibold">${daysElapsed}/${daysInMonth}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Budget usage:</span>
                        <span class="font-semibold">${monthlyBudget > 0 ? ((totalSpent / monthlyBudget) * 100).toFixed(1) : '0.0'}%</span>
                    </div>
                </div>
            </div>
            
            <div class="card p-4">
                <h3 class="text-lg font-semibold mb-4 text-gray-900">💡 Quick Tips</h3>
                <div class="space-y-2 text-sm">
                    ${projectedSpending > monthlyBudget ? 
                        `<p class="text-red-600">⚠️ You're projected to exceed your budget by ${formatCurrency(projectedSpending - monthlyBudget)}</p>` :
                        `<p class="text-green-600">✅ You're on track to stay within budget</p>`
                    }
                    <p class="text-gray-600">Daily budget target: ${formatCurrency(monthlyBudget / daysInMonth)}</p>
                    <p class="text-gray-600">Expenses recorded: ${monthlyExpenses.length} transactions</p>
                </div>
            </div>
        </div>
    `;
}

function generateBasicDailyBreakdown() {
    console.log('Using basic daily breakdown fallback');
    
    const container = document.getElementById('daily-breakdown');
    if (!container) return;
    
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    // Get last 7 days
    const last7Days = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        
        const dayExpenses = expenses.filter(expense => {
            const expenseDate = new Date(expense.date);
            return expenseDate.toDateString() === date.toDateString() && expense.status === 'active';
        });
        
        const dayTotal = dayExpenses.reduce((sum, e) => sum + e.cost, 0);
        const dailyBudgetTarget = monthlyBudget / new Date(currentYear, currentMonth + 1, 0).getDate();
        
        last7Days.push({
            date: date,
            total: dayTotal,
            isOverBudget: dayTotal > dailyBudgetTarget,
            expenses: dayExpenses
        });
    }
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-7 gap-2">
            ${last7Days.map(day => `
                <div class="card p-3 text-center">
                    <div class="text-xs text-gray-500 mb-1">${day.date.toLocaleDateString('en-GB', { weekday: 'short' })}</div>
                    <div class="text-lg font-semibold ${day.isOverBudget ? 'text-red-600' : 'text-gray-900'}">${formatCurrency(day.total)}</div>
                    <div class="text-xs ${day.isOverBudget ? 'text-red-500' : 'text-gray-500'}">${day.expenses.length} expense${day.expenses.length !== 1 ? 's' : ''}</div>
                </div>
            `).join('')}
        </div>
    `;
}

function updateRealMetrics() {
    const insights = calculateRealInsights();
    
    // Update the metrics cards at the top
    const metricElements = {
        monthlyIncome: document.querySelector('[data-metric="income"]'),
        monthlyBudget: document.querySelector('[data-metric="budget"]'),
        dailyBudget: document.querySelector('[data-metric="daily-budget"]'),
        goalProgress: document.querySelector('[data-metric="goal-progress"]')
    };
    
    if (metricElements.monthlyIncome) {
        metricElements.monthlyIncome.innerHTML = `
            <div class="text-center p-4">
                <div class="text-sm text-gray-600 dark:text-gray-400">Monthly Income</div>
                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${formatCurrency(monthlyIncome)}</div>
                <div class="text-xs text-gray-500">+5% vs last month</div>
            </div>
        `;
    }
    
    if (metricElements.monthlyBudget) {
        metricElements.monthlyBudget.innerHTML = `
            <div class="text-center p-4">
                <div class="text-sm text-gray-600 dark:text-gray-400">Monthly Budget</div>
                <div class="text-2xl font-bold text-green-600 dark:text-green-400">${formatCurrency(monthlyBudget)}</div>
                <div class="text-xs text-gray-500">${insights.budgetVariancePercent > 0 ? 'Over' : 'Under'} by ${Math.abs(insights.budgetVariancePercent).toFixed(1)}%</div>
            </div>
        `;
    }
    
    if (metricElements.dailyBudget) {
        metricElements.dailyBudget.innerHTML = `
            <div class="text-center p-4">
                <div class="text-sm text-gray-600 dark:text-gray-400">Daily Budget</div>
                <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">${formatCurrency(insights.dailyBudgetTarget)}</div>
                <div class="text-xs text-gray-500">${insights.daysOverBudget}/${insights.daysElapsed} days over</div>
            </div>
        `;
    }
}

// ===========================
// 6. SETTINGS INTEGRATION
// ===========================

// FIX: Direct dashboard update function
function updateDashboardTiles() {
    console.log('=== UPDATING DASHBOARD TILES ===');
    console.log('Current values:', { monthlyBudget, monthlyIncome });
    
    // Calculate current month expenses first
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    const monthlyExpenses = expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate.getMonth() === currentMonth && 
               expenseDate.getFullYear() === currentYear &&
               expense.status === 'active';
    });
    
    const totalSpent = monthlyExpenses.reduce((sum, e) => {
        const cost = parseFloat(e.cost) || 0;
        return sum + (isNaN(cost) ? 0 : cost);
    }, 0);
    const remaining = (monthlyBudget || 0) - (totalSpent || 0);
    
    console.log('Calculated values:', { totalSpent, remaining });
    
    // Use DOMElements cache - this is the KEY FIX
    if (DOMElements && DOMElements.monthlyBudgetDisplay) {
        DOMElements.monthlyBudgetDisplay.textContent = formatCurrency(monthlyBudget);
        console.log('✅ Updated budget display via DOMElements');
    } else {
        // Fallback to direct getElementById
        const budgetDisplay = document.getElementById('monthly-budget');
        if (budgetDisplay) {
            budgetDisplay.textContent = formatCurrency(monthlyBudget);
            console.log('✅ Updated budget display via getElementById');
        } else {
            console.log('❌ Budget display element not found');
        }
    }
    
    if (DOMElements && DOMElements.totalExpensesDisplay) {
        DOMElements.totalExpensesDisplay.textContent = formatCurrency(totalSpent);
        console.log('✅ Updated expenses display via DOMElements');
    } else {
        const expensesDisplay = document.getElementById('total-expenses');
        if (expensesDisplay) {
            expensesDisplay.textContent = formatCurrency(totalSpent);
            console.log('✅ Updated expenses display via getElementById');
        } else {
            console.log('❌ Expenses display element not found');
        }
    }
    
    if (DOMElements && DOMElements.remainingAmountDisplay) {
        DOMElements.remainingAmountDisplay.textContent = formatCurrency(remaining);
        
        // Update color based on remaining amount
        if (remaining < 0) {
            DOMElements.remainingAmountDisplay.classList.remove('text-green-600', 'dark:text-green-400');
            DOMElements.remainingAmountDisplay.classList.add('text-red-600', 'dark:text-red-400');
        } else {
            DOMElements.remainingAmountDisplay.classList.remove('text-red-600', 'dark:text-red-400');
            DOMElements.remainingAmountDisplay.classList.add('text-green-600', 'dark:text-green-400');
        }
        console.log('✅ Updated remaining display via DOMElements');
    } else {
        const remainingDisplay = document.getElementById('remaining-amount');
        if (remainingDisplay) {
            remainingDisplay.textContent = formatCurrency(remaining);
            if (remaining < 0) {
                remainingDisplay.classList.remove('text-green-600');
                remainingDisplay.classList.add('text-red-600');
            } else {
                remainingDisplay.classList.remove('text-red-600');
                remainingDisplay.classList.add('text-green-600');
            }
            console.log('✅ Updated remaining display via getElementById');
        } else {
            console.log('❌ Remaining display element not found');
        }
    }
    
    // Update income display if it exists
    if (DOMElements && DOMElements.totalIncomeDisplay && monthlyIncome > 0) {
        DOMElements.totalIncomeDisplay.textContent = formatCurrency(monthlyIncome);
        console.log('✅ Updated income display');
    }
    
    // Force a full display update as backup
    if (typeof updateDisplay === 'function') {
        console.log('Calling updateDisplay as backup...');
        updateDisplay();
    }
    
    console.log('=== DASHBOARD TILES UPDATE COMPLETE ===');
}


// ===========================
// 7. INITIALIZATION
// ===========================

// Call this when switching to insights tab or when expenses change
document.addEventListener('DOMContentLoaded', function() {
    // Override the existing saveSettings function
    window.saveSettings = saveSettingsWithInsightsUpdate;
    
    // Update insights when expenses are added/modified
    const originalAddExpense = window.addExpense;
    window.addExpense = function() {
        const result = originalAddExpense.apply(this, arguments);
        if (activeTab === 'insights') {
            setTimeout(updateChartsAndInsights, 100);
        }
        return result;
    };
    
    const originalUpdateExpense = window.updateExpense;
    window.updateExpense = function() {
        const result = originalUpdateExpense.apply(this, arguments);
        if (activeTab === 'insights') {
            setTimeout(updateChartsAndInsights, 100);
        }
        return result;
    };
    
    const originalDeleteExpense = window.deleteExpenses;
    window.deleteExpenses = function() {
        const result = originalDeleteExpense.apply(this, arguments);
        if (activeTab === 'insights') {
            setTimeout(updateChartsAndInsights, 100);
        }
        return result;
    };
});

/* 
USAGE INSTRUCTIONS:
1. Replace the hardcoded insights section in your index.html with this code
2. Make sure to add a daily budget input field to your settings page
3. Update the insights tab HTML to include proper element IDs:
   - insights-container
   - daily-breakdown  
   - spending-trend-chart
   - category-spending-chart
4. The code will now use real expense data, budget settings, and income values
5. Charts will show actual spending vs budget vs income lines
6. Insights will be calculated from real expense data
7. All settings changes will immediately update the insights
*/

// 🔥 ADD THIS CODE TO YOUR index.html FILE
// This will auto-save settings when you type in the fields

document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up auto-save for settings page...');
    
    // Add auto-save functionality to settings inputs
    function setupAutoSaveSettings() {
        const incomeInput = document.getElementById('settings-monthly-income');
        const budgetInput = document.getElementById('settings-monthly-budget');
        const dailyInput = document.getElementById('settings-daily-budget');
        
        console.log('Found elements:', {
            income: !!incomeInput,
            budget: !!budgetInput,
            daily: !!dailyInput
        });
        
        if (incomeInput) {
            incomeInput.addEventListener('blur', autoSaveSettings);
            incomeInput.addEventListener('change', autoSaveSettings);
        }
        
        if (budgetInput) {
            budgetInput.addEventListener('blur', autoSaveSettings);
            budgetInput.addEventListener('change', autoSaveSettings);
        }
        
        if (dailyInput) {
            dailyInput.addEventListener('blur', autoSaveSettings);
            dailyInput.addEventListener('change', autoSaveSettings);
        }
    }
    
    // Auto-save function that works like onboarding
    function autoSaveSettings() {
        console.log('🔥 AUTO-SAVING SETTINGS...');
        
        const incomeInput = document.getElementById('settings-monthly-income');
        const budgetInput = document.getElementById('settings-monthly-budget');
        const dailyInput = document.getElementById('settings-daily-budget');
        
        console.log('Current input values:', {
            income: incomeInput?.value,
            budget: budgetInput?.value,
            daily: dailyInput?.value
        });
        
        const incomeValue = parseFloat(incomeInput?.value);
        const budgetValue = parseFloat(budgetInput?.value);
        const dailyValue = parseFloat(dailyInput?.value);
        
        // Only update if we have valid values
        if (!isNaN(incomeValue) && incomeValue > 0) {
            monthlyIncome = incomeValue;
            console.log('✅ Updated monthlyIncome to:', monthlyIncome);
        }
        
        if (!isNaN(budgetValue) && budgetValue > 0) {
            monthlyBudget = budgetValue;
            console.log('✅ Updated monthlyBudget to:', monthlyBudget);
        }
        
        if (!isNaN(dailyValue) && dailyValue > 0) {
            dailyBudget = dailyValue;
            dailyBudgetOverride = true;
        } else if (!isNaN(budgetValue) && budgetValue > 0) {
            dailyBudget = Math.round((budgetValue / 30) * 100) / 100;
            dailyBudgetOverride = false;
        }
        
        // Save to localStorage
        try {
            saveData();
            console.log('✅ Data saved to localStorage');
        } catch (error) {
            console.error('❌ Error saving data:', error);
        }
        
        // Update dashboard immediately
        try {
            updateDisplay();
            console.log('✅ Dashboard updated');
        } catch (error) {
            console.error('❌ Error updating display:', error);
        }
        
        // Update budget calculations
        try {
            updateBudgetCalculations();
            console.log('✅ Budget calculations updated');
        } catch (error) {
            console.error('❌ Error updating budget calculations:', error);
        }
        
        console.log('🎉 AUTO-SAVE COMPLETE');
    }
    
    // Initialize after a short delay to ensure page is loaded
    setTimeout(setupAutoSaveSettings, 1000);
    
    // Also setup when switching to settings tab
    const originalShowTab = window.showTab;
    if (originalShowTab) {
        window.showTab = function(tabName) {
            originalShowTab(tabName);
            if (tabName === 'settings') {
                setTimeout(setupAutoSaveSettings, 100);
            }
        };
    }
});

// ===========================
// COMPLETE FINANCE INSIGHTS CLASS
// ===========================

class FinanceInsights {
    constructor() {
        this.monthlyIncome = 0;
        this.monthlyBudget = 0;
        this.dailyBudget = 0;
        this.dailyBudgetEnabled = false;
        this.monthlyIncomeEnabled = false;
        this.expenses = [];
        this.goals = [];
        this.recurringExpenses = [];
        
        // Initialize with data from your existing app
        this.loadFinancialData();
        this.render();
    }

    loadFinancialData() {
        try {
            // Load data from the same source as the main app
            const data = authManager.getUserData('lensAppData');
            let parsedData = {};
            
            if (data) {
                parsedData = typeof data === 'string' ? JSON.parse(data) : data;
            }
            
            // Connect to existing global variables and localStorage data
            this.monthlyIncome = window.monthlyIncome || parsedData.monthlyIncome || parseFloat(localStorage.getItem('monthlyIncome')) || 0;
            this.monthlyBudget = window.monthlyBudget || parsedData.monthlyBudget || parseFloat(localStorage.getItem('monthlyBudget')) || 0;
            this.expenses = window.expenses || parsedData.expenses || JSON.parse(localStorage.getItem('expenses') || '[]');
            this.goals = window.userGoals || parsedData.userGoals || JSON.parse(localStorage.getItem('userGoals') || '[]');
            this.recurringExpenses = window.recurringItems || parsedData.recurringItems || JSON.parse(localStorage.getItem('recurringItems') || '[]');
            
            // Load daily budget from the main settings field
            const dailyBudgetInput = document.getElementById('settings-daily-budget');
            const dailyBudgetValue = dailyBudgetInput ? parseFloat(dailyBudgetInput.value) : 0;
            
            // Use the daily budget from settings, or calculate from monthly if empty
            this.dailyBudget = dailyBudgetValue > 0 ? dailyBudgetValue : (this.monthlyBudget / 30);
            
            // Load coaching and income display settings
            const savedDailyBudgetEnabled = localStorage.getItem('dailyBudgetEnabled');
            const savedIncomeEnabled = localStorage.getItem('monthlyIncomeEnabled');
            
            this.dailyBudgetEnabled = savedDailyBudgetEnabled === 'true';
            this.monthlyIncomeEnabled = savedIncomeEnabled === 'true';
            
            console.log('Loaded financial data:', {
                income: this.monthlyIncome,
                budget: this.monthlyBudget,
                dailyBudget: this.dailyBudget,
                dailyBudgetEnabled: this.dailyBudgetEnabled,
                expenseCount: this.expenses.length
            });
        } catch (error) {
            console.error('Error loading financial data:', error);
        }
    }

    getCurrentMonthExpenses() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        return this.expenses.filter(expense => {
            const expenseDate = new Date(expense.date);
            return expenseDate.getMonth() === currentMonth && 
                   expenseDate.getFullYear() === currentYear;
        });
    }

    getTodayExpenses() {
        const today = new Date();
        const todayString = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
        
        return this.expenses.filter(expense => {
            return expense.date === todayString;
        });
    }

    calculateDailySpendingByDay() {
        const currentExpenses = this.getCurrentMonthExpenses();
        const dailyTotals = {};
        
        // Initialize all days of the month
        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        
        for (let i = 1; i <= daysInMonth; i++) {
            dailyTotals[i] = 0;
        }
        
        // Sum expenses by day - ensure we're reading actual transaction amounts
        currentExpenses.forEach(expense => {
            try {
                const expenseDate = new Date(expense.date);
                const day = expenseDate.getDate();
                const amount = parseFloat(expense.cost) || 0;
                
                // Only count positive amounts (actual spending)
                if (amount > 0 && day >= 1 && day <= daysInMonth) {
                    dailyTotals[day] += amount;
                }
            } catch (error) {
                console.warn('Error processing expense:', expense, error);
            }
        });
        
        console.log('Daily spending calculated:', dailyTotals);
        return dailyTotals;
    }

    calculateInsights() {
        const currentMonthExpenses = this.getCurrentMonthExpenses();
        const todayExpenses = this.getTodayExpenses();
        const oneTimeTotal = currentMonthExpenses.reduce((sum, exp) => sum + (parseFloat(exp.cost) || 0), 0);
        const recurringTotal = this.calculateMonthlyRecurringTotal();
        const totalSpent = oneTimeTotal + recurringTotal;
        const todaySpent = todayExpenses.reduce((sum, exp) => sum + (parseFloat(exp.cost) || 0), 0);
        
        const remainingBudget = this.monthlyBudget - totalSpent;
        const spentPercentage = this.monthlyBudget > 0 ? (totalSpent / this.monthlyBudget) * 100 : 0;
        
        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        const dayOfMonth = today.getDate();
        const daysRemaining = daysInMonth - dayOfMonth;
        
        // Daily budget calculations
        const todayRemaining = this.dailyBudget - todaySpent;
        const isOverDailyBudget = todaySpent > this.dailyBudget;
        
        // Simple projection
        const dailyAverage = oneTimeTotal / dayOfMonth;
        const projectedTotal = (dailyAverage * daysInMonth) + recurringTotal;

        return {
            totalSpent,
            remainingBudget,
            spentPercentage,
            projectedTotal,
            dailyAverage,
            daysInMonth,
            dayOfMonth,
            daysRemaining,
            todaySpent,
            todayRemaining,
            isOverDailyBudget,
            oneTimeTotal,
            recurringTotal,
            currentMonthExpenses
        };
    }

    calculateMonthlyRecurringTotal() {
        // CRITICAL FIX: Only include recurring EXPENSES, not income
        const recurringExpensesOnly = this.recurringExpenses.filter(item => 
            item.type === 'expense' && item.status === 'active'
        );
        
        return recurringExpensesOnly.reduce((total, item) => {
            const amount = parseFloat(item.amount) || 0;
            switch (item.frequency) {
                case 'weekly': return total + (amount * 4.33);
                case 'bi-weekly': return total + (amount * 2.17);
                case 'monthly': return total + amount;
                case 'quarterly': return total + (amount / 3);
                case 'annually': return total + (amount / 12);
                default: return total + amount;
            }
        }, 0);
    }

    generateDailyCoaching() {
        const insights = this.calculateInsights();
        const container = document.getElementById('daily-coaching-container');
        
        if (!container) return;
        
        let coachingMessage = '';
        let badgeClass = '';
        
        if (!this.dailyBudgetEnabled) {
            coachingMessage = `💡 Enable daily budget in settings to get real-time spending guidance throughout the day.`;
            badgeClass = 'alert';
        } else if (insights.todaySpent === 0) {
            coachingMessage = `🌟 Great start! You have £${this.dailyBudget.toFixed(2)} to spend today.`;
            badgeClass = '';
        } else if (insights.isOverDailyBudget) {
            const overage = insights.todaySpent - this.dailyBudget;
            coachingMessage = `⚠️ You've spent £${overage.toFixed(2)} over today's budget. Consider making coffee at home or postponing non-essential purchases.`;
            badgeClass = 'warning';
        } else if (insights.todayRemaining < (this.dailyBudget * 0.2)) {
            coachingMessage = `🎯 Almost at your daily limit! £${insights.todayRemaining.toFixed(2)} remaining for today.`;
            badgeClass = 'alert';
        } else {
            coachingMessage = `✅ Doing great! £${insights.todayRemaining.toFixed(2)} left for today. You're ${insights.daysRemaining} days away from month-end.`;
            badgeClass = '';
        }
        
        container.innerHTML = `
            <div class="daily-coaching-badge ${badgeClass}">
                ${coachingMessage}
            </div>
        `;
    }

    updateMetrics() {
        const insights = this.calculateInsights();
        
        // Update metric cards
        const elements = {
            'monthly-budget-display': `£${this.monthlyBudget.toFixed(0)}`,
            'total-spent-display': `£${insights.totalSpent.toFixed(0)}`,
            'daily-budget-display': `£${this.dailyBudget.toFixed(0)}`,
            'today-spent-display': `£${insights.todaySpent.toFixed(0)}`
        };
        
        Object.entries(elements).forEach(([id, text]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        });
        
        // Update subtitles
        const budgetVsIncome = this.monthlyIncome > 0 ? (this.monthlyBudget / this.monthlyIncome * 100).toFixed(0) : 0;
        const dailyBudgetStatus = this.dailyBudgetEnabled ? 'Enabled' : 'Auto-calculated';
        
        const subtitles = {
            'budget-vs-income': `${budgetVsIncome}% of income`,
            'spent-vs-budget': `${insights.spentPercentage.toFixed(0)}% of budget`,
            'daily-budget-status': dailyBudgetStatus,
            'today-remaining': `£${Math.max(0, insights.todayRemaining).toFixed(0)} remaining today`
        };
        
        Object.entries(subtitles).forEach(([id, text]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        });
    }



    showNotification(type, message) {
        // Create notification if it doesn't exist
        let notification = document.getElementById('spending-notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'spending-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                max-width: 400px;
                padding: 12px 16px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            document.body.appendChild(notification);
        }
        
        // Set color based on type
        const colors = {
            critical: '#dc2626',
            warning: '#f59e0b',
            info: '#3b82f6'
        };
        
        notification.style.backgroundColor = colors[type] || colors.info;
        notification.textContent = message;
        
        // Show notification
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
        
        // Hide after 5 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
        }, 5000);
    }

    render() {
        this.updateMetrics();
        this.generateDailyCoaching();
        this.renderAlerts();
        this.renderCategoryBreakdown();
        this.renderInsights();
        this.renderCoaching();
    }

    renderAlerts() {
        const insights = this.calculateInsights();
        const container = document.getElementById('alerts-section');
        if (!container) return;
        
        const alerts = [];

        // Daily budget alerts
        if (this.dailyBudgetEnabled && insights.isOverDailyBudget) {
            const overage = insights.todaySpent - this.dailyBudget;
            alerts.push({
                type: 'warning',
                icon: '📅',
                title: 'Daily Budget Exceeded',
                message: `You're £${overage.toFixed(2)} over today's budget of £${this.dailyBudget.toFixed(2)}`,
                action: 'Try to keep tomorrow under budget to stay on track'
            });
        }

        // Monthly budget alerts
        if (insights.spentPercentage > 90) {
            alerts.push({
                type: 'warning',
                icon: '⚠️',
                title: 'Monthly Budget Alert',
                message: `You've used ${insights.spentPercentage.toFixed(0)}% of your monthly budget`,
                action: 'Consider reducing discretionary spending'
            });
        }

        if (alerts.length === 0) {
            container.innerHTML = `
                <div class="card p-4 rounded-lg col-span-full bg-green-50 border border-green-200">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">📈</div>
                        <div>
                            <h4 class="font-semibold text-gray-900">All Systems Green</h4>
                            <p class="text-gray-700 text-sm">Your spending is healthy and on track</p>
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = alerts.map(alert => `
            <div class="card p-4 rounded-lg ${alert.type === 'warning' ? 'bg-yellow-50 border border-yellow-200' : 'bg-red-50 border border-red-200'}">
                <div class="flex items-start gap-3">
                    <div class="text-2xl">${alert.icon}</div>
                    <div class="flex-1">
                        <h4 class="font-semibold mb-1" style="color: var(--color-text-primary);">${alert.title}</h4>
                        <p class="text-sm mb-2" style="color: var(--color-text-primary);">${alert.message}</p>
                        <p class="text-xs font-medium" style="color: var(--color-text-primary);">${alert.action}</p>
                    </div>
                </div>
            </div>
        `).join('');
    }

    renderCategoryBreakdown() {
        this.renderCategorySpendingBreakdown();
        this.createCategoryDonutChart();
    }

    renderCategorySpendingBreakdown() {
        const container = document.getElementById('category-spending-breakdown');
        if (!container) return;
        
        const currentMonthExpenses = this.getCurrentMonthExpenses();
        const totalSpent = currentMonthExpenses.reduce((sum, expense) => sum + expense.cost, 0);
        
        if (totalSpent === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">No expenses this month yet</p>';
            return;
        }
        
        // Group expenses by category and calculate totals
        const categoryTotals = {};
        currentMonthExpenses.forEach(expense => {
            const category = expense.category || 'Other';
            categoryTotals[category] = (categoryTotals[category] || 0) + expense.cost;
        });
        
        // Sort categories by spending amount
        const sortedCategories = Object.entries(categoryTotals)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5); // Top 5 categories
        
        // Define colors for progress bars
        const colors = [
            'bg-green-500',    // Food
            'bg-purple-500',   // Entertainment
            'bg-orange-500',   // Shopping
            'bg-red-500',      // Bills
            'bg-blue-500'      // Transport
        ];
        
        const formatCurrency = (amount) => `£${amount.toFixed(2)}`;
        
        container.innerHTML = sortedCategories.map(([category, amount], index) => {
            const percentage = Math.round((amount / totalSpent) * 100);
            const progressWidth = Math.max(percentage, 5); // Minimum 5% for visibility
            const color = colors[index] || 'bg-gray-500';
            
            return `
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <h5 class="font-medium text-gray-900 dark:text-white">${category}</h5>
                        <span class="text-lg font-bold text-gray-900 dark:text-white">${formatCurrency(amount)}</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="${color} h-2 rounded-full transition-all duration-300" style="width: ${progressWidth}%"></div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${percentage}% of total spending</p>
                </div>
            `;
        }).join('');
    }

    createCategoryDonutChart() {
        const canvas = document.getElementById('category-donut-chart');
        const legendContainer = document.getElementById('category-chart-legend');
        
        if (!canvas || !legendContainer) return;
        
        // Destroy existing chart
        if (this.categoryChart) {
            this.categoryChart.destroy();
        }
        
        const currentMonthExpenses = this.getCurrentMonthExpenses();
        const totalSpent = currentMonthExpenses.reduce((sum, expense) => sum + expense.cost, 0);
        
        if (totalSpent === 0) {
            canvas.style.display = 'none';
            legendContainer.innerHTML = '<p class="text-gray-500 text-sm col-span-2">No data to display</p>';
            return;
        }
        
        canvas.style.display = 'block';
        
        // Group expenses by category
        const categoryTotals = {};
        currentMonthExpenses.forEach(expense => {
            const category = expense.category || 'Other';
            categoryTotals[category] = (categoryTotals[category] || 0) + expense.cost;
        });
        
        // Sort and get top categories
        const sortedCategories = Object.entries(categoryTotals)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5);
        
        const labels = sortedCategories.map(([category]) => category);
        const data = sortedCategories.map(([, amount]) => amount);
        
        // Define colors
        const backgroundColors = [
            '#10b981', // Green for Food
            '#3b82f6', // Blue for Transport  
            '#8b5cf6', // Purple for Entertainment
            '#f59e0b', // Orange for Shopping
            '#ef4444'  // Red for Bills
        ];
        
        const ctx = canvas.getContext('2d');
        this.categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        callbacks: {
                            label: function(context) {
                                const percentage = Math.round((context.parsed / totalSpent) * 100);
                                return `${context.label}: £${context.parsed.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                },
                elements: {
                    arc: {
                        borderWidth: 0
                    }
                }
            }
        });
        
        // Create legend
        legendContainer.innerHTML = labels.map((label, index) => {
            const color = backgroundColors[index];
            return `
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full" style="background-color: ${color}"></div>
                    <span class="text-sm" style="color: var(--color-text-primary)">${label}</span>
                </div>
            `;
        }).join('');
    }

    renderInsights() {
        const container = document.getElementById('insights-container');
        if (!container) return;
        
        const insights = this.calculateInsights();
        
        const insightsList = [
            {
                icon: '📊',
                title: 'Spending Pattern',
                description: `You're averaging £${insights.dailyAverage.toFixed(2)} per day in expenses.`,
                type: 'info'
            },
            {
                icon: '🎯',
                title: 'Monthly Projection',
                description: `At current rate, you'll spend £${insights.projectedTotal.toFixed(2)} this month.`,
                type: insights.projectedTotal > this.monthlyBudget ? 'warning' : 'success'
            }
        ];

        container.innerHTML = insightsList.map(insight => `
            <div class="flex items-start gap-4 p-4 rounded-lg ${insight.type === 'warning' ? 'bg-yellow-50 border border-yellow-200' : insight.type === 'success' ? 'bg-green-50 border border-green-200' : 'bg-blue-50 border border-blue-200'}">
                <div class="text-2xl">${insight.icon}</div>
                <div class="flex-1">
                    <h4 class="font-semibold mb-1" style="color: var(--color-text-primary);">${insight.title}</h4>
                    <p class="text-sm" style="color: var(--color-text-primary);">${insight.description}</p>
                </div>
            </div>
        `).join('');
    }

    renderCoaching() {
        const container = document.getElementById('coaching-panel');
        if (!container) return;
        
        const insights = this.calculateInsights();
        
        const recommendations = [
            {
                title: 'Budget Status',
                value: insights.spentPercentage > 90 ? 'Caution' : 'Healthy',
                subtitle: 'Current month status',
                type: insights.spentPercentage > 90 ? 'warning' : 'success'
            },
            {
                title: 'Days Remaining',
                value: insights.daysRemaining.toString(),
                subtitle: 'In this month',
                type: 'info'
            },
            {
                title: 'Daily Average',
                value: `£${insights.dailyAverage.toFixed(0)}`,
                subtitle: 'Current spending rate',
                type: 'info'
            }
        ];

        container.innerHTML = recommendations.map(rec => `
            <div class="text-center p-4 rounded-lg bg-gray-50">
                <div class="text-2xl font-bold ${rec.type === 'success' ? 'text-green-600' : rec.type === 'warning' ? 'text-red-600' : 'text-blue-600'}">${rec.value}</div>
                <div class="text-sm font-medium text-gray-700">${rec.title}</div>
                <div class="text-xs text-gray-500">${rec.subtitle}</div>
            </div>
        `).join('');
    }


    // Method to refresh insights (called when expenses are added/updated)
    refresh() {
        this.loadFinancialData();
        this.render();
    }
}

// ===========================
// 7-DAY TREND CHART (Dashboard)
// ===========================

function initializeSevenDayTrendChart() {
    const ctx = document.getElementById('seven-day-trend-chart');
    if (!ctx) {
        console.error('❌ Canvas element not found: seven-day-trend-chart');
        return;
    }
    
    console.log('✅ Initializing 7-Day Trend Chart');
    
    // Destroy existing chart if it exists
    if (sevenDayTrendChart) {
        sevenDayTrendChart.destroy();
        sevenDayTrendChart = null;
    }
    
    // Get theme for styling
    const isDark = document.documentElement.classList.contains('dark');
    
    sevenDayTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Daily Spending',
                data: [],
                borderColor: function(context) {
                    if (!context.parsed) return '#3b82f6';
                    const spendingAmount = context.parsed.y;
                    const dailyBudgetAmount = getActualDailyBudget();
                    
                    if (spendingAmount === 0) {
                        return '#94a3b8'; // Grey for no spend days
                    } else if (spendingAmount > dailyBudgetAmount && dailyBudgetAmount > 0) {
                        return '#ef4444'; // Red for over budget
                    } else {
                        return '#10b981'; // Green for under budget
                    }
                },
                backgroundColor: function(context) {
                    if (!context.parsed) return 'rgba(59, 130, 246, 0.1)';
                    const spendingAmount = context.parsed.y;
                    const dailyBudgetAmount = getActualDailyBudget();
                    
                    if (spendingAmount === 0) {
                        return 'rgba(148, 163, 184, 0.1)'; // Grey for no spend days
                    } else if (spendingAmount > dailyBudgetAmount && dailyBudgetAmount > 0) {
                        return 'rgba(239, 68, 68, 0.1)'; // Red for over budget
                    } else {
                        return 'rgba(16, 185, 129, 0.1)'; // Green for under budget
                    }
                },
                pointBackgroundColor: function(context) {
                    if (!context.parsed) return '#3b82f6';
                    const spendingAmount = context.parsed.y;
                    const dailyBudgetAmount = getActualDailyBudget();
                    
                    if (spendingAmount === 0) {
                        return '#94a3b8'; // Grey for no spend days
                    } else if (spendingAmount > dailyBudgetAmount && dailyBudgetAmount > 0) {
                        return '#ef4444'; // Red for over budget
                    } else {
                        return '#10b981'; // Green for under budget
                    }
                },
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const dataIndex = elements[0].index;
                    const dataPoint = sevenDayTrendChart.data.datasets[0].data[dataIndex];
                    const clickedDate = new Date(dataPoint.x);
                    
                    // Navigate to expenses tab with date filter
                    showTab('expenses');
                    
                    // Set date filter to the clicked day
                    setTimeout(() => {
                        const dateFrom = document.getElementById('expense-filter-date-from');
                        const dateTo = document.getElementById('expense-filter-date-to');
                        const dateStr = clickedDate.toISOString().split('T')[0];
                        
                        if (dateFrom && dateTo) {
                            dateFrom.value = dateStr;
                            dateTo.value = dateStr;
                            
                            // Trigger filter update
                            renderExpensesTable();
                        }
                    }, 100);
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: isDark ? '#1f2937' : '#ffffff',
                    titleColor: isDark ? '#f9fafb' : '#111827',
                    bodyColor: isDark ? '#e5e7eb' : '#374151',
                    borderColor: isDark ? '#374151' : '#d1d5db',
                    borderWidth: 1,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13,
                        weight: '500'
                    },
                    callbacks: {
                        title: function(context) {
                            const date = new Date(context[0].parsed.x);
                            return date.toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        },
                        label: function(context) {
                            const amount = context.parsed.y;
                            const dailyBudget = getActualDailyBudget();
                            let label = `Spent: ${formatCurrency(amount)}`;
                            
                            if (dailyBudget > 0) {
                                if (amount === 0) {
                                    label += '\n💰 No spending today';
                                } else if (amount > dailyBudget) {
                                    label += `\n⚠️ Over budget by ${formatCurrency(amount - dailyBudget)}`;
                                } else {
                                    label += `\n✅ Under budget by ${formatCurrency(dailyBudget - amount)}`;
                                }
                            }
                            
                            return label;
                        },
                        afterLabel: function(context) {
                            return 'Click to view expenses for this day';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'dd'
                        }
                    },
                    grid: {
                        display: true,
                        color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        color: isDark ? '#f3f4f6' : '#1f2937',
                        font: {
                            size: 12,
                            weight: '600'
                        },
                        maxTicksLimit: 7
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        color: isDark ? '#f3f4f6' : '#1f2937',
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    updateSevenDayTrendChart();
}

function updateSevenDayTrendChart() {
    if (!sevenDayTrendChart) return;
    
    // Get last 7 days of spending data
    const chartData = getSevenDaySpendingData();
    sevenDayTrendChart.data.datasets[0].data = chartData;
    sevenDayTrendChart.update('none');
}

function getSevenDaySpendingData() {
    const data = [];
    const today = new Date();
    
    console.log('🔍 FIXED: Getting exactly 7 days of spending data for dashboard trend');
    
    // Generate exactly 7 days (including today) - FIXED
    for (let i = 6; i >= 0; i--) {
        const date = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
        const dateStr = date.getFullYear() + '-' + 
                       String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(date.getDate()).padStart(2, '0');
        
        // Calculate total spending for this day (only active expenses)
        const dayTotal = expenses
            .filter(expense => {
                if (expense.status !== 'active') return false;
                // Use string comparison for consistent date matching
                const expenseDate = expense.date.split('T')[0]; // Handle ISO format
                return expenseDate === dateStr;
            })
            .reduce((sum, expense) => {
                const cost = parseFloat(expense.cost || expense.amount || 0);
                return sum + (isNaN(cost) ? 0 : cost);
            }, 0);
        
        // Always add a data point for each day (even if spending is 0)
        data.push({
            x: date.getTime(),
            y: dayTotal,
            dateString: dateStr,
            dayIndex: 6 - i + 1 // Day 1-7 for proper labeling
        });
        
        console.log(`Day ${7-i}: ${dateStr} (${date.toDateString()}) = £${dayTotal.toFixed(2)}`);
    }
    
    console.log(`✅ Generated ${data.length} data points for 7-day trend`);
    return data;
}

// ===========================
// DAILY SPENDING INSIGHTS CHART
// ===========================

// Initialize the daily spending insights chart
function initializeDailySpendingInsightsChart() {
    const ctx = document.getElementById('daily-spending-insights-chart');
    if (!ctx) {
        console.error('❌ Canvas element not found: daily-spending-insights-chart');
        return;
    }
    
    console.log('✅ Initializing Daily Spending Chart');
    
    // CRITICAL: Destroy existing chart first
    if (dailySpendingInsightsChart) {
        dailySpendingInsightsChart.destroy();
        dailySpendingInsightsChart = null;
    }
    
    // CRITICAL: Ensure period matches the active button on initialization
    const activeButton = document.querySelector('.period-toggle.active');
    if (activeButton) {
        currentInsightsPeriod = activeButton.getAttribute('data-period') || '7days';
        console.log('✅ Set period from active button:', currentInsightsPeriod);
    }
    
    // Get theme for styling
    const isDark = document.documentElement.classList.contains('dark');
    
    // Create chart with proper configuration
    dailySpendingInsightsChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Daily Spending',
                data: [],
                backgroundColor: function(context) {
                    if (!context.parsed) return '#94a3b8';
                    
                    const spendingAmount = context.parsed.y;
                    const dailyBudgetAmount = getActualDailyBudget();
                    
                    if (spendingAmount === 0) {
                        return '#94a3b8'; // Grey for no spend days
                    } else if (spendingAmount > dailyBudgetAmount && dailyBudgetAmount > 0) {
                        return '#ef4444'; // Red for over budget
                    } else {
                        return '#10b981'; // Green for under budget
                    }
                },
                borderColor: function(context) {
                    if (!context.parsed) return '#64748b';
                    
                    const spendingAmount = context.parsed.y;
                    const dailyBudgetAmount = getActualDailyBudget();
                    
                    if (spendingAmount === 0) {
                        return '#64748b'; // Grey border for no spend days
                    } else if (spendingAmount > dailyBudgetAmount && dailyBudgetAmount > 0) {
                        return '#dc2626'; // Dark red border for over budget
                    } else {
                        return '#059669'; // Dark green border for under budget
                    }
                },
                borderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
                showLine: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'point'
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'MMM dd'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Date',
                        color: isDark ? '#cbd5e1' : '#64748b'
                    },
                    ticks: {
                        color: isDark ? '#cbd5e1' : '#64748b'
                    },
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.02)'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (£)',
                        color: isDark ? '#cbd5e1' : '#64748b'
                    },
                    ticks: {
                        color: isDark ? '#cbd5e1' : '#64748b',
                        callback: function(value) {
                            return '£' + value.toFixed(0);
                        }
                    },
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.02)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'center',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 12,
                            weight: '500'
                        },
                        generateLabels: function(chart) {
                            // Get current state of toggles
                            const dailyEnabled = localStorage.getItem('dailyBudgetLineEnabled') !== 'false';
                            const monthlyEnabled = localStorage.getItem('monthlyBudgetLineEnabled') !== 'false';
                            const incomeEnabled = localStorage.getItem('monthlyIncomeLineEnabled') !== 'false';
                            
                            // Get current theme for text color
                            const isDarkMode = document.documentElement.classList.contains('dark');
                            const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
                            
                            return [
                                {
                                    text: 'Daily Budget',
                                    fillStyle: dailyEnabled ? '#f59e0b' : '#9ca3af',
                                    strokeStyle: dailyEnabled ? '#f59e0b' : '#9ca3af',
                                    fontColor: textColor,
                                    lineWidth: 2,
                                    lineDash: [5, 5],
                                    pointStyle: 'line'
                                },
                                {
                                    text: 'Monthly Budget', 
                                    fillStyle: monthlyEnabled ? '#8b5cf6' : '#9ca3af',
                                    strokeStyle: monthlyEnabled ? '#8b5cf6' : '#9ca3af',
                                    fontColor: textColor,
                                    lineWidth: 2,
                                    lineDash: [10, 5],
                                    pointStyle: 'line'
                                },
                                {
                                    text: 'Monthly Income',
                                    fillStyle: incomeEnabled ? '#06b6d4' : '#9ca3af',
                                    strokeStyle: incomeEnabled ? '#06b6d4' : '#9ca3af',
                                    fontColor: textColor,
                                    lineWidth: 2,
                                    lineDash: [15, 5],
                                    pointStyle: 'line'
                                }
                            ];
                        },
                        color: isDark ? '#cbd5e1' : '#64748b'
                    },
                    onClick: function(evt, legendItem, legend) {
                        // Legend click handler for toggling lines
                        const chart = legend.chart;
                        const text = legendItem.text;
                        
                        console.log('🖱️ Legend clicked:', text);
                        
                        if (text === 'Daily Budget') {
                            const currentSetting = localStorage.getItem('dailyBudgetLineEnabled') !== 'false';
                            localStorage.setItem('dailyBudgetLineEnabled', (!currentSetting).toString());
                            console.log('Daily budget line toggled to:', !currentSetting);
                            updateDailyBudgetLineAnnotation();
                        } else if (text === 'Monthly Budget') {
                            const currentSetting = localStorage.getItem('monthlyBudgetLineEnabled') !== 'false'; 
                            localStorage.setItem('monthlyBudgetLineEnabled', (!currentSetting).toString());
                            console.log('Monthly budget line toggled to:', !currentSetting);
                            updateMonthlyBudgetLineAnnotation();
                        } else if (text === 'Monthly Income') {
                            const currentSetting = localStorage.getItem('monthlyIncomeLineEnabled') !== 'false';
                            localStorage.setItem('monthlyIncomeLineEnabled', (!currentSetting).toString()); 
                            console.log('Monthly income line toggled to:', !currentSetting);
                            updateMonthlyIncomeLineAnnotation();
                        }
                        
                        // Force legend regeneration to update colors
                        setTimeout(() => {
                            chart.update('none');
                        }, 100);
                    }
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: isDark ? '#1e293b' : '#ffffff',
                    titleColor: isDark ? '#f1f5f9' : '#1e293b',
                    bodyColor: isDark ? '#f1f5f9' : '#1e293b',
                    borderColor: isDark ? '#475569' : '#e2e8f0',
                    borderWidth: 1,
                    callbacks: {
                        title: function(context) {
                            if (!context || !context[0]) return 'No data';
                            
                            const dataPoint = context[0];
                            const timestamp = dataPoint.parsed.x;
                            const date = new Date(timestamp);
                            
                            // Fix date formatting for tooltips
                            const today = new Date();
                            const yesterday = new Date(today);
                            yesterday.setDate(yesterday.getDate() - 1);
                            
                            // Create date without time for comparison
                            const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                            const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                            const yesterdayDate = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
                            
                            if (targetDate.getTime() === todayDate.getTime()) {
                                return 'Today';
                            } else if (targetDate.getTime() === yesterdayDate.getTime()) {
                                return 'Yesterday';
                            } else {
                                // Format as "13 Jul" not "018"
                                return date.toLocaleDateString('en-GB', { 
                                    day: 'numeric', 
                                    month: 'short' 
                                });
                            }
                        },
                        label: function(context) {
                            const amount = context.parsed.y;
                            if (amount === 0) {
                                return 'No spending today';
                            }
                            return `Spent: £${amount.toFixed(2)}`;
                        },
                        afterBody: function(context) {
                            if (!context || !context[0]) return [];
                            
                            const dataPoint = context[0];
                            const amount = dataPoint.parsed.y;
                            
                            if (amount === 0) return ['Click to view expenses for this day'];
                            
                            // Find expenses for this day
                            const timestamp = dataPoint.parsed.x;
                            const date = new Date(timestamp);
                            const dateStr = date.getFullYear() + '-' + 
                                           String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                                           String(date.getDate()).padStart(2, '0');
                            
                            const dayExpenses = expenses.filter(expense => {
                                if (expense.status !== 'active') return false;
                                const expenseDate = expense.date.split('T')[0];
                                return expenseDate === dateStr;
                            });
                            
                            if (dayExpenses.length === 0) return ['Click to view expenses for this day'];
                            
                            const lines = ['', 'Expenses:'];
                            dayExpenses.slice(0, 3).forEach(expense => {
                                const cost = parseFloat(expense.cost || expense.amount || 0);
                                lines.push(`• ${expense.description || 'Expense'}: £${cost.toFixed(2)}`);
                            });
                            
                            if (dayExpenses.length > 3) {
                                lines.push(`• ... and ${dayExpenses.length - 3} more`);
                            }
                            
                            lines.push('', 'Click to view all expenses');
                            return lines;
                        }
                    }
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    console.log('Chart clicked:', elements[0]);
                }
            }
        }
    });
    
    // Load data immediately with correct period
    updateDailySpendingInsightsChart();
    
    // Apply the advanced tooltip system after initialization
    setTimeout(() => {
        applyAdvancedTooltipSystem();
        // Initialize all reference lines
        updateDailyBudgetLineAnnotation();
        updateMonthlyBudgetLineAnnotation();
        updateMonthlyIncomeLineAnnotation();
    }, 500);
    
    console.log('✅ Chart initialized with period:', currentInsightsPeriod);
}

// Update the insights chart with real data - moved to new enhanced version below

// Get daily spending data for insights chart (uses your existing expenses array)
function getDailySpendingInsightsData() {
    console.log('🔍 FIXED: Getting daily spending data for period:', currentInsightsPeriod);
    
    if (!expenses || expenses.length === 0) {
        console.log('⚠️ No expenses data available');
        return [];
    }
    
    // Determine number of days based on current period
    const days = currentInsightsPeriod === '7days' ? 7 : 
                 currentInsightsPeriod === '30days' ? 30 : 90;
    
    // CRITICAL FIX: Use proper local date calculation
    const today = new Date();
    const endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    
    // Generate the last N days including today
    const dates = [];
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
        const dateStr = date.getFullYear() + '-' + 
                       String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(date.getDate()).padStart(2, '0');
        dates.push(dateStr);
    }
    
    console.log('📅 DATES GENERATED:', dates.slice(0, 3), '...', dates.slice(-3));
    
    // Initialize daily totals for all dates
    const dailyTotals = {};
    dates.forEach(dateStr => {
        dailyTotals[dateStr] = 0;
    });
    
    // Sum expenses by date
    expenses.forEach(expense => {
        if (expense.status !== 'active') return;
        
        const expenseDate = expense.date;
        if (dailyTotals.hasOwnProperty(expenseDate)) {
            const amount = parseFloat(expense.cost || expense.amount || 0);
            if (!isNaN(amount) && amount > 0) {
                dailyTotals[expenseDate] += amount;
            }
        }
    });
    
    // Convert to chart data format with proper date objects
    const chartData = dates.map(dateStr => {
        // Create proper date for Chart.js
        const [year, month, day] = dateStr.split('-').map(Number);
        const dateObj = new Date(year, month - 1, day);
        
        return {
            x: dateObj.getTime(), // Use timestamp for Chart.js
            y: dailyTotals[dateStr],
            dateString: dateStr // Keep string for expense lookup
        };
    });
    
    console.log(`📊 Generated ${chartData.length} data points for ${days} days`);
    console.log('Sample data with dates:', chartData.slice(0, 3).map(d => ({ 
        date: new Date(d.x).toDateString(), 
        amount: d.y, 
        dateString: d.dateString 
    })));
    
    return chartData;
}

// Set chart period
function setInsightsPeriod(period) {
    console.log('🔄 FIXED: Switching to period:', period);
    
    // CRITICAL: Validate period parameter
    if (!period || !['7days', '30days', '90days'].includes(period)) {
        console.error('❌ Invalid period:', period);
        return;
    }
    
    // Update the global period variable FIRST
    currentInsightsPeriod = period;
    console.log('✅ Period set to:', currentInsightsPeriod);
    
    // Update button states - CRITICAL FIX
    document.querySelectorAll('.period-toggle').forEach(btn => {
        btn.classList.remove('active');
        // Reset to inactive styling
        btn.className = 'period-toggle px-4 py-2 rounded-lg font-medium transition-all duration-200 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 shadow-sm hover:shadow-md transform hover:scale-105';
    });
    
    const activeBtn = document.querySelector(`[data-period="${period}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        // Apply active styling
        activeBtn.className = 'period-toggle active px-4 py-2 rounded-lg font-medium transition-all duration-200 border-2 border-blue-500 bg-blue-500 text-white hover:bg-blue-600 hover:border-blue-600 shadow-sm hover:shadow-md transform hover:scale-105';
        console.log('✅ Button state updated for:', period);
    } else {
        console.error('❌ Button not found for period:', period);
        return;
    }
    
    // Update chart data for all periods (no special 90-day handling)
    updateDailySpendingInsightsChart();
    
    // Reapply tooltip system for new period
    setTimeout(() => {
        applyAdvancedTooltipSystem();
    }, 300);
    
    console.log('✅ Period switch completed:', period);
}

// Update legend values
function updateInsightsLegendValues() {
    const dailyElement = document.getElementById('insights-daily-budget-display');
    const monthlyElement = document.getElementById('insights-monthly-budget-display');
    const incomeElement = document.getElementById('insights-monthly-income-display');
    
    // Use your global variables (they should exist in your app)
    if (dailyElement) {
        dailyElement.textContent = dailyBudget > 0 ? dailyBudget.toFixed(0) : '--';
    }
    if (monthlyElement) {
        monthlyElement.textContent = monthlyBudget > 0 ? monthlyBudget.toFixed(0) : '--';
    }
    if (incomeElement) {
        incomeElement.textContent = monthlyIncome > 0 ? monthlyIncome.toFixed(0) : '--';
    }
    
    console.log('Updated legend values:', {
        daily: dailyBudget,
        monthly: monthlyBudget,
        income: monthlyIncome
    });
}

function debugExpenseStructure() {
    console.log('=== EXPENSE STRUCTURE DEBUG ===');
    console.log('Total expenses:', expenses.length);
    
    if (expenses.length > 0) {
        console.log('First expense structure:', expenses[0]);
        console.log('Expense properties:', Object.keys(expenses[0]));
        
        // Check what field contains the amount
        const firstExpense = expenses[0];
        console.log('Amount fields check:');
        console.log('- expense.amount:', firstExpense.amount);
        console.log('- expense.cost:', firstExpense.cost);
        console.log('- expense.value:', firstExpense.value);
        
        // Check active expenses
        const activeExpenses = expenses.filter(e => e.status === 'active');
        console.log('Active expenses:', activeExpenses.length);
        
        if (activeExpenses.length > 0) {
            console.log('Sample active expense:', activeExpenses[0]);
        }
    }
    
    console.log('Budget settings:');
    console.log('- dailyBudget:', dailyBudget);
    console.log('- monthlyBudget:', monthlyBudget);
    console.log('- monthlyIncome:', monthlyIncome);
    console.log('================================');
}

// 🔥 ADD: Function to manually test chart data
function testChartData() {
    console.log('🧪 Testing chart data generation...');
    
    debugExpenseStructure();
    
    const chartData = getDailySpendingInsightsData();
    console.log('Generated chart data:', chartData);
    
    const totalSpending = chartData.reduce((sum, point) => sum + point.y, 0);
    console.log('Total spending in chart period:', totalSpending);
    
    // Test if chart exists
    const chartCanvas = document.getElementById('daily-spending-insights-chart');
    console.log('Chart canvas found:', !!chartCanvas);
    console.log('Chart instance exists:', !!dailySpendingInsightsChart);
    
    if (dailySpendingInsightsChart) {
        console.log('Current chart data:', dailySpendingInsightsChart.data.datasets[0].data);
    }
}

// Advanced Tooltip System - FIXED VERSION
function applyAdvancedTooltipSystem() {
    if (!dailySpendingInsightsChart) {
        console.log('⚠️ Chart not ready for tooltip application');
        return false;
    }
    
    console.log('🔧 Applying FIXED advanced tooltip system for period:', currentInsightsPeriod);
    
    // CRITICAL: Store chart data in closure to avoid stale references
    let currentChartData = getDailySpendingInsightsData();
    
    // Helper functions
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-GB', { 
            style: 'currency', 
            currency: 'GBP' 
        }).format(amount);
    }
    
    function getExpensesForDate(dateString) {
        if (!expenses || !Array.isArray(expenses)) return [];
        return expenses.filter(expense => 
            expense.date === dateString && 
            expense.status === 'active'
        );
    }
    
    function truncateText(text, maxLength = 20) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength - 3) + '...';
    }
    
    // CRITICAL FIX: Proper date parsing from chart data
    function getDateFromChartPoint(chartPoint) {
        // Chart point now has timestamp in x and dateString for lookup
        if (chartPoint.x) {
            return new Date(chartPoint.x);
        }
        return new Date();
    }
    
    // Apply the FIXED tooltip configuration
    dailySpendingInsightsChart.options.plugins.tooltip = {
        enabled: true,
        backgroundColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#ffffff',
        titleColor: document.documentElement.classList.contains('dark') ? '#f1f5f9' : '#1e293b',
        bodyColor: document.documentElement.classList.contains('dark') ? '#f1f5f9' : '#1e293b',
        borderColor: document.documentElement.classList.contains('dark') ? '#475569' : '#e2e8f0',
        borderWidth: 1,
        callbacks: {
            title: function(context) {
                if (context.length === 0) return '';
                
                const dataIndex = context[0].dataIndex;
                // CRITICAL FIX: Get current chart data
                const chartData = dailySpendingInsightsChart.data.datasets[0].data;
                const dataPoint = chartData[dataIndex];
                
                if (!dataPoint) return 'Unknown Date';
                
                // Use the timestamp to create proper date
                const date = new Date(dataPoint.x);
                console.log('🔍 TOOLTIP DATE:', date.toDateString(), 'from timestamp:', dataPoint.x);
                
                return date.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            },
            label: function(context) {
                const dataIndex = context.dataIndex;
                const amount = context.parsed.y;
                
                // CRITICAL FIX: Get the date string for expense lookup
                const chartData = dailySpendingInsightsChart.data.datasets[0].data;
                const dataPoint = chartData[dataIndex];
                const dateString = dataPoint?.dateString;
                
                if (!dateString) return [`Total spent: ${formatCurrency(amount)}`];
                
                console.log('🔍 LOOKING FOR EXPENSES ON:', dateString);
                const dayExpenses = getExpensesForDate(dateString);
                
                const lines = [];
                lines.push(`Total spent: ${formatCurrency(amount)}`);
                
                // Add budget comparison if daily budget is set
                const currentDailyBudget = getActualDailyBudget();
                if (currentDailyBudget > 0) {
                    if (amount > currentDailyBudget) {
                        lines.push(`⚠️ Over daily budget by ${formatCurrency(amount - currentDailyBudget)}`);
                    }
                }
                
                lines.push(`📊 ${dayExpenses.length} expense${dayExpenses.length !== 1 ? 's' : ''}`);
                
                // Show individual expenses (limit to prevent huge tooltips)
                if (dayExpenses.length > 0) {
                    lines.push(''); // Empty line for spacing
                    dayExpenses.slice(0, 5).forEach(expense => {
                        const cost = expense.cost || expense.amount || 0;
                        const description = expense.name || expense.description || expense.merchant || 'Unknown';
                        lines.push(`• ${truncateText(description)}: ${formatCurrency(cost)}`);
                    });
                    
                    if (dayExpenses.length > 5) {
                        lines.push(`... and ${dayExpenses.length - 5} more`);
                    }
                }
                
                return lines;
            }
        }
    };
    
    // FIXED: Enable click functionality for all periods with proper expense filtering
    dailySpendingInsightsChart.options.onClick = function(event, elements) {
        if (elements.length > 0) {
            const dataIndex = elements[0].index;
            const chartData = dailySpendingInsightsChart.data.datasets[0].data;
            const dataPoint = chartData[dataIndex];
            const dateString = dataPoint?.dateString;
            
            if (dateString) {
                console.log('📅 Clicked on date:', dateString);
                const dayExpenses = getExpensesForDate(dateString);
                console.log('Expenses for this day:', dayExpenses);
                
                // Navigate to expenses tab and filter by date
                if (typeof window.showTab === 'function') {
                    window.showTab('expenses');
                    
                    // Set date filters to the clicked date
                    setTimeout(() => {
                        const dateFromInput = document.getElementById('expense-filter-date-from');
                        const dateToInput = document.getElementById('expense-filter-date-to');
                        
                        if (dateFromInput && dateToInput) {
                            dateFromInput.value = dateString;
                            dateToInput.value = dateString;
                            
                            // Trigger the expense table update
                            if (typeof window.renderExpensesTable === 'function') {
                                window.renderExpensesTable();
                            }
                        }
                    }, 100);
                }
            }
        }
    };
    
    // CRITICAL: Force update to apply new configuration
    dailySpendingInsightsChart.update('resize');
    
    console.log('✅ FIXED advanced tooltip system applied successfully');
    return true;
}

// 🔥 ENSURE: Chart updates when you switch to insights tab
function ensureChartOnInsightsTab() {
    // Hook into tab switching to ensure chart initializes properly
    const originalShowTab = window.showTab;
    if (originalShowTab) {
        window.showTab = function(tabName) {
            const result = originalShowTab.apply(this, arguments);
            
            if (tabName === 'insights') {
                console.log('🎯 Switched to insights tab');
                setTimeout(() => {
                    // Check if chart needs initialization
                    if (!dailySpendingInsightsChart) {
                        initializeDailySpendingInsightsChart();
                    } else {
                        // Just update if already exists
                        updateDailySpendingInsightsChart();
                    }
                }, 100);
            }
            
            return result;
        };
    }
}

// Helper function to ensure chart updates on data changes
function ensureChartUpdatesOnDataChange() {
    // Update chart if on insights tab
    if (activeTab === 'insights' && dailySpendingInsightsChart) {
        setTimeout(() => {
            updateDailySpendingInsightsChart();
        }, 100);
    }
}

// Add this function to ensure chart initialization on insights tab
function initializeInsightsTab() {
    // Only initialize if we're on insights tab and chart doesn't exist
    if (activeTab === 'insights' && !dailySpendingInsightsChart) {
        setTimeout(() => {
            initializeDailySpendingInsightsChart();
        }, 100);
    }
}

// Debug Functions for Testing
window.debugChartIssues = function() {
    console.log('=== CHART DEBUG INFO ===');
    console.log('Current period:', currentInsightsPeriod);
    console.log('Chart exists:', !!dailySpendingInsightsChart);
    console.log('Canvas exists:', !!document.getElementById('daily-spending-insights-chart'));
    console.log('Expenses count:', expenses?.length || 0);
    console.log('Active button:', document.querySelector('.period-toggle.active')?.getAttribute('data-period'));
    
    if (dailySpendingInsightsChart) {
        console.log('Chart data points:', dailySpendingInsightsChart.data.datasets[0].data.length);
    }
    
    const chartData = getDailySpendingInsightsData();
    console.log('Generated data points:', chartData.length);
    console.log('Non-zero days:', chartData.filter(d => d.y > 0).length);
    console.log('========================');
};

window.forceReinitChart = function() {
    console.log('Force reinitializing chart...');
    if (dailySpendingInsightsChart) {
        dailySpendingInsightsChart.destroy();
        dailySpendingInsightsChart = null;
    }
    initializeDailySpendingInsightsChart();
};

window.test90DayChart = function() {
    console.log('🧪 Testing 90-day chart specifically...');
    console.log('Current period:', currentInsightsPeriod);
    
    // Force set to 90 days
    setInsightsPeriod('90days');
    
    setTimeout(() => {
        console.log('After 90-day switch:');
        console.log('- Chart exists:', !!dailySpendingInsightsChart);
        console.log('- Current period:', currentInsightsPeriod);
        console.log('- Active button:', document.querySelector('.period-toggle.active')?.textContent);
        
        const data = getDailySpendingInsightsData();
        console.log('- Data points:', data.length);
        console.log('- Sample data:', data.slice(0, 3));
        
        if (dailySpendingInsightsChart) {
            console.log('- Chart data points:', dailySpendingInsightsChart.data.datasets[0].data.length);
        }
    }, 1000);
};

// Debug helper function to help debug data issues
function debugChartData() {
    console.log('=== CHART DEBUG INFO ===');
    console.log('Expenses count:', expenses.length);
    console.log('Sample expenses:', expenses.slice(0, 3));
    console.log('Current period:', currentInsightsPeriod);
    console.log('Budget settings:', { dailyBudget, monthlyBudget, monthlyIncome });
    
    const chartData = getDailySpendingInsightsData();
    console.log('Chart data points:', chartData.length);
    console.log('Non-zero days:', chartData.filter(d => d.y > 0));
    console.log('========================');
}

// Daily spending chart fix confirmation
console.log('🎯 Daily Spending Chart fixes loaded! Your chart should now show correct data.');

// Enhanced budget alerts function (integrates with your existing notification system)
function checkDailySpendingAlerts(date, amount) {
    const alerts = [];

    // Calculate daily total for the date
    const dayTotal = expenses
        .filter(e => e.date === date)
        .reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);

    // Daily budget alert
    if (dailyBudget > 0 && dayTotal > dailyBudget) {
        alerts.push({
            type: 'warning',
            message: `⚠️ Daily spending exceeded! Spent ${formatCurrency(dayTotal)} vs budget of ${formatCurrency(dailyBudget)}`
        });
    }

    // Single expense exceeds monthly income alert
    if (monthlyIncome > 0 && amount > monthlyIncome) {
        alerts.push({
            type: 'danger',
            message: `🚨 CRITICAL: This ${formatCurrency(amount)} expense exceeds your entire monthly income!`
        });
    }

    // Monthly budget alert
    const thisMonthStart = new Date();
    thisMonthStart.setDate(1);
    const monthTotal = expenses
        .filter(e => new Date(e.date) >= thisMonthStart)
        .reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);

    if (monthlyBudget > 0 && monthTotal > monthlyBudget) {
        alerts.push({
            type: 'danger',
            message: `🚨 Monthly budget exceeded! Spent ${formatCurrency(monthTotal)} vs budget of ${formatCurrency(monthlyBudget)}`
        });
    }

    // Show alerts using your existing notification system
    alerts.forEach(alert => {
        if (typeof showToast === 'function') {
            showToast(alert.message, alert.type);
        }
    });
}


// ===========================
// UPDATE SHOWTAB FUNCTION
// ===========================

// Modify your existing showTab function to initialize insights
const originalShowTabInsights = window.showTab;
window.showTab = function(tabName) {
    // Call original showTab function
    if (originalShowTabInsights) {
        originalShowTabInsights(tabName);
    }
    
    // Initialize insights when insights tab is opened
    if (tabName === 'insights') {
        setTimeout(() => {
            if (!window.FinanceInsights) {
                window.FinanceInsights = new FinanceInsights();
            } else {
                window.FinanceInsights.refresh();
            }
            
            // Initialize the new daily spending insights chart
            initializeDailySpendingInsightsChart();
            
            // Update all the new sections
            updateTodaysSpendingDisplay();        // ADD THIS LINE
            updateCurrentSpendingRateDisplay();   // ADD THIS LINE
            updateCurrentSpendingRate();
            updateDailyBudgetCoach();
            updateSpendingBreakdown();
            updateTodaysBudget();
            
            // FORCE UPDATE after everything else
            forceInsightsUpdate();
        }, 500);
    }
};

// ===========================
// REFRESH INSIGHTS ON DATA CHANGES
// ===========================

// Override existing functions to refresh insights
const originalAddExpenseInsights = window.addExpense;
window.addExpense = function() {
    const result = originalAddExpenseInsights ? originalAddExpenseInsights.apply(this, arguments) : null;
    if (window.FinanceInsights && activeTab === 'insights') {
        setTimeout(() => {
            window.FinanceInsights.refresh();
            updateDailySpendingInsightsChart();
            updateTodaysSpendingDisplay();        // ADD THIS LINE
            updateCurrentSpendingRateDisplay();   // ADD THIS LINE
            updateCurrentSpendingRate();
            updateDailyBudgetCoach();
            updateSpendingBreakdown();
            updateTodaysBudget();
        }, 100);
    }
    
    // Check for spending alerts on new expenses
    if (arguments.length >= 2) {
        const date = arguments[0];
        const amount = parseFloat(arguments[1]) || 0;
        checkDailySpendingAlerts(date, amount);
    }
    
    return result;
};

const originalDeleteExpenseInsights = window.deleteExpense;
window.deleteExpense = function() {
    const result = originalDeleteExpenseInsights ? originalDeleteExpenseInsights.apply(this, arguments) : null;
    if (window.FinanceInsights && activeTab === 'insights') {
        setTimeout(() => {
            window.FinanceInsights.refresh();
            updateDailySpendingInsightsChart();
            updateTodaysSpendingDisplay();        // ADD THIS LINE
            updateCurrentSpendingRateDisplay();   // ADD THIS LINE
            updateCurrentSpendingRate();
            updateDailyBudgetCoach();
            updateSpendingBreakdown();
            updateTodaysBudget();
        }, 100);
    }
    return result;
};

// Update chart colors when theme changes
function updateChartTheme() {
    const isDarkMode = document.documentElement.classList.contains('dark');
    const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.02)';
    
    if (dailySpendingInsightsChart && activeTab === 'insights') {
        dailySpendingInsightsChart.options.scales.x.title.color = textColor;
        dailySpendingInsightsChart.options.scales.x.grid.color = gridColor;
        dailySpendingInsightsChart.options.scales.x.ticks.color = textColor;
        dailySpendingInsightsChart.options.scales.y.title.color = textColor;
        dailySpendingInsightsChart.options.scales.y.grid.color = gridColor;
        dailySpendingInsightsChart.options.scales.y.ticks.color = textColor;
        
        // Fix legend text color
        if (dailySpendingInsightsChart.options.plugins.legend) {
            dailySpendingInsightsChart.options.plugins.legend.labels.color = textColor;
        }
        
        dailySpendingInsightsChart.options.plugins.tooltip.backgroundColor = isDarkMode ? '#1a1d1f' : '#ffffff';
        dailySpendingInsightsChart.options.plugins.tooltip.titleColor = isDarkMode ? '#f8f9fa' : '#0f1419';
        dailySpendingInsightsChart.options.plugins.tooltip.bodyColor = isDarkMode ? '#cbd5e1' : '#64748b';
        dailySpendingInsightsChart.options.plugins.tooltip.borderColor = isDarkMode ? '#334155' : '#e2e8f0';
        
        dailySpendingInsightsChart.update('none');
    }
    
    // Update category chart legend colors
    if (window.insightsDashboard && window.insightsDashboard.categoryChart) {
        if (window.insightsDashboard.categoryChart.options.plugins.legend) {
            window.insightsDashboard.categoryChart.options.plugins.legend.labels.color = textColor;
        }
        window.insightsDashboard.categoryChart.update('none');
    }
}

// ===========================
// SETTINGS INTEGRATION WITH CONSOLIDATED SYSTEM
// ===========================

// New function for the consolidated daily budget coaching toggle
function toggleDailyBudgetCoaching() {
    const enabled = document.getElementById('daily-budget-enabled').checked;
    localStorage.setItem('dailyBudgetEnabled', enabled.toString());
    
    // Refresh insights when coaching is toggled
    if (window.FinanceInsights && activeTab === 'insights') {
        setTimeout(() => window.FinanceInsights.refresh(), 100);
    }
    
    console.log('Daily budget coaching', enabled ? 'enabled' : 'disabled');
}

// ===========================
// SMART DAILY BUDGET DETECTION
// ===========================

/**
 * SMART DAILY BUDGET DETECTION
 * - Auto-calculates from monthly budget (monthlyBudget / 30) when daily budget not set
 * - Uses the actual manually set amount if user overrides auto calculated amount
 * - Maintains proper correlation between budget settings and chart display
 */
function getActualDailyBudget() {
    // 1. Check if user has manually set a daily budget (dailyBudgetOverride is true)
    if (typeof dailyBudgetOverride !== 'undefined' && dailyBudgetOverride && typeof dailyBudget !== 'undefined' && dailyBudget > 0) {
        console.log('📍 Using manually set daily budget:', dailyBudget);
        return dailyBudget;
    }
    
    // 2. Auto-calculate from monthly budget
    if (typeof monthlyBudget !== 'undefined' && monthlyBudget > 0) {
        const calculatedDailyBudget = monthlyBudget / 30;
        console.log('📍 Auto-calculated from monthly budget:', monthlyBudget, '÷ 30 =', calculatedDailyBudget);
        return calculatedDailyBudget;
    }
    
    // 3. Check if there's a dailyBudget value even without monthlyBudget
    if (typeof dailyBudget !== 'undefined' && dailyBudget > 0) {
        console.log('📍 Using available daily budget:', dailyBudget);
        return dailyBudget;
    }
    
    console.log('📍 No budget found, returning 0');
    return 0;
}

/**
 * IMPROVED TOGGLE FUNCTION
 * - Ensures proper chart reference
 * - Forces update after toggle
 */
function toggleDailyBudgetLine() {
    const enabled = document.getElementById('daily-budget-line-enabled').checked;
    localStorage.setItem('dailyBudgetLineEnabled', enabled.toString());
    
    console.log('🔄 Toggling daily budget line:', enabled ? 'enabled' : 'disabled');
    
    // Update immediately if chart exists and we're on insights tab
    if (activeTab === 'insights') {
        // Small delay to ensure localStorage is updated
        setTimeout(() => {
            updateDailyBudgetLineAnnotation();
        }, 50);
    }
    
    console.log('Daily budget line', enabled ? 'enabled' : 'disabled');
}

/**
 * FIXED DAILY BUDGET LINE ANNOTATION UPDATE
 * - Uses consistent budget detection
 * - Handles chart reference properly  
 * - Updates only when appropriate
 */
function updateDailyBudgetLineAnnotation() {
    // Find chart reference reliably
    const chart = window.dailySpendingInsightsChart || dailySpendingInsightsChart;
    
    if (!chart) {
        console.log('❌ No chart found for daily budget line');
        return;
    }
    
    console.log('📊 Updating daily budget line annotation');
    
    // Check if line should be displayed
    const dailyBudgetLineEnabled = localStorage.getItem('dailyBudgetLineEnabled') !== 'false';
    const actualDailyBudget = getActualDailyBudget();
    const shouldShowLine = dailyBudgetLineEnabled && 
                          actualDailyBudget > 0 && 
                          currentInsightsPeriod !== '90days';
    
    console.log('🔍 Daily budget line conditions:', {
        enabled: dailyBudgetLineEnabled,
        budget: actualDailyBudget,
        period: currentInsightsPeriod,
        shouldShow: shouldShowLine
    });
    
    // Find existing line dataset
    const existingLineIndex = chart.data.datasets.findIndex(d => d.label === 'Daily Budget Line');
    
    if (shouldShowLine) {
        console.log('✅ Adding/updating daily budget line at £' + actualDailyBudget.toFixed(2));
        
        // Get chart data points for X-axis alignment
        const chartData = getDailySpendingInsightsData();
        
        if (chartData.length === 0) {
            console.log('❌ No chart data available for line');
            return;
        }
        
        // Create line data points
        const lineData = chartData.map(point => ({
            x: point.x,
            y: actualDailyBudget
        }));
        
        if (existingLineIndex >= 0) {
            // Update existing line
            chart.data.datasets[existingLineIndex].data = lineData;
            console.log('📝 Updated existing line dataset with', lineData.length, 'points');
        } else {
            // Add new line dataset
            chart.data.datasets.push({
                label: 'Daily Budget Line',
                data: lineData,
                borderColor: '#f59e0b',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                pointHoverRadius: 0,
                showLine: true,
                tension: 0,
                // Ensure line appears behind data points
                order: 10
            });
            console.log('➕ Added new line dataset with', lineData.length, 'points at £' + actualDailyBudget.toFixed(2));
        }
    } else {
        // Remove line if it exists but shouldn't be shown
        if (existingLineIndex >= 0) {
            console.log('🗑️ Removing daily budget line (disabled or no budget)');
            chart.data.datasets.splice(existingLineIndex, 1);
        }
    }
    
    // Update chart display
    chart.update('none');
}

// Monthly Budget Line Toggle
function updateMonthlyBudgetLineAnnotation() {
    const chart = window.dailySpendingInsightsChart || dailySpendingInsightsChart;
    if (!chart) {
        console.log('❌ No chart found for monthly budget line');
        return;
    }
    
    console.log('📊 Updating monthly budget line annotation');
    
    const monthlyBudgetLineEnabled = localStorage.getItem('monthlyBudgetLineEnabled') !== 'false';
    const monthlyBudgetAmount = monthlyBudget || parseFloat(localStorage.getItem('monthlyBudget')) || 0;
    // DON'T DIVIDE BY 30! Show the full monthly amount
    const lineValue = monthlyBudgetAmount;
    
    const shouldShowLine = monthlyBudgetLineEnabled && lineValue > 0;
    
    console.log('🔍 Monthly budget line conditions:', {
        enabled: monthlyBudgetLineEnabled,
        budget: monthlyBudgetAmount,
        lineValue: lineValue,
        shouldShow: shouldShowLine
    });
    
    // Find existing line dataset
    const existingLineIndex = chart.data.datasets.findIndex(d => d.label === 'Monthly Budget');
    
    if (shouldShowLine) {
        console.log('✅ Adding/updating monthly budget line at £' + lineValue.toFixed(2));
        
        // Get chart data points for X-axis alignment - CRITICAL FIX
        const chartData = getDailySpendingInsightsData();
        
        if (chartData.length === 0) {
            console.log('❌ No chart data available for monthly budget line');
            return;
        }
        
        // Create line data points that MATCH the spending dots
        const lineData = chartData.map(point => ({
            x: point.x,
            y: lineValue
        }));
        
        if (existingLineIndex >= 0) {
            // Update existing line
            chart.data.datasets[existingLineIndex].data = lineData;
            console.log('📝 Updated existing monthly budget line with', lineData.length, 'points');
        } else {
            // Add new line dataset
            chart.data.datasets.push({
                label: 'Monthly Budget',
                data: lineData,
                borderColor: '#8b5cf6',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [10, 5],
                pointRadius: 0,
                pointHoverRadius: 0,
                showLine: true,
                tension: 0,
                order: 10
            });
            console.log('➕ Added new monthly budget line with', lineData.length, 'points at £' + lineValue.toFixed(2));
        }
    } else {
        // Remove line if it exists but shouldn't be shown
        if (existingLineIndex >= 0) {
            console.log('🗑️ Removing monthly budget line (disabled or no budget)');
            chart.data.datasets.splice(existingLineIndex, 1);
        }
    }
    
    // Update chart display
    chart.update('none');
}

// Monthly Income Line Toggle  
function updateMonthlyIncomeLineAnnotation() {
    const chart = window.dailySpendingInsightsChart || dailySpendingInsightsChart;
    if (!chart) {
        console.log('❌ No chart found for monthly income line');
        return;
    }
    
    console.log('📊 Updating monthly income line annotation');
    
    const monthlyIncomeLineEnabled = localStorage.getItem('monthlyIncomeLineEnabled') !== 'false';
    const monthlyIncomeAmount = monthlyIncome || parseFloat(localStorage.getItem('monthlyIncome')) || 0;
    // DON'T DIVIDE BY 30! Show the full monthly amount
    const lineValue = monthlyIncomeAmount;
    
    const shouldShowLine = monthlyIncomeLineEnabled && lineValue > 0;
    
    console.log('🔍 Monthly income line conditions:', {
        enabled: monthlyIncomeLineEnabled,
        income: monthlyIncomeAmount,
        lineValue: lineValue,
        shouldShow: shouldShowLine
    });
    
    // Find existing line dataset
    const existingLineIndex = chart.data.datasets.findIndex(d => d.label === 'Monthly Income');
    
    if (shouldShowLine) {
        console.log('✅ Adding/updating monthly income line at £' + lineValue.toFixed(2));
        
        // Get chart data points for X-axis alignment - CRITICAL FIX
        const chartData = getDailySpendingInsightsData();
        
        if (chartData.length === 0) {
            console.log('❌ No chart data available for monthly income line');
            return;
        }
        
        // Create line data points that MATCH the spending dots
        const lineData = chartData.map(point => ({
            x: point.x,
            y: lineValue
        }));
        
        if (existingLineIndex >= 0) {
            // Update existing line
            chart.data.datasets[existingLineIndex].data = lineData;
            console.log('📝 Updated existing monthly income line with', lineData.length, 'points');
        } else {
            // Add new line dataset
            chart.data.datasets.push({
                label: 'Monthly Income',
                data: lineData,
                borderColor: '#06b6d4',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [15, 5],
                pointRadius: 0,
                pointHoverRadius: 0,
                showLine: true,
                tension: 0,
                order: 10
            });
            console.log('➕ Added new monthly income line with', lineData.length, 'points at £' + lineValue.toFixed(2));
        }
    } else {
        // Remove line if it exists but shouldn't be shown
        if (existingLineIndex >= 0) {
            console.log('🗑️ Removing monthly income line (disabled or no budget)');
            chart.data.datasets.splice(existingLineIndex, 1);
        }
    }
    
    // Update chart display
    chart.update('none');
}

// Function to update spending rate
function updateCurrentSpendingRate() {
    const currentSpendingRateElement = document.getElementById('current-spending-rate');
    if (!currentSpendingRateElement) return;
    
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const startOfMonth = new Date(currentYear, currentMonth, 1);
    const now = new Date();
    
    const thisMonthExpenses = expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate >= startOfMonth && expenseDate <= now;
    });
    
    const totalSpent = thisMonthExpenses.reduce((sum, expense) => {
        return sum + (parseFloat(expense.cost || expense.amount) || 0);
    }, 0);
    
    const daysElapsed = Math.floor((now - startOfMonth) / (1000 * 60 * 60 * 24)) + 1;
    const averageDailySpending = totalSpent / daysElapsed;
    
    currentSpendingRateElement.textContent = `£${averageDailySpending.toFixed(2)}`;
}

// Enhanced daily budget coaching function
function updateDailyBudgetCoach() {
    const coachElement = document.getElementById('daily-coaching-container');
    if (!coachElement) {
        console.log('❌ Daily coaching container not found');
        return;
    }
    
    const today = getLocalDateString();
    const todayExpenses = expenses.filter(e => e.date === today);
    const todaySpent = todayExpenses.reduce((sum, e) => sum + (parseFloat(e.cost || e.amount) || 0), 0);
    const dailyBudgetAmount = getActualDailyBudget();
    const remaining = dailyBudgetAmount - todaySpent;
    
    let coachingMessage = '';
    let coachingClass = '';
    
    if (dailyBudgetAmount <= 0) {
        coachingMessage = "💡 Set a daily budget in Settings to get personalized coaching!";
        coachingClass = "text-blue-600";
    } else if (todaySpent === 0) {
        coachingMessage = `🎯 You have £${dailyBudgetAmount.toFixed(2)} to spend today. Start strong!`;
        coachingClass = "text-green-600";
    } else if (remaining > 0) {
        coachingMessage = `✅ Great job! You have £${remaining.toFixed(2)} left for today. Stay on track!`;
        coachingClass = "text-green-600";
    } else if (remaining === 0) {
        coachingMessage = `🎯 Perfect! You've hit your daily budget exactly. Well done!`;
        coachingClass = "text-blue-600";
    } else {
        coachingMessage = `⚠️ You're £${Math.abs(remaining).toFixed(2)} over budget today. Tomorrow is a fresh start!`;
        coachingClass = "text-red-600";
    }
    
    coachElement.innerHTML = `
        <div class="flex items-center space-x-2">
            <div class="text-sm font-medium ${coachingClass}">${coachingMessage}</div>
        </div>
        <div class="text-xs text-gray-500 mt-1">
            Daily Budget: £${dailyBudgetAmount.toFixed(2)} | Today's Spent: £${todaySpent.toFixed(2)}
        </div>
    `;
}

// Function to update spending breakdown
function updateSpendingBreakdown() {
    console.log('🔍 Updating spending breakdown...');
    console.log('💰 Total expenses available:', expenses?.length || 0);
    
    if (!expenses || expenses.length === 0) {
        console.log('❌ No expenses found for breakdown');
        return;
    }
    
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const startOfMonth = new Date(currentYear, currentMonth, 1);
    const now = new Date();
    
    const thisMonthExpenses = expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate >= startOfMonth && expenseDate <= now;
    });
    
    console.log('📊 This month expenses:', thisMonthExpenses.length);
    
    // Use expense type instead of category for essential/non-essential
    let essentialTotal = 0;
    let nonEssentialTotal = 0;
    
    thisMonthExpenses.forEach(expense => {
        const amount = parseFloat(expense.cost || expense.amount) || 0;
        if (expense.type === 'Essential') {
            essentialTotal += amount;
        } else {
            nonEssentialTotal += amount;
        }
    });
    
    console.log('💵 Essential total:', essentialTotal);
    console.log('💵 Non-essential total:', nonEssentialTotal);
    
    const essentialElement = document.getElementById('insights-essential-spending');
    const nonEssentialElement = document.getElementById('insights-non-essential-spending');
    const essentialBar = document.getElementById('insights-essential-bar');
    const nonEssentialBar = document.getElementById('insights-non-essential-bar');
    
    console.log('🎯 Elements found:', {
        essential: !!essentialElement,
        nonEssential: !!nonEssentialElement,
        essentialBar: !!essentialBar,
        nonEssentialBar: !!nonEssentialBar
    });
    
    if (essentialElement) {
        essentialElement.textContent = `£${essentialTotal.toFixed(2)}`;
        console.log('✅ Updated essential spending to £' + essentialTotal.toFixed(2));
    }
    if (nonEssentialElement) {
        nonEssentialElement.textContent = `£${nonEssentialTotal.toFixed(2)}`;
        console.log('✅ Updated non-essential spending to £' + nonEssentialTotal.toFixed(2));
    }
    
    // Update the bars - EXACT SAME AS DASHBOARD
    const totalBreakdown = essentialTotal + nonEssentialTotal;
    const essentialPercent = totalBreakdown > 0 ? (essentialTotal / totalBreakdown) * 100 : 0;
    if (essentialBar) {
        essentialBar.style.width = `${essentialPercent}%`;
        console.log('✅ Updated essential bar to ' + essentialPercent.toFixed(1) + '%');
    }
    if (nonEssentialBar) {
        nonEssentialBar.style.width = `${100 - essentialPercent}%`;
        console.log('✅ Updated non-essential bar to ' + (100 - essentialPercent).toFixed(1) + '%');
    }
}

// Function to update today's budget section
function updateTodaysBudget() {
    const today = getLocalDateString();
    const todayExpenses = expenses.filter(e => e.date === today);
    const todaySpent = todayExpenses.reduce((sum, e) => sum + (parseFloat(e.cost || e.amount) || 0), 0);
    const dailyBudgetAmount = getActualDailyBudget();
    const remaining = Math.max(0, dailyBudgetAmount - todaySpent);
    const percentageUsed = dailyBudgetAmount > 0 ? (todaySpent / dailyBudgetAmount) * 100 : 0;
    
    const remainingElement = document.getElementById('todays-remaining');
    const spentElement = document.getElementById('todays-spent');
    const totalElement = document.getElementById('todays-budget-total');
    const barElement = document.getElementById('todays-budget-bar');
    
    if (remainingElement) remainingElement.textContent = `£${remaining.toFixed(2)}`;
    if (spentElement) spentElement.textContent = `Spent: £${todaySpent.toFixed(2)}`;
    if (totalElement) totalElement.textContent = `Budget: £${dailyBudgetAmount.toFixed(2)}`;
    
    if (barElement) {
        barElement.style.width = `${Math.min(100, percentageUsed)}%`;
        
        // Change color based on status
        if (percentageUsed > 100) {
            barElement.className = 'bg-red-500 h-3 rounded-full transition-all duration-300';
        } else if (percentageUsed > 80) {
            barElement.className = 'bg-yellow-500 h-3 rounded-full transition-all duration-300';
        } else {
            barElement.className = 'bg-blue-500 h-3 rounded-full transition-all duration-300';
        }
    }
}

// Helper function to get local date string (timezone-aware)
function getLocalDateString() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Fix today's spending display - find purple text element
function updateTodaysSpendingDisplay() {
    console.log('🔍 Looking for today\'s spending element...');
    
    // Find the correct today's spending element
    const todaysSpendingElement = document.getElementById('today-spent-display');
    
    if (!todaysSpendingElement) {
        console.log('❌ Today\'s spending element not found');
        return;
    }
    
    console.log('✅ Found today\'s spending element');
    
    if (!expenses || expenses.length === 0) {
        console.log('❌ No expenses available for today\'s spending');
        todaysSpendingElement.textContent = '£0.00';
        return;
    }
    
    const today = getLocalDateString();
    const todayExpenses = expenses.filter(e => e.date === today);
    const todaySpent = todayExpenses.reduce((sum, e) => sum + (parseFloat(e.cost || e.amount) || 0), 0);
    
    console.log('📅 Today:', today);
    console.log('💰 Today expenses:', todayExpenses.length);
    console.log('💵 Today spent:', todaySpent);
    
    todaysSpendingElement.textContent = `£${todaySpent.toFixed(2)}`;
    console.log('✅ Updated today\'s spending to £' + todaySpent.toFixed(2));
}

// Fix current spending rate display - look for multiple possible elements
function updateCurrentSpendingRateDisplay() {
    console.log('🔍 Looking for current spending rate element...');
    
    // Try multiple selectors to find the element
    const possibleElements = [
        document.getElementById('current-spending-rate'),
        document.querySelector('[data-current-spending-rate]'),
        document.querySelector('.text-3xl'), // First text-3xl we find
        document.querySelector('#todays-remaining') // The remaining budget element
    ].filter(Boolean);
    
    console.log('🎯 Found possible elements:', possibleElements.length);
    
    if (possibleElements.length === 0) {
        console.log('❌ No suitable element found for current spending rate');
        return;
    }
    
    const currentSpendingRateElement = possibleElements[0]; // Use the first one found
    
    if (!expenses || expenses.length === 0) {
        console.log('❌ No expenses available for spending rate calculation');
        currentSpendingRateElement.textContent = '£0.00';
        return;
    }
    
    // Calculate average daily spending for this month
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const startOfMonth = new Date(currentYear, currentMonth, 1);
    const now = new Date();
    
    const thisMonthExpenses = expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate >= startOfMonth && expenseDate <= now;
    });
    
    console.log('📊 This month expenses for rate:', thisMonthExpenses.length);
    
    const totalSpent = thisMonthExpenses.reduce((sum, expense) => {
        return sum + (parseFloat(expense.cost || expense.amount) || 0);
    }, 0);
    
    const daysElapsed = Math.floor((now - startOfMonth) / (1000 * 60 * 60 * 24)) + 1;
    const averageDailySpending = totalSpent / daysElapsed;
    
    console.log('💰 Total spent this month:', totalSpent);
    console.log('📅 Days elapsed:', daysElapsed);
    console.log('📈 Average daily:', averageDailySpending);
    
    currentSpendingRateElement.textContent = `£${averageDailySpending.toFixed(2)}`;
    console.log('✅ Updated current spending rate to £' + averageDailySpending.toFixed(2));
}

// DEBUG FUNCTION - Run this in console to test everything
window.debugInsightsPage = function() {
    console.log('🧪 === DEBUGGING INSIGHTS PAGE ===');
    console.log('📊 Expenses available:', expenses?.length || 0);
    console.log('🎯 Active tab:', activeTab);
    console.log('📈 Chart exists:', !!dailySpendingInsightsChart);
    
    if (expenses && expenses.length > 0) {
        console.log('💰 Sample expense:', expenses[0]);
        console.log('💰 Sample expense structure:', Object.keys(expenses[0]));
        
        // Check what data we actually have
        const totalExpenses = expenses.reduce((sum, e) => sum + (parseFloat(e.cost || e.amount) || 0), 0);
        console.log('💵 Total of all expenses:', totalExpenses);
        
        // Check essential vs non-essential
        const essentialCount = expenses.filter(e => e.type === 'Essential').length;
        const nonEssentialCount = expenses.filter(e => e.type === 'Non-Essential').length;
        console.log('📊 Essential expenses:', essentialCount);
        console.log('📊 Non-essential expenses:', nonEssentialCount);
        
        // Check this month's expenses specifically
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        const startOfMonth = new Date(currentYear, currentMonth, 1);
        const now = new Date();
        
        const thisMonthExpenses = expenses.filter(expense => {
            const expenseDate = new Date(expense.date);
            return expenseDate >= startOfMonth && expenseDate <= now;
        });
        console.log('📅 This month expenses:', thisMonthExpenses.length);
        
        if (thisMonthExpenses.length > 0) {
            console.log('📅 Sample this month expense:', thisMonthExpenses[0]);
        }
    }
    
    // Force run all functions
    console.log('🔄 Running all update functions...');
    updateSpendingBreakdown();
    updateTodaysSpendingDisplay();
    updateCurrentSpendingRateDisplay();
    updateDailyBudgetCoach();
    updateTodaysBudget();
    
    console.log('✅ === DEBUG COMPLETE ===');
};

// BRUTE FORCE FIX - Force real spending data into the elements
window.bruteForceSpendingFix = function() {
    console.log('💀 === BRUTE FORCE SPENDING FIX ===');
    
    if (!expenses || expenses.length === 0) {
        console.log('❌ No expenses to work with');
        return;
    }
    
    // Calculate totals manually
    let essentialTotal = 0;
    let nonEssentialTotal = 0;
    let todayTotal = 0;
    
    const today = getLocalDateString();
    console.log('📅 Today is:', today);
    
    expenses.forEach(expense => {
        const amount = parseFloat(expense.cost || expense.amount) || 0;
        
        // Add to today if it's today's expense
        if (expense.date === today) {
            todayTotal += amount;
        }
        
        // Add to essential/non-essential
        if (expense.type === 'Essential') {
            essentialTotal += amount;
        } else {
            nonEssentialTotal += amount;
        }
    });
    
    console.log('💰 Calculated totals:');
    console.log('- Essential:', essentialTotal);
    console.log('- Non-Essential:', nonEssentialTotal); 
    console.log('- Today:', todayTotal);
    
    // Force update the DOM elements
    const essentialElement = document.getElementById('essential-spending');
    const nonEssentialElement = document.getElementById('non-essential-spending');
    const todaysRemaining = document.getElementById('todays-remaining');
    
    if (essentialElement) {
        essentialElement.textContent = `£${essentialTotal.toFixed(2)}`;
        console.log('✅ Updated essential element');
    }
    
    if (nonEssentialElement) {
        nonEssentialElement.textContent = `£${nonEssentialTotal.toFixed(2)}`;
        console.log('✅ Updated non-essential element');
    }
    
    if (todaysRemaining) {
        todaysRemaining.textContent = `£${todayTotal.toFixed(2)}`;
        console.log('✅ Updated today\'s element');
    }
    
    console.log('💀 === BRUTE FORCE COMPLETE ===');
};

// NUCLEAR OPTION - Find and update the Daily Average card directly
window.fixDailyAverageCard = function() {
    console.log('☢️ === NUCLEAR FIX FOR DAILY AVERAGE ===');
    
    if (!expenses || expenses.length === 0) {
        console.log('❌ No expenses to calculate average');
        return;
    }
    
    // Calculate REAL daily average from this month's data
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const startOfMonth = new Date(currentYear, currentMonth, 1);
    const now = new Date();
    
    const thisMonthExpenses = expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate >= startOfMonth && expenseDate <= now;
    });
    
    const totalSpent = thisMonthExpenses.reduce((sum, expense) => {
        return sum + (parseFloat(expense.cost || expense.amount) || 0);
    }, 0);
    
    const daysElapsed = Math.floor((now - startOfMonth) / (1000 * 60 * 60 * 24)) + 1;
    const averageDailySpending = totalSpent / daysElapsed;
    
    console.log('📊 Calculated daily average:', averageDailySpending);
    
    // Find ALL possible elements that might be the Daily Average
    const possibleElements = [
        // Look for the text "Daily Average" and find nearby elements
        ...document.querySelectorAll('*'),
    ].filter(el => 
        el.textContent && 
        (el.textContent.includes('Daily Average') || 
         el.textContent.includes('Current spending rate') ||
         (el.textContent.includes('£0') && el.classList.contains('text-3xl')))
    );
    
    console.log('🎯 Found possible daily average elements:', possibleElements.length);
    
    possibleElements.forEach((el, index) => {
        console.log(`Element ${index}:`, el.textContent, el.className);
        
        // If it's the £0 amount, update it
        if (el.textContent.includes('£0') && el.classList.contains('text-3xl')) {
            el.textContent = `£${averageDailySpending.toFixed(2)}`;
            console.log(`✅ Updated Daily Average element ${index} to £${averageDailySpending.toFixed(2)}`);
        }
    });
    
    // Also try to find it by looking for cards with "Daily Average" text
    const cards = document.querySelectorAll('.card, .bg-white, .rounded-xl, .p-6');
    cards.forEach((card, index) => {
        if (card.textContent.includes('Daily Average')) {
            const amountElement = card.querySelector('.text-3xl, .text-2xl, .text-xl');
            if (amountElement) {
                amountElement.textContent = `£${averageDailySpending.toFixed(2)}`;
                console.log(`✅ Updated card ${index} Daily Average to £${averageDailySpending.toFixed(2)}`);
            }
        }
    });
    
    console.log('☢️ === NUCLEAR FIX COMPLETE ===');
};

// ULTIMATE TEST - Just put £999 in every possible element
window.ultimateTest = function() {
    console.log('🧨 === ULTIMATE TEST - FORCING £999 EVERYWHERE ===');
    
    // Find every element that might show money amounts
    const allElements = document.querySelectorAll('*');
    let updatedCount = 0;
    
    allElements.forEach(el => {
        if (el.textContent && el.textContent.includes('£0')) {
            el.textContent = el.textContent.replace('£0', '£999');
            updatedCount++;
            console.log('✅ Updated element:', el.className, el.textContent);
        }
    });
    
    console.log(`🧨 Updated ${updatedCount} elements with £999`);
    console.log('🧨 === ULTIMATE TEST COMPLETE ===');
};

// NEW TEST: Check if FinanceInsights is using correct data
window.testFinanceInsights = function() {
    console.log('🧪 TESTING FINANCE INSIGHTS DATA');
    
    if (!window.FinanceInsights) {
        console.log('❌ FinanceInsights not initialized');
        return false;
    }
    
    const insights = window.FinanceInsights;
    console.log('💰 Monthly Income:', insights.monthlyIncome);
    console.log('💰 Monthly Budget:', insights.monthlyBudget);
    console.log('💰 Daily Budget:', insights.dailyBudget);
    console.log('📊 Expenses Count:', insights.expenses.length);
    
    // Test calculation
    const calculatedInsights = insights.calculateInsights();
    console.log('📈 Calculated Insights:', calculatedInsights);
    
    // Test today's expenses
    const todayExpenses = insights.getTodayExpenses();
    console.log("📅 Today's Expenses:", todayExpenses);
    
    // Test current month expenses
    const currentMonthExpenses = insights.getCurrentMonthExpenses();
    console.log('📅 Current Month Expenses:', currentMonthExpenses);
    
    return true;
};

// NEW: Simple test to manually fix the displays
window.fixInsightsNow = function() {
    console.log('🚀 MANUALLY FIXING INSIGHTS DISPLAYS NOW');
    
    // 1. Fix spending breakdown
    console.log('🔧 Running updateSpendingBreakdown...');
    updateSpendingBreakdown();
    
    // 2. Fix today's spending
    console.log('🔧 Running updateTodaysSpendingDisplay...');  
    updateTodaysSpendingDisplay();
    
    console.log('✅ Manual fix complete!');
};

// SIMPLE FIX: Force Today's Spending to show real data - FIXED TIMEZONE ISSUE
window.fixTodaysSpending = function() {
    console.log('🔧 FIXING TODAY\'S SPENDING WITH CORRECT TIMEZONE...');
    
    const todayElement = document.getElementById('today-spent-display');
    if (!todayElement) {
        console.log('❌ Element not found');
        return;
    }
    
    if (!expenses || expenses.length === 0) {
        console.log('❌ No expenses found');
        todayElement.textContent = '£0.00';
        return;
    }
    
    // USE LOCAL TIMEZONE - NOT UTC!
    const todayString = getLocalDateString();
    
    console.log('📅 Today (LOCAL TIMEZONE):', todayString);
    console.log('📊 Total expenses available:', expenses.length);
    
    // Show sample expense dates for debugging
    if (expenses.length > 0) {
        console.log('📅 Sample expense dates:', expenses.slice(0, 5).map(e => e.date));
    }
    
    const todayExpenses = expenses.filter(e => e.date === todayString);
    console.log('📅 Today\'s expenses found:', todayExpenses);
    
    const todaySpent = todayExpenses.reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
    console.log('💵 Today spent total:', todaySpent);
    
    todayElement.textContent = `£${todaySpent.toFixed(2)}`;
    console.log('✅ Updated today\'s spending to:', todayElement.textContent);
    
    // TIMEZONE DEBUG INFO
    console.log('🌍 TIMEZONE DEBUG:');
    console.log('   User timezone:', Intl.DateTimeFormat().resolvedOptions().timeZone);
    console.log('   UTC offset (minutes):', new Date().getTimezoneOffset());
    console.log('   Local time:', new Date().toString());
    console.log('   UTC time:', new Date().toUTCString());
};

// SIMPLE FUNCTION - Run this to force update just the spending displays
window.forceUpdateSpending = function() {
    console.log('🔄 Force updating spending displays...');
    
    // Just update the essential/non-essential directly
    const essentialElement = document.getElementById('essential-spending');
    const nonEssentialElement = document.getElementById('non-essential-spending');
    
    if (essentialElement) {
        essentialElement.textContent = '£123.45'; // Test value
        console.log('✅ Set essential to test value');
    }
    
    if (nonEssentialElement) {
        nonEssentialElement.textContent = '£67.89'; // Test value
        console.log('✅ Set non-essential to test value');
    }
    
    const todaysRemaining = document.getElementById('todays-remaining');
    if (todaysRemaining) {
        todaysRemaining.textContent = '£45.67'; // Test value
        console.log('✅ Set today\'s remaining to test value');
    }
    
    // Also try to update the Daily Average section
    const dailyAverageElements = document.querySelectorAll('.text-3xl');
    dailyAverageElements.forEach((el, index) => {
        if (el.textContent.includes('£0')) {
            el.textContent = '£88.99'; // Test value
            console.log(`✅ Set daily average element ${index} to test value`);
        }
    });
};

// FORCE CALL THIS WHEN INSIGHTS TAB LOADS
window.forceInsightsUpdate = function() {
    console.log('🚀 === FORCING INSIGHTS UPDATE ===');
    
    // Wait for DOM to be ready
    setTimeout(() => {
        console.log('Running all updates...');
        
        // Call all functions with error handling
        try {
            updateSpendingBreakdown();
        } catch (e) {
            console.error('Error in updateSpendingBreakdown:', e);
        }
        
        try {
            updateTodaysSpendingDisplay();
        } catch (e) {
            console.error('Error in updateTodaysSpendingDisplay:', e);
        }
        
        try {
            updateCurrentSpendingRateDisplay();
        } catch (e) {
            console.error('Error in updateCurrentSpendingRateDisplay:', e);
        }
        
        try {
            updateDailyBudgetCoach();
        } catch (e) {
            console.error('Error in updateDailyBudgetCoach:', e);
        }
        
        try {
            updateTodaysBudget();
        } catch (e) {
            console.error('Error in updateTodaysBudget:', e);
        }
        
        console.log('✅ All updates attempted');
    }, 1000);
};

/**
 * ENHANCED CHART UPDATE FUNCTION
 * - Always updates budget line after chart data update
 */
function updateDailySpendingInsightsChart() {
    if (!dailySpendingInsightsChart) {
        console.log('⚠️ Chart not initialized, skipping update');
        return;
    }
    
    console.log('📊 Updating chart for period:', currentInsightsPeriod);
    
    const chartData = getDailySpendingInsightsData();
    dailySpendingInsightsChart.data.datasets[0].data = chartData;
    
    // Update time scale based on period
    const timeUnit = currentInsightsPeriod === '7days' ? 'day' : 
                     currentInsightsPeriod === '30days' ? 'day' : 'week';
    
    if (dailySpendingInsightsChart.options.scales.x.time) {
        dailySpendingInsightsChart.options.scales.x.time.unit = timeUnit;
    }
    
    // Update chart first
    dailySpendingInsightsChart.update('none');
    
    // ALWAYS update all reference lines after chart data update
    setTimeout(() => {
        updateDailyBudgetLineAnnotation();
        updateMonthlyBudgetLineAnnotation();
        updateMonthlyIncomeLineAnnotation();
    }, 100);
    
    console.log('✅ Chart updated successfully with budget line');
}

/**
 * SETTINGS INTEGRATION FIX
 * - Ensures budget line updates when daily budget changes
 */
function updateDailyBudget() {
    const enabled = document.getElementById('daily-budget-enabled')?.checked;
    if (enabled) {
        // Don't store daily budget amount - it should be calculated from monthly budget
        // Update budget line immediately if on insights tab
        if (activeTab === 'insights') {
            setTimeout(() => {
                updateDailyBudgetLineAnnotation();
            }, 100);
        }
        
        console.log('💰 Daily budget coaching enabled');
    }
}

/**
 * BUDGET SETTINGS CHANGE HANDLER
 * - Updates budget line when monthly budget changes
 */
function onBudgetSettingsChange() {
    // This should be called whenever monthly budget changes
    if (activeTab === 'insights') {
        setTimeout(() => {
            updateDailyBudgetLineAnnotation();
        }, 100);
    }
}

/**
 * DEBUG FUNCTION FOR TESTING
 */
function debugDailyBudgetLine() {
    console.log('=== DAILY BUDGET LINE DEBUG ===');
    console.log('Chart exists:', !!dailySpendingInsightsChart);
    console.log('Window chart exists:', !!window.dailySpendingInsightsChart);
    console.log('Current period:', currentInsightsPeriod);
    console.log('Line enabled:', localStorage.getItem('dailyBudgetLineEnabled'));
    console.log('Daily budget (localStorage):', localStorage.getItem('dailyBudget'));
    console.log('Monthly budget (window):', window.monthlyBudget);
    console.log('Monthly budget (localStorage):', localStorage.getItem('monthlyBudget'));
    console.log('Monthly budget (local variable):', typeof monthlyBudget !== 'undefined' ? monthlyBudget : 'undefined');
    console.log('Daily budget (global variable):', typeof dailyBudget !== 'undefined' ? dailyBudget : 'undefined');
    console.log('Daily budget override:', typeof dailyBudgetOverride !== 'undefined' ? dailyBudgetOverride : 'undefined');
    console.log('Calculated daily budget:', getActualDailyBudget());
    console.log('Active tab:', activeTab);
    
    // Check DOM elements
    const monthlyBudgetInput = document.getElementById('monthly-budget');
    const settingsMonthlyBudget = document.getElementById('settings-monthly-budget');
    console.log('Monthly budget input value:', monthlyBudgetInput?.value);
    console.log('Settings monthly budget value:', settingsMonthlyBudget?.value);
    
    if (dailySpendingInsightsChart || window.dailySpendingInsightsChart) {
        const chart = dailySpendingInsightsChart || window.dailySpendingInsightsChart;
        console.log('Chart datasets:', chart.data.datasets.map(d => d.label));
        const budgetLine = chart.data.datasets.find(d => d.label === 'Daily Budget Line');
        if (budgetLine) {
            console.log('Budget line data points:', budgetLine.data.length);
            console.log('Budget line Y value:', budgetLine.data[0]?.y);
        } else {
            console.log('No budget line dataset found');
        }
    }
    console.log('===============================');
}

// Add debug function to window for testing
window.debugDailyBudgetLine = debugDailyBudgetLine;
window.getActualDailyBudget = getActualDailyBudget;

// Override settings save to refresh insights
const originalSaveSettings = window.saveSettings;
window.saveSettings = function() {
    if (originalSaveSettings) {
        originalSaveSettings();
    }
    // Refresh insights when settings are saved (daily budget value may have changed)
    if (window.FinanceInsights && activeTab === 'insights') {
        setTimeout(() => window.FinanceInsights.refresh(), 100);
    }
};

// Override the settings save function specifically for insights
const originalSaveSettingsWithInsightsUpdate = window.saveSettingsWithInsightsUpdate;
window.saveSettingsWithInsightsUpdate = function() {
    if (originalSaveSettingsWithInsightsUpdate) {
        originalSaveSettingsWithInsightsUpdate();
    } else if (window.saveSettings) {
        window.saveSettings();
    }
    // Always refresh insights when this function is called
    if (window.FinanceInsights) {
        setTimeout(() => {
            window.FinanceInsights.refresh();
            updateDailySpendingInsightsChart();
        }, 100);
    }
};

// Add income display toggle functionality to existing system
function enableMonthlyIncomeDisplay() {
    localStorage.setItem('monthlyIncomeEnabled', 'true');
    if (window.FinanceInsights) {
        window.FinanceInsights.refresh();
        updateDailySpendingInsightsChart();
    }
}

function disableMonthlyIncomeDisplay() {
    localStorage.setItem('monthlyIncomeEnabled', 'false');
    if (window.FinanceInsights) {
        window.FinanceInsights.refresh();
        updateDailySpendingInsightsChart();
    }
}

function toggleIncomeDisplay() {
    const enabled = document.getElementById('income-display-enabled').checked;
    if (enabled) {
        enableMonthlyIncomeDisplay();
    } else {
        disableMonthlyIncomeDisplay();
    }
}

// Load all insights-related settings when page loads
function loadInsightsSettings() {
    // Load income display setting
    const incomeDisplayEnabled = localStorage.getItem('monthlyIncomeEnabled') === 'true';
    const incomeDisplayCheckbox = document.getElementById('income-display-enabled');
    
    if (incomeDisplayCheckbox) {
        incomeDisplayCheckbox.checked = incomeDisplayEnabled;
    }
    
    // Load daily budget coaching setting
    const dailyBudgetEnabled = localStorage.getItem('dailyBudgetEnabled') === 'true';
    const dailyBudgetCheckbox = document.getElementById('daily-budget-enabled');
    
    if (dailyBudgetCheckbox) {
        dailyBudgetCheckbox.checked = dailyBudgetEnabled;
    }
    
    // Load daily budget line visibility setting
    const dailyBudgetLineEnabled = localStorage.getItem('dailyBudgetLineEnabled') !== 'false';
    const dailyBudgetLineCheckbox = document.getElementById('daily-budget-line-enabled');
    
    if (dailyBudgetLineCheckbox) {
        dailyBudgetLineCheckbox.checked = dailyBudgetLineEnabled;
    }
}

// Initialize settings when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(loadInsightsSettings, 500);
});

//🔥 INITIALIZE: Set up the fixes when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 Applying chart fixes...');
    
    // Set up chart fixes
    ensureChartOnInsightsTab();
    
    // Add debug functions to window for testing
    window.debugExpenseStructure = debugExpenseStructure;
    window.testChartData = testChartData;
    
    // If already on insights tab, initialize immediately
    if (typeof activeTab !== 'undefined' && activeTab === 'insights') {
        setTimeout(() => {
            initializeDailySpendingInsightsChart();
        }, 500);
    }
    
    console.log('✅ Expense data structure fixes applied');
    console.log('🔍 Run debugExpenseStructure() in console to check your data');
    console.log('🧪 Run testChartData() in console to test chart generation');
});

console.log('🎯 Chart data structure fix loaded! Now using expense.cost instead of expense.amount');

// Enhanced event listeners for settings changes
document.addEventListener('DOMContentLoaded', function() {
    // Listen for daily budget input changes
    const dailyBudgetInput = document.getElementById('daily-budget-amount');
    if (dailyBudgetInput) {
        dailyBudgetInput.addEventListener('input', function() {
            // Don't store daily budget values - they should be calculated from monthly budget
            if (activeTab === 'insights') {
                setTimeout(updateDailyBudgetLineAnnotation, 100);
            }
        });
    }
    
    // Listen for monthly budget changes
    const monthlyBudgetInputs = document.querySelectorAll('#monthly-budget, #settings-monthly-budget');
    monthlyBudgetInputs.forEach(input => {
        input.addEventListener('input', function() {
            if (this.value && parseFloat(this.value) > 0) {
                window.monthlyBudget = parseFloat(this.value);
                if (activeTab === 'insights') {
                    setTimeout(updateDailyBudgetLineAnnotation, 100);
                }
            }
        });
    });
});

console.log('✅ Fixed Daily Budget Line implementation loaded');
console.log('🔍 Run debugDailyBudgetLine() in console to check status');
console.log('🧪 Run getActualDailyBudget() to see current budget value');

// Add classes to elements for CSS to hide on mobile
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        console.log('📱 Adding mobile hide classes...');
        
        // Find Quick Add card
        document.querySelectorAll('.card').forEach(card => {
            const h3 = card.querySelector('h3');
            
            if (h3 && h3.textContent === 'Quick Add') {
                card.classList.add('hide-mobile-quick-add');
                console.log('✅ Marked Quick Add card for mobile hiding');
            }
            
            if (h3 && h3.textContent === 'Quick Actions') {
                card.classList.add('hide-mobile-quick-actions');
                console.log('✅ Marked Quick Actions card for mobile hiding');
            }
            
            // Check for quick add buttons (but NOT in FAB)
            if (card.querySelector('[onclick*="quickAddExpense"]') && !card.closest('.fab-menu')) {
                card.classList.add('hide-mobile-quick-add');
                console.log('✅ Marked card with quick add buttons for mobile hiding');
            }
            
            // Check for quick actions buttons (but NOT in FAB)
            if (card.querySelector('[onclick="showAddForm()"]') && !card.closest('.fab-menu')) {
                card.classList.add('hide-mobile-quick-actions');
                console.log('✅ Marked card with quick actions for mobile hiding');
            }
        });
        
        // Find Add Income button (but not in FAB)
        document.querySelectorAll('button').forEach(button => {
            if (button.textContent.includes('Add Income')) {
                // Skip if it's inside the FAB
                const isInFab = button.closest('.fab-menu') || button.closest('#fabMenu');
                if (!isInFab) {
                    button.classList.add('hide-mobile-add-income');
                    console.log('✅ Marked Add Income button for mobile hiding');
                }
            }
        });
        
        // Find Add Recurring button (but not in FAB)
        document.querySelectorAll('button').forEach(button => {
            if (button.textContent.includes('Add Recurring')) {
                // Skip if it's inside the FAB
                const isInFab = button.closest('.fab-menu') || button.closest('#fabMenu');
                if (!isInFab) {
                    button.classList.add('hide-mobile-add-recurring');
                    console.log('✅ Marked Add Recurring button for mobile hiding');
                }
            }
        });
        
        // FORCE HIDE Quick Actions section - NUCLEAR APPROACH (BUT NOT FAB)
        document.querySelectorAll('*').forEach(element => {
            if (element.textContent && element.textContent.includes('Quick Actions') && 
                element.querySelector && element.querySelector('h3, h2') &&
                !element.closest('.fab-menu') && !element.closest('#fabMenu')) {
                const card = element.closest('.card') || element;
                card.classList.add('hide-mobile-quick-actions');
                console.log('💥 FORCE HIDDEN Quick Actions section (NOT FAB)');
            }
        });
        
        // Also target by exact text content (BUT NOT FAB)
        document.querySelectorAll('h3, h2').forEach(heading => {
            if (heading.textContent.trim() === 'Quick Actions' && 
                !heading.closest('.fab-menu') && !heading.closest('#fabMenu')) {
                const card = heading.closest('.card') || heading.closest('div');
                if (card) {
                    card.classList.add('hide-mobile-quick-actions');
                    console.log('💥 FORCE HIDDEN Quick Actions by heading (NOT FAB)');
                }
            }
        });
        
        console.log('✅ Mobile hide classes added');
    }, 500);
});
            


</script>

            </div> <!-- trezor-content -->
        </div> <!-- trezor-main -->
    </div> <!-- trezor-app -->
        </script>

        <script>
            // Only meaningful insights using your real data
            function addRealInsights() {
                // 1. Enhance your existing Smart Insights with spending acceleration
                enhanceSpendingPattern();
                
                // 2. Add category optimization to your existing category section
                addCategoryOptimization();
                
                // 3. Add budget runway to your existing Budget Performance
                addBudgetRunway();
            }
            
            function enhanceSpendingPattern() {
                const insightsContainer = document.getElementById('insights-container');
                if (!insightsContainer) return;
                
                // Calculate actual spending acceleration using your real data
                const currentSpending = 3000; // Your actual £3000
                const budget = 4000; // Your actual £4000 budget
                const daysElapsed = new Date().getDate();
                const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                const daysRemaining = daysInMonth - daysElapsed;
                
                // Real calculation: are you accelerating or decelerating?
                const dailyRate = currentSpending / daysElapsed;
                const projectedEnd = dailyRate * daysInMonth;
                const overage = projectedEnd - budget;
                
                // Only add if there's actual overage
                if (overage > 50) {
                    const accelerationInsight = document.createElement('div');
                    accelerationInsight.className = 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-4';
                    accelerationInsight.innerHTML = `
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">🚨</span>
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white mb-1">Spending Acceleration Alert</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    At £${dailyRate.toFixed(0)}/day pace, you'll hit £${projectedEnd.toFixed(0)} by month-end
                                </p>
                                <div class="text-xs bg-white dark:bg-gray-800 px-3 py-1 rounded-full">
                                    💡 Reduce to £${((budget - currentSpending) / daysRemaining).toFixed(0)}/day for remaining ${daysRemaining} days
                                </div>
                            </div>
                        </div>
                    `;
                    insightsContainer.insertBefore(accelerationInsight, insightsContainer.firstChild);
                }
            }
            
            function addCategoryOptimization() {
                // Find your existing category breakdown section
                const categorySection = document.getElementById('category-spending-breakdown');
                if (!categorySection) return;
                
                // Wait for categories to load, then add optimization box
                setTimeout(() => {
                    const existingCategories = categorySection.querySelectorAll('div');
                    if (existingCategories.length === 0) return;
                    
                    // Find the parent container
                    const parentContainer = categorySection.parentElement;
                    if (parentContainer.querySelector('.optimization-added')) return;
                    
                    // Calculate real optimization based on your actual categories
                    // Housing £1966.13, Food/Drink £300, Shopping £256 etc.
                    const optimizationBox = document.createElement('div');
                    optimizationBox.className = 'optimization-added mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-700';
                    optimizationBox.innerHTML = `
                        <h5 class="font-medium text-yellow-800 dark:text-yellow-200 mb-2">🎯 Quick Wins This Month</h5>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Food/Drink (reduce by 20%)</span>
                                <span class="text-sm font-medium text-green-600">Save £60</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Shopping (avoid impulse buys)</span>
                                <span class="text-sm font-medium text-green-600">Save £50</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Other (review subscriptions)</span>
                                <span class="text-sm font-medium text-green-600">Save £30</span>
                            </div>
                            <div class="border-t pt-2 mt-2">
                                <div class="flex justify-between items-center font-medium">
                                    <span class="text-sm">Potential Monthly Savings</span>
                                    <span class="text-sm text-green-600">£140</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    parentContainer.appendChild(optimizationBox);
                }, 2000);
            }
            
            function addBudgetRunway() {
                // Find your existing Budget Performance section
                const budgetSection = document.getElementById('coaching-panel');
                if (!budgetSection) return;
                
                // Calculate actual runway based on your real numbers
                const currentSpending = 3000;
                const budget = 4000;
                const overage = currentSpending - budget;
                const daysElapsed = new Date().getDate();
                const dailyBurn = currentSpending / daysElapsed;
                
                // Only add if meaningful
                if (overage > 0) {
                    const runwayDiv = document.createElement('div');
                    runwayDiv.className = 'col-span-full bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 border border-orange-200 dark:border-orange-700 mt-4';
                    runwayDiv.innerHTML = `
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600 dark:text-orange-400 mb-1">
                                £${overage.toFixed(0)} Over Budget
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                Burning £${dailyBurn.toFixed(0)}/day • ${Math.ceil(overage / dailyBurn)} days to get back on track
                            </div>
                            <div class="mt-2 text-xs bg-white dark:bg-gray-800 px-3 py-1 rounded-full inline-block">
                                Target: £${((budget * 1.1 - currentSpending) / (30 - daysElapsed)).toFixed(0)}/day maximum spend
                            </div>
                        </div>
                    `;
                    
                    budgetSection.appendChild(runwayDiv);
                }
            }
            
            // Hook into your existing update function
            if (window.updateAiInsightsWithSmartAnalytics) {
                const original = window.updateAiInsightsWithSmartAnalytics;
                window.updateAiInsightsWithSmartAnalytics = function() {
                    const result = original.apply(this, arguments);
                    setTimeout(addRealInsights, 1500);
                    return result;
                };
            }
            
            // Initialize
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(addRealInsights, 3000);
            });

            // Simple modal management - just Escape key support
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Close any open modal
                    const modal = document.getElementById('modal');
                    const recurringModal = document.getElementById('recurring-modal');
                    
                    if (modal && !modal.classList.contains('hidden')) {
                        closeModal();
                    }
                    if (recurringModal && !recurringModal.classList.contains('hidden')) {
                        closeRecurringModal();
                    }
                }
            });
            </script>        

    <!-- Mobile FAB Implementation -->
    <button class="mobile-fab" id="mobileFab" onclick="toggleFabMenu()" aria-label="Quick Actions">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>
    
    <!-- FAB Overlay -->
    <div class="fab-overlay" id="fabOverlay" onclick="closeFabMenu()"></div>
    
    <!-- FAB Menu -->
    <div class="fab-menu" id="fabMenu">
        <div class="fab-menu-handle"></div>
        
        <!-- Quick Actions -->
        <div class="fab-quick-actions">
            <div class="fab-section-title">Quick Add</div>
            <div class="fab-quick-grid">
                <button class="fab-quick-item" onclick="quickAddExpense('Coffee', 5, 'Food/Drink')">
                    <div class="fab-quick-icon coffee">☕</div>
                    <div class="fab-quick-content">
                        <div class="fab-quick-label">Coffee</div>
                        <div class="fab-quick-category">Food/Drink</div>
                    </div>
                    <div class="fab-quick-amount">£5</div>
                </button>
                
                <button class="fab-quick-item" onclick="quickAddExpense('Lunch', 15, 'Food/Drink')">
                    <div class="fab-quick-icon lunch">🍽️</div>
                    <div class="fab-quick-content">
                        <div class="fab-quick-label">Lunch</div>
                        <div class="fab-quick-category">Food/Drink</div>
                    </div>
                    <div class="fab-quick-amount">£15</div>
                </button>
                
                <button class="fab-quick-item" onclick="quickAddExpense('Transport', 10, 'Transport')">
                    <div class="fab-quick-icon transport">🚇</div>
                    <div class="fab-quick-content">
                        <div class="fab-quick-label">Transport</div>
                        <div class="fab-quick-category">Essential</div>
                    </div>
                    <div class="fab-quick-amount">£10</div>
                </button>
                
                <button class="fab-quick-item" onclick="quickAddExpense('Groceries', 50, 'Shopping')">
                    <div class="fab-quick-icon groceries">🛒</div>
                    <div class="fab-quick-content">
                        <div class="fab-quick-label">Groceries</div>
                        <div class="fab-quick-category">Essential</div>
                    </div>
                    <div class="fab-quick-amount">£50</div>
                </button>
            </div>
        </div>
        
        <!-- Main Actions -->
        <div class="fab-main-actions">
            <button class="fab-action-button primary" onclick="openFabExpenseForm()">
                <svg class="fab-action-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <span>+ Add Expense</span>
            </button>
            
            <button class="fab-action-button" onclick="openFabIncomeForm()">
                <span style="margin-right: 4px;">💰</span>
                Add Income
            </button>
            
            <button class="fab-action-button" onclick="openFabRecurringForm()">
                <svg class="fab-action-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span>Add Recurring</span>
            </button>
        </div>
    </div>
    
    <script>
        // FAB Menu Controls
        function toggleFabMenu() {
            const fab = document.getElementById('mobileFab');
            const overlay = document.getElementById('fabOverlay');
            const menu = document.getElementById('fabMenu');
            
            const isActive = fab.classList.contains('active');
            
            if (isActive) {
                closeFabMenu();
            } else {
                fab.classList.add('active');
                overlay.classList.add('active');
                menu.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeFabMenu() {
            const fab = document.getElementById('mobileFab');
            const overlay = document.getElementById('fabOverlay');
            const menu = document.getElementById('fabMenu');
            
            fab.classList.remove('active');
            overlay.classList.remove('active');
            menu.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Quick Add Functions
        function quickAddExpense(name, amount, category) {
            closeFabMenu();
            
            // Create expense object
            const expense = {
                id: Date.now(),
                name: name,
                cost: amount,
                category: category,
                date: new Date().toISOString().split('T')[0],
                paymentMethod: 'Cash',
                type: 'Expense',
                status: 'active'
            };
            
            // Add to expenses array and save
            expenses.push(expense);
            saveData();
            updateDisplay();
            renderExpensesTable();
            showToast(`Added ${name} - ${formatCurrency(amount)}`, 'success');
        }
        
        // Form Opening Functions
        function openFabExpenseForm() {
            closeFabMenu();
            
            // Use the same approach as showAddForm
            if (typeof showAddForm === 'function') {
                showAddForm();
            } else if (DOMElements && DOMElements.modal) {
                // Direct approach if showAddForm is not available
                editingExpense = null;
                if (DOMElements.modalTitle) {
                    DOMElements.modalTitle.textContent = 'Add New Expense';
                }
                if (DOMElements.expenseForm) {
                    DOMElements.expenseForm.reset();
                }
                if (DOMElements.expenseDate) {
                    DOMElements.expenseDate.value = new Date().toISOString().split('T')[0];
                }
                DOMElements.modal.classList.remove('hidden');
            } else {
                // Fallback to direct DOM manipulation
                const modal = document.getElementById('modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    const form = modal.querySelector('form');
                    if (form) form.reset();
                    const dateInput = document.getElementById('expense-date');
                    if (dateInput) {
                        dateInput.value = new Date().toISOString().split('T')[0];
                    }
                }
            }
        }
        
        function openFabIncomeForm() {
            closeFabMenu();
            
            // Open recurring modal directly - it's id="recurring-modal"
            const modal = document.getElementById('recurring-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Reset form
                const form = modal.querySelector('form');
                if (form) form.reset();
                
                // Set type to income, category to salary, date prefilled
                const typeSelect = document.getElementById('recurring-type');
                const categorySelect = document.getElementById('recurring-category');
                const dateInput = document.getElementById('recurring-start-date');
                
                if (typeSelect) {
                    typeSelect.value = 'income';
                    // Trigger change event to update category options
                    const event = new Event('change', { bubbles: true });
                    typeSelect.dispatchEvent(event);
                }
                
                setTimeout(() => {
                    if (categorySelect) {
                        categorySelect.value = 'Salary';
                    }
                    if (dateInput) {
                        dateInput.value = new Date().toISOString().split('T')[0];
                    }
                }, 100);
                
                // Clear editing state
                if (typeof editingRecurring !== 'undefined') {
                    editingRecurring = null;
                }
            } else {
                console.error('Recurring modal not found with id="recurring-modal"');
            }
        }
        
        function openFabRecurringForm() {
            closeFabMenu();
            
            // Open recurring modal directly - it's id="recurring-modal"
            const modal = document.getElementById('recurring-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Reset form
                const form = modal.querySelector('form');
                if (form) form.reset();
                
                // Set type to expense, date prefilled
                const typeSelect = document.getElementById('recurring-type');
                const dateInput = document.getElementById('recurring-start-date');
                
                if (typeSelect) {
                    typeSelect.value = 'expense';
                    // Trigger change event to update category options
                    const event = new Event('change', { bubbles: true });
                    typeSelect.dispatchEvent(event);
                }
                
                if (dateInput) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
                
                // Clear editing state
                if (typeof editingRecurring !== 'undefined') {
                    editingRecurring = null;
                }
            } else {
                console.error('Recurring modal not found with id="recurring-modal"');
            }
        }
        
        // Swipe to close support
        (function() {
            let startY = 0;
            let currentY = 0;
            let isDragging = false;
            
            const menu = document.getElementById('fabMenu');
            
            menu.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                isDragging = true;
                menu.style.transition = 'none';
            }, { passive: true });
            
            menu.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                
                currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;
                
                if (deltaY > 0) {
                    menu.style.transform = `translateY(${deltaY}px)`;
                }
            }, { passive: true });
            
            menu.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                
                isDragging = false;
                menu.style.transition = '';
                
                const deltaY = currentY - startY;
                
                if (deltaY > 100) {
                    closeFabMenu();
                } else {
                    menu.style.transform = '';
                }
            }, { passive: true });
        })();
    </script>

</body>
</html>
