<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>Lens - Personal Finance Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Clear financial insight for personal expense tracking and budgeting">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lens">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Content Security Policy for PWA -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdn.plaid.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https: http://localhost:8000 http://127.0.0.1:8000; frame-src https://cdn.plaid.com;">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='iconGradient' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6'/%3E%3Cstop offset='100%25' style='stop-color:%231d4ed8'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='0' y='0' width='32' height='32' rx='6' fill='url(%23iconGradient)'/%3E%3Ccircle cx='16' cy='16' r='10' fill='none' stroke='rgba(255,255,255,0.9)' stroke-width='1.5'/%3E%3Ccircle cx='16' cy='16' r='6' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='1'/%3E%3Ccircle cx='16' cy='16' r='3' fill='none' stroke='rgba(255,255,255,0.6)' stroke-width='1'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="mask-icon" href="icons/icon-192x192.png" color="#3b82f6">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Your existing scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc; /* Light gray background */
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b; /* Dark slate */
            --text-secondary: #64748b; /* Medium slate */
            --text-tertiary: #94a3b8; /* Light slate */
            --border-color: #e2e8f0;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --help-text-color: #374151;
            --health-score-good: var(--accent-green);
            --health-score-ok: var(--accent-yellow);
            --health-score-bad: var(--accent-red);
        }
        .dark {
            --bg-primary: #0f172a; /* Very dark blue */
            --bg-secondary: #1e293b; /* Dark blue */
            --bg-tertiary: #334155; /* Medium dark blue */
            --text-primary: #f1f5f9; /* Light gray */
            --text-secondary: #cbd5e1; /* Medium gray */
            --text-tertiary: #94a3b8; /* Darker gray */
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --help-text-color: #d1d5db;
        }
        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .stat-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
            text-align: center;
        }
        .dark .stat-card {
             background-color: var(--bg-tertiary);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .stat-card.cursor-pointer:hover {
            border-color: var(--accent-purple);
        }
        .stat-card-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        .stat-card-value {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* bold */
            color: var(--text-primary);
            line-height: 1.2;
        }
        .stat-card-value.text-green-600 { color: var(--accent-green); }
        .stat-card-value.text-red-600 { color: var(--accent-red); }
        .dark .stat-card-value.text-green-600 { color: #34d399; } /* Lighter green */
        .dark .stat-card-value.text-red-600 { color: #f87171; } /* Lighter red */
        
        /* Info Icon Styling */
        .info-icon {
            cursor: help;
            display: inline-flex;
            vertical-align: middle;
            color: var(--text-tertiary);
            transition: color 0.2s;
        }
        .info-icon:hover {
            color: var(--accent-blue);
        }
        /* Tooltip styling */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: normal;
            z-index: 50;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            max-width: 300px;
            width: max-content;
        }

        .tab-button {
            position: relative;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab-button:hover {
            color: var(--text-primary);
        }
        .tab-button.active {
            color: var(--accent-blue);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-blue);
            border-radius: 1px;
        }

/* Clean Onboarding Styles */
.onboarding-modal {
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    box-shadow: var(--shadow-md);
    max-width: 600px;
    max-height: 85vh;
    overflow-y: auto;
}

.progress-bar {
    width: 100%;
    height: 4px;
    background-color: var(--bg-tertiary);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background-color: var(--accent-blue);
    transition: width 0.5s ease;
}

.clean-goal-option:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.clean-goal-option.selected {
    border-color: var(--accent-blue);
    background-color: rgba(59, 130, 246, 0.1);
}

.clean-debt-item {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.clean-summary-card {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.highlight-number {
    color: var(--accent-blue);
    font-weight: 600;
}

        .modern-input, .modern-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
            appearance: none;
            line-height: 1.5;
        }
        .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem;
        }
        .dark .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .modern-input:focus, .modern-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .modern-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            min-height: 44px;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .modern-button-primary {
            background-color: var(--accent-blue);
            color: white;
        }
        .modern-button-primary:hover {
            background-color: #2563eb;
            box-shadow: var(--shadow-md);
        }
         .modern-button-primary:active {
            transform: translateY(1px);
        }
        .modern-button-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .modern-button-secondary:hover {
            background-color: var(--border-color);
        }
        .modern-button-danger {
            background-color: var(--accent-red);
            color: white;
        }
        .modern-button-danger:hover {
             background-color: #dc2626;
             box-shadow: var(--shadow-md);
        }
        .modern-button-outline {
            background-color: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .modern-button-outline:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .icon-button {
            padding: 0.5rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        .icon-button:hover {
            color: var(--text-primary);
        }
        .icon-button svg {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        .dropdown-menu {
            position: absolute;
            margin-top: 0.5rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 50;
            min-width: 220px; /* Wider for import/export */
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: background-color 0.2s ease, color 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .dropdown-item:hover {
            background-color: var(--bg-secondary);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        .dark .status-active {
             background-color: rgba(16, 185, 129, 0.2);
             color: #10b981;
        }
        .status-cancelled {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            text-decoration: line-through;
        }
         .dark .status-cancelled {
             background-color: rgba(239, 68, 68, 0.2);
             color: #ef4444;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #2d3748;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 100;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            position: relative; 
            height: 350px;
            width: 100%;
        }
        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-blue);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        /* Help Tab Contrast */
        #help-tab p, #help-tab li {
            color: var(--help-text-color);
            transition: color 0.3s;
        }
        #help-tab h3 {
             color: var(--text-primary);
             transition: color 0.3s;
        }
        #help-tab strong {
            color: var(--text-primary);
            transition: color 0.3s;
        }
        #help-tab ul {
            margin-left: 1rem;
        }
        /* Table Checkbox */
        .table-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        /* Budget Health Score */
        .health-score-container {
            position: relative;
            width: 150px;
            height: 75px; /* Half circle */
            overflow: hidden;
            margin: 1rem auto 0;
        }
        .health-score-gauge {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--bg-tertiary);
            border-bottom-color: transparent;
            border-left-color: transparent;
            transform: rotate(-135deg); /* Start from bottom-left */
            box-sizing: border-box;
        }
        .health-score-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--health-score-good); /* Default color */
            border-top-color: transparent;
            border-right-color: transparent;
            transform: rotate(45deg); /* Start from bottom-left, fill clockwise */
            transform-origin: center center;
            clip-path: polygon(50% 0%, 100% 0%, 100% 50%, 50% 50%); /* Clip to top-right quadrant initially */
            transition: transform 1s ease-out, border-color 0.5s ease;
            box-sizing: border-box;
        }
        .health-score-text {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            color: var(--text-primary);
        }
        .health-score-label {
            font-size: 0.875rem; /* text-sm */
            color: var(--text-secondary);
            margin-top: -5px;
        }
        /* AI Insights Styling */
        .ai-insight {
            background-color: rgba(59, 130, 246, 0.05); /* Light blue bg */
            border-left: 4px solid var(--accent-blue);
            padding: 1rem;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        .dark .ai-insight {
            background-color: rgba(59, 130, 246, 0.1);
            border-left-color: var(--accent-blue);
            color: var(--text-secondary);
        }
        .ai-insight strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        /* Consistent Dark Mode */
        html.dark body { background-color: var(--bg-secondary); color: var(--text-primary); }
        html.dark .card { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .stat-card { background-color: var(--bg-tertiary); border-color: var(--border-color); }
        html.dark .modern-input, html.dark .modern-select { background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        html.dark .modern-button-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        html.dark .modern-button-secondary:hover { background-color: var(--border-color); }
        html.dark .tab-button { color: var(--text-secondary); }
        html.dark .tab-button:hover { color: var(--text-primary); }
        html.dark .tab-button.active { color: var(--accent-blue); }
        html.dark .icon-button { color: var(--text-secondary); }
        html.dark .icon-button:hover { color: var(--text-primary); }
        html.dark .dropdown-menu { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .dropdown-item { color: var(--text-primary); }
        html.dark .dropdown-item:hover { background-color: var(--bg-secondary); }
        html.dark table thead { background-color: var(--bg-tertiary); color: var(--text-secondary); }
        html.dark table tbody tr { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark table tbody tr:hover { background-color: var(--bg-secondary); }
        html.dark table tbody td { color: var(--text-secondary); }
        html.dark table tbody td:first-child { color: var(--text-primary); }
        html.dark #help-tab p, html.dark #help-tab li { color: var(--help-text-color); }
        html.dark #help-tab h3, html.dark #help-tab strong { color: var(--text-primary); }
        html.dark .health-score-gauge { border-color: var(--bg-tertiary); border-bottom-color: transparent; border-left-color: transparent; }
        html.dark .health-score-text { color: var(--text-primary); }
        html.dark .health-score-label { color: var(--text-secondary); }

        /* Driver.js Customization */
        .driver-popover {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* Match card radius */
        }
        .driver-popover-title {
            color: var(--text-primary);
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
        }
        .driver-popover-description {
            color: var(--text-secondary);
        }
        .driver-popover-progress-text {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn:hover {
            color: var(--text-primary);
        }
        .driver-popover-arrow-side-left.driver-popover-arrow {
            border-left-color: var(--border-color);
        }
        .driver-popover-arrow-side-right.driver-popover-arrow {
            border-right-color: var(--border-color);
        }
        .driver-popover-arrow-side-top.driver-popover-arrow {
            border-top-color: var(--border-color);
        }
        .driver-popover-arrow-side-bottom.driver-popover-arrow {
            border-bottom-color: var(--border-color);
        }
        .driver-popover-footer {
            gap: 0.5rem;
        }
        .driver-popover-next-btn, .driver-popover-prev-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
            cursor: pointer;
            text-shadow: none;
        }
        .driver-popover-next-btn {
            background-color: var(--accent-blue);
            color: white;
        }
        .driver-popover-next-btn:hover {
            background-color: #2563eb; /* Darker blue */
        }
        .driver-popover-prev-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .driver-popover-prev-btn:hover {
            background-color: var(--border-color);
        }

        /* Settings Modal Text Color Fix */
        #settings-modal .card h4,
        #settings-modal .card label {
            color: var(--text-primary);
        }

        /* Interactive Range Slider Styles */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--border-color);
            outline: none;
            border-radius: 5px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-blue);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider::-webkit-slider-thumb:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-blue);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-track {
            height: 8px;
            background: var(--border-color);
            border-radius: 5px;
        }

        /* New Tooltip CSS */
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 320px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            text-align: left;
            border-radius: 8px;
            padding: 16px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -160px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .dark .tooltip .tooltiptext {
            background-color: var(--bg-tertiary);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Arrow pointing down */
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--bg-primary) transparent transparent transparent;
        }

        .dark .tooltip .tooltiptext::after {
            border-color: var(--bg-tertiary) transparent transparent transparent;
        }

        /* AI Insights v2 Styling */
        .ai-section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* 12px */
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* bold */
            margin-bottom: 1rem; /* 16px */
        }
        .prediction-card {
            background-color: var(--bg-tertiary);
            padding: 1rem; /* 16px */
            border-radius: 0.75rem; /* 12px */
            border: 1px solid var(--border-color);
        }
        .confidence-meter {
            background-color: var(--border-color);
            border-radius: 9999px;
            height: 0.5rem; /* 8px */
            overflow: hidden;
        }
        .confidence-fill {
            background-color: var(--accent-blue);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .action-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .action-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .metric-card {
            background-color: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .ai-loading {
            width: 24px;
            height: 24px;
            border: 3px solid var(--accent-blue);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Bottom Nav Styling */
        .bottom-nav {
            background-color: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dark .bottom-nav {
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
        .bottom-nav-item {
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }
        .bottom-nav-item.active {
            color: var(--accent-blue);
        }
        
        /* New Mobile Card Styling */
        .mobile-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin: 0 0 12px 0;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        html.dark .mobile-card {
            background-color: var(--bg-tertiary);
        }
        .mobile-card:active {
            transform: scale(0.98);
            background-color: var(--bg-tertiary);
        }
        .mobile-card-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-tertiary);
            font-size: 1.25rem;
        }
         html.dark .mobile-card-icon {
            background-color: var(--bg-secondary);
        }
        .mobile-card-main {
            flex: 1;
            min-width: 0;
        }
        .mobile-card-title {
            font-weight: 500;
            color: var(--text-primary);
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        .mobile-card-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .mobile-card-amount {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        
        
        /* Modal z-index fixes */
        #goals-modal {
            z-index: 55 !important;
        }

        @media (max-width: 640px) {
          /* Hide table headers */
          table thead {
            position: absolute;
            top: -9999px;
            left: -9999px;
          }
          
          /* Date group headers - Revolut style */
          .mobile-date-header td {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0.75rem 1rem !important;
            color: var(--text-secondary) !important;
            font-size: 0.875rem !important;
            font-weight: 600 !important;
            border-bottom: 1px solid var(--border-color) !important;
            margin-bottom: 0.5rem !important;
            background: transparent !important;
            border-radius: 0 !important;
            box-shadow: none !important;
          }

          /* Checkbox styling */
          td:first-child {
            display: none !important;
          }
          
          td:first-child::before {
            content: '' !important;
          }

          /* Card layout */
          table, tbody, tr {
            display: block;
            width: 100%;
          }

          /* REVOLUT-STYLE TRANSACTION CARDS */
          tr:not(.mobile-date-header) {
            display: flex !important;
            align-items: center !important;
            background: var(--bg-primary) !important;
            border: 1px solid var(--border-color) !important;
            border-bottom: none !important;
            padding: 1rem !important;
            margin-bottom: 0 !important;
            gap: 0.75rem !important;
            transition: all 0.2s ease !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            min-height: 64px !important;
            cursor: pointer !important;
          }

          /* First card rounded top */
          tr:not(.mobile-date-header):first-of-type {
            border-radius: 0.75rem 0.75rem 0 0 !important;
          }

          /* Last card rounded bottom */
          tr:not(.mobile-date-header):last-of-type {
            border-radius: 0 0 0.75rem 0.75rem !important;
            border-bottom: 1px solid var(--border-color) !important;
          }

          /* Only card gets full rounded corners */
          tr:not(.mobile-date-header):only-of-type {
            border-radius: 0.75rem !important;
            border-bottom: 1px solid var(--border-color) !important;
          }

          .mobile-transaction-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 16px 8px;
            width: auto !important;
            min-width: fit-content !important;
            border: none !important;
          }
          .mobile-transaction-actions .icon-button {
            padding: 4px;
          }

          /* Hover and active states */
          tr:not(.mobile-date-header):hover {
            background: var(--bg-tertiary) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
          }

          tr:not(.mobile-date-header):active {
            transform: scale(0.98);
            background: var(--bg-tertiary) !important;
          }

          /* Transaction Icon - position as second visible element */
          td:nth-child(2) {
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #6b7280, #4b5563) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            font-size: 1.25rem !important;
            color: white !important;
            border: none !important;
          }

          /* Category-based icon colors */
          tr[data-category="Food/Drink"] td:nth-child(2) {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
          }
          tr[data-category="Transport"] td:nth-child(2) {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
          }
          tr[data-category="Entertainment"] td:nth-child(2) {
            background: linear-gradient(135deg, #8b5cf6, #a855f7) !important;
          }
          tr[data-category="Housing"] td:nth-child(2) {
            background: linear-gradient(135deg, #10b981, #059669) !important;
          }
          tr[data-category="Subscriptions"] td:nth-child(2) {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
          }
          tr[data-category="Utilities"] td:nth-child(2) {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
          }
          tr[data-category="Shopping"] td:nth-child(2) {
            background: linear-gradient(135deg, #ec4899, #db2777) !important;
          }
          tr[data-category="Health"] td:nth-child(2) {
            background: linear-gradient(135deg, #06b6d4, #0891b2) !important;
          }

          /* Icon display using data attribute */
          td:nth-child(2)::after {
            content: attr(data-icon);
            font-size: 1.25rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
          }

          /* Transaction details - Name field becomes flex container */
          td[data-label="Name"] {
            flex: 1 !important;
            min-width: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: flex-start !important;
            border: none !important;
          }

          /* Transaction name styling */
          td[data-label="Name"] > span {
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            font-size: 1rem !important;
            margin-bottom: 0.125rem !important;
            line-height: 1.2 !important;
            display: block !important;
            max-width: 100% !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
          }

          /* Transaction meta info */
          td[data-label="Name"]::after {
            font-size: 0.8125rem !important;
            color: var(--text-secondary) !important;
            display: block !important;
            margin-top: 0.125rem !important;
            line-height: 1.2 !important;
          }

          /* Generate meta info based on transaction type */
          td[data-label="Name"]:not([data-recurring="true"])::after {
            content: attr(data-category) " â€¢ " attr(data-time);
          }

          td[data-label="Name"][data-recurring="true"]::after {
            content: "ðŸ” Recurring â€¢ " attr(data-time);
          }

          /* Transaction amount */
          td[data-label="Amount"] {
            font-weight: 700 !important;
            font-size: 1.125rem !important;
            color: var(--text-primary) !important;
            text-align: right !important;
            padding: 0 !important;
            margin: 0 !important;
            margin-left: auto !important;
            flex-shrink: 0 !important;
            border: none !important;
            display: flex !important;
            align-items: center !important;
            line-height: 1 !important;
            white-space: nowrap !important;
            max-width: 30% !important;
          }

          /* Positive amounts (income) */
          td[data-label="Amount"][data-positive="true"] {
            color: var(--accent-green) !important;
          }

          /* Hide other desktop fields */
          td[data-label="Date"],
          td[data-label="Category"],
          td[data-label="Payment Method"],
          td[data-label="Type"],
          td[data-label="Actions"] {
            display: none !important;
          }

          /* Dark mode improvements */
          html.dark tr:not(.mobile-date-header) {
            background: var(--bg-primary) !important;
            border-color: var(--border-color) !important;
          }

          html.dark tr:not(.mobile-date-header):hover {
            background: var(--bg-tertiary) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
          }

          html.dark .mobile-date-header td {
            color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
          }

          html.dark td[data-label="Name"] > span {
            color: var(--text-primary) !important;
          }

          html.dark td[data-label="Name"]::after {
            color: var(--text-secondary) !important;
          }

          html.dark td[data-label="Amount"] {
            color: var(--text-primary) !important;
          }

          html.dark td[data-label="Amount"][data-positive="true"] {
            color: var(--accent-green) !important;
          }

          /* Responsive adjustments for smaller screens */
          @media (max-width: 375px) {
            tr:not(.mobile-date-header) {
              padding: 0.875rem !important;
              gap: 0.625rem !important;
            }

            td:nth-child(2) {
              width: 36px !important;
              height: 36px !important;
              min-width: 36px !important;
              font-size: 1.125rem !important;
            }
            
            td[data-label="Name"] > span {
              font-size: 0.9375rem !important;
            }
            
            td[data-label="Amount"] {
              font-size: 1rem !important;
            }
          }

          /* Prevent horizontal overflow */
          .overflow-x-auto {
            overflow-x: hidden !important;
            width: 100%;
          }

          .card .overflow-x-auto {
            margin: -0.25rem;
            padding: 0.25rem;
          }
        }

        /* Landscape mode optimizations */
        @media screen and (orientation: landscape) and (max-height: 500px) {
          .app-header,
          header.card {
            padding: 0.75rem 1rem !important;
          }
          
          .app-header h1,
          header.card h1 {
            font-size: 1.5rem !important;
          }
          
          .bottom-nav {
            height: 56px !important;
          }
          
          .bottom-nav-item svg {
            width: 1.125rem !important;
            height: 1.125rem !important;
            margin-bottom: 0.125rem !important;
          }
          
          .bottom-nav-item span {
            font-size: 0.625rem !important;
          }
        }

        /* Safe area handling for notched devices */
        @supports (padding: max(0px)) {
          body {
            padding-bottom: max(5rem, env(safe-area-inset-bottom));
          }
          
          .bottom-nav {
            padding-bottom: max(0px, env(safe-area-inset-bottom));
          }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
          body {
            height: 100vh;
            height: -webkit-fill-available;
          }
          
          .min-h-screen {
            min-height: 100vh;
            min-height: -webkit-fill-available;
          }
        }

        /* Enhanced touch interactions */
        @media (hover: none) and (pointer: coarse) {
          .modern-button:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
          }
        }
        
        /* === Lens Mobile Card Layout END === */

        /* No-scroll CSS - Prevent horizontal scrolling */
        html,body{max-width:100%;overflow-x:hidden;}
        .table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%;}
        
        /* Enhanced Pagination Styling */
        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 1rem;
            margin: 0;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            border-radius: 0 0 0.75rem 0.75rem;
        }
        
        .pagination-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .pagination-info select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            min-width: 70px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .pagination-info select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0;
        }
        
        .pagination-status {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }
        
        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .pagination-nav-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            min-height: 36px;
        }
        
        .pagination-nav-btn:hover:not(:disabled) {
            background-color: var(--bg-secondary);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .pagination-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--bg-tertiary);
        }
        
        .pagination-page-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 0.75rem;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            margin: 0 0.25rem;
        }
        
        .pagination-page-input {
            width: 3.5rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            text-align: center;
            font-weight: 600;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .pagination-page-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background-color: white;
        }
        
        .dark .pagination-page-input:focus {
            background-color: var(--bg-secondary);
        }
        
        .pagination-page-total {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Dark mode improvements */
        .dark .pagination-container {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
        }
        
        .dark .pagination-info select,
        .dark .pagination-nav-btn,
        .dark .pagination-page-input {
            background-color: var(--bg-primary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .dark .pagination-nav-btn:hover:not(:disabled) {
            background-color: var(--bg-secondary);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .dark .pagination-nav-btn:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-tertiary);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .pagination-controls {
                gap: 0.75rem;
            }
            
            .pagination-status {
                font-size: 0.8125rem;
            }
            
            .pagination-nav-btn {
                padding: 0.375rem 0.625rem;
                font-size: 0.8125rem;
                min-width: 32px;
                min-height: 32px;
            }
            
            .pagination-page-input {
                width: 3rem;
                padding: 0.375rem 0.5rem;
                font-size: 0.8125rem;
            }
        }
    </style>

<style>
#health-score-tooltip{
  bottom:auto !important;
  top:110% !important;
}
</style>

<!-- Added by ChatGPT 2025-06-22 -->
<style>
#commitment-buttons .modern-button {
    white-space: normal;
    line-height: 1.25rem;
    padding-block: .75rem;
    text-align: left;
    min-height: 64px;
}
#goal-confirmation-overlay {
    position: fixed !important;
}
</style>

</head>
<body class="antialiased pb-20 md:pb-0">
    <div class="min-h-screen p-4 md:p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="card p-2 md:p-1 mb-6">
                <div class="flex justify-between items-center gap-4">
                    <!-- Logo & Title -->
                    <div class="flex items-center gap-3" data-tour="app-header">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="8" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" fill="none"/>
                                <circle cx="12" cy="12" r="5" stroke="rgba(255,255,255,0.6)" stroke-width="1" fill="none"/>
                                <circle cx="12" cy="12" r="2.5" stroke="rgba(255,255,255,0.8)" stroke-width="1" fill="none"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold">Lens</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Your financial insight</p>
                                        </div>
                                        </div>

                    <!-- Desktop Navigation & Settings -->
                    <div class="hidden md:flex items-center gap-4">
                        <nav class="flex items-center space-x-2" aria-label="Tabs">
                        <button onclick="showTab('overview')" id="tab-overview" class="tab-button active">Overview</button>
                        <button onclick="showTab('expenses')" id="tab-expenses" class="tab-button">Expenses</button>
                        <button onclick="showTab('recurring')" id="tab-recurring" class="tab-button">Recurring</button>
                            <button onclick="showTab('insights')" id="tab-insights" class="tab-button">Insights</button>
                    </nav>
                        <div class="border-l border-gray-200 dark:border-gray-600 h-8"></div>
                        <div class="relative inline-block text-left">
                            <button onclick="openSettings()" class="modern-button modern-button-secondary" data-tour="budget-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                                <span class="hidden sm:inline">Settings</span>
                            </button>
                </div>
            </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <div class="mt-6">
                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Key Stats & Budget Health -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Key Stats Row -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="stat-card bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800">
                                    <div class="stat-card-title">Monthly Budget</div>
                                    <div class="stat-card-value text-blue-600 dark:text-blue-400" id="monthly-budget">Â£0.00</div>
                                </div>
                                <div class="stat-card bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800">
                                    <div class="stat-card-title">Spent (Month)</div>
                                    <div class="stat-card-value text-red-600" id="total-expenses">Â£0.00</div>
                                </div>
                                <div class="stat-card bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800">
                                    <div class="stat-card-title">Remaining</div>
                                    <div class="stat-card-value text-green-600" id="remaining-amount">Â£0.00</div>
                                </div>
                                 <div class="stat-card bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-800 cursor-pointer hover:border-purple-400 dark:hover:border-purple-600" onclick="openGoalsModal()" data-tour="goals-section">
                                    <div class="stat-card-title">
                                        Goal Progress
                                        <span class="info-icon ml-1" data-tooltip="Shows your progress on active financial goals. Click for details.">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="stat-card-value text-purple-600 dark:text-purple-400" id="goal-progress-display">--</div>
                                </div>
                            </div>
                
                            <!-- ADDED SHORTCUTS -->
                            <div class="text-center -mt-4 space-x-4">
                                <button class="text-sm text-blue-600 dark:text-blue-400 opacity-70 hover:opacity-100 hover:underline" onclick="openSettings('budget')">
                                    Edit budget & income
                                </button>
                                <span class="text-gray-300">â€¢</span>
                                <button class="text-sm text-purple-600 dark:text-purple-400 opacity-70 hover:opacity-100 hover:underline" onclick="openEditTotalSavings()">
                                    Edit total savings
                                </button>
                            </div>
                
                            <!-- Budget Health & Progress -->
                            <div class="card p-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                                    <div class="md:col-span-2">
                                        <h3 class="text-lg font-semibold mb-1">Budget Progress</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">How you're tracking against your monthly budget.</p>
                                        <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 mb-2">
                                            <div id="budget-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <p id="budget-percentage" class="text-sm text-gray-600 dark:text-gray-400">0% Used</p>
                                        </div>
                                        <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm" id="ai-projection-container">
                                            <!-- AI Projection content will be inserted here -->
                                        </div>
                                    </div>
                                    <div class="text-center" id="budget-health-section">
                                        <div class="flex items-center justify-center gap-2 mb-2">
                                            <h3 class="text-lg font-semibold">Budget Health</h3>
                                            <div class="tooltip">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-help hover:text-gray-600 dark:hover:text-gray-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div id="health-score-tooltip" class="tooltiptext">
                                                    <!-- Dynamic content goes here -->
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div id="health-score-visual" class="relative w-32 h-32 mx-auto mb-2">
                                            <!-- Circular progress indicator will be rendered here by JS -->
                                        </div>
                                        
                                        <div id="health-score-trend" class="text-xs mt-1">
                                            <!-- Trend indicator will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Essential vs Non-Essential -->
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Spending Breakdown (Month)</h3>
                                <div class="flex justify-around items-center text-center mb-4">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Essential</p>
                                        <p class="text-2xl font-semibold text-sky-600 dark:text-sky-400" id="essential-spending">Â£0.00</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Non-Essential</p>
                                        <p class="text-2xl font-semibold text-indigo-600 dark:text-indigo-400" id="non-essential-spending">Â£0.00</p>
                                    </div>
                                </div>
                                <div class="w-full rounded-full h-3">
                                    <div id="essential-bar" class="bg-sky-500 h-3 rounded-l-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div><!--
                                 --><div id="non-essential-bar" class="bg-indigo-500 h-3 rounded-r-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                
                        <!-- Right Column: Actions & Recent Activity -->
                        <div class="space-y-6">
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                                <div class="space-y-3">
                                    <button onclick="showAddForm()" class="modern-button modern-button-primary w-full" data-tour="add-expense">
                                        <span>âž•</span> Add New Expense
                                    </button>
                                    <button onclick="showRecurringForm()" class="modern-button modern-button-secondary w-full">
                                        <span>ðŸ”</span> Add Recurring Item
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Quick Add Common Expenses</h3>
                                <div class="flex flex-col gap-2 w-full">
                                    <div id="quick-add-coffee">
                                        <button class="bg-gray-600 dark:bg-gray-700 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">â˜•</span>
                                                <span class="text-white">Coffee</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-transport">
                                        <button class="bg-gray-600 dark:bg-gray-700 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">ðŸšŒ</span>
                                                <span class="text-white">Transport</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-lunch">
                                        <button class="bg-gray-600 dark:bg-gray-700 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">ðŸ¥ª</span>
                                                <span class="text-white">Lunch</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-groceries">
                                        <button class="bg-gray-600 dark:bg-gray-700 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">ðŸ›’</span>
                                                <span class="text-white">Groceries</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                                <div id="recent-expenses" class="space-y-3">
                                    <p class="text-gray-700 dark:text-gray-800">No recent expenses.</p>
                                </div>
                                <div class="text-center mt-4">
                                    <button onclick="showTab('expenses')" class="text-blue-600 dark:text-blue-400 font-medium hover:underline">
                                        See all
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expenses Tab -->
                <div id="expenses-tab" class="tab-content hidden fade-in">
                    <div class="card">
                        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-4">
                            <h2 class="text-xl font-semibold">All Expenses</h2>
                            <div class="flex flex-wrap gap-2 sm:gap-3">
                                <button onclick="toggleFilterPanel('expense-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                    </svg>
                                    Filters
                                </button>
                                <button id="delete-selected-btn" onclick="deleteSelectedExpenses()" class="modern-button modern-button-danger hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showAddForm()" class="modern-button modern-button-primary">
                                     <span>âž•</span> Add Expense
                                 </button>
                             </div>
                        </div>
                        
                        <!-- Filter Panel -->
                        <div id="expense-filter-panel" class="p-4 border-b border-gray-200 dark:border-gray-700 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <!-- Date Range -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Date Range</label>
                                    <div class="flex gap-2">
                                        <input type="date" id="expense-filter-date-from" class="modern-input">
                                        <input type="date" id="expense-filter-date-to" class="modern-input">
                                    </div>
                                </div>
                                <!-- Category -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Category</label>
                                    <select id="expense-filter-category" class="modern-select">
                                        <option value="">All Categories</option>
                                        <!-- Populated dynamically -->
                                    </select>
                                </div>
                                <!-- Type -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Type</label>
                                    <select id="expense-filter-type" class="modern-select">
                                        <option value="">All Types</option>
                                        <option value="Essential">Essential</option>
                                        <option value="Non-Essential">Non-Essential</option>
                                        <option value="Recurring">Recurring</option>
                                    </select>
                            </div>
                            <!-- Clear Filters -->
                                <div class="md:col-span-3 flex justify-end gap-2">
                                <button onclick="applyExpenseFilters()" class="modern-button modern-button-primary">Apply Filters</button>
                                <button onclick="clearExpenseFilters()" class="modern-button modern-button-secondary">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-expenses" onchange="toggleSelectAllExpenses(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Date</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Payment Method</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Type</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table">
                                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                        <td colspan="8" class="px-6 py-4 text-center">No expenses recorded yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Expenses Pagination -->
                        <div id="expenses-pagination" class="pagination-container">
                            <div class="pagination-info">
                                <span>Show</span>
                                <select id="expenses-per-page" onchange="changeExpensesPerPage(this.value)">
                                    <option value="5" selected>5</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <span>entries</span>
                            </div>
                            
                            <div class="pagination-controls">
                                <span id="expenses-page-info" class="pagination-status"></span>
                                <div class="pagination-buttons">
                                    <button onclick="goToExpensesPage('first')" id="expenses-first-btn" class="pagination-nav-btn" title="First page">
                                        â®
                                    </button>
                                    <button onclick="changeExpensesPage('prev')" id="expenses-prev-btn" class="pagination-nav-btn">
                                        Previous
                                    </button>
                                    <div class="pagination-page-input-container">
                                        <span class="text-sm text-gray-500">Page</span>
                                        <input type="number" id="expenses-page-input" min="1" onchange="goToExpensesPage(this.value)" class="pagination-page-input">
                                        <span id="expenses-total-pages" class="pagination-page-total"></span>
                                    </div>
                                    <button onclick="changeExpensesPage('next')" id="expenses-next-btn" class="pagination-nav-btn">
                                        Next
                                    </button>
                                    <button onclick="goToExpensesPage('last')" id="expenses-last-btn" class="pagination-nav-btn" title="Last page">
                                        â­
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <!-- Recurring Tab -->
                <div id="recurring-tab" class="tab-content hidden fade-in">
                    <div class="card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 gap-4">
                            <div>
                                <h2 class="text-xl font-bold">Recurring Items</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Regular income and expenses like salaries or subscriptions.</p>
                            </div>
                            <div class="flex-shrink-0 flex flex-wrap items-center gap-2 sm:space-x-2 sm:gap-0">
                                <button onclick="toggleFilterPanel('recurring-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg>
                                    Filter
                                </button>
                                <button id="delete-selected-recurring-btn" onclick="deleteSelectedRecurring()" class="modern-button modern-button-danger hidden">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showRecurringForm()" class="modern-button modern-button-primary">
                                    <span>ðŸ”</span> Add Recurring
                                </button>
                            </div>
                        </div>
                
                        <div id="recurring-filter-panel" class="hidden p-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label for="recurring-filter-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                                    <select id="recurring-filter-type" class="modern-select mt-1">
                                        <option value="">All Types</option>
                                        <option value="income">Income</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                                    <select id="recurring-filter-category" class="modern-select mt-1">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-frequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                                    <select id="recurring-filter-frequency" class="modern-select mt-1">
                                        <option value="">All Frequencies</option>
                                        <option value="Daily">Daily</option>
                                        <option value="Weekly">Weekly</option>
                                        <option value="Bi-Weekly">Bi-Weekly</option>
                                        <option value="Monthly">Monthly</option>
                                        <option value="Quarterly">Quarterly</option>
                                        <option value="Annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 mt-4">
                                <button onclick="applyRecurringFilters()" class="modern-button modern-button-primary">Apply</button>
                                <button onclick="clearRecurringFilters()" class="modern-button modern-button-secondary">Clear</button>
                            </div>
                        </div>
                
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-recurring" onchange="toggleSelectAllRecurring(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Type</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Frequency</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell" style="white-space: nowrap;">Date</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recurring-table">
                                    <!-- Rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Recurring Pagination -->
                        <div id="recurring-pagination" class="pagination-container">
                            <div class="pagination-info">
                                <span>Show</span>
                                <select id="recurring-per-page" onchange="changeRecurringPerPage(this.value)">
                                    <option value="10">10</option>
                                    <option value="15" selected>15</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <span>entries</span>
                            </div>
                            
                            <div class="pagination-controls">
                                <span id="recurring-page-info" class="pagination-status"></span>
                                <div class="pagination-buttons">
                                    <button onclick="goToRecurringPage('first')" id="recurring-first-btn" class="pagination-nav-btn" title="First page">
                                        â®
                                    </button>
                                    <button onclick="changeRecurringPage('prev')" id="recurring-prev-btn" class="pagination-nav-btn">
                                        Previous
                                    </button>
                                    <div class="pagination-page-input-container">
                                        <span class="text-sm text-gray-500">Page</span>
                                        <input type="number" id="recurring-page-input" min="1" onchange="goToRecurringPage(this.value)" class="pagination-page-input">
                                        <span id="recurring-total-pages" class="pagination-page-total"></span>
                                    </div>
                                    <button onclick="changeRecurringPage('next')" id="recurring-next-btn" class="pagination-nav-btn">
                                        Next
                                    </button>
                                    <button onclick="goToRecurringPage('last')" id="recurring-last-btn" class="pagination-nav-btn" title="Last page">
                                        â­
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                
                <!-- Replace your insights tab HTML with this better layout -->
<div id="insights-tab" class="tab-content hidden fade-in">
    <!-- Priority Content First -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Smart Recommendations -->
        <div class="card p-6">
            <h2 class="ai-section-title">
                <span class="text-xl">ðŸ’¡</span>
                <span>Smart Recommendations</span>
                <span id="action-count" class="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
            </h2>
            <div id="smart-recommendations" class="space-y-3">
                <!-- JS-rendered content -->
            </div>
        </div>
        
        <!-- Your Goals -->
        <div class="card p-6">
            <h2 class="ai-section-title">
                <span class="text-xl">ðŸŽ¯</span>
                <span>Your Goals</span>
            </h2>
            <div id="goals-dashboard">
                <!-- JS-rendered content -->
            </div>
        </div>
    </div>

    <!-- Secondary Content -->
    <div class="grid grid-cols-1 gap-6 mb-6">
        <!-- Your Monthly Story (Combined with metrics) -->
        <div class="card p-6">
            <h2 class="ai-section-title">
                <span class="text-xl">ðŸ“–</span>
                <span>Your Monthly Story</span>
            </h2>
            <div id="monthly-story">
                <!-- JS-rendered content with embedded metrics -->
            </div>
            <!-- This container is now hidden as metrics are embedded above -->
            <div id="story-metrics" class="hidden"></div>
        </div>
        
        <!-- 7-Day Forecast (Moved to secondary position) -->
        <div class="card p-6">
            <h2 class="ai-section-title">
                <span class="text-xl">ðŸ“…</span>
                <span>7-Day Forecast</span>
            </h2>
            <div id="seven-day-forecast" class="space-y-4">
                <!-- JS-rendered content -->
            </div>
        </div>
    </div>

    <!-- Charts (Least important, moved to bottom) -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <div class="card p-6">
             <h2 class="text-xl font-bold mb-4">Spending Trend</h2>
             <div class="chart-container h-64 md:h-80">
                <canvas id="spending-trend-chart"></canvas>
            </div>
        </div>
        <div class="card p-6">
            <h2 class="text-xl font-semibold mb-4">Monthly Savings Trend</h2>
            <div class="chart-container" style="height: 320px;">
                <canvas id="monthly-savings-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced dark mode styling */
:root {
    --insights-bg-primary: #ffffff;
    --insights-bg-secondary: #f8fafc;
    --insights-text-primary: #1e293b;
    --insights-text-secondary: #64748b;
}

.dark {
    --insights-bg-primary: #0f172a;
    --insights-bg-secondary: #1e293b;
    --insights-text-primary: #f1f5f9;
    --insights-text-secondary: #cbd5e1;
}

/* Better contrast for insights */
#insights-tab {
    background-color: var(--insights-bg-secondary);
    min-height: 100vh;
    padding: 1rem;
}

#insights-tab .card {
    background-color: var(--insights-bg-primary);
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.dark #insights-tab .card {
    background-color: var(--insights-bg-primary);
    border-color: #334155;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

/* Recommendation cards with better dark mode */
#smart-recommendations .border-l-4 {
    background-color: var(--insights-bg-primary);
    border-right: 1px solid var(--border-color);
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
}

.dark #smart-recommendations .border-l-4 {
    background-color: #1e293b;
    border-right-color: #334155;
    border-top-color: #334155;
    border-bottom-color: #334155;
}

/* Fix text contrast in dark mode */
.dark #insights-tab h2,
.dark #insights-tab h3,
.dark #insights-tab h4 {
    color: var(--insights-text-primary);
}

.dark #insights-tab p,
.dark #insights-tab span:not(.bg-red-500):not(.bg-blue-600):not(.text-green-600):not(.text-red-600) {
    color: var(--insights-text-secondary);
}

/* Better visibility for action buttons */
.dark #smart-recommendations .bg-blue-600 {
    background-color: #2563eb !important;
    color: white !important;
}

/* Ensure chart visibility in dark mode */
.dark .chart-container {
    background-color: var(--insights-bg-primary);
    border-radius: 0.5rem;
    padding: 1rem;
}

/* Make metrics cards more visible */
.dark .metric-card,
.dark .bg-gray-50 {
    background-color: #334155 !important;
    color: var(--insights-text-primary) !important;
}

/* Toast improvements for dark mode */
.dark .toast {
    background-color: #1e293b !important;
    border: 1px solid #334155 !important;
    color: var(--insights-text-primary) !important;
}
</style>

    <!-- Settings Modal -->
    <div id="settings-modal" onclick="closeSettings()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-2 sm:p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Settings</h3>
                <button onclick="closeSettings()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Budget & Income Section -->
                <div id="settings-budget-section" class="space-y-3 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                    <h4 class="text-md font-semibold">Budget & Income</h4>
                    <div>
                        <label class="block text-xs font-medium">Monthly Budget</label>
                        <input type="number" id="settings-budget-input" placeholder="e.g., 2000" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-xs font-medium">Monthly Income</label>
                        <input type="number" id="settings-income-input" placeholder="e.g., 3500" class="modern-input mt-1">
                    </div>
                </div>
            
                <!-- General Settings -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="theme-toggle" class="text-sm font-medium">Dark Mode</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle" onchange="toggleTheme(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="currency-select" class="text-sm font-medium">Currency</label>
                        <select id="currency-select" onchange="changeCurrency(this.value)" class="modern-select text-sm w-40">
                            <option value="AUD">AUD (A$)</option>
                            <option value="CAD">CAD (C$)</option>
                            <option value="EUR">EUR (â‚¬)</option>
                            <option value="GBP">GBP (Â£)</option>
                            <option value="JPY">JPY (Â¥)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="space-y-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="exportData()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>Export Data (JSON)</span>
                    </button>
                    <label class="modern-button modern-button-secondary w-full justify-start cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>Import Data (JSON)</span>
                        <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                    </label>
                    <button onclick="connectBankAccount()" class="modern-button modern-button-secondary w-full justify-start" id="connect-bank-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                        <span>Connect Bank Account</span>
                    </button>
                    <button onclick="importBankTransactions()" class="modern-button modern-button-secondary w-full justify-start" id="import-transactions-btn" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>Import Bank Transactions</span>
                    </button>
                     <button onclick="openHelpModal()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Help & Documentation</span>
                    </button>
                    <button onclick="restartTour()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>Restart Tour</span>
                    </button>
                </div>
            </div>

            <div class="flex gap-3 mt-6 border-t border-gray-200 dark:border-gray-700 pt-3">
                <button onclick="saveSettings()" class="modern-button modern-button-primary flex-1">Save & Close</button>
                <button onclick="closeSettings()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>
    




    <!-- Add/Edit Expense Modal -->
    <div id="modal" onclick="closeModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-6" id="modal-title">Add New Expense</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="expense-name" placeholder="e.g., Coffee, Rent" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="modal-currency">Â£</span>)</label>
                        <input type="number" step="0.01" id="expense-cost" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" id="expense-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="expense-category" class="modern-select mt-1">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                        <select id="expense-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="expense-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveExpense()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Recurring Item Modal -->
    <div id="recurring-modal" onclick="closeRecurringModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-4" id="recurring-modal-title">Add Recurring Item</h3>
            <div class="space-y-4">
                 <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                    <select id="recurring-item-type" class="modern-select mt-1" onchange="toggleRecurringFields(this.value)">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="recurring-name" placeholder="e.g., Salary, Netflix" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="recurring-modal-currency">Â£</span>)</label>
                        <input type="number" step="0.01" id="recurring-amount" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                        <select id="recurring-frequency" class="modern-select mt-1">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Bi-Weekly">Bi-Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Annual">Annual</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="recurring-category" class="modern-select mt-1">
                            <!-- Options loaded dynamically -->
                        </select>
                    </div>
                    <div id="recurring-essential-type-wrapper">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Expense Type</label>
                        <select id="recurring-essential-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                        <input type="date" id="recurring-start-date" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date (Optional)</label>
                        <input type="date" id="recurring-end-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="recurring-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveRecurring()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeRecurringModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" onclick="closeHelpModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold">Help & Documentation</h3>
                <button onclick="closeHelpModal()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 md:p-8">
                <div class="space-y-8 text-sm leading-relaxed">
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">ðŸš€ Getting Started</h3>
                        <p>Welcome to Lens! The first time you use the app, an onboarding tour will guide you through the key features. You can start by visiting the <button onclick="openSettings('budget')" class="text-blue-600 hover:underline">Settings</button> to set your monthly budget and income.</p>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">The Dashboard Tabs</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-md mb-2">ðŸŽ¯ Overview</h4>
                                <p class="mb-2">This is your main financial dashboard, giving you a live snapshot of your finances for the current month.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Key Stats:</strong> See your total monthly budget, how much you've spent, what's remaining, and your total income. Click the income card for a detailed breakdown.</li>
                                    <li><strong>Budget Progress & AI Projection:</strong> A visual bar shows how much of your budget is used. The AI projection forecasts your total spending by month-end.</li>
                                    <li><strong>Budget Health Score:</strong> A score from 0-100 that measures how well you're managing your finances. Hover over it for a detailed breakdown of what's affecting your score.</li>
                                    <li><strong>Spending Breakdown:</strong> See a clear split between your Essential and Non-Essential spending.</li>
                                    <li><strong>Quick Actions:</strong> Add new expenses or recurring items with a single click.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-md mb-2">ðŸ’¸ Expenses</h4>
                                <p class="mb-2">Log, view, and manage all your individual, one-off expenses.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Add, Edit, Delete:</strong> Use the action buttons to manage each expense. When adding, the app will try to auto-categorize it based on the name.</li>
                                    <li><strong>Filtering:</strong> Use the "Filters" button to narrow down your view by date range, category, or type (including auto-generated recurring expenses).</li>
                                    <li><strong>Bulk Actions:</strong> Use the checkboxes to select multiple expenses and delete them at once.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-md mb-2">ðŸ”„ Recurring</h4>
                                <p class="mb-2">Manage transactions that happen on a regular schedule, like salaries, rent, or subscriptions.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Income or Expense:</strong> Recurring items can be set as either income (e.g., salary) or an expense (e.g., Netflix).</li>
                                    <li><strong>Automatic Logging:</strong> The app automatically creates an expense record on the due date for each active recurring item. Recurring income is automatically added to your monthly total.</li>
                                    <li><strong>Pause & Resume:</strong> You can pause a recurring item by setting its status to "cancelled," and resume it by setting it back to "active."</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-md mb-2">ðŸ“Š Insights</h4>
                                <p class="mb-2">Advanced AI-powered analysis of your spending with banking integration and optimization recommendations.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Points Optimization:</strong> Identifies missed credit card rewards opportunities from your imported transactions. Shows potential annual value and recommends optimal cards for different spending categories.</li>
                                    <li><strong>Goal Impact Analysis:</strong> Real-time calculations showing how your spending affects goal completion timelines. Compares current trajectory vs optimized scenarios.</li>
                                    <li><strong>Smart Recommendations:</strong> Actionable tips based on spending patterns, including points optimization, subscription reviews, and budget adjustments.</li>
                                    <li><strong>7-Day Forecast:</strong> Upcoming recurring expenses and their impact on your budget and goals.</li>
                                    <li><strong>Month-End Projection:</strong> Forecasts total spending, savings, and goal progress by month-end.</li>
                                    <li><strong>Your Monthly Story:</strong> Narrative summary highlighting key financial metrics and achievements.</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">ðŸŽ¯ Goals & Real-time Impact Analysis</h3>
                        <ul class="list-disc ml-5 space-y-2">
                            <li><strong>Goal Types:</strong> Choose from 6 goal templates: House Deposit, Emergency Fund, Dream Vacation, Investment Fund, Debt Payoff, or create Custom goals with your own targets.</li>
                            <li><strong>Real-time Timeline Calculations:</strong> See how your current spending patterns affect goal completion dates. Uses smart algorithms to estimate realistic monthly savings capacity.</li>
                            <li><strong>Optimization Impact Display:</strong> Compare "Current Timeline" vs "With Optimization" to see how points optimization and spending changes can accelerate your goals.</li>
                            <li><strong>Smart Savings Estimation:</strong> Goal-specific calculations account for debt payment capacity (20% of available income) and realistic savings rates based on your financial situation.</li>
                            <li><strong>Progress Acceleration Metrics:</strong> See exactly how many days/months faster you can reach goals through optimization strategies.</li>
                            <li><strong>Savings Allocation:</strong> YNAB-style "give every dollar a job" approach with live allocation tracking and unallocated amount calculations.</li>
                            <li><strong>Dynamic Progress Tracking:</strong> Visual progress bars, percentage completion, and real-time updates when transactions are imported or goals are modified.</li>
                            <li><strong>Enhanced Dashboard Integration:</strong> Goal cards show current timeline, optimization potential, and actionable acceleration tips.</li>
                        </ul>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">ðŸ¦ Banking Integration & Transaction Import</h3>
                        <ul class="list-disc ml-5 space-y-2">
                            <li><strong>Connect Bank Accounts:</strong> Use Plaid integration to securely connect your bank accounts. Click "Connect Bank Account" in Settings to start the secure authentication process.</li>
                            <li><strong>Automatic Transaction Import:</strong> Import up to 30 days of recent transactions with automatic categorization based on merchant names and spending patterns.</li>
                            <li><strong>Duplicate Prevention:</strong> Smart deduplication ensures imported transactions don't conflict with manually entered expenses.</li>
                            <li><strong>Points Optimization Analysis:</strong> Imported transactions are automatically analyzed for credit card rewards optimization opportunities.</li>
                            <li><strong>Real-time Goal Impact:</strong> New transactions immediately update goal timeline calculations and optimization recommendations.</li>
                            <li><strong>Security:</strong> Bank connections use Plaid's bank-grade security. No banking credentials are stored in the app - only secure access tokens are used.</li>
                        </ul>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">ðŸ’³ Points Optimization Calculations</h3>
                        <div class="space-y-3">
                            <p><strong>Credit Card Rewards Database:</strong></p>
                            <ul class="list-disc ml-5 space-y-1 text-xs">
                                <li>Amex Gold: 4x points on Food & Drink, 1x on other categories</li>
                                <li>Amex Green: 3x points on Transport, 1x on other categories</li>
                                <li>Virgin Red: 3x points on Shopping, 2x on Transport, 1x on others</li>
                            </ul>
                            <p><strong>Point Value Estimates (Conservative):</strong></p>
                            <ul class="list-disc ml-5 space-y-1 text-xs">
                                <li>Amex Points: Â£0.005 per point</li>
                                <li>Virgin Points: Â£0.01 per point</li>
                                <li>ANA Miles: Â£0.012 per mile</li>
                            </ul>
                            <p><strong>Optimization Formula:</strong></p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded text-xs font-mono">
                                potentialValue = transactionAmount Ã— pointRate Ã— pointValue<br>
                                annualSavings = monthlyMissedValue Ã— 12<br>
                                Example: Â£100 at Tesco with Amex Gold = Â£100 Ã— 4 Ã— 0.005 = Â£2.00
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">ðŸ“ˆ Goal Timeline Calculations</h3>
                        <div class="space-y-3">
                            <p><strong>Debt Payoff Goals:</strong></p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded text-xs font-mono">
                                availableIncome = max(0, monthlyIncome - monthlyBudget)<br>
                                paymentCapacity = availableIncome Ã— 0.2  // 20% allocation<br>
                                monthlyPayment = max(Â£50, paymentCapacity)<br>
                                monthsToCompletion = remainingDebt Ã· monthlyPayment
                            </div>
                            <p><strong>Savings Goals (House, Emergency, etc.):</strong></p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded text-xs font-mono">
                                surplus = max(0, monthlyIncome - monthlySpending)<br>
                                monthlySavings = max(Â£50, min(surplus Ã— 0.5, monthlyIncome Ã— 0.1))<br>
                                monthsToGoal = remainingAmount Ã· monthlySavings
                            </div>
                            <p><strong>Optimization Impact:</strong></p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded text-xs font-mono">
                                optimizedSavings = baseSavings + monthlyPointsValue<br>
                                optimizedTimeline = remainingAmount Ã· optimizedSavings<br>
                                timeSaved = originalTimeline - optimizedTimeline
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">âš™ï¸ Settings & Data Management</h3>
                         <ul class="list-disc ml-5 space-y-2">
                            <li><strong>Banking Setup:</strong> Connect bank accounts via Plaid for automatic transaction import. Backend server handles secure token exchange.</li>
                            <li><strong>Currency & Theme:</strong> Change your display currency and switch between light and dark modes.</li>
                            <li><strong>Data Management:</strong> Export complete financial data as JSON backup. Import data to restore previous state.</li>
                            <li><strong>Privacy:</strong> All personal data stored <strong>only in browser localStorage</strong>. Banking integration uses secure tokens without storing credentials. Clear browser data will erase records - export regularly.</li>
                            <li><strong>Backend Integration:</strong> Banking features require the backend server (Node.js/Express) running on localhost:8000 with proper Plaid API credentials.</li>
                        </ul>
                    </section>
                </div>
            </div>
            <div class="flex justify-center p-4">
                <button onclick="closeHelpModal()" class="modern-button modern-button-primary w-56">Close</button>
            </div>
        </div>
    </div>

    <!-- Income Breakdown Modal -->
    <div id="income-modal" onclick="closeIncomeModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-sm w-full">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold">Income Breakdown</h3>
                <button onclick="closeIncomeModal()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            <div id="income-breakdown-content" class="p-6 space-y-3 text-sm">
                <!-- Dynamic content will be generated here by JavaScript -->
            </div>
            <div class="flex justify-center p-4">
                <button onclick="closeIncomeModal()" class="modern-button modern-button-primary w-56">Close</button>
            </div>
        </div>
    </div>

    <!-- Goals Modal -->
<div id="goals-modal" onclick="closeGoalsModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
    <div onclick="event.stopPropagation()" class="card max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold">Your Goals</h3>
            <button onclick="closeGoalsModal()" class="icon-button text-2xl leading-none">&times;</button>
        </div>
        <div id="goals-content" class="p-6">
            <!-- Goals will be populated here -->
        </div>
        <div class="flex justify-center p-4">
            <button onclick="editGoals()" class="modern-button modern-button-secondary mr-3">Edit Goals</button>
            <button onclick="closeGoalsModal()" class="modern-button modern-button-primary">Close</button>
        </div>
    </div>
</div>

<!-- Goal Editing Modal -->
<div id="goal-editing-modal" onclick="closeGoalEditingModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
    <div onclick="event.stopPropagation()" class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto relative">
        <!-- Confirmation Overlay (within goal editing modal) -->
        <div id="goal-confirmation-overlay" class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-10 hidden">
            <div class="card max-w-md w-full">
                <div class="p-6 text-center">
                    <div class="text-4xl mb-4" id="confirmation-icon">âš ï¸</div>
                    <h3 class="text-lg font-semibold mb-2" id="confirmation-title">Confirm Action</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6" id="confirmation-message">Are you sure you want to proceed?</p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="cancelConfirmation()" class="modern-button modern-button-secondary px-6">Cancel</button>
                        <button id="confirmation-button" onclick="confirmAction()" class="modern-button px-6">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold">Edit Your Goals</h3>
            <button onclick="closeGoalEditingModal()" class="icon-button text-2xl leading-none">&times;</button>
        </div>
        <div id="goal-editing-content" class="p-6">
            <!-- Goal editing interface will be populated here -->
        </div>
        <div class="flex justify-between p-4 border-t border-gray-200 dark:border-gray-700">
            <button onclick="addNewGoal()" class="modern-button modern-button-secondary" data-tour="add-new-goal">Add New Goal</button>
            <div class="space-x-3">
                <button onclick="closeGoalEditingModal()" class="modern-button modern-button-secondary">Cancel</button>
                <button onclick="saveGoalEdits()" class="modern-button modern-button-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>


    <!-- Clean Modern Onboarding Modal -->
<div id="clean-onboarding-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-2 sm:p-4 z-50 hidden fade-in">
    <div class="onboarding-modal w-full">
        <!-- Progress Bar -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-600">
            <div class="progress-bar mb-2">
                <div id="clean-progress-fill" class="progress-fill" style="width: 20%"></div>
            </div>
            <div class="text-center text-sm text-gray-600 dark:text-gray-400">
                <span id="clean-step-indicator">Step 1 of 5</span>
            </div>
        </div>

        <!-- Step 1: Income & Budget -->
        <div id="clean-step-1" class="clean-onboarding-step p-6">
            <h2 class="text-xl font-semibold mb-2 text-center">Welcome to Lens</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Let's start with your monthly finances</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Monthly Income</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">Â£</span>
                        <input type="number" id="clean-income-input" placeholder="3,500" class="modern-input pl-6 pr-4 font-semibold">
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">Your monthly income after tax</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Monthly Spending</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">Â£</span>
                        <input type="number" id="clean-budget-input" placeholder="2,800" class="modern-input pl-6 pr-4 font-semibold">
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">How much you spend each month on bills, food, etc.</div>
                </div>
            </div>
        </div>

        <!-- Step 2: Goal Selection -->
        <div id="clean-step-2" class="clean-onboarding-step p-6 hidden">
            <h2 class="text-xl font-semibold mb-2 text-center">What's Your Main Goal?</h2>
            <p class="text-gray-600 dark:text-gray-400 text-center mb-6">Choose your primary financial focus</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="house">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">ðŸ </div>
                        <h3 class="font-medium text-sm sm:text-base">House Deposit</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="emergency">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">ðŸ’°</div>
                        <h3 class="font-medium text-sm sm:text-base">Emergency Fund</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="debt">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">ðŸ’³</div>
                        <h3 class="font-medium text-sm sm:text-base">Pay Off Debt</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="vacation">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">âœˆï¸</div>
                        <h3 class="font-medium text-sm sm:text-base">Vacation</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="investment">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">ðŸ“ˆ</div>
                        <h3 class="font-medium text-sm sm:text-base">Investing</h3>
                    </div>
                </div>
                
                <div class="clean-goal-option p-4 sm:p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-all" data-goal="custom">
                    <div class="flex items-center gap-2">
                        <div class="text-2xl">ðŸŽ¯</div>
                        <h3 class="font-medium text-sm sm:text-base">Custom Goal</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Complete Goal Planning (MERGED 3A+3B+3C) -->
        <div id="clean-step-3" class="clean-onboarding-step p-6 hidden">
            <div id="clean-complete-goal-content">
                <!-- Will be populated by prepareCompleteGoalPlanning() -->
            </div>
        </div>

        <!-- Step 4: Financial Position & Debt (MERGED debt + savings) -->
        <div id="clean-step-4" class="clean-onboarding-step p-6 hidden">
            <div id="clean-financial-position-content">
                <!-- Will be populated by prepareFinancialPosition() -->
            </div>
        </div>

        <!-- Step 5: Goal Activation (ENHANCED) -->
        <div id="clean-step-5" class="clean-onboarding-step p-6 hidden">
            <div id="clean-goal-activation-content">
                <!-- Will be populated by prepareGoalActivation() -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-between items-center p-6 border-t border-gray-200 dark:border-gray-600">
            <button id="clean-back-btn" onclick="goCleanBack()" class="modern-button modern-button-secondary min-w-[120px] sm:min-w-[140px]">â† Back</button>
            <div class="flex gap-3">
                <button onclick="skipOnboarding()" class="modern-button modern-button-outline min-w-[120px] sm:min-w-[140px]">Skip Setup</button>
                <button id="clean-next-btn" onclick="goCleanNext()" class="modern-button modern-button-primary min-w-[120px] sm:min-w-[140px]">Next â†’</button>
            </div>
        </div>
    </div>
</div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <script>
        // --- State Variables ---
        let expenses = [];
        let recurringItems = [];
        let selectedExpenseIds = new Set();
        let selectedRecurringIds = new Set();
        let editingExpense = null;
        let editingRecurring = null;
        let monthlyBudget = 2000.00;
        let monthlyIncome = 0;
        let monthlyExpenses = 0;
        let totalSavings = 0;
        let totalDebt = 0;
        let healthScoreHistory = {};
        
        // Pagination variables (global scope)
        window.expensesCurrentPage = 1;
        window.expensesItemsPerPage = 5; // Start with 5 to test pagination
        window.recurringCurrentPage = 1;
        window.recurringItemsPerPage = 15;
        let currencyConfig = {
            'AUD': { symbol: 'A$', locale: 'en-AU' },
            'CAD': { symbol: 'C$', locale: 'en-CA' },
            'EUR': { symbol: 'â‚¬', locale: 'de-DE' },
            'GBP': { symbol: 'Â£', locale: 'en-GB' },
            'JPY': { symbol: 'Â¥', locale: 'ja-JP' },
            'USD': { symbol: '$', locale: 'en-US' }
        };
        let currentCurrencyCode = 'GBP';
        let activeTab = 'overview';
        let spendingTrendChart = null;
        let categorySpendingChart = null;
        let monthlySavingsChart = null;
        let aiSavingsCache = null;
        let aiSpendingCache = null;
        let lastAiUpdate = 0;
        // === GOAL SYSTEM ===
let userGoals = [];
let goalTemplates = {
    'savings_builder': {
        name: 'Savings Builder',
        icon: 'ðŸ’°',
        description: 'Focus on building your savings and emergency fund',
        goals: [
            { type: 'savings_rate', name: 'Save 20% of income', target: 20, unit: 'percent' },
            { type: 'emergency_fund', name: 'Build Â£1000 emergency fund', target: 1000, unit: 'currency' },
            { type: 'no_spend_days', name: '6 no-spend days per month', target: 6, unit: 'days' }
        ]
    },
    'spending_controller': {
        name: 'Spending Controller', 
        icon: 'ðŸ“‰',
        description: 'Take control of your spending habits',
        goals: [
            { type: 'category_limit', name: 'Dining out limit', target: 80, unit: 'currency', category: 'Food/Drink' },
            { type: 'impulse_limit', name: 'No purchases over Â£40', target: 40, unit: 'currency' },
            { type: 'subscription_review', name: 'Review subscriptions monthly', target: 1, unit: 'boolean' }
        ]
    },
    'mindful_spender': {
        name: 'Mindful Spender',
        icon: 'ðŸŽ¯', 
        description: 'Develop healthy spending habits',
        goals: [
            { type: 'coffee_budget', name: 'Coffee budget Â£25/month', target: 25, unit: 'currency', category: 'Food/Drink', keywords: ['coffee'] },
            { type: 'cook_home', name: 'Cook at home 20 days/month', target: 20, unit: 'days' },
            { type: 'no_spend_days', name: '8 no-spend days per month', target: 8, unit: 'days' }
        ]
    },
    'debt_fighter': {
        name: 'Debt Fighter',
        icon: 'âš”ï¸',
        description: 'Aggressive debt reduction and spending cuts',
        goals: [
            { type: 'total_spending_limit', name: 'Total spending under budget by 15%', target: 15, unit: 'percent' },
            { type: 'entertainment_limit', name: 'Entertainment under Â£50', target: 50, unit: 'currency', category: 'Entertainment' },
            { type: 'no_spend_days', name: '10 no-spend days per month', target: 10, unit: 'days' }
        ]
    }
};

        function stripISO(dateStr) {
            return (dateStr || '').split('T')[0];
        }

        const expenseCategories = ["Housing", "Utilities", "Transport", "Food/Drink", "Entertainment", "Shopping", "Health", "Personal Care", "Education", "Debt", "Subscriptions", "Other"];
        const incomeCategories = ["Salary", "Bonus", "Investment", "Gift", "Other Income"];

        // Keyword mapping for auto-categorization and essential status
        const categoryKeywords = {
            'Housing': ['rent', 'mortgage', 'property tax', 'home insurance'],
            'Utilities': ['gas', 'electricity', 'water', 'internet', 'phone', 'council tax'],
            'Transport': ['fuel', 'petrol', 'diesel', 'train', 'bus', 'tube', 'taxi', 'uber'],
            'Food/Drink': ['coffee', 'lunch', 'groceries', 'supermarket', 'restaurant', 'takeaway'],
            'Entertainment': ['cinema', 'concert', 'theatre', 'streaming', 'netflix', 'spotify', 'disney+'],
            'Shopping': ['clothes', 'electronics', 'gifts', 'amazon'],
            'Health': ['pharmacy', 'doctor', 'dentist', 'gym'],
            'Personal Care': ['haircut', 'toiletries'],
            'Education': ['books', 'course', 'tuition'],
            'Debt': ['loan', 'credit card'],
            'Subscriptions': ['subscription']
        };

        const essentialKeywords = [
            'rent', 'mortgage', 'property tax', 'home insurance', 'gas', 'electricity', 
            'water', 'internet', 'phone', 'council tax', 'fuel', 'petrol', 'diesel', 'train', 
            'bus', 'tube', 'groceries', 'supermarket', 'pharmacy', 'doctor', 'dentist', 
            'loan', 'credit card', 'tuition'
        ];

        // --- DOM Elements Cache ---
        let DOMElements = {};

        function cacheDOMElements() {
            DOMElements = {
            html: document.documentElement,
            // Modals & Forms
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            expenseName: document.getElementById('expense-name'),
            expenseCost: document.getElementById('expense-cost'),
            expenseType: document.getElementById('expense-type'),
            expenseCategory: document.getElementById('expense-category'),
            expenseDate: document.getElementById('expense-date'),
            expensePaymentMethod: document.getElementById('expense-payment-method'),
            modalCurrency: document.getElementById('modal-currency'),
            
            recurringModal: document.getElementById('recurring-modal'),
            recurringModalTitle: document.getElementById('recurring-modal-title'),
            recurringItemType: document.getElementById('recurring-item-type'),
            recurringName: document.getElementById('recurring-name'),
            recurringAmount: document.getElementById('recurring-amount'),
            recurringFrequency: document.getElementById('recurring-frequency'),
            recurringCategory: document.getElementById('recurring-category'),
            recurringEssentialTypeWrapper: document.getElementById('recurring-essential-type-wrapper'),
            recurringEssentialType: document.getElementById('recurring-essential-type'),
            recurringPaymentMethod: document.getElementById('recurring-payment-method'),
            recurringStartDate: document.getElementById('recurring-start-date'),
            recurringEndDate: document.getElementById('recurring-end-date'),
            recurringModalCurrency: document.getElementById('recurring-modal-currency'),

            monthlyBudgetDisplay: document.getElementById('monthly-budget'),
            budgetInput: document.getElementById('budget-input'),
            incomeInput: document.getElementById('income-input'),
            totalExpensesDisplay: document.getElementById('total-expenses'),
            remainingAmountDisplay: document.getElementById('remaining-amount'),
            totalIncomeDisplay: document.getElementById('total-income'),
            budgetBar: document.getElementById('budget-bar'),
            budgetPercentage: document.getElementById('budget-percentage'),
            healthScoreFill: document.getElementById('health-score-fill'),
            healthScoreValue: document.getElementById('health-score-value'),
            healthScoreLabel: document.getElementById('health-score-label'),
            essentialSpendingDisplay: document.getElementById('essential-spending'),
            nonEssentialSpendingDisplay: document.getElementById('non-essential-spending'),
            essentialBar: document.getElementById('essential-bar'),
            nonEssentialBar: document.getElementById('non-essential-bar'),
            recentExpensesContainer: document.getElementById('recent-expenses'),
            expensesTableBody: document.getElementById('expenses-table'),
            recurringTableBody: document.getElementById('recurring-table'),
            themeToggle: document.getElementById('theme-toggle'),
            currencySelect: document.getElementById('currency-select'),
            toast: document.getElementById('toast'),
            
            spendingTrendCanvas: document.getElementById('spending-trend-chart'),
            categorySpendingCanvas: document.getElementById('category-spending-chart'),
            monthlySavingsCanvas: document.getElementById('monthly-savings-chart'),
            spendingInsightsContainer: document.getElementById('spending-insights'),
            aiSavingsInsightsContainer: document.getElementById('ai-savings-insights'),

            selectAllExpensesCheckbox: document.getElementById('select-all-expenses'),
            deleteSelectedBtn: document.getElementById('delete-selected-btn'),
            selectAllRecurringCheckbox: document.getElementById('select-all-recurring'),
            deleteSelectedRecurringBtn: document.getElementById('delete-selected-recurring-btn'),
            
            // New Health Score Elements
            healthScoreVisual: document.getElementById('health-score-visual'),
            healthScoreTrend: document.getElementById('health-score-trend'),
            healthScoreTooltip: document.getElementById('health-score-tooltip'),
            aiProjectionContainer: document.getElementById('ai-projection-container'),
            };
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            cacheDOMElements();
            loadData();
            processRecurringExpenses();
            populateCategoryDropdowns();
            applyTheme();
            updateCurrencyUI();
            updateDisplay();
            showTab(activeTab);
            DOMElements.expenseDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];

            // Add event listener for auto-categorization
            DOMElements.expenseName.addEventListener('input', autoCategorizeExpense);
            DOMElements.recurringName.addEventListener('input', autoCategorizeExpense);
            
            startOnboardingProcess();
        });

        // --- Recurring Expense Processing ---
        function processRecurringExpenses() {
            let newExpensesGenerated = 0;
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            recurringItems.forEach(item => {
                if (item.status !== 'active' || item.type !== 'expense') {
                return;
            }

                const itemStartDate = new Date(item.startDate + 'T00:00:00');
                if (itemStartDate > today) return;

                let currentDate = new Date(itemStartDate);
                const itemEndDate = item.endDate ? new Date(item.endDate + 'T00:00:00') : today;

                let iterations = 0;
                while (currentDate <= itemEndDate && currentDate <= today && iterations < 1000) {
                    // Fix: Use local date string to avoid timezone issues
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    
                    const instanceId = `auto-${item.id}-${dateStr}`;
                    
                    if (!expenses.some(e => e.id === instanceId)) {
                        expenses.push({
                            id: instanceId,
                            name: item.name,
                            cost: item.amount,
                            type: item.essentialType || 'Non-Essential',
                            category: item.category,
                            date: dateStr,
                            paymentMethod: item.paymentMethod,
                            status: 'active',
                            recurringSourceId: item.id
                        });
                        newExpensesGenerated++;
                    }

                    // Get next date
                    switch (item.frequency) {
                        case 'Daily': currentDate.setDate(currentDate.getDate() + 1); break;
                        case 'Weekly': currentDate.setDate(currentDate.getDate() + 7); break;
                        case 'Bi-Weekly': currentDate.setDate(currentDate.getDate() + 14); break;
                        case 'Monthly': currentDate.setMonth(currentDate.getMonth() + 1); break;
                        case 'Quarterly': currentDate.setMonth(currentDate.getMonth() + 3); break;
                        case 'Annual': currentDate.setFullYear(currentDate.getFullYear() + 1); break;
                        default: iterations = 1000; break;
                    }
                    iterations++;
                }
            });

            if (newExpensesGenerated > 0) {
                sortExpenses();
                showToast(`${newExpensesGenerated} new recurring expense(s) have been added.`, 'info');
                saveData();
            }
        }

        // --- Expense Sorting ---
        function sortExpenses() {
            expenses.sort((a, b) => {
                // First sort by date (newest first)
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                // For same dates, sort by ID (newest first)
                // Handle both string and numeric IDs
                const getNumericId = (id) => {
                    if (typeof id === 'string') {
                        // Extract numeric part from auto-generated IDs
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return id;
                };
                
                return getNumericId(b.id) - getNumericId(a.id);
            });
            }

        // --- Onboarding ---
        function startOnboardingProcess() {
            const firstVisit = localStorage.getItem('onboardingComplete') !== 'true';
            if (firstVisit) {
                document.getElementById('clean-onboarding-modal').classList.remove('hidden');
                updateCleanOnboardingStep();
            }
        }

        // === NEW CLEAN ONBOARDING SYSTEM ===
let cleanOnboardingData = {
    currentStep: 1,
    totalSteps: 5, // Consolidated to 5 logical steps
    data: {
        monthlyIncome: 0,
        monthlyBudget: 0,
        primaryGoal: null,
        goalDetails: {},
        debts: [],
        totalSavings: 0,
        monthlyExpenses: 0
    }
};

function goCleanNext() {
    console.log('goCleanNext called, current step:', cleanOnboardingData.currentStep);
    
    // Save current step data before validation
    saveCurrentStepData();
    
    // Validate this step; stop if errors
    if (!validateCleanStep()) {
        console.log('Validation failed for step:', cleanOnboardingData.currentStep);
        return;
    }

    console.log('Validation passed, moving to next step');
    
    // Move to next step
    cleanOnboardingData.currentStep++;

    // If we've gone past the last step, complete onboarding
    if (cleanOnboardingData.currentStep > cleanOnboardingData.totalSteps) {
        finishCleanOnboarding();
    } else {
        updateCleanOnboardingStep();
    }
}

function goCleanBack() {
    if (cleanOnboardingData.currentStep > 1) {
        // Save current step data before going back
        saveCurrentStepData();
        
        // Move to previous step
        cleanOnboardingData.currentStep--;
        updateCleanOnboardingStep();
    }
}

function updateCleanOnboardingStep() {
    try {
        // Validate current step is within bounds
        if (cleanOnboardingData.currentStep < 1 || cleanOnboardingData.currentStep > cleanOnboardingData.totalSteps) {
            console.error('Invalid step:', cleanOnboardingData.currentStep);
            cleanOnboardingData.currentStep = Math.max(1, Math.min(cleanOnboardingData.currentStep, cleanOnboardingData.totalSteps));
        }
        
        // Hide all steps
        document.querySelectorAll('.clean-onboarding-step').forEach(step => {
            step.classList.add('hidden');
        });
        
        // Show current step
        const currentStepElement = document.getElementById(`clean-step-${cleanOnboardingData.currentStep}`);
        if (currentStepElement) {
            currentStepElement.classList.remove('hidden');
        } else {
            console.error('Step element not found:', `clean-step-${cleanOnboardingData.currentStep}`);
            return;
        }
        
        // Update progress
        const progress = (cleanOnboardingData.currentStep / cleanOnboardingData.totalSteps) * 100;
        const progressBar = document.getElementById('clean-progress-fill');
        const stepIndicator = document.getElementById('clean-step-indicator');
        
        if (progressBar) progressBar.style.width = `${progress}%`;
        
        // Create user-friendly step labels
        const stepLabels = {
            1: 'Income & Budget',
            2: 'Choose Goal',
            3: 'Goal Planning',
            4: 'Financial Position',
            5: 'Goal Activation'
        };
        
        const stepLabel = stepLabels[cleanOnboardingData.currentStep] || `Step ${cleanOnboardingData.currentStep}`;
        if (stepIndicator) stepIndicator.textContent = `Step ${cleanOnboardingData.currentStep} of ${cleanOnboardingData.totalSteps}: ${stepLabel}`;
        
        // Update navigation
        const backBtn = document.getElementById('clean-back-btn');
        const nextBtn = document.getElementById('clean-next-btn');
        
        if (backBtn) backBtn.style.visibility = cleanOnboardingData.currentStep === 1 ? 'hidden' : 'visible';
        if (nextBtn) nextBtn.textContent = cleanOnboardingData.currentStep === cleanOnboardingData.totalSteps ? 'Activate My Goal' : 'Next â†’';
        
        // Prepare step-specific content
        if (cleanOnboardingData.currentStep === 3) {
            prepareCompleteGoalPlanning(); // Step 3: Complete Goal Planning (merged)
            setTimeout(() => restoreCurrentStepData(), 150);
        } else if (cleanOnboardingData.currentStep === 4) {
            prepareFinancialPosition(); // Step 4: Financial Position & Debt
            setTimeout(() => restoreCurrentStepData(), 150);
        } else if (cleanOnboardingData.currentStep === 5) {
            prepareGoalActivation(); // Step 5: Goal Activation
            restoreCurrentStepData();
        } else {
            // Restore form data for current step
            restoreCurrentStepData();
        }
    } catch (error) {
        console.error('Error updating onboarding step:', error);
        showToast('Error updating onboarding step. Please refresh and try again.', 'error');
    }
}

function validateCleanStep() {
    const data = cleanOnboardingData.data;
    
    switch(cleanOnboardingData.currentStep) {
        case 1:
            const income = parseFloat(document.getElementById('clean-income-input').value);
            const budget = parseFloat(document.getElementById('clean-budget-input').value);
            if (!income || !budget || income <= 0 || budget <= 0) {
                showToast('Please enter valid income and budget amounts', 'error');
                return false;
            }
            if (budget >= income) {
                showToast('Your budget should be less than your income to allow for savings', 'error');
                return false;
            }
            data.monthlyIncome = income;
            data.monthlyBudget = budget;
            return true;
            
        case 2:
            console.log('Validating step 2, primaryGoal:', data.primaryGoal);
            if (!data.primaryGoal) {
                showToast('Please select a primary goal', 'error');
                return false;
            }
            console.log('Step 2 validation passed');
            return true;
            
        case 3:
            // Step 3: Complete Goal Planning validation
            // Special handling for debt goals
            if (data.primaryGoal === 'debt') {
                console.log('=== DEBT VALIDATION START ===');
                console.log('Current data.debts before collection:', data.debts);
                
                // Collect debt data from the form before validation
                const debtItems = document.querySelectorAll('.debt-entry-item');
                console.log('Found debt items:', debtItems.length);
                
                const debts = [];
                
                debtItems.forEach((item, index) => {
                    const name = item.querySelector('.debt-name').value || '';
                    const balance = parseFloat(item.querySelector('.debt-balance').value) || 0;
                    const interest = parseFloat(item.querySelector('.debt-interest').value) || 0;
                    
                    console.log(`Debt item ${index + 1}:`, { name, balance, interest });
                    
                    if (balance > 0) {
                        debts.push({ name: name || 'Debt', balance, interest });
                    }
                });
                
                console.log('Collected debts from form:', debts);
                
                // Update the data object with collected debts
                data.debts = debts;
                console.log('Updated data.debts:', data.debts);
                
                // Validate that at least one debt is entered
                if (!debts || debts.length === 0) {
                    console.error('VALIDATION FAILED: No debts found');
                    showToast('Please add at least one debt to continue', 'error');
                    return false;
                }
                
                // Validate strategy is selected
                const strategy = document.getElementById('debt-strategy')?.value;
                console.log('Selected strategy:', strategy);
                if (!strategy) {
                    console.error('VALIDATION FAILED: No strategy selected');
                    showToast('Please select a payoff strategy from the dropdown', 'error');
                    return false;
                }
                
                // Save debt-specific data
                data.goalDetails['debt-strategy'] = strategy;
                const extraPayment = parseFloat(document.getElementById('debt-extra-payment-slider')?.value) || 0;
                data.goalDetails['debt-extra-payment'] = extraPayment;
                const totalDebt = debts.reduce((sum, debt) => sum + debt.balance, 0);
                data.goalDetails.target = totalDebt;
                data.goalDetails.current = 0; // Start with 0 paid off
                data.goalDetails.monthlyCommitment = extraPayment;
                
                console.log('DEBT VALIDATION PASSED:', {
                    debts: debts,
                    strategy: strategy,
                    extraPayment: extraPayment,
                    totalDebt: totalDebt
                });
                console.log('=== DEBT VALIDATION END ===');
                return true;
            }
            
            // Regular goal validation
            const targetInput = document.getElementById('goal-target');
            const slider = document.getElementById('monthly-commitment-slider');
            
            if (!targetInput) {
                showToast('Please enter your goal target amount', 'error');
                return false;
            }
            
            const target = parseFloat(targetInput.value) || 0;
            
            if (target <= 0) {
                showToast('Please enter a target amount for your goal', 'error');
                return false;
            }
            
            if (!slider) {
                showToast('Please set a monthly commitment amount', 'error');
                return false;
            }
            
            const monthlyCommitment = parseFloat(slider.value) || 0;
            
            if (monthlyCommitment <= 0) {
                showToast('Please set a monthly commitment amount using the slider', 'error');
                return false;
            }
            
            return true;
            
        case 4:
            // Step 4: Financial Position & Debt validation
            const savings = parseFloat(document.getElementById('clean-total-savings-input')?.value) || 0;
            data.totalSavings = savings;
            
            // Validate that goal allocation doesn't exceed total savings
            const goalAllocation = data.goalDetails.current || 0;
            if (goalAllocation > savings) {
                showToast(`Your goal allocation (Â£${goalAllocation.toLocaleString()}) cannot exceed your total savings (Â£${savings.toLocaleString()})`, 'error');
                return false;
            }
            
            // Use monthly budget as monthly expenses since we simplified the questions
            data.monthlyExpenses = data.monthlyBudget;
            return true;
            
        default:
            return true;
    }
}

function finishCleanOnboarding() {
    try {
        const data = cleanOnboardingData.data;
        
        // Update main app variables with safe defaults
        monthlyIncome = data.monthlyIncome || 0;
        monthlyBudget = data.monthlyBudget || 0;
        monthlyExpenses = data.monthlyExpenses || data.monthlyBudget || 0;
        totalSavings = data.totalSavings || 0;
        totalDebt = (data.debts || []).reduce((sum, debt) => sum + debt.balance, 0);
    
    // Create real goals
    userGoals = [];
    console.log('Creating goals for primaryGoal:', data.primaryGoal);
    
    if (data.primaryGoal === 'house') {
        userGoals.push({
            id: Date.now(),
            type: 'house_deposit',
            name: 'House Deposit',
            target: data.goalDetails['house-target'] || 0,
            currentProgress: data.goalDetails['house-current'] || 0,
            unit: 'currency',
            timeline: data.goalDetails['house-timeline'],
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    if (data.primaryGoal === 'emergency') {
        const months = parseInt(data.goalDetails['emergency-months']?.charAt(0)) || 6;
        const userTarget = data.goalDetails['emergency-target'] || (data.monthlyExpenses * months);
        console.log('Emergency fund creation:', {
            savedTarget: data.goalDetails['emergency-target'],
            calculatedTarget: data.monthlyExpenses * months,
            finalTarget: userTarget,
            months: months,
            monthlyExpenses: data.monthlyExpenses
        });
        userGoals.push({
            id: Date.now() + 1,
            type: 'emergency_fund',
            name: `${months}-Month Emergency Fund`,
            target: userTarget,
            currentProgress: data.goalDetails['emergency-current'] || 0,
            unit: 'currency',
            months: months,
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    if (data.primaryGoal === 'vacation') {
        userGoals.push({
            id: Date.now() + 2,
            type: 'vacation',
            name: data.goalDetails['vacation-name'] || 'Dream Vacation',
            target: data.goalDetails['vacation-cost'] || 0,
            currentProgress: data.goalDetails['vacation-current'] || 0,
            unit: 'currency',
            timeline: data.goalDetails['vacation-timeline'],
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    if (data.primaryGoal === 'investment') {
        userGoals.push({
            id: Date.now() + 3,
            type: 'investment',
            name: 'Investment Goal',
            target: data.goalDetails['investment-target'] || 0,
            currentProgress: data.goalDetails['investment-current'] || 0,
            unit: 'currency',
            timeline: data.goalDetails['investment-timeline'],
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    if (data.primaryGoal === 'debt') {
        console.log('Creating debt goal with data.debts:', data.debts);
        const totalDebt = (data.debts || []).reduce((sum, debt) => sum + debt.balance, 0);
        console.log('Calculated totalDebt:', totalDebt);
        
        if (totalDebt === 0) {
            console.error('ERROR: Total debt is 0! data.debts:', data.debts);
            showToast('Error: No debt data found. Please go back and add your debts.', 'error');
            return;
        }
        
        userGoals.push({
            id: Date.now() + 4,
            type: 'debt_payoff',
            name: 'Debt Payoff',
            target: totalDebt, // Use calculated total debt
            currentProgress: 0, // Start with 0 paid off
            unit: 'currency',
            timeline: data.goalDetails['debt-timeline'] || '',
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString(),
            // Add debt-specific properties
            strategy: data.goalDetails['debt-strategy'] || '',
            extraPayment: data.goalDetails['debt-extra-payment'] || 0,
            debts: data.debts || []
        });
        console.log('Created debt goal:', userGoals[userGoals.length - 1]);
    }
    
    if (data.primaryGoal === 'custom') {
        userGoals.push({
            id: Date.now() + 5,
            type: 'custom',
            name: data.goalDetails['custom-name'] || 'Custom Goal',
            target: data.goalDetails['custom-target'] || 0,
            currentProgress: data.goalDetails['custom-current'] || 0,
            unit: 'currency',
            timeline: data.goalDetails['custom-timeline'],
            status: 'active',
            priority: 'primary',
            createdAt: new Date().toISOString()
        });
    }
    
    console.log('Goals created:', userGoals.length, userGoals);
    console.log('Data details:', {
        primaryGoal: data.primaryGoal,
        goalDetails: data.goalDetails,
        totalSavings: data.totalSavings,
        totalDebt: totalDebt
    });
    
    // Add debts as recurring items
    data.debts.forEach(debt => {
        recurringItems.push({
            id: Date.now() + Math.random(),
            type: 'expense',
            name: `${debt.name} Payment`,
            amount: Math.max(debt.balance * 0.02, 25),
            frequency: 'Monthly',
            category: 'Debt',
            essentialType: 'Essential',
            startDate: new Date().toISOString().split('T')[0],
            status: 'active',
            debtBalance: debt.balance,
            debtInterest: debt.interest
        });
    });
    
    // Save everything
    console.log('About to save data, userGoals:', userGoals);
    saveData();
    console.log('Data saved. Checking localStorage...');
    const savedData = JSON.parse(localStorage.getItem('lensAppData') || '{}');
    console.log('Saved userGoals:', savedData.userGoals);
    localStorage.setItem('onboardingComplete', 'true');
    localStorage.setItem('cleanOnboardingData', JSON.stringify(data));
    
        // Close modal and update display
        const modal = document.getElementById('clean-onboarding-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        updateDisplay();
        
        showToast('Welcome to Lens! Your personalized financial tracker is ready.', 'success');
        
        // Start tour
        setTimeout(() => {
            if (localStorage.getItem('tourComplete') !== 'true') {
                launchOnboardingTour();
            }
        }, 1000);
        
    } catch (error) {
        console.error('Error finishing onboarding:', error);
        // Fallback: just close the modal
        const modal = document.getElementById('clean-onboarding-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        showToast('Setup completed with some issues. You can continue using the app.', 'warning');
    }
}

// === FIXES FOR THE 4 ERRORS ===

// 1. ADD missing prepareCleanGoalDetails function
function prepareCleanGoalDetails() {
    const container = document.getElementById('clean-goal-details-content');
    const goal = cleanOnboardingData.data.primaryGoal;
    
    const configs = {
        house: {
            title: 'ðŸ  House Deposit Goal',
            subtitle: 'Tell us about your house purchase plan',
            fields: [
                { id: 'house-target', label: 'Target Deposit Amount', placeholder: '50,000', type: 'currency' },
                { id: 'house-timeline', label: 'Purchase Timeline', type: 'select', options: ['1 year', '2 years', '3 years', '4 years', '5+ years'] },
                { id: 'house-current', label: 'Current House Deposit Savings', placeholder: '5,000', type: 'currency', help: 'Money you\'ve already saved specifically for the house deposit (part of your total savings)' }
            ]
        },
        emergency: {
            title: 'ðŸ’° Emergency Fund Goal',
            subtitle: 'Build your financial safety net',
            fields: [
                { id: 'emergency-months', label: 'Target Coverage', type: 'select', options: ['3 months expenses', '4 months expenses', '5 months expenses', '6 months expenses', '12 months expenses'] },
                { id: 'emergency-current', label: 'Current Emergency Fund Allocation', placeholder: '1,000', type: 'currency', help: 'How much of your total savings is specifically allocated to emergency fund (this should be part of your total savings amount)' }
            ]
        },
        debt: {
            title: 'ðŸ’³ Debt Payoff Strategy',
            subtitle: 'Choose your debt elimination approach',
            fields: [
                { id: 'debt-strategy', label: 'Payoff Strategy', type: 'select', options: ['Avalanche (highest interest first)', 'Snowball (smallest balance first)', 'Equal payments'] }
            ]
        },
        vacation: {
            title: 'âœˆï¸ Vacation Goal',
            subtitle: 'Plan your dream trip',
            fields: [
                { id: 'vacation-cost', label: 'Total Trip Cost', placeholder: '3,000', type: 'currency' },
                { id: 'vacation-when', label: 'When do you want to go?', type: 'select', options: ['6 months', '1 year', '18 months', '2 years'] },
                { id: 'vacation-current', label: 'Current Vacation Savings', placeholder: '500', type: 'currency', help: 'Money already saved for vacation (part of your total savings)' }
            ]
        },
        investment: {
            title: 'ðŸ“ˆ Investment Goal',
            subtitle: 'Build your investment portfolio',
            fields: [
                { id: 'investment-target', label: 'Investment Target', placeholder: '10,000', type: 'currency' },
                { id: 'investment-timeline', label: 'Timeline', type: 'select', options: ['1 year', '3 years', '5 years', '10+ years'] },
                { id: 'investment-current', label: 'Current Investment Savings', placeholder: '1,000', type: 'currency', help: 'Money already set aside for investing (part of your total savings)' }
            ]
        },
        custom: {
            title: 'ðŸŽ¯ Custom Goal',
            subtitle: 'Set your own financial target',
            fields: [
                { id: 'custom-name', label: 'Goal Name', placeholder: 'My Financial Goal', type: 'text' },
                { id: 'custom-target', label: 'Target Amount', placeholder: '5,000', type: 'currency' },
                { id: 'custom-timeline', label: 'Timeline', type: 'select', options: ['6 months', '1 year', '2 years', '3 years', '5+ years'] },
                { id: 'custom-current', label: 'Current Progress', placeholder: '0', type: 'currency', help: 'Money already saved toward this goal' }
            ]
        }
    };
    
    const config = configs[goal];
    if (!config) return;
    
    container.innerHTML = `
        <h2 class="text-xl font-semibold mb-2 text-center">${config.title}</h2>
        <p class="text-gray-600 dark:text-gray-400 text-center mb-6">${config.subtitle}</p>
        
        <div class="space-y-4">
            ${config.fields.map(field => {
                if (field.type === 'select') {
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${field.label}</label>
                            <select id="${field.id}" class="modern-select font-medium">
                                <option value="">Select...</option>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                            ${field.help ? `<div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">${field.help}</div>` : ''}
                        </div>
                    `;
                } else if (field.type === 'currency') {
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${field.label}</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">Â£</span>
                                <input type="number" id="${field.id}" placeholder="${field.placeholder}" class="modern-input pl-8 text-center font-semibold">
                            </div>
                            ${field.help ? `<div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">${field.help}</div>` : ''}
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">${field.label}</label>
                            <input type="${field.type}" id="${field.id}" placeholder="${field.placeholder}" class="modern-input text-center font-medium">
                            ${field.help ? `<div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">${field.help}</div>` : ''}
                        </div>
                    `;
                }
            }).join('')}
        </div>
    `;
}

function prepareGoalCommitment() {
    const container = document.getElementById('clean-goal-commitment-content');
    const goal = cleanOnboardingData.data.primaryGoal;
    const data = cleanOnboardingData.data;
    
    // Calculate available surplus
    const surplus = data.monthlyIncome - data.monthlyBudget;
    
    if (surplus <= 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">âš ï¸</div>
                <h2 class="text-xl font-semibold mb-4 text-red-600">Budget Alert</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Your budget exceeds your income. You'll need to adjust your budget before setting financial goals.</p>
                <button onclick="goCleanBack()" class="modern-button modern-button-primary">Go Back & Adjust Budget</button>
            </div>
        `;
        return;
    }
    
    const goalConfigs = {
        house: { 
            icon: 'ðŸ ', 
            title: 'House Deposit Plan',
            subtitle: 'Let\'s create your monthly savings plan',
            targetPlaceholder: '50,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '5,000',
            currentLabel: 'Amount allocated to this goal'
        },
        emergency: { 
            icon: 'ðŸ’°', 
            title: 'Emergency Fund Plan',
            subtitle: 'Build your financial safety net',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        vacation: { 
            icon: 'âœˆï¸', 
            title: 'Vacation Savings Plan',
            subtitle: 'Plan your dream trip',
            targetPlaceholder: '3,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        },
        investment: { 
            icon: 'ðŸ“ˆ', 
            title: 'Investment Plan',
            subtitle: 'Build your investment portfolio',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        custom: { 
            icon: 'ðŸŽ¯', 
            title: 'Custom Goal Plan',
            subtitle: 'Achieve your financial target',
            targetPlaceholder: '5,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        },
        debt: { 
            icon: 'ðŸ’³', 
            title: 'Debt Payoff Plan',
            subtitle: 'Eliminate your debt strategically',
            targetPlaceholder: '15,000',
            targetLabel: 'Total Debt Amount',
            currentPlaceholder: '0',
            currentLabel: 'Already Paid Off'
        }
    };
    
    const config = goalConfigs[goal] || goalConfigs.custom;
    
    // Special handling for debt payoff goals
    if (goal === 'debt') {
        container.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">${config.icon}</div>
                <h2 class="text-xl font-semibold mb-2">${config.title}</h2>
                <p class="text-gray-600 dark:text-gray-400">${config.subtitle}</p>
            </div>
            
            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 mb-6">
                <div class="text-center">
                    <div class="text-sm text-red-600 dark:text-red-400 font-medium">Total Debt to Pay Off</div>
                    <div class="text-2xl font-bold text-red-700 dark:text-red-300">Â£${totalDebt.toLocaleString()}</div>
                    <div class="text-xs text-red-500 dark:text-red-400">From ${data.debts.length} debt(s) you entered</div>
                </div>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-3">Payoff Strategy <span class="text-gray-500">(Required - Select from dropdown)</span></label>
                    <div class="relative">
                        <select id="debt-strategy" class="modern-input appearance-none pr-10 cursor-pointer" onchange="updateDebtCalculations()">
                            <option value="">ðŸ”½ Choose your payoff strategy...</option>
                            <option value="Avalanche (highest interest first)">ðŸ”ï¸ Avalanche - Pay highest interest first</option>
                            <option value="Snowball (smallest balance first)">â›„ Snowball - Pay smallest balance first</option>
                            <option value="Equal payments">âš–ï¸ Equal Payments - Split evenly</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">Choose the strategy that motivates you most</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-3">Extra Monthly Payment</label>
                    <div class="space-y-3">
                        <input type="range" id="debt-extra-payment-slider" 
                               min="0" max="${surplus}" step="25" value="0"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                               onchange="updateDebtCalculations()" oninput="updateDebtCalculations()">
                        
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                            <span>Â£0/month extra</span>
                            <span>Â£${surplus.toLocaleString()}/month extra</span>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-lg font-semibold">Extra Payment: <span id="debt-extra-amount">Â£0</span>/month</div>
                        </div>
                    </div>
                </div>
                
                <div id="debt-timeline-display" class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800 hidden">
                    <h4 class="font-medium mb-3 text-blue-700 dark:text-blue-300">Payoff Timeline</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Minimum Payments:</span>
                            <span id="debt-min-payments" class="font-mono text-blue-600 dark:text-blue-400">Â£0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Total Monthly Payment:</span>
                            <span id="debt-total-payment" class="font-mono text-blue-600 dark:text-blue-400">Â£0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Debt-Free Timeline:</span>
                            <span id="debt-timeline-months" class="font-mono text-green-600 dark:text-green-400">0 months</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Initialize debt calculations
        updateDebtCalculations();
        return;
    }
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">${config.icon}</div>
            <h2 class="text-xl font-semibold mb-2">${config.title}</h2>
            <p class="text-gray-600 dark:text-gray-400">${config.subtitle}</p>
        </div>
        
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-6">
            <div class="text-center">
                <div class="text-sm text-blue-600 dark:text-blue-400 font-medium">Monthly Surplus Available</div>
                <div class="text-2xl font-bold text-blue-700 dark:text-blue-300">Â£${surplus.toLocaleString()}</div>
                <div class="text-xs text-blue-500 dark:text-blue-400">Income - Budget = Available for goals</div>
            </div>
        </div>
        
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">${config.targetLabel}</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">Â£</span>
                        <input type="number" id="goal-target" placeholder="${config.targetPlaceholder}" 
                               class="modern-input pl-6 pr-4 font-semibold" 
                               onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">${config.currentLabel}</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">Â£</span>
                        <input type="number" id="goal-current" placeholder="${config.currentPlaceholder}" 
                               class="modern-input pl-6 pr-4 font-semibold" 
                               onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-3">Monthly Commitment</label>
                <div class="space-y-3">
                    <input type="range" id="monthly-commitment-slider" 
                           min="0" max="${surplus}" step="50" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                           onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                    
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                        <span>Â£0/month</span>
                        <span>Â£${surplus.toLocaleString()}/month</span>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-lg font-bold" id="commitment-amount">Â£0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">per month toward your goal</div>
                    </div>
                </div>
            </div>
            
            <div id="timeline-display" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 hidden">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-medium">Your Plan Timeline</span>
                    <span id="timeline-months" class="text-lg font-bold text-purple-600"></span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                    <div id="timeline-progress" class="bg-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                    <span id="timeline-current">Â£0 (current)</span>
                    <span id="timeline-target">Â£0 (target)</span>
                </div>
            </div>
            
            <div id="commitment-options" class="space-y-3 hidden">
                <h4 class="font-medium">Quick Commitment Options:</h4>
                <div class="grid grid-cols-2 gap-3" id="commitment-buttons">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <div id="commitment-warning" class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-4 hidden">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700 dark:text-yellow-300" id="warning-text"></p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Initialize calculations
    setTimeout(() => {
        updateCommitmentCalculations();
        generateCommitmentOptions();
    }, 100);
}

// Step 3: Complete Goal Planning (MERGED 3A+3B+3C)
function prepareCompleteGoalPlanning() {
    const container = document.getElementById('clean-complete-goal-content');
    const goal = cleanOnboardingData.data.primaryGoal;
    const data = cleanOnboardingData.data;
    
    // Calculate available surplus
    const surplus = data.monthlyIncome - data.monthlyBudget;
    
    if (surplus <= 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">âš ï¸</div>
                <h2 class="text-xl font-semibold mb-4 text-red-600">Budget Alert</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Your budget exceeds your income. You'll need to adjust your budget before setting financial goals.</p>
                <button onclick="goCleanBack()" class="modern-button modern-button-primary">Go Back & Adjust Budget</button>
            </div>
        `;
        return;
    }
    
    // Special handling for debt payoff goals
    if (goal === 'debt') {
        const totalDebt = (data.debts || []).reduce((sum, debt) => sum + debt.balance, 0);
        container.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">ðŸ’³</div>
                <h2 class="text-xl font-semibold mb-2">Debt Payoff Plan</h2>
                <p class="text-gray-600 dark:text-gray-400">Add your debts and choose your payoff strategy</p>
            </div>
            
            <!-- Debt Entry Section -->
            <div class="card p-4 mb-6">
                <h3 class="font-medium mb-4">Your Debts</h3>
                <div id="debt-entry-list" class="space-y-3 mb-4"></div>
                <button onclick="addDebtEntry()" class="modern-button modern-button-secondary w-full">+ Add Debt</button>
            </div>
            
            <div id="debt-summary-section" class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 mb-6 ${totalDebt === 0 ? 'hidden' : ''}">
                <div class="text-center">
                    <div class="text-sm text-red-600 dark:text-red-400 font-medium">Total Debt to Pay Off</div>
                    <div class="text-2xl font-bold text-red-700 dark:text-red-300" id="total-debt-display">Â£${totalDebt.toLocaleString()}</div>
                    <div class="text-xs text-red-500 dark:text-red-400" id="debt-count-display">From ${(data.debts || []).length} debt(s) you entered</div>
                </div>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-3">Payoff Strategy <span class="text-gray-500">(Required - Select from dropdown)</span></label>
                    <div class="relative">
                        <select id="debt-strategy" class="modern-input appearance-none pr-10 cursor-pointer" onchange="updateDebtCalculations()">
                            <option value="">ðŸ”½ Choose your payoff strategy...</option>
                            <option value="Avalanche (highest interest first)">ðŸ”ï¸ Avalanche - Pay highest interest first</option>
                            <option value="Snowball (smallest balance first)">â›„ Snowball - Pay smallest balance first</option>
                            <option value="Equal payments">âš–ï¸ Equal Payments - Split evenly</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">Choose the strategy that motivates you most</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-3">Extra Monthly Payment</label>
                    <div class="space-y-3">
                        <input type="range" id="debt-extra-payment-slider" 
                               min="0" max="${surplus}" step="25" value="0"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                               onchange="updateDebtCalculations()" oninput="updateDebtCalculations()">
                        
                        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                            <span>Â£0/month extra</span>
                            <span>Â£${surplus.toLocaleString()}/month extra</span>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-lg font-semibold">Extra Payment: <span id="debt-extra-amount">Â£0</span>/month</div>
                        </div>
                    </div>
                </div>
                
                <div id="debt-timeline-display" class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800 hidden">
                    <h4 class="font-medium mb-3 text-blue-700 dark:text-blue-300">Payoff Timeline</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Minimum Payments:</span>
                            <span id="debt-min-payments" class="font-mono text-blue-600 dark:text-blue-400">Â£0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Total Monthly Payment:</span>
                            <span id="debt-total-payment" class="font-mono text-blue-600 dark:text-blue-400">Â£0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                            <span>Debt-Free Timeline:</span>
                            <span id="debt-timeline-months" class="font-mono text-green-600 dark:text-green-400">0 months</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Initialize debt calculations and restore existing debts
        setTimeout(() => {
            const debtList = document.getElementById('debt-entry-list');
            if (debtList && data.debts && data.debts.length > 0) {
                // Restore existing debts
                data.debts.forEach(debt => {
                    addDebtEntry();
                    const lastItem = debtList.lastElementChild;
                    if (lastItem) {
                        lastItem.querySelector('.debt-name').value = debt.name || '';
                        lastItem.querySelector('.debt-balance').value = debt.balance || '';
                        lastItem.querySelector('.debt-interest').value = debt.interest || '';
                    }
                });
                updateDebtSummary();
            } else if (debtList && debtList.children.length === 0) {
                // Auto-add first debt entry if none exist
                addDebtEntry();
            }
            updateDebtCalculations();
        }, 100);
        return;
    }
    
    const goalConfigs = {
        house: { 
            icon: 'ðŸ ', 
            title: 'House Deposit Plan',
            subtitle: 'Complete your house deposit planning',
            targetPlaceholder: '50,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '5,000',
            currentLabel: 'Amount allocated to this goal'
        },
        emergency: { 
            icon: 'ðŸ’°', 
            title: 'Emergency Fund Plan',
            subtitle: 'Build your financial safety net',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        vacation: { 
            icon: 'âœˆï¸', 
            title: 'Vacation Savings Plan',
            subtitle: 'Plan your dream trip',
            targetPlaceholder: '3,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        },
        investment: { 
            icon: 'ðŸ“ˆ', 
            title: 'Investment Plan',
            subtitle: 'Build your investment portfolio',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        custom: { 
            icon: 'ðŸŽ¯', 
            title: 'Custom Goal Plan',
            subtitle: 'Achieve your financial target',
            targetPlaceholder: '5,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        }
    };
    
    const config = goalConfigs[goal] || goalConfigs.custom;
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">${config.icon}</div>
            <h2 class="text-xl font-semibold mb-2">${config.title}</h2>
            <p class="text-gray-600 dark:text-gray-400">${config.subtitle}</p>
        </div>
        
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-6">
            <div class="text-center">
                <div class="text-sm text-blue-600 dark:text-blue-400 font-medium">Monthly Surplus Available</div>
                <div class="text-2xl font-bold text-blue-700 dark:text-blue-300">Â£${surplus.toLocaleString()}</div>
                <div class="text-xs text-blue-500 dark:text-blue-400">Income - Budget = Available for goals</div>
            </div>
        </div>
        
        <div class="space-y-6">
            <!-- Goal Details Section -->
            <div class="card p-4">
                <h3 class="font-medium mb-4">Goal Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">${config.targetLabel}</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">Â£</span>
                            <input type="number" id="goal-target" placeholder="${config.targetPlaceholder}" 
                                   class="modern-input pl-8 text-center font-semibold" 
                                   onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">${config.currentLabel}</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">Â£</span>
                            <input type="number" id="goal-current" placeholder="${config.currentPlaceholder}" 
                                   class="modern-input pl-8 text-center font-semibold" 
                                   onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Commitment Section -->
            <div class="card p-4">
                <h3 class="font-medium mb-4">Monthly Commitment</h3>
                <div class="space-y-3">
                    <input type="range" id="monthly-commitment-slider" 
                           min="0" max="${surplus}" step="50" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                           onchange="updateCommitmentCalculations()" oninput="updateCommitmentCalculations()">
                    
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                        <span>Â£0/month</span>
                        <span>Â£${surplus.toLocaleString()}/month</span>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-lg font-semibold">Monthly commitment: <span id="commitment-amount">Â£0</span></div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">per month toward your goal</div>
                    </div>
                </div>
                
                <div id="commitment-options" class="space-y-3 hidden mt-4">
                    <h4 class="font-medium">Quick Commitment Options:</h4>
                    <div class="grid grid-cols-2 gap-3" id="commitment-buttons"></div>
                </div>
            </div>
            
            <!-- Timeline Section -->
            <div id="timeline-display" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 hidden">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-medium">Your Plan Timeline</span>
                    <span id="timeline-months" class="text-lg font-bold text-purple-600"></span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                    <div id="timeline-progress" class="bg-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                    <span id="timeline-current">Â£0 (current)</span>
                    <span id="timeline-target">Â£0 (target)</span>
                </div>
            </div>
            
            <div id="commitment-warning" class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 hidden">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700 dark:text-yellow-300" id="warning-text"></p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Initialize calculations and restore data
    setTimeout(() => {
        // Restore data if it exists
        const data = cleanOnboardingData.data;
        if (data.goalDetails && Object.keys(data.goalDetails).length > 0) {
            const targetInput = document.getElementById('goal-target');
            const currentInput = document.getElementById('goal-current');
            const slider = document.getElementById('monthly-commitment-slider');
            
            if (targetInput && data.goalDetails.target !== undefined) {
                targetInput.value = data.goalDetails.target;
            }
            if (currentInput && data.goalDetails.current !== undefined) {
                currentInput.value = data.goalDetails.current;
            }
            if (slider && data.goalDetails.monthlyCommitment !== undefined) {
                slider.value = data.goalDetails.monthlyCommitment;
            }
            
            // Trigger calculations after restoration to ensure UI updates
            setTimeout(() => {
                updateCommitmentCalculations();
                generateCommitmentOptions();
            }, 50);
        } else {
            // No data to restore, but still initialize the UI
            updateCommitmentCalculations();
            generateCommitmentOptions();
        }
    }, 200);
}

// Legacy function kept for compatibility
function prepareGoalDetails() {
    const container = document.getElementById('clean-goal-details-content');
    const goal = cleanOnboardingData.data.primaryGoal;
    const data = cleanOnboardingData.data;
    
    // Calculate available surplus
    const surplus = data.monthlyIncome - data.monthlyBudget;
    
    if (surplus <= 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">âš ï¸</div>
                <h2 class="text-xl font-semibold mb-4 text-red-600">Budget Alert</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Your budget exceeds your income. You'll need to adjust your budget before setting financial goals.</p>
                <button onclick="goCleanBack()" class="modern-button modern-button-primary">Go Back & Adjust Budget</button>
            </div>
        `;
        return;
    }
    
    const goalConfigs = {
        house: { 
            icon: 'ðŸ ', 
            title: 'House Deposit Plan',
            subtitle: 'Tell us about your house deposit goal',
            targetPlaceholder: '50,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '5,000',
            currentLabel: 'Amount allocated to this goal'
        },
        emergency: { 
            icon: 'ðŸ’°', 
            title: 'Emergency Fund Plan',
            subtitle: 'Set up your financial safety net',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        vacation: { 
            icon: 'âœˆï¸', 
            title: 'Vacation Savings Plan',
            subtitle: 'Plan your dream trip',
            targetPlaceholder: '3,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        },
        investment: { 
            icon: 'ðŸ“ˆ', 
            title: 'Investment Plan',
            subtitle: 'Build your investment portfolio',
            targetPlaceholder: '10,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '1,000',
            currentLabel: 'Amount allocated to this goal'
        },
        custom: { 
            icon: 'ðŸŽ¯', 
            title: 'Custom Goal Plan',
            subtitle: 'Achieve your financial target',
            targetPlaceholder: '5,000',
            targetLabel: 'How much do you need?',
            currentPlaceholder: '500',
            currentLabel: 'Amount allocated to this goal'
        }
    };
    
    const config = goalConfigs[goal] || goalConfigs.custom;
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">${config.icon}</div>
            <h2 class="text-xl font-semibold mb-2">${config.title}</h2>
            <p class="text-gray-600 dark:text-gray-400">${config.subtitle}</p>
        </div>
        
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">${config.targetLabel}</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">Â£</span>
                        <input type="number" id="goal-target" placeholder="${config.targetPlaceholder}" 
                               class="modern-input pl-8 text-center font-semibold">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">${config.currentLabel}</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">Â£</span>
                        <input type="number" id="goal-current" placeholder="${config.currentPlaceholder}" 
                               class="modern-input pl-8 text-center font-semibold">
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Step 4: Financial Position & Debt (CONTEXT-AWARE)
function prepareFinancialPosition() {
    const container = document.getElementById('clean-financial-position-content');
    const data = cleanOnboardingData.data;
    const isDebtGoal = data.primaryGoal === 'debt';
    
    if (isDebtGoal) {
        // Simplified view for debt goals - only savings needed
        container.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">ðŸ’°</div>
                <h2 class="text-xl font-semibold mb-2">Your Current Savings</h2>
                <p class="text-gray-600 dark:text-gray-400">How much do you have saved across all accounts?</p>
            </div>
            
            <div class="space-y-6">
                <!-- Current Savings Section -->
                <div class="card p-4">
                    <h3 class="font-medium mb-4">Total Savings</h3>
                    <div>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">Â£</span>
                            <input type="number" id="clean-total-savings-input" placeholder="2,500" class="modern-input pl-6 pr-4 font-semibold">
                        </div>
                        <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                            Total money you have saved across all accounts (used to calculate your net worth after debt payoff)
                        </div>
                    </div>
                </div>
                
                <!-- Debt Summary (Read-only) -->
                <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
                    <h4 class="font-medium mb-3 text-red-700 dark:text-red-300">Your Debt Summary</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Total Debt:</span>
                            <span class="font-mono text-red-600 dark:text-red-400">Â£${(data.debts || []).reduce((sum, debt) => sum + debt.balance, 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Number of Debts:</span>
                            <span class="font-mono">${(data.debts || []).length}</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-2">
                        âœ“ Debts already configured in previous step
                    </div>
                </div>
            </div>
        `;
    } else {
        // Full view for other goals - savings + optional debts
        container.innerHTML = `
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">ðŸ’°</div>
                <h2 class="text-xl font-semibold mb-2">Your Financial Position</h2>
                <p class="text-gray-600 dark:text-gray-400">Tell us about your current savings and any debts</p>
            </div>
            
            <div class="space-y-6">
                <!-- Current Savings Section -->
                <div class="card p-4">
                    <h3 class="font-medium mb-4">Current Savings</h3>
                    <div>
                        <label class="block text-sm font-medium mb-2">Total Savings</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">Â£</span>
                            <input type="number" id="clean-total-savings-input" placeholder="2,500" class="modern-input pl-6 pr-4 font-semibold">
                        </div>
                        <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                            Total money you have saved across all accounts (your goal allocations will be portions of this total)
                        </div>
                    </div>
                </div>
                
                <!-- Debt Section -->
                <div class="card p-4">
                    <h3 class="font-medium mb-4">Current Debts (Optional)</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Add any debts to get better goal recommendations and progress tracking</p>
                    
                    <div id="clean-debt-list" class="space-y-3 mb-4"></div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="addCleanDebt()" class="modern-button modern-button-secondary w-full">+ Add Debt</button>
                        <button onclick="skipCleanDebts()" class="modern-button modern-button-outline w-full">No Debts</button>
                    </div>
                </div>
            
            <!-- Impact Preview -->
            <div id="financial-impact-preview" class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 hidden">
                <h4 class="font-medium mb-3 text-blue-700 dark:text-blue-300">Financial Impact Preview</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Current Savings:</span>
                        <span id="preview-savings" class="font-mono">Â£0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Debt:</span>
                        <span id="preview-debt" class="font-mono text-red-600">Â£0</span>
                    </div>
                    <div class="flex justify-between font-medium border-t border-blue-200 dark:border-blue-800 pt-2">
                        <span>Net Worth:</span>
                        <span id="preview-net-worth" class="font-mono">Â£0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Estimated Monthly Debt Payments:</span>
                        <span id="preview-debt-payments" class="font-mono">Â£0</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    }
    
    // Add event listener to savings input to update preview (works for both debt and non-debt goals)
    setTimeout(() => {
        const savingsInput = document.getElementById('clean-total-savings-input');
        if (savingsInput) {
            savingsInput.addEventListener('input', updateFinancialPreview);
        }
        updateFinancialPreview();
    }, 100);
}

function updateFinancialPreview() {
    const savingsInput = document.getElementById('clean-total-savings-input');
    const previewDiv = document.getElementById('financial-impact-preview');
    const previewSavings = document.getElementById('preview-savings');
    const previewDebt = document.getElementById('preview-debt');
    const previewNetWorth = document.getElementById('preview-net-worth');
    const previewDebtPayments = document.getElementById('preview-debt-payments');
    
    if (!previewDiv) return;
    
    const savings = savingsInput ? parseFloat(savingsInput.value) || 0 : 0;
    
    // Collect current debt data from form inputs in real-time
    const currentDebts = [];
    document.querySelectorAll('.clean-debt-item').forEach(item => {
        const name = item.querySelector('.debt-name')?.value || '';
        const balance = parseFloat(item.querySelector('.debt-balance')?.value) || 0;
        const interest = parseFloat(item.querySelector('.debt-interest')?.value) || 0;
        
        if (balance > 0) {
            currentDebts.push({ name, balance, interest });
        }
    });
    
    const totalDebt = currentDebts.reduce((sum, debt) => sum + debt.balance, 0);
    const monthlyDebtPayments = currentDebts.reduce((sum, debt) => sum + Math.max(debt.balance * 0.02, 25), 0);
    const netWorth = savings - totalDebt;
    
    if (savings > 0 || totalDebt > 0) {
        previewDiv.classList.remove('hidden');
        
        if (previewSavings) previewSavings.textContent = `Â£${savings.toLocaleString()}`;
        if (previewDebt) previewDebt.textContent = `Â£${totalDebt.toLocaleString()}`;
        if (previewNetWorth) {
            previewNetWorth.textContent = `Â£${netWorth.toLocaleString()}`;
            previewNetWorth.className = `font-mono ${netWorth >= 0 ? 'text-green-600' : 'text-red-600'}`;
        }
        if (previewDebtPayments) previewDebtPayments.textContent = `Â£${monthlyDebtPayments.toLocaleString()}`;
    } else {
        previewDiv.classList.add('hidden');
    }
}

// Step 3C: Timeline & Review  
function prepareGoalReview() {
    const container = document.getElementById('clean-goal-review-content');
    const data = cleanOnboardingData.data;
    const goalDetails = data.goalDetails || {};
    
    const target = goalDetails.target || 0;
    const current = goalDetails.current || 0;
    const monthlyCommitment = goalDetails.monthlyCommitment || 0;
    const remaining = Math.max(target - current, 0);
    const monthsToComplete = monthlyCommitment > 0 ? Math.ceil(remaining / monthlyCommitment) : 0;
    const currentProgress = target > 0 ? (current / target) * 100 : 0;
    
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">ðŸ“Š</div>
            <h2 class="text-xl font-semibold mb-2">Your Goal Timeline</h2>
            <p class="text-gray-600 dark:text-gray-400">Review your plan before proceeding</p>
        </div>
        
        <div class="space-y-6">
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                <h3 class="font-medium mb-3">Goal Summary</h3>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span>Target:</span>
                        <span class="font-mono">Â£${target.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>Current:</span>
                        <span class="font-mono">Â£${current.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>Still needed:</span>
                        <span class="font-mono">Â£${remaining.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>Monthly commitment:</span>
                        <span class="font-mono">Â£${monthlyCommitment.toLocaleString()}</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                <h3 class="font-medium mb-3 text-blue-700 dark:text-blue-300">Timeline Projection</h3>
                <div class="text-center mb-4">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">
                        ${monthsToComplete} months
                    </div>
                    <div class="text-sm text-blue-600 dark:text-blue-400">to reach your goal</div>
                </div>
                
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                    <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${Math.min(currentProgress, 100)}%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                    <span>${currentProgress.toFixed(1)}% complete</span>
                    <span>${target > 0 ? ((target - current) / target * 100).toFixed(1) : 0}% remaining</span>
                </div>
            </div>
            
            ${monthsToComplete > 36 ? `
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700 dark:text-yellow-300">
                                This timeline is quite long. Consider increasing your monthly commitment or adjusting your target to reach your goal sooner.
                            </p>
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// Step 5: Goal Activation (ENHANCED)
// Step 5: Goal Activation (ENHANCED, patched)
function prepareGoalActivation() {
    const container = document.getElementById('clean-goal-activation-content');
    if (!container) return;

    // Build shell first so #clean-summary-content exists
    container.innerHTML = `
        <div class="text-center mb-6">
            <div class="text-4xl mb-3">ðŸš€</div>
            <h2 class="text-xl font-semibold mb-2">Activate Your Goal</h2>
            <p class="text-gray-600 dark:text-gray-400">Your personalized goal tracker is ready to go!</p>
        </div>

        <!-- Plan Summary -->
        <div class="card p-4 mb-6">
            <h3 class="font-medium mb-4">Your Plan Summary</h3>
            <div id="clean-summary-content"></div>
        </div>

        <!-- Next Steps -->
        <div class="card p-4 mb-6">
            <h3 class="font-medium mb-4">What Happens Next</h3>
            <div class="space-y-3">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-xs font-medium text-blue-600 dark:text-blue-400">1</div>
                    <div>
                        <div class="font-medium">Your goal will be activated</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">All goals and budgets will be set up in your account</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-xs font-medium text-blue-600 dark:text-blue-400">2</div>
                    <div>
                        <div class="font-medium">Start tracking expenses</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Log your spending to stay on track with your budget</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-xs font-medium text-blue-600 dark:text-blue-400">3</div>
                    <div>
                        <div class="font-medium">Monitor your progress</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Watch your goals grow and adjust as needed</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Health Preview -->
        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 mb-6">
            <h4 class="font-medium mb-3 text-green-700 dark:text-green-300">Your Financial Health Score</h4>
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="activation-health-score">Calculating...</div>
                    <div class="text-sm text-green-600 dark:text-green-400">Expected score with this plan</div>
                </div>
                <div class="text-4xl">ðŸ“ˆ</div>
            </div>
        </div>

        <!-- Ready to activate -->
        <div class="text-center">
            <div class="text-gray-600 dark:text-gray-400">Click "Activate My Goal" below to complete setup</div>
        </div>
    `;

    // Populate summary and score once container is in DOM
    generateCleanSummary();
    calculateActivationHealthScore();
}

function calculateActivationHealthScore() {
    const data = cleanOnboardingData.data;
    const scoreElement = document.getElementById('activation-health-score');
    
    if (!scoreElement) return;
    
    // Simplified health score calculation
    let score = 50; // Base score
    
    // Income vs Budget ratio
    const surplus = data.monthlyIncome - data.monthlyBudget;
    const surplusRatio = surplus / data.monthlyIncome;
    if (surplusRatio > 0.2) score += 20;
    else if (surplusRatio > 0.1) score += 10;
    else if (surplusRatio < 0) score -= 30;
    
    // Savings to income ratio
    const savingsRatio = data.totalSavings / (data.monthlyIncome * 12);
    if (savingsRatio > 0.5) score += 15;
    else if (savingsRatio > 0.25) score += 10;
    else if (savingsRatio > 0.1) score += 5;
    
    // Debt considerations
    const totalDebt = data.debts.reduce((sum, debt) => sum + debt.balance, 0);
    if (totalDebt === 0) score += 10;
    else if (totalDebt < data.monthlyIncome * 6) score += 5;
    else if (totalDebt > data.monthlyIncome * 12) score -= 15;
    
    // Goal commitment
    if (data.goalDetails.monthlyCommitment > 0) score += 10;
    
    // Cap the score
    score = Math.max(0, Math.min(100, score));
    
    scoreElement.textContent = `${Math.round(score)}/100`;
}

function activateGoal() {
    console.log('activateGoal function called');
    // This function will complete the onboarding
    finishCleanOnboarding();
}

// Ensure function is globally accessible
window.activateGoal = activateGoal;

function activateGoalSafely() {
    try {
        // Validate that we have minimum required data
        const data = cleanOnboardingData.data;
        
        if (!data.monthlyIncome || !data.monthlyBudget || !data.primaryGoal) {
            throw new Error('Missing required data: income, budget, or goal');
        }
        
        // Ensure goalDetails exists
        if (!data.goalDetails) {
            data.goalDetails = {};
        }
        
        // Validate goal-specific data and set defaults if missing
        if (data.primaryGoal === 'house') {
            if (!data.goalDetails['house-target']) {
                data.goalDetails['house-target'] = 50000; // Default house target
            }
            if (!data.goalDetails['house-current']) {
                data.goalDetails['house-current'] = 0;
            }
        } else if (data.primaryGoal === 'emergency') {
            if (!data.goalDetails['emergency-months']) {
                data.goalDetails['emergency-months'] = '6 months expenses';
            }
            if (!data.goalDetails['emergency-current']) {
                data.goalDetails['emergency-current'] = 0;
            }
        } else if (data.primaryGoal === 'vacation') {
            if (!data.goalDetails['vacation-cost']) {
                data.goalDetails['vacation-cost'] = 3000;
            }
            if (!data.goalDetails['vacation-current']) {
                data.goalDetails['vacation-current'] = 0;
            }
        } else if (data.primaryGoal === 'investment') {
            if (!data.goalDetails['investment-target']) {
                data.goalDetails['investment-target'] = 10000;
            }
            if (!data.goalDetails['investment-current']) {
                data.goalDetails['investment-current'] = 0;
            }
        }
        
        // Ensure debts array exists
        if (!data.debts) {
            data.debts = [];
        }
        
        // Ensure savings value exists
        if (!data.totalSavings) {
            data.totalSavings = 0;
        }
        
        console.log('Activating goal with validated data:', data);
        
        // Now call the finish function with validated data
        finishCleanOnboarding();
        
    } catch (error) {
        console.error('Error activating goal:', error);
        showToast('Error setting up your goal. Using default values...', 'warning');
        
        // Set safe defaults and try again
        cleanOnboardingData.data.goalDetails = {
            target: 5000,
            current: 0,
            monthlyCommitment: 250
        };
        cleanOnboardingData.data.debts = cleanOnboardingData.data.debts || [];
        cleanOnboardingData.data.totalSavings = cleanOnboardingData.data.totalSavings || 0;
        
        finishCleanOnboarding();
    }
}

// Skip onboarding function
function skipOnboarding() {
    // Set default values
    cleanOnboardingData.data.monthlyIncome = 3000;
    cleanOnboardingData.data.monthlyBudget = 2500;
    cleanOnboardingData.data.primaryGoal = 'emergency';
    cleanOnboardingData.data.goalDetails = {
        target: 5000,
        current: 0,
        monthlyCommitment: 250
    };
    cleanOnboardingData.data.debts = [];
    cleanOnboardingData.data.totalSavings = 0;
    
    // Complete onboarding with defaults
    finishCleanOnboarding();
}

// 2. ADD missing validateCleanGoalDetails function
function validateCleanGoalDetails() {
    const inputs = document.querySelectorAll('#clean-goal-details-content input, #clean-goal-details-content select');
    let valid = true;
    
    inputs.forEach(input => {
        if (input.type === 'number') {
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0) {
                valid = false;
            } else {
                cleanOnboardingData.data.goalDetails[input.id] = value;
            }
        } else {
            if (!input.value.trim()) {
                valid = false;
            } else {
                cleanOnboardingData.data.goalDetails[input.id] = input.value;
            }
        }
    });
    
    if (!valid) {
        showToast('Please fill in all goal details', 'error');
        return false;
    }
    return true;
}

function updateCommitmentCalculations() {
    const targetInput = document.getElementById('goal-target');
    const currentInput = document.getElementById('goal-current');
    const slider = document.getElementById('monthly-commitment-slider');
    const commitmentAmount = document.getElementById('commitment-amount');
    const timelineDisplay = document.getElementById('timeline-display');
    const timelineMonths = document.getElementById('timeline-months');
    const timelineProgress = document.getElementById('timeline-progress');
    const timelineCurrent = document.getElementById('timeline-current');
    const timelineTarget = document.getElementById('timeline-target');
    const warningDiv = document.getElementById('commitment-warning');
    const warningText = document.getElementById('warning-text');
    
    if (!targetInput || !currentInput || !slider) return;
    
    const target = parseFloat(targetInput.value) || 0;
    const current = parseFloat(currentInput.value) || 0;
    const monthlyCommitment = parseFloat(slider.value) || 0;
    const remaining = Math.max(target - current, 0);
    
    // Update commitment amount display
    if (commitmentAmount) {
        commitmentAmount.textContent = `Â£${monthlyCommitment.toLocaleString()}`;
    }
    
    // Save to onboarding data
    cleanOnboardingData.data.goalDetails = {
        target: target,
        current: current,
        monthlyCommitment: monthlyCommitment
    };
    
    if (target > 0 && monthlyCommitment > 0) {
        // Calculate timeline
        const monthsToComplete = Math.ceil(remaining / monthlyCommitment);
        const currentProgress = current > 0 ? (current / target) * 100 : 0;
        
        // Show timeline
        if (timelineDisplay) timelineDisplay.classList.remove('hidden');
        if (timelineMonths) {
            timelineMonths.textContent = monthsToComplete === 1 ? '1 month' : `${monthsToComplete} months`;
        }
        if (timelineProgress) {
            timelineProgress.style.width = `${Math.min(currentProgress, 100)}%`;
        }
        if (timelineCurrent) {
            timelineCurrent.textContent = `Â£${current.toLocaleString()} (current)`;
        }
        if (timelineTarget) {
            timelineTarget.textContent = `Â£${target.toLocaleString()} (target)`;
        }
        
        // Show warnings if needed
        if (monthsToComplete > 60) {
            warningDiv.classList.remove('hidden');
            warningText.textContent = `At this rate, it will take ${monthsToComplete} months (${Math.round(monthsToComplete/12)} years) to reach your goal. Consider increasing your monthly commitment.`;
        } else if (monthlyCommitment > (cleanOnboardingData.data.monthlyIncome - cleanOnboardingData.data.monthlyBudget) * 0.8) {
            warningDiv.classList.remove('hidden');
            warningText.textContent = 'This commitment uses most of your surplus. Make sure to leave room for other goals and unexpected expenses.';
        } else {
            warningDiv.classList.add('hidden');
        }
    } else {
        if (timelineDisplay) timelineDisplay.classList.add('hidden');
        if (warningDiv) warningDiv.classList.add('hidden');
    }
    
    // Update quick options when calculations change
    generateCommitmentOptions();
}

function generateCommitmentOptions() {
    const targetInput = document.getElementById('goal-target');
    const currentInput = document.getElementById('goal-current');
    const buttonsContainer = document.getElementById('commitment-buttons');
    const optionsDiv = document.getElementById('commitment-options');
    
    if (!targetInput || !currentInput || !buttonsContainer) return;
    
    const target = parseFloat(targetInput.value) || 0;
    const current = parseFloat(currentInput.value) || 0;
    const remaining = Math.max(target - current, 0);
    const surplus = cleanOnboardingData.data.monthlyIncome - cleanOnboardingData.data.monthlyBudget;
    
    if (target > 0 && remaining > 0) {
        optionsDiv.classList.remove('hidden');
        
        // Generate smart commitment options
        const options = [];
        
        // Option 1: Complete in 1 year
        const oneYearAmount = Math.ceil(remaining / 12);
        if (oneYearAmount <= surplus) {
            options.push({ 
                label: 'Complete in 1 Year', 
                amount: oneYearAmount, 
                description: `Â£${oneYearAmount.toLocaleString()}/month` 
            });
        }
        
        // Option 2: Complete in 2 years
        const twoYearAmount = Math.ceil(remaining / 24);
        if (twoYearAmount <= surplus && twoYearAmount !== oneYearAmount) {
            options.push({ 
                label: 'Complete in 2 Years', 
                amount: twoYearAmount, 
                description: `Â£${twoYearAmount.toLocaleString()}/month` 
            });
        }
        
        // Option 3: Use 50% of surplus
        const halfSurplus = Math.floor(surplus * 0.5);
        if (halfSurplus > 0 && !options.some(opt => Math.abs(opt.amount - halfSurplus) < 50)) {
            const months = Math.ceil(remaining / halfSurplus);
            options.push({ 
                label: 'Balanced Approach', 
                amount: halfSurplus, 
                description: `Â£${halfSurplus.toLocaleString()}/month (${months} months)` 
            });
        }
        
        // Option 4: Aggressive (80% of surplus)
        const aggressiveAmount = Math.floor(surplus * 0.8);
        if (aggressiveAmount > halfSurplus && !options.some(opt => Math.abs(opt.amount - aggressiveAmount) < 50)) {
            const months = Math.ceil(remaining / aggressiveAmount);
            options.push({ 
                label: 'Aggressive Plan', 
                amount: aggressiveAmount, 
                description: `Â£${aggressiveAmount.toLocaleString()}/month (${months} months)` 
            });
        }
        
        buttonsContainer.innerHTML = options.slice(0, 4).map(option => `
            <button onclick="setCommitmentAmount(${option.amount})" 
                    class="modern-button modern-button-secondary text-left p-3">
                <div class="font-medium text-sm">${option.label}</div>
                <div class="text-xs text-gray-600 dark:text-gray-400">${option.description}</div>
            </button>
        `).join('');
    } else {
        optionsDiv.classList.add('hidden');
    }
}

function updateDebtCalculations() {
    const slider = document.getElementById('debt-extra-payment-slider');
    const strategySelect = document.getElementById('debt-strategy');
    const extraAmountSpan = document.getElementById('debt-extra-amount');
    const timelineDisplay = document.getElementById('debt-timeline-display');
    const minPaymentsSpan = document.getElementById('debt-min-payments');
    const totalPaymentSpan = document.getElementById('debt-total-payment');
    const timelineMonthsSpan = document.getElementById('debt-timeline-months');
    
    if (!slider || !cleanOnboardingData.data.debts || cleanOnboardingData.data.debts.length === 0) return;
    
    const extraPayment = parseFloat(slider.value) || 0;
    const strategy = strategySelect ? strategySelect.value : 'Avalanche (highest interest first)';
    
    // Calculate minimum payments
    const totalMinPayments = cleanOnboardingData.data.debts.reduce((sum, debt) => 
        sum + Math.max(debt.balance * 0.02, 25), 0);
    const totalPayment = totalMinPayments + extraPayment;
    
    // Update display
    if (extraAmountSpan) extraAmountSpan.textContent = `Â£${extraPayment.toLocaleString()}`;
    if (minPaymentsSpan) minPaymentsSpan.textContent = `Â£${totalMinPayments.toLocaleString()}`;
    if (totalPaymentSpan) totalPaymentSpan.textContent = `Â£${totalPayment.toLocaleString()}`;
    
    // Calculate simplified payoff timeline
    const totalDebt = cleanOnboardingData.data.debts.reduce((sum, debt) => sum + debt.balance, 0);
    const avgInterest = cleanOnboardingData.data.debts.length > 0 ? 
        cleanOnboardingData.data.debts.reduce((sum, debt) => sum + debt.interest, 0) / cleanOnboardingData.data.debts.length : 0;
    
    // Simplified calculation - actual debt payoff is more complex with interest compounding
    const monthsToPayoff = totalPayment > 0 ? Math.ceil(totalDebt / totalPayment) : 0;
    
    if (timelineMonthsSpan) timelineMonthsSpan.textContent = `${monthsToPayoff} months`;
    
    if (timelineDisplay) {
        timelineDisplay.classList.remove('hidden');
    }
    
    // Save debt strategy to goal details
    cleanOnboardingData.data.goalDetails = {
        ...cleanOnboardingData.data.goalDetails,
        'debt-strategy': strategy,
        'debt-extra-payment': extraPayment,
        'debt-total-payment': totalPayment
    };
}

function setCommitmentAmount(amount) {
    const slider = document.getElementById('monthly-commitment-slider');
    if (slider) {
        slider.value = amount;
        updateCommitmentCalculations();
    }
}

// 3. ADD missing debt management functions
function addCleanDebt() {
    const debtList = document.getElementById('clean-debt-list');
    const debtItem = document.createElement('div');
    debtItem.className = 'clean-debt-item';
    debtItem.innerHTML = `
        <div class="space-y-3">
            <input type="text" placeholder="Debt name (e.g., Credit Card)" class="modern-input debt-name text-sm font-medium text-center">
            <div class="grid grid-cols-2 gap-2">
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium text-sm">Â£</span>
                    <input type="number" placeholder="5,000" class="modern-input pl-8 debt-balance text-sm font-semibold text-center" oninput="updateFinancialPreview()">
                </div>
                <input type="number" placeholder="18.9%" step="0.1" class="modern-input debt-interest text-sm font-semibold text-center" oninput="updateFinancialPreview()">
            </div>
            <button onclick="removeCleanDebt(this)" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
        </div>
    `;
    debtList.appendChild(debtItem);
}

// New function for debt entry in goal planning (Step 3)
function addDebtEntry() {
    const debtList = document.getElementById('debt-entry-list');
    if (!debtList) return;
    
    const debtItem = document.createElement('div');
    debtItem.className = 'debt-entry-item border border-gray-200 dark:border-gray-600 rounded-lg p-4';
    debtItem.innerHTML = `
        <div class="space-y-3">
            <input type="text" placeholder="Debt name (e.g., Credit Card)" class="modern-input debt-name text-sm font-medium">
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Balance</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium text-sm">Â£</span>
                        <input type="number" placeholder="5,000" class="modern-input pl-8 debt-balance text-sm font-semibold" oninput="updateDebtSummary()">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Interest Rate (%)</label>
                    <input type="number" placeholder="18.9" step="0.1" class="modern-input debt-interest text-sm font-semibold" oninput="updateDebtSummary()">
                </div>
            </div>
            <button onclick="removeDebtEntry(this)" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
        </div>
    `;
    debtList.appendChild(debtItem);
    
    // Auto-add first debt entry if this is the first one
    if (debtList.children.length === 1) {
        updateDebtSummary();
    }
}

function removeDebtEntry(button) {
    button.closest('.debt-entry-item').remove();
    updateDebtSummary();
}

function updateDebtSummary() {
    const debtItems = document.querySelectorAll('.debt-entry-item');
    let totalDebt = 0;
    const debts = [];
    
    console.log('updateDebtSummary called, found', debtItems.length, 'debt items');
    
    debtItems.forEach((item, index) => {
        const name = item.querySelector('.debt-name').value || '';
        const balance = parseFloat(item.querySelector('.debt-balance').value) || 0;
        const interest = parseFloat(item.querySelector('.debt-interest').value) || 0;
        
        console.log(`Debt ${index + 1}:`, { name, balance, interest });
        
        if (balance > 0) {
            totalDebt += balance;
            debts.push({ name: name || 'Debt', balance, interest });
        }
    });
    
    console.log('Total debts collected:', debts);
    console.log('Total debt amount:', totalDebt);
    
    // Update cleanOnboardingData
    cleanOnboardingData.data.debts = debts;
    console.log('Updated cleanOnboardingData.data.debts:', cleanOnboardingData.data.debts);
    
    // Update UI
    const summarySection = document.getElementById('debt-summary-section');
    const totalDisplay = document.getElementById('total-debt-display');
    const countDisplay = document.getElementById('debt-count-display');
    
    if (summarySection && totalDisplay && countDisplay) {
        if (totalDebt > 0) {
            summarySection.classList.remove('hidden');
            totalDisplay.textContent = `Â£${totalDebt.toLocaleString()}`;
            countDisplay.textContent = `From ${debts.length} debt(s) you entered`;
        } else {
            summarySection.classList.add('hidden');
        }
    }
    
    // Update debt calculations if elements exist
    updateDebtCalculations();
}

function removeCleanDebt(button) {
    button.closest('.clean-debt-item').remove();
    updateFinancialPreview();
}

function skipCleanDebts() {
    cleanOnboardingData.data.debts = [];
    goCleanNext();
}

function collectCleanDebts() {
    const debtItems = document.querySelectorAll('.clean-debt-item');
    const newDebts = [];
    
    // Only clear debts if we find debt items in the DOM
    if (debtItems.length > 0) {
        debtItems.forEach(item => {
            const nameInput = item.querySelector('.debt-name');
            const balanceInput = item.querySelector('.debt-balance');
            const interestInput = item.querySelector('.debt-interest');
            
            if (nameInput && balanceInput && interestInput) {
                const name = nameInput.value || '';
                const balance = parseFloat(balanceInput.value) || 0;
                const interest = parseFloat(interestInput.value) || 0;
                
                // Include debt even if name is empty, as long as balance > 0
                if (balance > 0) {
                    newDebts.push({
                        name: name || 'Unnamed Debt',
                        balance: balance,
                        interest: interest
                    });
                }
            }
        });
        
        // Only update the debts array if we found actual debt items
        cleanOnboardingData.data.debts = newDebts;
        console.log('Collected debts from', debtItems.length, 'items:', cleanOnboardingData.data.debts);
    } else {
        // No debt items found in DOM - preserve existing debt data
        console.log('No debt items found in DOM, preserving existing debts:', cleanOnboardingData.data.debts);
    }
}

// Data persistence functions
function saveCurrentStepData() {
    const step = cleanOnboardingData.currentStep;
    console.log('saveCurrentStepData called for step:', step);
    
    try {
        switch (step) {
            case 1:
                // Save income and budget
                const incomeInput = document.getElementById('clean-income-input');
                const budgetInput = document.getElementById('clean-budget-input');
                if (incomeInput) cleanOnboardingData.data.monthlyIncome = parseFloat(incomeInput.value) || 0;
                if (budgetInput) cleanOnboardingData.data.monthlyBudget = parseFloat(budgetInput.value) || 0;
                break;
                
            case 2:
                // Save selected goal - handled by click event
                break;
                
            case 3:
                // Step 3: Save complete goal planning (target, current, commitment)
                // Ensure goalDetails object exists
                if (!cleanOnboardingData.data.goalDetails) {
                    cleanOnboardingData.data.goalDetails = {};
                }
                const targetInput = document.getElementById('goal-target');
                const currentInput = document.getElementById('goal-current');
                const slider = document.getElementById('monthly-commitment-slider');
                
                // Save both generic and goal-specific field names for compatibility
                const targetValue = parseFloat(targetInput?.value) || 0;
                const currentValue = parseFloat(currentInput?.value) || 0;
                const commitmentValue = parseFloat(slider?.value) || 0;
                
                // Generic field names (for new Step 3 consolidated approach)
                cleanOnboardingData.data.goalDetails.target = targetValue;
                cleanOnboardingData.data.goalDetails.current = currentValue;
                cleanOnboardingData.data.goalDetails.monthlyCommitment = commitmentValue;
                
                // Goal-specific field names (for backward compatibility and summary function)
                const goal = cleanOnboardingData.data.primaryGoal;
                if (goal === 'house') {
                    cleanOnboardingData.data.goalDetails['house-target'] = targetValue;
                    cleanOnboardingData.data.goalDetails['house-current'] = currentValue;
                    cleanOnboardingData.data.goalDetails['house-commitment'] = commitmentValue;
                } else if (goal === 'vacation') {
                    cleanOnboardingData.data.goalDetails['vacation-cost'] = targetValue;
                    cleanOnboardingData.data.goalDetails['vacation-current'] = currentValue;
                    cleanOnboardingData.data.goalDetails['vacation-commitment'] = commitmentValue;
                } else if (goal === 'emergency') {
                    // For emergency funds, save the user's target amount and current allocation
                    cleanOnboardingData.data.goalDetails['emergency-target'] = targetValue;
                    cleanOnboardingData.data.goalDetails['emergency-current'] = currentValue;
                    const months = cleanOnboardingData.data.monthlyExpenses > 0 ? Math.round(targetValue / cleanOnboardingData.data.monthlyExpenses) : 0;
                    cleanOnboardingData.data.goalDetails['emergency-months'] = months;
                    cleanOnboardingData.data.goalDetails['emergency-commitment'] = commitmentValue;
                } else if (goal === 'investment') {
                    cleanOnboardingData.data.goalDetails['investment-target'] = targetValue;
                    cleanOnboardingData.data.goalDetails['investment-current'] = currentValue;
                    cleanOnboardingData.data.goalDetails['investment-commitment'] = commitmentValue;
                } else if (goal === 'custom') {
                    cleanOnboardingData.data.goalDetails['custom-target'] = targetValue;
                    cleanOnboardingData.data.goalDetails['custom-current'] = currentValue;
                    cleanOnboardingData.data.goalDetails['custom-commitment'] = commitmentValue;
                } else if (goal === 'debt') {
                    // For debt goals, collect debt data from Step 3 form
                    const debtItems = document.querySelectorAll('.debt-entry-item');
                    const debts = [];
                    
                    debtItems.forEach(item => {
                        const name = item.querySelector('.debt-name').value || '';
                        const balance = parseFloat(item.querySelector('.debt-balance').value) || 0;
                        const interest = parseFloat(item.querySelector('.debt-interest').value) || 0;
                        
                        if (balance > 0) {
                            debts.push({ name: name || 'Debt', balance, interest });
                        }
                    });
                    
                    cleanOnboardingData.data.debts = debts;
                    console.log('Saved debts in case 3:', debts);
                    
                    // Save strategy and extra payment
                    const strategy = document.getElementById('debt-strategy')?.value || '';
                    const extraPayment = parseFloat(document.getElementById('debt-extra-payment-slider')?.value) || 0;
                    
                    cleanOnboardingData.data.goalDetails['debt-strategy'] = strategy;
                    cleanOnboardingData.data.goalDetails['debt-extra-payment'] = extraPayment;
                    
                    const totalDebt = debts.reduce((sum, debt) => sum + debt.balance, 0);
                    cleanOnboardingData.data.goalDetails.target = totalDebt;
                    cleanOnboardingData.data.goalDetails.current = 0;
                    cleanOnboardingData.data.goalDetails.monthlyCommitment = extraPayment;
                }
                break;
                
            case 4:
                // Step 4: Save financial position and debts - SIMPLE AND DIRECT
                const savingsInput = document.getElementById('clean-total-savings-input');
                if (savingsInput) {
                    cleanOnboardingData.data.totalSavings = parseFloat(savingsInput.value) || 0;
                }
                
                cleanOnboardingData.data.monthlyExpenses = cleanOnboardingData.data.monthlyBudget;
                
                // Save debts directly (but only if not a debt payoff goal - debt goals collect debt data in Step 3)
                if (cleanOnboardingData.data.primaryGoal !== 'debt') {
                    cleanOnboardingData.data.debts = [];
                    document.querySelectorAll('.clean-debt-item').forEach(item => {
                        const name = item.querySelector('.debt-name')?.value || '';
                        const balance = parseFloat(item.querySelector('.debt-balance')?.value) || 0;
                        const interest = parseFloat(item.querySelector('.debt-interest')?.value) || 0;
                    
                        if (balance > 0) {
                            cleanOnboardingData.data.debts.push({
                                name: name || 'Debt',
                                balance: balance,
                                interest: interest
                            });
                        }
                    });
                } else {
                    // For debt payoff goals, preserve existing debt data from Step 3
                    console.log('Step 4: Preserving debt data for debt goal:', cleanOnboardingData.data.debts);
                }
                break;
        }
    } catch (error) {
        console.log('Error saving step data:', error);
    }
}

function restoreCurrentStepData() {
    const step = cleanOnboardingData.currentStep;
    const data = cleanOnboardingData.data;
    
    try {
        switch (step) {
            case 1:
                // Restore income and budget
                const incomeInput = document.getElementById('clean-income-input');
                const budgetInput = document.getElementById('clean-budget-input');
                if (incomeInput && data.monthlyIncome) incomeInput.value = data.monthlyIncome;
                if (budgetInput && data.monthlyBudget) budgetInput.value = data.monthlyBudget;
                break;
                
            case 2:
                // Restore selected goal
                if (data.primaryGoal) {
                    const selectedOption = document.querySelector(`[data-goal="${data.primaryGoal}"]`);
                    if (selectedOption) {
                        document.querySelectorAll('.clean-goal-option').forEach(opt => opt.classList.remove('selected'));
                        selectedOption.classList.add('selected');
                    }
                }
                break;
                
            case 3:
                // Step 3: Restore complete goal planning
                const targetInput = document.getElementById('goal-target');
                const currentInput = document.getElementById('goal-current');
                const slider = document.getElementById('monthly-commitment-slider');
                
                if (data.goalDetails) {
                    if (targetInput && data.goalDetails.target) targetInput.value = data.goalDetails.target;
                    if (currentInput && data.goalDetails.current) currentInput.value = data.goalDetails.current;
                    if (slider && data.goalDetails.monthlyCommitment) {
                        slider.value = data.goalDetails.monthlyCommitment;
                        // Trigger calculations after restoration
                        setTimeout(() => updateCommitmentCalculations(), 100);
                    }
                }
                break;
                
            case 4:
                // Step 4: Restore financial position and debts - SIMPLE AND DIRECT
                setTimeout(() => {
                    // Restore savings
                    const savingsInput = document.getElementById('clean-total-savings-input');
                    if (savingsInput) {
                        savingsInput.value = data.totalSavings || 0;
                    }
                    
                    // Restore debts
                    const debtList = document.getElementById('clean-debt-list');
                    if (debtList && data.debts && data.debts.length > 0) {
                        debtList.innerHTML = '';
                        
                        data.debts.forEach(debt => {
                            addCleanDebt();
                            const lastItem = debtList.lastElementChild;
                            if (lastItem) {
                                const nameInput = lastItem.querySelector('.debt-name');
                                const balanceInput = lastItem.querySelector('.debt-balance');
                                const interestInput = lastItem.querySelector('.debt-interest');
                                
                                if (nameInput) nameInput.value = debt.name || '';
                                if (balanceInput) balanceInput.value = debt.balance || '';
                                if (interestInput) interestInput.value = debt.interest || '';
                            }
                        });
                    }
                    
                    // Update preview
                    updateFinancialPreview();
                }, 300);
                break;
        }
    } catch (error) {
        console.log('Error restoring step data:', error);
    }
}

function restoreDebts() {
    const debtList = document.getElementById('clean-debt-list');
    if (!debtList) {
        console.log('ERROR: Debt list element not found');
        return;
    }
    
    const debts = cleanOnboardingData.data.debts || [];
    console.log('Restoring debts - found', debts.length, 'debts:', debts);
    
    // Clear existing debt items
    debtList.innerHTML = '';
    
    if (debts.length === 0) {
        console.log('No debts to restore');
        return;
    }
    
    // Restore saved debts
    debts.forEach((debt, index) => {
        addCleanDebt();
        const lastDebtItem = debtList.lastElementChild;
        if (lastDebtItem) {
            const nameInput = lastDebtItem.querySelector('.debt-name');
            const balanceInput = lastDebtItem.querySelector('.debt-balance');
            const interestInput = lastDebtItem.querySelector('.debt-interest');
            
            if (nameInput) {
                nameInput.value = debt.name || '';
                console.log(`Restored debt ${index + 1} name:`, debt.name);
            }
            if (balanceInput) {
                balanceInput.value = debt.balance || '';
                console.log(`Restored debt ${index + 1} balance:`, debt.balance);
            }
            if (interestInput) {
                interestInput.value = debt.interest || '';
                console.log(`Restored debt ${index + 1} interest:`, debt.interest);
            }
            
            // Ensure event listeners are working by manually adding them if needed
            if (balanceInput && !balanceInput.hasAttribute('data-listener-added')) {
                balanceInput.addEventListener('input', updateFinancialPreview);
                balanceInput.setAttribute('data-listener-added', 'true');
            }
            if (interestInput && !interestInput.hasAttribute('data-listener-added')) {
                interestInput.addEventListener('input', updateFinancialPreview);
                interestInput.setAttribute('data-listener-added', 'true');
            }
        }
    });
    
    // Trigger financial preview update after debt restoration
    setTimeout(() => {
        updateFinancialPreview();
    }, 50);
}

// 4. ADD missing generateCleanSummary function
function generateCleanSummary() {
    const container = document.getElementById('clean-summary-content');
    const data = cleanOnboardingData.data;
    
    const monthlySurplus = data.monthlyIncome - data.monthlyExpenses;
    const totalDebt = data.debts.reduce((sum, debt) => sum + debt.balance, 0);
    
    // Helper function to get goal-specific values with proper mapping
    function getGoalValues(goalType) {
        const details = data.goalDetails;
        let target = 0, current = 0, monthlyCommitment = 0;
        
        switch (goalType) {
            case 'house':
                target = details['house-target'] || details.target || 0;
                current = details['house-current'] || details.current || 0;
                monthlyCommitment = details['house-commitment'] || details.monthlyCommitment || 0;
                break;
            case 'vacation':
                target = details['vacation-cost'] || details.target || 0;
                current = details['vacation-current'] || details.current || 0;
                monthlyCommitment = details['vacation-commitment'] || details.monthlyCommitment || 0;
                break;
            case 'emergency':
                const months = details['emergency-months'] || 0;
                target = months * data.monthlyExpenses || details.target || 0;
                current = details['emergency-current'] || details.current || 0;
                monthlyCommitment = details['emergency-commitment'] || details.monthlyCommitment || 0;
                break;
            case 'investment':
                target = details['investment-target'] || details.target || 0;
                current = details['investment-current'] || details.current || 0;
                monthlyCommitment = details['investment-commitment'] || details.monthlyCommitment || 0;
                break;
            case 'custom':
                target = details['custom-target'] || details.target || 0;
                current = details['custom-current'] || details.current || 0;
                monthlyCommitment = details['custom-commitment'] || details.monthlyCommitment || 0;
                break;
        }
        
        return { target, current, monthlyCommitment };
    }
    
    let goalSummary = '';
    if (data.primaryGoal === 'house') {
        const { target, current, monthlyCommitment } = getGoalValues('house');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">ðŸ </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">House Deposit Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">Â£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already saved:</span>
                                <span class="highlight-number font-mono">Â£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">Â£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">Â£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'emergency') {
        const { target, current, monthlyCommitment } = getGoalValues('emergency');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        const currentCoverage = data.monthlyExpenses > 0 ? (current / data.monthlyExpenses).toFixed(1) : '0.0';
        const targetCoverage = data.monthlyExpenses > 0 ? (target / data.monthlyExpenses).toFixed(1) : '0.0';
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">ðŸ’°</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Emergency Fund Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">Â£${target.toLocaleString()} (${targetCoverage} months)</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already saved:</span>
                                <span class="highlight-number font-mono">Â£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">Â£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">Â£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Current coverage:</span>
                                <span class="highlight-number font-mono">${currentCoverage} months</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'vacation') {
        const { target, current, monthlyCommitment } = getGoalValues('vacation');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">âœˆï¸</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Vacation Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">Â£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already saved:</span>
                                <span class="highlight-number font-mono">Â£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">Â£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">Â£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'investment') {
        const { target, current, monthlyCommitment } = getGoalValues('investment');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">ðŸ“ˆ</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Investment Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">Â£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already invested:</span>
                                <span class="highlight-number font-mono">Â£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">Â£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">Â£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'custom') {
        const { target, current, monthlyCommitment } = getGoalValues('custom');
        const needed = Math.max(target - current, 0);
        const months = monthlyCommitment > 0 ? Math.ceil(needed / monthlyCommitment) : 0;
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">ðŸŽ¯</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Custom Goal</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Target:</span>
                                <span class="highlight-number font-mono">Â£${target.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Already saved:</span>
                                <span class="highlight-number font-mono">Â£${current.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Still needed:</span>
                                <span class="highlight-number font-mono">Â£${needed.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Monthly commitment:</span>
                                <span class="highlight-number font-mono">Â£${monthlyCommitment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Timeline:</span>
                                <span class="highlight-number font-mono">${months > 0 ? months + ' months' : 'Set commitment'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.primaryGoal === 'debt') {
        // Calculate debt payoff strategy
        const strategy = data.goalDetails['debt-strategy'] || 'Avalanche (highest interest first)';
        const totalMinPayments = data.debts.reduce((sum, debt) => sum + Math.max(debt.balance * 0.02, 25), 0);
        const extraPayment = Math.max(monthlySurplus - 50, 0); // Leave Â£50 buffer
        const totalPayment = totalMinPayments + extraPayment;
        
        // Calculate payoff timeline (simplified calculation)
        const avgInterest = data.debts.length > 0 ? 
            data.debts.reduce((sum, debt) => sum + debt.interest, 0) / data.debts.length : 0;
        const monthsToPayoff = totalDebt > 0 && totalPayment > 0 ? 
            Math.ceil(totalDebt / totalPayment) : 0;
        
        goalSummary = `
            <div class="clean-summary-card">
                <div class="flex gap-2">
                    <div class="text-lg flex-shrink-0">ðŸ’³</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold mb-2">Debt Payoff Plan</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Strategy:</span>
                                <span class="highlight-number font-mono">${strategy.split(' ')[0]}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Total Monthly Payment:</span>
                                <span class="highlight-number font-mono">Â£${totalPayment.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Payoff Timeline:</span>
                                <span class="highlight-number font-mono">${monthsToPayoff} months</span>
                            </div>
                            <div class="flex justify-between items-center text-sm gap-2">
                                <span>Extra Payment:</span>
                                <span class="highlight-number text-green-600 font-mono">+Â£${extraPayment.toLocaleString()}/month</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = `
        <div class="clean-summary-card">
            <div class="flex gap-2">
                <div class="text-lg flex-shrink-0">ðŸ’¡</div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-semibold mb-2">Financial Overview</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span>Monthly Income:</span>
                            <span class="highlight-number font-mono">Â£${data.monthlyIncome.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span>Monthly Surplus:</span>
                            <span class="highlight-number font-mono">Â£${monthlySurplus.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm gap-2">
                            <span>Total Savings:</span>
                            <span class="highlight-number font-mono">Â£${data.totalSavings.toLocaleString()}</span>
                        </div>
                        ${totalDebt > 0 ? `<div class="flex justify-between items-center text-sm gap-2">
                            <span>Total Debt:</span>
                            <span class="highlight-number text-red-600 font-mono">Â£${totalDebt.toLocaleString()}</span>
                        </div>` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        ${goalSummary}
        
        <div class="clean-summary-card">
            <div class="flex gap-2">
                <div class="text-lg flex-shrink-0">ðŸŽ¯</div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-semibold mb-2">What's Next</h3>
                    <ul class="text-sm space-y-1 list-disc list-inside text-gray-600 dark:text-gray-400">
                        <li>Track expenses with real-time goal impact</li>
                        <li>Get personalized spending recommendations</li>
                        <li>Monitor progress toward your ${data.primaryGoal} goal</li>
                        <li>Receive smart financial insights</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
}

// Goal selection handler
document.addEventListener('click', function(e) {
    if (e.target.closest('.clean-goal-option')) {
        e.preventDefault();
        e.stopPropagation();
        
        const option = e.target.closest('.clean-goal-option');
        const goalType = option.getAttribute('data-goal');
        
        // Clear previous selections
        document.querySelectorAll('.clean-goal-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // Select this option
        option.classList.add('selected');
        cleanOnboardingData.data.primaryGoal = goalType;
        
        // Debug logging
        console.log('Goal selected:', goalType, cleanOnboardingData.data.primaryGoal);
        
        // Explicitly prevent any auto-advancement
        return false;
    }
});

        function launchOnboardingTour() {
            const driver = window.driver?.js?.driver;
            if (!driver) {
                console.log('Driver.js not available, skipping tour');
                return;
            }
            
            // Close any open modals before starting tour
            const settingsMenu = document.getElementById('settings-menu');
            if (settingsMenu && !settingsMenu.classList.contains('hidden')) {
                settingsMenu.classList.add('hidden');
            }
            
            const isMobile = window.innerWidth < 768;

            const desktopSteps = [
                {
                    element: '[data-tour="app-header"]',
                    popover: { title: 'Welcome to Lens! ðŸ‘‹', description: "Your personal finance tracker is ready. Let's take a quick tour to get you started with tracking expenses and achieving your financial goals.", side: "bottom", align: 'start' }
                },
                {
                    element: '[data-tour="budget-button"]',
                    popover: { title: 'Set Your Budget & Income ðŸ’°', description: 'Start here! Set your monthly income and budget - this creates the foundation for all your financial tracking and goal planning.', side: "top", align: 'center' }
                },
                {
                    element: '[data-tour="goals-section"]',
                    popover: { 
                        title: 'Financial Goals Hub ðŸŽ¯', 
                        description: 'This is where the magic happens! Click here to set up financial goals like saving for a house, vacation, emergency fund, or paying off debt. Track your progress and stay motivated.',
                        side: "top", 
                        align: 'center'
                    }
                },
                {
                    element: '[data-tour="add-expense"]',
                    popover: { title: 'Track Your Expenses ðŸ“', description: 'Log your daily expenses here. Every purchase, bill, and cost should be tracked to see where your money goes and stay on budget.', side: "left", align: 'start' }
                },
                {
                    element: null,
                    popover: { 
                        title: 'You\'re All Set! ðŸŽ‰', 
                        description: 'You now know the basics: set your budget, create goals, and track expenses. Start with small goals and build the habit of logging expenses daily. Your financial future starts now!',
                        onDeselected: () => {
                            closeGoalsModal(); // Close goals modal when tour ends
                        }
                    }
                }
            ];

            const mobileSteps = [
                {
                    element: '[data-tour="app-header"]',
                    popover: { title: 'Welcome to Lens! ðŸ‘‹', description: "Your personal finance tracker is ready. Let's take a quick mobile tour to get you started.", side: "bottom", align: 'start' }
                },
                {
                    element: '[data-tour="goals-section"]',
                    popover: { 
                        title: 'Set Financial Goals ðŸŽ¯', 
                        description: 'Tap here to create goals like saving for vacation, emergency fund, house deposit, or debt payoff. Track your progress and stay motivated!',
                        side: "top", 
                        align: 'center',
                        onNextClick: () => {
                            openGoalsModal();
                        }
                    }
                },
                {
                    element: '[data-tour="first-goal"]',
                    popover: { title: 'Add Your First Goal ðŸš€', description: 'Start here! Choose from goal templates or create a custom financial target. Set amount, timeline, and track progress.', side: "bottom", align: 'center' }
                },
                {
                    element: '[data-tour="add-expense"]',
                    popover: { title: 'Track Expenses ðŸ“±', description: 'Tap here to log expenses. Quick and easy - just enter amount, category, and description to track your spending.', side: "top", align: 'center' }
                },
                {
                    element: null,
                    popover: { 
                        title: 'Ready to Go! ðŸŽ‰', 
                        description: 'You\'re all set! Start by creating a goal, then track your expenses daily. Small steps lead to big financial wins!',
                        onDeselected: () => {
                            closeGoalsModal();
                        }
                    }
                }
            ];

            const driverObj = driver({
                showProgress: true,
                popoverClass: 'driver-popover',
                steps: isMobile ? mobileSteps : desktopSteps,
                onDestroyed: () => {
                    localStorage.setItem('tourComplete', 'true');
                },
                onDeselected: (element, step, options) => {
                    // Only mark complete if user reaches the last step
                    const totalSteps = isMobile ? mobileSteps.length : desktopSteps.length;
                    if (step.index === totalSteps - 1) {
                        localStorage.setItem('tourComplete', 'true');
                    }
                }
            });

            driverObj.drive();
        }

        function restartTour() {
            // Close settings modal first
            closeSettings();
            
            localStorage.removeItem('tourComplete');
            
            // Add slight delay to ensure modal closes
            setTimeout(() => {
                launchOnboardingTour();
            }, 300);
        }

        // Enhanced goal-focused tour for first-time users
        function launchGoalTour() {
            // Close settings modal first
            closeSettings();
            
            // Add slight delay to ensure modal closes
            setTimeout(() => {
                const driver = window.driver?.js?.driver;
                if (!driver) return;
            
            // Check if user has existing goals to determine tour path
            const hasGoals = userGoals && userGoals.length > 0;
            
            const goalSteps = [
                {
                    element: '[data-tour="goals-section"]',
                    popover: { 
                        title: 'Goal Setting Made Easy ðŸŽ¯', 
                        description: hasGoals ? 'Let\'s explore your goal management system! Here you can see your goal progress and make adjustments.' : 'Let\'s set up your first financial goal! This is the key to staying motivated and tracking progress.',
                        side: "top",
                        onNextClick: () => showGoalEditingInterface()
                    }
                },
                {
                    element: hasGoals ? '[data-tour="add-new-goal"]' : '[data-tour="first-goal"]',
                    popover: { 
                        title: hasGoals ? 'Add More Goals ðŸš€' : 'Choose Your Goal Type ðŸš€', 
                        description: hasGoals ? 'You can add additional goals here. Choose from popular templates like house deposit, vacation fund, emergency savings, or create your own custom goal.' : 'Select from popular templates like house deposit, vacation fund, emergency savings, or create your own custom goal.',
                        side: "bottom"
                    }
                }
            ];

            const goalDriver = driver({
                showProgress: true,
                popoverClass: 'driver-popover',
                steps: goalSteps,
                onDestroyed: () => closeGoalEditingModal()
            });

            goalDriver.drive();
            }, 300);
        }

        // === GOAL SYSTEM FUNCTIONS ===

function renderGoalTemplates() {
    const container = document.getElementById('goal-templates-container');
    container.innerHTML = Object.entries(goalTemplates).map(([key, template]) => `
        <div onclick="selectGoalTemplate('${key}')" class="p-6 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
            <div class="text-center">
                <div class="text-4xl mb-3">${template.icon}</div>
                <h4 class="text-lg font-semibold mb-2">${template.name}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${template.description}</p>
                <div class="text-xs text-left space-y-1">
                    ${template.goals.map(goal => `
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                            <span>${goal.name}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');
}


function removeGoal(index) {
    const goalElement = document.querySelector(`#goals-list > div:nth-child(${index + 1})`);
    if (goalElement) {
        goalElement.remove();
    }
}


// === GOAL PROGRESS TRACKING ===

function calculateGoalProgress() {
    if (!userGoals || userGoals.length === 0) return;
    
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    userGoals.forEach(goal => {
        // Skip automatic calculation for manually edited goals
        if (goal.manuallyEdited) return;
        
        switch(goal.type) {
            case 'savings_rate':
                goal.currentProgress = calculateSavingsRateProgress(currentMonth, currentYear);
                break;
            case 'category_limit':
            case 'coffee_budget':
                goal.currentProgress = calculateCategorySpendingProgress(goal, currentMonth, currentYear);
                break;
            case 'no_spend_days':
                goal.currentProgress = calculateNoSpendDaysProgress(currentMonth, currentYear);
                break;
            case 'cook_home':
                goal.currentProgress = calculateCookHomeProgress(currentMonth, currentYear);
                break;
            case 'total_spending_limit':
                goal.currentProgress = calculateTotalSpendingProgress(goal, currentMonth, currentYear);
                break;
            case 'impulse_limit':
                goal.currentProgress = calculateImpulseLimitProgress(goal, currentMonth, currentYear);
                break;
            case 'emergency_fund':
                // Don't auto-calculate for house_deposit and emergency_fund 
                // These are manual savings goals
                if (!goal.manuallyEdited) {
                    goal.currentProgress = calculateEmergencyFundProgress(goal);
                }
                break;
        }
    });
    
    saveData();
}

function calculateSavingsRateProgress(month, year) {
    const monthlyRecurring = getMonthlyRecurringTotals(year, month);
    const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;
    const totalSpent = getMonthlyExpenseTotal(year, month);
    
    if (totalMonthlyIncome === 0) return 0;
    
    const actualSavingsRate = ((totalMonthlyIncome - totalSpent) / totalMonthlyIncome) * 100;
    return Math.max(0, actualSavingsRate);
}

function calculateCategorySpendingProgress(goal, month, year) {
    let categorySpending = 0;
    
    const monthlyExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year &&
               e.category === goal.category;
    });
    
    if (goal.keywords && goal.keywords.length > 0) {
        // Filter by keywords (e.g., coffee)
        categorySpending = monthlyExpenses
            .filter(e => goal.keywords.some(keyword => 
                e.name.toLowerCase().includes(keyword.toLowerCase())
            ))
            .reduce((sum, e) => sum + e.cost, 0);
    } else {
        categorySpending = monthlyExpenses.reduce((sum, e) => sum + e.cost, 0);
    }
    
    // Return percentage of goal used (inverted - lower spending = higher progress)
    const percentageUsed = (categorySpending / goal.target) * 100;
    return Math.max(0, 100 - percentageUsed);
}

function calculateNoSpendDaysProgress(month, year) {
    const monthlyExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year;
    });
    
    const spendingDays = new Set(monthlyExpenses.map(e => e.date)).size;
    const currentDay = new Date().getDate();
    const totalDaysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Calculate no-spend days so far
    const noSpendDays = Math.max(0, currentDay - spendingDays);
    return noSpendDays;
}

// Fix the missing calculation functions
function calculateCookHomeProgress(month, year) {
    // This is a placeholder - you'd need to track cooking vs dining out
    // For now, estimate based on food expenses
    const foodExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year &&
               e.category === 'Food/Drink';
    });
    
    const diningOutExpenses = foodExpenses.filter(e => 
        e.name.toLowerCase().includes('restaurant') ||
        e.name.toLowerCase().includes('takeaway') ||
        e.name.toLowerCase().includes('delivery')
    );
    
    const currentDay = new Date().getDate();
    const estimatedCookDays = Math.max(0, currentDay - diningOutExpenses.length);
    return estimatedCookDays;
}

function calculateTotalSpendingProgress(goal, month, year) {
    const totalSpent = getMonthlyExpenseTotal(year, month);
    const targetSpending = monthlyBudget * (1 - goal.target / 100);
    
    if (totalSpent <= targetSpending) {
        return 100; // Goal achieved
    } else {
        const overspend = totalSpent - targetSpending;
        return Math.max(0, 100 - (overspend / targetSpending) * 100);
    }
}

function calculateImpulseLimitProgress(goal, month, year) {
    const impulseExpenses = expenses.filter(e => {
        const expenseDate = new Date(e.date);
        return e.status === 'active' && 
               expenseDate.getMonth() === month && 
               expenseDate.getFullYear() === year &&
               e.type === 'Non-Essential' &&
               e.cost > goal.target;
    });
    
    return impulseExpenses.length === 0 ? 100 : Math.max(0, 100 - impulseExpenses.length * 20);
}

function calculateEmergencyFundProgress(goal) {
    // Emergency fund progress should not be auto-calculated
    // It should only use the amount the user has specifically saved for emergencies
    // If no manual amount is set, return 0
    return goal.currentProgress || 0;
}

function updateGoalProgressDisplay() {
    calculateGoalProgress();
    
    // Update impact analysis when goals are updated
    updateGoalImpactDisplay();
    
    const goalDisplay = document.getElementById('goal-progress-display');
    
    if (!userGoals || userGoals.length === 0) {
        goalDisplay.textContent = 'No Goals';
        return;
    }
    
    // Find the primary goal (active financial goal)
    const primaryGoal = userGoals.find(g => g.priority === 'primary' && g.unit === 'currency');
    
    if (primaryGoal) {
        // Show concise progress for primary financial goal
        const progressPercent = (primaryGoal.currentProgress / primaryGoal.target) * 100;
        
        // Simple, compact display
        goalDisplay.innerHTML = `
            <div class="text-sm font-medium truncate">${primaryGoal.name}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">
                ${formatCurrency(primaryGoal.currentProgress)} / ${formatCurrency(primaryGoal.target)} (${Math.round(progressPercent)}%)
            </div>
            <div class="text-xs text-purple-500 mt-1 opacity-70">Click for details</div>
        `;
        
        // Make it clickable for details
        goalDisplay.className = goalDisplay.className + ' cursor-pointer hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors rounded-lg';
        goalDisplay.onclick = () => openGoalsModal();
    } else {
        // Fallback to simple completed/total display
        const completedGoals = userGoals.filter(g => {
            if (g.unit === 'percent' || g.unit === 'currency') {
                return g.currentProgress >= g.target;
            } else if (g.unit === 'days') {
                return g.currentProgress >= g.target;
            }
            return false;
        }).length;
        
        goalDisplay.textContent = `${completedGoals}/${userGoals.length} Complete`;
    }
}

function openGoalsModal() {
    renderGoalsModal();
    document.getElementById('goals-modal').classList.remove('hidden');
}

function closeGoalsModal() {
    document.getElementById('goals-modal').classList.add('hidden');
}

function openHelpModal() {
    // Close settings modal first
    closeSettings();
    
    // Add slight delay to ensure settings modal closes
    setTimeout(() => {
        document.getElementById('help-modal').classList.remove('hidden');
    }, 300);
}

function closeHelpModal() {
    document.getElementById('help-modal').classList.add('hidden');
}

function editGoals() {
    // Close the current goals modal
    closeGoalsModal();
    
    // Show the proper goal editing interface
    showGoalEditingInterface();
}

function showGoalEditingInterface() {
    document.getElementById('goal-editing-modal').classList.remove('hidden');
    renderGoalEditingInterface();
}

function closeGoalEditingModal() {
    document.getElementById('goal-editing-modal').classList.add('hidden');
}

function openEditTotalSavings() {
    // Pre-populate the input with current total savings
    const input = document.getElementById('edit-total-savings-input');
    input.value = totalSavings;
    
    // Show current allocation breakdown
    updateCurrentAllocationDisplay();
    
    // Show the modal
    document.getElementById('edit-total-savings-modal').classList.remove('hidden');
    
    // Focus the input
    setTimeout(() => input.focus(), 100);
}

function closeEditTotalSavings() {
    document.getElementById('edit-total-savings-modal').classList.add('hidden');
}

function updateCurrentAllocationDisplay() {
    const container = document.getElementById('current-allocation-display');
    
    // Calculate current allocations
    const allocatedAmount = userGoals.reduce((sum, goal) => {
        if (goal.unit === 'currency') {
            return sum + goal.currentProgress;
        }
        return sum;
    }, 0);
    
    const unallocated = totalSavings - allocatedAmount;
    
    container.innerHTML = `
        <div class="flex justify-between">
            <span>Goal allocations:</span>
            <span>${formatCurrency(allocatedAmount)}</span>
        </div>
        <div class="flex justify-between">
            <span>Unallocated:</span>
            <span>${formatCurrency(unallocated)}</span>
        </div>
        <div class="flex justify-between font-medium border-t border-gray-300 dark:border-gray-600 pt-1 mt-1">
            <span>Total:</span>
            <span>${formatCurrency(totalSavings)}</span>
        </div>
    `;
}

function saveTotalSavings() {
    const input = document.getElementById('edit-total-savings-input');
    const newTotalSavings = parseFloat(input.value) || 0;
    
    // Validate the input
    if (newTotalSavings < 0) {
        showToast('Total savings cannot be negative', 'error');
        return;
    }
    
    // Calculate total allocated amount
    const allocatedAmount = userGoals.reduce((sum, goal) => {
        if (goal.unit === 'currency') {
            return sum + goal.currentProgress;
        }
        return sum;
    }, 0);
    
    // Warn if new total is less than allocated amount
    if (newTotalSavings < allocatedAmount) {
        showToast(`Warning: New total (${formatCurrency(newTotalSavings)}) is less than your allocated amount (${formatCurrency(allocatedAmount)})`, 'warning');
        // Allow but show warning
    }
    
    // Update the global variable
    totalSavings = newTotalSavings;
    
    // Save to localStorage
    saveData();
    
    // Update the display
    updateDisplay();
    updateGoalProgressDisplay();
    
    // Close the modal
    closeEditTotalSavings();
    
    // Show success message
    showToast(`Total savings updated to ${formatCurrency(newTotalSavings)}`, 'success');
    
    // Refresh the goals modal if it's open
    const goalsModal = document.getElementById('goals-modal');
    if (!goalsModal.classList.contains('hidden')) {
        renderGoalsModal();
    }
}

function updateSavingsAllocation() {
    const input = document.getElementById('edit-total-savings-main');
    const newTotalSavings = parseFloat(input.value) || 0;
    
    // Calculate total allocated amount
    const allocatedAmount = userGoals.reduce((sum, goal) => {
        if (goal.unit === 'currency') {
            return sum + goal.currentProgress;
        }
        return sum;
    }, 0);
    
    const newUnallocated = newTotalSavings - allocatedAmount;
    
    // Update the unallocated display
    const unallocatedDisplay = document.getElementById('unallocated-display');
    if (unallocatedDisplay) {
        unallocatedDisplay.textContent = formatCurrency(newUnallocated);
        
        // Change color based on whether it's positive or negative
        if (newUnallocated < 0) {
            unallocatedDisplay.className = 'font-medium text-red-600';
        } else {
            unallocatedDisplay.className = 'font-medium text-green-600';
        }
    }
    
    // Show warning if new total is less than allocated
    if (newTotalSavings < allocatedAmount) {
        input.classList.add('border-red-500');
        input.title = `Warning: Total savings (${formatCurrency(newTotalSavings)}) is less than allocated amount (${formatCurrency(allocatedAmount)})`;
    } else {
        input.classList.remove('border-red-500');
        input.title = '';
    }
}

function renderGoalEditingInterface() {
    const container = document.getElementById('goal-editing-content');
    
    console.log('renderGoalEditingInterface - userGoals:', userGoals);
    console.log('renderGoalEditingInterface - userGoals length:', userGoals?.length);
    
    if (!userGoals || userGoals.length === 0) {
        console.log('No goals found in edit interface');
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">ðŸŽ¯</div>
                <p class="text-gray-600 dark:text-gray-400 mb-4">No goals set yet.</p>
                <button onclick="addNewGoal()" class="modern-button modern-button-primary" data-tour="first-goal">Add Your First Goal</button>
            </div>
        `;
        return;
    }
    
    // Calculate total allocated amount
    const allocatedAmount = userGoals.reduce((sum, goal) => {
        if (goal.unit === 'currency') {
            return sum + goal.currentProgress;
        }
        return sum;
    }, 0);
    
    const unallocated = totalSavings - allocatedAmount;
    
    container.innerHTML = `
        <!-- Total Savings Section -->
        <div class="card p-4 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-700">
            <h4 class="font-medium mb-3 text-blue-800 dark:text-blue-200">ðŸ’° Total Savings Management</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Total Savings</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium pointer-events-none select-none">Â£</span>
                        <input type="number" id="edit-total-savings-main" value="${totalSavings}" class="modern-input pl-6 pr-4 font-semibold" onchange="updateSavingsAllocation()">
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Total money across all accounts</div>
                </div>
                <div class="space-y-2">
                    <div class="text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Goal allocations:</span>
                            <span class="font-medium">${formatCurrency(allocatedAmount)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Unallocated:</span>
                            <span class="font-medium text-green-600" id="unallocated-display">${formatCurrency(unallocated)}</span>
                        </div>
                        ${totalDebt > 0 ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Total debt:</span>
                            <span class="font-medium text-red-600">-${formatCurrency(totalDebt)}</span>
                        </div>
                        <div class="flex justify-between border-t pt-1 mt-1">
                            <span class="text-gray-700 dark:text-gray-300 font-medium">Net worth:</span>
                            <span class="font-semibold ${totalSavings - totalDebt >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(totalSavings - totalDebt)}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Goals Section -->
        <div class="space-y-6">
            <h4 class="font-medium text-gray-800 dark:text-gray-200">ðŸŽ¯ Individual Goals</h4>
            ${userGoals.map((goal, index) => renderGoalEditForm(goal, index)).join('')}
        </div>
    `;
}

function renderGoalEditForm(goal, index) {
    const goalTypeConfig = getGoalTypeConfig(goal.type);
    
    return `
        <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h4 class="text-lg font-semibold">${goalTypeConfig.icon} ${goal.name}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${goalTypeConfig.description}</p>
                </div>
                <button onclick="removeGoal(${index})" class="text-red-500 hover:text-red-700 font-medium text-sm">Remove</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Target Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">Â£</span>
                        <input type="number" id="goal-${index}-target" value="${goal.target}" class="modern-input pl-8 text-center font-semibold" onchange="updateGoalProgress(${index})" oninput="updateGoalProgress(${index})">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Current Progress</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">Â£</span>
                        <input type="number" id="goal-${index}-current" value="${goal.currentProgress}" class="modern-input pl-8 text-center font-semibold" onchange="updateGoalProgress(${index})" oninput="updateGoalProgress(${index})">
                    </div>
                </div>
                
                ${goal.timeline ? `
                <div>
                    <label class="block text-sm font-medium mb-2">Timeline</label>
                    <select id="goal-${index}-timeline" class="modern-select font-medium">
                        <option value="">Select...</option>
                        ${getTimelineOptions().map(opt => `
                            <option value="${opt}" ${goal.timeline === opt ? 'selected' : ''}>${opt}</option>
                        `).join('')}
                    </select>
                </div>
                ` : ''}
                
                ${goal.months ? `
                <div>
                    <label class="block text-sm font-medium mb-2">Coverage Period</label>
                    <select id="goal-${index}-months" class="modern-select font-medium">
                        <option value="">Select...</option>
                        ${getMonthOptions().map(opt => `
                            <option value="${opt}" ${goal.months === parseInt(opt.charAt(0)) ? 'selected' : ''}>${opt}</option>
                        `).join('')}
                    </select>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                        This updates the goal name only. Your target amount stays as you set it.
                    </div>
                </div>
                ` : ''}
            </div>
            
            <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded">
                <div class="flex justify-between text-sm">
                    <span>Progress: <span id="goal-${index}-progress-text" class="font-medium">${Math.round((goal.currentProgress / goal.target) * 100)}%</span></span>
                    <span>Remaining: <span id="goal-${index}-remaining-text" class="font-medium">Â£${(goal.target - goal.currentProgress).toLocaleString()}</span></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div id="goal-${index}-progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-500" style="width: ${Math.min((goal.currentProgress / goal.target) * 100, 100)}%"></div>
                </div>
            </div>
        </div>
    `;
}

function getGoalTypeConfig(type) {
    const configs = {
        'house_deposit': { icon: 'ðŸ ', description: 'House purchase deposit fund' },
        'emergency_fund': { icon: 'ðŸ’°', description: 'Emergency fund for unexpected expenses' },
        'vacation': { icon: 'âœˆï¸', description: 'Dream vacation fund' },
        'investment': { icon: 'ðŸ“ˆ', description: 'Investment portfolio building' },
        'custom': { icon: 'ðŸŽ¯', description: 'Custom financial goal' }
    };
    return configs[type] || { icon: 'ðŸŽ¯', description: 'Financial goal' };
}

function getTimelineOptions() {
    return ['6 months', '1 year', '18 months', '2 years', '3 years', '4 years', '5+ years'];
}

function getMonthOptions() {
    return ['3 months expenses', '4 months expenses', '5 months expenses', '6 months expenses', '12 months expenses'];
}

function updateGoalProgress(index) {
    const targetInput = document.getElementById(`goal-${index}-target`);
    const currentInput = document.getElementById(`goal-${index}-current`);
    const progressText = document.getElementById(`goal-${index}-progress-text`);
    const remainingText = document.getElementById(`goal-${index}-remaining-text`);
    const progressBar = document.getElementById(`goal-${index}-progress-bar`);
    
    if (targetInput && currentInput && progressText && remainingText && progressBar) {
        const target = parseFloat(targetInput.value) || 0;
        const current = parseFloat(currentInput.value) || 0;
        
        const progressPercent = target > 0 ? Math.round((current / target) * 100) : 0;
        const remaining = Math.max(target - current, 0);
        
        progressText.textContent = `${progressPercent}%`;
        remainingText.textContent = `Â£${remaining.toLocaleString()}`;
        progressBar.style.width = `${Math.min(progressPercent, 100)}%`;
    }
}

function addNewGoal() {
    const goalTypes = [
        { type: 'house_deposit', name: 'ðŸ  House Deposit', description: 'Save for a house deposit' },
        { type: 'emergency_fund', name: 'ðŸ’° Emergency Fund', description: 'Build an emergency fund' },
        { type: 'vacation', name: 'âœˆï¸ Vacation', description: 'Save for a dream vacation' },
        { type: 'investment', name: 'ðŸ“ˆ Investment', description: 'Build investment portfolio' },
        { type: 'custom', name: 'ðŸŽ¯ Custom Goal', description: 'Create a custom goal' }
    ];
    
    const container = document.getElementById('goal-editing-content');
    container.innerHTML = `
        <div class="text-center mb-6">
            <h4 class="text-lg font-semibold mb-2">Add New Goal</h4>
            <p class="text-gray-600 dark:text-gray-400">Choose the type of goal you want to add</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            ${goalTypes.map(type => `
                <div onclick="selectNewGoalType('${type.type}')" class="p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
                    <div class="text-center">
                        <div class="text-2xl mb-2">${type.name.split(' ')[0]}</div>
                        <h5 class="font-semibold mb-1">${type.name.substring(2)}</h5>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${type.description}</p>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="text-center">
            <button onclick="renderGoalEditingInterface()" class="modern-button modern-button-secondary">Back to Goals</button>
        </div>
    `;
}

function selectNewGoalType(goalType) {
    const newGoal = {
        id: Date.now(),
        type: goalType,
        name: getDefaultGoalName(goalType),
        target: 0,
        currentProgress: 0,
        unit: 'currency',
        status: 'active',
        priority: 'secondary',
        createdAt: new Date().toISOString()
    };
    
    // Only set months for emergency fund, but let user set their own target
    if (goalType === 'emergency_fund') {
        newGoal.months = 6;
        // Don't auto-calculate target - let user decide
    }
    
    userGoals.push(newGoal);
    renderGoalEditingInterface();
}

function getDefaultGoalName(type) {
    const names = {
        'house_deposit': 'House Deposit',
        'emergency_fund': '6-Month Emergency Fund',
        'vacation': 'Dream Vacation',
        'investment': 'Investment Portfolio',
        'custom': 'Custom Goal'
    };
    return names[type] || 'New Goal';
}

function removeGoal(index) {
    const goal = userGoals[index];
    showConfirmation({
        icon: 'ðŸ—‘ï¸',
        title: 'Remove Goal',
        message: `Are you sure you want to remove "${goal.name}"? This action cannot be undone.`,
        confirmText: 'Remove',
        confirmClass: 'modern-button-danger',
        onConfirm: () => {
            userGoals.splice(index, 1);
            renderGoalEditingInterface();
            showToast('Goal removed successfully', 'info');
        }
    });
}

function showConfirmation(options) {
    const overlay = document.getElementById('goal-confirmation-overlay');
    const icon = document.getElementById('confirmation-icon');
    const title = document.getElementById('confirmation-title');
    const message = document.getElementById('confirmation-message');
    const button = document.getElementById('confirmation-button');
    
    // Set content
    icon.textContent = options.icon || 'âš ï¸';
    title.textContent = options.title || 'Confirm Action';
    message.textContent = options.message || 'Are you sure you want to proceed?';
    button.textContent = options.confirmText || 'Confirm';
    
    // Set button style
    button.className = `modern-button px-6 ${options.confirmClass || 'modern-button-primary'}`;
    
    // Store callback
    window.currentConfirmationCallback = options.onConfirm;
    
    // Show overlay within the goal editing modal
    overlay.classList.remove('hidden');
}

function cancelConfirmation() {
    document.getElementById('goal-confirmation-overlay').classList.add('hidden');
    window.currentConfirmationCallback = null;
}

function confirmAction() {
    if (window.currentConfirmationCallback) {
        window.currentConfirmationCallback();
        window.currentConfirmationCallback = null;
    }
    document.getElementById('goal-confirmation-overlay').classList.add('hidden');
}

function saveGoalEdits() {
    // Update total savings first
    const totalSavingsInput = document.getElementById('edit-total-savings-main');
    if (totalSavingsInput) {
        const newTotalSavings = parseFloat(totalSavingsInput.value) || 0;
        
        // Validate the input
        if (newTotalSavings < 0) {
            showToast('Total savings cannot be negative', 'error');
            return;
        }
        
        totalSavings = newTotalSavings;
    }
    
    // Update goals with new values from the forms
    userGoals.forEach((goal, index) => {
        const targetInput = document.getElementById(`goal-${index}-target`);
        const currentInput = document.getElementById(`goal-${index}-current`);
        const timelineInput = document.getElementById(`goal-${index}-timeline`);
        const monthsInput = document.getElementById(`goal-${index}-months`);
        
        // Always preserve user input values and mark as manually edited
        if (targetInput) {
            goal.target = parseFloat(targetInput.value) || 0;
            goal.manuallyEdited = true; // Prevent automatic calculation
        }
        if (currentInput) {
            goal.currentProgress = parseFloat(currentInput.value) || 0;
            goal.manuallyEdited = true; // Prevent automatic calculation
        }
        if (timelineInput) goal.timeline = timelineInput.value;
        
        // Only update months info if it exists, but DON'T override target
        if (monthsInput && goal.type === 'emergency_fund') {
            const months = parseInt(monthsInput.value.charAt(0));
            if (months) {
                goal.months = months;
                goal.name = `${months}-Month Emergency Fund`;
                // Don't override target - let user control it
            }
        }
    });
    
    // Save to localStorage
    saveData();
    
    // Update display
    updateDisplay();
    
    // Close modal and show success
    closeGoalEditingModal();
    showToast('Goals updated successfully!', 'success');
    
    // Refresh goals modal if it was open
    renderGoalsModal();
}

function renderGoalsModal() {
    const container = document.getElementById('goals-content');
    
    if (!userGoals || userGoals.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-4">ðŸŽ¯</div>
                <p class="text-gray-600 dark:text-gray-400">No goals set yet.</p>
                <button onclick="showGoalSelection()" class="modern-button modern-button-primary mt-4">Set Goals</button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = userGoals.map(goal => {
        const progressPercent = calculateGoalProgressPercent(goal);
        const isCompleted = progressPercent >= 100;
        const remaining = goal.target - goal.currentProgress;
        
        // Create detailed info for the modal
        let detailedInfo = '';
        if (goal.unit === 'currency') {
            if (goal.type === 'debt_payoff') {
                // Special handling for debt payoff goals
                detailedInfo = `
                    <div class="text-sm space-y-2 mt-3 p-3 bg-red-50 dark:bg-red-900/20 rounded">
                        <div class="flex justify-between">
                            <span>Total Debt:</span>
                            <span class="font-medium text-red-600 dark:text-red-400">${formatCurrency(goal.target)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Amount Paid Off:</span>
                            <span class="font-medium text-green-600 dark:text-green-400">${formatCurrency(goal.currentProgress)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Remaining Debt:</span>
                            <span class="font-medium text-red-600 dark:text-red-400">${formatCurrency(remaining)}</span>
                        </div>
                        ${goal.strategy ? `
                        <div class="flex justify-between text-xs pt-2 border-t border-red-200 dark:border-red-800">
                            <span>Strategy:</span>
                            <span>${goal.strategy}</span>
                        </div>
                        ` : ''}
                        ${goal.extraPayment > 0 ? `
                        <div class="flex justify-between text-xs">
                            <span>Extra Monthly Payment:</span>
                            <span>${formatCurrency(goal.extraPayment)}</span>
                        </div>
                        ` : ''}
                        ${totalSavings > 0 ? `
                        <div class="flex justify-between text-xs border-t border-red-200 dark:border-red-800 pt-2">
                            <span>Net Worth After Payoff:</span>
                            <span class="text-green-600 dark:text-green-400">${formatCurrency(totalSavings - remaining)}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Regular savings goals
                detailedInfo = `
                    <div class="text-sm space-y-2 mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded">
                        <div class="flex justify-between">
                            <span>Allocated:</span>
                            <span class="font-medium">${formatCurrency(goal.currentProgress)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Target:</span>
                            <span class="font-medium">${formatCurrency(goal.target)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Still needed:</span>
                            <span class="font-medium text-purple-600">${formatCurrency(remaining)}</span>
                        </div>
                        ${totalSavings > 0 ? `
                        <div class="flex justify-between text-xs pt-2 border-t border-gray-200 dark:border-gray-600">
                            <span>Total savings:</span>
                            <span>${formatCurrency(totalSavings)}</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span>Unallocated:</span>
                            <span>${formatCurrency(totalSavings - goal.currentProgress)}</span>
                        </div>
                        ` : ''}
                        ${totalDebt > 0 ? `
                        <div class="flex justify-between text-xs border-t border-gray-200 dark:border-gray-600 pt-2">
                            <span>Net worth:</span>
                            <span class="text-red-500">${formatCurrency(totalSavings - totalDebt)}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        return `
            <div class="p-4 border border-gray-200 dark:border-gray-600 rounded-lg mb-4 ${isCompleted ? 'bg-green-50 dark:bg-green-900/20 border-green-500' : ''}">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium">${goal.name}</h4>
                    ${isCompleted ? '<span class="text-green-600 text-xl">âœ…</span>' : ''}
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-purple-600 h-2 rounded-full transition-all duration-500" style="width: ${Math.min(progressPercent, 100)}%"></div>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600 dark:text-gray-400">${formatGoalProgress(goal)}</span>
                    <span class="font-medium">${Math.round(progressPercent)}%</span>
                </div>
                ${detailedInfo}
            </div>
        `;
    }).join('');
}

function calculateGoalProgressPercent(goal) {
    if (goal.unit === 'percent') {
        return goal.target > 0 ? (goal.currentProgress / goal.target) * 100 : 0;
    } else if (goal.unit === 'currency') {
        if (goal.type === 'category_limit' || goal.type === 'coffee_budget') {
            return goal.currentProgress; // Already calculated as percentage
        }
        if (goal.target === 0) {
            console.warn('Goal has 0 target:', goal);
            return 0;
        }
        return (goal.currentProgress / goal.target) * 100;
    } else if (goal.unit === 'days') {
        return goal.target > 0 ? (goal.currentProgress / goal.target) * 100 : 0;
    }
    return 0;
}

function formatGoalProgress(goal) {
    if (goal.unit === 'currency') {
        if (goal.type === 'category_limit' || goal.type === 'coffee_budget') {
            const spent = goal.target * (1 - goal.currentProgress / 100);
            return `${formatCurrency(spent)} / ${formatCurrency(goal.target)}`;
        } else if (goal.type === 'emergency_fund' && goal.months && monthlyExpenses > 0) {
            // Show coverage for emergency fund goals
            const coverageMonths = (goal.currentProgress / monthlyExpenses).toFixed(1);
            return `${formatCurrency(goal.currentProgress)} / ${formatCurrency(goal.target)} (${coverageMonths} months coverage)`;
        }
        return `${formatCurrency(goal.currentProgress)} / ${formatCurrency(goal.target)}`;
    } else if (goal.unit === 'percent') {
        return `${goal.currentProgress.toFixed(1)}% / ${goal.target}%`;
    } else if (goal.unit === 'days') {
        return `${goal.currentProgress} / ${goal.target} days`;
    }
    return `${goal.currentProgress} / ${goal.target}`;
}

function closeGoalSelection() {
    document.getElementById('goal-selection-modal').classList.add('hidden');
}

        // --- Tab Management ---
        function showTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            // Deactivate all desktop and mobile tab buttons
            document.querySelectorAll('.tab-button, .bottom-nav-item').forEach(button => button.classList.remove('active'));

            // Activate desktop tab button
            const desktopTabButton = document.getElementById(`tab-${tabName}`);
            if (desktopTabButton) desktopTabButton.classList.add('active');
            
            // Activate mobile tab button
            const mobileTabButton = document.getElementById(`mobile-tab-${tabName}`);
            if (mobileTabButton) mobileTabButton.classList.add('active');

            // Show the content panel
            const newTabContent = document.getElementById(`${tabName}-tab`);
            if (newTabContent) {
                newTabContent.classList.remove('hidden');
            }
            
                activeTab = tabName;

                // Render content based on the active tab
                if (activeTab === 'insights') {
                    updateChartsAndInsights();
                } else if (activeTab === 'expenses') {
                    renderExpensesTable();
                } else if (activeTab === 'recurring') {
                    renderRecurringTable();
                }
                saveData();
        }

        // --- Settings & Theme ---
        function toggleSettings() {
            DOMElements.settingsMenu.classList.toggle('hidden');
        }

        function toggleTheme(isDark) {
            localStorage.setItem('darkMode', isDark);
            applyTheme();
        }

        function applyTheme() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            DOMElements.html.classList.toggle('dark', darkMode);
            DOMElements.themeToggle.checked = darkMode;
            
            if (activeTab === 'insights') {
                updateChartsAndInsights(); 
            }
        }

        // --- Data Load/Save ---
        function loadData() {
            const data = localStorage.getItem('lensAppData');
            if (data) {
                const parsedData = JSON.parse(data);
                console.log('loadData - raw data from localStorage:', data);
                console.log('loadData - parsedData.userGoals:', parsedData.userGoals);
                console.log('loadData - userGoals before assignment:', userGoals);
                expenses = parsedData.expenses || [];
                recurringItems = parsedData.recurringItems || [];
                monthlyBudget = parsedData.monthlyBudget || 0;
                monthlyIncome = parsedData.monthlyIncome || 0;
                monthlyExpenses = parsedData.monthlyExpenses || 0;
                totalSavings = parsedData.totalSavings || 0;
                totalDebt = parsedData.totalDebt || 0;
                healthScoreHistory = parsedData.healthScoreHistory || {};
                currentCurrencyCode = parsedData.currentCurrencyCode || 'GBP';
                activeTab = parsedData.activeTab || 'overview';
                userGoals = parsedData.userGoals || [];
                console.log('loadData - userGoals after assignment:', userGoals);
            }
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                 DOMElements.themeToggle.checked = savedDarkMode === 'true';
            }
        }

        function saveData() {
            const dataToSave = {
                expenses,
                recurringItems,
                monthlyBudget,
                monthlyIncome,
                monthlyExpenses,
                totalSavings,
                totalDebt,
                healthScoreHistory,
                currentCurrencyCode,
                activeTab,
                userGoals
            };
            localStorage.setItem('lensAppData', JSON.stringify(dataToSave));
        }

        // --- Import / Export ---
        function exportData() {
            const dataStr = localStorage.getItem('lensAppData') || '{}';
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `lens-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData === 'object' && importedData !== null) {
                        expenses = importedData.expenses || [];
                        recurringItems = importedData.recurringItems || [];
                        monthlyBudget = importedData.monthlyBudget || 0;
                        monthlyIncome = importedData.monthlyIncome || 0;
                        healthScoreHistory = importedData.healthScoreHistory || {};
                        currentCurrencyCode = importedData.currentCurrencyCode || 'GBP';
                        activeTab = importedData.activeTab || 'overview';
                        userGoals = importedData.userGoals || [];
                        
                        if (DOMElements.currencySelect) {
                            DOMElements.currencySelect.value = currentCurrencyCode;
                        }

                        saveData();
                        updateCurrencyUI();
                        updateDisplay();
                        showTab(activeTab);
                        showToast('Data imported successfully!');
                        closeSettings();
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    showToast('Import failed: Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        // --- Budget & Income ---
        function updateBudget(value) {
            monthlyBudget = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }
        function updateIncome(value) {
            monthlyIncome = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }

        // --- Currency Management ---
        function changeCurrency(value) {
            if (currencyConfig[value]) {
                currentCurrencyCode = value;
                updateCurrencyUI();
                saveData();
                updateDisplay();
                showToast(`Currency changed to ${value}`);
            }
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function updateCurrencyUI() {
            const symbol = currencyConfig[currentCurrencyCode].symbol;
            DOMElements.modalCurrency.textContent = symbol;
            DOMElements.recurringModalCurrency.textContent = symbol;
            DOMElements.currencySelect.value = currentCurrencyCode;
        }

        // --- Expense Management ---
        function showAddForm(prefill = {}) {
            editingExpense = null;
            DOMElements.modalTitle.textContent = 'Add New Expense';
            DOMElements.expenseName.value = prefill.name || '';
            DOMElements.expenseCost.value = prefill.cost || '';
            DOMElements.expenseType.value = prefill.type || 'Non-Essential';
            DOMElements.expenseCategory.value = prefill.category || 'Other';
            DOMElements.expenseDate.value = prefill.date || new Date().toISOString().split('T')[0];
            DOMElements.expensePaymentMethod.value = prefill.paymentMethod || '';
            DOMElements.modal.classList.remove('hidden');
        }

        function closeModal() {
            DOMElements.modal.classList.add('hidden');
            editingExpense = null;
        }

        function handleExpenseFormSubmission(event) {
            event.preventDefault();
            saveExpense();
        }

        function saveExpense() {
            const name = DOMElements.expenseName.value.trim();
            const cost = parseFloat(DOMElements.expenseCost.value);
            const date = DOMElements.expenseDate.value;

            if (!name || isNaN(cost) || cost <= 0 || !date) {
                showToast('Please fill in all fields correctly (Name, positive Amount, Date).', 'error');
                return;
            }

            const expense = {
                id: editingExpense ? editingExpense.id : Date.now(),
                name: name,
                cost: cost,
                type: DOMElements.expenseType.value,
                category: DOMElements.expenseCategory.value,
                date: date,
                paymentMethod: DOMElements.expensePaymentMethod.value,
                status: 'active'
            };

            if (editingExpense) {
                const index = expenses.findIndex(e => e.id === editingExpense.id);
                if (index !== -1) expenses[index] = expense;
            } else {
                expenses.push(expense);
            }

            sortExpenses();
            saveData();
            updateDisplay();
            closeModal();
            showToast(`Expense '${name}' saved successfully.`, "success");
        }
        
        function quickAddExpense(name, category, type, cost) {
            const expense = {
                    id: Date.now(),
                name: name,
                cost: cost,
                type: type || 'Non-Essential',
                category: category || 'Other',
                date: new Date().toISOString().split('T')[0],
                paymentMethod: '',
                    status: 'active'
                };
            expenses.push(expense);
            sortExpenses();
            saveData();
            updateDisplay();
            showToast(`${name} added successfully for ${formatCurrency(cost)}.`);
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
            editingExpense = expense;
                DOMElements.modalTitle.textContent = 'Edit Expense';
                DOMElements.expenseName.value = expense.name;
                DOMElements.expenseCost.value = expense.cost;
                DOMElements.expenseType.value = expense.type;
                DOMElements.expenseCategory.value = expense.category;
                DOMElements.expenseDate.value = expense.date;
                DOMElements.expensePaymentMethod.value = expense.paymentMethod || '';
                DOMElements.modal.classList.remove('hidden');
            }
        }

        function deleteExpense(id) {
            const index = expenses.findIndex(e => e.id === id);
            if (index > -1) {
                const expenseName = expenses[index].name;
                expenses.splice(index, 1);
                updateDisplay();
                showToast(`Expense '${expenseName}' deleted.`, 'info');
            }
        }

        function toggleExpenseStatus(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.status = expense.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Expense status updated to ${expense.status}.`);
            }
        }

        function toggleFilterPanel(panelId) {
            document.getElementById(panelId).classList.toggle('hidden');
        }

        // --- Recurring Item Management ---
        function populateCategoryDropdowns() {
            const expenseOptions = expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            DOMElements.expenseCategory.innerHTML = expenseOptions;
            
            document.getElementById('expense-filter-category').innerHTML = '<option value="">All Categories</option>' + expenseOptions;
            
            const allCats = [...new Set([...expenseCategories, ...incomeCategories])];
            document.getElementById('recurring-filter-category').innerHTML = '<option value="">All Categories</option>' + allCats.map(c => `<option value="${c}">${c}</option>`).join('');

            toggleRecurringFields('expense');
        }

        function toggleRecurringFields(type) {
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            DOMElements.recurringCategory.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            DOMElements.recurringEssentialTypeWrapper.style.display = type === 'expense' ? 'block' : 'none';
        }

         function showRecurringForm() {
            editingRecurring = null;
            DOMElements.recurringModalTitle.textContent = 'Add Recurring Item';
            DOMElements.recurringItemType.value = 'expense';
            toggleRecurringFields('expense');
            DOMElements.recurringName.value = '';
            DOMElements.recurringAmount.value = '';
            DOMElements.recurringFrequency.value = 'Monthly';
            DOMElements.recurringPaymentMethod.value = '';
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringEndDate.value = '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function closeRecurringModal() {
            DOMElements.recurringModal.classList.add('hidden');
            editingRecurring = null;
        }

        function saveRecurring() {
            const type = DOMElements.recurringItemType.value;
            const name = DOMElements.recurringName.value.trim();
            const amount = parseFloat(DOMElements.recurringAmount.value);
            const startDate = DOMElements.recurringStartDate.value;
            const endDate = DOMElements.recurringEndDate.value || null;

            if (!name || isNaN(amount) || amount <= 0 || !startDate) {
                 showToast('Please fill in recurring item fields correctly.', 'error');
                return;
            }

            const recurringItem = {
                id: editingRecurring ? editingRecurring.id : Date.now(),
                type: type,
                name: name,
                amount: amount,
                frequency: DOMElements.recurringFrequency.value,
                category: DOMElements.recurringCategory.value,
                essentialType: type === 'expense' ? DOMElements.recurringEssentialType.value : null,
                paymentMethod: DOMElements.recurringPaymentMethod.value,
                startDate: startDate,
                endDate: endDate,
                status: 'active'
            };

            if (editingRecurring) {
                const index = recurringItems.findIndex(r => r.id === editingRecurring.id);
                if (index !== -1) recurringItems[index] = recurringItem;
            } else {
                recurringItems.unshift(recurringItem); // Add to beginning for chronological order
            }

            saveData();
            
            // Fix: Force immediate processing and update
            processRecurringExpenses();
            updateDisplay();
            
            closeRecurringModal();
            showToast(`Recurring item '${name}' saved successfully.`, "success");
        }

        function editRecurring(id) {
            const item = recurringItems.find(r => r.id === id);
            if (!item) return;
            editingRecurring = item;
            DOMElements.recurringModalTitle.textContent = 'Edit Recurring Item';
            DOMElements.recurringItemType.value = item.type;
            toggleRecurringFields(item.type);
            DOMElements.recurringName.value = item.name;
            DOMElements.recurringAmount.value = item.amount;
            DOMElements.recurringFrequency.value = item.frequency;
            DOMElements.recurringCategory.value = item.category;
            if (item.type === 'expense') {
                DOMElements.recurringEssentialType.value = item.essentialType || 'Non-Essential';
            }
            DOMElements.recurringPaymentMethod.value = item.paymentMethod || '';
            DOMElements.recurringStartDate.value = item.startDate;
            DOMElements.recurringEndDate.value = item.endDate || '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function deleteRecurring(id) {
            if (confirm('Are you sure you want to delete this recurring item and all its automatically generated expenses?')) {
                // Remove the recurring item
                recurringItems = recurringItems.filter(r => r.id !== id);
                
                // Remove ALL associated auto-generated expenses
                const initialExpenseCount = expenses.length;
                expenses = expenses.filter(e => e.recurringSourceId !== id);
                const removedExpenseCount = initialExpenseCount - expenses.length;
                
                // Remove from selected items
                selectedRecurringIds.delete(id);
                
                saveData();
                updateDisplay();
                
                if (removedExpenseCount > 0) {
                    showToast(`Recurring item and ${removedExpenseCount} associated expense(s) deleted!`);
                } else {
                    showToast('Recurring item deleted!');
                }
            }
        }
        
        function toggleRecurringStatus(id) {
            const item = recurringItems.find(r => r.id === id);
            if(item) {
                item.status = item.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Recurring item status updated.`);
            }
        }
        
        // --- Filtering Logic ---
        function applyExpenseFilters() {
            window.expensesCurrentPage = 1; // Reset to first page when filtering
            renderExpensesTable();
            showToast('Filters applied');
        }

        function clearExpenseFilters() {
            document.getElementById('expense-filter-date-from').value = '';
            document.getElementById('expense-filter-date-to').value = '';
            document.getElementById('expense-filter-category').value = '';
            document.getElementById('expense-filter-type').value = '';
            window.expensesCurrentPage = 1; // Reset to first page when clearing
            renderExpensesTable();
            showToast('Filters cleared');
        }

        function applyRecurringFilters() {
            window.recurringCurrentPage = 1; // Reset to first page when filtering
            renderRecurringTable();
            showToast('Filters applied');
        }

        function clearRecurringFilters() {
            document.getElementById('recurring-filter-type').value = '';
            document.getElementById('recurring-filter-category').value = '';
            document.getElementById('recurring-filter-frequency').value = '';
            window.recurringCurrentPage = 1; // Reset to first page when clearing
            renderRecurringTable();
            showToast('Filters cleared');
        }
        
        // --- Bulk Actions ---
        function toggleSelectAllExpenses(checked) {
            const checkboxes = DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox');
            selectedExpenseIds.clear();
            checkboxes.forEach(cb => {
                if (!cb.disabled) {
                    cb.checked = checked;
                    if (checked) {
                        selectedExpenseIds.add(cb.dataset.id);
                    }
                }
            });
            updateDeleteSelectedButton();
        }

        function toggleExpenseSelection(checkbox, id) {
            if (checkbox.checked) {
                selectedExpenseIds.add(id);
            } else {
                selectedExpenseIds.delete(id);
            }
            const allCheckboxes = [...DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox:not(:disabled)')];
            DOMElements.selectAllExpensesCheckbox.checked = allCheckboxes.length > 0 && selectedExpenseIds.size === allCheckboxes.length;
            updateDeleteSelectedButton();
        }

        function updateDeleteSelectedButton() {
            if (selectedExpenseIds.size > 0) {
                DOMElements.deleteSelectedBtn.classList.remove('hidden');
                DOMElements.deleteSelectedBtn.querySelector('span').textContent = `Delete Selected (${selectedExpenseIds.size})`;
            } else {
                DOMElements.deleteSelectedBtn.classList.add('hidden');
            }
        }

        function deleteSelectedExpenses() {
            if (selectedExpenseIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedExpenseIds.size} selected one-time expense(s)?`)) {
                const initialCount = expenses.length;
                expenses = expenses.filter(e => !selectedExpenseIds.has(e.id.toString()));
                const deletedCount = initialCount - expenses.length;
                selectedExpenseIds.clear();
                DOMElements.selectAllExpensesCheckbox.checked = false;
                saveData();
                updateDisplay();
                showToast(`${deletedCount} expense(s) deleted.`);
            }
        }
        
        function toggleSelectAllRecurring(checked) {
            const checkboxes = DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox');
            selectedRecurringIds.clear();
            checkboxes.forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedRecurringIds.add(parseInt(cb.dataset.id));
                }
            });
            updateDeleteSelectedRecurringButton();
        }

        function toggleRecurringSelection(checkbox, id) {
            const numId = parseInt(id);
            if (checkbox.checked) {
                selectedRecurringIds.add(numId);
            } else {
                selectedRecurringIds.delete(numId);
            }
            const allCheckboxes = [...DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox')];
            DOMElements.selectAllRecurringCheckbox.checked = allCheckboxes.length > 0 && selectedRecurringIds.size === allCheckboxes.length;
            updateDeleteSelectedRecurringButton();
        }

        function updateDeleteSelectedRecurringButton() {
            const btn = DOMElements.deleteSelectedRecurringBtn;
            if (selectedRecurringIds.size > 0) {
                btn.classList.remove('hidden');
                btn.querySelector('span').textContent = `Delete Selected (${selectedRecurringIds.size})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        function deleteSelectedRecurring() {
            if (selectedRecurringIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedRecurringIds.size} recurring item(s) and their associated expenses?`)) {
                let totalRemovedExpenses = 0;
                
                // For each selected recurring item, remove associated expenses
                selectedRecurringIds.forEach(recurringId => {
                    const initialExpenseCount = expenses.length;
                    expenses = expenses.filter(e => e.recurringSourceId !== recurringId);
                    totalRemovedExpenses += (initialExpenseCount - expenses.length);
                });
                
                // Remove the recurring items
                const deletedRecurringCount = selectedRecurringIds.size;
                recurringItems = recurringItems.filter(r => !selectedRecurringIds.has(r.id));
                
                // Clear selections and update UI
                selectedRecurringIds.clear();
                DOMElements.selectAllRecurringCheckbox.checked = false;
                
                saveData();
                updateDisplay();
                
                if (totalRemovedExpenses > 0) {
                    showToast(`${deletedRecurringCount} recurring item(s) and ${totalRemovedExpenses} associated expense(s) deleted!`);
                } else {
                    showToast(`${deletedRecurringCount} recurring item(s) deleted!`);
                }
            }
        }

        // --- Calculation Functions ---
        function getMonthlyRecurringTotals(year, month) {
            let totals = { income: 0, expenses: 0, incomeItems: [], expenseItems: [] };
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            recurringItems.forEach(item => {
                if (item.status !== 'active') return;

                const startDate = new Date(item.startDate + 'T00:00:00');
                if (startDate > lastDay) return;

                if (item.endDate) {
                    const endDate = new Date(item.endDate + 'T00:00:00');
                    if (endDate < firstDay) return;
                }

                // Check if this recurring item has a due date in this month
                let currentDate = new Date(startDate);
                let hasOccurrenceThisMonth = false;
                let iterations = 0;
                
                while (currentDate <= lastDay && iterations < 100) {
                    if (currentDate >= firstDay && currentDate <= lastDay) {
                        hasOccurrenceThisMonth = true;
            break;
    }

                    // Move to next occurrence
                    switch (item.frequency) {
                        case 'Daily': currentDate.setDate(currentDate.getDate() + 1); break;
                        case 'Weekly': currentDate.setDate(currentDate.getDate() + 7); break;
                        case 'Bi-Weekly': currentDate.setDate(currentDate.getDate() + 14); break;
                        case 'Monthly': currentDate.setMonth(currentDate.getMonth() + 1); break;
                        case 'Quarterly': currentDate.setMonth(currentDate.getMonth() + 3); break;
                        case 'Annual': currentDate.setFullYear(currentDate.getFullYear() + 1); break;
                        default: iterations = 100; break;
                    }
                    iterations++;
                }

                // If there's an occurrence this month, count it once
                if (hasOccurrenceThisMonth) {
                    if (item.type === 'income') {
                        totals.income += item.amount;
                        if (!totals.incomeItems.find(i => i.id === item.id)) {
                            totals.incomeItems.push(item);
                        }
                    } else {
                        // Note: Don't add recurring expenses here since they're already in the main expenses array
                        // Only track for income calculations
                        if (!totals.expenseItems.find(i => i.id === item.id)) {
                            totals.expenseItems.push(item);
                        }
                    }
                }
            });
            
            return totals;
        }

        function getMonthlyExpenseTotal(year, month) {
            return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === month && 
                       expenseDate.getFullYear() === year;
            }).reduce((sum, e) => sum + e.cost, 0);
        }

        // --- UI Update Functions ---
        function getResponsiveFontSize(text) {
            const baseSize = 1.875; // Corresponds to text-3xl
            const minSize = 1.25; // Corresponds to text-xl
            const maxLength = 8; // Start shrinking after 8 characters
            
            let newSize = baseSize;
            if (text.length > maxLength) {
                newSize = Math.max(minSize, baseSize - (text.length - maxLength) * 0.15);
            }
            return `${newSize}rem`;
        }

        function updateQuickAddButtons() {
            const quickAddData = {
                'JPY': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 500 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 700 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 1000 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 20000 }
                ],
                'default': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 5 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 10 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 15 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 50 }
                ]
            };

            const currencyData = quickAddData[currentCurrencyCode] || quickAddData['default'];
            
            currencyData.forEach(item => {
                const container = document.getElementById(item.id);
                if (container) {
                    const button = container.querySelector('button');
                    if (button) {
                        const costSpan = button.querySelector('span.font-medium');
                        if (costSpan) {
                            costSpan.textContent = formatCurrency(item.cost);
                        }
                        button.onclick = () => quickAddExpense(item.name, item.category, item.type, item.cost);
                    }
                }
            });
        }

        function updateDisplay() {
            console.time('updateDisplay');
            
            sortExpenses();
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Centralized calculations for all expenses this month
            const monthlyRecurring = getMonthlyRecurringTotals(currentYear, currentMonth);
            const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;

            // âœ… FIXED: Only use the main expenses array (recurring expenses are already there)
            const allMonthlyExpenses = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            const totalSpent = allMonthlyExpenses.reduce((sum, e) => sum + e.cost, 0);

            // --- Update UI Tiles ---
            const budgetStr = formatCurrency(monthlyBudget);
            const spentStr = formatCurrency(totalSpent);
            const incomeStr = formatCurrency(totalMonthlyIncome);
            const remaining = monthlyBudget - totalSpent;
            const remainingStr = formatCurrency(remaining);

            // Find the longest string to determine a consistent font size
            const maxLength = Math.max(budgetStr.length, spentStr.length, incomeStr.length, remainingStr.length);
            const responsiveSize = getResponsiveFontSize(" ".repeat(maxLength));

            DOMElements.monthlyBudgetDisplay.textContent = budgetStr;
            DOMElements.monthlyBudgetDisplay.style.fontSize = responsiveSize;

            DOMElements.totalExpensesDisplay.textContent = spentStr;
            DOMElements.totalExpensesDisplay.style.fontSize = responsiveSize;
            
            if (DOMElements.totalIncomeDisplay) {
    if (DOMElements.totalIncomeDisplay) {
    DOMElements.totalIncomeDisplay.textContent = incomeStr;
    DOMElements.totalIncomeDisplay.style.fontSize = responsiveSize;
}
}

            DOMElements.remainingAmountDisplay.textContent = remainingStr;
            DOMElements.remainingAmountDisplay.style.fontSize = responsiveSize;

            if (remaining < 0) {
                DOMElements.remainingAmountDisplay.classList.remove('text-green-600', 'dark:text-green-400');
                DOMElements.remainingAmountDisplay.classList.add('text-red-600', 'dark:text-red-400');
            } else {
                DOMElements.remainingAmountDisplay.classList.remove('text-red-600', 'dark:text-red-400');
                DOMElements.remainingAmountDisplay.classList.add('text-green-600', 'dark:text-green-400');
            }

            updateQuickAddButtons();

            // Budget Health & Progress Bar
            const budgetProgress = (monthlyBudget > 0) ? (totalSpent / monthlyBudget) * 100 : 0;
            DOMElements.budgetBar.style.width = `${Math.min(budgetProgress, 100)}%`;
            DOMElements.budgetBar.classList.remove('bg-blue-600', 'bg-red-600');
            DOMElements.budgetBar.classList.add(budgetProgress > 100 ? 'bg-red-600' : 'bg-blue-600');
            DOMElements.budgetPercentage.textContent = `${budgetProgress.toFixed(0)}% Used`;
            
            // AI Projection
            const projection = predictMonthEndSpending(totalSpent, now);
            DOMElements.aiProjectionContainer.innerHTML = `
                                <div class="flex items-center gap-2">
                    <span class="text-lg">ðŸ”®</span>
                    <div class="flex items-center gap-2">
                            <div>
                        <span class="font-semibold">AI Projection:</span>
                        You're on track to spend <strong>${formatCurrency(projection.projectedSpend)}</strong> this month.
                        <span class="font-bold ${projection.statusColor}">${projection.statusText}</span>
                                </div>
                        <div class="tooltip">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 cursor-help hover:text-gray-600 dark:hover:text-gray-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="tooltiptext">
                                <strong>How this works:</strong><br>
                                Based on your spending so far (${formatCurrency(totalSpent)}) divided by ${new Date().getDate()} days = ${formatCurrency(totalSpent / new Date().getDate())} per day average.<br><br>
                                Projected over ${new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate()} days in this month = ${formatCurrency(projection.projectedSpend)} total.<br><br>
                                This becomes more accurate as you add more expenses throughout the month.
                        </div>
                    </div>
                </div>
                    </div>
            `;
            
            // âœ… FIXED: Use the correct variable name 'allMonthlyExpenses' instead of 'activeMonthlyExpenses'
            updateBudgetHealthScore(totalSpent, monthlyBudget, allMonthlyExpenses, totalMonthlyIncome, now);
            
            // Spending Breakdown - FIXED: Use correct variable name
            const essentialSpending = allMonthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
            const nonEssentialSpending = allMonthlyExpenses.filter(e => e.type === 'Non-Essential').reduce((sum, e) => sum + e.cost, 0);
            DOMElements.essentialSpendingDisplay.textContent = formatCurrency(essentialSpending);
            DOMElements.nonEssentialSpendingDisplay.textContent = formatCurrency(nonEssentialSpending);
            const totalBreakdown = essentialSpending + nonEssentialSpending;
            const essentialPercent = totalBreakdown > 0 ? (essentialSpending / totalBreakdown) * 100 : 0;
            DOMElements.essentialBar.style.width = `${essentialPercent}%`;
            DOMElements.nonEssentialBar.style.width = `${100 - essentialPercent}%`;

            // âœ… These functions should now work properly
            renderRecentExpenses();
            renderExpensesTable();
            renderRecurringTable();
            
            if (activeTab === 'insights') {
                updateChartsAndInsights();
            }
            updateDeleteSelectedButton();
            updateDeleteSelectedRecurringButton();
            
            // Update table labels for mobile cards
            setTimeout(updateTableLabels_NEW, 10);
            
            updateGoalProgressDisplay(); // ADD THIS LINE

            console.timeEnd('updateDisplay');
        }

        // --- Budget Health Score v3 ---

        function calculateBudgetUsageScore(totalSpent, budget, now) {
            let score = 0;
            // Component 1: Budget Usage (30 points)
            if (budget > 0) {
                const usage = totalSpent / budget;
                if (usage > 1) score += 0;
                else if (usage <= 0.8) score += 30;
                else score += 30 * (1 - (usage - 0.8) / 0.2);
            }

            // Component 2: Spending Velocity (20 points)
            if (budget > 0) {
                const dayOfMonth = now.getDate();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const percentOfMonthPassed = dayOfMonth / daysInMonth;
                const idealSpend = budget * percentOfMonthPassed;
                const deviation = totalSpent / idealSpend;
                if (deviation <= 1.0) score += 20;
                else if (deviation <= 1.5) score += 20 * (1 - (deviation - 1.0) / 0.5);
            }

            return { score: Math.round(score), max: 50 };
        }

        function calculateSpendingHabitsScore(monthlyExpenses, totalSpent) {
            let score = 0;
            if (totalSpent > 0) {
                // Component 1: Essential vs Non-Essential (15 points)
                const essentialSpending = monthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
                const nonEssentialRatio = (totalSpent - essentialSpending) / totalSpent;
                if (nonEssentialRatio < 0.3) score += 15;
                else if (nonEssentialRatio < 0.5) score += 7;

                // Component 2: No-Spend Days (15 points)
                const spendingDays = new Set(monthlyExpenses.map(e => e.date)).size;
                const zeroSpendingDays = new Date().getDate() - spendingDays;
                if (zeroSpendingDays >= 8) score += 15;
                else if (zeroSpendingDays >= 4) score += 7;
            }
            return { score: Math.round(score), max: 30 };
        }

        function calculateSavingsRateScore(totalSpent, totalMonthlyIncome, now) {
            let score = 0;
            // Component 1: Positive Savings (10 points)
            if (totalMonthlyIncome > 0 && totalMonthlyIncome > totalSpent) {
                score += 10;
            }
            
            // Component 2: Improving Savings Rate (10 points)
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthData = getExpensesForMonth(lastMonth.getFullYear(), lastMonth.getMonth());
            const lastMonthIncomeData = getMonthlyRecurringTotals(lastMonth.getFullYear(), lastMonth.getMonth());
            const lastMonthTotalIncome = (monthlyIncome || 0) + lastMonthIncomeData.income;
            if (lastMonthTotalIncome > 0) {
                const lastMonthSpent = lastMonthData.reduce((sum, e) => sum + e.cost, 0);
                const currentSavingsRate = (totalMonthlyIncome - totalSpent) / totalMonthlyIncome;
                const lastMonthSavingsRate = (lastMonthTotalIncome - lastMonthSpent) / lastMonthTotalIncome;
                if (currentSavingsRate > lastMonthSavingsRate) {
                    score += 10;
                }
            }
            return { score: Math.round(score), max: 20 };
        }

        function generateHealthScoreInsights(scoreData, totalSpent, monthlyExpenses, totalMonthlyIncome) {
            const insights = { strengths: [], improvements: [], tip: '' };
            const { budgetUsage, spendingHabits, savingsRate } = scoreData.breakdown;

            // Strengths
            if (budgetUsage.score / budgetUsage.max > 0.8) insights.strengths.push("Excellent budget control and spending pace.");
            if (spendingHabits.score / spendingHabits.max > 0.8) insights.strengths.push("Great balance of essential vs. non-essential spending.");
            if (savingsRate.score / savingsRate.max > 0.8) insights.strengths.push("Fantastic! Your savings rate is improving.");
            if (insights.strengths.length === 0) insights.strengths.push("Getting started is the first step!");

            // Improvements & Tips
            let lowestCategory = 'budgetUsage';
            let lowestPercentage = (budgetUsage.score / budgetUsage.max);
            if ((spendingHabits.score / spendingHabits.max) < lowestPercentage) {
                lowestCategory = 'spendingHabits';
                lowestPercentage = spendingHabits.score / spendingHabits.max;
            }
            if ((savingsRate.score / savingsRate.max) < lowestPercentage) {
                lowestCategory = 'savingsRate';
            }
            
            if (lowestPercentage < 0.6) {
                switch(lowestCategory) {
                    case 'budgetUsage':
                        insights.improvements.push("Spending is outpacing your budget for this point in the month.");
                        insights.tip = "Try having a 'no-spend' day to get back on track.";
            break;
                    case 'spendingHabits':
                        insights.improvements.push("A high portion of spending is on non-essentials.");
                        insights.tip = "Review subscriptions or dining out for potential savings.";
            break;
                    case 'savingsRate':
                        insights.improvements.push("Currently not saving or saving less than last month.");
                        insights.tip = "Set a small, achievable savings goal for this month.";
            break;
    }
}
            if (insights.improvements.length === 0) insights.improvements.push("You're on the right track in all areas.");

            return insights;
        }

        function renderBudgetHealthScore(scoreData) {
            const { totalScore, breakdown, insights } = scoreData;

            // --- Render Visuals ---
            let scoreColor = 'var(--health-score-bad)';
            let scoreLabel = 'Poor';
            if (totalScore >= 70) {
                scoreColor = 'var(--health-score-good)';
                scoreLabel = 'Good';
            } else if (totalScore >= 40) {
                scoreColor = 'var(--health-score-ok)';
                scoreLabel = 'Okay';
            }
            
            DOMElements.healthScoreVisual.innerHTML = `
                <svg class="w-full h-full" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="${DOMElements.html.classList.contains('dark') ? 'var(--bg-tertiary)' : '#e6e6e6'}" stroke-width="3" />
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="${scoreColor}" stroke-width="3" stroke-dasharray="${totalScore}, 100" stroke-linecap="round"
                          style="transition: stroke-dasharray 1s ease-out;" />
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold" style="color: ${scoreColor};">${totalScore}</span>
                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">${scoreLabel}</span>
                    </div>
            `;
            
            // --- Render Trend ---
            let trendHtml = '';
            if (scoreData.lastMonthScore !== undefined) {
                const diff = totalScore - scoreData.lastMonthScore;
                if (diff > 0) {
                    trendHtml = `<span class="text-green-500 flex items-center justify-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        Up from ${scoreData.lastMonthScore}
                    </span>`;
                } else if (diff < 0) {
                    trendHtml = `<span class="text-red-500 flex items-center justify-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                        Down from ${scoreData.lastMonthScore}
                    </span>`;
                } else {
                    trendHtml = `<span>- Same as last month</span>`;
                }
            }
            DOMElements.healthScoreTrend.innerHTML = trendHtml;
            
            // --- Render Tooltip ---
            const renderProgressBar = (value, max) => {
                const percentage = (value / max) * 100;
                return `
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
            };

            DOMElements.healthScoreTooltip.innerHTML = `
                <div class="font-bold text-base mb-2 text-center">Your Score: ${totalScore}/100</div>
                <div class="space-y-3">
                <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-semibold">Budget Usage</span>
                            <span class="text-xs font-medium">${breakdown.budgetUsage.score}/${breakdown.budgetUsage.max} pts</span>
                    </div>
                        ${renderProgressBar(breakdown.budgetUsage.score, breakdown.budgetUsage.max)}
                </div>
                <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-semibold">Spending Habits</span>
                            <span class="text-xs font-medium">${breakdown.spendingHabits.score}/${breakdown.spendingHabits.max} pts</span>
                </div>
                        ${renderProgressBar(breakdown.spendingHabits.score, breakdown.spendingHabits.max)}
                    </div>
                            <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-semibold">Savings Rate</span>
                            <span class="text-xs font-medium">${breakdown.savingsRate.score}/${breakdown.savingsRate.max} pts</span>
                            </div>
                        ${renderProgressBar(breakdown.savingsRate.score, breakdown.savingsRate.max)}
                    </div>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-600 my-3"></div>
                        <div>
                    <h4 class="font-semibold text-green-600 dark:text-green-400">Strengths</h4>
                    <ul class="list-disc list-inside text-xs">${insights.strengths.map(s => `<li>${s}</li>`).join('')}</ul>
                        </div>
                <div class="mt-2">
                    <h4 class="font-semibold text-yellow-600 dark:text-yellow-400">Areas to Improve</h4>
                    <ul class="list-disc list-inside text-xs">${insights.improvements.map(i => `<li>${i}</li>`).join('')}</ul>
                    </div>
                <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 text-center">
                    <span class="font-semibold">ðŸ’¡ Tip:</span>
                    <span class="text-xs italic">${insights.tip}</span>
            </div>
        `;
        }

        function updateBudgetHealthScore(totalSpent, budget, monthlyExpenses, totalMonthlyIncome, now) {
            const breakdown = {
                budgetUsage: calculateBudgetUsageScore(totalSpent, budget, now),
                spendingHabits: calculateSpendingHabitsScore(monthlyExpenses, totalSpent),
                savingsRate: calculateSavingsRateScore(totalSpent, totalMonthlyIncome, now)
            };
            const totalScore = Math.round(breakdown.budgetUsage.score + breakdown.spendingHabits.score + breakdown.savingsRate.score);
            
            const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            healthScoreHistory[currentMonthKey] = totalScore;
            saveData();
            
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthKey = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
            
            const scoreData = {
                totalScore,
                breakdown,
                lastMonthScore: healthScoreHistory[lastMonthKey],
                insights: generateHealthScoreInsights({ breakdown }, totalSpent, monthlyExpenses, totalMonthlyIncome)
            };

            renderBudgetHealthScore(scoreData);
        }

        function predictMonthEndSpending(totalSpent, now) {
            if (totalSpent <= 0) {
                return { projectedSpend: 0, statusText: '', statusColor: '' };
            }
            const dayOfMonth = now.getDate();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const avgDailySpend = totalSpent / dayOfMonth;
            const projectedSpend = avgDailySpend * daysInMonth;

            const budgetUsage = projectedSpend / monthlyBudget;
            let statusText = 'On Track';
            let statusColor = 'text-green-700 dark:text-green-400';

            if (budgetUsage > 1.1) {
                statusText = 'Exceeding Budget';
                statusColor = 'text-red-700 dark:text-red-400';
            } else if (budgetUsage > 0.95) {
                statusText = 'At Risk';
                statusColor = 'text-yellow-600 dark:text-yellow-400';
            }
            return { projectedSpend, statusText, statusColor };
        }
        
        function getExpensesForMonth(year, month) {
            return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate.getFullYear() === year && expenseDate.getMonth() === month;
            });
        }

        function renderRecentExpenses() {
            DOMElements.recentExpensesContainer.innerHTML = '';
            const recent = expenses
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recent.length === 0) {
                DOMElements.recentExpensesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">No recent expenses.</p>';
                return;
            }
            recent.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center border-b border-gray-100 dark:border-gray-700 py-2 last:border-b-0 text-xs';
                div.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-900 dark:text-gray-600">${escapeHTML(expense.name)}</p>
                        <p class="text-gray-700 dark:text-gray-500">${expense.date} - ${escapeHTML(expense.category)}</p>
                    </div>
                    <p class="font-medium text-red-600 dark:text-red-400">${formatCurrency(expense.cost)}</p>
                `;
                DOMElements.recentExpensesContainer.appendChild(div);
            });
        }

        function renderExpensesTable() {
            console.log('=== PAGINATION DEBUG START ===');
            console.log('Current page:', window.expensesCurrentPage || 1);
            console.log('Items per page:', window.expensesItemsPerPage || 15);
            
            let allExpenses = [...expenses];
            console.log('Total expenses:', allExpenses.length);

            // Apply filters
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            const filteredExpenses = allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                if (typeFilter && e.type !== typeFilter && !(typeFilter === 'Recurring' && e.recurringSourceId)) passes = false;
                return passes;
            });

            console.log('Filtered expenses:', filteredExpenses.length);

            // Sort filtered expenses
            filteredExpenses.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                const getNumericId = (id) => {
                    if (typeof id === 'string') {
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return id;
                };
                
                return getNumericId(b.id) - getNumericId(a.id);
            });

            const tableBody = DOMElements.expensesTableBody;
            if (filteredExpenses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500 dark:text-gray-400">No expenses match your filters.</td></tr>`;
                document.getElementById('expenses-pagination').style.display = 'none';
                console.log('=== PAGINATION DEBUG END (no data) ===');
                return;
            }

            // SIMPLE PAGINATION - NO COMPLEX LOGIC
            const currentPage = window.expensesCurrentPage || 1;
            const itemsPerPage = window.expensesItemsPerPage || 15;
            const totalItems = filteredExpenses.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageItems = filteredExpenses.slice(startIndex, endIndex);

            console.log('PAGINATION CALCULATION:');
            console.log('- Total items:', totalItems);
            console.log('- Current page:', currentPage);
            console.log('- Items per page:', itemsPerPage);
            console.log('- Total pages:', totalPages);
            console.log('- Start index:', startIndex);
            console.log('- End index:', endIndex);
            console.log('- Page items count:', pageItems.length);

            // Update pagination display
            const pagination = document.getElementById('expenses-pagination');
            if (pagination) {
                pagination.style.display = 'flex';
                
                const pageInfo = document.getElementById('expenses-page-info');
                if (pageInfo) {
                    pageInfo.textContent = `${startIndex + 1}-${endIndex} of ${totalItems}`;
                }
                
                const pageInput = document.getElementById('expenses-page-input');
                if (pageInput) {
                    pageInput.value = currentPage;
                    pageInput.max = totalPages;
                }
                
                const totalPagesSpan = document.getElementById('expenses-total-pages');
                if (totalPagesSpan) {
                    totalPagesSpan.textContent = `of ${totalPages}`;
                }
                
                // Update buttons
                const prevBtn = document.getElementById('expenses-prev-btn');
                const nextBtn = document.getElementById('expenses-next-btn');
                const firstBtn = document.getElementById('expenses-first-btn');
                const lastBtn = document.getElementById('expenses-last-btn');
                
                if (prevBtn) prevBtn.disabled = currentPage <= 1;
                if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
                if (firstBtn) firstBtn.disabled = currentPage <= 1;
                if (lastBtn) lastBtn.disabled = currentPage >= totalPages;
            }

            tableBody.innerHTML = pageItems.map(expense => {
                const isRecurringInstance = !!expense.recurringSourceId;
                const isCancelled = expense.status === 'cancelled';
                const originalRecurringItem = isRecurringInstance ? recurringItems.find(r => r.id === expense.recurringSourceId) : null;

                let editAction = `editExpense(${expense.id})`;
                if (isRecurringInstance && originalRecurringItem) {
                    editAction = `editRecurring(${originalRecurringItem.id})`;
                }
                
                const deleteAction = isRecurringInstance ? 'return false;' : `deleteExpense(${expense.id})`;
                const checkboxId = `expense-${expense.id}`;

                // Better status text for mobile
                let statusText = 'Active';
                if (isCancelled) {
                    statusText = 'Cancelled';
                } else if (isRecurringInstance) {
                    statusText = 'Recurring';
                }

                // Format date for better display
                const formattedDate = new Date(expense.date).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                return `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 ${isCancelled ? 'opacity-60' : ''}">
                        <td class="px-4 py-3" data-label="">
                            <input type="checkbox" id="${checkboxId}" data-id="${expense.id}" onchange="toggleExpenseSelection(this, '${expense.id}')" 
                            class="table-checkbox expense-checkbox" ${isRecurringInstance ? 'disabled' : ''} ${selectedExpenseIds.has(expense.id.toString()) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap" data-label="Name">
                            <span>${escapeHTML(expense.name)}</span>${isRecurringInstance ? '<span class="text-xs text-gray-400 ml-1">(R)</span>' : ''}
                        </td>
                        <td class="px-6 py-3" data-label="Amount">${formatCurrency(expense.cost)}</td>
                        <td class="px-6 py-3" data-label="Date">${formattedDate}</td>
                        <td class="px-6 py-3 hidden md:table-cell" data-label="Category">${escapeHTML(expense.category)}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Payment Method">${escapeHTML(expense.paymentMethod) || '-'}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Type">${escapeHTML(expense.type)}</td>
                        <td class="px-6 py-3 text-right" data-label="Actions">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="${editAction}" title="Edit" class="icon-button" ${isCancelled ? 'disabled' : ''} ${isCancelled ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="${deleteAction}" title="Delete" class="icon-button text-red-600/80 hover:text-red-500" ${isRecurringInstance ? 'disabled' : ''} ${isRecurringInstance ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
        </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('Table rendered with', pageItems.length, 'items');
            console.log('=== PAGINATION DEBUG END ===');
        }

        window.renderRecurringTable = function renderRecurringTable() {
            DOMElements.recurringTableBody.innerHTML = '';
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;

            let filtered = recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });

            // Fix: Sort by ID (newest first) since ID is timestamp-based
            filtered.sort((a, b) => b.id - a.id);

            if (filtered.length === 0) {
                DOMElements.recurringTableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                updateRecurringPagination(0, 0);
                return;
            }

            // Calculate pagination
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / window.recurringItemsPerPage);
            const startIndex = (window.recurringCurrentPage - 1) * window.recurringItemsPerPage;
            const endIndex = startIndex + window.recurringItemsPerPage;
            const pageItems = filtered.slice(startIndex, endIndex);

            // Update pagination controls
            updateRecurringPagination(totalItems, totalPages);

            // Clear table first
            DOMElements.recurringTableBody.innerHTML = '';

            pageItems.forEach(item => {
                const tr = document.createElement('tr');
                const isSelected = selectedRecurringIds.has(item.id);
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${item.status === 'cancelled' ? 'opacity-60' : ''} ${isSelected ? 'bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800'}`;
                const itemTypeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

                // Format start date for better display
                const formattedStartDate = new Date(item.startDate).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                tr.innerHTML = `
                    <td class="px-4 py-4 w-1" data-label=""><input type="checkbox" data-id="${item.id}" onchange="toggleRecurringSelection(this, ${item.id})" class="table-checkbox recurring-checkbox" ${isSelected ? 'checked' : ''}></td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white" data-label="Name">${escapeHTML(item.name)}</td>
                    <td class="px-6 py-4 capitalize" data-label="Type">${item.type}</td>
                    <td class="px-6 py-4 font-medium ${itemTypeClass}" data-label="Amount">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4" data-label="Frequency">${item.frequency}</td>
                    <td class="px-6 py-4" data-label="Start Date">${formattedStartDate}</td>
                    <td class="px-6 py-4 hidden lg:table-cell" data-label="Category">${escapeHTML(item.category)}</td>
                    <td class="px-6 py-4" data-label="Status"><span class="status-badge ${item.status === 'active' ? 'status-active' : 'status-cancelled'}">${item.status}</span></td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap" data-label="Actions">
                        <button onclick="editRecurring(${item.id})" class="icon-button" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        <button onclick="toggleRecurringStatus(${item.id})" class="icon-button" title="${item.status === 'active' ? 'Pause' : 'Resume'}">
                           ${item.status === 'active' ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                           }
                        </button>
                        <button onclick="deleteRecurring(${item.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </td>
                `;
                DOMElements.recurringTableBody.appendChild(tr);
            });
        }

        // --- Pagination Functions ---
        function updateExpensesPagination(totalItems, totalPages) {
            const pageInfo = document.getElementById('expenses-page-info');
            const prevBtn = document.getElementById('expenses-prev-btn');
            const nextBtn = document.getElementById('expenses-next-btn');
            const firstBtn = document.getElementById('expenses-first-btn');
            const lastBtn = document.getElementById('expenses-last-btn');
            const pageInput = document.getElementById('expenses-page-input');
            const totalPagesSpan = document.getElementById('expenses-total-pages');
            const pagination = document.getElementById('expenses-pagination');

            console.log('updateExpensesPagination called:', { totalItems, totalPages, currentPage: expensesCurrentPage });

            if (totalItems === 0) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            
            const startItem = (window.expensesCurrentPage - 1) * window.expensesItemsPerPage + 1;
            const endItem = Math.min(window.expensesCurrentPage * window.expensesItemsPerPage, totalItems);
            
            pageInfo.textContent = `${startItem}-${endItem} of ${totalItems}`;
            
            // Update page input and total pages
            pageInput.value = window.expensesCurrentPage;
            pageInput.max = totalPages;
            totalPagesSpan.textContent = `of ${totalPages}`;
            
            // Update button states
            prevBtn.disabled = window.expensesCurrentPage <= 1;
            nextBtn.disabled = window.expensesCurrentPage >= totalPages;
            firstBtn.disabled = window.expensesCurrentPage <= 1;
            lastBtn.disabled = window.expensesCurrentPage >= totalPages;
            
            console.log('Pagination UI updated:', { startItem, endItem, totalItems });
        }

        function updateRecurringPagination(totalItems, totalPages) {
            const pageInfo = document.getElementById('recurring-page-info');
            const prevBtn = document.getElementById('recurring-prev-btn');
            const nextBtn = document.getElementById('recurring-next-btn');
            const firstBtn = document.getElementById('recurring-first-btn');
            const lastBtn = document.getElementById('recurring-last-btn');
            const pageInput = document.getElementById('recurring-page-input');
            const totalPagesSpan = document.getElementById('recurring-total-pages');
            const pagination = document.getElementById('recurring-pagination');

            if (totalItems === 0) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            
            const startItem = (window.recurringCurrentPage - 1) * window.recurringItemsPerPage + 1;
            const endItem = Math.min(window.recurringCurrentPage * window.recurringItemsPerPage, totalItems);
            
            pageInfo.textContent = `${startItem}-${endItem} of ${totalItems}`;
            
            // Update page input and total pages
            pageInput.value = window.recurringCurrentPage;
            pageInput.max = totalPages;
            totalPagesSpan.textContent = `of ${totalPages}`;
            
            // Update button states
            prevBtn.disabled = window.recurringCurrentPage <= 1;
            nextBtn.disabled = window.recurringCurrentPage >= totalPages;
            firstBtn.disabled = window.recurringCurrentPage <= 1;
            lastBtn.disabled = window.recurringCurrentPage >= totalPages;
        }

        // SIMPLE PAGINATION FUNCTIONS
        window.changeExpensesPage = function(direction) {
            console.log('changeExpensesPage called with:', direction);
            if (direction === 'prev' && (window.expensesCurrentPage || 1) > 1) {
                window.expensesCurrentPage = (window.expensesCurrentPage || 1) - 1;
            } else if (direction === 'next') {
                window.expensesCurrentPage = (window.expensesCurrentPage || 1) + 1;
            }
            console.log('New page:', window.expensesCurrentPage);
            renderExpensesTable();
        }

        window.changeRecurringPage = function(direction) {
            if (direction === 'prev' && window.recurringCurrentPage > 1) {
                window.recurringCurrentPage--;
            } else if (direction === 'next') {
                window.recurringCurrentPage++;
            }
            renderRecurringTable();
        }

        window.changeExpensesPerPage = function(value) {
            console.log('changeExpensesPerPage called with:', value);
            window.expensesItemsPerPage = parseInt(value) || 15;
            window.expensesCurrentPage = 1;
            console.log('Items per page set to:', window.expensesItemsPerPage);
            renderExpensesTable();
        }

        window.changeRecurringPerPage = function(value) {
            window.recurringItemsPerPage = parseInt(value);
            window.recurringCurrentPage = 1; // Reset to first page
            renderRecurringTable();
        }

        window.goToExpensesPage = function(target) {
            console.log('goToExpensesPage called with:', target);
            
            // Simple approach - don't overcomplicate
            if (target === 'first') {
                window.expensesCurrentPage = 1;
            } else if (target === 'last') {
                // Calculate total pages on the fly
                const totalItems = expenses.length; // Use simple total for now
                const totalPages = Math.ceil(totalItems / (window.expensesItemsPerPage || 15));
                window.expensesCurrentPage = totalPages;
            } else {
                const page = parseInt(target);
                if (page >= 1) {
                    window.expensesCurrentPage = page;
                }
            }
            console.log('Going to page:', window.expensesCurrentPage);
            renderExpensesTable();
        }

        window.goToRecurringPage = function(target) {
            const filteredRecurring = getFilteredRecurring(); // We need this to calculate total pages
            const totalPages = Math.ceil(filteredRecurring.length / window.recurringItemsPerPage);
            
            if (target === 'first') {
                window.recurringCurrentPage = 1;
            } else if (target === 'last') {
                window.recurringCurrentPage = totalPages;
            } else {
                const page = parseInt(target);
                if (page >= 1 && page <= totalPages) {
                    window.recurringCurrentPage = page;
                }
            }
            renderRecurringTable();
        }

        // Helper functions to get filtered data (extracted from render functions)
        function getFilteredExpenses() {
            let allExpenses = [...expenses];

            // Apply filters
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            return allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                
                // Fixed typeFilter logic
                if (typeFilter) {
                    if (typeFilter === 'Recurring') {
                        if (!e.recurringSourceId) passes = false;
                    } else {
                        if (e.type !== typeFilter) passes = false;
                    }
                }
                
                return passes;
            });
        }

        function getFilteredRecurring() {
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;

            return recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });
        }
        
        // --- Charting and Insights ---
        function updateChartsAndInsights() {
            renderSpendingTrendChart();
            renderCategorySpendingChart();
            renderMonthlySavingsChart();
            updateAiInsightsWithSmartAnalytics(); // NEW
        }

        const chartColors = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#06b6d4', '#d946ef', '#84cc16'];
        function getChartColors(count) {
            return Array.from({length: count}, (_, i) => chartColors[i % chartColors.length]);
        }

        function getChartOptions(isDarkMode) {
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { color: gridColor }, ticks: { color: textColor } },
                    y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, callback: value => formatCurrency(value, false) } }
                },
                plugins: {
                    legend: { labels: { color: textColor } },
                    tooltip: { titleFont: { weight: 'bold' }, bodyFont: {}, backgroundColor: isDarkMode ? '#334155' : '#ffffff', titleColor: isDarkMode ? '#f1f5f9' : '#1e293b', bodyColor: isDarkMode ? '#f1f5f9' : '#1e293b', borderColor: isDarkMode ? '#475569' : '#e2e8f0', borderWidth: 1 }
                }
            };
        }

        function renderSpendingTrendChart() {
            const ctx = DOMElements.spendingTrendCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const data = monthlyData.map(m => m.expenses);

            if (spendingTrendChart) spendingTrendChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            spendingTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: chartColors[2],
                        backgroundColor: chartColors[2] + '33',
                        tension: 0.2, fill: true, pointRadius: 3, pointHoverRadius: 5
                    }]
                },
                options: options
            });
        }

        function renderCategorySpendingChart() {
            const ctx = DOMElements.categorySpendingCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const data = monthlyData.map(m => m.expenses);
            
            if (categorySpendingChart) categorySpendingChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            categorySpendingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(d => d >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'),
                        borderColor: data.map(d => d >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }

        function renderMonthlySavingsChart() {
            const ctx = DOMElements.monthlySavingsCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const savingsData = monthlyData.map(m => m.income - m.expenses);

            if (monthlySavingsChart) monthlySavingsChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Savings: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            monthlySavingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: savingsData,
                        backgroundColor: savingsData.map(s => s >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'),
                        borderColor: savingsData.map(s => s >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }
        
        function getMonthlyIncomeAndExpenses(numMonths) {
            const data = [];
            for (let i = 0; i < numMonths; i++) {
                const date = new Date(new Date().setMonth(new Date().getMonth() - i));
                const year = date.getFullYear();
                const month = date.getMonth();
                
                // Get recurring income only (expenses are already in main array)
                const recurringIncome = getMonthlyRecurringTotals(year, month).income;
                
                data.push({
                    year: year,
                    month: month,
                    income: monthlyIncome + recurringIncome,
                    expenses: getMonthlyExpenseTotal(year, month)
                });
            }
            return data.reverse();
        }


        function getNextDueDate(item, fromDate) {
            let nextDueDate = new Date(item.startDate + 'T00:00:00');
            
            if (nextDueDate >= fromDate) {
                return nextDueDate;
            }

            let iterations = 0;
            while (nextDueDate < fromDate && iterations < 1000) {
                switch (item.frequency) {
                    case 'Daily': nextDueDate.setDate(nextDueDate.getDate() + 1); break;
                    case 'Weekly': nextDueDate.setDate(nextDueDate.getDate() + 7); break;
                    case 'Bi-Weekly': nextDueDate.setDate(nextDueDate.getDate() + 14); break;
                    case 'Monthly': nextDueDate.setMonth(nextDueDate.getMonth() + 1); break;
                    case 'Quarterly': nextDueDate.setMonth(nextDueDate.getMonth() + 3); break;
                    case 'Annual': nextDueDate.setFullYear(nextDueDate.getFullYear() + 1); break;
                    default: return new Date('9999-12-31');
                }
                iterations++;
            }
            return nextDueDate;
        }

        
        // --- Utility Functions ---
        function formatCurrency(amount, useDecimals = true) {
            const { locale } = currencyConfig[currentCurrencyCode];
            const isInteger = !useDecimals || (amount % 1 === 0);
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: isInteger ? 0 : 2,
                maximumFractionDigits: isInteger ? 0 : 2
            };
            return new Intl.NumberFormat(locale, options).format(amount || 0);
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function showToast(message, type = 'success') {
            DOMElements.toast.textContent = message;
            DOMElements.toast.className = `toast show ${type === 'error' ? 'bg-red-600' : 'bg-gray-800 dark:bg-gray-200 dark:text-gray-800'}`;
            setTimeout(() => { DOMElements.toast.className = 'toast'; }, 3000);
        }

        // Plaid Integration Functions
        const BACKEND_URL = 'http://localhost:8000';  // Changed from 127.0.0.1 to localhost
        let plaidAccessToken = localStorage.getItem('plaid_access_token');

        // Also add this test function to verify connectivity
        async function testBackendConnection() {
            try {
                console.log('Testing backend connection...');
                const response = await fetch(`${BACKEND_URL}/health`);
                console.log('Health check response:', response.status, response.statusText);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Backend health:', data);
                    showToast('Backend connection successful!', 'success');
                } else {
                    throw new Error(`Health check failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Backend connection test failed:', error);
                showToast(`Backend connection failed: ${error.message}`, 'error');
            }
        }

        // Call this function in console to test: testBackendConnection()

        async function connectBankAccount() {
            try {
                const connectBtn = document.getElementById('connect-bank-btn');
                connectBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Connecting...</span>';
                
                // Get link token from backend
                const linkTokenResponse = await fetch(`${BACKEND_URL}/api/create_link_token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!linkTokenResponse.ok) {
                    throw new Error('Failed to create link token');
                }
                
                const { link_token } = await linkTokenResponse.json();
                
                // Initialize Plaid Link
                const handler = Plaid.create({
                    token: link_token,
                    onSuccess: async (public_token, metadata) => {
                        try {
                            await exchangePublicToken(public_token);
                            showToast('Bank account connected successfully!');
                            connectBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Connected âœ“</span>';
                            document.getElementById('import-transactions-btn').style.display = 'flex';
                        } catch (error) {
                            console.error('Error exchanging token:', error);
                            showToast('Failed to connect bank account', 'error');
                            resetConnectButton();
                        }
                    },
                    onLoad: () => {
                        // Handle loading
                    },
                    onExit: (err, metadata) => {
                        if (err != null) {
                            console.error('Plaid Link error:', err);
                            showToast('Bank connection cancelled', 'error');
                        }
                        resetConnectButton();
                    },
                    onEvent: (eventName, metadata) => {
                        // Handle events
                    }
                });
                
                handler.open();
                
            } catch (error) {
                console.error('Error connecting bank account:', error);
                showToast('Failed to connect bank account', 'error');
                resetConnectButton();
            }
        }

        async function exchangePublicToken(publicToken) {
            const response = await fetch(`${BACKEND_URL}/api/exchange_public_token`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ public_token: publicToken })
            });
            
            if (!response.ok) {
                throw new Error('Failed to exchange public token');
            }
            
            const { access_token } = await response.json();
            plaidAccessToken = access_token;
            localStorage.setItem('plaid_access_token', access_token);
            
            // Import transactions immediately after connecting
            await importBankTransactions();
        }

        async function importBankTransactions() {
            if (!plaidAccessToken) {
                showToast('No bank account connected', 'error');
                return;
            }
            
            try {
                console.log('Starting transaction import with token:', plaidAccessToken);
                console.log('Backend URL:', BACKEND_URL);
                
                // Add timeout and better error handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(`${BACKEND_URL}/api/transactions`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ access_token: plaidAccessToken }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('Backend response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const responseData = await response.json();
                console.log('Backend response data:', responseData);
                
                const { transactions } = responseData;
                console.log('Transactions received:', transactions?.length, transactions);
                
                if (!transactions || !Array.isArray(transactions)) {
                    throw new Error('Invalid transactions data received');
                }
                
                const importedCount = processPlaidTransactions(transactions);
                console.log('Imported count:', importedCount);
                
                if (importedCount > 0) {
                    showToast(`Imported ${importedCount} new transactions from your bank`);
                    updateDisplay();
                    
                    // Close settings modal and navigate to expenses page
                    document.getElementById('settings-modal').classList.add('hidden');
                    showTab('expenses');
                } else {
                    showToast('No new transactions to import');
                    
                    // Still close settings and go to expenses even if no new transactions
                    document.getElementById('settings-modal').classList.add('hidden');
                    showTab('expenses');
                }
                
            } catch (error) {
                console.error('Error importing transactions:', error);
                
                if (error.name === 'AbortError') {
                    showToast('Request timeout - please try again', 'error');
                } else if (error instanceof TypeError && error.message.includes('fetch')) {
                    showToast('Network error - check if backend is running', 'error');
                } else {
                    showToast(`Failed to import transactions: ${error.message}`, 'error');
                }
            }
        }

        function processPlaidTransactions(plaidTransactions) {
            console.log('Processing Plaid transactions:', plaidTransactions);
            let importedCount = 0;
            const existingTransactionIds = new Set(expenses.map(e => e.plaidId).filter(id => id));
            console.log('Existing transaction IDs:', existingTransactionIds);
            
            for (const transaction of plaidTransactions) {
                console.log('Processing transaction:', transaction);
                
                // Skip if we already have this transaction
                if (existingTransactionIds.has(transaction.transaction_id)) {
                    console.log('Skipping duplicate transaction:', transaction.transaction_id);
                    continue;
                }
                
                const transformedExpense = transformPlaidTransaction(transaction);
                console.log('Transformed expense:', transformedExpense);
                
                expenses.push(transformedExpense);
                importedCount++;
            }
            
            console.log('Total expenses after import:', expenses.length);
            console.log('Imported count:', importedCount);
            
            if (importedCount > 0) {
                saveData();
                generateEnhancedPointsOptimization(expenses); // Replace existing call
                updateGoalImpactDisplay(); // Add this new call
            }
            
            return importedCount;
        }

        function transformPlaidTransaction(transaction) {
            // Map Plaid categories to app categories
            const categoryMap = {
                'Food and Drink': 'Food/Drink',
                'Shops': 'Shopping',
                'Transportation': 'Transport',
                'Healthcare': 'Health',
                'Entertainment': 'Entertainment',
                'Travel': 'Transport',
                'Bills': 'Utilities',
                'Transfer': 'Other',
                'Restaurants': 'Food/Drink',
                'Public Transportation': 'Transport',
                'Digital Purchase': 'Shopping',
                'Supermarkets and Groceries': 'Shopping'
            };
            
            // Get the first (most specific) category from Plaid
            const plaidCategory = transaction.category?.[0] || 'Other';
            const appCategory = categoryMap[plaidCategory] || 'Other';
            
            // Extract clean merchant name
            let merchantName = transaction.merchant_name || transaction.name || 'Unknown';
            // Remove common bank transaction prefixes
            merchantName = merchantName.replace(/^(CARD PURCHASE |DEBIT CARD |ATM |)/, '');
            
            // Determine expense type based on category
            const essentialCategories = ['Transport', 'Utilities', 'Health'];
            const expenseType = essentialCategories.includes(appCategory) ? 'Essential' : 'Non-Essential';
            
            return {
                id: Date.now() + Math.random(),
                plaidId: transaction.transaction_id,
                name: merchantName,
                cost: Math.abs(transaction.amount), // Ensure positive number
                type: expenseType,
                category: appCategory,
                date: transaction.date,
                paymentMethod: 'Bank Account',
                status: 'active',
                source: 'plaid'
            };
        }

        // Enhanced Points Optimization System
        class PointsOptimizationEngine {
            constructor() {
                // Credit card rewards mapping
                this.cardRewards = {
                    'amex_gold': {
                        name: 'Amex Gold',
                        categories: {
                            'Food & Drink': 4, // 4x points
                            'Shopping': 1,
                            'Transport': 1,
                            'default': 1
                        }
                    },
                    'amex_green': {
                        name: 'Amex Green',
                        categories: {
                            'Transport': 3, // 3x points  
                            'Food & Drink': 1,
                            'Shopping': 1,
                            'default': 1
                        }
                    },
                    'virgin_red': {
                        name: 'Virgin Red',
                        categories: {
                            'Shopping': 3, // 3x points at certain retailers
                            'Transport': 2, // 2x for Virgin services
                            'Food & Drink': 1,
                            'default': 1
                        }
                    }
                };
                
                // Points value in GBP (conservative estimates)
                this.pointValues = {
                    'amex': 0.005, // Â£0.005 per point
                    'virgin': 0.01, // Â£0.01 per point
                    'ana': 0.012   // Â£0.012 per mile
                };
            }
            
            // Analyze a transaction for point optimization opportunities
            analyzeTransaction(transaction) {
                const opportunities = [];
                const amount = transaction.cost;
                const category = transaction.category;
                
                // Find best card for this transaction
                let bestCard = null;
                let bestPoints = 0;
                let bestValue = 0;
                
                for (const [cardId, card] of Object.entries(this.cardRewards)) {
                    const pointsRate = card.categories[category] || card.categories.default;
                    const potentialPoints = Math.floor(amount * pointsRate);
                    const pointValue = potentialPoints * this.pointValues.amex; // Assuming Amex for now
                    
                    if (pointValue > bestValue) {
                        bestCard = card;
                        bestPoints = potentialPoints;
                        bestValue = pointValue;
                    }
                }
                
                // If transaction was made with suboptimal method, flag opportunity
                if (transaction.paymentMethod === 'Bank Account' || transaction.paymentMethod === 'Debit Card') {
                    opportunities.push({
                        type: 'missed_points',
                        transaction_id: transaction.id,
                        merchant: transaction.name,
                        amount: amount,
                        category: category,
                        date: transaction.date,
                        recommended_card: bestCard.name,
                        potential_points: bestPoints,
                        potential_value: bestValue,
                        message: `Could have earned ${bestPoints} points (worth Â£${bestValue.toFixed(2)}) using ${bestCard.name}`
                    });
                }
                
                return opportunities;
            }
            
            // Analyze all transactions for optimization opportunities
            analyzeAllTransactions(transactions) {
                const allOpportunities = [];
                let totalMissedValue = 0;
                
                transactions.forEach(transaction => {
                    if (transaction.source === 'plaid') { // Only analyze imported transactions
                        const opportunities = this.analyzeTransaction(transaction);
                        allOpportunities.push(...opportunities);
                        
                        opportunities.forEach(opp => {
                            totalMissedValue += opp.potential_value;
                        });
                    }
                });
                
                return {
                    opportunities: allOpportunities,
                    totalMissedValue: totalMissedValue,
                    summary: this.generateOptimizationSummary(allOpportunities)
                };
            }
            
            // Generate merchant-specific recommendations
            generateMerchantRecommendations(transactions) {
                const merchantSpending = {};
                
                // Group spending by merchant
                transactions.forEach(transaction => {
                    if (transaction.source === 'plaid') {
                        const merchant = transaction.name;
                        if (!merchantSpending[merchant]) {
                            merchantSpending[merchant] = {
                                total: 0,
                                count: 0,
                                category: transaction.category,
                                transactions: []
                            };
                        }
                        merchantSpending[merchant].total += transaction.cost;
                        merchantSpending[merchant].count += 1;
                        merchantSpending[merchant].transactions.push(transaction);
                    }
                });
                
                // Generate recommendations for top merchants
                const recommendations = [];
                const topMerchants = Object.entries(merchantSpending)
                    .sort(([,a], [,b]) => b.total - a.total)
                    .slice(0, 5);
                    
                topMerchants.forEach(([merchant, data]) => {
                    const bestCard = this.getBestCardForCategory(data.category);
                    const monthlyPoints = Math.floor(data.total * bestCard.pointsRate);
                    const monthlyValue = monthlyPoints * this.pointValues.amex;
                    
                    recommendations.push({
                        merchant: merchant,
                        monthlySpending: data.total,
                        recommendedCard: bestCard.name,
                        monthlyPoints: monthlyPoints,
                        monthlyValue: monthlyValue,
                        annualValue: monthlyValue * 12
                    });
                });
                
                return recommendations;
            }
            
            // Get best card for a category
            getBestCardForCategory(category) {
                let bestCard = { name: 'Amex Gold', pointsRate: 1 };
                let bestRate = 1;
                
                for (const [cardId, card] of Object.entries(this.cardRewards)) {
                    const rate = card.categories[category] || card.categories.default;
                    if (rate > bestRate) {
                        bestCard = { name: card.name, pointsRate: rate };
                        bestRate = rate;
                    }
                }
                
                return bestCard;
            }
            
            // Generate summary insights
            generateOptimizationSummary(opportunities) {
                if (opportunities.length === 0) {
                    return "Great job! You're already optimizing your spending.";
                }
                
                const totalValue = opportunities.reduce((sum, opp) => sum + opp.potential_value, 0);
                const topCategory = this.getTopMissedCategory(opportunities);
                
                return {
                    totalMissedValue: totalValue,
                    monthlyPotential: totalValue,
                    annualPotential: totalValue * 12,
                    topRecommendation: `Switch to optimized cards for ${topCategory} spending`,
                    quickWin: `Start using the right card for your top spending categories`
                };
            }
            
            // Get category with most missed value
            getTopMissedCategory(opportunities) {
                const categoryTotals = {};
                
                opportunities.forEach(opp => {
                    if (!categoryTotals[opp.category]) {
                        categoryTotals[opp.category] = 0;
                    }
                    categoryTotals[opp.category] += opp.potential_value;
                });
                
                return Object.entries(categoryTotals)
                    .sort(([,a], [,b]) => b - a)[0]?.[0] || 'General';
            }
        }

        // Initialize the points optimization engine
        const pointsEngine = new PointsOptimizationEngine();

        // Enhanced function to replace existing generatePointsOptimizationSuggestions
        function generateEnhancedPointsOptimization(transactions) {
            const analysis = pointsEngine.analyzeAllTransactions(transactions);
            const merchantRecs = pointsEngine.generateMerchantRecommendations(transactions);
            
            // Store enhanced insights
            localStorage.setItem('pointsAnalysis', JSON.stringify(analysis));
            localStorage.setItem('merchantRecommendations', JSON.stringify(merchantRecs));
            localStorage.setItem('pointsOptimizationSuggestions', JSON.stringify(analysis.opportunities));
            
            console.log('Enhanced points analysis:', analysis);
            console.log('Merchant recommendations:', merchantRecs);
            
            return analysis;
        }

        // Legacy function for backward compatibility
        function generatePointsOptimizationSuggestions(transactions) {
            return generateEnhancedPointsOptimization(expenses);
        }

        function resetConnectButton() {
            const connectBtn = document.getElementById('connect-bank-btn');
            connectBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg><span>Connect Bank Account</span>';
        }

        // Enhanced Insights Dashboard Display Functions
        function renderEnhancedInsights() {
            const pointsAnalysis = JSON.parse(localStorage.getItem('pointsAnalysis') || '{"opportunities": [], "totalMissedValue": 0}');
            const merchantRecs = JSON.parse(localStorage.getItem('merchantRecommendations') || '[]');
            
            // Only render if there are opportunities to show
            if (pointsAnalysis.opportunities && pointsAnalysis.opportunities.length > 0) {
                // Create a dedicated section for points insights if it doesn't exist
                let pointsSection = document.getElementById('points-optimization-section');
                if (!pointsSection) {
                    pointsSection = document.createElement('div');
                    pointsSection.id = 'points-optimization-section';
                    
                    // Insert before the smart recommendations
                    const smartRecommendationsContainer = document.getElementById('smart-recommendations');
                    if (smartRecommendationsContainer && smartRecommendationsContainer.parentNode) {
                        smartRecommendationsContainer.parentNode.insertBefore(pointsSection, smartRecommendationsContainer);
                    }
                }
                
                // Render the points insights
                pointsSection.innerHTML = renderPointsOptimizationInsights(pointsAnalysis, merchantRecs);
                
                // Badge will be updated by the main insights function
            }
        }

        function renderPointsOptimizationInsights(analysis, merchantRecs) {
            if (analysis.opportunities.length === 0) {
                return `
                    <div class="text-center p-6 bg-green-50 dark:bg-green-900/20 rounded-lg mb-4">
                        <div class="text-2xl mb-2">ðŸŽ¯</div>
                        <h3 class="font-semibold text-green-800 dark:text-green-200 mb-2">Perfect Optimization!</h3>
                        <p class="text-sm text-green-600 dark:text-green-300">You're already maximizing your points potential.</p>
                    </div>
                `;
            }
            
            const totalMissed = analysis.totalMissedValue;
            const annualPotential = totalMissed * 12;
            
            return `
                <!-- Points Optimization Summary Card -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="text-2xl">ðŸ’³</div>
                            <div>
                                <h3 class="font-semibold text-gray-800 dark:text-gray-200">Points Optimization</h3>
                                <p class="text-xs text-gray-600 dark:text-gray-400">Based on your spending patterns</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-purple-600 dark:text-purple-400">Â£${totalMissed.toFixed(2)}</div>
                            <div class="text-xs text-gray-500">potential monthly</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-3">
                            <div class="text-sm font-semibold text-gray-800 dark:text-gray-200">Monthly Potential</div>
                            <div class="text-lg font-bold text-green-600">Â£${totalMissed.toFixed(2)}</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-3">
                            <div class="text-sm font-semibold text-gray-800 dark:text-gray-200">Annual Potential</div>
                            <div class="text-lg font-bold text-blue-600">Â£${annualPotential.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Opportunities -->
                <div class="space-y-3 mb-4">
                    <h4 class="font-semibold text-gray-800 dark:text-gray-200 text-sm">ðŸŽ¯ Top Opportunities</h4>
                    ${analysis.opportunities.slice(0, 3).map(opp => `
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-100 dark:border-gray-700">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800 dark:text-gray-200">${opp.merchant}</div>
                                    <div class="text-xs text-gray-500">${opp.category} â€¢ ${opp.date}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-green-600">Â£${opp.potential_value.toFixed(2)}</div>
                                    <div class="text-xs text-gray-500">${opp.potential_points} points</div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                ðŸ’¡ ${opp.message}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Merchant Recommendations -->
                ${merchantRecs.length > 0 ? `
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 text-sm mb-3">ðŸª Your Top Merchants</h4>
                        <div class="space-y-2">
                            ${merchantRecs.slice(0, 3).map(rec => `
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-100 dark:border-gray-700">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-medium text-gray-800 dark:text-gray-200">${rec.merchant}</div>
                                            <div class="text-xs text-gray-500">Monthly: Â£${rec.monthlySpending.toFixed(2)}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold text-blue-600">${rec.recommendedCard}</div>
                                            <div class="text-xs text-green-600">+Â£${rec.monthlyValue.toFixed(2)}/month</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Action Button -->
                <div class="mb-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="showDetailedOptimization()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors">
                        View Detailed Analysis
                    </button>
                </div>
            `;
        }


        function showDetailedOptimization() {
            const analysis = JSON.parse(localStorage.getItem('pointsAnalysis') || '{"opportunities": []}');
            const merchantRecs = JSON.parse(localStorage.getItem('merchantRecommendations') || '[]');
            
            // Create a detailed modal or navigate to a detailed view
            console.log('Detailed optimization analysis:', { analysis, merchantRecs });
            
            // For now, show a detailed toast
            const totalAnnual = analysis.totalMissedValue * 12;
            showToast(`Annual optimization potential: Â£${totalAnnual.toFixed(2)}. Check console for details.`, 'info');
        }

        // Goal Impact Analysis System
        class GoalImpactAnalyzer {
            constructor() {
                this.pointValues = {
                    'amex': 0.005,
                    'virgin': 0.01,
                    'ana': 0.012
                };
            }
            
            // Calculate how spending affects goal timeline
            calculateGoalImpact(goals, transactions, pointsOptimization) {
                const goalImpacts = [];
                
                goals.forEach(goal => {
                    if (goal.status !== 'active') return;
                    
                    const monthlySpending = this.calculateMonthlySpending(transactions);
                    const monthlyPointsValue = this.calculateMonthlyPointsValue(pointsOptimization);
                    const currentSavings = goal.current || 0;
                    const targetAmount = goal.target;
                    const remainingAmount = targetAmount - currentSavings;
                    
                    console.log(`Goal ${goal.name}:`, {
                        type: goal.type,
                        current: currentSavings,
                        target: targetAmount,
                        remaining: remainingAmount,
                        monthlySpending,
                        monthlyPointsValue
                    });
                    
                    // Current trajectory (without optimization)
                    const monthlySavingsCurrent = this.estimateMonthlySavings(monthlySpending, goal.type);
                    const monthsToGoalCurrent = remainingAmount / (monthlySavingsCurrent || 1);
                    
                    console.log(`${goal.name} calculation:`, {
                        monthlySavingsCurrent,
                        monthsToGoalCurrent,
                        monthlyIncome: monthlyIncome || 0,
                        monthlyBudget: monthlyBudget || 0
                    });
                    
                    // Optimized trajectory (with points optimization)
                    const monthlySavingsOptimized = monthlySavingsCurrent + monthlyPointsValue;
                    const monthsToGoalOptimized = remainingAmount / monthlySavingsOptimized;
                    
                    // Time saved through optimization
                    const timeSavedMonths = monthsToGoalCurrent - monthsToGoalOptimized;
                    
                    goalImpacts.push({
                        goalId: goal.id,
                        goalName: goal.name,
                        goalType: goal.type,
                        target: targetAmount,
                        current: currentSavings,
                        remaining: remainingAmount,
                        progressPercent: (currentSavings / targetAmount) * 100,
                        
                        // Current trajectory
                        monthsToGoalCurrent: monthsToGoalCurrent,
                        completionDateCurrent: this.addMonthsToDate(new Date(), monthsToGoalCurrent),
                        
                        // Optimized trajectory  
                        monthsToGoalOptimized: monthsToGoalOptimized,
                        completionDateOptimized: this.addMonthsToDate(new Date(), monthsToGoalOptimized),
                        
                        // Impact metrics
                        timeSavedMonths: timeSavedMonths,
                        timeSavedDays: timeSavedMonths * 30,
                        monthlyPointsBoost: monthlyPointsValue,
                        annualPointsBoost: monthlyPointsValue * 12,
                        
                        // Recommendations
                        recommendations: this.generateGoalRecommendations(goal, monthlySpending, monthlyPointsValue)
                    });
                });
                
                return goalImpacts;
            }
            
            // Calculate monthly spending from transactions
            calculateMonthlySpending(transactions) {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                return transactions
                    .filter(t => {
                        const transactionDate = new Date(t.date);
                        return transactionDate.getMonth() === currentMonth && 
                               transactionDate.getFullYear() === currentYear &&
                               t.status === 'active';
                    })
                    .reduce((total, t) => total + t.cost, 0);
            }
            
            // Calculate monthly points value from optimization opportunities
            calculateMonthlyPointsValue(pointsOptimization) {
                if (!pointsOptimization || !pointsOptimization.totalMissedValue) {
                    return 0;
                }
                return pointsOptimization.totalMissedValue;
            }
            
            // Estimate monthly savings based on goal type and available income
            estimateMonthlySavings(monthlySpending, goalType) {
                // Get user's monthly budget and income
                const userIncome = monthlyIncome || 0;
                const userBudget = monthlyBudget || 0;
                
                // For debt payoff, use a more realistic calculation
                if (goalType === 'debt') {
                    // Use 20% of available income after essential expenses as baseline
                    const availableAfterBudget = Math.max(0, userIncome - userBudget);
                    const debtPaymentCapacity = availableAfterBudget * 0.2;
                    
                    // Minimum payment should be at least Â£50/month to be realistic
                    return Math.max(50, debtPaymentCapacity);
                } else {
                    // For other goals, use 10% of income or available surplus
                    const surplus = Math.max(0, userIncome - monthlySpending);
                    return Math.max(50, Math.min(surplus * 0.5, userIncome * 0.1));
                }
            }
            
            // Add months to a date
            addMonthsToDate(date, months) {
                const result = new Date(date);
                result.setMonth(result.getMonth() + months);
                return result;
            }
            
            // Format date for display
            formatDate(date) {
                return date.toLocaleDateString('en-GB', { 
                    year: 'numeric', 
                    month: 'short' 
                });
            }
            
            // Generate goal-specific recommendations
            generateGoalRecommendations(goal, monthlySpending, monthlyPointsValue) {
                const recommendations = [];
                
                if (monthlyPointsValue > 0) {
                    recommendations.push({
                        type: 'points_optimization',
                        message: `Use points strategically to accelerate your ${goal.name} goal by ${Math.round(monthlyPointsValue * 30)} days per month`,
                        impact: monthlyPointsValue
                    });
                }
                
                if (goal.type === 'house') {
                    recommendations.push({
                        type: 'spending_reduction',
                        message: 'Consider reducing non-essential spending by 5% to reach your house deposit faster',
                        impact: monthlySpending * 0.05
                    });
                }
                
                if (goal.type === 'emergency') {
                    recommendations.push({
                        type: 'automatic_allocation',
                        message: 'Set up automatic transfers to build your emergency fund consistently',
                        impact: 'behavioral'
                    });
                }
                
                return recommendations;
            }
        }

        // Initialize goal impact analyzer
        const goalImpactAnalyzer = new GoalImpactAnalyzer();

        // Enhanced function to update goal displays with impact analysis
        function updateGoalsWithImpactAnalysis() {
            const goals = userGoals || [];
            const pointsAnalysis = JSON.parse(localStorage.getItem('pointsAnalysis') || '{"totalMissedValue": 0}');
            
            if (goals.length === 0) return;
            
            const goalImpacts = goalImpactAnalyzer.calculateGoalImpact(goals, expenses, pointsAnalysis);
            
            // Store impact analysis for display
            localStorage.setItem('goalImpacts', JSON.stringify(goalImpacts));
            
            // Update goal display
            renderGoalImpactCards(goalImpacts);
            
            console.log('Goal impact analysis:', goalImpacts);
        }

        // Render enhanced goal cards with impact analysis
        function renderGoalImpactCards(goalImpacts) {
            const goalsContainer = document.getElementById('goals-dashboard');
            if (!goalsContainer || goalImpacts.length === 0) return;
            
            goalsContainer.innerHTML = `
                <div class="space-y-4">
                    ${goalImpacts.map(impact => `
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-100 dark:border-gray-700">
                            <!-- Goal Header -->
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-semibold text-gray-800 dark:text-gray-200">${impact.goalName}</h3>
                                    <p class="text-sm text-gray-500">Â£${impact.current.toLocaleString()} / Â£${impact.target.toLocaleString()}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-gray-600 dark:text-gray-400">${impact.progressPercent.toFixed(1)}%</div>
                                    <div class="text-xs text-gray-500">complete</div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${Math.min(impact.progressPercent, 100)}%"></div>
                            </div>
                            
                            <!-- Impact Analysis -->
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500">Current Timeline</div>
                                    <div class="font-semibold text-gray-800 dark:text-gray-200">
                                        ${impact.monthsToGoalCurrent > 12 ? 
                                            `${(impact.monthsToGoalCurrent / 12).toFixed(1)} years` : 
                                            `${Math.round(impact.monthsToGoalCurrent)} months`}
                                    </div>
                                    <div class="text-xs text-gray-500">${goalImpactAnalyzer.formatDate(impact.completionDateCurrent)}</div>
                                </div>
                                
                                ${impact.timeSavedMonths > 0 ? `
                                    <div class="text-center">
                                        <div class="text-xs text-green-600">With Optimization</div>
                                        <div class="font-semibold text-green-700">
                                            ${impact.monthsToGoalOptimized > 12 ? 
                                                `${(impact.monthsToGoalOptimized / 12).toFixed(1)} years` : 
                                                `${Math.round(impact.monthsToGoalOptimized)} months`}
                                        </div>
                                        <div class="text-xs text-green-600">
                                            ${Math.round(impact.timeSavedDays)} days faster!
                                        </div>
                                    </div>
                                ` : `
                                    <div class="text-center">
                                        <div class="text-xs text-gray-500">Points Boost</div>
                                        <div class="font-semibold text-blue-600">Â£${impact.monthlyPointsBoost.toFixed(2)}</div>
                                        <div class="text-xs text-gray-500">per month</div>
                                    </div>
                                `}
                            </div>
                            
                            <!-- Quick Action -->
                            ${impact.timeSavedMonths > 0 ? `
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3">
                                    <div class="text-sm text-green-800 dark:text-green-200">
                                        ðŸ’¡ <strong>Optimize spending</strong> to reach this goal ${Math.round(impact.timeSavedDays)} days earlier
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Call this function when transactions are updated
        function updateGoalImpactDisplay() {
            updateGoalsWithImpactAnalysis();
        }


        // Settings modal is handled by onclick="closeSettings()" on the backdrop
        // No need for window click handler since we use a modal, not a dropdown menu

        
        // --- Auto-Categorization ---
        function autoCategorizeExpense(event) {
            const name = event.target.value.toLowerCase();
            if (!name) return;

            let matchedCategory = 'Other';
            let matchedEssential = 'Non-Essential';

            // Find category based on keywords
            for (const category in categoryKeywords) {
                if (categoryKeywords[category].some(keyword => name.includes(keyword))) {
                    matchedCategory = category;
                    break;
                }
            }

            // Determine if essential based on keywords
            if (essentialKeywords.some(keyword => name.includes(keyword))) {
                matchedEssential = 'Essential';
            }

            // Update the form fields
            const formPrefix = event.target.id.startsWith('recurring') ? 'recurring-' : 'expense-';
            const categorySelect = document.getElementById(`${formPrefix}category`);
            const typeSelect = document.getElementById(`${formPrefix}type`) || document.getElementById(`${formPrefix}essential-type`);
            
            if (categorySelect) {
                categorySelect.value = matchedCategory;
            }
            if (typeSelect) {
                typeSelect.value = matchedEssential;
            }
        }

        // --- Settings Modal ---
        function openSettings(section) {
            const settingsModal = document.getElementById('settings-modal');
            
            // Populate inputs with current values
            document.getElementById('settings-budget-input').value = monthlyBudget > 0 ? monthlyBudget : '';
            document.getElementById('settings-income-input').value = monthlyIncome > 0 ? monthlyIncome : '';
            
            settingsModal.classList.remove('hidden');

            if (section === 'budget') {
                setTimeout(() => {
                    document.getElementById('settings-budget-input').focus();
                }, 100);
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const budgetValue = document.getElementById('settings-budget-input').value;
            const incomeValue = document.getElementById('settings-income-input').value;

            updateBudget(budgetValue);
            updateIncome(incomeValue);

            closeSettings();
            showToast('Settings saved successfully!');
        }

        function formatCurrency(amount) {
            const config = currencyConfig[currentCurrencyCode];
            const isInteger = amount % 1 === 0;
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
                maximumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
            };
            return new Intl.NumberFormat(config.locale, options).format(amount || 0);
        }

// SMART ANALYTICS CORE ENGINE

class LensSmartInsights {
    constructor(expenses, recurringItems, monthlyBudget, monthlyIncome) {
        this.expenses = expenses || [];
        this.recurringItems = recurringItems || [];
        this.monthlyBudget = monthlyBudget || 0;
        this.monthlyIncome = monthlyIncome || 0;
        this.now = new Date();
        
        // Process data once for all analyses
        this.processedExpenses = this.enrichExpenseData();
        this.monthlyData = this.getMonthlyBreakdown();
    }

    enrichExpenseData() {
        return this.expenses
            .filter(e => e.status === 'active')
            .map(expense => ({
                ...expense,
                cost: parseFloat(expense.cost) || 0,
                date: new Date(expense.date),
                dayOfWeek: new Date(expense.date).getDay(),
                isWeekend: [0, 6].includes(new Date(expense.date).getDay()),
                isRecurring: !!expense.recurringSourceId,
                merchantName: this.extractMerchant(expense.name),
                month: new Date(expense.date).getMonth(),
                year: new Date(expense.date).getFullYear()
            }))
            .sort((a, b) => b.date - a.date);
    }

    extractMerchant(name) {
        return name.toLowerCase()
            .replace(/\d+/g, '')
            .replace(/[^\w\s]/g, '')
            .trim()
            .split(' ')[0];
    }

    getMonthlyBreakdown() {
        const currentMonth = this.now.getMonth();
        const currentYear = this.now.getFullYear();
        
        return {
            thisMonth: this.processedExpenses.filter(e => 
                e.month === currentMonth && e.year === currentYear
            ),
            lastMonth: this.processedExpenses.filter(e => {
                const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const lastYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                return e.month === lastMonth && e.year === lastYear;
            }),
            last3Months: this.processedExpenses.filter(e => {
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                return e.date >= threeMonthsAgo;
            })
        };
    }

    // ===================================================================
    // BEHAVIORAL ANALYSIS
    // ===================================================================

    analyzeWeekendSpending() {
        const { thisMonth } = this.monthlyData;
        
        const weekdayExpenses = thisMonth.filter(e => !e.isWeekend && e.type === 'Non-Essential');
        const weekendExpenses = thisMonth.filter(e => e.isWeekend && e.type === 'Non-Essential');
        
        const weekdayTotal = weekdayExpenses.reduce((sum, e) => sum + e.cost, 0);
        const weekendTotal = weekendExpenses.reduce((sum, e) => sum + e.cost, 0);
        
        // Fix: Prevent division by zero
        const weekdayDays = Math.max(1, new Set(weekdayExpenses.map(e => e.date.getDate())).size);
        const weekendDays = Math.max(1, new Set(weekendExpenses.map(e => e.date.getDate())).size);
        
        const weekdayAvg = weekdayTotal / weekdayDays;
        const weekendAvg = weekendTotal / weekendDays;
        
        // Fix: Handle zero weekday spending
        const weekendPremium = weekdayAvg > 0 ? (weekendAvg - weekdayAvg) / weekdayAvg : 0;
        
        // Fix: Cap at reasonable values
        const cappedPremium = Math.min(5, Math.max(0, weekendPremium)); // Cap at 500% increase
        
        return {
            weekendPremium: cappedPremium,
            nonEssentialWeekendSpending: weekendTotal,
            nonEssentialWeekdaySpending: weekdayTotal,
            potentialSaving: Math.min(1000, cappedPremium * weekendTotal * 0.3) // Cap savings at Â£1000
        };
    }

    analyzeImpulseSpending() {
        const { thisMonth } = this.monthlyData;
        
        // Impulse indicators: Non-essential, small amounts, quick succession
        const impulseExpenses = thisMonth.filter(expense => {
            const isNonEssential = expense.type === 'Non-Essential';
            const isSmallAmount = expense.cost < 30;
            const isQuickSuccession = this.isInQuickSuccession(expense, thisMonth);
            
            return isNonEssential && (isSmallAmount || isQuickSuccession);
        });

        return {
            count: impulseExpenses.length,
            total: impulseExpenses.reduce((sum, e) => sum + e.cost, 0),
            avgAmount: impulseExpenses.length > 0 ? 
                impulseExpenses.reduce((sum, e) => sum + e.cost, 0) / impulseExpenses.length : 0,
            score: impulseExpenses.length / Math.max(thisMonth.length, 1)
        };
    }

    isInQuickSuccession(expense, allExpenses) {
        const sameDay = allExpenses.filter(e => 
            e.date.toDateString() === expense.date.toDateString() && 
            e.id !== expense.id
        );
        return sameDay.length > 2; // More than 2 other purchases same day
    }

    analyzeMerchantLoyalty() {
        const { last3Months } = this.monthlyData;
        
        // Group by category and merchant
        const categoryMerchants = {};
        last3Months.forEach(expense => {
            if (!categoryMerchants[expense.category]) {
                categoryMerchants[expense.category] = {};
            }
            if (!categoryMerchants[expense.category][expense.merchantName]) {
                categoryMerchants[expense.category][expense.merchantName] = [];
            }
            categoryMerchants[expense.category][expense.merchantName].push(expense.cost);
        });

        const opportunities = [];
        Object.entries(categoryMerchants).forEach(([category, merchants]) => {
            const merchantAvgs = Object.entries(merchants).map(([merchant, costs]) => ({
                merchant,
                avg: costs.reduce((a, b) => a + b, 0) / costs.length,
                count: costs.length,
                total: costs.reduce((a, b) => a + b, 0)
            })).filter(m => m.count >= 2); // Only merchants used multiple times

            if (merchantAvgs.length > 1) {
                merchantAvgs.sort((a, b) => a.avg - b.avg);
                const cheapest = merchantAvgs[0];
                const mostUsed = merchantAvgs.reduce((max, curr) => 
                    curr.count > max.count ? curr : max
                );

                if (mostUsed.merchant !== cheapest.merchant && mostUsed.avg > cheapest.avg * 1.2) {
                    const monthlySaving = (mostUsed.avg - cheapest.avg) * (mostUsed.count / 3); // Monthly estimate
                    opportunities.push({
                        category,
                        currentMerchant: mostUsed.merchant,
                        betterMerchant: cheapest.merchant,
                        potentialSaving: monthlySaving
                    });
                }
            }
        });

        return opportunities;
    }

    detectHiddenSubscriptions() {
        const { last3Months } = this.monthlyData;
        
        // Group by merchant and look for regular patterns
        const merchantPatterns = {};
        last3Months.forEach(expense => {
            if (!merchantPatterns[expense.merchantName]) {
                merchantPatterns[expense.merchantName] = [];
            }
            merchantPatterns[expense.merchantName].push({
                cost: expense.cost,
                date: expense.date
            });
        });

        const suspectedSubscriptions = [];
        Object.entries(merchantPatterns).forEach(([merchant, transactions]) => {
            if (transactions.length < 2) return;

            // Check for regular amounts
            const amounts = transactions.map(t => t.cost);
            const mostCommonAmount = this.getMostCommon(amounts);
            const regularAmountCount = amounts.filter(a => Math.abs(a - mostCommonAmount) < 0.01).length;
            
            // Check for regular intervals (approximately monthly)
            const dates = transactions.map(t => t.date).sort();
            const intervals = [];
            for (let i = 1; i < dates.length; i++) {
                const days = (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
                intervals.push(days);
            }
            
            const avgInterval = intervals.length > 0 ? intervals.reduce((a, b) => a + b, 0) / intervals.length : 0;
            const isMonthlyish = avgInterval > 25 && avgInterval < 35;
            const hasRegularInterval = intervals.every(interval => Math.abs(interval - avgInterval) < 7);

            // Check if already tracked
            const isTracked = this.recurringItems.some(item => 
                item.name.toLowerCase().includes(merchant.toLowerCase())
            );

            if (regularAmountCount >= 2 && (isMonthlyish || hasRegularInterval) && !isTracked) {
                suspectedSubscriptions.push({
                    merchant,
                    amount: mostCommonAmount,
                    confidence: (regularAmountCount / transactions.length) * 
                               (hasRegularInterval ? 1 : 0.7),
                    estimatedFrequency: Math.round(avgInterval)
                });
            }
        });

        return suspectedSubscriptions.filter(s => s.confidence > 0.6);
    }

    getMostCommon(arr) {
        const counts = {};
        arr.forEach(val => counts[val] = (counts[val] || 0) + 1);
        return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    }

    // ===================================================================
    // PREDICTIVE ANALYSIS
    // ===================================================================

    predictBudgetRisk() {
        const { thisMonth } = this.monthlyData;
        const currentDay = this.now.getDate();
        const daysInMonth = new Date(this.now.getFullYear(), this.now.getMonth() + 1, 0).getDate();
        
        const spentSoFar = thisMonth.reduce((sum, e) => sum + e.cost, 0);
        const dailyAverage = spentSoFar / currentDay;
        const projectedTotal = dailyAverage * daysInMonth;
        
        // Add upcoming recurring expenses
        const upcomingRecurring = this.getUpcomingRecurringThisMonth();
        const totalProjected = projectedTotal + upcomingRecurring;
        
        const overrunAmount = Math.max(0, totalProjected - this.monthlyBudget);
        const riskScore = this.monthlyBudget > 0 ? Math.min(1, overrunAmount / (this.monthlyBudget * 0.1)) : 0;
        
        return {
            riskScore,
            projectedSpend: totalProjected,
            projectedOverrun: overrunAmount,
            dailyBudgetRemaining: this.monthlyBudget > 0 ? 
                (this.monthlyBudget - spentSoFar) / (daysInMonth - currentDay) : 0
        };
    }

    getUpcomingRecurringThisMonth() {
        const startOfMonth = new Date(this.now.getFullYear(), this.now.getMonth(), 1);
        const endOfMonth = new Date(this.now.getFullYear(), this.now.getMonth() + 1, 0);
        
        return this.recurringItems
            .filter(item => item.status === 'active' && item.type === 'expense')
            .reduce((total, item) => {
                const nextDue = this.getNextDueDate(item, this.now);
                if (nextDue && nextDue <= endOfMonth && nextDue > this.now) {
                    return total + item.amount;
                }
                return total;
            }, 0);
    }

    getNextDueDate(recurringItem, fromDate) {
        let nextDate = new Date(recurringItem.startDate);
        
        while (nextDate <= fromDate) {
            switch (recurringItem.frequency) {
                case 'Daily': nextDate.setDate(nextDate.getDate() + 1); break;
                case 'Weekly': nextDate.setDate(nextDate.getDate() + 7); break;
                case 'Bi-Weekly': nextDate.setDate(nextDate.getDate() + 14); break;
                case 'Monthly': nextDate.setMonth(nextDate.getMonth() + 1); break;
                case 'Quarterly': nextDate.setMonth(nextDate.getMonth() + 3); break;
                case 'Annual': nextDate.setFullYear(nextDate.getFullYear() + 1); break;
            }
        }
        
        return nextDate;
    }

    analyzeCategoryTrends() {
        const { thisMonth, lastMonth } = this.monthlyData;
        
        const thisMonthByCategory = this.groupByCategory(thisMonth);
        const lastMonthByCategory = this.groupByCategory(lastMonth);
        
        const trends = [];
        Object.keys(thisMonthByCategory).forEach(category => {
            const thisTotal = thisMonthByCategory[category] || 0;
            const lastTotal = lastMonthByCategory[category] || 0;
            
            if (lastTotal > 0) {
                const change = (thisTotal - lastTotal) / lastTotal;
                if (Math.abs(change) > 0.2) { // 20% change threshold
                    trends.push({
                        category,
                        change,
                        thisMonth: thisTotal,
                        lastMonth: lastTotal,
                        direction: change > 0 ? 'increasing' : 'decreasing'
                    });
                }
            }
        });
        
        return trends.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
    }

    groupByCategory(expenses) {
        return expenses.reduce((acc, expense) => {
            acc[expense.category] = (acc[expense.category] || 0) + expense.cost;
            return acc;
        }, {});
    }

    // ===================================================================
    // RECOMMENDATION ENGINE
    // ===================================================================

    generateSmartRecommendations() {
        const recommendations = [];
        const { thisMonth } = this.monthlyData;
        
        // Coffee habit detection
        const coffeeExpenses = thisMonth.filter(e => e.name.toLowerCase().includes('coffee'));
        if (coffeeExpenses.length >= 3) {
            const coffeeTotal = coffeeExpenses.reduce((sum, e) => sum + e.cost, 0);
            recommendations.push({
                type: 'behavioral',
                priority: 'medium',
                title: 'Coffee Spending Pattern',
                description: `${coffeeExpenses.length} coffee purchases this month totaling Â£${coffeeTotal}. That's Â£${(coffeeTotal * 12).toFixed(0)} annually! Consider a coffee subscription or home brewing.`,
                icon: 'â˜•',
                potentialSaving: coffeeTotal * 0.6,
                actionable: true,
                category: 'coffee_habit',
                action: 'Review coffee spending'
            });
        }
        
        // Same-day multiple purchases
        const expensesByDate = {};
        thisMonth.forEach(e => {
            if (!expensesByDate[e.date]) expensesByDate[e.date] = [];
            expensesByDate[e.date].push(e);
        });
        
        Object.entries(expensesByDate).forEach(([date, dayExpenses]) => {
            const sameCategoryMultiple = {};
            dayExpenses.forEach(e => {
                if (!sameCategoryMultiple[e.category]) sameCategoryMultiple[e.category] = [];
                sameCategoryMultiple[e.category].push(e);
            });
            
            Object.entries(sameCategoryMultiple).forEach(([category, expenses]) => {
                if (expenses.length > 1) {
                    const total = expenses.reduce((sum, e) => sum + e.cost, 0);
                    recommendations.push({
                        type: 'behavioral',
                        priority: 'high',
                        title: 'Multiple Same-Day Purchases',
                        description: `${expenses.length} ${category} purchases on ${date} totaling Â£${total}. Consider planning ahead to avoid duplicate spending.`,
                        icon: 'ðŸš¨',
                        potentialSaving: total * 0.5,
                        actionable: true,
                        category: 'same_day_duplicates',
                        action: 'Plan purchases better'
                    });
                }
            });
        });
        
        // Large discretionary spending
        const largeDiscretionary = thisMonth.filter(e => 
            e.type === 'Non-Essential' && e.cost > 100
        );
        
        if (largeDiscretionary.length > 0) {
            const total = largeDiscretionary.reduce((sum, e) => sum + e.cost, 0);
            recommendations.push({
                type: 'behavioral',
                priority: 'high',
                title: 'Large Discretionary Purchases',
                description: `${largeDiscretionary.length} large non-essential purchases: ${largeDiscretionary.map(e => e.name).join(', ')} totaling Â£${total}. Consider a 48-hour cooling-off period for purchases over Â£100.`,
                icon: 'ðŸ’¸',
                potentialSaving: total * 0.3,
                actionable: true,
                category: 'large_spending',
                action: 'Set spending limits'
            });
        }
        
        // Transport pattern analysis
        const transportExpenses = thisMonth.filter(e => e.category === 'Transport');
        if (transportExpenses.length >= 3) {
            const transportTotal = transportExpenses.reduce((sum, e) => sum + e.cost, 0);
            const avgPerTrip = transportTotal / transportExpenses.length;
            recommendations.push({
                type: 'efficiency',
                priority: 'medium',
                title: 'Regular Transport Costs',
                description: `${transportExpenses.length} transport expenses averaging Â£${avgPerTrip.toFixed(0)} per trip. Consider a monthly travel card or cycling for potential savings.`,
                icon: 'ðŸšŒ',
                potentialSaving: transportTotal * 0.2,
                actionable: true,
                category: 'transport_optimization',
                action: 'Consider travel alternatives'
            });
        }

        // Enhanced points optimization recommendations
        const pointsAnalysis = JSON.parse(localStorage.getItem('pointsAnalysis') || '{}');
        const merchantRecs = JSON.parse(localStorage.getItem('merchantRecommendations') || '[]');
        
        if (pointsAnalysis.opportunities && pointsAnalysis.opportunities.length > 0) {
            const totalMissedValue = pointsAnalysis.totalMissedValue || 0;
            const annualPotential = totalMissedValue * 12;
            const topCategory = pointsAnalysis.summary?.topRecommendation || 'Use optimized credit cards';
            
            recommendations.push({
                type: 'efficiency',
                priority: 'high',
                title: `Optimize Credit Card Usage`,
                description: `You're missing Â£${totalMissedValue.toFixed(2)}/month (Â£${annualPotential.toFixed(2)}/year) in rewards value. ${topCategory}.`,
                icon: 'ðŸ’³',
                potentialSaving: Math.floor(annualPotential),
                actionable: true,
                category: 'points_optimization',
                action: pointsAnalysis.summary?.quickWin || 'Use rewards cards for purchases'
            });
        }
        
        // Add merchant-specific recommendations
        if (merchantRecs.length > 0) {
            const topMerchant = merchantRecs[0];
            if (topMerchant.annualValue > 50) {
                recommendations.push({
                    type: 'efficiency',
                    priority: 'medium',
                    title: `Optimize ${topMerchant.merchant} Spending`,
                    description: `You spend Â£${topMerchant.monthlySpending.toFixed(2)}/month at ${topMerchant.merchant}. Using ${topMerchant.recommendedCard} could earn Â£${topMerchant.annualValue.toFixed(2)}/year in rewards.`,
                    icon: 'ðŸŽ¯',
                    potentialSaving: Math.floor(topMerchant.annualValue),
                    actionable: true,
                    category: 'merchant_optimization',
                    action: `Use ${topMerchant.recommendedCard} at ${topMerchant.merchant}`
                });
            }
        }
        
        return recommendations.slice(0, 6); // Return top 6 to include points optimization
    }

    prioritizeRecommendations(recommendations) {
        return recommendations
            .map(rec => ({
                ...rec,
                score: this.calculatePriorityScore(rec)
            }))
            .sort((a, b) => b.score - a.score)
            .slice(0, 6);
    }

    calculatePriorityScore(rec) {
        const priorityWeight = {
            'urgent': 100,
            'high': 75,
            'medium': 50,
            'low': 25
        }[rec.priority] || 25;
        
        const savingsScore = Math.min(50, (rec.potentialSaving || 0) / 2);
        const typeBonus = {
            'urgent': 25,
            'behavioral': 15,
            'efficiency': 20,
            'organization': 10,
            'trend': 15
        }[rec.type] || 0;
        
        return priorityWeight + savingsScore + typeBonus;
    }

    generate7DayForecast() {
        try {
            const forecast = [];
            const today = new Date();
            
            for (let i = 1; i <= 7; i++) {
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + i);
                
                const dayName = targetDate.toLocaleDateString('en-GB', { weekday: 'short' });
                const dayOfWeek = targetDate.getDay();
                
                const prediction = this.predictDaySpending(dayOfWeek, targetDate);
                
                forecast.push({
                    date: `${dayName} ${targetDate.getDate()}`,
                    predicted: prediction.amount,
                    confidence: prediction.confidence,
                    reasoning: prediction.reasoning,
                    hasRecurring: prediction.hasRecurring
                });
            }
            
            return forecast;
        } catch (error) {
            console.error('7-day forecast error:', error);
            return [];
        }
    }

    predictDaySpending(dayOfWeek, date) {
        try {
            const { last3Months } = this.monthlyData;
            
            const sameDaySpending = last3Months
                .filter(e => e.dayOfWeek === dayOfWeek)
                .map(e => e.cost);
                
            const avgSpending = sameDaySpending.length > 0 ? 
                sameDaySpending.reduce((a, b) => a + b, 0) / sameDaySpending.length : 0;
            
            const confidence = Math.min(95, Math.max(40, sameDaySpending.length * 10));
            const reasoning = `Based on ${sameDaySpending.length} similar days`;
            
            return {
                amount: avgSpending,
                confidence,
                reasoning,
                hasRecurring: false
            };
        } catch (error) {
            return { amount: 0, confidence: 0, reasoning: 'Unable to predict', hasRecurring: false };
        }
    }

    generateMonthlyStory() {
        try {
            const { thisMonth } = this.monthlyData;
            const totalSpent = thisMonth.reduce((sum, e) => sum + e.cost, 0);
            
            if (totalSpent === 0) {
                return {
                    story: "Add some expenses to see your personalized financial insights.",
                    metrics: null
                };
            }
            
            const totalIncome = this.monthlyIncome + this.getMonthlyRecurringIncome();
            const savingsRate = totalIncome > 0 ? ((totalIncome - totalSpent) / totalIncome) * 100 : 0;
            
            const spendingDays = new Set(thisMonth.map(e => e.date.getDate())).size;
            
            let story = `This month you've spent <strong>${formatCurrency(totalSpent)}</strong> across ${spendingDays} days. `;
            
            if (savingsRate > 15) {
                story += `Excellent <strong>${savingsRate.toFixed(0)}% savings rate</strong>! `;
            } else if (savingsRate > 0) {
                story += `Good <strong>${savingsRate.toFixed(0)}% savings rate</strong>. `;
            }
            
            const metrics = {
                savingsRate: savingsRate.toFixed(0),
                topCategory: 'Various',
                spendingDays: spendingDays
            };
            
            return { story, metrics };
        } catch (error) {
            return { story: "Unable to generate story", metrics: null };
        }
    }

    getMonthlyRecurringIncome() {
        try {
            return this.recurringItems
                .filter(item => item.status === 'active' && item.type === 'income')
                .reduce((total, item) => total + item.amount, 0);
        } catch (error) {
            return 0;
        }
    }
}

// ===================================================================
// INTEGRATION FUNCTIONS - Drop-in replacements
// ===================================================================

function updateAiInsightsWithSmartAnalytics() {
    console.log('Starting smart analytics update...');
    
    showInsightsLoading();
    
    setTimeout(() => {
        try {
            console.log('Data check:', {
                expensesCount: expenses?.length || 0,
                recurringCount: recurringItems?.length || 0,
                budget: monthlyBudget,
                income: monthlyIncome
            });
            
            const insights = new LensSmartInsights(
                expenses || [], 
                recurringItems || [], 
                monthlyBudget || 0, 
                monthlyIncome || 0
            );
            
            const forecast = insights.generate7DayForecast();
            const recommendations = insights.generateSmartRecommendations();
            const monthlyStory = insights.generateMonthlyStory();
            const budgetRisk = insights.predictBudgetRisk();
            
            renderSmart7DayForecast(forecast);
            renderSmartRecommendations(recommendations);
            renderSmartMonthlyStory(monthlyStory);
            renderMonthEndProjectionSmart(budgetRisk);
            
            // Add enhanced points optimization insights and update combined badge
            renderEnhancedInsights();
            
            // Update badge with combined count
            const pointsAnalysis = JSON.parse(localStorage.getItem('pointsAnalysis') || '{"opportunities": []}');
            const totalRecommendations = recommendations.length + pointsAnalysis.opportunities.length;
            updateRecommendationBadge(totalRecommendations);
            
        } catch (error) {
            console.error('Smart analytics error:', error);
            showInsightsError();
        }
    }, 500);
}

// UI Rendering Functions
function showInsightsLoading() {
    const containers = [
        'seven-day-forecast',
        'smart-recommendations', 
        'monthly-story',
        'month-end-projection'
    ];
    
    containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = `
                <div class="flex justify-center items-center p-6">
                    <div class="ai-loading"></div>
                    <span class="ml-3 text-sm text-gray-500">Analyzing your spending patterns...</span>
            </div>
            `;
        }
    });
}

function renderSmart7DayForecast(forecast) {
    const container = document.getElementById('seven-day-forecast');
    if (!container) return;
    
    if (forecast.length === 0) {
        container.innerHTML = `
            <div class="text-center p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    Add more expenses to generate spending predictions
                </p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-3">
            <div class="text-xs text-gray-500 mb-3 italic">
                ðŸ“Š Predictions based on your spending patterns
            </div>
            ${forecast.map(day => `
                <div class="flex justify-between items-center p-3 rounded-lg border border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                    <div>
                        <div class="font-medium text-gray-800 dark:text-gray-200">${day.date}</div>
                        <div class="text-xs text-gray-500 mt-1">${day.reasoning}</div>
            </div>
                    <div class="text-right">
                        <div class="font-semibold ${day.predicted > 0 ? 'text-red-500' : 'text-gray-400'} dark:text-red-400">
                            ${day.predicted > 0 ? formatCurrency(day.predicted) : 'No spending predicted'}
                        </div>
                        <div class="text-xs text-gray-400">${day.confidence}% confidence</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderSmartRecommendations(recommendations) {
    const container = document.getElementById('smart-recommendations');
    if (!container) return;
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="text-center p-6">
                <div class="text-4xl mb-3">ðŸŽ‰</div>
                <div class="font-medium text-gray-800 dark:text-gray-200 mb-2">All looking good!</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    No urgent recommendations right now. Keep up the great work!
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recommendations.map(rec => {
        const priorityColors = {
            'urgent': 'border-red-500 bg-red-50 dark:bg-red-900/20',
            'high': 'border-orange-500 bg-orange-50 dark:bg-orange-900/20',
            'medium': 'border-blue-500 bg-blue-50 dark:bg-blue-900/20',
            'low': 'border-gray-500 bg-gray-50 dark:bg-gray-900/20'
        };
        
        const priorityBadgeColors = {
            'urgent': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
            'high': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
            'medium': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
            'low': 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200'
        };
        
        return `
            <div class="p-4 rounded-lg border-l-4 ${priorityColors[rec.priority]} hover:shadow-md transition-shadow cursor-pointer" 
                 onclick="handleRecommendationClick('${rec.category}', ${JSON.stringify(rec).replace(/"/g, '&quot;')})">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${rec.icon}</span>
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">${rec.title}</h4>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full ${priorityBadgeColors[rec.priority]}">
                        ${rec.priority}
                    </span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 leading-relaxed">${rec.description}</p>
             <div class="flex justify-between items-center">
                    <div class="text-xs text-gray-500">
                        ${rec.potentialSaving > 0 ? `ðŸ’° Potential saving: <strong>${formatCurrency(rec.potentialSaving)}</strong>` : 'ðŸ“Š Organization improvement'}
            </div>
                    <div class="text-xs bg-white dark:bg-gray-800 px-2 py-1 rounded border hover:bg-gray-50 dark:hover:bg-gray-700">
                        Take Action â†’
                    </div>
                </div>
        </div>
    `;
    }).join('');
}

function renderSmartMonthlyStory(storyData) {
    const container = document.getElementById('monthly-story');
    const metricsContainer = document.getElementById('story-metrics');
    
    if (!container) return;
    
    container.innerHTML = `
        <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
            ${storyData.story}
        </div>
    `;
    
    if (metricsContainer && storyData.metrics) {
        metricsContainer.innerHTML = `
            <div class="metric-card">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Savings Rate</p>
                <p class="text-lg font-bold ${parseFloat(storyData.metrics.savingsRate) >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                    ${storyData.metrics.savingsRate}%
                </p>
            </div>
            <div class="metric-card">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Top Category</p>
                <p class="text-lg font-bold text-gray-800 dark:text-gray-200 truncate">${storyData.metrics.topCategory}</p>
            </div>
            <div class="metric-card">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Active Days</p>
                <p class="text-lg font-bold text-gray-800 dark:text-gray-200">${storyData.metrics.spendingDays}</p>
            </div>
        `;
        metricsContainer.classList.remove('hidden');
        metricsContainer.classList.add('grid', 'grid-cols-3', 'gap-2', 'mt-4', 'text-center');
    }
}

function renderMonthEndProjectionSmart(budgetRisk) {
    const container = document.getElementById('month-end-projection');
    if (!container) return;
    
    const riskLevel = budgetRisk.riskScore > 0.8 ? 'high' : budgetRisk.riskScore > 0.5 ? 'medium' : 'low';
    const riskColors = {
        'high': 'text-red-600 dark:text-red-400',
        'medium': 'text-yellow-600 dark:text-yellow-400', 
        'low': 'text-green-600 dark:text-green-400'
    };
    
    const totalIncome = monthlyIncome + (recurringItems?.filter(r => r.type === 'income' && r.status === 'active').reduce((sum, r) => sum + r.amount, 0) || 0);
    const projectedSavings = totalIncome - budgetRisk.projectedSpend;
    
    container.innerHTML = `
        <div class="space-y-4">
            <div class="text-center p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Projected Monthly Spending</p>
                <p class="text-2xl font-bold text-gray-800 dark:text-gray-200">${formatCurrency(budgetRisk.projectedSpend)}</p>
                <p class="text-xs font-medium mt-1 ${riskColors[riskLevel]}">
                    ${riskLevel === 'high' ? 'âš ï¸ Budget Risk' : riskLevel === 'medium' ? 'âš¡ Watch Closely' : 'âœ… On Track'}
                </p>
            </div>
            
            ${budgetRisk.riskScore > 0.6 ? `
                <div class="p-3 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500">
                    <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Daily Budget Alert</p>
                    <p class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">
                        Limit spending to ${formatCurrency(budgetRisk.dailyBudgetRemaining)}/day to stay on budget
                    </p>
                </div>
            ` : ''}
            
            <div class="text-center">
                <p class="text-sm text-gray-600 dark:text-gray-400">Projected Savings</p>
                <p class="text-xl font-bold ${projectedSavings >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                    ${formatCurrency(projectedSavings)}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                    Based on current spending velocity
                </p>
            </div>
        </div>
    `;
}

function updateRecommendationBadge(count) {
    const badge = document.getElementById('action-count');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}

function handleRecommendationClick(category, recommendation) {
    // Handle different recommendation actions
    switch(category) {
        case 'weekend_control':
            // Could open a weekend budget setting modal
            showToast('Set a weekend spending limit in Settings', 'info');
            break;
        case 'impulse_control':
            // Could show impulse spending tips
            showToast('Try waiting 24 hours before non-essential purchases', 'info');
            break;
        case 'merchant_optimization':
            // Could show merchant comparison
            showToast('Research alternative merchants for better prices', 'info');
            break;
        case 'subscription_tracking':
            // Could open add recurring item modal
            showRecurringForm();
            break;
        case 'budget_risk':
            // Could open budget adjustment modal
            openSettings('budget');
            break;
        default:
            showToast('Recommendation noted! Check insights regularly for updates.', 'info');
    }
}

function showInsightsError() {
    const containers = ['seven-day-forecast', 'smart-recommendations', 'monthly-story', 'month-end-projection'];
    containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <p class="text-sm text-red-500">Unable to generate insights. Please try again.</p>
                </div>
            `;
        }
    });
}
        // --- Utility Functions ---
        function debugExpenseData() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const thisMonthExpenses = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && 
                       expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            const recurringExpenses = thisMonthExpenses.filter(e => e.recurringSourceId);
            const oneTimeExpenses = thisMonthExpenses.filter(e => !e.recurringSourceId);
            
            console.log('=== EXPENSE DATA DEBUG ===');
            console.log('Total this month:', thisMonthExpenses.length);
            console.log('One-time expenses:', oneTimeExpenses.length);
            console.log('Recurring expenses:', recurringExpenses.length);
            console.log('Total amount:', thisMonthExpenses.reduce((sum, e) => sum + e.cost, 0));
            console.log('Recurring items in system:', recurringItems.length);

        return {
                total: thisMonthExpenses.length,
                oneTime: oneTimeExpenses.length,
                recurring: recurringExpenses.length,
                amount: thisMonthExpenses.reduce((sum, e) => sum + e.cost, 0)
            };
        }

        function categorizeChanges(oldItem, newItem) {
            const changes = {
                safe: [],      // amount, name, category, paymentMethod
                schedule: [],  // frequency, startDate, endDate
                structural: [] // type, essentialType
            };
            
            const safeFields = ['name', 'amount', 'category', 'paymentMethod'];
            const scheduleFields = ['frequency', 'startDate', 'endDate'];
            const structuralFields = ['type', 'essentialType'];
            
            Object.keys(newItem).forEach(key => {
                if (oldItem[key] !== newItem[key]) {
                    if (safeFields.includes(key)) {
                        changes.safe.push(key);
                    } else if (scheduleFields.includes(key)) {
                        changes.schedule.push(key);
                    } else if (structuralFields.includes(key)) {
                        changes.structural.push(key);
                    }
                }
            });
            
            return changes;
        }

        function updateExpensesFromCurrentMonth(recurringItem) {
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            let updatedCount = 0;
            let preservedCount = 0;
            
            expenses.forEach(expense => {
                if (expense.recurringSourceId === recurringItem.id) {
                    const expenseDate = new Date(expense.date);
                    
                    if (expenseDate >= currentMonthStart) {
                        // Update current month and future expenses
                        expense.name = recurringItem.name;
                        expense.cost = recurringItem.amount;
                        expense.category = recurringItem.category;
                        expense.type = recurringItem.essentialType || 'Non-Essential';
                        expense.paymentMethod = recurringItem.paymentMethod;
                        updatedCount++;
                    } else {
                        // Count preserved past expenses
                        preservedCount++;
                    }
                }
            });
            
            return { updatedCount, preservedCount };
        }

        function handleScheduleChanges(oldItem, newItem) {
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Count what we're about to remove
            const removedCount = expenses.filter(e => 
                e.recurringSourceId === oldItem.id && 
                new Date(e.date) >= currentMonthStart
            ).length;
            
            const preservedCount = expenses.filter(e => 
                e.recurringSourceId === oldItem.id && 
                new Date(e.date) < currentMonthStart
            ).length;
            
            // Remove future expenses (keep past ones intact)
            expenses = expenses.filter(e => {
                if (e.recurringSourceId !== oldItem.id) {
                    return true; // Keep non-related expenses
                }
                
                const expenseDate = new Date(e.date);
                return expenseDate < currentMonthStart; // Keep past expenses only
            });
            
            return { removedCount, preservedCount };
        }

        function saveRecurring() {
            const type = DOMElements.recurringItemType.value;
            const name = DOMElements.recurringName.value.trim();
            const amount = parseFloat(DOMElements.recurringAmount.value);
            const startDate = DOMElements.recurringStartDate.value;
            const endDate = DOMElements.recurringEndDate.value || null;

            if (!name || isNaN(amount) || amount <= 0 || !startDate) {
                 showToast('Please fill in recurring item fields correctly.', 'error');
                return;
            }

            const recurringItem = {
                id: editingRecurring ? editingRecurring.id : Date.now(),
                type: type,
                name: name,
                amount: amount,
                frequency: DOMElements.recurringFrequency.value,
                category: DOMElements.recurringCategory.value,
                essentialType: type === 'expense' ? DOMElements.recurringEssentialType.value : null,
                paymentMethod: DOMElements.recurringPaymentMethod.value,
                startDate: startDate,
                endDate: endDate,
                status: 'active'
            };

            if (editingRecurring) {
                const oldRecurring = editingRecurring;
                const changes = categorizeChanges(oldRecurring, recurringItem);
                
                // Update the recurring item first
                const index = recurringItems.findIndex(r => r.id === editingRecurring.id);
                if (index !== -1) {
                    recurringItems[index] = recurringItem;
                    
                    // Determine how to handle the update
                    if (changes.schedule.length > 0 || changes.structural.length > 0) {
                        // Schedule or structural changes: regenerate from current month
                        const result = handleScheduleChanges(oldRecurring, recurringItem);
                        
                        showToast(
                            `Recurring ${type} '${name}' updated! ` +
                            `${result.preservedCount} past expense(s) preserved, ` +
                            `${result.removedCount} current/future expense(s) will be regenerated.`
                        );
                    } else if (changes.safe.length > 0) {
                        // Safe changes: update current month + future only
                        const result = updateExpensesFromCurrentMonth(recurringItem);
                        
                        let message = `Recurring ${type} '${name}' updated!`;
                        if (result.updatedCount > 0) {
                            message += ` ${result.updatedCount} current/future expense(s) updated.`;
                        }
                        if (result.preservedCount > 0) {
                            message += ` ${result.preservedCount} past expense(s) preserved.`;
                        }
                        
                        showToast(message);
                    } else {
                        // No relevant changes
                        showToast(`Recurring ${type} '${name}' updated!`);
                    }
                }
            } else {
                // Adding new recurring item
                recurringItems.unshift(recurringItem);
                showToast(`Recurring ${type} '${name}' saved successfully!`);
            }
            
    saveData();
            
            // Fix: Force immediate processing and update
            processRecurringExpenses();
    updateDisplay();
            
            closeRecurringModal();
        }

        // Enhanced Mobile Rendering Functions

        // Category to icon mapping
        const categoryIcons = {
            "Housing": "ðŸ ", "Utilities": "ðŸ’¡", "Transport": "ðŸš—", "Food/Drink": "ðŸ”",
            "Entertainment": "ðŸŽ¬", "Shopping": "ðŸ›ï¸", "Health": "â¤ï¸", "Personal Care": "ðŸ§´",
            "Education": "ðŸŽ“", "Debt": "ðŸ’³", "Subscriptions": "ðŸ”", "Other": "â“",
            "Salary": "ðŸ’°", "Bonus": "â­", "Investment": "ðŸ“ˆ", "Gift": "ðŸŽ", "Other Income": "ðŸª™"
        };

        // DEPRECATED: Enhanced renderExpensesTable function (replaced with paginated version)
        function renderExpensesTable_NEW_DEPRECATED() {
            let allExpenses = [...expenses];

            // Apply filters (existing filter logic)
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            const filteredExpenses = allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                
                if (typeFilter) {
                    if (typeFilter === 'Recurring') {
                        if (!e.recurringSourceId) passes = false;
                    } else {
                        if (e.type !== typeFilter) passes = false;
                    }
                }

                return passes;
            });

            // Sort expenses by date (newest first)
            filteredExpenses.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                const getNumericId = (id) => {
                    if (typeof id === 'string') {
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return id;
                };
                
                return getNumericId(b.id) - getNumericId(a.id);
            });

            const tableBody = DOMElements.expensesTableBody;
            
            if (filteredExpenses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500 dark:text-gray-400">No expenses match your filters.</td></tr>`;
                return;
            }

            // Check if we're on mobile (using more reliable detection)
            const isMobile = window.innerWidth <= 768 || /Mobi|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Hide the desktop table structure for mobile
                const tableContainer = tableBody.closest('table');
                if (tableContainer) {
                    tableContainer.style.display = 'none';
                }
                
                // Create or get mobile container
                let mobileContainer = document.getElementById('mobile-expenses-container');
                if (!mobileContainer) {
                    mobileContainer = document.createElement('div');
                    mobileContainer.id = 'mobile-expenses-container';
                    mobileContainer.className = 'block md:hidden p-2 sm:p-4';
                    tableBody.closest('.card').appendChild(mobileContainer);
                }
                
                renderMobileExpenseCards(filteredExpenses, mobileContainer);
                
                // Show mobile container
                mobileContainer.style.display = 'block';
            } else {
                // Show desktop table
                const tableContainer = tableBody.closest('table');
                if (tableContainer) {
                    tableContainer.style.display = 'table';
                }
                
                // Hide mobile container
                const mobileContainer = document.getElementById('mobile-expenses-container');
                if (mobileContainer) {
                    mobileContainer.style.display = 'none';
                }
                
                renderDesktopExpenseTable(filteredExpenses, tableBody);
            }
        }

        function renderMobileExpenseCards(expenses, container) {
            if (!expenses || expenses.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-500 dark:text-gray-400">No expenses to display.</div>`;
                return;
            }

            const grouped = expenses.reduce((groups, expense) => {
                const date = (expense.date || '').split('T')[0];
                if (!date) return groups;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(expense);
                return groups;
            }, {});

            let html = '';

            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(date => {
                const dayExpenses = grouped[date];
                const dayTotal = dayExpenses.reduce((sum, exp) => sum + exp.cost, 0);

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const expenseDate = new Date(date + 'T00:00:00');

                let dateLabel;
                if (expenseDate.getTime() === today.getTime()) {
                    dateLabel = 'Today';
                } else if (expenseDate.getTime() === yesterday.getTime()) {
                    dateLabel = 'Yesterday';
                } else {
                    dateLabel = expenseDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' });
                }

                html += `
                    <div class="mobile-date-header" style="padding: 16px 8px 4px 8px; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${dateLabel}</span>
                            <span>-${formatCurrency(dayTotal, false)}</span>
                        </div>
                    </div>`;

                dayExpenses.forEach(expense => {
                    const categoryIcon = categoryIcons[expense.category] || categoryIcons['Other'];
                    const isRecurringInstance = !!expense.recurringSourceId;
                    const originalRecurringItem = isRecurringInstance ? recurringItems.find(r => r.id === expense.recurringSourceId) : null;
                    const editAction = isRecurringInstance && originalRecurringItem ? `editRecurring(${originalRecurringItem.id})` : `editExpense(${expense.id})`;

                    html += `
                        <div onclick="${editAction}" class="mobile-card">
                            <div class="mobile-card-icon">${categoryIcon}</div>
                            <div class="mobile-card-main">
                                <div class="mobile-card-title">${escapeHTML(expense.name)}</div>
                                <div class="mobile-card-subtitle">${escapeHTML(expense.category)}</div>
                            </div>
                            <div class="mobile-card-amount">-${formatCurrency(expense.cost)}</div>
                        </div>
                    `;
                    });
                });

            container.innerHTML = html;
        }

        function renderDesktopExpenseTable(expenses, container) {
            // Keep existing desktop table rendering logic
            container.innerHTML = expenses.map(expense => {
                const isRecurringInstance = !!expense.recurringSourceId;
                const isCancelled = expense.status === 'cancelled';
                const originalRecurringItem = isRecurringInstance ? 
                    recurringItems.find(r => r.id === expense.recurringSourceId) : null;

                let editAction = `editExpense(${expense.id})`;
                if (isRecurringInstance && originalRecurringItem) {
                    editAction = `editRecurring(${originalRecurringItem.id})`;
                }
                
                const deleteAction = isRecurringInstance ? 'return false;' : `deleteExpense(${expense.id})`;
                const checkboxId = `expense-${expense.id}`;

                const formattedDate = new Date(expense.date).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                return `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${isCancelled ? 'opacity-60' : ''}"
                        data-category="${expense.category}">
                        <td class="px-4 py-3" data-label="">
                            <input type="checkbox" id="${checkboxId}" data-id="${expense.id}" 
                                   onchange="toggleExpenseSelection(this, '${expense.id}')" 
                                   class="table-checkbox expense-checkbox" 
                                   ${isRecurringInstance ? 'disabled' : ''} 
                                   ${selectedExpenseIds.has(expense.id.toString()) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap" data-label="Name">
                            <span>${escapeHTML(expense.name)}</span>${isRecurringInstance ? '<span class="text-xs text-gray-400 ml-1">(R)</span>' : ''}
                        </td>
                        <td class="px-6 py-3" data-label="Amount">${formatCurrency(expense.cost)}</td>
                        <td class="px-6 py-3" data-label="Date">${formattedDate}</td>
                        <td class="px-6 py-3 hidden md:table-cell" data-label="Category">${escapeHTML(expense.category)}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Payment Method">${escapeHTML(expense.paymentMethod) || '-'}</td>
                        <td class="px-6 py-3 hidden lg:table-cell" data-label="Type">${escapeHTML(expense.type)}</td>
                        <td class="px-6 py-3 text-right" data-label="Actions">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="${editAction}" title="Edit" class="icon-button" 
                                        ${isCancelled ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button onclick="${deleteAction}" title="Delete" 
                                        class="icon-button text-red-600/80 hover:text-red-500" 
                                        ${isRecurringInstance ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function groupExpensesByDate(expenses) {
            return expenses.reduce((groups, expense) => {
                const date = expense.date;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(expense);
                return groups;
            }, {});
        }

        // DEPRECATED: Enhanced recurring table rendering for mobile (replaced with paginated version)
        function renderRecurringTable_NEW_DEPRECATED() {
            DOMElements.recurringTableBody.innerHTML = '';
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;

            let filtered = recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });

            filtered.sort((a, b) => b.id - a.id);

            if (filtered.length === 0) {
                DOMElements.recurringTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                return;
            }

            const isMobile = window.innerWidth <= 640;
            
            if (isMobile) {
                renderMobileRecurringList(filtered, DOMElements.recurringTableBody);
            } else {
                renderDesktopRecurringTable(filtered, DOMElements.recurringTableBody);
            }
        }

        function renderMobileRecurringList(items, container) {
            if (items.length === 0) {
                container.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                return;
            }
            let html = '';
            items.forEach(item => {
                const isCancelled = item.status === 'cancelled';
                const typeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                 html += `
                    <div onclick="editRecurring(${item.id})" class="mobile-card ${isCancelled ? 'opacity-60' : ''}">
                         <div class="mobile-card-icon">${categoryIcons[item.category] || categoryIcons['Other']}</div>
                         <div class="mobile-card-main">
                            <p class="mobile-card-title">${escapeHTML(item.name)}</p>
                            <div class="mobile-card-subtitle">
                                <span>${item.type === 'income' ? 'Income' : 'Expense'}</span>
                                &middot;
                                <span>${item.frequency}</span>
                            </div>
                         </div>
                         <div class="text-right">
                            <p class="mobile-card-amount ${typeClass}">${formatCurrency(item.amount)}</p>
                            <p class="text-xs text-gray-400">${item.status === 'active' ? 'Active' : 'Cancelled'}</p>
                         </div>
                    </div>
                `;
            });
            container.innerHTML = `<td colspan="8" style="padding: 0;">${html}</td>`;
        }

        function renderDesktopRecurringTable(items, container) {
            // Existing desktop recurring table logic
            items.forEach(item => {
                const tr = document.createElement('tr');
                const isSelected = selectedRecurringIds.has(item.id);
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${item.status === 'cancelled' ? 'opacity-60' : ''} ${isSelected ? 'bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800'}`;
                const itemTypeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

                const formattedStartDate = new Date(item.startDate).toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                tr.innerHTML = `
                    <td class="px-4 py-4 w-1" data-label="">
                        <input type="checkbox" data-id="${item.id}" onchange="toggleRecurringSelection(this, ${item.id})" class="table-checkbox recurring-checkbox" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white" data-label="Name">${escapeHTML(item.name)}</td>
                    <td class="px-6 py-4 capitalize" data-label="Type">${item.type}</td>
                    <td class="px-6 py-4 font-medium ${itemTypeClass}" data-label="Amount">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4" data-label="Frequency">${item.frequency}</td>
                    <td class="px-6 py-4" data-label="Start Date">${formattedStartDate}</td>
                    <td class="px-6 py-4 hidden lg:table-cell" data-label="Category">${escapeHTML(item.category)}</td>
                    <td class="px-6 py-4" data-label="Status">
                        <span class="status-badge ${item.status === 'active' ? 'status-active' : 'status-cancelled'}">${item.status}</span>
                    </td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap" data-label="Actions">
                        <button onclick="editRecurring(${item.id})" class="icon-button" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button onclick="toggleRecurringStatus(${item.id})" class="icon-button" title="${item.status === 'active' ? 'Pause' : 'Resume'}">
                           ${item.status === 'active' ? 
                               '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : 
                               '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                           }
                        </button>
                        <button onclick="deleteRecurring(${item.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                container.appendChild(tr);
            });
        }

      // Add responsive behavior
      function handleResize() {
          if (activeTab === 'expenses') {
                renderExpensesTable();
          } else if (activeTab === 'recurring') {
                renderRecurringTable();
          }
      }

      // Listen for window resize with debounce
      let resizeTimeout;
      window.addEventListener('resize', function() {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(handleResize, 250);
      });

        // Enhanced updateTableLabels function for better mobile support
        function updateTableLabels_NEW() {
            document.querySelectorAll('table').forEach(tbl => {
                const headers = Array.from(tbl.querySelectorAll('thead th'))
                             .map(th => th.textContent.trim());

                tbl.querySelectorAll('tbody tr').forEach(row => {
                    Array.from(row.children).forEach((cell, idx) => {
                        if (!cell.hasAttribute('data-label')) {
                            cell.setAttribute('data-label', headers[idx] || '');
                        }
                        
                        // Add category data attribute for styling
                        if (headers[idx] === 'Category' && cell.textContent.trim()) {
                            row.setAttribute('data-category', cell.textContent.trim());
                        }
                        
                        // Add recurring data attribute
                        if (headers[idx] === 'Status' && cell.textContent.includes('Recurring')) {
                            row.setAttribute('data-recurring', 'true');
                        }
                        
                        // Add time data for mobile meta display
                        if (headers[idx] === 'Date' && cell.textContent.trim()) {
                            const timeAttr = '12:00'; // Default time since we don't store time
                            row.querySelector('td[data-label="Name"]')?.setAttribute('data-time', timeAttr);
                        }
                        
                        // Add icon data attribute based on category
                        if (headers[idx] === 'Category' && cell.textContent.trim()) {
                            const category = cell.textContent.trim();
                            const icon = categoryIcons[category] || categoryIcons['Other'];
                            const iconCell = row.querySelector('td:nth-child(2)');
                            if (iconCell) {
                                iconCell.setAttribute('data-icon', icon);
                            }
                        }
                    });
                });
            });
        }
    </script>

    <!-- === Lens Card Labels Script START === -->
    <script>
      function updateTableLabels() {
        document.querySelectorAll('table').forEach(tbl => {
          const headers = Array.from(tbl.querySelectorAll('thead th'))
                               .map(th => th.textContent.trim());

          tbl.querySelectorAll('tbody tr').forEach(row => {
            Array.from(row.children).forEach((cell, idx) => {
              if (!cell.hasAttribute('data-label')) {
                cell.setAttribute('data-label', headers[idx] || '');
              }
            });
          });
        });
      }
      
      document.addEventListener('DOMContentLoaded', updateTableLabels);
    </script>
    <!-- === Lens Card Labels Script END === -->

    <!-- Mobile Bottom Navigation -->
<!-- Mobile Bottom Navigation -->
<nav class="md:hidden bottom-nav fixed bottom-0 left-0 right-0 z-40">
    <div class="max-w-5xl mx-auto px-2">
        <div class="flex justify-around items-center h-16">
            <button id="mobile-tab-overview" onclick="showTab('overview')" class="bottom-nav-item active flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                <span class="text-xs">Overview</span>
            </button>
            <button id="mobile-tab-expenses" onclick="showTab('expenses')" class="bottom-nav-item flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                <span class="text-xs">Expenses</span>
            </button>
            <button id="mobile-tab-recurring" onclick="showTab('recurring')" class="bottom-nav-item flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                    <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01" stroke-linecap="round"/>
                </svg>
                <span class="text-xs">Recurring</span>
            </button>
            <button id="mobile-tab-insights" onclick="showTab('insights')" class="bottom-nav-item flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>
                <span class="text-xs">Insights</span>
            </button>
            <!-- Add Settings Button for Mobile -->
            <button id="mobile-bottom-nav-settings" onclick="openSettings()" class="bottom-nav-item flex flex-col items-center justify-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-xs">Settings</span>
            </button>
            </div>
        </div>
    </nav>

<!-- Mobile View Rewrite (auto-generated) -->
<script>
// <![CDATA[
/* =============================================================
   Mobile View Rewrite for Lens Expense Tracker
   -------------------------------------------------------------
   Why a rewrite?
   â€¢ Table rows collapsed on some mobile browsers â†’ invisible cards
   â€¢ Duplicate renderers caused confusion (renderExpensesTable vs renderExpensesTable_NEW)
   â€¢ Costs sometimes strings â†’ totals = 0
   â€¢ ISO dates with time part created one header per entry
   Approach
   â€¢ Hide the desktop table on screens <640 px and render 
     a dedicated list of cards in a lightweight <div>.
   â€¢ Uses ONLY existing global arrays `expenses` and `recurringItems`.
   â€¢ NO changes to desktop logic or CSS â€“ strictly inside a media query.
   ============================================================= */

/* ---------- Helper functions ---------- */
function stripISO(dateStr) {
    // "2025-06-09" or "2025-06-09T14:22"
    return (dateStr || '').split('T')[0];
}
function dateLabel(d) {
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    const target = new Date(d);
    const startTarget = new Date(target.getFullYear(), target.getMonth(), target.getDate());
    const startToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const startYesterday = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());

    if (startTarget.getTime() === startToday.getTime()) return 'Today';
    if (startTarget.getTime() === startYesterday.getTime()) return 'Yesterday';

    return target.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' });
}
function toNumber(x) {
    const n = typeof x === 'string' ? parseFloat(x) : x;
    return isNaN(n) ? 0 : n;
}

/* ---------- Rendering ---------- */
function renderMobileExpenseList(expArr) {
    // Lazy create container if not present
    let container = document.getElementById('expenses-mobile-list');
    if (!container) {
        container = document.createElement('div');
        container.id = 'expenses-mobile-list';
        // Put it right before the desktop table
        const deskTable = document.getElementById('expenses-table') || document.querySelector('#expensesTable');
        deskTable?.parentNode?.insertBefore(container, deskTable);
    }

    // Hide desktop table only on mobile
    const isMobile = window.matchMedia('(max-width:640px)').matches;
    container.style.display = isMobile ? 'block' : 'none';

    if (!isMobile) return; // bail early on desktop

    if (!Array.isArray(expArr) || expArr.length === 0) {
        container.innerHTML = '<p class="text-center py-6 text-sm text-gray-400">No expenses yet</p>';
        return;
    }

    /* ----- group by date ----- */
    const grouped = expArr.reduce((acc, exp) => {
        const key = stripISO(exp.date);
        if (!acc[key]) acc[key] = [];
        acc[key].push(exp);
        return acc;
    }, {});

    const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));

    let html = '';
    sortedDates.forEach(dateKey => {
        const dayExpenses = grouped[dateKey];
        const dayTotal = dayExpenses.reduce((s,e)=> s + toNumber(e.cost), 0);

        /* Date header */
        html += `
            <div style="padding:8px 12px;font-weight:600;font-size:14px;color:#555;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span>${dateLabel(dateKey)}</span>
                    <span>- ${formatCurrency(dayTotal)}</span>
                </div>
            </div>`;

        /* Cards */
        dayExpenses.forEach(exp => {
            const icon = categoryIcons?.[exp.category] ?? 'â“';
            html += `
            <div onclick="editExpense(${exp.id})" style="
                 display:flex;align-items:center;gap:12px;
                 padding:12px;margin:4px 12px;background:#fff;
                 border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06);cursor:pointer;">
                <span style="font-size:22px;">${icon}</span>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:500;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;">${escapeHTML(exp.name)}</div>
                    <div style="font-size:12px;color:#666;">${escapeHTML(exp.category)}</div>
                </div>
                <div style="font-weight:600;white-space:nowrap;">${exp.type === 'Income' ? '' : '-'}${formatCurrency(toNumber(exp.cost))}</div>
            </div>`;
        });
    });

    container.innerHTML = html;
}

/* ---------- Hook into existing flow ---------- */
// Mobile rendering integration - do this after DOM loads when functions are defined
document.addEventListener('DOMContentLoaded', () => {
    // Store the original render function before wrapping
    const originalRenderExpensesTable = window.renderExpensesTable;
    
    if (originalRenderExpensesTable) {
        // Wrap the renderExpensesTable function to add mobile rendering
        window.renderExpensesTable = function() {
            // Call the original function first
            originalRenderExpensesTable.apply(this, arguments);
            
            // Then add mobile rendering with filtered and paginated data
            if (typeof getFilteredExpenses === 'function') {
                const filteredExpenses = getFilteredExpenses();
                const currentPage = window.expensesCurrentPage || 1;
                const itemsPerPage = window.expensesItemsPerPage || 15;
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageItems = filteredExpenses.slice(startIndex, endIndex);
                renderMobileExpenseList(pageItems);
            } else {
                const expensesArr = window.expenses ?? [];
                renderMobileExpenseList(expensesArr);
            }
        };
    }

    // Re-render on resize (cheap debounce)
    let resizeTo = null;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTo);
        resizeTo = setTimeout(() => {
            if (window.renderExpensesTable) {
                window.renderExpensesTable();
            }
        }, 150);
    });
}); 



// ]]>
</script>

<!-- Added by ChatGPT 2025-06-22 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  /* Rename Monthly Commitment to Monthly Contribution */
  document.querySelectorAll('label').forEach(lbl => {
    if(/Monthly Commitment/i.test(lbl.textContent)) {
      lbl.textContent = lbl.textContent.replace(/Commitment/i, 'Contribution');
    }
  });

  /* Lock body scroll when confirmation overlay is visible */
  const overlay = document.getElementById('goal-confirmation-overlay');
  if (overlay) {
    const observer = new MutationObserver(() => {
      if (!overlay.classList.contains('hidden')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    });
    observer.observe(overlay, { attributes: true, attributeFilter: ['class'] });
  }

  /* Microâ€‘copy for emergency fund inputs */
  const cleanStep3 = document.getElementById('clean-step-3');
  if (cleanStep3) {
    const title = cleanStep3.querySelector('h3');
    if (title && /Emergency Fund/i.test(title.textContent)) {
      cleanStep3.querySelectorAll('input[type="number"]').forEach(input => {
        const note = document.createElement('div');
        note.className = 'text-xs text-gray-500 mt-1';
        note.innerText = 'Only enter whatâ€™s earmarked specifically for emergencies.';
        input.parentElement.appendChild(note);
      });
    }
  }
});

/* APR â€œI donâ€™t knowâ€ helper */
function toggleAprUnknown(box) {
  const item = box.closest('.clean-debt-item');
  if (!item) return;
  const interestInput = item.querySelector('.debt-interest');
  if (!interestInput) return;
  if (box.checked) {
    interestInput.value = '';
    interestInput.disabled = true;
    interestInput.placeholder = 'N/A';
  } else {
    interestInput.disabled = false;
    interestInput.placeholder = '18.9%';
  }
}

/* Patch addCleanDebt to append the unknownâ€‘APR checkbox */
(function() {
  if (!window.addCleanDebt) return;
  const originalAddCleanDebt = window.addCleanDebt;
  window.addCleanDebt = function() {
    originalAddCleanDebt();
    const debtList = document.getElementById('clean-debt-list');
    const item = debtList ? debtList.lastElementChild : null;
    if (item && !item.querySelector('.apr-unknown')) {
      const interestInput = item.querySelector('input[type="number"]');
      if (interestInput) interestInput.classList.add('debt-interest');
      const wrapper = document.createElement('div');
      wrapper.className = 'flex items-center mt-1';
      wrapper.innerHTML = '<input type="checkbox" class="apr-unknown mr-2" onclick="toggleAprUnknown(this)"><span class="text-xs">I donâ€™t know the APR</span>';
      const grid = item.querySelector('.grid');
      if (grid) {
        grid.appendChild(wrapper);
      }
    }
  };
})();
</script>


<!-- ==== Hotâ€‘fix overrides (safe, no core edits) ==== -->
<script>
/* Override addCleanDebt and updateFinancialPreview without touching original functions */
(function(){
    function fmt(n){return 'Â£'+(Number(n)||0).toLocaleString();}
    window.addCleanDebt = function addCleanDebt(){
        const list=document.getElementById('clean-debt-list');if(!list)return;
        const row=document.createElement('div');row.className='clean-debt-item';
        row.innerHTML=`
            <div class="space-y-3">
                <input type="text" placeholder="Debt name (e.g., Credit Card)" class="modern-input debt-name text-sm font-medium text-center">
                <div class="grid grid-cols-2 gap-2">
                    <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">Â£</span>
                        <input type="number" placeholder="5,000" class="modern-input debt-balance pl-7 font-semibold text-center" oninput="updateFinancialPreview()">
                    </div>
                    <input type="number" placeholder="18.9%" step="0.1" class="modern-input debt-interest font-semibold text-center" oninput="updateFinancialPreview()">
                </div>
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" class="debt-no-apr"> I donâ€™t know the APR
                </label>
                <button onclick="removeCleanDebt(this)" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
            </div>`;
        list.appendChild(row);
        const chk=row.querySelector('.debt-no-apr');const apr=row.querySelector('.debt-interest');
        chk.addEventListener('change',()=>{if(chk.checked){apr.dataset.v=apr.value;apr.value='';apr.placeholder='N/A';apr.disabled=true;}else{apr.disabled=false;apr.placeholder='18.9%';if(apr.dataset.v)apr.value=apr.dataset.v;}updateFinancialPreview();});
        updateFinancialPreview();
    };
    window.updateFinancialPreview = function updateFinancialPreview(){
        const prev=document.getElementById('financial-impact-preview');if(!prev)return;
        const s=parseFloat(document.getElementById('clean-total-savings-input')?.value)||0;
        let d=0;document.querySelectorAll('.clean-debt-item').forEach(r=>{d+=parseFloat(r.querySelector('.debt-balance').value)||0;});
        const nw=s-d;const pay=d?Math.max(d*0.02,25):0;
        cleanOnboardingData.data.totalSavings=s;
        cleanOnboardingData.data.debts=[...document.querySelectorAll('.clean-debt-item')].map(r=>({name:r.querySelector('.debt-name').value||'',balance:parseFloat(r.querySelector('.debt-balance').value)||0,apr:parseFloat(r.querySelector('.debt-interest').value)||0}));
        document.getElementById('preview-savings').textContent=fmt(s);
        document.getElementById('preview-debt').textContent=fmt(d);
        const n=document.getElementById('preview-net-worth');if(n){n.textContent=fmt(nw);n.className='font-mono '+(nw>=0?'text-green-600':'text-red-600');}
        document.getElementById('preview-debt-payments').textContent=fmt(pay);
        prev.classList.remove('hidden');
    };
})();
</script>

</body>
</html>
