
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc; /* Light gray background */
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b; /* Dark slate */
            --text-secondary: #64748b; /* Medium slate */
            --text-tertiary: #94a3b8; /* Light slate */
            --border-color: #e2e8f0;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --help-text-color: #374151;
            --health-score-good: var(--accent-green);
            --health-score-ok: var(--accent-yellow);
            --health-score-bad: var(--accent-red);
        }
        .dark {
            --bg-primary: #0f172a; /* Very dark blue */
            --bg-secondary: #1e293b; /* Dark blue */
            --bg-tertiary: #334155; /* Medium dark blue */
            --text-primary: #f1f5f9; /* Light gray */
            --text-secondary: #cbd5e1; /* Medium gray */
            --text-tertiary: #94a3b8; /* Darker gray */
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --help-text-color: #d1d5db;
        }
        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .stat-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
            text-align: center;
        }
        .dark .stat-card {
             background-color: var(--bg-tertiary);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .stat-card-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        .stat-card-value {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* bold */
            color: var(--text-primary);
            line-height: 1.2;
        }
        .stat-card-value.text-green-600 { color: var(--accent-green); }
        .stat-card-value.text-red-600 { color: var(--accent-red); }
        .dark .stat-card-value.text-green-600 { color: #34d399; } /* Lighter green */
        .dark .stat-card-value.text-red-600 { color: #f87171; } /* Lighter red */
        
        /* Info Icon Styling */
        .info-icon {
            cursor: help;
            display: inline-flex;
            vertical-align: middle;
            color: var(--text-tertiary);
            transition: color 0.2s;
        }
        .info-icon:hover {
            color: var(--accent-blue);
        }
        /* Tooltip styling */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: normal;
            z-index: 50;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            max-width: 300px;
            width: max-content;
        }

        .tab-button {
            position: relative;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab-button:hover {
            color: var(--text-primary);
        }
        .tab-button.active {
            color: var(--accent-blue);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-blue);
            border-radius: 1px;
        }
        .modern-input, .modern-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
            appearance: none;
        }
        .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem;
        }
        .dark .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .modern-input:focus, .modern-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .modern-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .modern-button-primary {
            background-color: var(--accent-blue);
            color: white;
        }
        .modern-button-primary:hover {
            background-color: #2563eb;
            box-shadow: var(--shadow-md);
        }
         .modern-button-primary:active {
            transform: translateY(1px);
        }
        .modern-button-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .modern-button-secondary:hover {
            background-color: var(--border-color);
        }
        .modern-button-danger {
            background-color: var(--accent-red);
            color: white;
        }
        .modern-button-danger:hover {
             background-color: #dc2626;
             box-shadow: var(--shadow-md);
        }
        .icon-button {
            padding: 0.5rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        .icon-button:hover {
            color: var(--text-primary);
        }
        .icon-button svg {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        .dropdown-menu {
            position: absolute;
            margin-top: 0.5rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 50;
            min-width: 220px; /* Wider for import/export */
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: background-color 0.2s ease, color 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .dropdown-item:hover {
            background-color: var(--bg-secondary);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        .dark .status-active {
             background-color: rgba(16, 185, 129, 0.2);
             color: #10b981;
        }
        .status-cancelled {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            text-decoration: line-through;
        }
         .dark .status-cancelled {
             background-color: rgba(239, 68, 68, 0.2);
             color: #ef4444;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #2d3748;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 100;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #trends-tab canvas {
            max-width: 100%;
            height: auto;
        }
        .chart-container {
            position: relative; 
            height: 350px;
            width: 100%;
        }
        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-blue);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        /* Help Tab Contrast */
        #help-tab p, #help-tab li {
            color: var(--help-text-color);
            transition: color 0.3s;
        }
        #help-tab h3 {
             color: var(--text-primary);
             transition: color 0.3s;
        }
        #help-tab strong {
            color: var(--text-primary);
            transition: color 0.3s;
        }
        #help-tab ul {
            margin-left: 1rem;
        }
        /* Table Checkbox */
        .table-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        /* Budget Health Score */
        .health-score-container {
            position: relative;
            width: 150px;
            height: 75px; /* Half circle */
            overflow: hidden;
            margin: 1rem auto 0;
        }
        .health-score-gauge {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--bg-tertiary);
            border-bottom-color: transparent;
            border-left-color: transparent;
            transform: rotate(-135deg); /* Start from bottom-left */
            box-sizing: border-box;
        }
        .health-score-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--health-score-good); /* Default color */
            border-top-color: transparent;
            border-right-color: transparent;
            transform: rotate(45deg); /* Start from bottom-left, fill clockwise */
            transform-origin: center center;
            clip-path: polygon(50% 0%, 100% 0%, 100% 50%, 50% 50%); /* Clip to top-right quadrant initially */
            transition: transform 1s ease-out, border-color 0.5s ease;
            box-sizing: border-box;
        }
        .health-score-text {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            color: var(--text-primary);
        }
        .health-score-label {
            font-size: 0.875rem; /* text-sm */
            color: var(--text-secondary);
            margin-top: -5px;
        }
        /* AI Insights Styling */
        .ai-insight {
            background-color: rgba(59, 130, 246, 0.05); /* Light blue bg */
            border-left: 4px solid var(--accent-blue);
            padding: 1rem;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        .dark .ai-insight {
            background-color: rgba(59, 130, 246, 0.1);
            border-left-color: var(--accent-blue);
            color: var(--text-secondary);
        }
        .ai-insight strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        /* Consistent Dark Mode */
        html.dark body { background-color: var(--bg-secondary); color: var(--text-primary); }
        html.dark .card { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .stat-card { background-color: var(--bg-tertiary); border-color: var(--border-color); }
        html.dark .modern-input, html.dark .modern-select { background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        html.dark .modern-button-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        html.dark .modern-button-secondary:hover { background-color: var(--border-color); }
        html.dark .tab-button { color: var(--text-secondary); }
        html.dark .tab-button:hover { color: var(--text-primary); }
        html.dark .tab-button.active { color: var(--accent-blue); }
        html.dark .icon-button { color: var(--text-secondary); }
        html.dark .icon-button:hover { color: var(--text-primary); }
        html.dark .dropdown-menu { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .dropdown-item { color: var(--text-primary); }
        html.dark .dropdown-item:hover { background-color: var(--bg-secondary); }
        html.dark table thead { background-color: var(--bg-tertiary); color: var(--text-secondary); }
        html.dark table tbody tr { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark table tbody tr:hover { background-color: var(--bg-secondary); }
        html.dark table tbody td { color: var(--text-secondary); }
        html.dark table tbody td:first-child { color: var(--text-primary); }
        html.dark #help-tab p, html.dark #help-tab li { color: var(--help-text-color); }
        html.dark #help-tab h3, html.dark #help-tab strong { color: var(--text-primary); }
        html.dark .health-score-gauge { border-color: var(--bg-tertiary); border-bottom-color: transparent; border-left-color: transparent; }
        html.dark .health-score-text { color: var(--text-primary); }
        html.dark .health-score-label { color: var(--text-secondary); }

    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen p-4 md:p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header & Navigation Combined -->
            <div class="card mb-6">
                <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">💡</span> <!-- Changed Icon -->
                            <h1 class="text-2xl md:text-3xl font-bold">AI Expense Tracker</h1>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- Settings Button and Menu -->
                            <div class="relative inline-block text-left">
                                <button onclick="toggleSettings()" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                                    <span class="hidden sm:inline">Settings</span>
                                </button>
                                <div id="settings-menu" class="dropdown-menu absolute right-0 mt-2 w-60 origin-top-right hidden">
                                    <div class="py-1" role="menu" aria-orientation="vertical">
                                        <div class="dropdown-item">
                                            <label for="theme-toggle" class="flex-grow text-sm leading-5">Dark Mode</label>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="theme-toggle" onchange="toggleTheme(this.checked)">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                        <div class="dropdown-item">
                                            <label for="currency-select" class="text-sm leading-5">Currency</label>
                                            <select id="currency-select" onchange="changeCurrency(this.value)" class="modern-select text-sm flex-grow ml-2">
                                                <option value="GBP">GBP (£)</option>
                                                <option value="EUR">EUR (€)</option>
                                                <option value="JPY">JPY (¥)</option>
                                                <option value="USD">USD ($)</option>
                                            </select>
                                        </div>
                                        <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                        <div class="dropdown-item" onclick="exportData()">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                            <span class="text-sm">Export Data (JSON)</span>
                                        </div>
                                        <label class="dropdown-item cursor-pointer">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                                            <span class="text-sm">Import Data (JSON)</span>
                                            <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-4 sm:space-x-8 px-4 md:px-6 overflow-x-auto" aria-label="Tabs">
                        <button onclick="showTab('overview')" id="tab-overview" class="tab-button active">Overview</button>
                        <button onclick="showTab('expenses')" id="tab-expenses" class="tab-button">Expenses</button>
                        <button onclick="showTab('recurring')" id="tab-recurring" class="tab-button">Recurring</button>
                        <button onclick="showTab('trends')" id="tab-trends" class="tab-button">Trends</button>
                        <button onclick="showTab('savings')" id="tab-savings" class="tab-button">Savings AI</button> <!-- New Tab -->
                        <button onclick="showTab('help')" id="tab-help" class="tab-button">Help</button>
                    </nav>
                </div>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column: Key Stats & Budget Health -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Key Stats Row -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="stat-card bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800">
                                <div class="stat-card-title">Monthly Budget</div>
                                <div class="stat-card-value text-blue-600 dark:text-blue-400" id="monthly-budget">£0.00</div>
                            </div>
                            <div class="stat-card bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800">
                                <div class="stat-card-title">Spent (Month)</div>
                                <div class="stat-card-value text-red-600" id="total-expenses">£0.00</div>
                            </div>
                            <div class="stat-card bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800">
                                <div class="stat-card-title">Remaining</div>
                                <div class="stat-card-value text-green-600" id="remaining-amount">£0.00</div>
                            </div>
                             <div class="stat-card bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-800">
                                <div class="stat-card-title">
                                    Income (Month)
                                    <span class="info-icon ml-1" data-tooltip="Total monthly income = Base monthly income + Recurring income items">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                        </svg>
                                    </span>
                                </div>
                                <div class="stat-card-value text-purple-600 dark:text-purple-400" id="total-income">£0.00</div>
                            </div>
                        </div>

                        <!-- Budget Health & Progress -->
                        <div class="card p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                                <div class="md:col-span-2">
                                    <h3 class="text-lg font-semibold mb-1">Budget Progress</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">How you're tracking against your monthly budget.</p>
                                    <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 mb-2">
                                        <div id="budget-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                                    </div>
                                    <p id="budget-percentage" class="text-right text-sm text-gray-600 dark:text-gray-400">0% Used</p>
                                </div>
                                <div class="text-center">
                                    <h3 class="text-lg font-semibold mb-2">Budget Health</h3>
                                    <div class="health-score-container">
                                        <div class="health-score-gauge"></div>
                                        <div id="health-score-fill" class="health-score-fill"></div>
                                        <div class="health-score-text">
                                            <span id="health-score-value">0</span>
                                            <div id="health-score-label" class="health-score-label">Loading...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Essential vs Non-Essential -->
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Spending Breakdown (Month)</h3>
                            <div class="flex justify-around items-center text-center mb-4">
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Essential</p>
                                    <p class="text-2xl font-semibold text-orange-600 dark:text-orange-400" id="essential-spending">£0.00</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Non-Essential</p>
                                    <p class="text-2xl font-semibold text-pink-600 dark:text-pink-400" id="non-essential-spending">£0.00</p>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700">
                                <div id="essential-bar" class="bg-orange-500 h-3 rounded-l-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div><!--
                             --><div id="non-essential-bar" class="bg-pink-500 h-3 rounded-r-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Actions & Recent Activity -->
                    <div class="space-y-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300">Set Monthly Budget</label>
                                    <input type="number" id="budget-input" placeholder="e.g., 4000" onchange="updateBudget(this.value)" class="modern-input">
                                </div>
                                 <div>
                                    <label class="text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300">Set Monthly Income</label>
                                    <input type="number" id="income-input" placeholder="e.g., 6000" onchange="updateIncome(this.value)" class="modern-input">
                                </div>
                                <button onclick="showAddForm()" class="modern-button modern-button-primary w-full">
                                    <span>➕</span> Add New Expense
                                </button>
                                <button onclick="showRecurringForm()" class="modern-button modern-button-secondary w-full">
                                    <span>🔁</span> Add Recurring Item
                                </button>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Quick Add Common Expenses</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="quickAddExpense('Coffee', 'Food', 'Non Essential')" class="modern-button modern-button-secondary text-sm justify-start">☕ Coffee</button>
                                <button onclick="quickAddExpense('Transport', 'Transport', 'Essential')" class="modern-button modern-button-secondary text-sm justify-start">🚌 Transport</button>
                                <button onclick="quickAddExpense('Lunch', 'Food', 'Non Essential')" class="modern-button modern-button-secondary text-sm justify-start">🥪 Lunch</button>
                                <button onclick="quickAddExpense('Groceries', 'Food', 'Essential')" class="modern-button modern-button-secondary text-sm justify-start">🛒 Groceries</button>
                            </div>
                        </div>

                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                            <div id="recent-expenses" class="space-y-3 max-h-60 overflow-y-auto">
                                <p class="text-gray-500 dark:text-gray-400">No recent expenses.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses-tab" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-4">
                        <h2 class="text-xl font-semibold">All Expenses</h2>
                        <div class="flex gap-3">
                            <button onclick="toggleFilterPanel('expense-filter-controls')" class="modern-button modern-button-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                </svg>
                                Filters
                            </button>
                            <button id="delete-selected-btn" onclick="deleteSelectedExpenses()" class="modern-button modern-button-danger hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                <span>Delete Selected</span>
                            </button>
                            <button onclick="showAddForm()" class="modern-button modern-button-primary">
                                 <span>➕</span> Add Expense
                             </button>
                         </div>
                    </div>
                    
                    <!-- Filter Panel -->
                    <div id="expense-filter-controls" class="p-4 border-b border-gray-200 dark:border-gray-700 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <!-- Date Range -->
                            <div>
                                <label class="text-sm font-medium mb-1 block">Date Range</label>
                                <div class="flex gap-2">
                                    <input type="date" id="expense-filter-date-from" class="modern-input">
                                    <input type="date" id="expense-filter-date-to" class="modern-input">
                                </div>
                            </div>
                            <!-- Category -->
                            <div>
                                <label class="text-sm font-medium mb-1 block">Category</label>
                                <select id="expense-filter-category" class="modern-select">
                                    <option value="">All Categories</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <!-- Type -->
                            <div>
                                <label class="text-sm font-medium mb-1 block">Type</label>
                                <select id="expense-filter-type" class="modern-select">
                                    <option value="">All Types</option>
                                    <option value="Essential">Essential</option>
                                    <option value="Non Essential">Non-Essential</option>
                                </select>
                            </div>
                            <!-- Clear Filters -->
                            <div class="md:col-span-3 flex justify-end">
                                <button onclick="applyExpenseFilters()" class="modern-button modern-button-primary mr-2">Apply Filters</button>
                                <button onclick="clearExpenseFilters()" class="modern-button modern-button-secondary">Clear Filters</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th scope="col" class="px-4 py-3 w-1">
                                        <input type="checkbox" id="select-all-expenses" onchange="toggleSelectAllExpenses(this.checked)" class="table-checkbox">
                                    </th>
                                    <th scope="col" class="px-6 py-3">Name</th>
                                    <th scope="col" class="px-6 py-3">Amount</th>
                                    <th scope="col" class="px-6 py-3 hidden md:table-cell">Date</th>
                                    <th scope="col" class="px-6 py-3 hidden md:table-cell">Category</th>
                                    <th scope="col" class="px-6 py-3 hidden lg:table-cell">Payment Method</th>
                                    <th scope="col" class="px-6 py-3 hidden lg:table-cell">Type</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table">
                                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                    <td colspan="9" class="px-6 py-4 text-center">No expenses recorded yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

             <!-- Recurring Tab -->
            <div id="recurring-tab" class="tab-content hidden fade-in">
                <div class="card">
                    <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-4">
                        <h2 class="text-xl font-semibold">Recurring Income & Expenses</h2>
                        <div class="flex gap-3">
                            <button onclick="toggleFilterPanel('recurring-filter-controls')" class="modern-button modern-button-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                </svg>
                                Filters
                            </button>
                            <button onclick="showRecurringForm()" class="modern-button modern-button-primary">
                                <span>➕</span> Add Recurring Item
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter Panel -->
                    <div id="recurring-filter-controls" class="p-4 border-b border-gray-200 dark:border-gray-700 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <!-- Type -->
                            <div>
                                <label class="text-sm font-medium mb-1 block">Type</label>
                                <select id="recurring-filter-type" class="modern-select">
                                    <option value="">All Types</option>
                                    <option value="income">Income</option>
                                    <option value="expense">Expense</option>
                                </select>
                            </div>
                            <!-- Category -->
                            <div>
                                <label class="text-sm font-medium mb-1 block">Category</label>
                                <select id="recurring-filter-category" class="modern-select">
                                    <option value="">All Categories</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <!-- Frequency -->
                            <div>
                                <label class="text-sm font-medium mb-1 block">Frequency</label>
                                <select id="recurring-filter-frequency" class="modern-select">
                                    <option value="">All Frequencies</option>
                                    <option value="Monthly">Monthly</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Bi-Weekly">Bi-Weekly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Annual">Annual</option>
                                </select>
                            </div>
                            <!-- Clear Filters -->
                            <div class="md:col-span-3 flex justify-end">
                                <button onclick="applyRecurringFilters()" class="modern-button modern-button-primary mr-2">Apply Filters</button>
                                <button onclick="clearRecurringFilters()" class="modern-button modern-button-secondary">Clear Filters</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Name</th>
                                    <th scope="col" class="px-6 py-3">Amount</th>
                                    <th scope="col" class="px-6 py-3">Frequency</th>
                                    <th scope="col" class="px-6 py-3 hidden md:table-cell">Category</th>
                                    <th scope="col" class="px-6 py-3 hidden lg:table-cell">Payment Method</th>
                                    <th scope="col" class="px-6 py-3 hidden md:table-cell">Start Date</th>
                                    <th scope="col" class="px-6 py-3">Type</th>
                                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recurring-table">
                                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                    <td colspan="8" class="px-6 py-4 text-center">No recurring items recorded yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div id="trends-tab" class="tab-content hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4">Monthly Spending Trend</h2>
                        <div class="chart-container">
                            <canvas id="spending-trend-chart"></canvas>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4">Spending by Category (Month)</h2>
                        <div class="chart-container">
                             <canvas id="category-spending-chart"></canvas>
                        </div>
                    </div>
                </div>
                 <div class="card p-6">
                     <h2 class="text-xl font-semibold mb-4">Spending Patterns & Insights</h2>
                     <div id="spending-insights" class="space-y-4">
                         <!-- This will be replaced by renderAiInsights function -->
                     </div>
                 </div>
            </div>

            <!-- Savings AI Tab -->
            <div id="savings-tab" class="tab-content hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Savings Goal & Projection -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="card p-6">
                            <h2 class="text-xl font-semibold mb-4">Savings Goal & Projection</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Set Annual Savings Goal</label>
                                    <input type="number" id="savings-goal-input" placeholder="e.g., 24000" onchange="updateSavingsGoal(this.value)" class="modern-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Current Savings (Optional)</label>
                                    <input type="number" id="current-savings-input" placeholder="e.g., 5000" onchange="updateCurrentSavings(this.value)" class="modern-input">
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Progress Towards Goal</span>
                                    <span class="text-sm font-medium" id="savings-goal-percentage">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700">
                                    <div id="savings-goal-bar" class="h-3 rounded-full bg-purple-500 transition-all duration-500 ease-out" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="stat-card bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-800">
                                    <div class="stat-card-title">
                                        Projected Annual Savings
                                        <span class="info-icon ml-1" data-tooltip="Calculated as: Average Monthly Savings × 12. Uses data from the last 3 months when available.">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="stat-card-value text-purple-600 dark:text-purple-400" id="projected-savings">£0.00</div>
                                </div>
                                <div class="stat-card bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800">
                                    <div class="stat-card-title">
                                        On Track?
                                        <span class="info-icon ml-1" data-tooltip="'Yes' if your Projected Annual Savings meets or exceeds your Annual Savings Goal. 'No' if it falls short.">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="stat-card-value text-green-600" id="savings-on-track">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h2 class="text-xl font-semibold mb-4">Monthly Savings Trend</h2>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="monthly-savings-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- AI Insights -->
                    <div class="space-y-6">
                        <div class="card p-6">
                            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                <span>AI Spending & Savings Insights</span>
                            </h2>
                            <div id="ai-insights" class="space-y-4">
                                <p class="text-gray-500 dark:text-gray-400">AI analysis will appear here once you have enough data...</p>
                                <!-- AI Insights will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Help Tab -->
            <div id="help-tab" class="tab-content hidden fade-in">
                <div class="card p-8">
                    <h2 class="text-2xl font-semibold mb-6">Help & Documentation</h2>
                    <div class="space-y-6 text-sm leading-relaxed">
                        <section>
                            <h3 class="text-lg font-semibold mb-2">Welcome!</h3>
                            <p>
                                This AI Expense Tracker helps you manage your finances effectively. Track expenses, recurring items, income, and savings goals. Get AI-powered insights to improve your financial habits.
                            </p>
                        </section>
                        <section>
                            <h3 class="text-lg font-semibold mb-2">Overview Tab</h3>
                            <p>
                                Your financial dashboard. See key stats like budget, spending, remaining funds, and monthly income. Monitor your budget progress and check your <strong class="font-medium">Budget Health Score</strong> (aim for 70+). Use Quick Actions to set your budget/income and add items.
                            </p>
                        </section>
                        <section>
                            <h3 class="text-lg font-semibold mb-2">Expenses Tab</h3>
                            <p>
                                Log and manage all your one-time expenses. Add, edit, cancel/reactivate, or delete expenses. Use the checkboxes for bulk deletion.
                            </p>
                        </section>
                        <section>
                            <h3 class="text-lg font-semibold mb-2">Recurring Tab</h3>
                            <p>
                                Manage regular income (like salary) and expenses (like rent or subscriptions). Set frequency, start/end dates.
                            </p>
                        </section>
                        <section>
                            <h3 class="text-lg font-semibold mb-2">Trends Tab</h3>
                            <p>
                                Visualize your spending patterns with charts showing monthly trends and category breakdowns. Get basic insights into your spending habits.
                            </p>
                        </section>
                        <section>
                            <h3 class="text-lg font-semibold mb-2">Savings AI Tab</h3>
                            <p>
                                Set your annual savings goal and track your progress. See your projected annual savings based on current income and spending. Monitor your monthly savings trend. Get <strong class="font-medium">AI-powered insights</strong> on how to optimize spending and reach your goals faster.
                            </p>
                        </section>
                        <section>
                            <h3 class="text-lg font-semibold mb-2">Settings</h3>
                            <p>
                                Access settings via the ⚙️ icon. Toggle Dark Mode, change currency (GBP, EUR, JPY, USD), and <strong class="font-medium">Import/Export</strong> your data as a JSON file for backup or transfer.
                            </p>
                        </section>
                         <section>
                            <h3 class="text-lg font-semibold mb-2">Budget Health Score</h3>
                            <p>
                                This score (0-100) reflects how well you're managing your budget this month. It considers spending vs budget, spending consistency, and essential vs non-essential ratio. <strong class="font-medium text-green-600 dark:text-green-400">Good: 70+</strong>, <strong class="font-medium text-yellow-600 dark:text-yellow-400">Okay: 40-69</strong>, <strong class="font-medium text-red-600 dark:text-red-400">Needs Improvement: 0-39</strong>.
                            </p>
                        </section>
                        <section>
                            <h3 class="text-lg font-semibold mb-2">Data Storage</h3>
                            <p>
                                All data is saved locally in your browser. Clearing browser data will erase your tracker information. Use the Export feature for backups.
                            </p>
                        </section>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Add/Edit Expense Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="card max-w-lg w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-6" id="modal-title">Add New Expense</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="expense-name" placeholder="e.g., Coffee, Rent" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="modal-currency">£</span>)</label>
                        <input type="number" step="0.01" id="expense-cost" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" id="expense-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="expense-category" class="modern-select mt-1">
                            <option value="Housing">Housing</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Transport">Transport</option>
                            <option value="Food">Food</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Health">Health</option>
                            <option value="Personal Care">Personal Care</option>
                            <option value="Education">Education</option>
                            <option value="Debt">Debt</option>
                            <option value="Subscriptions">Subscriptions</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                        <select id="expense-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non Essential">Non Essential</option>
                        </select>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="expense-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                        <select id="expense-frequency" class="modern-select mt-1" disabled title="Set frequency in Recurring tab">
                            <option value="One-time">One-time</option>
                        </select>
                         <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use Recurring tab for repeated items.</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveExpense()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Recurring Item Modal -->
    <div id="recurring-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="card max-w-lg w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-4" id="recurring-modal-title">Add Recurring Item</h3>
            <div class="space-y-4">
                 <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                    <select id="recurring-item-type" class="modern-select mt-1" onchange="toggleRecurringCategory(this.value)">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="recurring-name" placeholder="e.g., Salary, Netflix" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="recurring-modal-currency">£</span>)</label>
                        <input type="number" step="0.01" id="recurring-amount" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                        <select id="recurring-frequency" class="modern-select mt-1">
                            <option value="Weekly">Weekly</option>
                            <option value="Bi-Weekly">Bi-Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Annual">Annual</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="recurring-category" class="modern-select mt-1">
                            <!-- Options loaded dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="recurring-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                        <input type="date" id="recurring-start-date" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date (Optional)</label>
                        <input type="date" id="recurring-end-date" class="modern-input mt-1">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveRecurring()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeRecurringModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // --- State Variables ---
        let expenses = [];
        let recurringItems = [];
        let monthlyBudget = 0;
        let monthlyIncome = 0;
        let annualSavingsGoal = 0;
        let currentSavings = 0;
        let currencyConfig = {
            'GBP': { symbol: '£', locale: 'en-GB' },
            'EUR': { symbol: '€', locale: 'de-DE' },
            'JPY': { symbol: '¥', locale: 'ja-JP' },
            'USD': { symbol: '$', locale: 'en-US' }
        };
        let currentCurrencyCode = 'GBP';
        let editingExpense = null;
        let editingRecurring = null;
        let activeTab = 'overview';
        let spendingTrendChart = null;
        let categorySpendingChart = null;
        let monthlySavingsChart = null;
        let selectedExpenseIds = new Set();
        let aiInsightsCache = null; // Cache for AI insights
        let lastAiUpdate = 0;

        const expenseCategories = ["Housing", "Utilities", "Transport", "Food", "Entertainment", "Shopping", "Health", "Personal Care", "Education", "Debt", "Subscriptions", "Other"];
        const incomeCategories = ["Salary", "Bonus", "Investment", "Gift", "Other Income"];

        // --- DOM Elements Cache ---
        const DOMElements = {
            html: document.documentElement,
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            expenseName: document.getElementById('expense-name'),
            expenseCost: document.getElementById('expense-cost'),
            expenseType: document.getElementById('expense-type'),
            expenseFrequency: document.getElementById('expense-frequency'),
            expenseCategory: document.getElementById('expense-category'),
            expenseDate: document.getElementById('expense-date'),
            expensePaymentMethod: document.getElementById('expense-payment-method'),
            modalCurrency: document.getElementById('modal-currency'),

            recurringModal: document.getElementById('recurring-modal'),
            recurringModalTitle: document.getElementById('recurring-modal-title'),
            recurringItemType: document.getElementById('recurring-item-type'),
            recurringName: document.getElementById('recurring-name'),
            recurringAmount: document.getElementById('recurring-amount'),
            recurringFrequency: document.getElementById('recurring-frequency'),
            recurringCategory: document.getElementById('recurring-category'),
            recurringPaymentMethod: document.getElementById('recurring-payment-method'),
            recurringStartDate: document.getElementById('recurring-start-date'),
            recurringEndDate: document.getElementById('recurring-end-date'),
            recurringModalCurrency: document.getElementById('recurring-modal-currency'),

            monthlyBudgetDisplay: document.getElementById('monthly-budget'),
            budgetInput: document.getElementById('budget-input'),
            incomeInput: document.getElementById('income-input'),
            totalExpensesDisplay: document.getElementById('total-expenses'),
            remainingAmountDisplay: document.getElementById('remaining-amount'),
            totalIncomeDisplay: document.getElementById('total-income'),
            budgetBar: document.getElementById('budget-bar'),
            budgetPercentage: document.getElementById('budget-percentage'),
            healthScoreFill: document.getElementById('health-score-fill'),
            healthScoreValue: document.getElementById('health-score-value'),
            healthScoreLabel: document.getElementById('health-score-label'),
            essentialSpendingDisplay: document.getElementById('essential-spending'),
            nonEssentialSpendingDisplay: document.getElementById('non-essential-spending'),
            essentialBar: document.getElementById('essential-bar'),
            nonEssentialBar: document.getElementById('non-essential-bar'),
            recentExpensesContainer: document.getElementById('recent-expenses'),
            expensesTableBody: document.getElementById('expenses-table'),
            recurringTableBody: document.getElementById('recurring-table'),
            settingsMenu: document.getElementById('settings-menu'),
            themeToggle: document.getElementById('theme-toggle'),
            currencySelect: document.getElementById('currency-select'),
            toast: document.getElementById('toast'),
            spendingTrendCanvas: document.getElementById('spending-trend-chart'),
            categorySpendingCanvas: document.getElementById('category-spending-chart'),
            spendingInsightsContainer: document.getElementById('spending-insights'),
            selectAllExpensesCheckbox: document.getElementById('select-all-expenses'),
            deleteSelectedBtn: document.getElementById('delete-selected-btn'),
            savingsGoalInput: document.getElementById('savings-goal-input'),
            currentSavingsInput: document.getElementById('current-savings-input'),
            savingsGoalBar: document.getElementById('savings-goal-bar'),
            savingsGoalPercentage: document.getElementById('savings-goal-percentage'),
            projectedSavingsDisplay: document.getElementById('projected-savings'),
            savingsOnTrackDisplay: document.getElementById('savings-on-track'),
            monthlySavingsCanvas: document.getElementById('monthly-savings-chart'),
            aiInsightsContainer: document.getElementById('ai-insights'),
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            populateCategoryDropdowns();
            applyTheme();
            updateCurrencyUI();
            updateDisplay();
            showTab(activeTab);
            DOMElements.budgetInput.value = monthlyBudget > 0 ? monthlyBudget : '';
            DOMElements.incomeInput.value = monthlyIncome > 0 ? monthlyIncome : '';
            DOMElements.savingsGoalInput.value = annualSavingsGoal > 0 ? annualSavingsGoal : '';
            DOMElements.currentSavingsInput.value = currentSavings > 0 ? currentSavings : '';
            DOMElements.expenseDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];
        });

        // --- Tab Management ---
        function showTab(tabName) {
            activeTab = tabName;
            localStorage.setItem('activeTab', activeTab);
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            const activeTabContent = document.getElementById(`${tabName}-tab`);
            if (activeTabContent) {
                 activeTabContent.classList.remove('hidden');
                 activeTabContent.classList.add('fade-in');
            } else {
                console.error(`Tab content not found for: ${tabName}`);
            }
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === `tab-${tabName}`) {
                    btn.classList.add('active');
                }
            });
            if (tabName === 'trends' || tabName === 'savings') {
                updateCharts(); // Update charts for relevant tabs
            }
            if (tabName === 'savings') {
                updateAiInsights(); // Update AI insights when tab is shown
            }
        }

        // --- Settings & Theme ---
        function toggleSettings() {
            DOMElements.settingsMenu.classList.toggle('hidden');
        }

        function toggleTheme(isDark) {
            localStorage.setItem('darkMode', isDark);
            applyTheme();
            setTimeout(() => DOMElements.settingsMenu.classList.add('hidden'), 150);
        }

        function applyTheme() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                DOMElements.html.classList.add('dark');
                DOMElements.themeToggle.checked = true;
            } else {
                DOMElements.html.classList.remove('dark');
                DOMElements.themeToggle.checked = false;
            }
            if (activeTab === 'trends' || activeTab === 'savings') {
                updateCharts(); 
            }
        }

        // --- Data Load/Save (using Local Storage) ---
        function loadData() {
            const data = localStorage.getItem('aiExpenseTrackerData');
            if (data) {
                const parsedData = JSON.parse(data);
                expenses = parsedData.expenses || [];
                recurringItems = parsedData.recurringItems || [];
                monthlyBudget = parsedData.monthlyBudget || 0;
                monthlyIncome = parsedData.monthlyIncome || 0;
                annualSavingsGoal = parsedData.annualSavingsGoal || 0;
                currentSavings = parsedData.currentSavings || 0;
                currentCurrencyCode = parsedData.currentCurrencyCode || 'GBP';
                activeTab = parsedData.activeTab || 'overview';
                // Theme is loaded separately
            }
            // Load theme preference
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                 DOMElements.themeToggle.checked = savedDarkMode === 'true';
            }
        }

        function saveData() {
            const dataToSave = {
                expenses,
                recurringItems,
                monthlyBudget,
                monthlyIncome,
                annualSavingsGoal,
                currentSavings,
                currentCurrencyCode,
                activeTab
            };
            localStorage.setItem('aiExpenseTrackerData', JSON.stringify(dataToSave));
            // Theme saved separately in toggleTheme
        }

        // --- Import / Export ---
        function exportData() {
            const dataStr = localStorage.getItem('aiExpenseTrackerData') || '{}';
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-expense-tracker-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Basic validation
                    if (typeof importedData === 'object' && importedData !== null) {
                        // Overwrite existing data
                        expenses = importedData.expenses || [];
                        recurringItems = importedData.recurringItems || [];
                        monthlyBudget = importedData.monthlyBudget || 0;
                        monthlyIncome = importedData.monthlyIncome || 0;
                        annualSavingsGoal = importedData.annualSavingsGoal || 0;
                        currentSavings = importedData.currentSavings || 0;
                        currentCurrencyCode = importedData.currentCurrencyCode || 'GBP';
                        activeTab = importedData.activeTab || 'overview';
                        
                        // Update inputs and UI
                        DOMElements.budgetInput.value = monthlyBudget > 0 ? monthlyBudget : '';
                        DOMElements.incomeInput.value = monthlyIncome > 0 ? monthlyIncome : '';
                        DOMElements.savingsGoalInput.value = annualSavingsGoal > 0 ? annualSavingsGoal : '';
                        DOMElements.currentSavingsInput.value = currentSavings > 0 ? currentSavings : '';
                        DOMElements.currencySelect.value = currentCurrencyCode;

                        saveData(); // Save imported data
                        updateCurrencyUI();
                        updateDisplay();
                        showTab(activeTab); // Go to the saved tab
                        showToast('Data imported successfully!');
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    showToast('Import failed: Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
            // Reset file input to allow importing the same file again
            event.target.value = null;
            DOMElements.settingsMenu.classList.add('hidden');
        }

        // --- Budget & Income Management ---
        function updateBudget(value) {
            monthlyBudget = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }
        function updateIncome(value) {
            monthlyIncome = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }

        // --- Savings Management ---
        function updateSavingsGoal(value) {
            annualSavingsGoal = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }
        function updateCurrentSavings(value) {
            currentSavings = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }

        // --- Currency Management ---
        function changeCurrency(value) {
            if (currencyConfig[value]) {
                currentCurrencyCode = value;
                updateCurrencyUI();
                saveData();
                updateDisplay();
                showToast(`Currency changed to ${value}`);
            } else {
                console.error("Invalid currency code:", value);
            }
             DOMElements.settingsMenu.classList.add('hidden');
        }

        function updateCurrencyUI() {
            const symbol = currencyConfig[currentCurrencyCode].symbol;
            DOMElements.modalCurrency.textContent = symbol;
            DOMElements.recurringModalCurrency.textContent = symbol;
            DOMElements.currencySelect.value = currentCurrencyCode;
        }

        // --- Expense Management ---
        function showAddForm(prefill = {}) {
            editingExpense = null;
            DOMElements.modalTitle.textContent = 'Add New Expense';
            DOMElements.expenseName.value = prefill.name || '';
            DOMElements.expenseCost.value = prefill.cost || '';
            DOMElements.expenseType.value = prefill.type || 'Non Essential'; // Default to non-essential
            DOMElements.expenseFrequency.value = 'One-time';
            DOMElements.expenseCategory.value = prefill.category || 'Other';
            DOMElements.expenseDate.value = prefill.date || new Date().toISOString().split('T')[0];
            DOMElements.expensePaymentMethod.value = prefill.paymentMethod || '';
            DOMElements.modal.classList.remove('hidden');
        }

        function closeModal() {
            DOMElements.modal.classList.add('hidden');
            editingExpense = null;
        }

        function saveExpense() {
            const name = DOMElements.expenseName.value.trim();
            const cost = parseFloat(DOMElements.expenseCost.value);
            const date = DOMElements.expenseDate.value;

            if (!name || isNaN(cost) || cost <= 0 || !date) {
                showToast('Please fill in all fields correctly (Name, positive Amount, Date).', 'error');
                return;
            }

            const expense = {
                id: editingExpense ? editingExpense.id : Date.now(),
                name: name,
                cost: cost,
                type: DOMElements.expenseType.value,
                frequency: 'One-time',
                category: DOMElements.expenseCategory.value,
                date: date,
                paymentMethod: DOMElements.expensePaymentMethod.value,
                status: 'active'
            };

            if (editingExpense) {
                const index = expenses.findIndex(e => e.id === editingExpense.id);
                if (index !== -1) expenses[index] = expense;
            } else {
                expenses.unshift(expense);
            }

            saveData();
            updateDisplay();
            closeModal();
            showToast(`Expense '${name}' saved successfully!`);
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            editingExpense = expense;
            DOMElements.modalTitle.textContent = 'Edit Expense';
            DOMElements.expenseName.value = expense.name;
            DOMElements.expenseCost.value = expense.cost;
            DOMElements.expenseType.value = expense.type;
            DOMElements.expenseFrequency.value = expense.frequency;
            DOMElements.expenseCategory.value = expense.category;
            DOMElements.expenseDate.value = expense.date;
            DOMElements.expensePaymentMethod.value = expense.paymentMethod || '';
            DOMElements.modal.classList.remove('hidden');
        }

        function deleteExpense(id) {
            if (confirm('Are you sure you want to permanently delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                selectedExpenseIds.delete(id);
                saveData();
                updateDisplay();
                showToast('Expense deleted successfully!');
            }
        }

        function toggleExpenseStatus(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.status = expense.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Expense status updated to ${expense.status}.`);
            }
        }

        // --- Bulk Expense Actions ---
        function toggleSelectAllExpenses(checked) {
            const checkboxes = DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox');
            selectedExpenseIds.clear();
            checkboxes.forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedExpenseIds.add(parseInt(cb.dataset.id));
                }
            });
            updateDeleteSelectedButton();
        }

        function toggleExpenseSelection(checkbox, id) {
            if (checkbox.checked) {
                selectedExpenseIds.add(id);
            } else {
                selectedExpenseIds.delete(id);
            }
            const allCheckboxes = DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox');
            DOMElements.selectAllExpensesCheckbox.checked = selectedExpenseIds.size === allCheckboxes.length && allCheckboxes.length > 0;
            updateDeleteSelectedButton();
        }

        function updateDeleteSelectedButton() {
            if (selectedExpenseIds.size > 0) {
                DOMElements.deleteSelectedBtn.classList.remove('hidden');
                DOMElements.deleteSelectedBtn.querySelector('span').textContent = `Delete Selected (${selectedExpenseIds.size})`;
            } else {
                DOMElements.deleteSelectedBtn.classList.add('hidden');
            }
        }

        function deleteSelectedExpenses() {
            if (selectedExpenseIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedExpenseIds.size} selected expense(s)?`)) {
                const initialCount = expenses.length;
                expenses = expenses.filter(e => !selectedExpenseIds.has(e.id));
                const deletedCount = initialCount - expenses.length;
                selectedExpenseIds.clear();
                DOMElements.selectAllExpensesCheckbox.checked = false;
                saveData();
                updateDisplay();
                showToast(`${deletedCount} expense(s) deleted.`);
            }
        }

        // --- Quick Add ---
        function quickAddExpense(name, category, type) {
            // Prompt for amount
            const costStr = prompt(`Enter amount for ${name}:`, '');
            const cost = parseFloat(costStr);
            if (costStr === null) return; // User cancelled
            if (isNaN(cost) || cost <= 0) {
                showToast('Invalid amount entered for quick add.', 'error');
                return;
            }

            const expense = {
                id: Date.now(),
                name: name,
                cost: cost,
                type: type || 'Non Essential',
                frequency: 'One-time',
                category: category || 'Other',
                date: new Date().toISOString().split('T')[0],
                paymentMethod: '',
                status: 'active'
            };
            expenses.unshift(expense);
            saveData();
            updateDisplay();
            showToast(`${name} added successfully for ${formatCurrency(cost)}.`);
        }

        // --- Recurring Item Management ---
        function populateCategoryDropdowns() {
            const expenseOptions = expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            DOMElements.expenseCategory.innerHTML = expenseOptions;
            // Set initial recurring category based on default type ('expense')
            toggleRecurringCategory('expense');
        }

        function toggleRecurringCategory(type) {
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            const options = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            DOMElements.recurringCategory.innerHTML = options;
        }

         function showRecurringForm() {
            editingRecurring = null;
            DOMElements.recurringModalTitle.textContent = 'Add Recurring Item';
            DOMElements.recurringItemType.value = 'expense';
            toggleRecurringCategory('expense'); // Set correct categories
            DOMElements.recurringName.value = '';
            DOMElements.recurringAmount.value = '';
            DOMElements.recurringFrequency.value = 'Monthly';
            DOMElements.recurringPaymentMethod.value = '';
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringEndDate.value = '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function closeRecurringModal() {
            DOMElements.recurringModal.classList.add('hidden');
            editingRecurring = null;
        }

        function saveRecurring() {
            const type = DOMElements.recurringItemType.value;
            const name = DOMElements.recurringName.value.trim();
            const amount = parseFloat(DOMElements.recurringAmount.value);
            const startDate = DOMElements.recurringStartDate.value;
            const endDate = DOMElements.recurringEndDate.value || null;

            if (!name || isNaN(amount) || amount <= 0 || !startDate) {
                 showToast('Please fill in recurring item fields correctly (Name, positive Amount, Start Date).', 'error');
                return;
            }

            const recurringItem = {
                id: editingRecurring ? editingRecurring.id : Date.now(),
                type: type,
                name: name,
                amount: amount,
                frequency: DOMElements.recurringFrequency.value,
                category: DOMElements.recurringCategory.value,
                paymentMethod: DOMElements.recurringPaymentMethod.value,
                startDate: startDate,
                endDate: endDate,
                status: 'active'
            };

            if (editingRecurring) {
                const index = recurringItems.findIndex(r => r.id === editingRecurring.id);
                if (index !== -1) recurringItems[index] = recurringItem;
            } else {
                recurringItems.unshift(recurringItem);
            }

            saveData();
            updateDisplay();
            closeRecurringModal();
            showToast(`Recurring ${type} '${name}' saved successfully!`);
        }

        function editRecurring(id) {
            const item = recurringItems.find(r => r.id === id);
            if (!item) return;
            editingRecurring = item;
            DOMElements.recurringModalTitle.textContent = 'Edit Recurring Item';
            DOMElements.recurringItemType.value = item.type;
            toggleRecurringCategory(item.type); // Ensure correct categories are shown
            DOMElements.recurringName.value = item.name;
            DOMElements.recurringAmount.value = item.amount;
            DOMElements.recurringFrequency.value = item.frequency;
            DOMElements.recurringCategory.value = item.category;
            DOMElements.recurringPaymentMethod.value = item.paymentMethod || '';
            DOMElements.recurringStartDate.value = item.startDate;
            DOMElements.recurringEndDate.value = item.endDate || '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function deleteRecurring(id) {
            if (confirm('Are you sure you want to delete this recurring item?')) {
                recurringItems = recurringItems.filter(r => r.id !== id);
                saveData();
                updateDisplay();
                showToast('Recurring item deleted successfully!');
            }
        }

        // --- Calculation Functions ---
        function getMonthlyRecurringTotals(year, month) {
            const startDateOfMonth = new Date(year, month, 1);
            const endDateOfMonth = new Date(year, month + 1, 0);
            let totalIncome = 0;
            let totalExpenses = 0;

            recurringItems.forEach(item => {
                if (item.status !== 'active') return;
                const itemStartDate = new Date(item.startDate);
                const itemEndDate = item.endDate ? new Date(item.endDate) : null;

                // Check if item is active during the month
                if (itemStartDate > endDateOfMonth || (itemEndDate && itemEndDate < startDateOfMonth)) {
                    return;
                }

                // Simple check for monthly items (more complex frequencies need more logic)
                if (item.frequency === 'Monthly') {
                     if (item.type === 'income') {
                        totalIncome += item.amount;
                    } else {
                        totalExpenses += item.amount;
                    }
                }
                // TODO: Add logic for Weekly, Bi-Weekly, Quarterly, Annual frequencies
            });
            return { income: totalIncome, expenses: totalExpenses };
        }

        function getMonthlyExpenseTotal(year, month) {
             return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && expenseDate.getMonth() === month && expenseDate.getFullYear() === year;
            }).reduce((sum, e) => sum + e.cost, 0);
        }

        // --- UI Update Functions ---
        function updateDisplay() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Calculate totals for the current month
            const monthlyRecurring = getMonthlyRecurringTotals(currentYear, currentMonth);
            const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income; // Add manual + recurring income
            const totalOneTimeExpenses = getMonthlyExpenseTotal(currentYear, currentMonth);
            const totalMonthlyRecurringExpenses = monthlyRecurring.expenses;
            const totalSpent = totalOneTimeExpenses + totalMonthlyRecurringExpenses;
            const remaining = monthlyBudget - totalSpent;
            const monthlySavings = totalMonthlyIncome - totalSpent;

            // Update Overview Tab Displays
            DOMElements.monthlyBudgetDisplay.textContent = formatCurrency(monthlyBudget);
            DOMElements.totalExpensesDisplay.textContent = formatCurrency(totalSpent);
            DOMElements.remainingAmountDisplay.textContent = formatCurrency(remaining);
            DOMElements.totalIncomeDisplay.textContent = formatCurrency(totalMonthlyIncome);
            DOMElements.remainingAmountDisplay.classList.toggle('text-red-600', remaining < 0);
            DOMElements.remainingAmountDisplay.classList.toggle('dark:text-red-400', remaining < 0);
            DOMElements.remainingAmountDisplay.classList.toggle('text-green-600', remaining >= 0);
            DOMElements.remainingAmountDisplay.classList.toggle('dark:text-green-400', remaining >= 0);
            
            // Update Budget Bar
            const budgetUsedPercentage = monthlyBudget > 0 ? Math.min(100, (totalSpent / monthlyBudget) * 100) : (totalSpent > 0 ? 100 : 0);
            DOMElements.budgetBar.style.width = `${budgetUsedPercentage}%`;
            DOMElements.budgetPercentage.textContent = `${budgetUsedPercentage.toFixed(0)}% Used`;
            DOMElements.budgetBar.classList.toggle('bg-red-600', budgetUsedPercentage >= 100);
            DOMElements.budgetBar.classList.toggle('bg-yellow-500', budgetUsedPercentage >= 80 && budgetUsedPercentage < 100);
            DOMElements.budgetBar.classList.toggle('bg-blue-600', budgetUsedPercentage < 80);

            // Update Budget Health Score
            updateBudgetHealthScore(totalSpent, monthlyBudget, currentYear, currentMonth);

            // Update Essential/Non-Essential Breakdown
            const monthlyExpenses = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            const essentialSpending = monthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
            const nonEssentialSpending = monthlyExpenses.filter(e => e.type === 'Non Essential').reduce((sum, e) => sum + e.cost, 0);
            DOMElements.essentialSpendingDisplay.textContent = formatCurrency(essentialSpending);
            DOMElements.nonEssentialSpendingDisplay.textContent = formatCurrency(nonEssentialSpending);
            const totalBreakdown = essentialSpending + nonEssentialSpending;
            const essentialPercent = totalBreakdown > 0 ? (essentialSpending / totalBreakdown) * 100 : 0;
            const nonEssentialPercent = totalBreakdown > 0 ? (nonEssentialSpending / totalBreakdown) * 100 : 0;
            DOMElements.essentialBar.style.width = `${essentialPercent}%`;
            DOMElements.nonEssentialBar.style.width = `${nonEssentialPercent}%`;

            // Update Recent Expenses on Overview
            renderRecentExpenses();
            renderExpensesTable();
            renderRecurringTable();
            updateSavingsDisplay(monthlySavings);

            if (activeTab === 'trends' || activeTab === 'savings') {
                updateCharts();
            }
            if (activeTab === 'savings') {
                updateAiInsights();
            }
            updateDeleteSelectedButton();
        }

        function updateBudgetHealthScore(totalSpent, budget, year, month) {
            let score = 0;
            let label = "Poor";
            let color = 'var(--health-score-bad)';

            if (budget > 0) {
                const usageRatio = totalSpent / budget;
                
                // Factor 1: Budget Usage (max 60 points)
                if (usageRatio <= 0.8) score += 60;
                else if (usageRatio <= 1.0) score += 60 * (1 - (usageRatio - 0.8) / 0.2); // Linear decrease from 80% to 100%
                // Score is 0 if usage > 100%

                // Factor 2: Spending Consistency (Placeholder - needs historical data) (max 20 points)
                // Simple placeholder: give 10 points if budget is set
                score += 10;

                // Factor 3: Essential vs Non-Essential Ratio (max 20 points)
                const monthlyExpenses = expenses.filter(e => {
                    const d = new Date(e.date);
                    return e.status === 'active' && d.getMonth() === month && d.getFullYear() === year;
                });
                const essentialSpending = monthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
                const nonEssentialSpending = monthlyExpenses.filter(e => e.type === 'Non Essential').reduce((sum, e) => sum + e.cost, 0);
                const totalBreakdown = essentialSpending + nonEssentialSpending;
                if (totalBreakdown > 0) {
                    const nonEssentialRatio = nonEssentialSpending / totalBreakdown;
                    // More points for lower non-essential ratio (e.g., < 30% is good)
                    if (nonEssentialRatio <= 0.3) score += 20;
                    else if (nonEssentialRatio <= 0.5) score += 10;
                }
                 else {
                    score += 10; // Give some points if no spending yet
                }

            } else {
                // No budget set
                score = 0; 
                label = "Set Budget";
            }

            score = Math.max(0, Math.min(100, Math.round(score))); // Clamp score 0-100

            if (score >= 70) { label = "Good"; color = 'var(--health-score-good)'; }
            else if (score >= 40) { label = "Okay"; color = 'var(--health-score-ok)'; }
            else if (budget > 0) { label = "Poor"; color = 'var(--health-score-bad)'; }

            DOMElements.healthScoreValue.textContent = score;
            DOMElements.healthScoreLabel.textContent = label;
            
            // Update gauge fill rotation and color
            const rotation = 45 + (score * 1.8); // 100 score = 180 degrees rotation from 45 = 225
            DOMElements.healthScoreFill.style.transform = `rotate(${rotation}deg)`;
            DOMElements.healthScoreFill.style.borderColor = color;
        }

        function updateSavingsDisplay(monthlySavings) {
            // Savings Goal Progress
            const totalSavings = currentSavings + calculateAccumulatedSavings();
            const goalProgress = annualSavingsGoal > 0 ? Math.min(100, (totalSavings / annualSavingsGoal) * 100) : 0;
            DOMElements.savingsGoalBar.style.width = `${goalProgress}%`;
            DOMElements.savingsGoalPercentage.textContent = `${goalProgress.toFixed(0)}%`;

            // Projected Annual Savings
            const projectedSavings = calculateProjectedAnnualSavings();
            DOMElements.projectedSavingsDisplay.textContent = formatCurrency(projectedSavings);

            // On Track Status
            let onTrack = '-';
            let onTrackColor = 'text-gray-600 dark:text-gray-400';
            if (annualSavingsGoal > 0 && monthlyIncome > 0) { // Need goal and income to determine track
                if (projectedSavings >= annualSavingsGoal) {
                    onTrack = 'Yes';
                    onTrackColor = 'text-green-600 dark:text-green-400';
                } else {
                    onTrack = 'No';
                    onTrackColor = 'text-red-600 dark:text-red-400';
                }
            }
            DOMElements.savingsOnTrackDisplay.textContent = onTrack;
            DOMElements.savingsOnTrackDisplay.className = `stat-card-value ${onTrackColor}`;
        }

        function calculateAccumulatedSavings() {
            // Calculate savings from previous months based on stored data
            let accumulated = 0;
            const monthlyData = getMonthlyIncomeAndExpenses(12); // Get last 12 months
            monthlyData.forEach(month => {
                accumulated += (month.income - month.expenses);
            });
            return accumulated;
        }

        function calculateProjectedAnnualSavings() {
            // Simple projection based on current month's savings rate
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthlyRecurring = getMonthlyRecurringTotals(currentYear, currentMonth);
            const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;
            const totalOneTimeExpenses = getMonthlyExpenseTotal(currentYear, currentMonth);
            const totalMonthlyRecurringExpenses = monthlyRecurring.expenses;
            const totalSpent = totalOneTimeExpenses + totalMonthlyRecurringExpenses;
            const currentMonthlySaving = totalMonthlyIncome - totalSpent;
            
            // Project based on average of last 3 months if available, else current month
            const monthlySavingsHistory = getMonthlyIncomeAndExpenses(3).map(m => m.income - m.expenses);
            let avgMonthlySaving = currentMonthlySaving;
            if (monthlySavingsHistory.length > 0) {
                 avgMonthlySaving = monthlySavingsHistory.reduce((a, b) => a + b, 0) / monthlySavingsHistory.length;
            }

            return avgMonthlySaving * 12;
        }

        function renderRecentExpenses() {
            DOMElements.recentExpensesContainer.innerHTML = '';
            const recent = expenses.slice(0, 5);
            if (recent.length === 0) {
                DOMElements.recentExpensesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">No recent expenses.</p>';
                return;
            }
            recent.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center border-b border-gray-100 dark:border-gray-700 py-2 last:border-b-0 text-xs';
                div.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800 dark:text-gray-200">${escapeHTML(expense.name)}</p>
                        <p class="text-gray-500 dark:text-gray-400">${expense.date} - ${escapeHTML(expense.category)}</p>
                    </div>
                    <p class="font-medium text-red-600 dark:text-red-400">${formatCurrency(expense.cost)}</p>
                `;
                DOMElements.recentExpensesContainer.appendChild(div);
            });
        }

        function renderExpensesTable() {
            DOMElements.expensesTableBody.innerHTML = '';
            if (expenses.length === 0) {
                 DOMElements.expensesTableBody.innerHTML = `<tr class="bg-white dark:bg-gray-800"><td colspan="9" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No expenses recorded yet.</td></tr>`;
                return;
            }
            expenses.forEach(expense => {
                const tr = document.createElement('tr');
                const isSelected = selectedExpenseIds.has(expense.id);
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${expense.status === 'cancelled' ? 'opacity-60' : ''} ${isSelected ? 'bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800'}`;
                tr.innerHTML = `
                    <td class="px-4 py-4 w-1">
                        <input type="checkbox" data-id="${expense.id}" onchange="toggleExpenseSelection(this, ${expense.id})" class="table-checkbox expense-checkbox" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${escapeHTML(expense.name)}</td>
                    <td class="px-6 py-4">${formatCurrency(expense.cost)}</td>
                    <td class="px-6 py-4 hidden md:table-cell">${expense.date}</td>
                    <td class="px-6 py-4 hidden md:table-cell">${escapeHTML(expense.category)}</td>
                    <td class="px-6 py-4 hidden lg:table-cell">${escapeHTML(expense.paymentMethod || '-')}</td>
                    <td class="px-6 py-4 hidden lg:table-cell">${escapeHTML(expense.type)}</td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${expense.status === 'active' ? 'status-active' : 'status-cancelled'}">${expense.status}</span>
                    </td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap">
                        <button onclick="editExpense(${expense.id})" class="icon-button" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                        <button onclick="toggleExpenseStatus(${expense.id})" class="icon-button" title="${expense.status === 'active' ? 'Cancel' : 'Reactivate'}">
                            ${expense.status === 'active' ? 
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9v6m-4.25 0V9M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : 
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113a.375.375 0 01-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112z" /></svg>'}
                        </button>
                        <button onclick="deleteExpense(${expense.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </td>
                `;
                DOMElements.expensesTableBody.appendChild(tr);
            });
        }
        
        function renderRecurringTable() {
            DOMElements.recurringTableBody.innerHTML = '';
            if (recurringItems.length === 0) {
                DOMElements.recurringTableBody.innerHTML = `<tr class="bg-white dark:bg-gray-800"><td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No recurring items recorded yet.</td></tr>`;
                return;
            }
            recurringItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${item.status === 'cancelled' ? 'opacity-60' : ''} bg-white dark:bg-gray-800`;
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${escapeHTML(item.name)}</td>
                    <td class="px-6 py-4 ${item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4">${escapeHTML(item.frequency)}</td>
                    <td class="px-6 py-4 hidden md:table-cell">${escapeHTML(item.category)}</td>
                    <td class="px-6 py-4 hidden lg:table-cell">${escapeHTML(item.paymentMethod || '-')}</td>
                    <td class="px-6 py-4 hidden md:table-cell">${item.startDate}</td>
                    <td class="px-6 py-4"><span class="capitalize status-badge status-active">${item.type}</span></td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap">
                        <button onclick="editRecurring(${item.id})" class="icon-button" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                         <button onclick="/* toggleRecurringStatus(${item.id}) */ alert('Toggle recurring status not implemented yet')" class="icon-button" title="Toggle Status (Not Implemented)"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9v6m-4.25 0V9M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                        <button onclick="deleteRecurring(${item.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </td>
                `;
                DOMElements.recurringTableBody.appendChild(tr);
            });
        }

        // --- Charting Functions ---
        function updateCharts() {
            renderSpendingTrendChart();
            renderCategorySpendingChart();
            renderMonthlySavingsChart();
        }

        const chartColors = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#06b6d4', '#d946ef', '#84cc16'];
        function getChartColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(chartColors[i % chartColors.length]);
            }
            return colors;
        }

        function getChartOptions(isDarkMode) {
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { color: gridColor }, ticks: { color: textColor } },
                    y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, callback: value => formatCurrency(value, false) } }
                },
                plugins: {
                    legend: { labels: { color: textColor } },
                    tooltip: { titleColor: isDarkMode ? '#fff' : '#000', bodyColor: isDarkMode ? '#fff' : '#000' }
                }
            };
        }

        function renderSpendingTrendChart() {
            const ctx = DOMElements.spendingTrendCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12); // Get last 12 months
            const labels = monthlyData.map(m => m.label);
            const data = monthlyData.map(m => m.expenses);

            if (spendingTrendChart) spendingTrendChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip = {
                callbacks: {
                    title: (tooltipItems) => tooltipItems[0].label,
                    label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}`
                }
            };
            options.plugins.legend = { display: false };

            spendingTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: data,
                        borderColor: chartColors[2], // Red
                        backgroundColor: chartColors[2] + '33',
                        tension: 0.2, fill: true, pointRadius: 3, pointHoverRadius: 5
                    }]
                },
                options: options
            });
        }

        function renderCategorySpendingChart() {
            const ctx = DOMElements.categorySpendingCanvas?.getContext('2d');
            if (!ctx) return;
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const categorySpending = {};
            expenses.filter(e => {
                 const d = new Date(e.date);
                return e.status === 'active' && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            }).forEach(expense => {
                const category = expense.category || 'Other';
                categorySpending[category] = (categorySpending[category] || 0) + expense.cost;
            });
            const sortedCategories = Object.entries(categorySpending).sort(([, a], [, b]) => b - a);
            const chartLabels = sortedCategories.map(([category]) => category);
            const chartData = sortedCategories.map(([, amount]) => amount);
            const backgroundColors = getChartColors(chartLabels.length);
            const borderColors = DOMElements.html.classList.contains('dark') ? '#1e293b' : '#ffffff';

            if (categorySpendingChart) categorySpendingChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.scales = {}; // No scales for doughnut
            options.plugins.legend = { position: 'bottom', labels: { color: isDarkMode ? '#cbd5e1' : '#64748b', boxWidth: 12, padding: 15 } };
            options.plugins.tooltip = {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) label += ': ';
                        if (context.parsed !== null) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                            label += `${formatCurrency(context.parsed)} (${percentage}%)`;
                        }
                        return label;
                    }
                }
            };

            categorySpendingChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Spending by Category',
                        data: chartData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        hoverOffset: 8
                    }]
                },
                options: options
            });
        }

        function renderMonthlySavingsChart() {
            const ctx = DOMElements.monthlySavingsCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12); // Get last 12 months
            const labels = monthlyData.map(m => m.label);
            const savingsData = monthlyData.map(m => m.income - m.expenses);

            if (monthlySavingsChart) monthlySavingsChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip = {
                callbacks: {
                    title: (tooltipItems) => tooltipItems[0].label,
                    label: (context) => ` Savings: ${formatCurrency(context.parsed.y)}`
                }
            };
             options.plugins.legend = { display: false };

            monthlySavingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Savings',
                        data: savingsData,
                        backgroundColor: savingsData.map(s => s >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'), // Green for positive, Red for negative
                        borderColor: savingsData.map(s => s >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }

        // --- AI Insights & Analysis ---
        function getMonthlyIncomeAndExpenses(numMonths) {
            const data = [];
            const today = new Date();
            for (let i = 0; i < numMonths; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth();
                const label = `${year}-${(month + 1).toString().padStart(2, '0')}`;
                
                const recurring = getMonthlyRecurringTotals(year, month);
                const oneTimeExpenses = getMonthlyExpenseTotal(year, month);
                
                data.push({
                    label: label,
                    year: year,
                    month: month,
                    income: (monthlyIncome + recurring.income), // Use global monthlyIncome + recurring
                    expenses: (oneTimeExpenses + recurring.expenses)
                });
            }
            return data.reverse(); // Return in chronological order
        }

        function updateAiInsights() {
            const now = Date.now();
            // Rate limit AI updates (e.g., once every 10 seconds)
            if (aiInsightsCache && (now - lastAiUpdate < 10000)) {
                renderAiInsights(aiInsightsCache);
                return;
            }

            // Generate new insights
            const insights = generateAiInsights();
            aiInsightsCache = insights;
            lastAiUpdate = now;
            renderAiInsights(insights);
        }

        function generateAiInsights() {
            const insights = [];
            const monthlyData = getMonthlyIncomeAndExpenses(3); // Analyze last 3 months
            if (monthlyData.length < 1) return ['Not enough data for analysis yet. Add income and expenses.'];

            const currentMonthData = monthlyData[monthlyData.length - 1];
            const previousMonthData = monthlyData.length > 1 ? monthlyData[monthlyData.length - 2] : null;

            // Insight 1: Savings Rate
            if (currentMonthData.income > 0) {
                const savings = currentMonthData.income - currentMonthData.expenses;
                const savingsRate = (savings / currentMonthData.income) * 100;
                if (savings >= 0) {
                     insights.push(`This month, you saved <strong>${formatCurrency(savings)}</strong>, which is <strong>${savingsRate.toFixed(0)}%</strong> of your income. ${savingsRate >= 20 ? 'Great job!' : (savingsRate >= 10 ? 'Good start!' : 'Aim to increase this!')}`);
                } else {
                     insights.push(`You overspent by <strong>${formatCurrency(Math.abs(savings))}</strong> this month. Review non-essential spending.`);
                }
            } else {
                insights.push('Set your monthly income to calculate savings rate.');
            }

            // Insight 2: Comparison to Previous Month
            if (previousMonthData) {
                const expenseChange = currentMonthData.expenses - previousMonthData.expenses;
                if (expenseChange > 0) {
                    insights.push(`Your spending increased by <strong>${formatCurrency(expenseChange)}</strong> compared to last month. Check recent transactions.`);
                } else if (expenseChange < 0) {
                    insights.push(`Well done! Your spending decreased by <strong>${formatCurrency(Math.abs(expenseChange))}</strong> compared to last month.`);
                }
            }

            // Insight 3: Top Spending Category Analysis
            const categorySpending = {};
            expenses.filter(e => {
                 const d = new Date(e.date);
                return e.status === 'active' && d.getMonth() === currentMonthData.month && d.getFullYear() === currentMonthData.year;
            }).forEach(expense => {
                const category = expense.category || 'Other';
                categorySpending[category] = (categorySpending[category] || 0) + expense.cost;
            });
            const topCategories = Object.entries(categorySpending).sort(([, a], [, b]) => b - a).slice(0, 3);
            if (topCategories.length > 0) {
                const topCatString = topCategories.map(([cat, amount]) => `<strong>${escapeHTML(cat)}</strong> (${formatCurrency(amount)})`).join(', ');
                insights.push(`Your top spending areas this month are: ${topCatString}. Consider if reductions are possible.`);
            }

            // Insight 4: Budget Adherence & Alert
            if (monthlyBudget > 0 && currentMonthData.expenses > monthlyBudget) {
                 insights.push(`<strong class="text-red-600 dark:text-red-400">Alert:</strong> You've exceeded your monthly budget by <strong>${formatCurrency(currentMonthData.expenses - monthlyBudget)}</strong>.`);
            } else if (monthlyBudget > 0 && currentMonthData.expenses / monthlyBudget > 0.8) {
                 insights.push(`You've used over 80% of your budget. Monitor spending closely.`);
            }

            // Insight 5: Savings Goal Check
            if (annualSavingsGoal > 0 && monthlyIncome > 0) {
                const projectedSavings = calculateProjectedAnnualSavings();
                if (projectedSavings < annualSavingsGoal) {
                    const shortfall = annualSavingsGoal - projectedSavings;
                    const neededMonthlySavings = annualSavingsGoal / 12;
                    insights.push(`You're projected to miss your annual savings goal by <strong>${formatCurrency(shortfall)}</strong>. Aim to save at least <strong>${formatCurrency(neededMonthlySavings)}</strong> each month.`);
                }
            }

            return insights;
        }

        function renderAiInsights(insights) {
            const container = DOMElements.spendingInsightsContainer;
            container.innerHTML = ''; // Clear previous
            if (insights.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Not enough data to generate insights yet. Add at least one month of expenses and income to see personalized spending patterns and recommendations.</p>';
                return;
            }
            insights.forEach(insightText => {
                const div = document.createElement('div');
                div.className = 'ai-insight';
                div.innerHTML = insightText; // Use innerHTML because insights contain <strong> tags
                container.appendChild(div);
            });
        }

        // --- Utility Functions ---
        function formatCurrency(value, useDecimals = true) {
            const { symbol, locale } = currencyConfig[currentCurrencyCode];
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: useDecimals ? 2 : 0,
                maximumFractionDigits: useDecimals ? 2 : 0,
            };
            try {
                 return new Intl.NumberFormat(locale, options).format(value);
            } catch (e) {
                console.warn("Intl.NumberFormat error for locale:", locale, e);
                const fixedValue = parseFloat(value).toFixed(useDecimals ? 2 : 0);
                return `${symbol}${fixedValue}`; 
            }
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function showToast(message, type = 'success') {
            DOMElements.toast.textContent = message;
            DOMElements.toast.className = `toast show ${type === 'error' ? 'bg-red-600' : 'bg-gray-800 dark:bg-gray-200 dark:text-gray-800'}`;
            setTimeout(() => {
                DOMElements.toast.className = 'toast';
            }, 3000);
        }

    </script>
</body>
</html>

