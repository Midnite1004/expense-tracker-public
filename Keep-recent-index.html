<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc; /* Light gray background */
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b; /* Dark slate */
            --text-secondary: #64748b; /* Medium slate */
            --text-tertiary: #94a3b8; /* Light slate */
            --border-color: #e2e8f0;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --help-text-color: #374151;
            --health-score-good: var(--accent-green);
            --health-score-ok: var(--accent-yellow);
            --health-score-bad: var(--accent-red);
        }
        .dark {
            --bg-primary: #0f172a; /* Very dark blue */
            --bg-secondary: #1e293b; /* Dark blue */
            --bg-tertiary: #334155; /* Medium dark blue */
            --text-primary: #f1f5f9; /* Light gray */
            --text-secondary: #cbd5e1; /* Medium gray */
            --text-tertiary: #94a3b8; /* Darker gray */
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --help-text-color: #d1d5db;
        }
        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .stat-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
            text-align: center;
        }
        .dark .stat-card {
             background-color: var(--bg-tertiary);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .stat-card-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        .stat-card-value {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* bold */
            color: var(--text-primary);
            line-height: 1.2;
        }
        .stat-card-value.text-green-600 { color: var(--accent-green); }
        .stat-card-value.text-red-600 { color: var(--accent-red); }
        .dark .stat-card-value.text-green-600 { color: #34d399; } /* Lighter green */
        .dark .stat-card-value.text-red-600 { color: #f87171; } /* Lighter red */
        
        /* Info Icon Styling */
        .info-icon {
            cursor: help;
            display: inline-flex;
            vertical-align: middle;
            color: var(--text-tertiary);
            transition: color 0.2s;
        }
        .info-icon:hover {
            color: var(--accent-blue);
        }
        /* Tooltip styling */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: normal;
            z-index: 50;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            max-width: 300px;
            width: max-content;
        }

        .tab-button {
            position: relative;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab-button:hover {
            color: var(--text-primary);
        }
        .tab-button.active {
            color: var(--accent-blue);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-blue);
            border-radius: 1px;
        }
        .modern-input, .modern-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
            appearance: none;
        }
        .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem;
        }
        .dark .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .modern-input:focus, .modern-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .modern-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .modern-button-primary {
            background-color: var(--accent-blue);
            color: white;
        }
        .modern-button-primary:hover {
            background-color: #2563eb;
            box-shadow: var(--shadow-md);
        }
         .modern-button-primary:active {
            transform: translateY(1px);
        }
        .modern-button-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .modern-button-secondary:hover {
            background-color: var(--border-color);
        }
        .modern-button-danger {
            background-color: var(--accent-red);
            color: white;
        }
        .modern-button-danger:hover {
             background-color: #dc2626;
             box-shadow: var(--shadow-md);
        }
        .icon-button {
            padding: 0.5rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        .icon-button:hover {
            color: var(--text-primary);
        }
        .icon-button svg {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        .dropdown-menu {
            position: absolute;
            margin-top: 0.5rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 50;
            min-width: 220px; /* Wider for import/export */
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: background-color 0.2s ease, color 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .dropdown-item:hover {
            background-color: var(--bg-secondary);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        .dark .status-active {
             background-color: rgba(16, 185, 129, 0.2);
             color: #10b981;
        }
        .status-cancelled {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            text-decoration: line-through;
        }
         .dark .status-cancelled {
             background-color: rgba(239, 68, 68, 0.2);
             color: #ef4444;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #2d3748;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 100;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            position: relative; 
            height: 350px;
            width: 100%;
        }
        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-blue);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        /* Help Tab Contrast */
        #help-tab p, #help-tab li {
            color: var(--help-text-color);
            transition: color 0.3s;
        }
        #help-tab h3 {
             color: var(--text-primary);
             transition: color 0.3s;
        }
        #help-tab strong {
            color: var(--text-primary);
            transition: color 0.3s;
        }
        #help-tab ul {
            margin-left: 1rem;
        }
        /* Table Checkbox */
        .table-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        /* Budget Health Score */
        .health-score-container {
            position: relative;
            width: 150px;
            height: 75px; /* Half circle */
            overflow: hidden;
            margin: 1rem auto 0;
        }
        .health-score-gauge {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--bg-tertiary);
            border-bottom-color: transparent;
            border-left-color: transparent;
            transform: rotate(-135deg); /* Start from bottom-left */
            box-sizing: border-box;
        }
        .health-score-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--health-score-good); /* Default color */
            border-top-color: transparent;
            border-right-color: transparent;
            transform: rotate(45deg); /* Start from bottom-left, fill clockwise */
            transform-origin: center center;
            clip-path: polygon(50% 0%, 100% 0%, 100% 50%, 50% 50%); /* Clip to top-right quadrant initially */
            transition: transform 1s ease-out, border-color 0.5s ease;
            box-sizing: border-box;
        }
        .health-score-text {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            color: var(--text-primary);
        }
        .health-score-label {
            font-size: 0.875rem; /* text-sm */
            color: var(--text-secondary);
            margin-top: -5px;
        }
        /* AI Insights Styling */
        .ai-insight {
            background-color: rgba(59, 130, 246, 0.05); /* Light blue bg */
            border-left: 4px solid var(--accent-blue);
            padding: 1rem;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        .dark .ai-insight {
            background-color: rgba(59, 130, 246, 0.1);
            border-left-color: var(--accent-blue);
            color: var(--text-secondary);
        }
        .ai-insight strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        /* Consistent Dark Mode */
        html.dark body { background-color: var(--bg-secondary); color: var(--text-primary); }
        html.dark .card { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .stat-card { background-color: var(--bg-tertiary); border-color: var(--border-color); }
        html.dark .modern-input, html.dark .modern-select { background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        html.dark .modern-button-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        html.dark .modern-button-secondary:hover { background-color: var(--border-color); }
        html.dark .tab-button { color: var(--text-secondary); }
        html.dark .tab-button:hover { color: var(--text-primary); }
        html.dark .tab-button.active { color: var(--accent-blue); }
        html.dark .icon-button { color: var(--text-secondary); }
        html.dark .icon-button:hover { color: var(--text-primary); }
        html.dark .dropdown-menu { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .dropdown-item { color: var(--text-primary); }
        html.dark .dropdown-item:hover { background-color: var(--bg-secondary); }
        html.dark table thead { background-color: var(--bg-tertiary); color: var(--text-secondary); }
        html.dark table tbody tr { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark table tbody tr:hover { background-color: var(--bg-secondary); }
        html.dark table tbody td { color: var(--text-secondary); }
        html.dark table tbody td:first-child { color: var(--text-primary); }
        html.dark #help-tab p, html.dark #help-tab li { color: var(--help-text-color); }
        html.dark #help-tab h3, html.dark #help-tab strong { color: var(--text-primary); }
        html.dark .health-score-gauge { border-color: var(--bg-tertiary); border-bottom-color: transparent; border-left-color: transparent; }
        html.dark .health-score-text { color: var(--text-primary); }
        html.dark .health-score-label { color: var(--text-secondary); }

        /* Driver.js Customization */
        .driver-popover {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .driver-popover-title {
            color: var(--text-primary);
        }
        .driver-popover-description {
            color: var(--text-secondary);
        }
        .driver-popover-progress-text {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn:hover {
            color: var(--text-primary);
        }
        .driver-popover-arrow-side-left.driver-popover-arrow {
            border-left-color: var(--border-color);
        }
        .driver-popover-arrow-side-right.driver-popover-arrow {
            border-right-color: var(--border-color);
        }
        .driver-popover-arrow-side-top.driver-popover-arrow {
            border-top-color: var(--border-color);
        }
        .driver-popover-arrow-side-bottom.driver-popover-arrow {
            border-bottom-color: var(--border-color);
        }

        /* Settings Modal Text Color Fix */
        #settings-modal .card h4,
        #settings-modal .card label {
            color: var(--text-primary);
        }

    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen p-4 md:p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="card mb-6">
                <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">💡</span>
                            <h1 class="text-2xl md:text-3xl font-bold">Expense Tracker</h1>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- Settings Button and Menu -->
                            <div class="relative inline-block text-left">
                                <button onclick="openSettings()" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                                    <span class="hidden sm:inline">Settings</span>
                                </button>
                                        </div>
                                        </div>
                    </div>
                </div>
                <!-- Navigation Tabs -->
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-4 sm:space-x-8 px-4 md:px-6" aria-label="Tabs">
                        <button onclick="showTab('overview')" id="tab-overview" class="tab-button active">Overview</button>
                        <button onclick="showTab('expenses')" id="tab-expenses" class="tab-button">Expenses</button>
                        <button onclick="showTab('recurring')" id="tab-recurring" class="tab-button">Recurring</button>
                        <button onclick="showTab('insights')" id="tab-insights" class="tab-button">Insights</button>
                        <button onclick="showTab('help')" id="tab-help" class="tab-button">Help</button>
                    </nav>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="mt-6">
                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Key Stats & Budget Health -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Key Stats Row -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="stat-card bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800">
                                    <div class="stat-card-title">Monthly Budget</div>
                                    <div class="stat-card-value text-blue-600 dark:text-blue-400" id="monthly-budget">£0.00</div>
                                </div>
                                <div class="stat-card bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800">
                                    <div class="stat-card-title">Spent (Month)</div>
                                    <div class="stat-card-value text-red-600" id="total-expenses">£0.00</div>
                                </div>
                                <div class="stat-card bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800">
                                    <div class="stat-card-title">Remaining</div>
                                    <div class="stat-card-value text-green-600" id="remaining-amount">£0.00</div>
                                </div>
                                 <div class="stat-card bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-800">
                                    <div class="stat-card-title">
                                        Income (Month)
                                        <span class="info-icon ml-1" data-tooltip="Total monthly income = Base monthly income + Recurring income items">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="stat-card-value text-purple-600 dark:text-purple-400" id="total-income">£0.00</div>
                                </div>
                            </div>
                
                            <!-- ADDED SHORTCUT -->
                            <div class="text-center -mt-4">
                                <button class="text-sm text-blue-600 dark:text-blue-400 opacity-70 hover:opacity-100 hover:underline" onclick="openSettings('budget')">
                                    Edit budget & income
                                </button>
                            </div>
                
                            <!-- Budget Health & Progress -->
                            <div class="card p-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                                    <div class="md:col-span-2">
                                        <h3 class="text-lg font-semibold mb-1">Budget Progress</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">How you're tracking against your monthly budget.</p>
                                        <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 mb-2">
                                            <div id="budget-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                                        </div>
                                        <p id="budget-percentage" class="text-right text-sm text-gray-600 dark:text-gray-400">0% Used</p>
                                    </div>
                                    <div class="text-center">
                                        <h3 class="text-lg font-semibold mb-2">Budget Health</h3>
                                        <div class="health-score-container">
                                            <div class="health-score-gauge"></div>
                                            <div id="health-score-fill" class="health-score-fill"></div>
                                            <div class="health-score-text">
                                                <span id="health-score-value">0</span>
                                                <div id="health-score-label" class="health-score-label">Loading...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Essential vs Non-Essential -->
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Spending Breakdown (Month)</h3>
                                <div class="flex justify-around items-center text-center mb-4">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Essential</p>
                                        <p class="text-2xl font-semibold text-sky-600 dark:text-sky-400" id="essential-spending">£0.00</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Non-Essential</p>
                                        <p class="text-2xl font-semibold text-indigo-600 dark:text-indigo-400" id="non-essential-spending">£0.00</p>
                                    </div>
                                </div>
                                <div class="w-full rounded-full h-3">
                                    <div id="essential-bar" class="bg-sky-500 h-3 rounded-l-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div><!--
                                 --><div id="non-essential-bar" class="bg-indigo-500 h-3 rounded-r-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                
                        <!-- Right Column: Actions & Recent Activity -->
                        <div class="space-y-6">
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                                <div class="space-y-3">
                                    <button onclick="showAddForm()" class="modern-button modern-button-primary w-full">
                                        <span>➕</span> Add New Expense
                                    </button>
                                    <button onclick="showRecurringForm()" class="modern-button modern-button-secondary w-full">
                                        <span>🔁</span> Add Recurring Item
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Quick Add Common Expenses</h3>
                                <div class="flex flex-col gap-2 w-full">
                                    <div id="quick-add-coffee">
                                        <button class="bg-gray-700 dark:bg-gray-800 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">☕</span>
                                                <span class="text-white">Coffee</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-transport">
                                        <button class="bg-gray-700 dark:bg-gray-800 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">🚌</span>
                                                <span class="text-white">Transport</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-lunch">
                                        <button class="bg-gray-700 dark:bg-gray-800 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">🥪</span>
                                                <span class="text-white">Lunch</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-groceries">
                                        <button class="bg-gray-700 dark:bg-gray-800 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">🛒</span>
                                                <span class="text-white">Groceries</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                                <div id="recent-expenses" class="space-y-3">
                                    <p class="text-gray-500 dark:text-gray-400">No recent expenses.</p>
                                </div>
                                <div class="text-center mt-4">
                                    <button onclick="showTab('expenses')" class="text-blue-600 dark:text-blue-400 font-medium hover:underline">
                                        See all
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expenses Tab -->
                <div id="expenses-tab" class="tab-content hidden fade-in">
                    <div class="card">
                        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-4">
                            <h2 class="text-xl font-semibold">All Expenses</h2>
                            <div class="flex gap-3">
                                <button onclick="toggleFilterPanel('expense-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                    </svg>
                                    Filters
                                </button>
                                <button id="delete-selected-btn" onclick="deleteSelectedExpenses()" class="modern-button modern-button-danger hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showAddForm()" class="modern-button modern-button-primary">
                                     <span>➕</span> Add Expense
                                 </button>
                             </div>
                        </div>
                        
                        <!-- Filter Panel -->
                        <div id="expense-filter-panel" class="p-4 border-b border-gray-200 dark:border-gray-700 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <!-- Date Range -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Date Range</label>
                                    <div class="flex gap-2">
                                        <input type="date" id="expense-filter-date-from" class="modern-input">
                                        <input type="date" id="expense-filter-date-to" class="modern-input">
                                    </div>
                                </div>
                                <!-- Category -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Category</label>
                                    <select id="expense-filter-category" class="modern-select">
                                        <option value="">All Categories</option>
                                        <!-- Populated dynamically -->
                                    </select>
                                </div>
                                <!-- Type -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Type</label>
                                    <select id="expense-filter-type" class="modern-select">
                                        <option value="">All Types</option>
                                        <option value="Essential">Essential</option>
                                        <option value="Non-Essential">Non-Essential</option>
                                        <option value="Recurring">Recurring</option>
                                    </select>
                            </div>
                            <!-- Clear Filters -->
                                <div class="md:col-span-3 flex justify-end gap-2">
                                <button onclick="applyExpenseFilters()" class="modern-button modern-button-primary">Apply Filters</button>
                                <button onclick="clearExpenseFilters()" class="modern-button modern-button-secondary">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-expenses" onchange="toggleSelectAllExpenses(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Date</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Payment Method</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Type</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table">
                                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                        <td colspan="9" class="px-6 py-4 text-center">No expenses recorded yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                 <!-- Recurring Tab -->
                <div id="recurring-tab" class="tab-content hidden fade-in">
                    <div class="card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 gap-4">
                            <div>
                                <h2 class="text-xl font-bold">Recurring Items</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Regular income and expenses like salaries or subscriptions.</p>
                            </div>
                            <div class="flex-shrink-0 flex items-center space-x-2">
                                <button onclick="toggleFilterPanel('recurring-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg>
                                    Filter
                                </button>
                                <button id="delete-selected-recurring-btn" onclick="deleteSelectedRecurring()" class="modern-button modern-button-danger hidden">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showRecurringForm()" class="modern-button modern-button-primary">
                                    <span>🔁</span> Add Recurring
                                </button>
                            </div>
                        </div>
                
                        <div id="recurring-filter-panel" class="hidden p-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label for="recurring-filter-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                                    <select id="recurring-filter-type" class="modern-select mt-1">
                                        <option value="">All Types</option>
                                        <option value="income">Income</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                                    <select id="recurring-filter-category" class="modern-select mt-1">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-frequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                                    <select id="recurring-filter-frequency" class="modern-select mt-1">
                                        <option value="">All Frequencies</option>
                                        <option value="Daily">Daily</option>
                                        <option value="Weekly">Weekly</option>
                                        <option value="Bi-Weekly">Bi-Weekly</option>
                                        <option value="Monthly">Monthly</option>
                                        <option value="Quarterly">Quarterly</option>
                                        <option value="Annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 mt-4">
                                <button onclick="applyRecurringFilters()" class="modern-button modern-button-primary">Apply</button>
                                <button onclick="clearRecurringFilters()" class="modern-button modern-button-secondary">Clear</button>
                            </div>
                        </div>
                
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-recurring" onchange="toggleSelectAllRecurring(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Type</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Frequency</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Start Date</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recurring-table">
                                    <!-- Rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Insights Tab -->
                <div id="insights-tab" class="tab-content hidden fade-in">
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                        <div class="card p-4 md:p-6">
                             <h2 class="text-xl font-bold mb-4">Spending Trend</h2>
                             <div class="chart-container h-64 md:h-80">
                                <canvas id="spending-trend-chart"></canvas>
                            </div>
                        </div>
                        <div class="card p-4 md:p-6">
                             <h2 class="text-xl font-bold mb-4">Spending by Category</h2>
                             <div class="chart-container h-64 md:h-80">
                                <canvas id="category-spending-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                        <div class="lg:col-span-2 card p-6">
                            <h2 class="text-xl font-semibold mb-4">Monthly Savings Trend</h2>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="monthly-savings-chart"></canvas>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                <span>Savings Insights</span>
                            </h2>
                            <div id="ai-savings-insights" class="space-y-4">
                                <p class="text-gray-500 dark:text-gray-400">Analysis will appear here once you have enough data...</p>
                                <!-- AI Insights will be populated here -->
                            </div>
                        </div>
                    </div>
                     <div class="card p-4 md:p-6 mt-6">
                        <div class="flex items-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.375 3.375 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                            <h2 class="text-xl font-bold">Spending Insights</h2>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Your intelligent assistant providing tips to improve your financial health based on your data.</p>
                        <div id="spending-insights" class="space-y-3">
                             <!-- AI Insights will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Help Tab -->
                <div id="help-tab" class="tab-content hidden fade-in">
                    <div class="card p-8">
                        <h2 class="text-2xl font-semibold mb-6">Help & Documentation</h2>
                        <div class="space-y-6 text-sm leading-relaxed">
                            <section>
                                <h3 class="text-lg font-semibold mb-2">Overview Tab <span class="text-red-500">🎯</span></h3>
                                <p>This is your financial dashboard. Here you can:</p>
                                <ul class="list-disc ml-5 mt-2 space-y-1">
                                    <li>Monthly Budget Overview: See your set budget, total expenses for the current month, remaining budget, and annual cost.</li>
                                    <li>Budget Usage Bar: A visual representation of how much of your monthly budget you've used.</li>
                                    <li>Spending Breakdown: A quick look at where your money is going by category.</li>
                                    <li>Quick Actions: Easily adjust your monthly budget and currency.</li>
                                    <li>Quick Add: Add common expenses with a single click.</li>
                                </ul>
                            </section>
                            <section>
                                <h3 class="text-lg font-semibold mb-2">Expenses Tab <span class="text-yellow-500">💸</span></h3>
                                <p>View and manage all your individual expenses here.</p>
                                <ul class="list-disc ml-5 mt-2 space-y-1">
                                    <li>Add Expense: Click the "+ Add Expense" button to open a form where you can enter details like name, cost, type (Essential/Non Essential), category, and date.</li>
                                    <li>Edit/Delete: Each expense row has buttons to edit its details or delete it.</li>
                                    <li>Filters: Use the "Type" and "Category" dropdowns to filter your expenses for easier viewing.</li>
                                    <li>Status: Expenses are marked as 'Paid' or 'Pending'.</li>
                                </ul>
                            </section>
                            <section>
                                <h3 class="text-lg font-semibold mb-2">Recurring Tab <span class="text-blue-500">🔄</span></h3>
                                <p>Manage your regular income and expenses (e.g., rent, salary, subscriptions).</p>
                                <ul class="list-disc ml-5 mt-2 space-y-1">
                                    <li>Add Recurring Item: Click the "+ Add Recurring Item" button to set up regular transactions.</li>
                                    <li>Type: Choose between "Income" (green) or "Expense" (blue) types.</li>
                                    <li>Frequency: Set how often the item occurs (Weekly, Monthly, etc.).</li>
                                    <li>Filters: Use the filters to sort and find specific recurring items.</li>
                                    <li>Edit/Delete: Manage your recurring items with the action buttons.</li>
                                </ul>
                            </section>
                            <section>
                                <h3 class="text-lg font-semibold mb-2">Insights Tab <span class="text-purple-500">📊</span></h3>
                                <p>
                                    Visualize your spending patterns with interactive charts showing monthly trends and category breakdowns. Analyze your spending habits over time and identify areas for potential savings. This tab also includes AI-powered analysis to help you understand your financial health.
                                </p>
                            </section>
                            <section>
                                <h3 class="text-lg font-semibold mb-2">Budget Health Score <span class="text-teal-500">📈</span></h3>
                                <p>
                                    This score (0-100) reflects how well you're managing your budget this month. It considers:
                                </p>
                                <ul class="list-disc ml-5 mt-2 space-y-1">
                                    <li>Spending vs. Budget ratio</li>
                                    <li>Spending consistency throughout the month</li>
                                    <li>Essential vs. Non-essential spending balance</li>
                                    <li><strong class="font-medium text-green-600 dark:text-green-400">Good: 70+</strong></li>
                                    <li><strong class="font-medium text-yellow-600 dark:text-yellow-400">Okay: 40-69</strong></li>
                                    <li><strong class="font-medium text-red-600 dark:text-red-400">Needs Improvement: 0-39</strong></li>
                                </ul>
                            </section>
                            <section>
                                <h3 class="text-lg font-semibold mb-2">Data Storage <span class="text-indigo-500">💾</span></h3>
                                <p>
                                    All data is saved locally in your browser using localStorage. Important notes:
                                </p>
                                <ul class="list-disc ml-5 mt-2 space-y-1">
                                    <li>Clearing browser data will erase your tracker information</li>
                                    <li>Use the Export feature regularly for backups</li>
                                    <li>Your data stays private and never leaves your device</li>
                                </ul>
                            </section>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" onclick="closeSettings()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Settings</h3>
                <button onclick="closeSettings()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Budget & Income Section -->
                <div id="settings-budget-section" class="space-y-3 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                    <h4 class="text-md font-semibold">Budget & Income</h4>
                    <div>
                        <label class="block text-xs font-medium">Monthly Budget</label>
                        <input type="number" id="settings-budget-input" placeholder="e.g., 2000" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-xs font-medium">Monthly Income</label>
                        <input type="number" id="settings-income-input" placeholder="e.g., 3500" class="modern-input mt-1">
                    </div>
                </div>
            
                <!-- General Settings -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="theme-toggle" class="text-sm font-medium">Dark Mode</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle" onchange="toggleTheme(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="currency-select" class="text-sm font-medium">Currency</label>
                        <select id="currency-select" onchange="changeCurrency(this.value)" class="modern-select text-sm w-40">
                            <option value="GBP">GBP (£)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="JPY">JPY (¥)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="space-y-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="exportData()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>Export Data (JSON)</span>
                    </button>
                    <label class="modern-button modern-button-secondary w-full justify-start cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>Import Data (JSON)</span>
                        <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                    </label>
                </div>
            </div>

            <div class="flex gap-3 mt-6 border-t border-gray-200 dark:border-gray-700 pt-3">
                <button onclick="saveSettings()" class="modern-button modern-button-primary flex-1">Save & Close</button>
                <button onclick="closeSettings()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- First-Time Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="card max-w-md w-full p-6">
            <h3 class="text-xl font-semibold mb-2">Welcome! Let's get you set up.</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Provide some initial details to personalize your tracker. You can change these anytime in the settings.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Your Monthly Budget</label>
                    <input type="number" id="setup-budget-input" placeholder="e.g., 2000" class="modern-input mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Your Monthly Income (Optional)</label>
                    <input type="number" id="setup-income-input" placeholder="e.g., 3500" class="modern-input mt-1">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveSetupAndStartTour()" class="modern-button modern-button-primary flex-1">Save and Continue</button>
                <button onclick="skipSetupAndStartTour()" class="modern-button modern-button-secondary flex-1">Skip for Now</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Expense Modal -->
    <div id="modal" onclick="closeModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-6" id="modal-title">Add New Expense</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="expense-name" placeholder="e.g., Coffee, Rent" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="modal-currency">£</span>)</label>
                        <input type="number" step="0.01" id="expense-cost" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" id="expense-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="expense-category" class="modern-select mt-1">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                        <select id="expense-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="expense-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveExpense()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Recurring Item Modal -->
    <div id="recurring-modal" onclick="closeRecurringModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-4" id="recurring-modal-title">Add Recurring Item</h3>
            <div class="space-y-4">
                 <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                    <select id="recurring-item-type" class="modern-select mt-1" onchange="toggleRecurringFields(this.value)">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="recurring-name" placeholder="e.g., Salary, Netflix" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="recurring-modal-currency">£</span>)</label>
                        <input type="number" step="0.01" id="recurring-amount" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                        <select id="recurring-frequency" class="modern-select mt-1">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Bi-Weekly">Bi-Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Annual">Annual</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="recurring-category" class="modern-select mt-1">
                            <!-- Options loaded dynamically -->
                        </select>
                    </div>
                    <div id="recurring-essential-type-wrapper">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Expense Type</label>
                        <select id="recurring-essential-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                        <input type="date" id="recurring-start-date" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date (Optional)</label>
                        <input type="date" id="recurring-end-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="recurring-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveRecurring()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeRecurringModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <script>
        // --- State Variables ---
        let expenses = [];
        let recurringItems = [];
        let selectedExpenseIds = new Set();
        let selectedRecurringIds = new Set();
        let editingExpense = null;
        let editingRecurring = null;
        let monthlyBudget = 2000.00;
        let monthlyIncome = 0;
        let currencyConfig = {
            'GBP': { symbol: '£', locale: 'en-GB' },
            'EUR': { symbol: '€', locale: 'de-DE' },
            'JPY': { symbol: '¥', locale: 'ja-JP' },
            'USD': { symbol: '$', locale: 'en-US' }
        };
        let currentCurrencyCode = 'GBP';
        let activeTab = 'overview';
        let spendingTrendChart = null;
        let categorySpendingChart = null;
        let monthlySavingsChart = null;
        let aiSavingsCache = null;
        let aiSpendingCache = null;
        let lastAiUpdate = 0;

        const expenseCategories = ["Housing", "Utilities", "Transport", "Food/Drink", "Entertainment", "Shopping", "Health", "Personal Care", "Education", "Debt", "Subscriptions", "Other"];
        const incomeCategories = ["Salary", "Bonus", "Investment", "Gift", "Other Income"];

        // Keyword mapping for auto-categorization and essential status
        const categoryKeywords = {
            'Housing': ['rent', 'mortgage', 'property tax', 'home insurance'],
            'Utilities': ['gas', 'electricity', 'water', 'internet', 'phone', 'council tax'],
            'Transport': ['fuel', 'petrol', 'diesel', 'train', 'bus', 'tube', 'taxi', 'uber'],
            'Food/Drink': ['coffee', 'lunch', 'groceries', 'supermarket', 'restaurant', 'takeaway'],
            'Entertainment': ['cinema', 'concert', 'theatre', 'streaming', 'netflix', 'spotify', 'disney+'],
            'Shopping': ['clothes', 'electronics', 'gifts', 'amazon'],
            'Health': ['pharmacy', 'doctor', 'dentist', 'gym'],
            'Personal Care': ['haircut', 'toiletries'],
            'Education': ['books', 'course', 'tuition'],
            'Debt': ['loan', 'credit card'],
            'Subscriptions': ['subscription']
        };

        const essentialKeywords = [
            'rent', 'mortgage', 'property tax', 'home insurance', 'gas', 'electricity', 
            'water', 'internet', 'phone', 'council tax', 'fuel', 'petrol', 'diesel', 'train', 
            'bus', 'tube', 'groceries', 'supermarket', 'pharmacy', 'doctor', 'dentist', 
            'loan', 'credit card', 'tuition'
        ];

        // --- DOM Elements Cache ---
        const DOMElements = {
            html: document.documentElement,
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            expenseName: document.getElementById('expense-name'),
            expenseCost: document.getElementById('expense-cost'),
            expenseType: document.getElementById('expense-type'),
            expenseCategory: document.getElementById('expense-category'),
            expenseDate: document.getElementById('expense-date'),
            expensePaymentMethod: document.getElementById('expense-payment-method'),
            modalCurrency: document.getElementById('modal-currency'),

            recurringModal: document.getElementById('recurring-modal'),
            recurringModalTitle: document.getElementById('recurring-modal-title'),
            recurringItemType: document.getElementById('recurring-item-type'),
            recurringName: document.getElementById('recurring-name'),
            recurringAmount: document.getElementById('recurring-amount'),
            recurringFrequency: document.getElementById('recurring-frequency'),
            recurringCategory: document.getElementById('recurring-category'),
            recurringEssentialTypeWrapper: document.getElementById('recurring-essential-type-wrapper'),
            recurringEssentialType: document.getElementById('recurring-essential-type'),
            recurringPaymentMethod: document.getElementById('recurring-payment-method'),
            recurringStartDate: document.getElementById('recurring-start-date'),
            recurringEndDate: document.getElementById('recurring-end-date'),
            recurringModalCurrency: document.getElementById('recurring-modal-currency'),

            monthlyBudgetDisplay: document.getElementById('monthly-budget'),
            budgetInput: document.getElementById('budget-input'),
            incomeInput: document.getElementById('income-input'),
            totalExpensesDisplay: document.getElementById('total-expenses'),
            remainingAmountDisplay: document.getElementById('remaining-amount'),
            totalIncomeDisplay: document.getElementById('total-income'),
            budgetBar: document.getElementById('budget-bar'),
            budgetPercentage: document.getElementById('budget-percentage'),
            healthScoreFill: document.getElementById('health-score-fill'),
            healthScoreValue: document.getElementById('health-score-value'),
            healthScoreLabel: document.getElementById('health-score-label'),
            essentialSpendingDisplay: document.getElementById('essential-spending'),
            nonEssentialSpendingDisplay: document.getElementById('non-essential-spending'),
            essentialBar: document.getElementById('essential-bar'),
            nonEssentialBar: document.getElementById('non-essential-bar'),
            recentExpensesContainer: document.getElementById('recent-expenses'),
            expensesTableBody: document.getElementById('expenses-table'),
            recurringTableBody: document.getElementById('recurring-table'),
            settingsMenu: document.getElementById('settings-menu'),
            themeToggle: document.getElementById('theme-toggle'),
            currencySelect: document.getElementById('currency-select'),
            toast: document.getElementById('toast'),
            
            spendingTrendCanvas: document.getElementById('spending-trend-chart'),
            categorySpendingCanvas: document.getElementById('category-spending-chart'),
            monthlySavingsCanvas: document.getElementById('monthly-savings-chart'),
            spendingInsightsContainer: document.getElementById('spending-insights'),
            aiSavingsInsightsContainer: document.getElementById('ai-savings-insights'),

            selectAllExpensesCheckbox: document.getElementById('select-all-expenses'),
            deleteSelectedBtn: document.getElementById('delete-selected-btn'),
            selectAllRecurringCheckbox: document.getElementById('select-all-recurring'),
            deleteSelectedRecurringBtn: document.getElementById('delete-selected-recurring-btn'),
        };
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            populateCategoryDropdowns();
            applyTheme();
            updateCurrencyUI();
            updateDisplay();
            showTab(activeTab);
            DOMElements.expenseDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];

            // Add event listener for auto-categorization
            DOMElements.expenseName.addEventListener('input', autoCategorizeExpense);
            DOMElements.recurringName.addEventListener('input', autoCategorizeExpense);
            
            startOnboardingProcess();
        });

        // --- Onboarding ---
        function startOnboardingProcess() {
            if (localStorage.getItem('onboardingComplete') !== 'true') {
                document.getElementById('setup-modal').classList.remove('hidden');
            }
        }

        function saveSetupAndStartTour() {
            const budget = document.getElementById('setup-budget-input').value;
            const income = document.getElementById('setup-income-input').value;

            if (budget) {
                updateBudget(budget);
            }
            if (income) {
                updateIncome(income);
            }
            
            document.getElementById('setup-modal').classList.add('hidden');
            launchOnboardingTour();
        }

        function skipSetupAndStartTour() {
            document.getElementById('setup-modal').classList.add('hidden');
            launchOnboardingTour();
        }

        function launchOnboardingTour() {
            const driver = window.driver.js.driver;
            const driverObj = driver({
                showProgress: true,
                popoverClass: 'driver-popover',
                steps: [
                    { 
                        element: '.sm\\:items-center .gap-3 h1', 
                        popover: { 
                            title: 'Welcome to Your Expense Tracker!', 
                            description: "Let's take a quick tour to get you started.",
                            side: "bottom" 
                        } 
                    },
                    { 
                        element: '#budget-input', 
                        popover: { 
                            title: 'Set Your Monthly Budget', 
                            description: 'Start by entering your total monthly budget. This is the baseline for tracking your spending.',
                            side: "bottom"
                        } 
                    },
                    { 
                        element: 'button[onclick="showAddForm()"]', 
                        popover: { 
                            title: 'Add a New Expense', 
                            description: 'Use this button to log any one-time purchases or expenses.',
                            side: "left" 
                        } 
                    },
                    { 
                        element: 'button[onclick="showRecurringForm()"]', 
                        popover: { 
                            title: 'Add a Recurring Item', 
                            description: 'For regular income (like a salary) or expenses (like rent or subscriptions), use this.',
                            side: "left"
                        } 
                    },
                    { 
                        element: '#tab-insights', 
                        popover: { 
                            title: 'Visualize Your Spending', 
                            description: 'This tab contains charts and AI-powered insights to help you understand your financial habits.',
                            side: "bottom" 
                        } 
                    },
                    { 
                        element: 'button[onclick="toggleSettings()"]', 
                        popover: { 
                            title: 'Settings & Data', 
                            description: 'Change the theme, set your currency, and import or export your data here.',
                            side: "left" 
                        } 
                    }
                ],
                onDestroyed: () => {
                    localStorage.setItem('onboardingComplete', 'true');
                    
                    // Animate quick-add tiles
                    const quickAddTiles = document.querySelectorAll('.card button[onclick^="quickAddExpense"]');
                    quickAddTiles.forEach(tile => tile.parentElement.classList.add('animate-pulse'));
                    
                    setTimeout(() => {
                        quickAddTiles.forEach(tile => tile.parentElement.classList.remove('animate-pulse'));
                    }, 4000);
                }
            });

            driverObj.drive();
        }

        // --- Tab Management ---
        function showTab(tabName) {
            // Hide all tab content and deactivate all tab buttons first
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

            // Activate the new tab button and show its content
            const newTabButton = document.getElementById(`tab-${tabName}`);
            const newTabContent = document.getElementById(`${tabName}-tab`);

            if (newTabButton && newTabContent) {
                newTabButton.classList.add('active');
                newTabContent.classList.remove('hidden');
                activeTab = tabName;

                if (activeTab === 'insights') {
                    updateChartsAndInsights();
                }
                saveData();
            }
        }

        // --- Settings & Theme ---
        function toggleSettings() {
            DOMElements.settingsMenu.classList.toggle('hidden');
        }

        function toggleTheme(isDark) {
            localStorage.setItem('darkMode', isDark);
            applyTheme();
        }

        function applyTheme() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            DOMElements.html.classList.toggle('dark', darkMode);
            DOMElements.themeToggle.checked = darkMode;
            
            if (activeTab === 'insights') {
                updateChartsAndInsights(); 
            }
        }

        // --- Data Load/Save ---
        function loadData() {
            const data = localStorage.getItem('aiExpenseTrackerData');
            if (data) {
                const parsedData = JSON.parse(data);
                expenses = parsedData.expenses || [];
                recurringItems = parsedData.recurringItems || [];
                monthlyBudget = parsedData.monthlyBudget || 0;
                monthlyIncome = parsedData.monthlyIncome || 0;
                currentCurrencyCode = parsedData.currentCurrencyCode || 'GBP';
                activeTab = parsedData.activeTab || 'overview';
            }
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                 DOMElements.themeToggle.checked = savedDarkMode === 'true';
            }
        }

        function saveData() {
            const dataToSave = {
                expenses,
                recurringItems,
                monthlyBudget,
                monthlyIncome,
                currentCurrencyCode,
                activeTab
            };
            localStorage.setItem('aiExpenseTrackerData', JSON.stringify(dataToSave));
        }

        // --- Import / Export ---
        function exportData() {
            const dataStr = localStorage.getItem('aiExpenseTrackerData') || '{}';
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-expense-tracker-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData === 'object' && importedData !== null) {
                        expenses = importedData.expenses || [];
                        recurringItems = importedData.recurringItems || [];
                        monthlyBudget = importedData.monthlyBudget || 0;
                        monthlyIncome = importedData.monthlyIncome || 0;
                        currentCurrencyCode = importedData.currentCurrencyCode || 'GBP';
                        activeTab = importedData.activeTab || 'overview';
                        
                        DOMElements.currencySelect.value = currentCurrencyCode;

                        saveData();
                        updateCurrencyUI();
                        updateDisplay();
                        showTab(activeTab);
                        showToast('Data imported successfully!');
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    showToast('Import failed: Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = null;
            DOMElements.settingsMenu.classList.add('hidden');
        }

        // --- Budget & Income ---
        function updateBudget(value) {
            monthlyBudget = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }
        function updateIncome(value) {
            monthlyIncome = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }

        // --- Currency Management ---
        function changeCurrency(value) {
            if (currencyConfig[value]) {
                currentCurrencyCode = value;
                updateCurrencyUI();
                saveData();
                updateDisplay();
                showToast(`Currency changed to ${value}`);
            }
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function updateCurrencyUI() {
            const symbol = currencyConfig[currentCurrencyCode].symbol;
            DOMElements.modalCurrency.textContent = symbol;
            DOMElements.recurringModalCurrency.textContent = symbol;
            DOMElements.currencySelect.value = currentCurrencyCode;
        }

        // --- Expense Management ---
        function showAddForm(prefill = {}) {
            editingExpense = null;
            DOMElements.modalTitle.textContent = 'Add New Expense';
            DOMElements.expenseName.value = prefill.name || '';
            DOMElements.expenseCost.value = prefill.cost || '';
            DOMElements.expenseType.value = prefill.type || 'Non-Essential';
            DOMElements.expenseCategory.value = prefill.category || 'Other';
            DOMElements.expenseDate.value = prefill.date || new Date().toISOString().split('T')[0];
            DOMElements.expensePaymentMethod.value = prefill.paymentMethod || '';
            DOMElements.modal.classList.remove('hidden');
        }

        function closeModal() {
            DOMElements.modal.classList.add('hidden');
            editingExpense = null;
        }

        function saveExpense() {
            const name = DOMElements.expenseName.value.trim();
            const cost = parseFloat(DOMElements.expenseCost.value);
            const date = DOMElements.expenseDate.value;

            if (!name || isNaN(cost) || cost <= 0 || !date) {
                showToast('Please fill in all fields correctly (Name, positive Amount, Date).', 'error');
                return;
            }

            const expense = {
                id: editingExpense ? editingExpense.id : Date.now(),
                name: name,
                cost: cost,
                type: DOMElements.expenseType.value,
                category: DOMElements.expenseCategory.value,
                date: date,
                paymentMethod: DOMElements.expensePaymentMethod.value,
                status: 'active'
            };

            if (editingExpense) {
                const index = expenses.findIndex(e => e.id === editingExpense.id);
                if (index !== -1) expenses[index] = expense;
            } else {
                expenses.unshift(expense);
            }

            saveData();
            updateDisplay();
            closeModal();
            showToast(`Expense '${name}' saved successfully!`);
        }
        
        function quickAddExpense(name, category, type, cost) {
            const expense = {
                id: Date.now(),
                name: name,
                cost: cost,
                type: type || 'Non-Essential',
                category: category || 'Other',
                date: new Date().toISOString().split('T')[0],
                paymentMethod: '',
                status: 'active'
            };
            expenses.unshift(expense);
            saveData();
            updateDisplay();
            showToast(`${name} added successfully for ${formatCurrency(cost)}.`);
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            editingExpense = expense;
            DOMElements.modalTitle.textContent = 'Edit Expense';
            DOMElements.expenseName.value = expense.name;
            DOMElements.expenseCost.value = expense.cost;
            DOMElements.expenseType.value = expense.type;
            DOMElements.expenseCategory.value = expense.category;
            DOMElements.expenseDate.value = expense.date;
            DOMElements.expensePaymentMethod.value = expense.paymentMethod || '';
            DOMElements.modal.classList.remove('hidden');
        }

        function deleteExpense(id) {
            // Handle deleting recurring instances from the expenses tab
            if (typeof id === 'string' && id.startsWith('recurring-')) {
                if (confirm('This is a recurring expense. Deleting it from this view will not stop future occurrences. To manage the series, please go to the Recurring tab. Do you want to proceed?')) {
                    // This is a virtual deletion for the current view only.
                    // We can't permanently delete a single instance without complex logic,
                    // so for now we just refresh the view.
                    showToast('Action acknowledged. Manage recurring items in their tab.', 'info');
                }
                return;
            }

            if (confirm('Are you sure you want to permanently delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                selectedExpenseIds.delete(id.toString());
                saveData();
                updateDisplay();
                showToast('Expense deleted successfully!');
            }
        }

        function toggleExpenseStatus(id) {
            // Find in regular expenses
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.status = expense.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Expense status updated to ${expense.status}.`);
            } else {
                // Handle recurring items if not found in regular expenses
                showToast('Cannot change status of a recurring item instance from here.', 'info');
            }
        }
        
        function toggleFilterPanel(panelId) {
            document.getElementById(panelId).classList.toggle('hidden');
        }

        // --- Recurring Item Management ---
        function populateCategoryDropdowns() {
            const expenseOptions = expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            DOMElements.expenseCategory.innerHTML = expenseOptions;
            
            document.getElementById('expense-filter-category').innerHTML = '<option value="">All Categories</option>' + expenseOptions;
            
            const allCats = [...new Set([...expenseCategories, ...incomeCategories])];
            document.getElementById('recurring-filter-category').innerHTML = '<option value="">All Categories</option>' + allCats.map(c => `<option value="${c}">${c}</option>`).join('');

            toggleRecurringFields('expense');
        }

        function toggleRecurringFields(type) {
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            DOMElements.recurringCategory.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            DOMElements.recurringEssentialTypeWrapper.style.display = type === 'expense' ? 'block' : 'none';
        }

         function showRecurringForm() {
            editingRecurring = null;
            DOMElements.recurringModalTitle.textContent = 'Add Recurring Item';
            DOMElements.recurringItemType.value = 'expense';
            toggleRecurringFields('expense');
            DOMElements.recurringName.value = '';
            DOMElements.recurringAmount.value = '';
            DOMElements.recurringFrequency.value = 'Monthly';
            DOMElements.recurringPaymentMethod.value = '';
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringEndDate.value = '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function closeRecurringModal() {
            DOMElements.recurringModal.classList.add('hidden');
            editingRecurring = null;
        }

        function saveRecurring() {
            const type = DOMElements.recurringItemType.value;
            const name = DOMElements.recurringName.value.trim();
            const amount = parseFloat(DOMElements.recurringAmount.value);
            const startDate = DOMElements.recurringStartDate.value;
            const endDate = DOMElements.recurringEndDate.value || null;

            if (!name || isNaN(amount) || amount <= 0 || !startDate) {
                 showToast('Please fill in recurring item fields correctly.', 'error');
                return;
            }

            const recurringItem = {
                id: editingRecurring ? editingRecurring.id : Date.now(),
                type: type,
                name: name,
                amount: amount,
                frequency: DOMElements.recurringFrequency.value,
                category: DOMElements.recurringCategory.value,
                essentialType: type === 'expense' ? DOMElements.recurringEssentialType.value : null,
                paymentMethod: DOMElements.recurringPaymentMethod.value,
                startDate: startDate,
                endDate: endDate,
                status: 'active'
            };

            if (editingRecurring) {
                const index = recurringItems.findIndex(r => r.id === editingRecurring.id);
                if (index !== -1) recurringItems[index] = recurringItem;
            } else {
                recurringItems.unshift(recurringItem);
            }

            saveData();
            updateDisplay();
            closeRecurringModal();
            showToast(`Recurring ${type} '${name}' saved successfully!`);
        }

        function editRecurring(id) {
            const item = recurringItems.find(r => r.id === id);
            if (!item) return;
            editingRecurring = item;
            DOMElements.recurringModalTitle.textContent = 'Edit Recurring Item';
            DOMElements.recurringItemType.value = item.type;
            toggleRecurringFields(item.type);
            DOMElements.recurringName.value = item.name;
            DOMElements.recurringAmount.value = item.amount;
            DOMElements.recurringFrequency.value = item.frequency;
            DOMElements.recurringCategory.value = item.category;
            if (item.type === 'expense') {
                DOMElements.recurringEssentialType.value = item.essentialType || 'Non-Essential';
            }
            DOMElements.recurringPaymentMethod.value = item.paymentMethod || '';
            DOMElements.recurringStartDate.value = item.startDate;
            DOMElements.recurringEndDate.value = item.endDate || '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function deleteRecurring(id) {
            if (confirm('Are you sure you want to delete this recurring item?')) {
                recurringItems = recurringItems.filter(r => r.id !== id);
                selectedRecurringIds.delete(id);
                saveData();
                updateDisplay();
                showToast('Recurring item deleted successfully!');
            }
        }
        
        function toggleRecurringStatus(id) {
            const item = recurringItems.find(r => r.id === id);
            if(item) {
                item.status = item.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Recurring item status updated.`);
            }
        }
        
        // --- Filtering Logic ---
        function applyExpenseFilters() {
            renderExpensesTable();
            showToast('Filters applied');
        }

        function clearExpenseFilters() {
            document.getElementById('expense-filter-date-from').value = '';
            document.getElementById('expense-filter-date-to').value = '';
            document.getElementById('expense-filter-category').value = '';
            document.getElementById('expense-filter-type').value = '';
            renderExpensesTable();
            showToast('Filters cleared');
        }

        function applyRecurringFilters() {
            renderRecurringTable();
            showToast('Filters applied');
        }

        function clearRecurringFilters() {
            document.getElementById('recurring-filter-type').value = '';
            document.getElementById('recurring-filter-category').value = '';
            document.getElementById('recurring-filter-frequency').value = '';
            renderRecurringTable();
            showToast('Filters cleared');
        }
        
        // --- Bulk Actions ---
        function toggleSelectAllExpenses(checked) {
            const checkboxes = DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox');
            selectedExpenseIds.clear();
            checkboxes.forEach(cb => {
                if (!cb.disabled) {
                    cb.checked = checked;
                    if (checked) {
                        selectedExpenseIds.add(cb.dataset.id);
                    }
                }
            });
            updateDeleteSelectedButton();
        }

        function toggleExpenseSelection(checkbox, id) {
            if (checkbox.checked) {
                selectedExpenseIds.add(id);
            } else {
                selectedExpenseIds.delete(id);
            }
            const allCheckboxes = [...DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox:not(:disabled)')];
            DOMElements.selectAllExpensesCheckbox.checked = allCheckboxes.length > 0 && selectedExpenseIds.size === allCheckboxes.length;
            updateDeleteSelectedButton();
        }

        function updateDeleteSelectedButton() {
            if (selectedExpenseIds.size > 0) {
                DOMElements.deleteSelectedBtn.classList.remove('hidden');
                DOMElements.deleteSelectedBtn.querySelector('span').textContent = `Delete Selected (${selectedExpenseIds.size})`;
            } else {
                DOMElements.deleteSelectedBtn.classList.add('hidden');
            }
        }

        function deleteSelectedExpenses() {
            if (selectedExpenseIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedExpenseIds.size} selected one-time expense(s)?`)) {
                const initialCount = expenses.length;
                expenses = expenses.filter(e => !selectedExpenseIds.has(e.id.toString()));
                const deletedCount = initialCount - expenses.length;
                selectedExpenseIds.clear();
                DOMElements.selectAllExpensesCheckbox.checked = false;
                saveData();
                updateDisplay();
                showToast(`${deletedCount} expense(s) deleted.`);
            }
        }
        
        function toggleSelectAllRecurring(checked) {
            const checkboxes = DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox');
            selectedRecurringIds.clear();
            checkboxes.forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedRecurringIds.add(parseInt(cb.dataset.id));
                }
            });
            updateDeleteSelectedRecurringButton();
        }

        function toggleRecurringSelection(checkbox, id) {
            const numId = parseInt(id);
            if (checkbox.checked) {
                selectedRecurringIds.add(numId);
            } else {
                selectedRecurringIds.delete(numId);
            }
            const allCheckboxes = [...DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox')];
            DOMElements.selectAllRecurringCheckbox.checked = allCheckboxes.length > 0 && selectedRecurringIds.size === allCheckboxes.length;
            updateDeleteSelectedRecurringButton();
        }

        function updateDeleteSelectedRecurringButton() {
            const btn = DOMElements.deleteSelectedRecurringBtn;
            if (selectedRecurringIds.size > 0) {
                btn.classList.remove('hidden');
                btn.querySelector('span').textContent = `Delete Selected (${selectedRecurringIds.size})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        function deleteSelectedRecurring() {
            if (selectedRecurringIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedRecurringIds.size} recurring item(s)?`)) {
                recurringItems = recurringItems.filter(r => !selectedRecurringIds.has(r.id));
                selectedRecurringIds.clear();
                DOMElements.selectAllRecurringCheckbox.checked = false;
                saveData();
                updateDisplay();
                showToast(`${selectedRecurringIds.size} recurring item(s) deleted.`);
            }
        }

        // --- Calculation Functions ---
        function getMonthlyRecurringTotals(year, month) {
            let totals = { income: 0, expenses: 0 };
            recurringItems.forEach(item => {
                if (item.status !== 'active') return;
                const startDate = new Date(item.startDate);
                if (startDate.getFullYear() > year || (startDate.getFullYear() === year && startDate.getMonth() > month)) return;
                if (item.endDate) {
                    const endDate = new Date(item.endDate);
                    if (endDate.getFullYear() < year || (endDate.getFullYear() === year && endDate.getMonth() < month)) return;
                }
                if (item.frequency === 'Monthly') {
                    if (item.type === 'income') totals.income += item.amount;
                    else totals.expenses += item.amount;
                }
                // TODO: Add other frequencies
            });
            return totals;
        }

        function getMonthlyExpenseTotal(year, month) {
             return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && expenseDate.getMonth() === month && expenseDate.getFullYear() === year;
            }).reduce((sum, e) => sum + e.cost, 0);
        }

        // --- UI Update Functions ---
        function getResponsiveFontSize(text) {
            const baseSize = 1.875; // Corresponds to text-3xl
            const minSize = 1.25; // Corresponds to text-xl
            const maxLength = 8; // Start shrinking after 8 characters
            
            let newSize = baseSize;
            if (text.length > maxLength) {
                newSize = Math.max(minSize, baseSize - (text.length - maxLength) * 0.15);
            }
            return `${newSize}rem`;
        }

        function updateQuickAddButtons() {
            const quickAddData = {
                'JPY': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 500 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 700 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 1000 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 20000 }
                ],
                'default': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 5 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 10 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 15 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 50 }
                ]
            };

            const currencyData = quickAddData[currentCurrencyCode] || quickAddData['default'];
            
            currencyData.forEach(item => {
                const container = document.getElementById(item.id);
                if (container) {
                    const button = container.querySelector('button');
                    const costSpan = button.querySelector('span.font-medium');

                    costSpan.textContent = formatCurrency(item.cost);
                    button.onclick = () => quickAddExpense(item.name, item.category, item.type, item.cost);
                }
            });
        }

        function updateDisplay() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Centralized calculations for all expenses this month
            const monthlyRecurring = getMonthlyRecurringTotals(currentYear, currentMonth);
            const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;

            const allMonthlyExpenses = [
                ...expenses.filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                }),
                ...generateExpensesFromRecurring().filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                })
            ];
            const activeMonthlyExpenses = allMonthlyExpenses.filter(e => e.status === 'active');
            const totalSpent = activeMonthlyExpenses.reduce((sum, e) => sum + e.cost, 0);

            // --- Update UI Tiles ---
            const budgetStr = formatCurrency(monthlyBudget);
            const spentStr = formatCurrency(totalSpent);
            const incomeStr = formatCurrency(totalMonthlyIncome);
            const remaining = monthlyBudget - totalSpent;
            const remainingStr = formatCurrency(remaining);

            // Find the longest string to determine a consistent font size
            const maxLength = Math.max(budgetStr.length, spentStr.length, incomeStr.length, remainingStr.length);
            const responsiveSize = getResponsiveFontSize(" ".repeat(maxLength));

            DOMElements.monthlyBudgetDisplay.textContent = budgetStr;
            DOMElements.monthlyBudgetDisplay.style.fontSize = responsiveSize;

            DOMElements.totalExpensesDisplay.textContent = spentStr;
            DOMElements.totalExpensesDisplay.style.fontSize = responsiveSize;
            
            DOMElements.totalIncomeDisplay.textContent = incomeStr;
            DOMElements.totalIncomeDisplay.style.fontSize = responsiveSize;

            DOMElements.remainingAmountDisplay.textContent = remainingStr;
            DOMElements.remainingAmountDisplay.style.fontSize = responsiveSize;

            if (remaining < 0) {
                DOMElements.remainingAmountDisplay.classList.remove('text-green-600', 'dark:text-green-400');
                DOMElements.remainingAmountDisplay.classList.add('text-red-600', 'dark:text-red-400');
            } else {
                DOMElements.remainingAmountDisplay.classList.remove('text-red-600', 'dark:text-red-400');
                DOMElements.remainingAmountDisplay.classList.add('text-green-600', 'dark:text-green-400');
            }

            updateQuickAddButtons();

            // Budget Health & Progress Bar
            const budgetProgress = (monthlyBudget > 0) ? (totalSpent / monthlyBudget) * 100 : 0;
            DOMElements.budgetBar.style.width = `${Math.min(budgetProgress, 100)}%`;
            DOMElements.budgetBar.classList.remove('bg-blue-600', 'bg-red-600');
            DOMElements.budgetBar.classList.add(budgetProgress > 100 ? 'bg-red-600' : 'bg-blue-600');
            DOMElements.budgetPercentage.textContent = `${budgetProgress.toFixed(0)}% Used`;
            
            updateBudgetHealthScore(totalSpent, monthlyBudget, activeMonthlyExpenses);
            
            // Spending Breakdown
            const essentialSpending = activeMonthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
            const nonEssentialSpending = activeMonthlyExpenses.filter(e => e.type === 'Non-Essential').reduce((sum, e) => sum + e.cost, 0);
            DOMElements.essentialSpendingDisplay.textContent = formatCurrency(essentialSpending);
            DOMElements.nonEssentialSpendingDisplay.textContent = formatCurrency(nonEssentialSpending);
            const totalBreakdown = essentialSpending + nonEssentialSpending;
            const essentialPercent = totalBreakdown > 0 ? (essentialSpending / totalBreakdown) * 100 : 0;
            DOMElements.essentialBar.style.width = `${essentialPercent}%`;
            DOMElements.nonEssentialBar.style.width = `${100 - essentialPercent}%`;

            renderRecentExpenses();
            renderExpensesTable();
            renderRecurringTable();
            
            if (activeTab === 'insights') {
                updateChartsAndInsights();
            }
            updateDeleteSelectedButton();
            updateDeleteSelectedRecurringButton();
        }

        function updateBudgetHealthScore(totalSpent, budget, monthlyExpenses) {
            let score = 0;
            let label = "Poor";
            let color = 'var(--health-score-bad)';

            if (budget > 0) {
                const usageRatio = totalSpent / budget;
                // Score based on budget usage
                if (usageRatio <= 0.8) score += 50;
                else if (usageRatio <= 1.0) score += 50 * (1 - (usageRatio - 0.8) / 0.2);
                
                // Score based on spending habits (essential vs non-essential)
                const totalBreakdown = monthlyExpenses.reduce((s, e) => s + e.cost, 0);
                if (totalBreakdown > 0) {
                    const nonEssentialSpending = monthlyExpenses.filter(e => e.type === 'Non-Essential').reduce((s, e) => s + e.cost, 0);
                    const nonEssentialRatio = nonEssentialSpending / totalBreakdown;
                    if (nonEssentialRatio <= 0.3) score += 30; // 30 points if non-essentials are <30%
                    else if (nonEssentialRatio <= 0.5) score += 15; // 15 points if <50%
                } else {
                    score += 15; // If no spending, give some points
                }

                // Score based on having income set vs budget
                if (monthlyIncome > 0 && monthlyIncome >= budget) {
                    score += 20;
                }

            } else {
                label = "Set Budget";
            }

            score = Math.max(0, Math.min(100, Math.round(score)));

            if (score >= 70) { label = "Good"; color = 'var(--health-score-good)'; }
            else if (score >= 40) { label = "Okay"; color = 'var(--health-score-ok)'; }
            else if (budget > 0) { label = "Poor"; color = 'var(--health-score-bad)'; }

            DOMElements.healthScoreValue.textContent = score;
            DOMElements.healthScoreLabel.textContent = label;
            DOMElements.healthScoreFill.style.borderColor = color;

            // Calculate rotation for the gauge
            const fillRotation = -135 + (score / 100) * 180;
            DOMElements.healthScoreFill.style.transform = `rotate(${fillRotation}deg)`;
        }

        function renderRecentExpenses() {
            DOMElements.recentExpensesContainer.innerHTML = '';
            const allDisplayExpenses = [...expenses, ...generateExpensesFromRecurring()];
            const recent = allDisplayExpenses
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recent.length === 0) {
                DOMElements.recentExpensesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">No recent expenses.</p>';
                return;
            }
            recent.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center border-b border-gray-100 dark:border-gray-700 py-2 last:border-b-0 text-xs';
                div.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800 dark:text-gray-200">${escapeHTML(expense.name)}</p>
                        <p class="text-gray-500 dark:text-gray-400">${expense.date} - ${escapeHTML(expense.category)}</p>
                    </div>
                    <p class="font-medium text-red-600 dark:text-red-400">${formatCurrency(expense.cost)}</p>
                `;
                DOMElements.recentExpensesContainer.appendChild(div);
            });
        }

        function renderExpensesTable() {
            const generated = generateExpensesFromRecurring();
            let allExpenses = [...expenses, ...generated];

            // Apply filters
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            const filteredExpenses = allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                if (typeFilter && e.type !== typeFilter) passes = false;
                return passes;
            }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by most recent date

            const tableBody = DOMElements.expensesTableBody;
            if (filteredExpenses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-gray-500">No expenses match your filters.</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredExpenses.map(expense => {
                const isRecurringInstance = typeof expense.id === 'string' && expense.id.startsWith('recurring-');
                const isCancelled = expense.status === 'cancelled';
                const editAction = isRecurringInstance ? `editRecurring(${expense.originalRecurringId})` : `editExpense(${expense.id})`;
                const deleteAction = isRecurringInstance ? 'return false;' : `deleteExpense(${expense.id})`;
                const statusToggleAction = isRecurringInstance ? `toggleRecurringStatus(${expense.originalRecurringId})` : `toggleExpenseStatus(${expense.id})`;
                const checkboxId = `expense-${expense.id}`;

                return `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 ${isCancelled ? 'opacity-60' : ''}">
                        <td class="px-4 py-3">
                            <input type="checkbox" id="${checkboxId}" data-id="${expense.id}" onchange="toggleExpenseSelection(this, '${expense.id}')" 
                            class="table-checkbox expense-checkbox" ${isRecurringInstance ? 'disabled' : ''} ${selectedExpenseIds.has(expense.id.toString()) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap">${escapeHTML(expense.name)}</td>
                        <td class="px-6 py-3">${formatCurrency(expense.cost)}</td>
                        <td class="px-6 py-3 hidden md:table-cell">${expense.date}</td>
                        <td class="px-6 py-3 hidden md:table-cell">${escapeHTML(expense.category)}</td>
                        <td class="px-6 py-3 hidden lg:table-cell">${escapeHTML(expense.paymentMethod) || '-'}</td>
                        <td class="px-6 py-3 hidden lg:table-cell">${escapeHTML(expense.type)}</td>
                        <td class="px-6 py-3">
                            <span class="status-badge ${isCancelled ? 'status-cancelled' : 'status-active'}">${isCancelled ? 'Cancelled' : 'Active'}</span>
                        </td>
                        <td class="px-6 py-3 text-right">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="${editAction}" title="Edit" class="icon-button" ${isCancelled ? 'disabled' : ''} ${isCancelled ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="${deleteAction}" title="Delete" class="icon-button text-red-600/80 hover:text-red-500" ${isRecurringInstance ? 'disabled' : ''} ${isRecurringInstance ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderRecurringTable() {
            DOMElements.recurringTableBody.innerHTML = '';
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;
            
            let filtered = recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });

            filtered.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            if (filtered.length === 0) {
                DOMElements.recurringTableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                return;
            }

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                const isSelected = selectedRecurringIds.has(item.id);
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${item.status === 'cancelled' ? 'opacity-60' : ''} ${isSelected ? 'bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800'}`;
                const itemTypeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

                tr.innerHTML = `
                    <td class="px-4 py-4 w-1"><input type="checkbox" data-id="${item.id}" onchange="toggleRecurringSelection(this, ${item.id})" class="table-checkbox recurring-checkbox" ${isSelected ? 'checked' : ''}></td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${escapeHTML(item.name)}</td>
                    <td class="px-6 py-4 capitalize">${item.type}</td>
                    <td class="px-6 py-4 font-medium ${itemTypeClass}">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4 hidden md:table-cell">${item.frequency}</td>
                    <td class="px-6 py-4 hidden md:table-cell">${item.startDate}</td>
                    <td class="px-6 py-4 hidden lg:table-cell">${escapeHTML(item.category)}</td>
                    <td class="px-6 py-4"><span class="status-badge ${item.status === 'active' ? 'status-active' : 'status-cancelled'}">${item.status}</span></td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap">
                        <button onclick="editRecurring(${item.id})" class="icon-button" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        <button onclick="toggleRecurringStatus(${item.id})" class="icon-button" title="${item.status === 'active' ? 'Pause' : 'Resume'}">
                           ${item.status === 'active' ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'}
                        </button>
                        <button onclick="deleteRecurring(${item.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </td>
                `;
                DOMElements.recurringTableBody.appendChild(tr);
            });
        }
        
        // --- Charting and Insights ---
        function updateChartsAndInsights() {
            renderSpendingTrendChart();
            renderCategorySpendingChart();
            renderMonthlySavingsChart();
            updateAiInsights();
        }

        const chartColors = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#06b6d4', '#d946ef', '#84cc16'];
        function getChartColors(count) {
            return Array.from({length: count}, (_, i) => chartColors[i % chartColors.length]);
        }

        function getChartOptions(isDarkMode) {
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { color: gridColor }, ticks: { color: textColor } },
                    y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, callback: value => formatCurrency(value, false) } }
                },
                plugins: {
                    legend: { labels: { color: textColor } },
                    tooltip: { titleFont: { weight: 'bold' }, bodyFont: {}, backgroundColor: isDarkMode ? '#334155' : '#ffffff', titleColor: isDarkMode ? '#f1f5f9' : '#1e293b', bodyColor: isDarkMode ? '#f1f5f9' : '#1e293b', borderColor: isDarkMode ? '#475569' : '#e2e8f0', borderWidth: 1 }
                }
            };
        }

        function renderSpendingTrendChart() {
            const ctx = DOMElements.spendingTrendCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const data = monthlyData.map(m => m.expenses);

            if (spendingTrendChart) spendingTrendChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            spendingTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: chartColors[2],
                        backgroundColor: chartColors[2] + '33',
                        tension: 0.2, fill: true, pointRadius: 3, pointHoverRadius: 5
                    }]
                },
                options: options
            });
        }

        function renderCategorySpendingChart() {
            const ctx = DOMElements.categorySpendingCanvas?.getContext('2d');
            if (!ctx) return;
            const now = new Date();
            const categorySpending = expenses.filter(e => new Date(e.date).getMonth() === now.getMonth() && new Date(e.date).getFullYear() === now.getFullYear() && e.status === 'active')
                .reduce((acc, exp) => {
                    acc[exp.category] = (acc[exp.category] || 0) + exp.cost;
                    return acc;
                }, {});
            
            const sortedCategories = Object.entries(categorySpending).sort((a,b) => b[1] - a[1]);
            const labels = sortedCategories.map(c => c[0]);
            const data = sortedCategories.map(c => c[1]);
            
            if (categorySpendingChart) categorySpendingChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.scales = {};
            options.plugins.legend = { position: 'bottom', labels: { color: isDarkMode ? '#cbd5e1' : '#64748b', boxWidth: 12, padding: 15 } };
            options.plugins.tooltip.callbacks = {
                label: function(context) {
                    let total = context.dataset.data.reduce((a, b) => a + b, 0);
                    let percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                    return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                }
            };

            categorySpendingChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: getChartColors(labels.length),
                        borderColor: isDarkMode ? '#1e293b' : '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 8
                    }]
                },
                options: options
            });
        }

        function renderMonthlySavingsChart() {
            const ctx = DOMElements.monthlySavingsCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const savingsData = monthlyData.map(m => m.income - m.expenses);

            if (monthlySavingsChart) monthlySavingsChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Savings: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            monthlySavingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: savingsData,
                        backgroundColor: savingsData.map(s => s >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'),
                        borderColor: savingsData.map(s => s >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }
        
        function getMonthlyIncomeAndExpenses(numMonths) {
            const data = [];
            for (let i = 0; i < numMonths; i++) {
                const date = new Date(new Date().setMonth(new Date().getMonth() - i));
                const year = date.getFullYear();
                const month = date.getMonth();
                const recurring = getMonthlyRecurringTotals(year, month);
                data.push({
                    year: year,
                    month: month,
                    income: monthlyIncome + recurring.income,
                    expenses: getMonthlyExpenseTotal(year, month) + recurring.expenses
                });
            }
            return data.reverse();
        }

        function updateAiInsights() {
            const now = Date.now();
            if (aiSpendingCache && (now - lastAiUpdate < 10000)) {
                renderAiInsights(aiSpendingCache, DOMElements.spendingInsightsContainer);
                renderAiInsights(aiSavingsCache, DOMElements.aiSavingsInsightsContainer);
                return;
            }
            const { spendingInsights, savingsInsights } = generateAiInsights();
            aiSpendingCache = spendingInsights;
            aiSavingsCache = savingsInsights;
            lastAiUpdate = now;
            renderAiInsights(spendingInsights, DOMElements.spendingInsightsContainer);
            renderAiInsights(savingsInsights, DOMElements.aiSavingsInsightsContainer);
        }

        function generateAiInsights() {
            const spendingInsights = [];
            const savingsInsights = [];
            const monthlyData = getMonthlyIncomeAndExpenses(3);
            if (monthlyData.length < 1) {
                const msg = 'Not enough data for analysis yet. Add income and expenses.';
                return { spendingInsights: [msg], savingsInsights: [msg] };
            }
            const currentMonthData = monthlyData[monthlyData.length - 1];
            const previousMonthData = monthlyData.length > 1 ? monthlyData[monthlyData.length - 2] : null;

            if (currentMonthData.income > 0) {
                const savings = currentMonthData.income - currentMonthData.expenses;
                const savingsRate = (savings / currentMonthData.income) * 100;
                if (savings >= 0) {
                     savingsInsights.push(`This month, you saved <strong>${formatCurrency(savings)}</strong>, a <strong>${savingsRate.toFixed(0)}%</strong> savings rate. ${savingsRate >= 20 ? 'Great job!' : 'Good start!'}`);
                } else {
                     spendingInsights.push(`You overspent by <strong>${formatCurrency(Math.abs(savings))}</strong> this month. Review non-essential spending.`);
                }
            } else {
                savingsInsights.push('Set your monthly income to calculate savings rate.');
            }

            if (previousMonthData) {
                const expenseChange = currentMonthData.expenses - previousMonthData.expenses;
                if (expenseChange > 0) {
                    spendingInsights.push(`Spending is up by <strong>${formatCurrency(expenseChange)}</strong> from last month.`);
                } else if (expenseChange < 0) {
                    spendingInsights.push(`Spending is down by <strong>${formatCurrency(Math.abs(expenseChange))}</strong> from last month. Keep it up!`);
                }
            }

            const categorySpending = expenses.filter(e => new Date(e.date).getMonth() === currentMonthData.month && new Date(e.date).getFullYear() === currentMonthData.year && e.status === 'active')
                .reduce((acc, exp) => {
                    acc[exp.category] = (acc[exp.category] || 0) + exp.cost;
                    return acc;
                }, {});
            const topCategory = Object.entries(categorySpending).sort((a,b) => b[1] - a[1])[0];
            if(topCategory) {
                spendingInsights.push(`Your top spending category is <strong>${escapeHTML(topCategory[0])}</strong> at <strong>${formatCurrency(topCategory[1])}</strong>.`);
            }

            if (monthlyBudget > 0 && currentMonthData.expenses > monthlyBudget) {
                 spendingInsights.push(`<strong class="text-red-600 dark:text-red-400">Alert:</strong> You've exceeded your budget by <strong>${formatCurrency(currentMonthData.expenses - monthlyBudget)}</strong>.`);
            } else if (monthlyBudget > 0 && currentMonthData.expenses / monthlyBudget > 0.8) {
                 spendingInsights.push(`You've used over 80% of your budget. Monitor spending closely.`);
            }

            return { spendingInsights, savingsInsights };
        }

        function renderAiInsights(insights, container) {
            if (!container) return;
            container.innerHTML = '';
            if (!insights || insights.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Not enough data to generate insights yet.</p>';
                return;
            }
            insights.forEach(insightText => {
                const div = document.createElement('div');
                div.className = 'ai-insight';
                div.innerHTML = insightText;
                container.appendChild(div);
            });
        }
        
        // --- Utility Functions ---
        function formatCurrency(value, useDecimals = true) {
            const { locale } = currencyConfig[currentCurrencyCode];
            return new Intl.NumberFormat(locale, { style: 'currency', currency: currentCurrencyCode, minimumFractionDigits: useDecimals ? 2 : 0, maximumFractionDigits: useDecimals ? 2 : 0, }).format(value);
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function showToast(message, type = 'success') {
            DOMElements.toast.textContent = message;
            DOMElements.toast.className = `toast show ${type === 'error' ? 'bg-red-600' : 'bg-gray-800 dark:bg-gray-200 dark:text-gray-800'}`;
            setTimeout(() => { DOMElements.toast.className = 'toast'; }, 3000);
        }

        window.addEventListener('click', (e) => {
            const settingsContainer = DOMElements.settingsMenu.parentElement;
            if (settingsContainer && !DOMElements.settingsMenu.classList.contains('hidden') && !settingsContainer.contains(e.target)) {
                DOMElements.settingsMenu.classList.add('hidden');
            }
        });

        function generateExpensesFromRecurring() {
            const generatedExpenses = [];
            const today = new Date();
            // To avoid timezone issues, we compare date strings
            const todayStr = today.toISOString().split('T')[0];

            recurringItems.forEach(item => {
                if (item.type !== 'expense' || item.status !== 'active') {
                    return;
                }

                let currentDate = new Date(item.startDate + 'T00:00:00'); // Set time to avoid timezone shifts
                const endDate = item.endDate ? new Date(item.endDate + 'T00:00:00') : today;

                while (currentDate <= endDate && currentDate <= today) {
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;

                    generatedExpenses.push({
                        id: `recurring-${item.id}-${dateStr}`, // composite ID
                        name: `${item.name} (r)`,
                        cost: item.amount,
                        type: item.essentialType || 'Non-Essential', // Assign essential type
                        category: item.category,
                        date: dateStr,
                        paymentMethod: item.paymentMethod,
                        status: 'active',
                        isRecurring: true,
                        originalRecurringId: item.id
                    });
                    
                    // Increment currentDate based on frequency
                    switch (item.frequency) {
                        case 'Daily':
                            currentDate.setDate(currentDate.getDate() + 1);
                            break;
                        case 'Weekly':
                            currentDate.setDate(currentDate.getDate() + 7);
                            break;
                        case 'Bi-Weekly':
                            currentDate.setDate(currentDate.getDate() + 14);
                            break;
                        case 'Monthly':
                            currentDate.setMonth(currentDate.getMonth() + 1);
                            break;
                        case 'Quarterly':
                            currentDate.setMonth(currentDate.getMonth() + 3);
                            break;
                        case 'Annual':
                            currentDate.setFullYear(currentDate.getFullYear() + 1);
                            break;
                        default:
                            // Break the loop for unknown frequencies
                            currentDate = new Date('9999-12-31');
                            break;
                    }
                }
            });

            return generatedExpenses;
        }

        // --- Auto-Categorization ---
        function autoCategorizeExpense(event) {
            const name = event.target.value.toLowerCase();
            if (!name) return;

            let matchedCategory = 'Other';
            let matchedEssential = 'Non-Essential';

            // Find category based on keywords
            for (const category in categoryKeywords) {
                if (categoryKeywords[category].some(keyword => name.includes(keyword))) {
                    matchedCategory = category;
                    break;
                }
            }

            // Determine if essential based on keywords
            if (essentialKeywords.some(keyword => name.includes(keyword))) {
                matchedEssential = 'Essential';
            }

            // Update the form fields
            const formPrefix = event.target.id.startsWith('recurring') ? 'recurring-' : 'expense-';
            const categorySelect = document.getElementById(`${formPrefix}category`);
            const typeSelect = document.getElementById(`${formPrefix}type`) || document.getElementById(`${formPrefix}essential-type`);
            
            if (categorySelect) {
                categorySelect.value = matchedCategory;
            }
            if (typeSelect) {
                typeSelect.value = matchedEssential;
            }
        }

        // --- Settings Modal ---
        function openSettings(section) {
            const settingsModal = document.getElementById('settings-modal');
            
            // Populate inputs with current values
            document.getElementById('settings-budget-input').value = monthlyBudget > 0 ? monthlyBudget : '';
            document.getElementById('settings-income-input').value = monthlyIncome > 0 ? monthlyIncome : '';
            
            settingsModal.classList.remove('hidden');

            if (section === 'budget') {
                setTimeout(() => {
                    document.getElementById('settings-budget-input').focus();
                }, 100);
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const budgetValue = document.getElementById('settings-budget-input').value;
            const incomeValue = document.getElementById('settings-income-input').value;

            updateBudget(budgetValue);
            updateIncome(incomeValue);

            closeSettings();
            showToast('Settings saved successfully!');
        }

        function formatCurrency(amount) {
            const config = currencyConfig[currentCurrencyCode];
            const isInteger = amount % 1 === 0;
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
                maximumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
            };
            return new Intl.NumberFormat(config.locale, options).format(amount || 0);
        }
    </script>
</body>
</html>
