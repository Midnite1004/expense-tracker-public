<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc; /* Light gray background */
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b; /* Dark slate */
            --text-secondary: #64748b; /* Medium slate */
            --text-tertiary: #94a3b8; /* Light slate */
            --border-color: #e2e8f0;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --help-text-color: #374151;
            --health-score-good: var(--accent-green);
            --health-score-ok: var(--accent-yellow);
            --health-score-bad: var(--accent-red);
        }
        .dark {
            --bg-primary: #0f172a; /* Very dark blue */
            --bg-secondary: #1e293b; /* Dark blue */
            --bg-tertiary: #334155; /* Medium dark blue */
            --text-primary: #f1f5f9; /* Light gray */
            --text-secondary: #cbd5e1; /* Medium gray */
            --text-tertiary: #94a3b8; /* Darker gray */
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --help-text-color: #d1d5db;
        }
        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .stat-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
            text-align: center;
        }
        .dark .stat-card {
             background-color: var(--bg-tertiary);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .stat-card-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        .stat-card-value {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* bold */
            color: var(--text-primary);
            line-height: 1.2;
        }
        .stat-card-value.text-green-600 { color: var(--accent-green); }
        .stat-card-value.text-red-600 { color: var(--accent-red); }
        .dark .stat-card-value.text-green-600 { color: #34d399; } /* Lighter green */
        .dark .stat-card-value.text-red-600 { color: #f87171; } /* Lighter red */
        
        /* Info Icon Styling */
        .info-icon {
            cursor: help;
            display: inline-flex;
            vertical-align: middle;
            color: var(--text-tertiary);
            transition: color 0.2s;
        }
        .info-icon:hover {
            color: var(--accent-blue);
        }
        /* Tooltip styling */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: normal;
            z-index: 50;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            max-width: 300px;
            width: max-content;
        }

        .tab-button {
            position: relative;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab-button:hover {
            color: var(--text-primary);
        }
        .tab-button.active {
            color: var(--accent-blue);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-blue);
            border-radius: 1px;
        }
        .modern-input, .modern-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
            appearance: none;
        }
        .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem;
        }
        .dark .modern-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .modern-input:focus, .modern-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .modern-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .modern-button-primary {
            background-color: var(--accent-blue);
            color: white;
        }
        .modern-button-primary:hover {
            background-color: #2563eb;
            box-shadow: var(--shadow-md);
        }
         .modern-button-primary:active {
            transform: translateY(1px);
        }
        .modern-button-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .modern-button-secondary:hover {
            background-color: var(--border-color);
        }
        .modern-button-danger {
            background-color: var(--accent-red);
            color: white;
        }
        .modern-button-danger:hover {
             background-color: #dc2626;
             box-shadow: var(--shadow-md);
        }
        .icon-button {
            padding: 0.5rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        .icon-button:hover {
            color: var(--text-primary);
        }
        .icon-button svg {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        .dropdown-menu {
            position: absolute;
            margin-top: 0.5rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 50;
            min-width: 220px; /* Wider for import/export */
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: background-color 0.2s ease, color 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .dropdown-item:hover {
            background-color: var(--bg-secondary);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        .dark .status-active {
             background-color: rgba(16, 185, 129, 0.2);
             color: #10b981;
        }
        .status-cancelled {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            text-decoration: line-through;
        }
         .dark .status-cancelled {
             background-color: rgba(239, 68, 68, 0.2);
             color: #ef4444;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #2d3748;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 100;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            position: relative; 
            height: 350px;
            width: 100%;
        }
        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-blue);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        /* Help Tab Contrast */
        #help-tab p, #help-tab li {
            color: var(--help-text-color);
            transition: color 0.3s;
        }
        #help-tab h3 {
             color: var(--text-primary);
             transition: color 0.3s;
        }
        #help-tab strong {
            color: var(--text-primary);
            transition: color 0.3s;
        }
        #help-tab ul {
            margin-left: 1rem;
        }
        /* Table Checkbox */
        .table-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        /* Budget Health Score */
        .health-score-container {
            position: relative;
            width: 150px;
            height: 75px; /* Half circle */
            overflow: hidden;
            margin: 1rem auto 0;
        }
        .health-score-gauge {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--bg-tertiary);
            border-bottom-color: transparent;
            border-left-color: transparent;
            transform: rotate(-135deg); /* Start from bottom-left */
            box-sizing: border-box;
        }
        .health-score-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 15px solid var(--health-score-good); /* Default color */
            border-top-color: transparent;
            border-right-color: transparent;
            transform: rotate(45deg); /* Start from bottom-left, fill clockwise */
            transform-origin: center center;
            clip-path: polygon(50% 0%, 100% 0%, 100% 50%, 50% 50%); /* Clip to top-right quadrant initially */
            transition: transform 1s ease-out, border-color 0.5s ease;
            box-sizing: border-box;
        }
        .health-score-text {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            color: var(--text-primary);
        }
        .health-score-label {
            font-size: 0.875rem; /* text-sm */
            color: var(--text-secondary);
            margin-top: -5px;
        }
        /* AI Insights Styling */
        .ai-insight {
            background-color: rgba(59, 130, 246, 0.05); /* Light blue bg */
            border-left: 4px solid var(--accent-blue);
            padding: 1rem;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        .dark .ai-insight {
            background-color: rgba(59, 130, 246, 0.1);
            border-left-color: var(--accent-blue);
            color: var(--text-secondary);
        }
        .ai-insight strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        /* Consistent Dark Mode */
        html.dark body { background-color: var(--bg-secondary); color: var(--text-primary); }
        html.dark .card { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .stat-card { background-color: var(--bg-tertiary); border-color: var(--border-color); }
        html.dark .modern-input, html.dark .modern-select { background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary); }
        html.dark .modern-button-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        html.dark .modern-button-secondary:hover { background-color: var(--border-color); }
        html.dark .tab-button { color: var(--text-secondary); }
        html.dark .tab-button:hover { color: var(--text-primary); }
        html.dark .tab-button.active { color: var(--accent-blue); }
        html.dark .icon-button { color: var(--text-secondary); }
        html.dark .icon-button:hover { color: var(--text-primary); }
        html.dark .dropdown-menu { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark .dropdown-item { color: var(--text-primary); }
        html.dark .dropdown-item:hover { background-color: var(--bg-secondary); }
        html.dark table thead { background-color: var(--bg-tertiary); color: var(--text-secondary); }
        html.dark table tbody tr { background-color: var(--bg-primary); border-color: var(--border-color); }
        html.dark table tbody tr:hover { background-color: var(--bg-secondary); }
        html.dark table tbody td { color: var(--text-secondary); }
        html.dark table tbody td:first-child { color: var(--text-primary); }
        html.dark #help-tab p, html.dark #help-tab li { color: var(--help-text-color); }
        html.dark #help-tab h3, html.dark #help-tab strong { color: var(--text-primary); }
        html.dark .health-score-gauge { border-color: var(--bg-tertiary); border-bottom-color: transparent; border-left-color: transparent; }
        html.dark .health-score-text { color: var(--text-primary); }
        html.dark .health-score-label { color: var(--text-secondary); }

        /* Driver.js Customization */
        .driver-popover {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .driver-popover-title {
            color: var(--text-primary);
        }
        .driver-popover-description {
            color: var(--text-secondary);
        }
        .driver-popover-progress-text {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn {
            color: var(--text-secondary);
        }
        .driver-popover-close-btn:hover {
            color: var(--text-primary);
        }
        .driver-popover-arrow-side-left.driver-popover-arrow {
            border-left-color: var(--border-color);
        }
        .driver-popover-arrow-side-right.driver-popover-arrow {
            border-right-color: var(--border-color);
        }
        .driver-popover-arrow-side-top.driver-popover-arrow {
            border-top-color: var(--border-color);
        }
        .driver-popover-arrow-side-bottom.driver-popover-arrow {
            border-bottom-color: var(--border-color);
        }

        /* Settings Modal Text Color Fix */
        #settings-modal .card h4,
        #settings-modal .card label {
            color: var(--text-primary);
        }

        /* New Tooltip CSS */
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 320px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            text-align: left;
            border-radius: 8px;
            padding: 16px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -160px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .dark .tooltip .tooltiptext {
            background-color: var(--bg-tertiary);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Arrow pointing down */
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--bg-primary) transparent transparent transparent;
        }

        .dark .tooltip .tooltiptext::after {
            border-color: var(--bg-tertiary) transparent transparent transparent;
        }

        /* AI Insights v2 Styling */
        .ai-section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* 12px */
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* bold */
            margin-bottom: 1rem; /* 16px */
        }
        .prediction-card {
            background-color: var(--bg-tertiary);
            padding: 1rem; /* 16px */
            border-radius: 0.75rem; /* 12px */
            border: 1px solid var(--border-color);
        }
        .confidence-meter {
            background-color: var(--border-color);
            border-radius: 9999px;
            height: 0.5rem; /* 8px */
            overflow: hidden;
        }
        .confidence-fill {
            background-color: var(--accent-blue);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .action-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .action-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .metric-card {
            background-color: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .ai-loading {
            width: 24px;
            height: 24px;
            border: 3px solid var(--accent-blue);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen p-4 md:p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="card mb-6">
                <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üí°</span>
                            <h1 class="text-2xl md:text-3xl font-bold">Expense Tracker</h1>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- Settings Button and Menu -->
                            <div class="relative inline-block text-left">
                                <button onclick="openSettings()" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                                    <span class="hidden sm:inline">Settings</span>
                                </button>
                                        </div>
                                        </div>
                    </div>
                </div>
                <!-- Navigation Tabs -->
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-4 sm:space-x-8 px-4 md:px-6" aria-label="Tabs">
                        <button onclick="showTab('overview')" id="tab-overview" class="tab-button active">Overview</button>
                        <button onclick="showTab('expenses')" id="tab-expenses" class="tab-button">Expenses</button>
                        <button onclick="showTab('recurring')" id="tab-recurring" class="tab-button">Recurring</button>
                        <button onclick="showTab('insights')" id="tab-insights" class="tab-button">Insights</button>
                    </nav>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="mt-6">
                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Key Stats & Budget Health -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Key Stats Row -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="stat-card bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800">
                                    <div class="stat-card-title">Monthly Budget</div>
                                    <div class="stat-card-value text-blue-600 dark:text-blue-400" id="monthly-budget">¬£0.00</div>
                                </div>
                                <div class="stat-card bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800">
                                    <div class="stat-card-title">Spent (Month)</div>
                                    <div class="stat-card-value text-red-600" id="total-expenses">¬£0.00</div>
                                </div>
                                <div class="stat-card bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800">
                                    <div class="stat-card-title">Remaining</div>
                                    <div class="stat-card-value text-green-600" id="remaining-amount">¬£0.00</div>
                                </div>
                                 <div class="stat-card bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-800">
                                    <div class="stat-card-title">
                                        Income (Month)
                                        <span class="info-icon ml-1" data-tooltip="Total monthly income = Base monthly income + Recurring income items">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="stat-card-value text-purple-600 dark:text-purple-400" id="total-income">¬£0.00</div>
                                </div>
                            </div>
                
                            <!-- ADDED SHORTCUT -->
                            <div class="text-center -mt-4">
                                <button class="text-sm text-blue-600 dark:text-blue-400 opacity-70 hover:opacity-100 hover:underline" onclick="openSettings('budget')">
                                    Edit budget & income
                                </button>
                            </div>
                
                            <!-- Budget Health & Progress -->
                            <div class="card p-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                                    <div class="md:col-span-2">
                                        <h3 class="text-lg font-semibold mb-1">Budget Progress</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">How you're tracking against your monthly budget.</p>
                                        <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 mb-2">
                                            <div id="budget-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <p id="budget-percentage" class="text-sm text-gray-600 dark:text-gray-400">0% Used</p>
                                        </div>
                                        <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm" id="ai-projection-container">
                                            <!-- AI Projection content will be inserted here -->
                                        </div>
                                    </div>
                                    <div class="text-center" id="budget-health-section">
                                        <div class="flex items-center justify-center gap-2 mb-2">
                                            <h3 class="text-lg font-semibold">Budget Health</h3>
                                            <div class="tooltip">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-help hover:text-gray-600 dark:hover:text-gray-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div id="health-score-tooltip" class="tooltiptext">
                                                    <!-- Dynamic content goes here -->
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div id="health-score-visual" class="relative w-32 h-32 mx-auto mb-2">
                                            <!-- Circular progress indicator will be rendered here by JS -->
                                        </div>
                                        
                                        <div id="health-score-trend" class="text-xs mt-1">
                                            <!-- Trend indicator will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Essential vs Non-Essential -->
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Spending Breakdown (Month)</h3>
                                <div class="flex justify-around items-center text-center mb-4">
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Essential</p>
                                        <p class="text-2xl font-semibold text-sky-600 dark:text-sky-400" id="essential-spending">¬£0.00</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Non-Essential</p>
                                        <p class="text-2xl font-semibold text-indigo-600 dark:text-indigo-400" id="non-essential-spending">¬£0.00</p>
                                    </div>
                                </div>
                                <div class="w-full rounded-full h-3">
                                    <div id="essential-bar" class="bg-sky-500 h-3 rounded-l-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div><!--
                                 --><div id="non-essential-bar" class="bg-indigo-500 h-3 rounded-r-full inline-block transition-all duration-500 ease-out" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                
                        <!-- Right Column: Actions & Recent Activity -->
                        <div class="space-y-6">
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                                <div class="space-y-3">
                                    <button onclick="showAddForm()" class="modern-button modern-button-primary w-full">
                                        <span>‚ûï</span> Add New Expense
                                    </button>
                                    <button onclick="showRecurringForm()" class="modern-button modern-button-secondary w-full">
                                        <span>üîÅ</span> Add Recurring Item
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Quick Add Common Expenses</h3>
                                <div class="flex flex-col gap-2 w-full">
                                    <div id="quick-add-coffee">
                                        <button class="bg-gray-700 dark:bg-gray-800 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">‚òï</span>
                                                <span class="text-white">Coffee</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-transport">
                                        <button class="bg-gray-700 dark:bg-gray-800 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">üöå</span>
                                                <span class="text-white">Transport</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-lunch">
                                        <button class="bg-gray-700 dark:bg-gray-800 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">ü•™</span>
                                                <span class="text-white">Lunch</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                    <div id="quick-add-groceries">
                                        <button class="bg-gray-700 dark:bg-gray-800 rounded-lg flex justify-between items-center w-full px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <span class="mr-2">üõí</span>
                                                <span class="text-white">Groceries</span>
                                            </div>
                                            <span class="text-white font-medium flex-shrink-0 overflow-hidden"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                
                            <div class="card p-6">
                                <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                                <div id="recent-expenses" class="space-y-3">
                                    <p class="text-gray-500 dark:text-gray-400">No recent expenses.</p>
                                </div>
                                <div class="text-center mt-4">
                                    <button onclick="showTab('expenses')" class="text-blue-600 dark:text-blue-400 font-medium hover:underline">
                                        See all
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expenses Tab -->
                <div id="expenses-tab" class="tab-content hidden fade-in">
                    <div class="card">
                        <div class="p-4 md:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-4">
                            <h2 class="text-xl font-semibold">All Expenses</h2>
                            <div class="flex gap-3">
                                <button onclick="toggleFilterPanel('expense-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                    </svg>
                                    Filters
                                </button>
                                <button id="delete-selected-btn" onclick="deleteSelectedExpenses()" class="modern-button modern-button-danger hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showAddForm()" class="modern-button modern-button-primary">
                                     <span>‚ûï</span> Add Expense
                                 </button>
                             </div>
                        </div>
                        
                        <!-- Filter Panel -->
                        <div id="expense-filter-panel" class="p-4 border-b border-gray-200 dark:border-gray-700 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <!-- Date Range -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Date Range</label>
                                    <div class="flex gap-2">
                                        <input type="date" id="expense-filter-date-from" class="modern-input">
                                        <input type="date" id="expense-filter-date-to" class="modern-input">
                                    </div>
                                </div>
                                <!-- Category -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Category</label>
                                    <select id="expense-filter-category" class="modern-select">
                                        <option value="">All Categories</option>
                                        <!-- Populated dynamically -->
                                    </select>
                                </div>
                                <!-- Type -->
                                <div>
                                    <label class="text-sm font-medium mb-1 block">Type</label>
                                    <select id="expense-filter-type" class="modern-select">
                                        <option value="">All Types</option>
                                        <option value="Essential">Essential</option>
                                        <option value="Non-Essential">Non-Essential</option>
                                        <option value="Recurring">Recurring</option>
                                    </select>
                            </div>
                            <!-- Clear Filters -->
                                <div class="md:col-span-3 flex justify-end gap-2">
                                <button onclick="applyExpenseFilters()" class="modern-button modern-button-primary">Apply Filters</button>
                                <button onclick="clearExpenseFilters()" class="modern-button modern-button-secondary">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-expenses" onchange="toggleSelectAllExpenses(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Date</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Payment Method</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Type</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table">
                                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                        <td colspan="9" class="px-6 py-4 text-center">No expenses recorded yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                 <!-- Recurring Tab -->
                <div id="recurring-tab" class="tab-content hidden fade-in">
                    <div class="card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 gap-4">
                            <div>
                                <h2 class="text-xl font-bold">Recurring Items</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Regular income and expenses like salaries or subscriptions.</p>
                            </div>
                            <div class="flex-shrink-0 flex items-center space-x-2">
                                <button onclick="toggleFilterPanel('recurring-filter-panel')" class="modern-button modern-button-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg>
                                    Filter
                                </button>
                                <button id="delete-selected-recurring-btn" onclick="deleteSelectedRecurring()" class="modern-button modern-button-danger hidden">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span>Delete Selected</span>
                                </button>
                                <button onclick="showRecurringForm()" class="modern-button modern-button-primary">
                                    <span>üîÅ</span> Add Recurring
                                </button>
                            </div>
                        </div>
                
                        <div id="recurring-filter-panel" class="hidden p-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label for="recurring-filter-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                                    <select id="recurring-filter-type" class="modern-select mt-1">
                                        <option value="">All Types</option>
                                        <option value="income">Income</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                                    <select id="recurring-filter-category" class="modern-select mt-1">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurring-filter-frequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                                    <select id="recurring-filter-frequency" class="modern-select mt-1">
                                        <option value="">All Frequencies</option>
                                        <option value="Daily">Daily</option>
                                        <option value="Weekly">Weekly</option>
                                        <option value="Bi-Weekly">Bi-Weekly</option>
                                        <option value="Monthly">Monthly</option>
                                        <option value="Quarterly">Quarterly</option>
                                        <option value="Annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 mt-4">
                                <button onclick="applyRecurringFilters()" class="modern-button modern-button-primary">Apply</button>
                                <button onclick="clearRecurringFilters()" class="modern-button modern-button-secondary">Clear</button>
                            </div>
                        </div>
                
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 w-1">
                                            <input type="checkbox" id="select-all-recurring" onchange="toggleSelectAllRecurring(this.checked)" class="table-checkbox">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3">Type</th>
                                        <th scope="col" class="px-6 py-3">Amount</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Frequency</th>
                                        <th scope="col" class="px-6 py-3 hidden md:table-cell">Start Date</th>
                                        <th scope="col" class="px-6 py-3 hidden lg:table-cell">Category</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recurring-table">
                                    <!-- Rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Insights Tab -->
                <div id="insights-tab" class="tab-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column: Forecast & Projection -->
                        <div class="space-y-6">
                            <div class="card p-6">
                                <h2 class="ai-section-title">
                                    <span class="text-xl">üìÖ</span>
                                    <span>7-Day Forecast</span>
                                </h2>
                                <div id="seven-day-forecast" class="space-y-4">
                                    <!-- JS-rendered content -->
                                </div>
                            </div>
                            <div class="card p-6">
                                <h2 class="ai-section-title">
                                    <span class="text-xl">üéØ</span>
                                    <span>Month-End Projection</span>
                                </h2>
                                <div id="month-end-projection">
                                    <!-- JS-rendered content -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Recommendations & Story -->
                        <div class="space-y-6">
                            <div class="card p-6">
                                <h2 class="ai-section-title">
                                    <span class="text-xl">üí°</span>
                                    <span>Smart Recommendations</span>
                                    <span id="action-count" class="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
                                </h2>
                                <div id="smart-recommendations" class="space-y-3">
                                    <!-- JS-rendered content -->
                                </div>
                            </div>
                             <div class="card p-6">
                                <h2 class="ai-section-title">
                                    <span class="text-xl">üìñ</span>
                                    <span>Your Monthly Story</span>
                                </h2>
                                <div id="monthly-story">
                                    <!-- JS-rendered content -->
                                </div>
                                <div id="story-metrics" class="hidden grid-cols-3 gap-2 mt-4 text-center">
                                    <!-- JS-rendered content -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Charts -->
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mt-6">
                        <div class="card p-4 md:p-6">
                             <h2 class="text-xl font-bold mb-4">Spending Trend</h2>
                             <div class="chart-container h-64 md:h-80">
                                <canvas id="spending-trend-chart"></canvas>
                            </div>
                        </div>
                        <div class="card p-4 md:p-6">
                            <h2 class="text-xl font-semibold mb-4">Monthly Savings Trend</h2>
                            <div class="chart-container" style="height: 320px;">
                                <canvas id="monthly-savings-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" onclick="closeSettings()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Settings</h3>
                <button onclick="closeSettings()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Budget & Income Section -->
                <div id="settings-budget-section" class="space-y-3 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                    <h4 class="text-md font-semibold">Budget & Income</h4>
                    <div>
                        <label class="block text-xs font-medium">Monthly Budget</label>
                        <input type="number" id="settings-budget-input" placeholder="e.g., 2000" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-xs font-medium">Monthly Income</label>
                        <input type="number" id="settings-income-input" placeholder="e.g., 3500" class="modern-input mt-1">
                    </div>
                </div>
            
                <!-- General Settings -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="theme-toggle" class="text-sm font-medium">Dark Mode</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle" onchange="toggleTheme(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/30">
                        <label for="currency-select" class="text-sm font-medium">Currency</label>
                        <select id="currency-select" onchange="changeCurrency(this.value)" class="modern-select text-sm w-40">
                            <option value="GBP">GBP (¬£)</option>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="JPY">JPY (¬•)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="space-y-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="exportData()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>Export Data (JSON)</span>
                    </button>
                    <label class="modern-button modern-button-secondary w-full justify-start cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        <span>Import Data (JSON)</span>
                        <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                    </label>
                     <button onclick="openHelpModal()" class="modern-button modern-button-secondary w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Help & Documentation</span>
                    </button>
                </div>
            </div>

            <div class="flex gap-3 mt-6 border-t border-gray-200 dark:border-gray-700 pt-3">
                <button onclick="saveSettings()" class="modern-button modern-button-primary flex-1">Save & Close</button>
                <button onclick="closeSettings()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- First-Time Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="card max-w-md w-full p-6">
            <h3 class="text-xl font-semibold mb-2">Welcome! Let's get you set up.</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Provide some initial details to personalize your tracker. You can change these anytime in the settings.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Your Monthly Budget</label>
                    <input type="number" id="setup-budget-input" placeholder="e.g., 2000" class="modern-input mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Your Monthly Income (Optional)</label>
                    <input type="number" id="setup-income-input" placeholder="e.g., 3500" class="modern-input mt-1">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveSetupAndStartTour()" class="modern-button modern-button-primary flex-1">Save and Continue</button>
                <button onclick="skipSetupAndStartTour()" class="modern-button modern-button-secondary flex-1">Skip for Now</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Expense Modal -->
    <div id="modal" onclick="closeModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-6" id="modal-title">Add New Expense</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="expense-name" placeholder="e.g., Coffee, Rent" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="modal-currency">¬£</span>)</label>
                        <input type="number" step="0.01" id="expense-cost" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" id="expense-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="expense-category" class="modern-select mt-1">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                        <select id="expense-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="expense-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveExpense()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Recurring Item Modal -->
    <div id="recurring-modal" onclick="closeRecurringModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-md w-full max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-xl font-semibold mb-4" id="recurring-modal-title">Add Recurring Item</h3>
            <div class="space-y-4">
                 <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                    <select id="recurring-item-type" class="modern-select mt-1" onchange="toggleRecurringFields(this.value)">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                    <input type="text" id="recurring-name" placeholder="e.g., Salary, Netflix" class="modern-input mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (<span id="recurring-modal-currency">¬£</span>)</label>
                        <input type="number" step="0.01" id="recurring-amount" placeholder="0.00" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Frequency</label>
                        <select id="recurring-frequency" class="modern-select mt-1">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Bi-Weekly">Bi-Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Annual">Annual</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="recurring-category" class="modern-select mt-1">
                            <!-- Options loaded dynamically -->
                        </select>
                    </div>
                    <div id="recurring-essential-type-wrapper">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Expense Type</label>
                        <select id="recurring-essential-type" class="modern-select mt-1">
                            <option value="Essential">Essential</option>
                            <option value="Non-Essential">Non-Essential</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                        <input type="date" id="recurring-start-date" class="modern-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date (Optional)</label>
                        <input type="date" id="recurring-end-date" class="modern-input mt-1">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment Method</label>
                        <select id="recurring-payment-method" class="modern-select mt-1">
                            <option value="">Not Specified</option>
                            <option value="Credit/Debit Card">Credit/Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Direct Debit">Direct Debit</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveRecurring()" class="modern-button modern-button-primary flex-1">Save</button>
                <button onclick="closeRecurringModal()" class="modern-button modern-button-secondary flex-1">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" onclick="closeHelpModal()" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div onclick="event.stopPropagation()" class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold">Help & Documentation</h3>
                <button onclick="closeHelpModal()" class="icon-button text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 md:p-8">
                <div class="space-y-8 text-sm leading-relaxed">
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">üöÄ Getting Started</h3>
                        <p>Welcome to your AI-powered Expense Tracker! The first time you use the app, an onboarding tour will guide you through the key features. You can start by visiting the <button onclick="openSettings('budget')" class="text-blue-600 hover:underline">Settings</button> to set your monthly budget and income.</p>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">The Dashboard Tabs</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-md mb-2">üéØ Overview</h4>
                                <p class="mb-2">This is your main financial dashboard, giving you a live snapshot of your finances for the current month.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Key Stats:</strong> See your total monthly budget, how much you've spent, what's remaining, and your total income.</li>
                                    <li><strong>Budget Progress & AI Projection:</strong> A visual bar shows how much of your budget is used. The AI projection forecasts your total spending by month-end.</li>
                                    <li><strong>Budget Health Score:</strong> A score from 0-100 that measures how well you're managing your finances. Hover over it for a detailed breakdown of what's affecting your score.</li>
                                    <li><strong>Spending Breakdown:</strong> See a clear split between your Essential and Non-Essential spending.</li>
                                    <li><strong>Quick Actions:</strong> Add new expenses or recurring items with a single click.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-md mb-2">üí∏ Expenses</h4>
                                <p class="mb-2">Log, view, and manage all your individual, one-off expenses.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Add, Edit, Delete:</strong> Use the action buttons to manage each expense. When adding, the app will try to auto-categorize it based on the name.</li>
                                    <li><strong>Filtering:</strong> Use the "Filters" button to narrow down your view by date range, category, or type (including auto-generated recurring expenses).</li>
                                    <li><strong>Bulk Actions:</strong> Use the checkboxes to select multiple expenses and delete them at once.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-md mb-2">üîÑ Recurring</h4>
                                <p class="mb-2">Manage transactions that happen on a regular schedule, like salaries, rent, or subscriptions.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>Income or Expense:</strong> Recurring items can be set as either income (e.g., salary) or an expense (e.g., Netflix).</li>
                                    <li><strong>Automatic Logging:</strong> The app automatically creates an expense record on the due date for each active recurring item. These are marked with "(R)" in the expenses list.</li>
                                    <li><strong>Pause & Resume:</strong> You can pause a recurring item by setting its status to "cancelled," and resume it by setting it back to "active."</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-md mb-2">üìä Insights</h4>
                                <p class="mb-2">This tab uses AI to analyze your spending and provide deeper insights into your financial habits.</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    <li><strong>7-Day Forecast:</strong> Shows you any recurring expenses that are due in the next week.</li>
                                    <li><strong>Month-End Projection:</strong> Forecasts your total spending and savings by the end of the current month.</li>
                                    <li><strong>Smart Recommendations:</strong> Provides actionable tips based on your spending patterns, like reviewing subscriptions or high non-essential spending.</li>
                                    <li><strong>Your Monthly Story:</strong> A narrative summary of your financial activity for the month, highlighting key metrics.</li>
                                    <li><strong>Charts:</strong> Visualize your month-over-month spending and savings trends.</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-lg font-semibold mb-3 border-b pb-2">‚öôÔ∏è Settings & Data</h3>
                         <ul class="list-disc ml-5 space-y-2">
                            <li><strong>Currency & Theme:</strong> Change your display currency and switch between light and dark modes.</li>
                            <li><strong>Data Management:</strong> Use the "Export Data" button to save a JSON backup of all your information. You can restore from a backup using the "Import Data" button.</li>
                            <li><strong>Privacy:</strong> All your data is stored <strong>only in your browser's local storage</strong>. It is never sent to a server. This means your information is completely private, but it also means clearing your browser data will erase your expense records. Please export your data regularly as a backup.</li>
                        </ul>
                    </section>
                </div>
            </div>
            <div class="flex gap-3 mt-auto p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                <button onclick="closeHelpModal()" class="modern-button modern-button-primary w-full">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <script>
        // --- State Variables ---
        let expenses = [];
        let recurringItems = [];
        let selectedExpenseIds = new Set();
        let selectedRecurringIds = new Set();
        let editingExpense = null;
        let editingRecurring = null;
        let monthlyBudget = 2000.00;
        let monthlyIncome = 0;
        let healthScoreHistory = {};
        let currencyConfig = {
            'GBP': { symbol: '¬£', locale: 'en-GB' },
            'EUR': { symbol: '‚Ç¨', locale: 'de-DE' },
            'JPY': { symbol: '¬•', locale: 'ja-JP' },
            'USD': { symbol: '$', locale: 'en-US' }
        };
        let currentCurrencyCode = 'GBP';
        let activeTab = 'overview';
        let spendingTrendChart = null;
        let categorySpendingChart = null;
        let monthlySavingsChart = null;
        let aiSavingsCache = null;
        let aiSpendingCache = null;
        let lastAiUpdate = 0;

        const expenseCategories = ["Housing", "Utilities", "Transport", "Food/Drink", "Entertainment", "Shopping", "Health", "Personal Care", "Education", "Debt", "Subscriptions", "Other"];
        const incomeCategories = ["Salary", "Bonus", "Investment", "Gift", "Other Income"];

        // Keyword mapping for auto-categorization and essential status
        const categoryKeywords = {
            'Housing': ['rent', 'mortgage', 'property tax', 'home insurance'],
            'Utilities': ['gas', 'electricity', 'water', 'internet', 'phone', 'council tax'],
            'Transport': ['fuel', 'petrol', 'diesel', 'train', 'bus', 'tube', 'taxi', 'uber'],
            'Food/Drink': ['coffee', 'lunch', 'groceries', 'supermarket', 'restaurant', 'takeaway'],
            'Entertainment': ['cinema', 'concert', 'theatre', 'streaming', 'netflix', 'spotify', 'disney+'],
            'Shopping': ['clothes', 'electronics', 'gifts', 'amazon'],
            'Health': ['pharmacy', 'doctor', 'dentist', 'gym'],
            'Personal Care': ['haircut', 'toiletries'],
            'Education': ['books', 'course', 'tuition'],
            'Debt': ['loan', 'credit card'],
            'Subscriptions': ['subscription']
        };

        const essentialKeywords = [
            'rent', 'mortgage', 'property tax', 'home insurance', 'gas', 'electricity', 
            'water', 'internet', 'phone', 'council tax', 'fuel', 'petrol', 'diesel', 'train', 
            'bus', 'tube', 'groceries', 'supermarket', 'pharmacy', 'doctor', 'dentist', 
            'loan', 'credit card', 'tuition'
        ];

        // --- DOM Elements Cache ---
        const DOMElements = {
            html: document.documentElement,
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            expenseName: document.getElementById('expense-name'),
            expenseCost: document.getElementById('expense-cost'),
            expenseType: document.getElementById('expense-type'),
            expenseCategory: document.getElementById('expense-category'),
            expenseDate: document.getElementById('expense-date'),
            expensePaymentMethod: document.getElementById('expense-payment-method'),
            modalCurrency: document.getElementById('modal-currency'),

            recurringModal: document.getElementById('recurring-modal'),
            recurringModalTitle: document.getElementById('recurring-modal-title'),
            recurringItemType: document.getElementById('recurring-item-type'),
            recurringName: document.getElementById('recurring-name'),
            recurringAmount: document.getElementById('recurring-amount'),
            recurringFrequency: document.getElementById('recurring-frequency'),
            recurringCategory: document.getElementById('recurring-category'),
            recurringEssentialTypeWrapper: document.getElementById('recurring-essential-type-wrapper'),
            recurringEssentialType: document.getElementById('recurring-essential-type'),
            recurringPaymentMethod: document.getElementById('recurring-payment-method'),
            recurringStartDate: document.getElementById('recurring-start-date'),
            recurringEndDate: document.getElementById('recurring-end-date'),
            recurringModalCurrency: document.getElementById('recurring-modal-currency'),

            monthlyBudgetDisplay: document.getElementById('monthly-budget'),
            budgetInput: document.getElementById('budget-input'),
            incomeInput: document.getElementById('income-input'),
            totalExpensesDisplay: document.getElementById('total-expenses'),
            remainingAmountDisplay: document.getElementById('remaining-amount'),
            totalIncomeDisplay: document.getElementById('total-income'),
            budgetBar: document.getElementById('budget-bar'),
            budgetPercentage: document.getElementById('budget-percentage'),
            healthScoreFill: document.getElementById('health-score-fill'),
            healthScoreValue: document.getElementById('health-score-value'),
            healthScoreLabel: document.getElementById('health-score-label'),
            essentialSpendingDisplay: document.getElementById('essential-spending'),
            nonEssentialSpendingDisplay: document.getElementById('non-essential-spending'),
            essentialBar: document.getElementById('essential-bar'),
            nonEssentialBar: document.getElementById('non-essential-bar'),
            recentExpensesContainer: document.getElementById('recent-expenses'),
            expensesTableBody: document.getElementById('expenses-table'),
            recurringTableBody: document.getElementById('recurring-table'),
            settingsMenu: document.getElementById('settings-menu'),
            themeToggle: document.getElementById('theme-toggle'),
            currencySelect: document.getElementById('currency-select'),
            toast: document.getElementById('toast'),
            
            spendingTrendCanvas: document.getElementById('spending-trend-chart'),
            categorySpendingCanvas: document.getElementById('category-spending-chart'),
            monthlySavingsCanvas: document.getElementById('monthly-savings-chart'),
            spendingInsightsContainer: document.getElementById('spending-insights'),
            aiSavingsInsightsContainer: document.getElementById('ai-savings-insights'),

            selectAllExpensesCheckbox: document.getElementById('select-all-expenses'),
            deleteSelectedBtn: document.getElementById('delete-selected-btn'),
            selectAllRecurringCheckbox: document.getElementById('select-all-recurring'),
            deleteSelectedRecurringBtn: document.getElementById('delete-selected-recurring-btn'),
            
            // New Health Score Elements
            healthScoreVisual: document.getElementById('health-score-visual'),
            healthScoreTrend: document.getElementById('health-score-trend'),
            healthScoreTooltip: document.getElementById('health-score-tooltip'),
            aiProjectionContainer: document.getElementById('ai-projection-container'),
        };
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            processRecurringExpenses(); // New function call
            populateCategoryDropdowns();
            applyTheme();
            updateCurrencyUI();
            updateDisplay();
            showTab(activeTab);
            DOMElements.expenseDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];

            // Add event listener for auto-categorization
            DOMElements.expenseName.addEventListener('input', autoCategorizeExpense);
            DOMElements.recurringName.addEventListener('input', autoCategorizeExpense);
            
            startOnboardingProcess();
        });

        // --- Recurring Expense Processing ---
        function getTodaysDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function processRecurringExpenses() {
            const lastCheck = localStorage.getItem('lastRecurringCheck');
            const todayStr = getTodaysDateString();

            if (lastCheck === todayStr) {
                console.log("Recurring expenses already processed today.");
                return;
            }

            const startDate = lastCheck ? new Date(lastCheck) : new Date(todayStr);
            const endDate = new Date(todayStr);
            
            let newExpensesGenerated = false;
            
            // Iterate from the day after the last check up to today
            for (let d = new Date(startDate.getTime() + 86400000); d <= endDate; d.setDate(d.getDate() + 1)) {
                const currentDateStr = d.toISOString().split('T')[0];
                
                recurringItems.forEach(item => {
                    if (item.status !== 'active') return;

                    const itemStartDate = new Date(item.startDate);
                    const itemEndDate = item.endDate ? new Date(item.endDate) : null;

                    if (d < itemStartDate || (itemEndDate && d > itemEndDate)) {
                        return; // Skip if outside the item's active range
                    }
                    
                    let shouldAdd = false;
                    switch (item.frequency) {
                        case 'Daily':
                            shouldAdd = true;
                            break;
                        case 'Weekly':
                            if (d.getDay() === itemStartDate.getDay()) shouldAdd = true;
                            break;
                        case 'Bi-Weekly':
                            const weeksSinceStart = Math.floor((d - itemStartDate) / (1000 * 60 * 60 * 24 * 7));
                            if (d.getDay() === itemStartDate.getDay() && weeksSinceStart % 2 === 0) shouldAdd = true;
                            break;
                        case 'Monthly':
                            if (d.getDate() === itemStartDate.getDate()) shouldAdd = true;
                            break;
                        case 'Quarterly':
                            const monthDiff = (d.getFullYear() - itemStartDate.getFullYear()) * 12 + d.getMonth() - itemStartDate.getMonth();
                            if (d.getDate() === itemStartDate.getDate() && monthDiff > 0 && monthDiff % 3 === 0) shouldAdd = true;
                            break;
        
                        case 'Annual':
                            if (d.getMonth() === itemStartDate.getMonth() && d.getDate() === itemStartDate.getDate()) shouldAdd = true;
                    break;
                }

                    if (shouldAdd) {
                        const newExpense = {
                            id: `auto-${item.id}-${currentDateStr}`,
                            name: item.name,
                            cost: item.amount,
                            type: item.type === 'expense' ? item.essentialType : 'Income',
                            category: item.category,
                            date: currentDateStr,
                            paymentMethod: item.paymentMethod,
                            status: 'active',
                            recurringSourceId: item.id
                        };

                        // Avoid adding duplicates
                        if (!expenses.some(e => e.id === newExpense.id)) {
                             if (item.type === 'expense') {
                                expenses.unshift(newExpense);
                                newExpensesGenerated = true;
                            }
                        }
                    }
                });
            }

            localStorage.setItem('lastRecurringCheck', todayStr);
            
            if (newExpensesGenerated) {
                showToast('New recurring expenses have been automatically added.', 'info');
                saveData();
                updateDisplay();
            }
            }

        // --- Onboarding ---
        function startOnboardingProcess() {
            const firstVisit = localStorage.getItem('onboardingComplete') !== 'true';
            if (firstVisit) {
                document.getElementById('setup-modal').classList.remove('hidden');
            }
        }

        function saveSetupAndStartTour() {
            const budget = document.getElementById('setup-budget-input').value;
            const income = document.getElementById('setup-income-input').value;

            if (budget) {
                updateBudget(budget);
            }
            if (income) {
                updateIncome(income);
            }
            
            document.getElementById('setup-modal').classList.add('hidden');
            launchOnboardingTour();
        }

        function skipSetupAndStartTour() {
            document.getElementById('setup-modal').classList.add('hidden');
            launchOnboardingTour();
        }

        function launchOnboardingTour() {
            const driver = window.driver.js.driver;
            const driverObj = driver({
                showProgress: true,
                popoverClass: 'driver-popover',
                steps: [
                    { 
                        element: '.sm\\:items-center .gap-3 h1', 
                        popover: { 
                            title: 'Welcome to Your Expense Tracker!', 
                            description: "Let's take a quick tour to get you started.",
                            side: "bottom" 
                        } 
                    },
                    { 
                        element: '#budget-input', 
                        popover: { 
                            title: 'Set Your Monthly Budget', 
                            description: 'Start by entering your total monthly budget. This is the baseline for tracking your spending.',
                            side: "bottom"
                        } 
                    },
                    { 
                        element: 'button[onclick="showAddForm()"]', 
                        popover: { 
                            title: 'Add a New Expense', 
                            description: 'Use this button to log any one-time purchases or expenses.',
                            side: "left" 
                        } 
                    },
                    { 
                        element: 'button[onclick="showRecurringForm()"]', 
                        popover: { 
                            title: 'Add a Recurring Item', 
                            description: 'For regular income (like a salary) or expenses (like rent or subscriptions), use this.',
                            side: "left"
                        } 
                    },
                    { 
                        element: '#tab-insights', 
                        popover: { 
                            title: 'Visualize Your Spending', 
                            description: 'This tab contains charts and AI-powered insights to help you understand your financial habits.',
                            side: "bottom" 
                        } 
                    },
                    { 
                        element: 'button[onclick="toggleSettings()"]', 
                        popover: { 
                            title: 'Settings & Data', 
                            description: 'Change the theme, set your currency, and import or export your data here.',
                            side: "left" 
                        } 
                    }
                ],
                onDestroyed: () => {
                    localStorage.setItem('onboardingComplete', 'true');
                    
                    // Animate quick-add tiles
                    const quickAddTiles = document.querySelectorAll('.card button[onclick^="quickAddExpense"]');
                    quickAddTiles.forEach(tile => tile.parentElement.classList.add('animate-pulse'));
                    
                    setTimeout(() => {
                        quickAddTiles.forEach(tile => tile.parentElement.classList.remove('animate-pulse'));
                    }, 4000);
                }
            });

            driverObj.drive();
        }

        // --- Tab Management ---
        function showTab(tabName) {
            // Hide all tab content and deactivate all tab buttons first
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

            // Activate the new tab button and show its content
            const newTabButton = document.getElementById(`tab-${tabName}`);
            const newTabContent = document.getElementById(`${tabName}-tab`);

            if (newTabButton && newTabContent) {
                newTabButton.classList.add('active');
                newTabContent.classList.remove('hidden');
                activeTab = tabName;

                if (activeTab === 'insights') {
                    updateChartsAndInsights();
                }
                saveData();
            }
        }

        // --- Settings & Theme ---
        function toggleSettings() {
            DOMElements.settingsMenu.classList.toggle('hidden');
        }

        function toggleTheme(isDark) {
            localStorage.setItem('darkMode', isDark);
            applyTheme();
        }

        function applyTheme() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            DOMElements.html.classList.toggle('dark', darkMode);
            DOMElements.themeToggle.checked = darkMode;
            
            if (activeTab === 'insights') {
                updateChartsAndInsights(); 
            }
        }

        // --- Data Load/Save ---
        function loadData() {
            const data = localStorage.getItem('aiExpenseTrackerData');
            if (data) {
                const parsedData = JSON.parse(data);
                expenses = parsedData.expenses || [];
                recurringItems = parsedData.recurringItems || [];
                monthlyBudget = parsedData.monthlyBudget || 0;
                monthlyIncome = parsedData.monthlyIncome || 0;
                healthScoreHistory = parsedData.healthScoreHistory || {};
                currentCurrencyCode = parsedData.currentCurrencyCode || 'GBP';
                activeTab = parsedData.activeTab || 'overview';
            }
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                 DOMElements.themeToggle.checked = savedDarkMode === 'true';
            }
        }

        function saveData() {
            const dataToSave = {
                expenses,
                recurringItems,
                monthlyBudget,
                monthlyIncome,
                healthScoreHistory,
                currentCurrencyCode,
                activeTab
            };
            localStorage.setItem('aiExpenseTrackerData', JSON.stringify(dataToSave));
        }

        // --- Import / Export ---
        function exportData() {
            const dataStr = localStorage.getItem('aiExpenseTrackerData') || '{}';
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-expense-tracker-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData === 'object' && importedData !== null) {
                        expenses = importedData.expenses || [];
                        recurringItems = importedData.recurringItems || [];
                        monthlyBudget = importedData.monthlyBudget || 0;
                        monthlyIncome = importedData.monthlyIncome || 0;
                        healthScoreHistory = importedData.healthScoreHistory || {};
                        currentCurrencyCode = importedData.currentCurrencyCode || 'GBP';
                        activeTab = importedData.activeTab || 'overview';
                        
                        DOMElements.currencySelect.value = currentCurrencyCode;

                        saveData();
                        updateCurrencyUI();
                        updateDisplay();
                        showTab(activeTab);
                        showToast('Data imported successfully!');
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    showToast('Import failed: Invalid file format.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = null;
            DOMElements.settingsMenu.classList.add('hidden');
        }

        // --- Budget & Income ---
        function updateBudget(value) {
            monthlyBudget = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }
        function updateIncome(value) {
            monthlyIncome = parseFloat(value) || 0;
            saveData();
            updateDisplay();
        }

        // --- Currency Management ---
        function changeCurrency(value) {
            if (currencyConfig[value]) {
                currentCurrencyCode = value;
                updateCurrencyUI();
                saveData();
                updateDisplay();
                showToast(`Currency changed to ${value}`);
            }
            DOMElements.settingsMenu.classList.add('hidden');
        }

        function updateCurrencyUI() {
            const symbol = currencyConfig[currentCurrencyCode].symbol;
            DOMElements.modalCurrency.textContent = symbol;
            DOMElements.recurringModalCurrency.textContent = symbol;
            DOMElements.currencySelect.value = currentCurrencyCode;
        }

        // --- Expense Management ---
        function showAddForm(prefill = {}) {
            editingExpense = null;
            DOMElements.modalTitle.textContent = 'Add New Expense';
            DOMElements.expenseName.value = prefill.name || '';
            DOMElements.expenseCost.value = prefill.cost || '';
            DOMElements.expenseType.value = prefill.type || 'Non-Essential';
            DOMElements.expenseCategory.value = prefill.category || 'Other';
            DOMElements.expenseDate.value = prefill.date || new Date().toISOString().split('T')[0];
            DOMElements.expensePaymentMethod.value = prefill.paymentMethod || '';
            DOMElements.modal.classList.remove('hidden');
        }

        function closeModal() {
            DOMElements.modal.classList.add('hidden');
            editingExpense = null;
        }

        function saveExpense() {
            const name = DOMElements.expenseName.value.trim();
            const cost = parseFloat(DOMElements.expenseCost.value);
            const date = DOMElements.expenseDate.value;

            if (!name || isNaN(cost) || cost <= 0 || !date) {
                showToast('Please fill in all fields correctly (Name, positive Amount, Date).', 'error');
                return;
            }

            const expense = {
                id: editingExpense ? editingExpense.id : Date.now(),
                name: name,
                cost: cost,
                type: DOMElements.expenseType.value,
                category: DOMElements.expenseCategory.value,
                date: date,
                paymentMethod: DOMElements.expensePaymentMethod.value,
                status: 'active'
            };

            if (editingExpense) {
                const index = expenses.findIndex(e => e.id === editingExpense.id);
                if (index !== -1) expenses[index] = expense;
            } else {
                expenses.unshift(expense);
            }

            saveData();
            updateDisplay();
            closeModal();
            showToast(`Expense '${name}' saved successfully!`);
        }
        
        function quickAddExpense(name, category, type, cost) {
            const expense = {
                id: Date.now(),
                name: name,
                cost: cost,
                type: type || 'Non-Essential',
                category: category || 'Other',
                date: new Date().toISOString().split('T')[0],
                paymentMethod: '',
                status: 'active'
            };
            expenses.unshift(expense);
            saveData();
            updateDisplay();
            showToast(`${name} added successfully for ${formatCurrency(cost)}.`);
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            editingExpense = expense;
            DOMElements.modalTitle.textContent = 'Edit Expense';
            DOMElements.expenseName.value = expense.name;
            DOMElements.expenseCost.value = expense.cost;
            DOMElements.expenseType.value = expense.type;
            DOMElements.expenseCategory.value = expense.category;
            DOMElements.expenseDate.value = expense.date;
            DOMElements.expensePaymentMethod.value = expense.paymentMethod || '';
            DOMElements.modal.classList.remove('hidden');
        }

        function deleteExpense(id) {
            if (confirm('Are you sure you want to permanently delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                selectedExpenseIds.delete(id.toString());
                saveData();
                updateDisplay();
                showToast('Expense deleted successfully!');
            }
        }

        function toggleExpenseStatus(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.status = expense.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Expense status updated to ${expense.status}.`);
            }
        }
        
        function toggleFilterPanel(panelId) {
            document.getElementById(panelId).classList.toggle('hidden');
        }

        // --- Recurring Item Management ---
        function populateCategoryDropdowns() {
            const expenseOptions = expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            DOMElements.expenseCategory.innerHTML = expenseOptions;
            
            document.getElementById('expense-filter-category').innerHTML = '<option value="">All Categories</option>' + expenseOptions;
            
            const allCats = [...new Set([...expenseCategories, ...incomeCategories])];
            document.getElementById('recurring-filter-category').innerHTML = '<option value="">All Categories</option>' + allCats.map(c => `<option value="${c}">${c}</option>`).join('');

            toggleRecurringFields('expense');
        }

        function toggleRecurringFields(type) {
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            DOMElements.recurringCategory.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            DOMElements.recurringEssentialTypeWrapper.style.display = type === 'expense' ? 'block' : 'none';
        }

         function showRecurringForm() {
            editingRecurring = null;
            DOMElements.recurringModalTitle.textContent = 'Add Recurring Item';
            DOMElements.recurringItemType.value = 'expense';
            toggleRecurringFields('expense');
            DOMElements.recurringName.value = '';
            DOMElements.recurringAmount.value = '';
            DOMElements.recurringFrequency.value = 'Monthly';
            DOMElements.recurringPaymentMethod.value = '';
            DOMElements.recurringStartDate.value = new Date().toISOString().split('T')[0];
            DOMElements.recurringEndDate.value = '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function closeRecurringModal() {
            DOMElements.recurringModal.classList.add('hidden');
            editingRecurring = null;
        }

        function saveRecurring() {
            const type = DOMElements.recurringItemType.value;
            const name = DOMElements.recurringName.value.trim();
            const amount = parseFloat(DOMElements.recurringAmount.value);
            const startDate = DOMElements.recurringStartDate.value;
            const endDate = DOMElements.recurringEndDate.value || null;

            if (!name || isNaN(amount) || amount <= 0 || !startDate) {
                 showToast('Please fill in recurring item fields correctly.', 'error');
                return;
            }

            const recurringItem = {
                id: editingRecurring ? editingRecurring.id : Date.now(),
                type: type,
                name: name,
                amount: amount,
                frequency: DOMElements.recurringFrequency.value,
                category: DOMElements.recurringCategory.value,
                essentialType: type === 'expense' ? DOMElements.recurringEssentialType.value : null,
                paymentMethod: DOMElements.recurringPaymentMethod.value,
                startDate: startDate,
                endDate: endDate,
                status: 'active'
            };

            if (editingRecurring) {
                const index = recurringItems.findIndex(r => r.id === editingRecurring.id);
                if (index !== -1) recurringItems[index] = recurringItem;
            } else {
                recurringItems.unshift(recurringItem);
            }

            saveData();
            updateDisplay();
            closeRecurringModal();
            showToast(`Recurring ${type} '${name}' saved successfully!`);
        }

        function editRecurring(id) {
            const item = recurringItems.find(r => r.id === id);
            if (!item) return;
            editingRecurring = item;
            DOMElements.recurringModalTitle.textContent = 'Edit Recurring Item';
            DOMElements.recurringItemType.value = item.type;
            toggleRecurringFields(item.type);
            DOMElements.recurringName.value = item.name;
            DOMElements.recurringAmount.value = item.amount;
            DOMElements.recurringFrequency.value = item.frequency;
            DOMElements.recurringCategory.value = item.category;
            if (item.type === 'expense') {
                DOMElements.recurringEssentialType.value = item.essentialType || 'Non-Essential';
            }
            DOMElements.recurringPaymentMethod.value = item.paymentMethod || '';
            DOMElements.recurringStartDate.value = item.startDate;
            DOMElements.recurringEndDate.value = item.endDate || '';
            DOMElements.recurringModal.classList.remove('hidden');
        }

        function deleteRecurring(id) {
            if (confirm('Are you sure you want to delete this recurring item and all its automatically generated future expenses?')) {
                recurringItems = recurringItems.filter(r => r.id !== id);
                expenses = expenses.filter(e => e.recurringSourceId !== id); // Also remove generated expenses
                selectedRecurringIds.delete(id);
                saveData();
                updateDisplay();
                showToast('Recurring item and its generated entries deleted!');
            }
        }
        
        function toggleRecurringStatus(id) {
            const item = recurringItems.find(r => r.id === id);
            if(item) {
                item.status = item.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Recurring item status updated.`);
            }
        }
        
        // --- Filtering Logic ---
        function applyExpenseFilters() {
            renderExpensesTable();
            showToast('Filters applied');
        }

        function clearExpenseFilters() {
            document.getElementById('expense-filter-date-from').value = '';
            document.getElementById('expense-filter-date-to').value = '';
            document.getElementById('expense-filter-category').value = '';
            document.getElementById('expense-filter-type').value = '';
            renderExpensesTable();
            showToast('Filters cleared');
        }

        function applyRecurringFilters() {
            renderRecurringTable();
            showToast('Filters applied');
        }

        function clearRecurringFilters() {
            document.getElementById('recurring-filter-type').value = '';
            document.getElementById('recurring-filter-category').value = '';
            document.getElementById('recurring-filter-frequency').value = '';
            renderRecurringTable();
            showToast('Filters cleared');
        }
        
        // --- Bulk Actions ---
        function toggleSelectAllExpenses(checked) {
            const checkboxes = DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox');
            selectedExpenseIds.clear();
            checkboxes.forEach(cb => {
                if (!cb.disabled) {
                    cb.checked = checked;
                    if (checked) {
                        selectedExpenseIds.add(cb.dataset.id);
                    }
                }
            });
            updateDeleteSelectedButton();
        }

        function toggleExpenseSelection(checkbox, id) {
            if (checkbox.checked) {
                selectedExpenseIds.add(id);
            } else {
                selectedExpenseIds.delete(id);
            }
            const allCheckboxes = [...DOMElements.expensesTableBody.querySelectorAll('.expense-checkbox:not(:disabled)')];
            DOMElements.selectAllExpensesCheckbox.checked = allCheckboxes.length > 0 && selectedExpenseIds.size === allCheckboxes.length;
            updateDeleteSelectedButton();
        }

        function updateDeleteSelectedButton() {
            if (selectedExpenseIds.size > 0) {
                DOMElements.deleteSelectedBtn.classList.remove('hidden');
                DOMElements.deleteSelectedBtn.querySelector('span').textContent = `Delete Selected (${selectedExpenseIds.size})`;
            } else {
                DOMElements.deleteSelectedBtn.classList.add('hidden');
            }
        }

        function deleteSelectedExpenses() {
            if (selectedExpenseIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedExpenseIds.size} selected one-time expense(s)?`)) {
                const initialCount = expenses.length;
                expenses = expenses.filter(e => !selectedExpenseIds.has(e.id.toString()));
                const deletedCount = initialCount - expenses.length;
                selectedExpenseIds.clear();
                DOMElements.selectAllExpensesCheckbox.checked = false;
                saveData();
                updateDisplay();
                showToast(`${deletedCount} expense(s) deleted.`);
            }
        }
        
        function toggleSelectAllRecurring(checked) {
            const checkboxes = DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox');
            selectedRecurringIds.clear();
            checkboxes.forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedRecurringIds.add(parseInt(cb.dataset.id));
                }
            });
            updateDeleteSelectedRecurringButton();
        }

        function toggleRecurringSelection(checkbox, id) {
            const numId = parseInt(id);
            if (checkbox.checked) {
                selectedRecurringIds.add(numId);
            } else {
                selectedRecurringIds.delete(numId);
            }
            const allCheckboxes = [...DOMElements.recurringTableBody.querySelectorAll('.recurring-checkbox')];
            DOMElements.selectAllRecurringCheckbox.checked = allCheckboxes.length > 0 && selectedRecurringIds.size === allCheckboxes.length;
            updateDeleteSelectedRecurringButton();
        }

        function updateDeleteSelectedRecurringButton() {
            const btn = DOMElements.deleteSelectedRecurringBtn;
            if (selectedRecurringIds.size > 0) {
                btn.classList.remove('hidden');
                btn.querySelector('span').textContent = `Delete Selected (${selectedRecurringIds.size})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        function deleteSelectedRecurring() {
            if (selectedRecurringIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedRecurringIds.size} recurring item(s)?`)) {
                recurringItems = recurringItems.filter(r => !selectedRecurringIds.has(r.id));
                selectedRecurringIds.clear();
                DOMElements.selectAllRecurringCheckbox.checked = false;
                saveData();
                updateDisplay();
                showToast(`${selectedRecurringIds.size} recurring item(s) deleted.`);
            }
        }

        // --- Calculation Functions ---
        function getMonthlyRecurringTotals(year, month) {
            let totals = { income: 0, expenses: 0 };
            recurringItems.forEach(item => {
                if (item.status !== 'active') return;
                const startDate = new Date(item.startDate);
                if (startDate.getFullYear() > year || (startDate.getFullYear() === year && startDate.getMonth() > month)) return;
                if (item.endDate) {
                    const endDate = new Date(item.endDate);
                    if (endDate.getFullYear() < year || (endDate.getFullYear() === year && endDate.getMonth() < month)) return;
                }
                if (item.frequency === 'Monthly') {
                    if (item.type === 'income') totals.income += item.amount;
                    else totals.expenses += item.amount;
                }
                // TODO: Add other frequencies
            });
            return totals;
        }

        function getMonthlyExpenseTotal(year, month) {
             return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return e.status === 'active' && expenseDate.getMonth() === month && expenseDate.getFullYear() === year;
            }).reduce((sum, e) => sum + e.cost, 0);
        }

        // --- UI Update Functions ---
        function getResponsiveFontSize(text) {
            const baseSize = 1.875; // Corresponds to text-3xl
            const minSize = 1.25; // Corresponds to text-xl
            const maxLength = 8; // Start shrinking after 8 characters
            
            let newSize = baseSize;
            if (text.length > maxLength) {
                newSize = Math.max(minSize, baseSize - (text.length - maxLength) * 0.15);
            }
            return `${newSize}rem`;
        }

        function updateQuickAddButtons() {
            const quickAddData = {
                'JPY': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 500 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 700 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 1000 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 20000 }
                ],
                'default': [
                    { id: 'quick-add-coffee', name: 'Coffee', category: 'Food/Drink', type: 'Non-Essential', cost: 5 },
                    { id: 'quick-add-transport', name: 'Transport', category: 'Transport', type: 'Essential', cost: 10 },
                    { id: 'quick-add-lunch', name: 'Lunch', category: 'Food/Drink', type: 'Non-Essential', cost: 15 },
                    { id: 'quick-add-groceries', name: 'Groceries', category: 'Food/Drink', type: 'Essential', cost: 50 }
                ]
            };

            const currencyData = quickAddData[currentCurrencyCode] || quickAddData['default'];
            
            currencyData.forEach(item => {
                const container = document.getElementById(item.id);
                if (container) {
                    const button = container.querySelector('button');
                    const costSpan = button.querySelector('span.font-medium');

                    costSpan.textContent = formatCurrency(item.cost);
                    button.onclick = () => quickAddExpense(item.name, item.category, item.type, item.cost);
                }
            });
        }

        function updateDisplay() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Centralized calculations for all expenses this month
            const monthlyRecurring = getMonthlyRecurringTotals(currentYear, currentMonth);
            const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;

            const allMonthlyExpenses = [
                ...expenses.filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                }),
                ...generateExpensesFromRecurring().filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                })
            ];
            const activeMonthlyExpenses = allMonthlyExpenses.filter(e => e.status === 'active');
            const totalSpent = activeMonthlyExpenses.reduce((sum, e) => sum + e.cost, 0);

            // --- Update UI Tiles ---
            const budgetStr = formatCurrency(monthlyBudget);
            const spentStr = formatCurrency(totalSpent);
            const incomeStr = formatCurrency(totalMonthlyIncome);
            const remaining = monthlyBudget - totalSpent;
            const remainingStr = formatCurrency(remaining);

            // Find the longest string to determine a consistent font size
            const maxLength = Math.max(budgetStr.length, spentStr.length, incomeStr.length, remainingStr.length);
            const responsiveSize = getResponsiveFontSize(" ".repeat(maxLength));

            DOMElements.monthlyBudgetDisplay.textContent = budgetStr;
            DOMElements.monthlyBudgetDisplay.style.fontSize = responsiveSize;

            DOMElements.totalExpensesDisplay.textContent = spentStr;
            DOMElements.totalExpensesDisplay.style.fontSize = responsiveSize;
            
            DOMElements.totalIncomeDisplay.textContent = incomeStr;
            DOMElements.totalIncomeDisplay.style.fontSize = responsiveSize;

            DOMElements.remainingAmountDisplay.textContent = remainingStr;
            DOMElements.remainingAmountDisplay.style.fontSize = responsiveSize;

            if (remaining < 0) {
                DOMElements.remainingAmountDisplay.classList.remove('text-green-600', 'dark:text-green-400');
                DOMElements.remainingAmountDisplay.classList.add('text-red-600', 'dark:text-red-400');
            } else {
                DOMElements.remainingAmountDisplay.classList.remove('text-red-600', 'dark:text-red-400');
                DOMElements.remainingAmountDisplay.classList.add('text-green-600', 'dark:text-green-400');
            }

            updateQuickAddButtons();

            // Budget Health & Progress Bar
            const budgetProgress = (monthlyBudget > 0) ? (totalSpent / monthlyBudget) * 100 : 0;
            DOMElements.budgetBar.style.width = `${Math.min(budgetProgress, 100)}%`;
            DOMElements.budgetBar.classList.remove('bg-blue-600', 'bg-red-600');
            DOMElements.budgetBar.classList.add(budgetProgress > 100 ? 'bg-red-600' : 'bg-blue-600');
            DOMElements.budgetPercentage.textContent = `${budgetProgress.toFixed(0)}% Used`;
            
            // AI Projection
            const projection = predictMonthEndSpending(totalSpent, now);
            DOMElements.aiProjectionContainer.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">üîÆ</span>
                    <div>
                        <span class="font-semibold">AI Projection:</span>
                        You're on track to spend <strong>${formatCurrency(projection.projectedSpend)}</strong> this month.
                        <span class="font-bold ${projection.statusColor}">${projection.statusText}</span>
                    </div>
                </div>
            `;
            
            updateBudgetHealthScore(totalSpent, monthlyBudget, activeMonthlyExpenses, totalMonthlyIncome, now);
            
            // Spending Breakdown
            const essentialSpending = activeMonthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
            const nonEssentialSpending = activeMonthlyExpenses.filter(e => e.type === 'Non-Essential').reduce((sum, e) => sum + e.cost, 0);
            DOMElements.essentialSpendingDisplay.textContent = formatCurrency(essentialSpending);
            DOMElements.nonEssentialSpendingDisplay.textContent = formatCurrency(nonEssentialSpending);
            const totalBreakdown = essentialSpending + nonEssentialSpending;
            const essentialPercent = totalBreakdown > 0 ? (essentialSpending / totalBreakdown) * 100 : 0;
            DOMElements.essentialBar.style.width = `${essentialPercent}%`;
            DOMElements.nonEssentialBar.style.width = `${100 - essentialPercent}%`;

            renderRecentExpenses();
            renderExpensesTable();
            renderRecurringTable();
            
            if (activeTab === 'insights') {
                updateChartsAndInsights();
            }
            updateDeleteSelectedButton();
            updateDeleteSelectedRecurringButton();
        }

        // --- Budget Health Score v3 ---

        function calculateBudgetUsageScore(totalSpent, budget, now) {
            let score = 0;
            // Component 1: Budget Usage (30 points)
            if (budget > 0) {
                const usage = totalSpent / budget;
                if (usage > 1) score += 0;
                else if (usage <= 0.8) score += 30;
                else score += 30 * (1 - (usage - 0.8) / 0.2);
            }

            // Component 2: Spending Velocity (20 points)
            if (budget > 0) {
                const dayOfMonth = now.getDate();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const percentOfMonthPassed = dayOfMonth / daysInMonth;
                const idealSpend = budget * percentOfMonthPassed;
                const deviation = totalSpent / idealSpend;
                if (deviation <= 1.0) score += 20;
                else if (deviation <= 1.5) score += 20 * (1 - (deviation - 1.0) / 0.5);
            }

            return { score: Math.round(score), max: 50 };
        }

        function calculateSpendingHabitsScore(monthlyExpenses, totalSpent) {
            let score = 0;
            if (totalSpent > 0) {
                // Component 1: Essential vs Non-Essential (15 points)
                const essentialSpending = monthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
                const nonEssentialRatio = (totalSpent - essentialSpending) / totalSpent;
                if (nonEssentialRatio < 0.3) score += 15;
                else if (nonEssentialRatio < 0.5) score += 7;

                // Component 2: No-Spend Days (15 points)
                const spendingDays = new Set(monthlyExpenses.map(e => e.date)).size;
                const zeroSpendingDays = new Date().getDate() - spendingDays;
                if (zeroSpendingDays >= 8) score += 15;
                else if (zeroSpendingDays >= 4) score += 7;
            }
            return { score: Math.round(score), max: 30 };
        }

        function calculateSavingsRateScore(totalSpent, totalMonthlyIncome, now) {
            let score = 0;
            // Component 1: Positive Savings (10 points)
            if (totalMonthlyIncome > 0 && totalMonthlyIncome > totalSpent) {
                score += 10;
            }
            
            // Component 2: Improving Savings Rate (10 points)
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthData = getExpensesForMonth(lastMonth.getFullYear(), lastMonth.getMonth());
            const lastMonthIncomeData = getMonthlyRecurringTotals(lastMonth.getFullYear(), lastMonth.getMonth());
            const lastMonthTotalIncome = (monthlyIncome || 0) + lastMonthIncomeData.income;
            if (lastMonthTotalIncome > 0) {
                const lastMonthSpent = lastMonthData.reduce((sum, e) => sum + e.cost, 0);
                const currentSavingsRate = (totalMonthlyIncome - totalSpent) / totalMonthlyIncome;
                const lastMonthSavingsRate = (lastMonthTotalIncome - lastMonthSpent) / lastMonthTotalIncome;
                if (currentSavingsRate > lastMonthSavingsRate) {
                    score += 10;
                }
            }
            return { score: Math.round(score), max: 20 };
        }

        function generateHealthScoreInsights(scoreData, totalSpent, monthlyExpenses, totalMonthlyIncome) {
            const insights = { strengths: [], improvements: [], tip: '' };
            const { budgetUsage, spendingHabits, savingsRate } = scoreData.breakdown;

            // Strengths
            if (budgetUsage.score / budgetUsage.max > 0.8) insights.strengths.push("Excellent budget control and spending pace.");
            if (spendingHabits.score / spendingHabits.max > 0.8) insights.strengths.push("Great balance of essential vs. non-essential spending.");
            if (savingsRate.score / savingsRate.max > 0.8) insights.strengths.push("Fantastic! Your savings rate is improving.");
            if (insights.strengths.length === 0) insights.strengths.push("Getting started is the first step!");

            // Improvements & Tips
            let lowestCategory = 'budgetUsage';
            let lowestPercentage = (budgetUsage.score / budgetUsage.max);
            if ((spendingHabits.score / spendingHabits.max) < lowestPercentage) {
                lowestCategory = 'spendingHabits';
                lowestPercentage = spendingHabits.score / spendingHabits.max;
            }
            if ((savingsRate.score / savingsRate.max) < lowestPercentage) {
                lowestCategory = 'savingsRate';
            }
            
            if (lowestPercentage < 0.6) {
                switch(lowestCategory) {
                    case 'budgetUsage':
                        insights.improvements.push("Spending is outpacing your budget for this point in the month.");
                        insights.tip = "Try having a 'no-spend' day to get back on track.";
                        break;
                    case 'spendingHabits':
                        insights.improvements.push("A high portion of spending is on non-essentials.");
                        insights.tip = "Review subscriptions or dining out for potential savings.";
                        break;
                    case 'savingsRate':
                        insights.improvements.push("Currently not saving or saving less than last month.");
                        insights.tip = "Set a small, achievable savings goal for this month.";
                        break;
                }
            }
            if (insights.improvements.length === 0) insights.improvements.push("You're on the right track in all areas.");

            return insights;
        }

        function renderBudgetHealthScore(scoreData) {
            const { totalScore, breakdown, insights } = scoreData;

            // --- Render Visuals ---
            let scoreColor = 'var(--health-score-bad)';
            let scoreLabel = 'Poor';
            if (totalScore >= 70) {
                scoreColor = 'var(--health-score-good)';
                scoreLabel = 'Good';
            } else if (totalScore >= 40) {
                scoreColor = 'var(--health-score-ok)';
                scoreLabel = 'Okay';
            }
            
            DOMElements.healthScoreVisual.innerHTML = `
                <svg class="w-full h-full" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="${DOMElements.html.classList.contains('dark') ? 'var(--bg-tertiary)' : '#e6e6e6'}" stroke-width="3" />
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="${scoreColor}" stroke-width="3" stroke-dasharray="${totalScore}, 100" stroke-linecap="round"
                          style="transition: stroke-dasharray 1s ease-out;" />
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold" style="color: ${scoreColor};">${totalScore}</span>
                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">${scoreLabel}</span>
                </div>
            `;
            
            // --- Render Trend ---
            let trendHtml = '';
            if (scoreData.lastMonthScore !== undefined) {
                const diff = totalScore - scoreData.lastMonthScore;
                if (diff > 0) {
                    trendHtml = `<span class="text-green-500 flex items-center justify-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        Up from ${scoreData.lastMonthScore}
                    </span>`;
                } else if (diff < 0) {
                    trendHtml = `<span class="text-red-500 flex items-center justify-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                        Down from ${scoreData.lastMonthScore}
                    </span>`;
                } else {
                    trendHtml = `<span>- Same as last month</span>`;
                }
            }
            DOMElements.healthScoreTrend.innerHTML = trendHtml;
            
            // --- Render Tooltip ---
            const renderProgressBar = (value, max) => {
                const percentage = (value / max) * 100;
                return `
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
            };

            DOMElements.healthScoreTooltip.innerHTML = `
                <div class="font-bold text-base mb-2 text-center">Your Score: ${totalScore}/100</div>
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-semibold">Budget Usage</span>
                            <span class="text-xs font-medium">${breakdown.budgetUsage.score}/${breakdown.budgetUsage.max} pts</span>
                        </div>
                        ${renderProgressBar(breakdown.budgetUsage.score, breakdown.budgetUsage.max)}
                    </div>
                    <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-semibold">Spending Habits</span>
                            <span class="text-xs font-medium">${breakdown.spendingHabits.score}/${breakdown.spendingHabits.max} pts</span>
                        </div>
                        ${renderProgressBar(breakdown.spendingHabits.score, breakdown.spendingHabits.max)}
                    </div>
                    <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-semibold">Savings Rate</span>
                            <span class="text-xs font-medium">${breakdown.savingsRate.score}/${breakdown.savingsRate.max} pts</span>
                        </div>
                        ${renderProgressBar(breakdown.savingsRate.score, breakdown.savingsRate.max)}
                    </div>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-600 my-3"></div>
                <div>
                    <h4 class="font-semibold text-green-600 dark:text-green-400">Strengths</h4>
                    <ul class="list-disc list-inside text-xs">${insights.strengths.map(s => `<li>${s}</li>`).join('')}</ul>
                </div>
                <div class="mt-2">
                    <h4 class="font-semibold text-yellow-600 dark:text-yellow-400">Areas to Improve</h4>
                    <ul class="list-disc list-inside text-xs">${insights.improvements.map(i => `<li>${i}</li>`).join('')}</ul>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 text-center">
                    <span class="font-semibold">üí° Tip:</span>
                    <span class="text-xs italic">${insights.tip}</span>
                </div>
            `;
        }

        function updateBudgetHealthScore(totalSpent, budget, monthlyExpenses, totalMonthlyIncome, now) {
            const breakdown = {
                budgetUsage: calculateBudgetUsageScore(totalSpent, budget, now),
                spendingHabits: calculateSpendingHabitsScore(monthlyExpenses, totalSpent),
                savingsRate: calculateSavingsRateScore(totalSpent, totalMonthlyIncome, now)
            };
            const totalScore = Math.round(breakdown.budgetUsage.score + breakdown.spendingHabits.score + breakdown.savingsRate.score);
            
            const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            healthScoreHistory[currentMonthKey] = totalScore;
            saveData();
            
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthKey = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
            
            const scoreData = {
                totalScore,
                breakdown,
                lastMonthScore: healthScoreHistory[lastMonthKey],
                insights: generateHealthScoreInsights({ breakdown }, totalSpent, monthlyExpenses, totalMonthlyIncome)
            };

            renderBudgetHealthScore(scoreData);
        }

        function predictMonthEndSpending(totalSpent, now) {
            if (totalSpent <= 0) {
                return { projectedSpend: 0, statusText: '', statusColor: '' };
            }
            const dayOfMonth = now.getDate();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const avgDailySpend = totalSpent / dayOfMonth;
            const projectedSpend = avgDailySpend * daysInMonth;

            const budgetUsage = projectedSpend / monthlyBudget;
            let statusText = 'On Track';
            let statusColor = 'text-green-700 dark:text-green-400';

            if (budgetUsage > 1.1) {
                statusText = 'Exceeding Budget';
                statusColor = 'text-red-700 dark:text-red-400';
            } else if (budgetUsage > 0.95) {
                statusText = 'At Risk';
                statusColor = 'text-yellow-600 dark:text-yellow-400';
            }
            return { projectedSpend, statusText, statusColor };
        }
        
        function getExpensesForMonth(year, month) {
            return expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate.getFullYear() === year && expenseDate.getMonth() === month;
            });
        }

        function renderRecentExpenses() {
            DOMElements.recentExpensesContainer.innerHTML = '';
            const allDisplayExpenses = [...expenses, ...generateExpensesFromRecurring()];
            const recent = allDisplayExpenses
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recent.length === 0) {
                DOMElements.recentExpensesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">No recent expenses.</p>';
                return;
            }
            recent.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center border-b border-gray-100 dark:border-gray-700 py-2 last:border-b-0 text-xs';
                div.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800 dark:text-gray-200">${escapeHTML(expense.name)}</p>
                        <p class="text-gray-500 dark:text-gray-400">${expense.date} - ${escapeHTML(expense.category)}</p>
                    </div>
                    <p class="font-medium text-red-600 dark:text-red-400">${formatCurrency(expense.cost)}</p>
                `;
                DOMElements.recentExpensesContainer.appendChild(div);
            });
        }

        function renderExpensesTable() {
            const generated = generateExpensesFromRecurring();
            let allExpenses = [...expenses, ...generated];

            // Apply filters
            const dateFrom = document.getElementById('expense-filter-date-from').value;
            const dateTo = document.getElementById('expense-filter-date-to').value;
            const categoryFilter = document.getElementById('expense-filter-category').value;
            const typeFilter = document.getElementById('expense-filter-type').value;

            const filteredExpenses = allExpenses.filter(e => {
                let passes = true;
                if (dateFrom && e.date < dateFrom) passes = false;
                if (dateTo && e.date > dateTo) passes = false;
                if (categoryFilter && e.category !== categoryFilter) passes = false;
                if (typeFilter && e.type !== typeFilter) passes = false;
                return passes;
            }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by most recent date

            const tableBody = DOMElements.expensesTableBody;
            if (filteredExpenses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-gray-500">No expenses match your filters.</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredExpenses.map(expense => {
                const isRecurringInstance = typeof expense.id === 'string' && expense.id.startsWith('recurring-');
                const isCancelled = expense.status === 'cancelled';
                const editAction = isRecurringInstance ? `editRecurring(${expense.originalRecurringId})` : `editExpense(${expense.id})`;
                const deleteAction = isRecurringInstance ? 'return false;' : `deleteExpense(${expense.id})`;
                const statusToggleAction = isRecurringInstance ? `toggleRecurringStatus(${expense.originalRecurringId})` : `toggleExpenseStatus(${expense.id})`;
                const checkboxId = `expense-${expense.id}`;

                return `
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 ${isCancelled ? 'opacity-60' : ''}">
                        <td class="px-4 py-3">
                            <input type="checkbox" id="${checkboxId}" data-id="${expense.id}" onchange="toggleExpenseSelection(this, '${expense.id}')" 
                            class="table-checkbox expense-checkbox" ${isRecurringInstance ? 'disabled' : ''} ${selectedExpenseIds.has(expense.id.toString()) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap">${escapeHTML(expense.name)}</td>
                        <td class="px-6 py-3">${formatCurrency(expense.cost)}</td>
                        <td class="px-6 py-3 hidden md:table-cell">${expense.date}</td>
                        <td class="px-6 py-3 hidden md:table-cell">${escapeHTML(expense.category)}</td>
                        <td class="px-6 py-3 hidden lg:table-cell">${escapeHTML(expense.paymentMethod) || '-'}</td>
                        <td class="px-6 py-3 hidden lg:table-cell">${escapeHTML(expense.type)}</td>
                        <td class="px-6 py-3">
                            <span class="status-badge ${isCancelled ? 'status-cancelled' : 'status-active'}">${isCancelled ? 'Cancelled' : 'Active'}</span>
                        </td>
                        <td class="px-6 py-3 text-right">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="${editAction}" title="Edit" class="icon-button" ${isCancelled ? 'disabled' : ''} ${isCancelled ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button onclick="${deleteAction}" title="Delete" class="icon-button text-red-600/80 hover:text-red-500" ${isRecurringInstance ? 'disabled' : ''} ${isRecurringInstance ? 'opacity-50 cursor-not-allowed' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderRecurringTable() {
            DOMElements.recurringTableBody.innerHTML = '';
            const type = document.getElementById('recurring-filter-type').value;
            const category = document.getElementById('recurring-filter-category').value;
            const frequency = document.getElementById('recurring-filter-frequency').value;

            let filtered = recurringItems.filter(item => {
                if (type && item.type !== type) return false;
                if (category && item.category !== category) return false;
                if (frequency && item.frequency !== frequency) return false;
                return true;
            });

            filtered.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            if (filtered.length === 0) {
                DOMElements.recurringTableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center">No recurring items found.</td></tr>`;
                return;
            }

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                const isSelected = selectedRecurringIds.has(item.id);
                tr.className = `border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 ${item.status === 'cancelled' ? 'opacity-60' : ''} ${isSelected ? 'bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800'}`;
                const itemTypeClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

                tr.innerHTML = `
                    <td class="px-4 py-4 w-1"><input type="checkbox" data-id="${item.id}" onchange="toggleRecurringSelection(this, ${item.id})" class="table-checkbox recurring-checkbox" ${isSelected ? 'checked' : ''}></td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${escapeHTML(item.name)}</td>
                    <td class="px-6 py-4 capitalize">${item.type}</td>
                    <td class="px-6 py-4 font-medium ${itemTypeClass}">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4 hidden md:table-cell">${item.frequency}</td>
                    <td class="px-6 py-4 hidden md:table-cell">${item.startDate}</td>
                    <td class="px-6 py-4 hidden lg:table-cell">${escapeHTML(item.category)}</td>
                    <td class="px-6 py-4"><span class="status-badge ${item.status === 'active' ? 'status-active' : 'status-cancelled'}">${item.status}</span></td>
                    <td class="px-6 py-4 text-right space-x-1 whitespace-nowrap">
                        <button onclick="editRecurring(${item.id})" class="icon-button" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        <button onclick="toggleRecurringStatus(${item.id})" class="icon-button" title="${item.status === 'active' ? 'Pause' : 'Resume'}">
                           ${item.status === 'active' ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'}
                        </button>
                        <button onclick="deleteRecurring(${item.id})" class="icon-button text-red-500 hover:text-red-700" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </td>
                `;
                DOMElements.recurringTableBody.appendChild(tr);
            });
        }
        
        // --- Charting and Insights ---
        function updateChartsAndInsights() {
            renderSpendingTrendChart();
            renderCategorySpendingChart();
            renderMonthlySavingsChart();
            updateAiInsights();
        }

        const chartColors = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#06b6d4', '#d946ef', '#84cc16'];
        function getChartColors(count) {
            return Array.from({length: count}, (_, i) => chartColors[i % chartColors.length]);
        }

        function getChartOptions(isDarkMode) {
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { color: gridColor }, ticks: { color: textColor } },
                    y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, callback: value => formatCurrency(value, false) } }
                },
                plugins: {
                    legend: { labels: { color: textColor } },
                    tooltip: { titleFont: { weight: 'bold' }, bodyFont: {}, backgroundColor: isDarkMode ? '#334155' : '#ffffff', titleColor: isDarkMode ? '#f1f5f9' : '#1e293b', bodyColor: isDarkMode ? '#f1f5f9' : '#1e293b', borderColor: isDarkMode ? '#475569' : '#e2e8f0', borderWidth: 1 }
                }
            };
        }

        function renderSpendingTrendChart() {
            const ctx = DOMElements.spendingTrendCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const data = monthlyData.map(m => m.expenses);

            if (spendingTrendChart) spendingTrendChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            spendingTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: chartColors[2],
                        backgroundColor: chartColors[2] + '33',
                        tension: 0.2, fill: true, pointRadius: 3, pointHoverRadius: 5
                    }]
                },
                options: options
            });
        }

        function renderCategorySpendingChart() {
            const ctx = DOMElements.categorySpendingCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const data = monthlyData.map(m => m.expenses);

            if (categorySpendingChart) categorySpendingChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Spending: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            categorySpendingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(d => d >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'),
                        borderColor: data.map(d => d >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }

        function renderMonthlySavingsChart() {
            const ctx = DOMElements.monthlySavingsCanvas?.getContext('2d');
            if (!ctx) return;
            const monthlyData = getMonthlyIncomeAndExpenses(12);
            const labels = monthlyData.map(m => new Date(m.year, m.month).toLocaleString('default', {month: 'short', year: '2-digit'}));
            const savingsData = monthlyData.map(m => m.income - m.expenses);

            if (monthlySavingsChart) monthlySavingsChart.destroy();
            const isDarkMode = DOMElements.html.classList.contains('dark');
            const options = getChartOptions(isDarkMode);
            options.plugins.tooltip.callbacks = { label: (context) => ` Savings: ${formatCurrency(context.parsed.y)}` };
            options.plugins.legend = { display: false };

            monthlySavingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: savingsData,
                        backgroundColor: savingsData.map(s => s >= 0 ? chartColors[1] + 'AA' : chartColors[2] + 'AA'),
                        borderColor: savingsData.map(s => s >= 0 ? chartColors[1] : chartColors[2]),
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }
        
        function getMonthlyIncomeAndExpenses(numMonths) {
            const data = [];
            for (let i = 0; i < numMonths; i++) {
                const date = new Date(new Date().setMonth(new Date().getMonth() - i));
                const year = date.getFullYear();
                const month = date.getMonth();
                const recurring = getMonthlyRecurringTotals(year, month);
                data.push({
                    year: year,
                    month: month,
                    income: monthlyIncome + recurring.income,
                    expenses: getMonthlyExpenseTotal(year, month) + recurring.expenses
                });
            }
            return data.reverse();
        }

        function updateAiInsights() {
            const forecastContainer = document.getElementById('seven-day-forecast');
            const projectionContainer = document.getElementById('month-end-projection');
            const recommendationsContainer = document.getElementById('smart-recommendations');
            const storyContainer = document.getElementById('monthly-story');
            const storyMetricsContainer = document.getElementById('story-metrics');
            const actionCount = document.getElementById('action-count');

            const showLoading = (container) => {
                if(container) container.innerHTML = `<div class="flex justify-center items-center p-4"><div class="ai-loading"></div></div>`;
            };
            
            showLoading(forecastContainer);
            showLoading(projectionContainer);
            showLoading(recommendationsContainer);
            showLoading(storyContainer);
            if(storyMetricsContainer) storyMetricsContainer.classList.add('hidden');


            setTimeout(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                 const monthlyExpenses = expenses.filter(e => {
                    const expenseDate = new Date(e.date);
                    return e.status === 'active' && expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                });
                 const totalSpent = monthlyExpenses.reduce((sum, e) => sum + e.cost, 0);

                render7DayForecast(forecastContainer);
                renderMonthEndProjection(projectionContainer, totalSpent, now);
                const recommendations = renderSmartRecommendations(recommendationsContainer, monthlyExpenses, recurringItems);
                if (recommendations.length > 0) {
                    actionCount.textContent = recommendations.length;
                    actionCount.classList.remove('hidden');
                } else {
                    actionCount.classList.add('hidden');
                }
                renderMonthlyStory(storyContainer, storyMetricsContainer, monthlyExpenses, totalSpent);
            }, 500);
        }

        function render7DayForecast(container) {
            if (!container) return;
            const today = new Date();
            today.setHours(0,0,0,0);
            const sevenDaysLater = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const upcomingItems = recurringItems
                .map(item => ({ ...item, dueDate: getNextDueDate(item, today) }))
                .filter(item => item.dueDate && item.dueDate <= sevenDaysLater && item.status === 'active' && item.type === 'expense')
                .sort((a,b) => a.dueDate - b.dueDate);

            if (upcomingItems.length === 0) {
                container.innerHTML = `<div class="text-center text-sm text-gray-500 dark:text-gray-400 p-4">No upcoming recurring expenses in the next 7 days.</div>`;
                return;
            }

            container.innerHTML = upcomingItems.map(item => `
                <div class="flex items-center justify-between text-sm p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800/50">
                    <div>
                        <div class="font-medium text-gray-800 dark:text-gray-200">${escapeHTML(item.name)}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">${item.dueDate.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                    </div>
                    <div class="font-semibold text-red-500 dark:text-red-400">${formatCurrency(item.amount)}</div>
                </div>
            `).join('');
        }

        function getNextDueDate(item, fromDate) {
            let nextDueDate = new Date(item.startDate);
             while (nextDueDate < fromDate) {
                switch (item.frequency) {
                    case 'Daily': nextDueDate.setDate(nextDueDate.getDate() + 1); break;
                    case 'Weekly': nextDueDate.setDate(nextDueDate.getDate() + 7); break;
                    case 'Bi-Weekly': nextDueDate.setDate(nextDueDate.getDate() + 14); break;
                    case 'Monthly': nextDueDate.setMonth(nextDueDate.getMonth() + 1); break;
                    case 'Quarterly': nextDueDate.setMonth(nextDueDate.getMonth() + 3); break;
                    case 'Annual': nextDueDate.setFullYear(nextDueDate.getFullYear() + 1); break;
                    default: return new Date('9999-12-31');
                }
            }
            return nextDueDate;
        }

        function renderMonthEndProjection(container, totalSpent, now) {
            if (!container) return;
            const projection = predictMonthEndSpending(totalSpent, now);
            const projectedSavings = monthlyIncome - projection.projectedSpend;

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="text-center">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Projected Spending</p>
                        <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">${formatCurrency(projection.projectedSpend, false)}</p>
                        <p class="text-xs font-medium ${projection.statusColor}">${projection.statusText} vs Budget</p>
                    </div>
                     <div class="text-center">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Projected Savings</p>
                        <p class="text-3xl font-bold ${projectedSavings >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                            ${formatCurrency(projectedSavings, false)}
                        </p>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Based on monthly income</p>
                    </div>
                </div>
            `;
        }
        
        function renderSmartRecommendations(container, monthlyExpenses, allRecurringItems) {
            if (!container) return [];
            let recommendations = [];
            
            const subscriptions = allRecurringItems.filter(i => i.status === 'active' && i.type === 'expense' && i.category === 'Subscriptions');
            if (subscriptions.length > 2) {
                const totalSubCost = subscriptions.reduce((sum, s) => sum + s.amount, 0);
                recommendations.push({
                    icon: '‚úÇÔ∏è',
                    title: 'Review Subscriptions',
                    description: `You have ${subscriptions.length} active subscriptions costing ${formatCurrency(totalSubCost)}/month. Consider cancelling any you don't use.`
                });
            }

            const nonEssentialSpending = monthlyExpenses.filter(e => e.type === 'Non-Essential').reduce((sum, e) => sum + e.cost, 0);
            const totalSpent = monthlyExpenses.reduce((sum, e) => sum + e.cost, 0);
            if (totalSpent > 0 && (nonEssentialSpending / totalSpent) > 0.4) {
                 recommendations.push({
                    icon: 'ü§î',
                    title: 'Check Non-Essential Spending',
                    description: `Over 40% of your spending this month is on non-essentials. Small cutbacks here could lead to big savings.`
                });
            }

            const diningOut = monthlyExpenses.filter(e => e.category === 'Food/Drink' && (e.name.toLowerCase().includes('restaurant') || e.name.toLowerCase().includes('takeaway') || e.name.toLowerCase().includes('coffee'))).reduce((sum, e) => sum + e.cost, 0);
            if (diningOut > (monthlyBudget * 0.1)) {
                 recommendations.push({
                    icon: 'üç≥',
                    title: 'Dining Out Costs',
                    description: `You've spent ${formatCurrency(diningOut)} on food & drinks out. Cooking at home is a great way to save.`
                });
            }

            if (recommendations.length === 0) {
                container.innerHTML = `<div class="text-center text-sm text-gray-500 dark:text-gray-400 p-4">Looking good! No specific recommendations right now.</div>`;
                return [];
            }
            
            container.innerHTML = recommendations.map(rec => `
                <div class="flex items-start gap-3 p-3 rounded-lg bg-gray-50 dark:bg-gray-800/50 action-item">
                    <div class="text-xl pt-1">${rec.icon}</div>
                    <div>
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">${rec.title}</h4>
                        <p class="text-sm text-slate-600 dark:text-slate-400">${rec.description}</p>
                    </div>
                </div>
            `).join('');

            return recommendations;
        }

        function renderMonthlyStory(storyContainer, metricsContainer, monthlyExpenses, totalSpent) {
            if (!storyContainer || !metricsContainer) return;
            
            const totalIncome = monthlyIncome + getMonthlyRecurringTotals(new Date().getFullYear(), new Date().getMonth()).income;
            
            if (totalSpent === 0) {
                 storyContainer.innerHTML = `<div class="text-center text-sm text-gray-500 dark:text-gray-400 p-4">Start adding expenses to see your monthly story unfold.</div>`;
                 metricsContainer.classList.add('hidden');
                 return;
            }

            const savingsRate = totalIncome > 0 ? ((totalIncome - totalSpent) / totalIncome) * 100 : 0;
            
            const spendingByDay = monthlyExpenses.reduce((acc, e) => {
                const day = new Date(e.date).getDate();
                acc[day] = (acc[day] || 0) + e.cost;
                return acc;
            }, {});
            const busiestDay = Object.entries(spendingByDay).sort((a,b) => b[1] - a[1])[0];

            const spendingByCategory = monthlyExpenses.reduce((acc, e) => {
                acc[e.category] = (acc[e.category] || 0) + e.cost;
                return acc;
            }, {});
            const topCategory = Object.entries(spendingByCategory).sort((a,b) => b[1] - a[1])[0];

            let story = `This month, you've spent <strong>${formatCurrency(totalSpent)}</strong>. `;
            if (savingsRate > 20) {
                story += `Your saving discipline is impressive, with a savings rate of <strong>${savingsRate.toFixed(0)}%</strong>. `;
            } else if (savingsRate > 0) {
                 story += `You're on the right track, saving <strong>${savingsRate.toFixed(0)}%</strong> of your income. `;
            } else {
                story += `It seems spending exceeded income this month. Let's aim for a positive savings rate next month. `;
            }
            if(busiestDay && topCategory) {
                story += `Your busiest spending day was the <strong>${busiestDay[0]}th</strong>, and your top category was <strong>${topCategory[0]}</strong>.`;
            }

            storyContainer.innerHTML = `<p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">${story}</p>`;
            
            metricsContainer.innerHTML = `
                <div class="metric-card">
                    <p class="text-xs font-medium text-slate-600 dark:text-slate-400">Savings Rate</p>
                    <p class="text-lg font-bold ${savingsRate >=0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${savingsRate.toFixed(0)}%</p>
                </div>
                <div class="metric-card">
                    <p class="text-xs font-medium text-slate-600 dark:text-slate-400">Top Category</p>
                    <p class="text-lg font-bold text-slate-800 dark:text-slate-200 truncate">${topCategory ? topCategory[0] : '-'}</p>
                </div>
                <div class="metric-card">
                    <p class="text-xs font-medium text-slate-600 dark:text-slate-400">Busiest Day</p>
                    <p class="text-lg font-bold text-slate-800 dark:text-slate-200">${busiestDay ? busiestDay[0] + 'th' : '-'}</p>
                </div>
            `;
            metricsContainer.classList.remove('hidden');
        }

        // --- Utility Functions ---
        function formatCurrency(amount, useDecimals = true) {
            const { locale } = currencyConfig[currentCurrencyCode];
            const isInteger = !useDecimals || (amount % 1 === 0);
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: isInteger ? 0 : 2,
                maximumFractionDigits: isInteger ? 0 : 2
            };
            return new Intl.NumberFormat(locale, options).format(amount || 0);
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function showToast(message, type = 'success') {
            DOMElements.toast.textContent = message;
            DOMElements.toast.className = `toast show ${type === 'error' ? 'bg-red-600' : 'bg-gray-800 dark:bg-gray-200 dark:text-gray-800'}`;
            setTimeout(() => { DOMElements.toast.className = 'toast'; }, 3000);
        }

        window.addEventListener('click', (e) => {
            const settingsContainer = DOMElements.settingsMenu.parentElement;
            if (settingsContainer && !DOMElements.settingsMenu.classList.contains('hidden') && !settingsContainer.contains(e.target)) {
                DOMElements.settingsMenu.classList.add('hidden');
        }
        });

        function generateExpensesFromRecurring() {
            const generatedExpenses = [];
            const today = new Date();
            // To avoid timezone issues, we compare date strings
            const todayStr = today.toISOString().split('T')[0];

            recurringItems.forEach(item => {
                if (item.type !== 'expense' || item.status !== 'active') {
                    return;
                }

                let currentDate = new Date(item.startDate + 'T00:00:00'); // Set time to avoid timezone shifts
                const endDate = item.endDate ? new Date(item.endDate + 'T00:00:00') : today;

                while (currentDate <= endDate && currentDate <= today) {
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;

                    generatedExpenses.push({
                        id: `recurring-${item.id}-${dateStr}`, // composite ID
                        name: `${item.name} (r)`,
                        cost: item.amount,
                        type: item.essentialType || 'Non-Essential', // Assign essential type
                        category: item.category,
                        date: dateStr,
                        paymentMethod: item.paymentMethod,
                        status: 'active',
                        isRecurring: true,
                        originalRecurringId: item.id
                    });
                    
                    // Increment currentDate based on frequency
                    switch (item.frequency) {
                        case 'Daily':
                            currentDate.setDate(currentDate.getDate() + 1);
                            break;
                        case 'Weekly':
                            currentDate.setDate(currentDate.getDate() + 7);
                            break;
                        case 'Bi-Weekly':
                            currentDate.setDate(currentDate.getDate() + 14);
                            break;
                        case 'Monthly':
                            currentDate.setMonth(currentDate.getMonth() + 1);
                            break;
                        case 'Quarterly':
                            currentDate.setMonth(currentDate.getMonth() + 3);
                            break;
                        case 'Annual':
                            currentDate.setFullYear(currentDate.getFullYear() + 1);
                            break;
                        default:
                            // Break the loop for unknown frequencies
                            currentDate = new Date('9999-12-31');
                            break;
                    }
                }
            });

            return generatedExpenses;
        }

        // --- Auto-Categorization ---
        function autoCategorizeExpense(event) {
            const name = event.target.value.toLowerCase();
            if (!name) return;

            let matchedCategory = 'Other';
            let matchedEssential = 'Non-Essential';

            // Find category based on keywords
            for (const category in categoryKeywords) {
                if (categoryKeywords[category].some(keyword => name.includes(keyword))) {
                    matchedCategory = category;
                    break;
                }
            }

            // Determine if essential based on keywords
            if (essentialKeywords.some(keyword => name.includes(keyword))) {
                matchedEssential = 'Essential';
            }

            // Update the form fields
            const formPrefix = event.target.id.startsWith('recurring') ? 'recurring-' : 'expense-';
            const categorySelect = document.getElementById(`${formPrefix}category`);
            const typeSelect = document.getElementById(`${formPrefix}type`) || document.getElementById(`${formPrefix}essential-type`);
            
            if (categorySelect) {
                categorySelect.value = matchedCategory;
            }
            if (typeSelect) {
                typeSelect.value = matchedEssential;
                    }
                }

        // --- Settings Modal ---
        function openSettings(section) {
            const settingsModal = document.getElementById('settings-modal');
            
            // Populate inputs with current values
            document.getElementById('settings-budget-input').value = monthlyBudget > 0 ? monthlyBudget : '';
            document.getElementById('settings-income-input').value = monthlyIncome > 0 ? monthlyIncome : '';
            
            settingsModal.classList.remove('hidden');

            if (section === 'budget') {
                setTimeout(() => {
                    document.getElementById('settings-budget-input').focus();
                }, 100);
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const budgetValue = document.getElementById('settings-budget-input').value;
            const incomeValue = document.getElementById('settings-income-input').value;

            updateBudget(budgetValue);
            updateIncome(incomeValue);

            closeSettings();
            showToast('Settings saved successfully!');
        }

        function formatCurrency(amount) {
            const config = currencyConfig[currentCurrencyCode];
            const isInteger = amount % 1 === 0;
            const options = {
                style: 'currency',
                currency: currentCurrencyCode,
                minimumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
                maximumFractionDigits: (currentCurrencyCode === 'JPY' || isInteger) ? 0 : 2,
            };
            return new Intl.NumberFormat(config.locale, options).format(amount || 0);
        }

        // --- Data Getters ---
        function getExpenses() {
            // New, simplified logic: Return all stored expenses.
            // The old logic for dynamically generating recurring instances is no longer needed.
            return [...expenses];
        }

        function getRecurringItems() {
            // Simplified for clarity, just returns the array
            return [...recurringItems];
        }


        // --- Update & Render ---
        function updateDisplay() {
            console.time('updateDisplay');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Centralized calculations for all expenses this month
            const monthlyRecurring = getMonthlyRecurringTotals(currentYear, currentMonth);
            const totalMonthlyIncome = monthlyIncome + monthlyRecurring.income;

            const allMonthlyExpenses = [
                ...expenses.filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                }),
                ...generateExpensesFromRecurring().filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                })
            ];
            const activeMonthlyExpenses = allMonthlyExpenses.filter(e => e.status === 'active');
            const totalSpent = activeMonthlyExpenses.reduce((sum, e) => sum + e.cost, 0);

            // --- Update UI Tiles ---
            const budgetStr = formatCurrency(monthlyBudget);
            const spentStr = formatCurrency(totalSpent);
            const incomeStr = formatCurrency(totalMonthlyIncome);
            const remaining = monthlyBudget - totalSpent;
            const remainingStr = formatCurrency(remaining);

            // Find the longest string to determine a consistent font size
            const maxLength = Math.max(budgetStr.length, spentStr.length, incomeStr.length, remainingStr.length);
            const responsiveSize = getResponsiveFontSize(" ".repeat(maxLength));

            DOMElements.monthlyBudgetDisplay.textContent = budgetStr;
            DOMElements.monthlyBudgetDisplay.style.fontSize = responsiveSize;

            DOMElements.totalExpensesDisplay.textContent = spentStr;
            DOMElements.totalExpensesDisplay.style.fontSize = responsiveSize;
            
            DOMElements.totalIncomeDisplay.textContent = incomeStr;
            DOMElements.totalIncomeDisplay.style.fontSize = responsiveSize;

            DOMElements.remainingAmountDisplay.textContent = remainingStr;
            DOMElements.remainingAmountDisplay.style.fontSize = responsiveSize;

            if (remaining < 0) {
                DOMElements.remainingAmountDisplay.classList.remove('text-green-600', 'dark:text-green-400');
                DOMElements.remainingAmountDisplay.classList.add('text-red-600', 'dark:text-red-400');
            } else {
                DOMElements.remainingAmountDisplay.classList.remove('text-red-600', 'dark:text-red-400');
                DOMElements.remainingAmountDisplay.classList.add('text-green-600', 'dark:text-green-400');
            }

            updateQuickAddButtons();

            // Budget Health & Progress Bar
            const budgetProgress = (monthlyBudget > 0) ? (totalSpent / monthlyBudget) * 100 : 0;
            DOMElements.budgetBar.style.width = `${Math.min(budgetProgress, 100)}%`;
            DOMElements.budgetBar.classList.remove('bg-blue-600', 'bg-red-600');
            DOMElements.budgetBar.classList.add(budgetProgress > 100 ? 'bg-red-600' : 'bg-blue-600');
            DOMElements.budgetPercentage.textContent = `${budgetProgress.toFixed(0)}% Used`;
            
            // AI Projection
            const projection = predictMonthEndSpending(totalSpent, now);
            DOMElements.aiProjectionContainer.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">üîÆ</span>
                    <div>
                        <span class="font-semibold">AI Projection:</span>
                        You're on track to spend <strong>${formatCurrency(projection.projectedSpend)}</strong> this month.
                        <span class="font-bold ${projection.statusColor}">${projection.statusText}</span>
                    </div>
                </div>
            `;
            
            updateBudgetHealthScore(totalSpent, monthlyBudget, activeMonthlyExpenses, totalMonthlyIncome, now);
            
            // Spending Breakdown
            const essentialSpending = activeMonthlyExpenses.filter(e => e.type === 'Essential').reduce((sum, e) => sum + e.cost, 0);
            const nonEssentialSpending = activeMonthlyExpenses.filter(e => e.type === 'Non-Essential').reduce((sum, e) => sum + e.cost, 0);
            DOMElements.essentialSpendingDisplay.textContent = formatCurrency(essentialSpending);
            DOMElements.nonEssentialSpendingDisplay.textContent = formatCurrency(nonEssentialSpending);
            const totalBreakdown = essentialSpending + nonEssentialSpending;
            const essentialPercent = totalBreakdown > 0 ? (essentialSpending / totalBreakdown) * 100 : 0;
            DOMElements.essentialBar.style.width = `${essentialPercent}%`;
            DOMElements.nonEssentialBar.style.width = `${100 - essentialPercent}%`;

            renderRecentExpenses();
            renderExpensesTable();
            renderRecurringTable();
            
            if (activeTab === 'insights') {
                updateChartsAndInsights();
            }
            updateDeleteSelectedButton();
            updateDeleteSelectedRecurringButton();
            console.timeEnd('updateDisplay');
        }

        function deleteExpense(id) {
            if (confirm('Are you sure you want to permanently delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                selectedExpenseIds.delete(id.toString());
                saveData();
                updateDisplay();
                showToast('Expense deleted successfully!');
            }
        }

        function toggleExpenseStatus(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                expense.status = expense.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Expense status updated to ${expense.status}.`);
        }
        }

        function toggleRecurringStatusInExpenseView(recurringId) {
            const item = recurringItems.find(r => r.id === recurringId);
            if (item) {
                item.status = item.status === 'active' ? 'cancelled' : 'active';
                saveData();
                updateDisplay();
                showToast(`Status of recurring series '${item.name}' has been updated.`);
            }
        }
        
        function toggleFilterPanel(panelId) {
            document.getElementById(panelId).classList.toggle('hidden');
        }

        function openHelpModal() {
            document.getElementById('help-modal').classList.remove('hidden');
            closeSettings();
        }

        function closeHelpModal() {
            document.getElementById('help-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
